/*! For license information please see main.js.LICENSE.txt */
(function(){"use strict";var __webpack_modules__={593:function(t,e,o){o.d(e,{p:function(){return i}}),t=o.hmd(t);var i=i||function(t){if(!(void 0===t||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var e=t.document,o=function(){return t.URL||t.webkitURL||t},i=e.createElementNS("http://www.w3.org/1999/xhtml","a"),s="download"in i,r=/constructor/i.test(t.HTMLElement)||t.safari,n=/CriOS\/[\d]+/.test(navigator.userAgent),a=function(e){(t.setImmediate||t.setTimeout)((function(){throw e}),0)},h=function(t){setTimeout((function(){"string"==typeof t?o().revokeObjectURL(t):t.remove()}),4e4)},l=function(t,e,o){for(var i=(e=[].concat(e)).length;i--;){var s=t["on"+e[i]];if("function"==typeof s)try{s.call(t,o||t)}catch(t){a(t)}}},p=function(t){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob([String.fromCharCode(65279),t],{type:t.type}):t},c=function(e,a,c){c||(e=p(e));var d,u=this,f="application/octet-stream"===e.type,g=function(){l(u,"writestart progress write writeend".split(" "))};if(u.readyState=u.INIT,s)return d=o().createObjectURL(e),void setTimeout((function(){i.href=d,i.download=a,function(t){var e=new MouseEvent("click");t.dispatchEvent(e)}(i),g(),h(d),u.readyState=u.DONE}));!function(){if((n||f&&r)&&t.FileReader){var i=new FileReader;return i.onloadend=function(){var e=n?i.result:i.result.replace(/^data:[^;]*;/,"data:attachment/file;");t.open(e,"_blank")||(t.location.href=e),e=void 0,u.readyState=u.DONE,g()},i.readAsDataURL(e),void(u.readyState=u.INIT)}d||(d=o().createObjectURL(e)),f?t.location.href=d:t.open(d,"_blank")||(t.location.href=d),u.readyState=u.DONE,g(),h(d)}()},d=c.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(t,e,o){return e=e||t.name||"download",o||(t=p(t)),navigator.msSaveOrOpenBlob(t,e)}:(d.abort=function(){},d.readyState=d.INIT=0,d.WRITING=1,d.DONE=2,d.error=d.onwritestart=d.onprogress=d.onwrite=d.onabort=d.onerror=d.onwriteend=null,function(t,e,o){return new c(t,e||t.name||"download",o)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||(void 0).content);t.exports?t.exports.saveAs=i:"undefined"!=typeof define&&null!==define&&null!==o.amdO&&define("FileSaver.js",(function(){return i}))},253:function(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.d(__webpack_exports__,{r9:function(){return morphicVersion},qz:function(){return modules},A3:function(){return useBlurredShadows},xE:function(){return ZERO},E5:function(){return BLACK},Cj:function(){return WHITE},EO:function(){return CLEAR},tU:function(){return MorphicPreferences},WY:function(){return nop},NC:function(){return localize},kK:function(){return isNil},r3:function(){return contains},qY:function(){return detect},Qm:function(){return sizeOf},HD:function(){return isString},uR:function(){return radians},RW:function(){return degrees},SW:function(){return fontHeight},oM:function(){return newCanvas},TJ:function(){return copyCanvas},eg:function(){return getDocumentPositionOf},JG:function(){return copy},Ck:function(){return enableRetinaSupport},D8:function(){return isRetinaSupported},Sg:function(){return isRetinaEnabled},bw:function(){return disableRetinaSupport},bl:function(){return normalizeCanvas},fw:function(){return Animation},Il:function(){return Color},E9:function(){return Point},Ae:function(){return Rectangle},_V:function(){return Morph},qs:function(){return ShadowMorph},LG:function(){return HandleMorph},I_:function(){return PenMorph},kX:function(){return ColorPaletteMorph},Hj:function(){return CursorMorph},RC:function(){return BoxMorph},KE:function(){return SpeechBubbleMorph},ZZ:function(){return DialMorph},Vl:function(){return SliderMorph},wR:function(){return MenuMorph},XC:function(){return StringMorph},$1:function(){return TextMorph},xp:function(){return TriggerMorph},xK:function(){return MenuItemMorph},xZ:function(){return FrameMorph},yR:function(){return ScrollFrameMorph},NT:function(){return ListMorph},qi:function(){return StringFieldMorph},ww:function(){return WorldMorph}});var morphicVersion="2020-November-12",modules={},useBlurredShadows=!0;const ZERO=new Point,BLACK=new Color,WHITE=new Color(255,255,255),CLEAR=new Color(0,0,0,0);Object.freeze(ZERO),Object.freeze(BLACK),Object.freeze(WHITE);var standardSettings={minimumFontHeight:getMinimumFontHeight(),globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:12,bubbleHelpFontSize:10,prompterFontName:"sans-serif",prompterFontSize:12,prompterSliderSize:10,handleSize:15,scrollBarSize:12,mouseScrollAmount:40,useSliderForInput:!1,isTouchDevice:!1,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5,showHoles:!1},touchScreenSettings={minimumFontHeight:standardSettings.minimumFontHeight,globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:24,bubbleHelpFontSize:18,prompterFontName:"sans-serif",prompterFontSize:24,prompterSliderSize:20,handleSize:26,scrollBarSize:24,mouseScrollAmount:40,useSliderForInput:!1,isTouchDevice:!0,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5,showHoles:!1},MorphicPreferences=standardSettings;function nop(){return null}function localize(t){return t}function isNil(t){return null==t}function contains(t,e){return-1!==t.indexOf(e)}function detect(t,e){var o,i=t.length;for(o=0;o<i;o+=1)if(e.call(null,t[o]))return t[o];return null}function sizeOf(t){var e,o=0;for(e in t)Object.prototype.hasOwnProperty.call(t,e)&&(o+=1);return o}function isString(t){return"string"==typeof t||t instanceof String}function isObject(t){return null!==t&&("object"==typeof t||t instanceof Object)}function radians(t){return t*Math.PI/180}function degrees(t){return 180*t/Math.PI}function fontHeight(t){return 1.2*Math.max(t,MorphicPreferences.minimumFontHeight)}function isWordChar(t){return t.match(/[A-zÀ-ÿ0-9]/)}function isURLChar(t){return t.match(/[A-z0-9./:?&_+%-]/)}function isURL(t){return/^https?:\/\//.test(t)}function newCanvas(t,e,o){var i,s;return e=e||!1,s=(t||(o?new Point(o.width,o.height):new Point(0,0))).ceil(),o&&!o.dataset.morphicShare&&(o.isRetinaEnabled||!1)!==e&&s.x===o.width&&s.y===o.height?((i=o).getContext("2d").clearRect(0,0,i.width,i.height),i):((i=document.createElement("canvas")).width=s.x,i.height=s.y,e&&i.isRetinaEnabled&&(i.isRetinaEnabled=!1),i)}function copyCanvas(t){var e;return t&&t.width&&t.height?((e=newCanvas(new Point(t.width,t.height),!t.isRetinaEnabled)).getContext("2d").drawImage(t,0,0),e):t}function getMinimumFontHeight(){var t,e,o,i,s=document.createElement("canvas");for(s.width=50,s.height=50,(t=s.getContext("2d")).font="1px serif",e=t.measureText("I").width,t.fillStyle="black",t.textBaseline="bottom",t.fillText("I",0,50),i=0;i<50;i+=1)for(o=0;o<e;o+=1)if(0!==t.getImageData(o,i,1,1).data[3])return 50-i+1;return 0}function getDocumentPositionOf(t){var e=t.getBoundingClientRect(),o=window.pageXOffset||document.documentElement.scrollLeft,i=window.pageYOffset||document.documentElement.scrollTop;return{x:e.left+o,y:e.top+i}}function copy(t){var e,o,i,s,r,n;if("object"!=typeof t)return t;if(e=t.valueOf(),t!==e)return new t.constructor(e);if(t instanceof t.constructor&&t.constructor!==Object)for(o=Object.create(t.constructor.prototype),r=(s=Object.keys(t)).length,n=0;n<r;n+=1)t[i=s[n]]instanceof HTMLCanvasElement&&(t[i].dataset.morphicShare="true"),o[i]=t[i];else for(i in o={},t)o[i]=t[i];return o}function enableRetinaSupport(){var t=document.createElement("canvas").getContext("2d"),e=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1,o=Math.ceil(window.devicePixelRatio),i=HTMLCanvasElement.prototype,s=CanvasRenderingContext2D.prototype,r={drawImage:s.drawImage,getImageData:s.getImageData,width:Object.getOwnPropertyDescriptor(i,"width"),height:Object.getOwnPropertyDescriptor(i,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(s,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(s,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(s,"shadowBlur")};function n(t){return t.isRetinaEnabled?(o||1)/e:1}e!==o&&(Object.keys(r).some((t=>{var e=r[t];return e.hasOwnProperty("configurable")&&!e.configurable}))||(i._isRetinaEnabled=!0,i._bak=r,Object.defineProperty(i,"isRetinaEnabled",{get:function(){return this._isRetinaEnabled},set:function(t){var e=n(this),o=this.width,i=this.height;this._isRetinaEnabled=t,n(this)!=e&&(this.width=o,this.height=i)},configurable:!0}),Object.defineProperty(i,"width",{get:function(){return r.width.get.call(this)/n(this)},set:function(t){try{var e=n(this);r.width.set.call(this,t*e),this.getContext("2d").scale(e,e)}catch(e){console.log("Retina Display Support Problem",e),r.width.set.call(this,t)}}}),Object.defineProperty(i,"height",{get:function(){return r.height.get.call(this)/n(this)},set:function(t){var e=n(this);r.height.set.call(this,t*e),this.getContext("2d").scale(e,e)}}),s.drawImage=function(t){var e,o,i,s,a,h,l,p,c=n(t);switch(arguments.length){case 9:e=arguments[1],o=arguments[2],i=arguments[3],s=arguments[4],a=arguments[5],h=arguments[6],l=arguments[7],p=arguments[8];break;case 5:e=0,o=0,i=t.width,s=t.height,a=arguments[1],h=arguments[2],l=arguments[3],p=arguments[4];break;case 3:e=0,o=0,i=t.width,s=t.height,a=arguments[1],h=arguments[2],l=t.width,p=t.height;break;default:throw Error("Called drawImage() with "+arguments.length+" arguments")}r.drawImage.call(this,t,e*c,o*c,i*c,s*c,a,h,l,p)},s.getImageData=function(t,e,o,i){var s=n(this.canvas);return r.getImageData.call(this,t*s,e*s,o*s,i*s)},Object.defineProperty(s,"shadowOffsetX",{get:function(){return r.shadowOffsetX.get.call(this)/n(this.canvas)},set:function(t){var e=n(this.canvas);r.shadowOffsetX.set.call(this,t*e)}}),Object.defineProperty(s,"shadowOffsetY",{get:function(){return r.shadowOffsetY.get.call(this)/n(this.canvas)},set:function(t){var e=n(this.canvas);r.shadowOffsetY.set.call(this,t*e)}}),Object.defineProperty(s,"shadowBlur",{get:function(){return r.shadowBlur.get.call(this)/n(this.canvas)},set:function(t){var e=n(this.canvas);r.shadowBlur.set.call(this,t*e)}})))}function isRetinaSupported(){var t=document.createElement("canvas").getContext("2d"),e=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1,o=HTMLCanvasElement.prototype,i=CanvasRenderingContext2D.prototype,s={drawImage:i.drawImage,getImageData:i.getImageData,width:Object.getOwnPropertyDescriptor(o,"width"),height:Object.getOwnPropertyDescriptor(o,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(i,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(i,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(i,"shadowBlur")};return e!==window.devicePixelRatio&&!Object.keys(s).some((t=>{var e=s[t];return e.hasOwnProperty("configurable")&&!e.configurable}))}function isRetinaEnabled(){return HTMLCanvasElement.prototype.hasOwnProperty("_isRetinaEnabled")}function disableRetinaSupport(){var t,e,o;isRetinaEnabled()&&(t=HTMLCanvasElement.prototype,e=CanvasRenderingContext2D.prototype,o=t._bak,Object.defineProperty(t,"width",o.width),Object.defineProperty(t,"height",o.height),e.drawImage=o.drawImage,e.getImageData=o.getImageData,Object.defineProperty(e,"shadowOffsetX",o.shadowOffsetX),Object.defineProperty(e,"shadowOffsetY",o.shadowOffsetY),Object.defineProperty(e,"shadowBlur",o.shadowBlur),delete t._isRetinaEnabled,delete t.isRetinaEnabled,delete t._bak)}function normalizeCanvas(t,e){var o;return t.isRetinaEnabled?((o=newCanvas(new Point(t.width,t.height),!0)).getContext("2d").drawImage(t,0,0),e?o:(t.isRetinaEnabled=!1,t.width=o.width,t.height=o.height,t.getContext("2d").drawImage(o,0,0),t)):t}function Animation(t,e,o,i,s,r){this.setter=t,this.getter=e,this.delta=o||0,this.duration=i||0,this.easing=isString(s)?this.easings[s]||this.easings.sinusoidal:s||this.easings.sinusoidal,this.onComplete=r||null,this.endTime=null,this.destination=null,this.isActive=!1,this.start()}function Color(t,e,o,i){this.r=t||0,this.g=e||0,this.b=o||0,this.a=i||(0===i?0:1)}function Point(t,e){this.x=t||0,this.y=e||0}function Rectangle(t,e,o,i){this.init(new Point(t||0,e||0),new Point(o||0,i||0))}function Node(t,e){this.init(t||null,e||[])}function Morph(){this.init()}function ShadowMorph(){this.init()}function HandleMorph(t,e,o,i,s,r){this.init(t,e,o,i,s,r)}function PenMorph(){this.init()}function ColorPaletteMorph(t,e){this.init(t||null,e||new Point(80,50))}function GrayPaletteMorph(t,e){this.init(t||null,e||new Point(80,10))}function ColorPickerMorph(t){this.init(t||WHITE)}function BlinkerMorph(t){this.init(t)}function CursorMorph(t,e){this.init(t,e)}function BoxMorph(t,e,o){this.init(t,e,o)}function SpeechBubbleMorph(t,e,o,i,s,r,n,a){this.init(t,e,o,i,s,r,n,a)}function DialMorph(t,e,o,i,s){this.init(t,e,o,i,s)}function CircleBoxMorph(t){this.init(t||"vertical")}function SliderButtonMorph(t){this.init(t)}function SliderMorph(t,e,o,i,s,r){this.init(t||0,e||100,o||0,i||10,s||"vertical",r)}function MouseSensorMorph(t,e,o){this.init(t,e,o)}function InspectorMorph(t){this.init(t)}function MenuMorph(t,e,o,i){this.init(t,e,o,i)}function StringMorph(t,e,o,i,s,r,n,a,h,l){this.init(t,e,o,i,s,r,n,a,h,l)}function TextMorph(t,e,o,i,s,r,n,a,h,l){this.init(t,e,o,i,s,r,n,a,h,l)}function TriggerMorph(t,e,o,i,s,r,n,a,h,l,p){this.init(t,e,o,i,s,r,n,a,h,l,p)}function MenuItemMorph(t,e,o,i,s,r,n,a,h,l,p,c){this.shortcutString=c||null,this.shortcut=null,this.init(t,e,o,i,s,r,n,a,h,l,p)}function FrameMorph(t){this.init(t)}function ScrollFrameMorph(t,e,o){this.init(t,e,o)}function ListMorph(t,e,o,i,s){this.init(t||[],e||function(t){return isString(t)?t:t.toSource?t.toSource():t.toString()},o||[],i,s)}function StringFieldMorph(t,e,o,i,s,r,n){this.init(t||"",e||100,o||12,i||"sans-serif",s||!1,r||!1,n)}function BouncerMorph(){this.init()}function HandMorph(t){this.init(t)}function WorldMorph(t,e){this.init(t,e)}enableRetinaSupport(),Animation.prototype.easings={linear:t=>t,sinusoidal:t=>1-Math.cos(radians(90*t)),quadratic:t=>t<.5?2*t*t:(4-2*t)*t-1,cubic:t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1,elastic:t=>(t-=.5)<0?(.01+.01/t)*Math.sin(50*t):(.02-.01/t)*Math.sin(50*t)+1,sine_in:t=>1-Math.sin(radians(90+90*t)),quad_in:t=>t*t,cubic_in:t=>t*t*t,elastic_in:t=>(.04-.04/t)*Math.sin(25*t)+1,sine_out:t=>Math.sin(radians(90*t)),quad_out:t=>t*(2-t),elastic_out:t=>.04*t/--t*Math.sin(25*t)},Animation.prototype.start=function(){this.endTime=Date.now()+this.duration,this.destination=this.getter.call(this)+this.delta,this.isActive=!0},Animation.prototype.step=function(){if(this.isActive){var t=Date.now();t>this.endTime?(this.setter(this.destination),this.isActive=!1,this.onComplete&&this.onComplete()):this.setter(this.destination-this.delta*this.easing((this.endTime-t)/this.duration))}},Color.prototype.toString=function(){return"rgba("+Math.round(this.r)+","+Math.round(this.g)+","+Math.round(this.b)+","+this.a+")"},Color.prototype.toRGBstring=function(){return"rgb("+Math.round(this.r)+","+Math.round(this.g)+","+Math.round(this.b)+")"},Color.fromString=function(t){var e=t.split(/[\(),]/).slice(1,5);return new Color(e[0],e[1],e[2],e[3])},Color.prototype.copy=function(){return new Color(this.r,this.g,this.b,this.a)},Color.prototype.eq=function(t,e){return t&&this.r===t.r&&this.g===t.g&&this.b===t.b&&(!e||this.a===t.a)},Color.prototype.isCloseTo=function(t,e,o){var i=2.55*(o||10);function s(t,e){var o=t-e;return o<0?255+o:o}return t&&s(this.r,t.r)<i&&s(this.g,t.g)<i&&s(this.b,t.b)<i&&(!e||this.a===t.a)},Color.prototype.hsv=function(){var t,e,o,i,s,r,n=this.r/255,a=this.g/255,h=this.b/255;if(o=t=Math.max(n,a,h),s=t,r=t-(e=Math.min(n,a,h)),i=0===t?0:r/t,t===e)o=0;else{switch(t){case n:o=(a-h)/r+(a<h?6:0);break;case a:o=(h-n)/r+2;break;case h:o=(n-a)/r+4}o/=6}return[o,i,s]},Color.prototype.set_hsv=function(t,e,o){var i,s,r,n,a;switch(r=o*(1-e),n=o*(1-(s=6*t-(i=Math.floor(6*t)))*e),a=o*(1-(1-s)*e),i%6){case 0:this.r=o,this.g=a,this.b=r;break;case 1:this.r=n,this.g=o,this.b=r;break;case 2:this.r=r,this.g=o,this.b=a;break;case 3:this.r=r,this.g=n,this.b=o;break;case 4:this.r=a,this.g=r,this.b=o;break;case 5:this.r=o,this.g=r,this.b=n}this.r*=255,this.g*=255,this.b*=255},Color.prototype.hsl=function(){var t,e,o,i=this.r/255,s=this.g/255,r=this.b/255,n=Math.max(i,s,r),a=Math.min(i,s,r),h=(n+a)/2;if(n===a)t=0,e=0;else{switch(o=n-a,e=h>.5?o/(2-n-a):o/(n+a),n){case i:t=(s-r)/o+(s<r?6:0);break;case s:t=(r-i)/o+2;break;case r:t=(i-s)/o+4}t/=6}return[t,e,h]},Color.prototype.set_hsl=function(t,e,o){var i,s;function r(t,e,o){return o<0&&(o+=1),o>1&&(o-=1),o<1/6?t+6*(e-t)*o:o<.5?e:o<2/3?t+(e-t)*(2/3-o)*6:t}0==e?(this.r=o,this.g=o,this.b=o):(s=2*o-(i=o<.5?o*(1+e):o+e-o*e),this.r=r(s,i,t+1/3),this.g=r(s,i,t),this.b=r(s,i,t-1/3)),this.r*=255,this.g*=255,this.b*=255},Color.prototype.mixed=function(t,e){var o=Math.min(Math.max(t,0),1),i=1-o;return new Color(this.r*o+e.r*i,this.g*o+e.g*i,this.b*o+e.b*i)},Color.prototype.darker=function(t){var e=.8333;return t&&(e=(100-t)/100),this.mixed(e,new Color(0,0,0))},Color.prototype.lighter=function(t){var e=.8333;return t&&(e=(100-t)/100),this.mixed(e,WHITE)},Color.prototype.dansDarker=function(){var t=this.hsv(),e=new Color,o=Math.max(t[2]-.16,0);return e.set_hsv(t[0],t[1],o),e},Color.prototype.inverted=function(){return new Color(255-this.r,255-this.g,255-this.b)},Color.prototype.solid=function(){return new Color(this.r,this.g,this.b)},Point.prototype.toString=function(){return Math.round(this.x.toString())+"@"+Math.round(this.y.toString())},Point.prototype.copy=function(){return new Point(this.x,this.y)},Point.prototype.eq=function(t){return this.x===t.x&&this.y===t.y},Point.prototype.lt=function(t){return this.x<t.x&&this.y<t.y},Point.prototype.gt=function(t){return this.x>t.x&&this.y>t.y},Point.prototype.ge=function(t){return this.x>=t.x&&this.y>=t.y},Point.prototype.le=function(t){return this.x<=t.x&&this.y<=t.y},Point.prototype.max=function(t){return new Point(Math.max(this.x,t.x),Math.max(this.y,t.y))},Point.prototype.min=function(t){return new Point(Math.min(this.x,t.x),Math.min(this.y,t.y))},Point.prototype.round=function(){return new Point(Math.round(this.x),Math.round(this.y))},Point.prototype.abs=function(){return new Point(Math.abs(this.x),Math.abs(this.y))},Point.prototype.neg=function(){return new Point(-this.x,-this.y)},Point.prototype.mirror=function(){return new Point(this.y,this.x)},Point.prototype.floor=function(){return new Point(Math.max(Math.floor(this.x),0),Math.max(Math.floor(this.y),0))},Point.prototype.ceil=function(){return new Point(Math.ceil(this.x),Math.ceil(this.y))},Point.prototype.add=function(t){return t instanceof Point?new Point(this.x+t.x,this.y+t.y):new Point(this.x+t,this.y+t)},Point.prototype.subtract=function(t){return t instanceof Point?new Point(this.x-t.x,this.y-t.y):new Point(this.x-t,this.y-t)},Point.prototype.multiplyBy=function(t){return t instanceof Point?new Point(this.x*t.x,this.y*t.y):new Point(this.x*t,this.y*t)},Point.prototype.divideBy=function(t){return t instanceof Point?new Point(this.x/t.x,this.y/t.y):new Point(this.x/t,this.y/t)},Point.prototype.floorDivideBy=function(t){return t instanceof Point?new Point(Math.floor(this.x/t.x),Math.floor(this.y/t.y)):new Point(Math.floor(this.x/t),Math.floor(this.y/t))},Point.prototype.r=function(){var t=this.multiplyBy(this);return Math.sqrt(t.x+t.y)},Point.prototype.degrees=function(){var t,e;return 0===this.x?this.y>=0?90:270:(t=this.y/this.x,e=Math.atan(t),this.x>=0?this.y>=0?degrees(e):360+degrees(e):180+degrees(e))},Point.prototype.theta=function(){var t,e;return 0===this.x?this.y>=0?radians(90):radians(270):(t=this.y/this.x,e=Math.atan(t),this.x>=0?this.y>=0?e:radians(360)+e:radians(180)+e)},Point.prototype.crossProduct=function(t){return this.multiplyBy(t.mirror())},Point.prototype.distanceTo=function(t){return t.subtract(this).r()},Point.prototype.rotate=function(t,e){var o=this.subtract(e);return"right"===t?new Point(-o.y,o.y).add(e):"left"===t?new Point(o.y,-o.y).add(e):e.subtract(o)},Point.prototype.flip=function(t,e){return"vertical"===t?new Point(this.x,2*e.y-this.y):new Point(2*e.x-this.x,this.y)},Point.prototype.distanceAngle=function(t,e){var o,i,s=e;return s>270?s-=360:s<-270&&(s+=360),-90<=s&&s<=90?(o=Math.sin(radians(s))*t,i=Math.sqrt(t*t-o*o),new Point(o+this.x,this.y-i)):(o=Math.sin(radians(180-s))*t,i=Math.sqrt(t*t-o*o),new Point(o+this.x,this.y+i))},Point.prototype.scaleBy=function(t){return this.multiplyBy(t)},Point.prototype.translateBy=function(t){return this.add(t)},Point.prototype.rotateBy=function(t,e){var o=e||ZERO,i=this.subtract(o),s=i.r(),r=t-i.theta();return new Point(o.x+s*Math.cos(r),o.y-s*Math.sin(r))},Point.prototype.asArray=function(){return[this.x,this.y]},Rectangle.prototype.init=function(t,e){this.origin=t,this.corner=e},Rectangle.prototype.toString=function(){return"["+this.origin.toString()+" | "+this.extent().toString()+"]"},Rectangle.prototype.copy=function(){return new Rectangle(this.left(),this.top(),this.right(),this.bottom())},Point.prototype.corner=function(t){return new Rectangle(this.x,this.y,t.x,t.y)},Point.prototype.rectangle=function(t){var e,o;return e=this.min(t),o=this.max(t),new Rectangle(e.x,e.y,o.x,o.y)},Point.prototype.extent=function(t){var e=this.add(t);return new Rectangle(this.x,this.y,e.x,e.y)},Rectangle.prototype.setTo=function(t,e,o,i){this.origin=new Point(t||(0===t?0:this.left()),e||(0===e?0:this.top())),this.corner=new Point(o||(0===o?0:this.right()),i||(0===i?0:this.bottom()))},Rectangle.prototype.setExtent=function(t){this.setWidth(t.x),this.setHeight(t.y)},Rectangle.prototype.setWidth=function(t){this.corner.x=this.origin.x+t},Rectangle.prototype.setHeight=function(t){this.corner.y=this.origin.y+t},Rectangle.prototype.area=function(){var t=this.width();return t<0?0:Math.max(t*this.height(),0)},Rectangle.prototype.bottom=function(){return this.corner.y},Rectangle.prototype.bottomCenter=function(){return new Point(this.center().x,this.bottom())},Rectangle.prototype.bottomLeft=function(){return new Point(this.origin.x,this.corner.y)},Rectangle.prototype.bottomRight=function(){return this.corner.copy()},Rectangle.prototype.boundingBox=function(){return this},Rectangle.prototype.center=function(){return this.origin.add(this.corner.subtract(this.origin).floorDivideBy(2))},Rectangle.prototype.corners=function(){return[this.origin,this.bottomLeft(),this.corner,this.topRight()]},Rectangle.prototype.extent=function(){return this.corner.subtract(this.origin)},Rectangle.prototype.height=function(){return this.corner.y-this.origin.y},Rectangle.prototype.left=function(){return this.origin.x},Rectangle.prototype.leftCenter=function(){return new Point(this.left(),this.center().y)},Rectangle.prototype.right=function(){return this.corner.x},Rectangle.prototype.rightCenter=function(){return new Point(this.right(),this.center().y)},Rectangle.prototype.top=function(){return this.origin.y},Rectangle.prototype.topCenter=function(){return new Point(this.center().x,this.top())},Rectangle.prototype.topLeft=function(){return this.origin},Rectangle.prototype.topRight=function(){return new Point(this.corner.x,this.origin.y)},Rectangle.prototype.width=function(){return this.corner.x-this.origin.x},Rectangle.prototype.position=function(){return this.origin},Rectangle.prototype.eq=function(t){return this.origin.eq(t.origin)&&this.corner.eq(t.corner)},Rectangle.prototype.abs=function(){var t,e;return t=this.origin.abs(),e=this.corner.max(t),t.corner(e)},Rectangle.prototype.insetBy=function(t){var e=new Rectangle;return e.origin=this.origin.add(t),e.corner=this.corner.subtract(t),e},Rectangle.prototype.expandBy=function(t){var e=new Rectangle;return e.origin=this.origin.subtract(t),e.corner=this.corner.add(t),e},Rectangle.prototype.growBy=function(t){var e=new Rectangle;return e.origin=this.origin.copy(),e.corner=this.corner.add(t),e},Rectangle.prototype.intersect=function(t){var e=new Rectangle;return e.origin=this.origin.max(t.origin),e.corner=this.corner.min(t.corner),e},Rectangle.prototype.merge=function(t){var e=new Rectangle;return e.origin=this.origin.min(t.origin),e.corner=this.corner.max(t.corner),e},Rectangle.prototype.mergeWith=function(t){this.origin=this.origin.min(t.origin),this.corner=this.corner.max(t.corner)},Rectangle.prototype.round=function(){return this.origin.round().corner(this.corner.round())},Rectangle.prototype.spread=function(){return this.origin.floor().corner(this.corner.ceil())},Rectangle.prototype.amountToTranslateWithin=function(t){var e=0,o=0;return this.right()>t.right()&&(e=t.right()-this.right()),this.bottom()>t.bottom()&&(o=t.bottom()-this.bottom()),this.left()+e<t.left()&&(e=t.left()-this.left()),this.top()+o<t.top()&&(o=t.top()-this.top()),new Point(e,o)},Rectangle.prototype.regionsAround=function(t){var e=[];return this.intersects(t)?(t.left()>this.left()&&e.push(new Rectangle(this.left(),this.top(),t.left(),this.bottom())),t.top()>this.top()&&e.push(new Rectangle(this.left(),this.top(),this.right(),t.top())),t.right()<this.right()&&e.push(new Rectangle(t.right(),this.top(),this.right(),this.bottom())),t.bottom()<this.bottom()&&e.push(new Rectangle(this.left(),t.bottom(),this.right(),this.bottom())),e):e},Rectangle.prototype.containsPoint=function(t){return this.origin.le(t)&&t.lt(this.corner)},Rectangle.prototype.containsRectangle=function(t){return t.origin.gt(this.origin)&&t.corner.lt(this.corner)},Rectangle.prototype.intersects=function(t){var e=t.origin,o=t.corner;return o.x>=this.origin.x&&o.y>=this.origin.y&&e.x<=this.corner.x&&e.y<=this.corner.y},Rectangle.prototype.isNearTo=function(t,e){var o=t.origin,i=t.corner,s=e||0;return i.x+s>=this.origin.x&&i.y+s>=this.origin.y&&o.x-s<=this.corner.x&&o.y-s<=this.corner.y},Rectangle.prototype.scaleBy=function(t){var e=this.origin.multiplyBy(t),o=this.corner.multiplyBy(t);return new Rectangle(e.x,e.y,o.x,o.y)},Rectangle.prototype.translateBy=function(t){var e=this.origin.add(t),o=this.corner.add(t);return new Rectangle(e.x,e.y,o.x,o.y)},Rectangle.prototype.asArray=function(){return[this.left(),this.top(),this.right(),this.bottom()]},Rectangle.prototype.asArray_xywh=function(){return[this.left(),this.top(),this.width(),this.height()]},Node.prototype.init=function(t,e){this.parent=t||null,this.children=e||[]},Node.prototype.toString=function(){return"a Node["+this.children.length.toString()+"]"},Node.prototype.addChild=function(t){this.children.push(t),t.parent=this},Node.prototype.addChildFirst=function(t){this.children.splice(0,null,t),t.parent=this},Node.prototype.removeChild=function(t){var e=this.children.indexOf(t);-1!==e&&this.children.splice(e,1)},Node.prototype.root=function(){return null===this.parent?this:this.parent.root()},Node.prototype.depth=function(){return null===this.parent?0:this.parent.depth()+1},Node.prototype.allChildren=function(){var t=[this];return this.children.forEach((e=>{t=t.concat(e.allChildren())})),t},Node.prototype.forAllChildren=function(t){this.children.length>0&&this.children.forEach((e=>e.forAllChildren(t))),t.call(null,this)},Node.prototype.anyChild=function(t){var e;if(t.call(null,this))return!0;for(e=0;e<this.children.length;e+=1)if(this.children[e].anyChild(t))return!0;return!1},Node.prototype.allLeafs=function(){var t=[];return this.allChildren().forEach((e=>{0===e.children.length&&t.push(e)})),t},Node.prototype.allParents=function(){var t=[this];return null!==this.parent&&(t=t.concat(this.parent.allParents())),t},Node.prototype.siblings=function(){return null===this.parent?[]:this.parent.children.filter((t=>t!==this))},Node.prototype.parentThatIsA=function(){var t;for(t=0;t<arguments.length;t+=1)if(this instanceof arguments[t])return this;return this.parent?this.parentThatIsA.apply(this.parent,arguments):null},Node.prototype.parentThatIsAnyOf=function(t){return this.parentThatIsA.apply(this,t)},Morph.prototype=new Node,Morph.prototype.constructor=Morph,Morph.uber=Node.prototype,Morph.prototype.shadowBlur=4,Morph.prototype.init=function(){Morph.uber.init.call(this),this.isMorph=!0,this.cachedImage=null,this.isCachingImage=!1,this.shouldRerender=!1,this.bounds=new Rectangle(0,0,50,40),this.holes=[],this.color=new Color(80,80,80),this.texture=null,this.cachedTexture=null,this.alpha=1,this.isVisible=!0,this.isDraggable=!1,this.isTemplate=!1,this.acceptsDrops=!1,this.isFreeForm=!1,this.noDropShadow=!1,this.fullShadowSource=!0,this.fps=0,this.customContextMenu=null,this.lastTime=Date.now(),this.onNextStep=null},Morph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+" "+this.children.length.toString()+" "+this.bounds},Morph.prototype.destroy=function(){null!==this.parent&&(this.fullChanged(),this.parent.removeChild(this))},Morph.prototype.stepFrame=function(){if(!this.step)return null;var t,e,o;e=(t=Date.now())-this.lastTime,(this.fps>0?1e3/this.fps-e:0)<1&&(this.lastTime=t,this.onNextStep&&(o=this.onNextStep,this.onNextStep=null,o.call(this)),this.step(),this.children.forEach((t=>t.stepFrame())))},Morph.prototype.nextSteps=function(t){var e=t||[],o=e.shift();o&&(this.onNextStep=()=>{o.call(this),this.nextSteps(e)})},Morph.prototype.step=nop,Morph.prototype.left=function(){return this.bounds.left()},Morph.prototype.right=function(){return this.bounds.right()},Morph.prototype.top=function(){return this.bounds.top()},Morph.prototype.bottom=function(){return this.bounds.bottom()},Morph.prototype.center=function(){return this.bounds.center()},Morph.prototype.bottomCenter=function(){return this.bounds.bottomCenter()},Morph.prototype.bottomLeft=function(){return this.bounds.bottomLeft()},Morph.prototype.bottomRight=function(){return this.bounds.bottomRight()},Morph.prototype.boundingBox=function(){return this.bounds},Morph.prototype.corners=function(){return this.bounds.corners()},Morph.prototype.leftCenter=function(){return this.bounds.leftCenter()},Morph.prototype.rightCenter=function(){return this.bounds.rightCenter()},Morph.prototype.topCenter=function(){return this.bounds.topCenter()},Morph.prototype.topLeft=function(){return this.bounds.topLeft()},Morph.prototype.topRight=function(){return this.bounds.topRight()},Morph.prototype.position=function(){return this.bounds.origin},Morph.prototype.extent=function(){return this.bounds.extent()},Morph.prototype.width=function(){return this.bounds.width()},Morph.prototype.height=function(){return this.bounds.height()},Morph.prototype.fullBounds=function(){var t;return t=this.bounds,this.children.forEach((e=>{e.isVisible&&(t=t.merge(e.fullBounds()))})),t},Morph.prototype.fullBoundsNoShadow=function(){var t;return t=this.bounds,this.children.forEach((e=>{e instanceof ShadowMorph||!e.isVisible||(t=t.merge(e.fullBounds()))})),t},Morph.prototype.visibleBounds=function(){var t=this.bounds;return this.allParents().filter((t=>t instanceof FrameMorph)).forEach((e=>t=t.intersect(e.bounds))),t},Morph.prototype.moveBy=function(t){var e=this.children,o=e.length;for(this.changed(),this.bounds=this.bounds.translateBy(t),this.changed();o>0;o-=1)e[o-1].moveBy(t)},Morph.prototype.setPosition=function(t){var e=t.subtract(this.topLeft());e.eq(ZERO)||this.moveBy(e)},Morph.prototype.setLeft=function(t){this.setPosition(new Point(t,this.top()))},Morph.prototype.setRight=function(t){this.setPosition(new Point(t-this.width(),this.top()))},Morph.prototype.setTop=function(t){this.setPosition(new Point(this.left(),t))},Morph.prototype.setBottom=function(t){this.setPosition(new Point(this.left(),t-this.height()))},Morph.prototype.setCenter=function(t){this.setPosition(t.subtract(this.extent().floorDivideBy(2)))},Morph.prototype.setFullCenter=function(t){this.setPosition(t.subtract(this.fullBounds().extent().floorDivideBy(2)))},Morph.prototype.keepWithin=function(t){var e,o,i,s;(o=this.fullBounds().right()-t.right())>0&&this.moveBy(new Point(-o,0)),(e=this.fullBounds().left()-t.left())<0&&this.moveBy(new Point(-e,0)),(s=this.fullBounds().bottom()-t.bottom())>0&&this.moveBy(new Point(0,-s)),(i=this.fullBounds().top()-t.top())<0&&this.moveBy(new Point(0,-i))},Morph.prototype.scrollIntoView=function(){var t,e,o,i,s=this.parentThatIsA(ScrollFrameMorph);s&&((e=Math.min(this.fullBounds().right()-s.right(),s.contents.right()-s.right()))>0&&s.contents.moveBy(new Point(-e,0)),(t=this.fullBounds().left()-s.left())<0&&s.contents.moveBy(new Point(-t,0)),(o=this.fullBounds().top()-s.top())<0&&s.contents.moveBy(new Point(0,-o)),(i=this.fullBounds().bottom()-s.bottom())>0&&s.contents.moveBy(new Point(0,-i)),s.adjustScrollBars())},Morph.prototype.setExtent=function(t){t.eq(this.extent())||(this.changed(),this.bounds.setWidth(t.x),this.bounds.setHeight(t.y),this.fixLayout(),this.rerender())},Morph.prototype.setWidth=function(t){this.setExtent(new Point(t||0,this.height()))},Morph.prototype.setHeight=function(t){this.setExtent(new Point(this.width(),t||0))},Morph.prototype.setColor=function(t){t&&(this.color.eq(t)||(this.color=t,this.rerender()))},Morph.prototype.getImage=function(){var t;return this.cachedImage&&!this.shouldRerender?this.cachedImage:(t=newCanvas(this.extent(),!1,this.cachedImage),this.isCachingImage&&(this.cachedImage=t),this.render(t.getContext("2d")),this.shouldRerender=!1,t)},Morph.prototype.render=function(t){t.fillStyle=this.getRenderColor().toString(),t.fillRect(0,0,this.width(),this.height()),this.cachedTexture?this.renderCachedTexture(t):this.texture&&this.renderTexture(this.texture,t)},Morph.prototype.getRenderColor=function(){return this.color},Morph.prototype.fixLayout=function(){},Morph.prototype.fixHolesLayout=function(){},Morph.prototype.renderTexture=function(t,e){this.cachedTexture=new Image,this.cachedTexture.onload=()=>this.changed(),this.cachedTexture.src=this.texture=t},Morph.prototype.renderCachedTexture=function(t){var e,o,i=this.cachedTexture,s=Math.floor(this.width()/i.width),r=Math.floor(this.height()/i.height);for(t.save(),t.globalAlpha=this.alpha,t.beginPath(),t.rect(0,0,this.width(),this.height()),t.clip(),o=0;o<=r;o+=1)for(e=0;e<=s;e+=1)t.drawImage(i,e*i.width,o*i.height);t.restore()},Morph.prototype.drawOn=function(t,e){var o,i,s,r,n,a,h=e.intersect(this.bounds),l=this.position();if(h.extent().gt(ZERO)){if(t.save(),t.globalAlpha=this.alpha,this.isCachingImage){if(o=this.getImage(),n=(i=h.translateBy(l.neg())).left(),a=i.top(),s=Math.min(i.width(),o.width-n),r=Math.min(i.height(),o.height-a),s<1||r<1)return;t.drawImage(o,n,a,s,r,h.left(),h.top(),s,r)}else t.beginPath(),t.rect(h.left(),h.top(),h.width(),h.height()),t.clip(),t.translate(l.x,l.y),this.render(t),MorphicPreferences.showHoles&&(t.translate(-l.x,-l.y),t.globalAlpha=.25,t.fillStyle="white",this.holes.forEach((e=>{var o=e.translateBy(l).intersect(h);t.fillRect(o.left(),o.top(),o.width(),o.height())})));t.restore()}},Morph.prototype.fullDrawOn=function(t,e){this.isVisible&&(this.drawOn(t,e),this.children.forEach((o=>o.fullDrawOn(t,e))))},Morph.prototype.hide=function(){this.isVisible=!1,this.changed()},Morph.prototype.show=function(){this.isVisible=!0,this.changed()},Morph.prototype.toggleVisibility=function(){this.isVisible=!this.isVisible,this.changed()},Morph.prototype.fullImage=function(){var t=this.fullBounds(),e=newCanvas(t.extent()),o=e.getContext("2d");return o.translate(-t.origin.x,-t.origin.y),this.fullDrawOn(o,t),e},Morph.prototype.shadowImage=function(t,e){var o,i,s,r,n,a=t||new Point(7,7),h=e||new Color(0,0,0);return this.fullShadowSource?(o=this.fullBounds().extent(),i=this.fullImage()):(o=this.extent(),i=this.getImage()),(n=(s=newCanvas(o)).getContext("2d")).drawImage(i,0,0),n.globalCompositeOperation="destination-out",n.drawImage(i,-a.x,-a.y),(n=(r=newCanvas(o)).getContext("2d")).drawImage(s,0,0),n.globalCompositeOperation="source-atop",n.fillStyle=h.toString(),n.fillRect(0,0,o.x,o.y),r},Morph.prototype.shadowImageBlurred=function(t,e){var o,i,s,r,n=t||new Point(7,7),a=this.shadowBlur,h=e||new Color(0,0,0);return this.fullShadowSource?(o=this.fullBounds().extent().add(2*a),i=this.fullImage()):(o=this.extent().add(2*a),i=this.getImage()),(r=(s=newCanvas(o)).getContext("2d")).shadowOffsetX=n.x,r.shadowOffsetY=n.y,r.shadowBlur=a,r.shadowColor=h.toString(),r.drawImage(i,a-n.x,a-n.y),r.shadowOffsetX=0,r.shadowOffsetY=0,r.shadowBlur=0,r.globalCompositeOperation="destination-out",r.drawImage(i,a-n.x,a-n.y),s},Morph.prototype.shadow=function(t,e,o){var i=new ShadowMorph,s=t||new Point(7,7),r=e||(0===e?0:.2),n=this.fullBounds();return i.setExtent(n.extent().add(2*this.shadowBlur)),useBlurredShadows?(i.cachedImage=this.shadowImageBlurred(s,o),i.alpha=r,i.setPosition(n.origin.add(s).subtract(this.shadowBlur))):(i.cachedImage=this.shadowImage(s,o),i.alpha=r,i.setPosition(n.origin.add(s))),i.shouldRerender=!1,i},Morph.prototype.addShadow=function(t,e,o){var i,s=t||new Point(7,7),r=e||(0===e?0:.2);return i=this.shadow(s,r,o),this.addBack(i),this.fullChanged(),i},Morph.prototype.getShadow=function(){var t;return 0!==(t=this.children.slice(0).reverse().filter((t=>t instanceof ShadowMorph))).length?t[0]:null},Morph.prototype.removeShadow=function(){var t=this.getShadow();null!==t&&(this.fullChanged(),this.removeChild(t))},Morph.prototype.penTrails=function(){return this.getImage()},Morph.prototype.rerender=function(){this.shouldRerender=!0,this.changed()},Morph.prototype.changed=function(){var t=this.root();t instanceof WorldMorph&&t.broken.push(this.visibleBounds().spread()),this.parent&&this.parent.childChanged(this)},Morph.prototype.fullChanged=function(){var t=this.root();t instanceof WorldMorph&&t.broken.push(this.fullBounds().spread())},Morph.prototype.childChanged=function(){this.parent&&this.parent.childChanged(this)},Morph.prototype.world=function(){var t=this.root();return t instanceof WorldMorph?t:t instanceof HandMorph?t.world:null},Morph.prototype.add=function(t){var e=t.parent;null!==e&&e.removeChild(t),this.addChild(t)},Morph.prototype.addBack=function(t){var e=t.parent;null!==e&&e.removeChild(t),this.addChildFirst(t)},Morph.prototype.topMorphAt=function(t){var e,o;if(!this.isVisible)return null;for(e=this.children.length-1;e>=0;e-=1)if(o=this.children[e].topMorphAt(t))return o;if(this.bounds.containsPoint(t)){if(this.holes.some((e=>e.translateBy(this.position()).containsPoint(t))))return null;if(!this.isFreeForm)return this;if(!this.isTransparentAt(t))return this}return null},Morph.prototype.topMorphSuchThat=function(t){var e;return t.call(null,this)?(e=detect(this.children.slice(0).reverse(),t))?e.topMorphSuchThat(t):this:null},Morph.prototype.overlappedMorphs=function(){var t=this.world(),e=this.fullBounds(),o=this.allParents(),i=this.allChildren();return t.allChildren().filter((s=>s.isVisible&&s!==this&&s!==t&&!contains(o,s)&&!contains(i,s)&&s.fullBounds().intersects(e)))},Morph.prototype.getPixelColor=function(t){var e,o;return e=t.subtract(this.bounds.origin),new Color((o=this.getImage().getContext("2d").getImageData(e.x,e.y,1,1)).data[0],o.data[1],o.data[2],o.data[3]/255)},Morph.prototype.isTransparentAt=function(t){var e;return!!this.bounds.containsPoint(t)&&!this.texture&&(e=t.subtract(this.bounds.origin),0===this.getImage().getContext("2d").getImageData(Math.floor(e.x),Math.floor(e.y),1,1).data[3])},Morph.prototype.copy=function(){var t=copy(this);return t.parent=null,t.children=[],t.bounds=this.bounds.copy(),t},Morph.prototype.fullCopy=function(){var t,e=new Map;return(t=this.copyRecordingReferences(e)).forAllChildren((t=>t.updateReferences(e))),t},Morph.prototype.copyRecordingReferences=function(t){var e=this.copy();return t.set(this,e),this.children.forEach((o=>e.add(o.copyRecordingReferences(t)))),e},Morph.prototype.updateReferences=function(t){var e,o,i,s,r=Object.keys(this),n=r.length;for(s=0;s<n;s+=1)(o=this[e=r[s]])&&o.isMorph&&(i=t.get(o))&&(this[e]=i)},Morph.prototype.rootForGrab=function(){return this instanceof ShadowMorph?this.parent.rootForGrab():this.parent instanceof ScrollFrameMorph?this.parent:null===this.parent||this.parent instanceof WorldMorph||this.parent instanceof FrameMorph||!0===this.isDraggable?this:this.parent.rootForGrab()},Morph.prototype.isCorrectingOutsideDrag=function(){return!0},Morph.prototype.wantsDropOf=function(t){return!(t instanceof HandleMorph||t instanceof MenuMorph||t instanceof InspectorMorph)&&this.acceptsDrops},Morph.prototype.pickUp=function(t){var e=t||this.world();this.setPosition(e.hand.position().subtract(this.extent().floorDivideBy(2))),e.hand.grab(this)},Morph.prototype.isPickedUp=function(){return null!==this.parentThatIsA(HandMorph)},Morph.prototype.situation=function(){return this.parent?{origin:this.parent,position:this.position().subtract(this.parent.position())}:null},Morph.prototype.slideBackTo=function(t,e,o,i){var s=t.origin.position().add(t.position);this.glideTo(s,e,null,(()=>{t.origin.add(this),o&&o(),this.justDropped&&this.justDropped(),t.origin.reactToDropOf&&t.origin.reactToDropOf(this),i&&i()}))},Morph.prototype.glideTo=function(t,e,o,i){var s=this.world(),r=new Animation((t=>this.setLeft(t)),(()=>this.left()),-(this.left()-t.x),e||100,o);s.animations.push(r),s.animations.push(new Animation((t=>this.setTop(t)),(()=>this.top()),-(this.top()-t.y),e||100,o,(()=>{r.setter(r.destination),r.isActive=!1,i()})))},Morph.prototype.fadeTo=function(t,e,o,i){var s=this.world(),r=this.alpha;this.children.forEach((i=>i.fadeTo(t,e,o))),s.animations.push(new Animation((t=>{this.alpha=t,this.changed()}),(()=>this.alpha),t-this.alpha,e||200,o,(()=>{this.alpha=r,i&&i()})))},Morph.prototype.perish=function(t,e){this.fadeTo(0,t||100,null,(()=>{this.destroy(),e&&e()}))},Morph.prototype.nop=nop,Morph.prototype.resize=function(){this.world().activeHandle=new HandleMorph(this)},Morph.prototype.move=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"move")},Morph.prototype.moveCenter=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"moveCenter")},Morph.prototype.hint=function(t){var e,o;o=t,t?t.toString&&(o=t.toString()):o="NULL",(e=new MenuMorph(this,o)).isDraggable=!0,e.popUpCenteredAtHand(this.world())},Morph.prototype.inform=function(t){var e,o;o=t,t?t.toString&&(o=t.toString()):o="NULL",(e=new MenuMorph(this,o)).addItem("Ok"),e.isDraggable=!0,e.popUpCenteredAtHand(this.world())},Morph.prototype.prompt=function(t,e,o,i,s,r,n,a,h=nop){var l,p,c,d;n&&(d=!0),l=new MenuMorph(e||null,t||"",o||null),p=new StringFieldMorph(i||"",s||100,MorphicPreferences.prompterFontSize,MorphicPreferences.prompterFontName,!1,!1,d),l.items.push(p),(n||MorphicPreferences.useSliderForInput)&&((c=new SliderMorph(r||0,n,parseFloat(i),Math.floor((n-r)/4),"horizontal")).alpha=1,c.color=new Color(225,225,225),c.button.color=l.borderColor,c.button.highlightColor=c.button.color.copy(),c.button.highlightColor.b+=100,c.button.pressColor=c.button.color.copy(),c.button.pressColor.b+=150,c.setHeight(MorphicPreferences.prompterSliderSize),c.action=a?t=>{p.changed(),p.text.text=Math.round(t).toString(),p.text.fixLayout(),p.text.changed(),p.text.edit(),h(Math.round(t))}:t=>{p.changed(),p.text.text=t.toString(),p.text.fixLayout(),p.text.changed(),h(t)},l.items.push(c)),l.addLine(2),l.addItem("Ok",(()=>p.string())),l.addItem("Cancel",(()=>(h(i),null))),l.isDraggable=!0,l.popUpAtHand(this.world()),p.text.edit()},Morph.prototype.pickColor=function(t,e,o,i){var s,r;s=new MenuMorph(e||null,t||"",o||null),r=new ColorPickerMorph(i),s.items.push(r),s.addLine(2),s.addItem("Ok",(()=>r.getChoice())),s.addItem("Cancel",(()=>null)),s.isDraggable=!0,s.popUpAtHand(this.world())},Morph.prototype.inspect=function(t){var e,o=this.world instanceof Function?this.world():this.root()||this.world,i=this;t&&(i=t),(e=new InspectorMorph(i)).setPosition(o.hand.position()),e.keepWithin(o),o.add(e),e.changed()},Morph.prototype.inspectKeyEvent=function(t){this.inform("Key pressed: "+String.fromCharCode(t.charCode)+"\n------------------------\ncharCode: "+t.charCode.toString()+"\nkeyCode: "+t.keyCode.toString()+"\nkey: "+t.key.toString()+"\nshiftKey: "+t.shiftKey.toString()+"\naltKey: "+t.altKey.toString()+"\nctrlKey: "+t.ctrlKey.toString()+"\ncmdKey: "+t.metaKey.toString())},Morph.prototype.contextMenu=function(){var t;return this.customContextMenu?this.customContextMenu:(t=this.world instanceof Function?this.world():this.world)&&t.isDevMode?this.parent===t?this.developersMenu():this.hierarchyMenu():this.userMenu()||this.parent&&this.parent.userMenu()},Morph.prototype.hierarchyMenu=function(){var t=this.allParents(),e=this.world instanceof Function?this.world():this.world,o=new MenuMorph(this,null);return t.forEach((t=>{t.developersMenu&&t!==e&&o.addMenu(t.toString().slice(0,50),t.developersMenu())})),o},Morph.prototype.developersMenu=function(){var t=this.world instanceof Function?this.world():this.world,e=this.userMenu()||this.parent&&this.parent.userMenu(),o=new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]);return e&&(o.addMenu("user features",e),o.addLine()),o.addItem("color...",(()=>{this.pickColor(o.title+localize("\ncolor:"),this.setColor,this,this.color)}),"choose another color \nfor this morph"),o.addItem("transparency...",(()=>{this.prompt(o.title+localize("\nalpha\nvalue:"),this.setAlphaScaled,this,(100*this.alpha).toString(),null,1,100,!0)}),"set this morph's\nalpha value"),o.addItem("resize...","resize","show a handle\nwhich can be dragged\nto change this morph's extent"),o.addLine(),o.addItem("duplicate",(()=>this.fullCopy().pickUp(this.world())),"make a copy\nand pick it up"),o.addItem("pick up","pickUp","detach and put \ninto the hand"),o.addItem("attach...","attach","stick this morph\nto another one"),o.addItem("move...","move","show a handle\nwhich can be dragged\nto move this morph"),o.addItem("inspect...","inspect","open a window\non all properties"),o.addItem("pic...",(()=>window.open(this.fullImage().toDataURL())),"open a new window\nwith a picture of this morph"),o.addLine(),this.isDraggable?o.addItem("lock","toggleIsDraggable","make this morph\nunmovable"):o.addItem("unlock","toggleIsDraggable","make this morph\nmovable"),o.addItem("hide","hide"),o.addItem("delete","destroy"),this instanceof WorldMorph||(o.addLine(),o.addItem("World...",(()=>t.contextMenu().popUpAtHand(t)),"show the\nWorld's menu")),o},Morph.prototype.userMenu=function(){return null},Morph.prototype.addToDemoMenu=function(t){WorldMorph.prototype.customMorphs.push(t)},Morph.prototype.setAlphaScaled=function(t){var e,o;"number"==typeof t?(o=t/100,this.alpha=Math.min(Math.max(o,0),1)):(e=parseFloat(t),isNaN(e)||(o=e/100,this.alpha=Math.min(Math.max(o,0),1))),this.changed()},Morph.prototype.attach=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose new parent:");t.forEach((t=>{e.addItem(t.toString().slice(0,50),(()=>{t.add(this),this.isDraggable=!1}))})),t.length>0&&e.popUpAtHand(this.world())},Morph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable},Morph.prototype.colorSetters=function(){return["color"]},Morph.prototype.numericalSetters=function(){return["setLeft","setTop","setWidth","setHeight","setAlphaScaled"]},Morph.prototype.allEntryFields=function(){return this.allChildren().filter((t=>t.isEditable&&(t instanceof StringMorph||t instanceof TextMorph)))},Morph.prototype.nextEntryField=function(t){var e=this.allEntryFields(),o=e.indexOf(t);return-1!==o&&e.length>o+1?e[o+1]:e[0]},Morph.prototype.previousEntryField=function(t){var e=this.allEntryFields(),o=e.indexOf(t);return-1!==o?o>0?e[o-1]:e[e.length-1]:e[0]},Morph.prototype.tab=function(t){this.nextTab?this.nextTab(t):this.parent&&this.parent.tab(t)},Morph.prototype.backTab=function(t){this.previousTab?this.previousTab(t):this.parent&&this.parent.backTab(t)},Morph.prototype.escalateEvent=function(t,e){for(var o=this.parent;!o[t]&&null!==o.parent;)o=o.parent;o[t]&&o[t](e)},Morph.prototype.evaluateString=function(code){var result;try{result=eval(code),this.changed()}catch(t){this.inform(t)}return result},Morph.prototype.isTouching=function(t){var e,o,i=this.overlappingPixels(t);if(!i)return!1;for(e=i[0].length,o=3;o<e;o+=4)if(i[0][o]&&i[1][o])return!0;return!1},Morph.prototype.overlappingPixels=function(t){var e,o,i=this.fullBounds(),s=t.fullBounds(),r=i.intersect(s);return!(r.width()<1||r.height()<1)&&(e=this.fullImage(),o=t.fullImage(),e.isRetinaEnabled!==o.isRetinaEnabled&&(e=normalizeCanvas(e,!0),o=normalizeCanvas(o,!0)),[e.getContext("2d").getImageData(r.left()-this.left(),r.top()-this.top(),r.width(),r.height()).data,o.getContext("2d").getImageData(r.left()-t.left(),r.top()-t.top(),r.width(),r.height()).data])},ShadowMorph.prototype=new Morph,ShadowMorph.prototype.constructor=ShadowMorph,ShadowMorph.uber=Morph.prototype,ShadowMorph.prototype.init=function(){ShadowMorph.uber.init.call(this),this.isCachingImage=!0},ShadowMorph.prototype.topMorphAt=function(){return null},HandleMorph.prototype=new Morph,HandleMorph.prototype.constructor=HandleMorph,HandleMorph.uber=Morph.prototype,HandleMorph.prototype.init=function(t,e,o,i,s,r){var n=MorphicPreferences.handleSize;this.target=t||null,this.minExtent=new Point(e||0,o||0),this.inset=new Point(i||0,s||i||0),this.type=r||"resize",this.isHighlighted=!1,HandleMorph.uber.init.call(this),this.color=WHITE,this.isDraggable=!1,"movePivot"===this.type&&(n*=2),this.setExtent(new Point(n,n)),this.fixLayout()},HandleMorph.prototype.fixLayout=function(){this.target&&("moveCenter"===this.type?this.setCenter(this.target.center()):"movePivot"===this.type?this.setCenter(this.target.rotationCenter()):this.setPosition(this.target.bottomRight().subtract(this.extent().add(this.inset))),this.target.add(this),this.target.changed())},HandleMorph.prototype.render=function(t){"movePivot"===this.type?this.isHighlighted?this.renderCrosshairsOn(t,.5):this.renderCrosshairsOn(t,.6):this.isHighlighted?this.renderHandleOn(t,new Color(100,100,255),WHITE):this.renderHandleOn(t,this.color,new Color(100,100,100))},HandleMorph.prototype.renderCrosshairsOn=function(t,e){var o=this.width()/2;t.fillStyle="rgba(255, 255, 255, 0.5)",t.beginPath(),t.arc(o,o,.9*o,radians(0),radians(360),!1),t.fill(),t.strokeStyle="black",t.lineWidth=1,t.beginPath(),t.arc(o,o,o*e,radians(0),radians(360),!1),t.stroke(),t.moveTo(0,o),t.lineTo(this.width(),o),t.stroke(),t.moveTo(o,0),t.lineTo(o,this.height()),t.stroke()},HandleMorph.prototype.renderHandleOn=function(t,e,o){var i,s,r,n=0===this.type.indexOf("move"),a=new Point(0,this.height()),h=new Point(this.width(),0);if(t.lineWidth=1,t.lineCap="round",t.strokeStyle=e.toString(),n)for(i=a.copy(),s=h.copy(),r=0;r<=this.height();r+=6)i.y=a.y-r,s.y=h.y-r,t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.closePath(),t.stroke();for(i=a.copy(),s=h.copy(),r=0;r<=this.width();r+=6)i.x=a.x+r,s.x=h.x+r,t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.closePath(),t.stroke();if(t.strokeStyle=o.toString(),n)for(i=a.copy(),s=h.copy(),r=-2;r<=this.height();r+=6)i.y=a.y-r,s.y=h.y-r,t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.closePath(),t.stroke();for(i=a.copy(),s=h.copy(),r=2;r<=this.width();r+=6)i.x=a.x+r,s.x=h.x+r,t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.closePath(),t.stroke()},HandleMorph.prototype.step=null,HandleMorph.prototype.mouseDownLeft=function(t){var e,o=this.root();if(!this.target)return null;e=0===this.type.indexOf("move")?t.subtract(this.center()):t.subtract(this.bounds.origin),this.step=()=>{var t,i;o.hand.mouseButton?(t=o.hand.bounds.origin.copy().subtract(e),"resize"===this.type?(i=(i=t.add(this.extent().add(this.inset)).subtract(this.target.bounds.origin)).max(this.minExtent),this.target.setExtent(i),this.setPosition(this.target.bottomRight().subtract(this.extent().add(this.inset)))):"moveCenter"===this.type?this.target.setCenter(t):"movePivot"===this.type?(this.target.setPivot(t),this.setCenter(this.target.rotationCenter())):this.target.setPosition(t.subtract(this.target.extent()).add(this.extent()))):this.step=null},this.target.step||(this.target.step=nop)},HandleMorph.prototype.rootForGrab=function(){return this},HandleMorph.prototype.mouseEnter=function(){this.isHighlighted=!0,this.changed()},HandleMorph.prototype.mouseLeave=function(){this.isHighlighted=!1,this.changed()},HandleMorph.prototype.attach=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:");t.forEach((t=>{e.addItem(t.toString().slice(0,50),(()=>{this.isDraggable=!1,this.target=t,this.fixLayout()}))})),t.length>0&&e.popUpAtHand(this.world())},PenMorph.prototype=new Morph,PenMorph.prototype.constructor=PenMorph,PenMorph.uber=Morph.prototype,PenMorph.prototype.init=function(){var t=4*MorphicPreferences.handleSize;this.isWarped=!1,this.heading=0,this.isDown=!0,this.size=1,this.penPoint="tip",this.penBounds=null,HandleMorph.uber.init.call(this),this.setExtent(new Point(t,t))},PenMorph.prototype.changed=function(){this.isWarped||PenMorph.uber.changed.call(this)},PenMorph.prototype.render=function(t,e){var o,i,s,r,n,a=e||this.heading;n=this.width()/2,o=this.center().subtract(this.bounds.origin),"tip"===this.penPoint?(i=o.distanceAngle(.75*n,a-180),s=o.distanceAngle(n,a+195),r=o.distanceAngle(n,a-195)):(i=o.distanceAngle(.75*n,a),s=o.distanceAngle(.33*n,a+230),r=o.distanceAngle(.33*n,a-230)),this.penBounds=new Rectangle(Math.min(o.x,i.x,s.x,r.x),Math.min(o.y,i.y,s.y,r.y),Math.max(o.x,i.x,s.x,r.x),Math.max(o.y,i.y,s.y,r.y)),t.fillStyle=this.color.toString(),t.beginPath(),t.moveTo(o.x,o.y),t.lineTo(s.x,s.y),t.lineTo(i.x,i.y),t.lineTo(r.x,r.y),t.closePath(),t.strokeStyle="white",t.lineWidth=3,t.stroke(),t.strokeStyle="black",t.lineWidth=1,t.stroke(),t.fill()},PenMorph.prototype.setHeading=function(t){this.heading=(+t%360+360)%360,this.fixLayout(),this.rerender()},PenMorph.prototype.numericalSetters=function(){return["setLeft","setTop","setWidth","setHeight","setAlphaScaled","setHeading"]},PenMorph.prototype.developersMenu=function(){var t=PenMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("set rotation","setRotation","interactively turn this morph\nusing a dial widget"),t},PenMorph.prototype.setRotation=function(){var t,e,o=this.name||this.constructor.name;o.length>10&&(o=o.slice(0,9)+"..."),t=new MenuMorph(this,o),(e=new DialMorph(null,null,this.heading)).rootForGrab=()=>e,e.target=this,e.action="setHeading",t.items.push(e),t.addLine(),t.addItem("(90) right",(()=>this.setHeading(90))),t.addItem("(-90) left",(()=>this.setHeading(-90))),t.addItem("(0) up",(()=>this.setHeading(0))),t.addItem("(180) down",(()=>this.setHeading(180))),t.isDraggable=!0,t.popUpAtHand(this.world())},PenMorph.prototype.drawLine=function(t,e){var o=this.parent.penTrails().getContext("2d"),i=t.subtract(this.parent.bounds.origin),s=e.subtract(this.parent.bounds.origin);this.isDown&&(o.lineWidth=this.size,o.strokeStyle=this.color.toString(),o.lineCap="round",o.lineJoin="round",o.beginPath(),o.moveTo(i.x,i.y),o.lineTo(s.x,s.y),o.stroke(),!1===this.isWarped&&this.world().broken.push(t.rectangle(e).expandBy(Math.max(this.size/2,1)).intersect(this.parent.visibleBounds()).spread()))},PenMorph.prototype.turn=function(t){this.setHeading(this.heading+parseFloat(t))},PenMorph.prototype.forward=function(t){var e,o=this.center(),i=parseFloat(t);e=i>=0?this.position().distanceAngle(i,this.heading):this.position().distanceAngle(Math.abs(i),this.heading-180),this.setPosition(e),this.drawLine(o,this.center())},PenMorph.prototype.down=function(){this.isDown=!0},PenMorph.prototype.up=function(){this.isDown=!1},PenMorph.prototype.clear=function(){this.parent.rerender()},PenMorph.prototype.startWarp=function(){this.isWarped=!0},PenMorph.prototype.endWarp=function(){this.isWarped=!1,this.parent.changed()},PenMorph.prototype.warp=function(t){this.startWarp(),t.call(this),this.endWarp()},PenMorph.prototype.warpOp=function(t,e){this.startWarp(),this[t].apply(this,e),this.endWarp()},PenMorph.prototype.warpSierpinski=function(t,e){this.warpOp("sierpinski",[t,e])},PenMorph.prototype.sierpinski=function(t,e){var o;if(t>e)for(o=0;o<3;o+=1)this.sierpinski(.5*t,e),this.turn(120),this.forward(t)},PenMorph.prototype.warpTree=function(t,e,o){this.warpOp("tree",[t,e,o])},PenMorph.prototype.tree=function(t,e,o){t>0&&(this.size=t,this.forward(e),this.turn(o),this.tree(t-1,.75*e,o),this.turn(-2*o),this.tree(t-1,.75*e,o),this.turn(o),this.forward(-e))},ColorPaletteMorph.prototype=new Morph,ColorPaletteMorph.prototype.constructor=ColorPaletteMorph,ColorPaletteMorph.uber=Morph.prototype,ColorPaletteMorph.prototype.init=function(t,e){ColorPaletteMorph.uber.init.call(this),this.isCachingImage=!0,this.target=t,this.targetSetter="color",this.setExtent(e),this.choice=null},ColorPaletteMorph.prototype.render=function(t){var e,o,i,s,r=this.extent();for(this.choice=BLACK,e=0;e<=r.x;e+=1)for(i=360*e/r.x,o=0;o<=r.y;o+=1)s=100-o/r.y*100,t.fillStyle="hsl("+i+",100%,"+s+"%)",t.fillRect(e,o,1,1)},ColorPaletteMorph.prototype.mouseMove=function(t){this.choice=this.getPixelColor(t),this.updateTarget()},ColorPaletteMorph.prototype.mouseDownLeft=function(t){this.choice=this.getPixelColor(t),this.updateTarget()},ColorPaletteMorph.prototype.updateTarget=function(){this.target instanceof Morph&&null!==this.choice&&(this.target[this.targetSetter]instanceof Function?this.target[this.targetSetter](this.choice):(this.target[this.targetSetter]=this.choice,this.target.rerender()))},ColorPaletteMorph.prototype.developersMenu=function(){var t=ColorPaletteMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("set target","setTarget","choose another morph\nwhose color property\n will be controlled by this one"),t},ColorPaletteMorph.prototype.setTarget=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:");t.push(this.world()),t.forEach((t=>{e.addItem(t.toString().slice(0,50),(()=>{this.target=t,this.setTargetSetter()}))})),1===t.length?(this.target=t[0],this.setTargetSetter()):t.length>0&&e.popUpAtHand(this.world())},ColorPaletteMorph.prototype.setTargetSetter=function(){var t=this.target.colorSetters(),e=new MenuMorph(this,"choose target property:");t.forEach((t=>{e.addItem(t,(()=>this.targetSetter=t))})),1===t.length?this.targetSetter=t[0]:t.length>0&&e.popUpAtHand(this.world())},GrayPaletteMorph.prototype=new ColorPaletteMorph,GrayPaletteMorph.prototype.constructor=GrayPaletteMorph,GrayPaletteMorph.uber=ColorPaletteMorph.prototype,GrayPaletteMorph.prototype.render=function(t){var e,o=this.extent();this.choice=BLACK,(e=t.createLinearGradient(0,0,o.x,o.y)).addColorStop(0,"black"),e.addColorStop(1,"white"),t.fillStyle=e,t.fillRect(0,0,o.x,o.y)},ColorPickerMorph.prototype=new Morph,ColorPickerMorph.prototype.constructor=ColorPickerMorph,ColorPickerMorph.uber=Morph.prototype,ColorPickerMorph.prototype.init=function(t){this.choice=t,ColorPickerMorph.uber.init.call(this),this.color=WHITE,this.setExtent(new Point(80,80))},ColorPickerMorph.prototype.fixLayout=function(){var t,e,o,i;this.children.forEach((t=>t.destroy())),this.children=[],this.feedback=new Morph,this.feedback.color=this.choice,this.feedback.setExtent(new Point(20,20)),t=new ColorPaletteMorph(this.feedback,new Point(this.width(),50)),e=new GrayPaletteMorph(this.feedback,new Point(this.width(),5)),t.setPosition(this.bounds.origin),this.add(t),e.setPosition(t.bottomLeft()),this.add(e),o=e.left()+Math.floor((e.width()-this.feedback.width())/2),i=e.bottom()+Math.floor((this.bottom()-e.bottom()-this.feedback.height())/2),this.feedback.setPosition(new Point(o,i)),this.add(this.feedback)},ColorPickerMorph.prototype.getChoice=function(){return this.feedback.color},ColorPickerMorph.prototype.rootForGrab=function(){return this},BlinkerMorph.prototype=new Morph,BlinkerMorph.prototype.constructor=BlinkerMorph,BlinkerMorph.uber=Morph.prototype,BlinkerMorph.prototype.init=function(t){BlinkerMorph.uber.init.call(this),this.color=new Color(0,0,0),this.fps=t||2},BlinkerMorph.prototype.step=function(){this.toggleVisibility()},CursorMorph.prototype=new BlinkerMorph,CursorMorph.prototype.constructor=CursorMorph,CursorMorph.uber=BlinkerMorph.prototype,CursorMorph.prototype.viewPadding=1,CursorMorph.prototype.init=function(t,e){var o;this.keyDownEventUsed=!1,this.target=t,this.originalContents=this.target.text,this.originalAlignment=this.target.alignment,this.slot=this.target.text.length,this.textarea=e,CursorMorph.uber.init.call(this),o=fontHeight(this.target.fontSize),this.setExtent(new Point(Math.max(Math.floor(o/20),1),o)),this.target instanceof TextMorph&&"left"!==this.target.alignment&&this.target.setAlignmentToLeft(),this.textarea.value=this.target.text,this.textarea.style.fontSize=this.target.fontSize+"px",this.gotoSlot(this.slot),this.updateTextAreaPosition(),this.syncTextareaSelectionWith(this.target)},CursorMorph.prototype.processKeyDown=function(t){var e,o=t.key,i=t.shiftKey,s=this.target instanceof StringMorph;if(!isNil(this.target.receiver)&&(t.ctrlKey||t.metaKey)){if("d"===o)return t.preventDefault(),void this.target.doIt();if("i"===o)return t.preventDefault(),void this.target.inspectIt();if("p"===o)return t.preventDefault(),void this.target.showIt()}"Tab"===o||"U+0009"===o?(i?this.target.backTab(this.target):this.target.tab(this.target),t.preventDefault(),this.target.escalateEvent("reactToEdit",this.target)):"Escape"===o?this.cancel():"Enter"===o&&(s||i)?this.accept():("ArrowDown"===o&&(e=this.target.downFrom(this.slot),this.textarea.setSelectionRange(e,e),t.preventDefault()),"ArrowUp"===o&&(e=this.target.upFrom(this.slot),this.textarea.setSelectionRange(e,e),t.preventDefault()),this.target.escalateEvent("reactToKeystroke",t))},CursorMorph.prototype.processKeyUp=function(t){var e=this.textarea,o=this.target;e.selectionStart===e.selectionEnd?(o.startMark=null,o.endMark=null):"backward"===e.selectionDirection?(o.startMark=e.selectionEnd,o.endMark=e.selectionStart):(o.startMark=e.selectionStart,o.endMark=e.selectionEnd),o.fixLayout(),o.rerender(),this.gotoSlot(e.selectionEnd)},CursorMorph.prototype.processInput=function(t){var e,o,i=this.target,s=this.textarea;(e=i.isNumeric?function(t){var e,o,i=0,s="";for(e=0;e<t.length;e+=1)("0"<=(o=t.charAt(e))&&o<="9"||0===e&&"-"===o||"."===o&&0===i)&&(s+=o,"."===o&&(i+=1));return s}(s.value):s.value).length<s.value.length&&(s.value=e,o=Math.min(s.selectionStart,e.length),s.selectionEnd=o,s.selectionStart=o),i.text=e,s.selectionStart===s.selectionEnd?(i.startMark=null,i.endMark=null):"backward"===s.selectionDirection?(i.startMark=s.selectionEnd,i.endMark=s.selectionStart):(i.startMark=s.selectionStart,i.endMark=s.selectionEnd),i.changed(),i.fixLayout(),i.rerender(),this.gotoSlot(s.selectionStart),this.updateTextAreaPosition(),this.target.escalateEvent("reactToInput",t)},CursorMorph.prototype.updateTextAreaPosition=function(){var t=getDocumentPositionOf(this.target.world().worldCanvas),e=this.target.bounds.origin.add(new Point(t.x,t.y));function o(t){return Math.ceil(t)+"px"}this.textarea.style.top=o(e.y),this.textarea.style.left=o(e.x)},CursorMorph.prototype.syncTextareaSelectionWith=function(t){var e=t.startMark,o=t.endMark;e===o?this.textarea.setSelectionRange(this.slot,this.slot,"none"):e<o?this.textarea.setSelectionRange(e,o,"forward"):this.textarea.setSelectionRange(o,e,"backward"),this.textarea.focus()},CursorMorph.prototype.gotoSlot=function(t){var e,o,i=this.target.text.length,s=this.target.slotPosition(t);this.slot=t<0?0:t>i?i:t,this.parent&&this.target.isScrollable&&(e=this.parent.right()-this.viewPadding,o=this.parent.left()+this.viewPadding,s.x>e&&(this.target.setLeft(this.target.left()+e-s.x),s.x=e),s.x<o&&(o=Math.min(this.parent.left(),o),this.target.setLeft(this.target.left()+o-s.x),s.x=o),this.target.right()<e&&e-this.target.width()<o&&(s.x+=e-this.target.right(),this.target.setRight(e))),this.show(),this.setPosition(s),this.parent&&this.parent.parent instanceof ScrollFrameMorph&&this.target.isScrollable&&this.parent.parent.scrollCursorIntoView(this)},CursorMorph.prototype.gotoPos=function(t){this.gotoSlot(this.target.slotAt(t)),this.show()},CursorMorph.prototype.updateSelection=function(t){t?isNil(this.target.endMark)&&isNil(this.target.startMark)?(this.target.startMark=this.slot,this.target.endMark=this.slot):this.target.endMark!==this.slot&&(this.target.endMark=this.slot,this.target.changed()):this.target.clearSelection()},CursorMorph.prototype.accept=function(){var t=this.root();t&&t.stopEditing(),this.escalateEvent("accept",this)},CursorMorph.prototype.cancel=function(){var t=this.root();this.undo(),t&&t.stopEditing(),this.escalateEvent("cancel",this)},CursorMorph.prototype.undo=function(){this.target.text=this.originalContents,this.target.changed(),this.target.fixLayout(),this.target.changed(),this.gotoSlot(0)},CursorMorph.prototype.destroy=function(){this.target.alignment!==this.originalAlignment&&(this.target.alignment=this.originalAlignment,this.target.changed()),CursorMorph.uber.destroy.call(this),this.target.world().resetKeyboardHandler()},BoxMorph.prototype=new Morph,BoxMorph.prototype.constructor=BoxMorph,BoxMorph.uber=Morph.prototype,BoxMorph.prototype.init=function(t,e,o){this.edge=t||4,this.border=e||(0===e?0:2),this.borderColor=o||BLACK,BoxMorph.uber.init.call(this)},BoxMorph.prototype.render=function(t){0!==this.edge||0!==this.border?(t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),this.border>0&&(t.lineWidth=this.border,t.strokeStyle=this.borderColor.toString(),t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke())):BoxMorph.uber.render.call(this,t)},BoxMorph.prototype.outlinePath=function(t,e,o){var i=this.width(),s=this.height(),r=Math.min(e,(Math.min(i,s)-o)/2),n=r+o;t.arc(n,n,r,radians(-180),radians(-90),!1),t.arc(i-n,n,r,radians(-90),radians(-0),!1),t.arc(i-n,s-n,r,radians(0),radians(90),!1),t.arc(n,s-n,r,radians(90),radians(180),!1)},BoxMorph.prototype.developersMenu=function(){var t=BoxMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("border width...",(()=>{this.prompt(t.title+"\nborder\nwidth:",this.setBorderWidth,this,this.border.toString(),null,0,100,!0)}),"set the border's\nline size"),t.addItem("border color...",(()=>{this.pickColor(t.title+"\nborder color:",this.setBorderColor,this,this.borderColor)}),"set the border's\nline color"),t.addItem("corner size...",(()=>{this.prompt(t.title+"\ncorner\nsize:",this.setCornerSize,this,this.edge.toString(),null,0,100,!0)}),"set the corner's\nradius"),t},BoxMorph.prototype.setBorderWidth=function(t){var e;"number"==typeof t?this.border=Math.max(t,0):(e=parseFloat(t),isNaN(e)||(this.border=Math.max(e,0))),this.changed()},BoxMorph.prototype.setBorderColor=function(t){t&&(this.borderColor=t,this.changed())},BoxMorph.prototype.setCornerSize=function(t){var e;"number"==typeof t?this.edge=Math.max(t,0):(e=parseFloat(t),isNaN(e)||(this.edge=Math.max(e,0))),this.changed()},BoxMorph.prototype.colorSetters=function(){return["color","borderColor"]},BoxMorph.prototype.numericalSetters=function(){var t=BoxMorph.uber.numericalSetters.call(this);return t.push("setBorderWidth","setCornerSize"),t},SpeechBubbleMorph.prototype=new BoxMorph,SpeechBubbleMorph.prototype.constructor=SpeechBubbleMorph,SpeechBubbleMorph.uber=BoxMorph.prototype,SpeechBubbleMorph.prototype.init=function(t,e,o,i,s,r,n,a){this.isPointingRight=!0,this.contents=t||"",this.padding=r||0,this.isThought=n||!1,this.isClickable=!1,SpeechBubbleMorph.uber.init.call(this,o||6,i||(0===i?0:1),s||new Color(140,140,140)),this.hasShadow=!0!==a,this.noDropShadow=!0,this.fullShadowSource=!1,this.color=e||new Color(230,230,230),this.fixLayout()},SpeechBubbleMorph.prototype.popUp=function(t,e,o){this.fixLayout(),this.setPosition(e.subtract(new Point(0,this.height()))),this.keepWithin(t),t.add(this),this.fullChanged(),t.hand.destroyTemporaries(),t.hand.temporaries.push(this),o?this.isClickable=!0:this.mouseEnter=this.destroy},SpeechBubbleMorph.prototype.fixLayout=function(){this.contentsMorph&&this.contentsMorph.destroy(),this.contents instanceof Morph?this.contentsMorph=this.contents:isString(this.contents)?this.contentsMorph=new TextMorph(this.contents,MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center"):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.setExtent(new Point(this.contents.width,this.contents.height)),this.contentsMorph.cachedImage=this.contents):this.contentsMorph=new TextMorph(this.contents.toString(),MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center"),this.add(this.contentsMorph),this.bounds.setExtent(new Point(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge),this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2)),this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1))),this.hasShadow&&(this.removeShadow(),this.addShadow(new Point(2,2),80))},SpeechBubbleMorph.prototype.outlinePath=function(t,e,o){var i,s=e+o,r=this.width(),n=this.height();function a(e,o,i){t.moveTo(e+i,o),t.arc(e,o,i,radians(0),radians(360))}t.arc(s,s,e,radians(-180),radians(-90),!1),t.arc(r-s,s,e,radians(-90),radians(-0),!1),t.arc(r-s,n-s-e,e,radians(0),radians(90),!1),this.isThought||(this.isPointingRight?(t.lineTo(s+e,n-s),t.lineTo(e/2+o,n-o)):(t.lineTo(r-(e/2+o),n-o),t.lineTo(r-(s+e),n-s))),t.arc(s,n-s-e,e,radians(90),radians(180),!1),!0===this.isThought&&(t.lineTo(o,s),this.isPointingRight?(a((i=e/4)+o,n-i-o,i),a(2*(i=e/3.2)+o,n-i-2*o,i),a(3*(i=e/2.8)+2*o,n-i-4*o,i)):(a(r-((i=e/4)+o),n-i-o,i),a(r-(2*(i=e/3.2)+o),n-i-2*o,i),a(r-(3*(i=e/2.8)+2*o),n-i-4*o,i)))},SpeechBubbleMorph.prototype.shadowImage=function(t,e){var o,i,s,r,n,a=t||new Point(7,7),h=e||new Color(0,0,0);return o=this.extent(),i=this.getImage(),(n=(s=newCanvas(o)).getContext("2d")).drawImage(i,0,0),n.globalCompositeOperation="destination-out",n.drawImage(i,-a.x,-a.y),(n=(r=newCanvas(o)).getContext("2d")).drawImage(s,0,0),n.globalCompositeOperation="source-atop",n.fillStyle=h.toString(),n.fillRect(0,0,o.x,o.y),r},SpeechBubbleMorph.prototype.shadowImageBlurred=function(t,e){var o,i,s,r,n=t||new Point(7,7),a=this.shadowBlur,h=e||new Color(0,0,0);return o=this.extent().add(2*a),i=this.getImage(),(r=(s=newCanvas(o)).getContext("2d")).shadowOffsetX=n.x,r.shadowOffsetY=n.y,r.shadowBlur=a,r.shadowColor=h.toString(),r.drawImage(i,a-n.x,a-n.y),r.shadowOffsetX=0,r.shadowOffsetY=0,r.shadowBlur=0,r.globalCompositeOperation="destination-out",r.drawImage(i,a-n.x,a-n.y),s},DialMorph.prototype=new Morph,DialMorph.prototype.constructor=DialMorph,DialMorph.uber=Morph.prototype,DialMorph.prototype.init=function(t,e,o,i,s){this.target=null,this.action=null,this.min=t||0,this.max=e||360,this.value=Math.max(this.min,(o||0)%this.max),this.tick=i||15,this.fillColor=null,DialMorph.uber.init.call(this),this.color=new Color(230,230,230),this.setRadius(s||4*MorphicPreferences.menuFontSize)},DialMorph.prototype.setRadius=function(t){this.radius=t,this.setExtent(new Point(2*this.radius,2*this.radius))},DialMorph.prototype.setValue=function(t,e,o){var i=this.max-this.min;t=t||0,this.value=this.min+(+t%i+i)%i,e&&(this.value<this.tick?this.value=this.min:this.value-=this.value%this.tick%this.value),this.changed(),o||this.updateTarget()},DialMorph.prototype.getValueOf=function(t){var e=this.max-this.min,o=this.center(),i=t.x-o.x,s=o.y-t.y;return e*(((Math.abs(i)<.001?s<0?90:270:Math.round((i>=0?0:180)-57.2957795131*Math.atan(s/i)))+90)/360)+this.min},DialMorph.prototype.setExtent=function(t){var e=Math.min(t.x,t.y);this.radius=e/2,DialMorph.uber.setExtent.call(this,new Point(e,e))},DialMorph.prototype.render=function(t){var e,o,i,s,r,n,a=this.color.lighter().toString(),h=this.max-this.min,l=h/this.tick,p=.75*this.radius,c=.85*p,d=.95*p;for(t.fillStyle=a,t.beginPath(),t.arc(this.radius,this.radius,p+Math.min(1,this.radius-p),0,2*Math.PI,!1),t.closePath(),t.fill(),t.fillStyle=this.color.toString(),t.beginPath(),t.arc(this.radius,this.radius,p,0,2*Math.PI,!1),t.closePath(),t.fill(),o=(this.value-this.min)*(2*Math.PI)/h-Math.PI/2,t.fillStyle=(this.fillColor||this.color.darker()).toString(),t.beginPath(),t.arc(this.radius,this.radius,p,Math.PI/-2,o,!1),t.lineTo(this.radius,this.radius),t.closePath(),t.fill(),t.strokeStyle=new Color(35,35,35).toString(),t.lineWidth=1,e=0;e<l;e+=1)o=(e-3)*(2*Math.PI)/l-Math.PI/2,t.beginPath(),i=this.radius+Math.cos(o)*c,s=this.radius+Math.sin(o)*c,r=this.radius+Math.cos(o)*d,n=this.radius+Math.sin(o)*d,t.moveTo(i,s),t.lineTo(r,n),t.stroke();c=.05*p,t.fillStyle="black",t.beginPath(),t.arc(this.radius,this.radius,c,0,2*Math.PI,!1),t.closePath(),t.fill(),t.strokeStyle="black",t.lineWidth=1,o=(this.value-this.min)*(2*Math.PI)/h-Math.PI/2,d=.8*p,i=this.radius+Math.cos(o)*c,s=this.radius+Math.sin(o)*c,r=this.radius+Math.cos(o)*d,n=this.radius+Math.sin(o)*d,t.beginPath(),t.moveTo(i,s),t.lineTo(r,n),t.stroke(),c*=2,r=this.radius+Math.cos(o)*(d+c),n=this.radius+Math.sin(o)*(d+c),t.fillStyle="black",t.beginPath(),t.arc(r,n,c,0,2*Math.PI,!1),t.closePath(),t.stroke(),o=(this.value-this.min)*(2*Math.PI)/h-Math.PI/2,i=this.radius+Math.cos(o)*p,s=this.radius+Math.sin(o)*p,r=this.radius+Math.cos(o)*(this.radius-1),n=this.radius+Math.sin(o)*(this.radius-1),t.beginPath(),t.moveTo(i,s),t.lineTo(r,n),t.lineWidth=3,t.strokeStyle=a,t.stroke(),t.lineWidth=1,t.strokeStyle="black",t.stroke(),o=radians(degrees(o)-4),i=this.radius+Math.cos(o)*this.radius*.9,s=this.radius+Math.sin(o)*this.radius*.9,t.beginPath(),t.moveTo(i,s),o=radians(degrees(o)+8),i=this.radius+Math.cos(o)*this.radius*.9,s=this.radius+Math.sin(o)*this.radius*.9,t.lineTo(i,s),t.lineTo(r,n),t.closePath(),t.lineWidth=3,t.strokeStyle=a,t.stroke(),t.lineWidth=1,t.strokeStyle="black",t.stroke(),t.fill()},DialMorph.prototype.step=null,DialMorph.prototype.mouseDownLeft=function(t){var e=this.root();this.step=()=>{e.hand.mouseButton?this.setValue(this.getValueOf(e.hand.bounds.origin),16!==e.currentKey):this.step=null}},DialMorph.prototype.developersMenu=function(){var t=DialMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("set target","setTarget","select another morph\nwhose numerical property\nwill be controlled by this one"),t},DialMorph.prototype.setTarget=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:");t.push(this.world()),t.forEach((t=>{e.addItem(t.toString().slice(0,50),(()=>{this.target=t,this.setTargetSetter()}))})),1===t.length?(this.target=t[0],this.setTargetSetter()):t.length>0&&e.popUpAtHand(this.world())},DialMorph.prototype.setTargetSetter=function(){var t=this.target.numericalSetters(),e=new MenuMorph(this,"choose target property:");t.forEach((t=>{e.addItem(t,(()=>this.action=t))})),1===t.length?this.action=t[0]:t.length>0&&e.popUpAtHand(this.world())},DialMorph.prototype.updateTarget=function(){this.action&&("function"==typeof this.action?this.action.call(this.target,this.value):this.target[this.action](this.value))},CircleBoxMorph.prototype=new Morph,CircleBoxMorph.prototype.constructor=CircleBoxMorph,CircleBoxMorph.uber=Morph.prototype,CircleBoxMorph.prototype.init=function(t){CircleBoxMorph.uber.init.call(this),this.orientation=t,this.autoOrient=!0,this.setExtent(new Point(20,100))},CircleBoxMorph.prototype.autoOrientation=function(){this.height()>this.width()?this.orientation="vertical":this.orientation="horizontal"},CircleBoxMorph.prototype.render=function(t){var e,o=this.width(),i=this.height();this.autoOrient&&this.autoOrientation(),"vertical"===this.orientation?(e=o/2,t.beginPath(),t.arc(e,e,e,radians(180),radians(0),!1),t.lineTo(o,i-e),t.arc(e,i-e,e,radians(0),radians(180),!1)):(e=i/2,t.beginPath(),t.arc(e,e,e,radians(90),radians(-90),!1),t.lineTo(o-e,0),t.arc(o-e,e,e,radians(-90),radians(90),!1)),t.closePath(),t.fillStyle=this.color.toString(),t.fill()},CircleBoxMorph.prototype.developersMenu=function(){var t=CircleBoxMorph.uber.developersMenu.call(this);return t.addLine(),"vertical"===this.orientation?t.addItem("horizontal...","toggleOrientation","toggle the\norientation"):t.addItem("vertical...","toggleOrientation","toggle the\norientation"),t},CircleBoxMorph.prototype.toggleOrientation=function(){var t=this.center();this.changed(),"vertical"===this.orientation?this.orientation="horizontal":this.orientation="vertical",this.setExtent(new Point(this.height(),this.width())),this.setCenter(t)},SliderButtonMorph.prototype=new CircleBoxMorph,SliderButtonMorph.prototype.constructor=SliderButtonMorph,SliderButtonMorph.uber=CircleBoxMorph.prototype,SliderButtonMorph.prototype.init=function(t){this.color=new Color(80,80,80),this.highlightColor=new Color(90,90,140),this.pressColor=new Color(80,80,160),this.userState="normal",this.is3D=!1,this.hasMiddleDip=!0,SliderButtonMorph.uber.init.call(this,t)},SliderButtonMorph.prototype.autoOrientation=nop,SliderButtonMorph.prototype.render=function(t){var e=this.color;"highlight"===this.userState?this.color=this.highlightColor:"pressed"===this.userState&&(this.color=this.pressColor),SliderButtonMorph.uber.render.call(this,t),!this.is3D&&MorphicPreferences.isFlat||this.renderEdges(t),this.color=e},SliderButtonMorph.prototype.renderEdges=function(t){var e,o,i=this.width(),s=this.height();t.lineJoin="round",t.lineCap="round","vertical"===this.orientation?(t.lineWidth=i/3,(e=t.createLinearGradient(0,0,t.lineWidth,0)).addColorStop(0,"white"),e.addColorStop(1,this.color.toString()),t.strokeStyle=e,t.beginPath(),t.moveTo(.5*t.lineWidth,i/2),t.lineTo(.5*t.lineWidth,s-i/2),t.stroke(),(e=t.createLinearGradient(i-t.lineWidth,0,i,0)).addColorStop(0,this.color.toString()),e.addColorStop(1,"black"),t.strokeStyle=e,t.beginPath(),t.moveTo(i-.5*t.lineWidth,i/2),t.lineTo(i-.5*t.lineWidth,s-i/2),t.stroke(),this.hasMiddleDip&&(o=i/4,(e=t.createLinearGradient(t.lineWidth,0,i-t.lineWidth,0)).addColorStop(0,"black"),e.addColorStop(.35,this.color.toString()),e.addColorStop(.65,this.color.toString()),e.addColorStop(1,"white"),t.fillStyle=e,t.beginPath(),t.arc(i/2,s/2,o,radians(0),radians(360),!1),t.closePath(),t.fill())):"horizontal"===this.orientation&&(t.lineWidth=s/3,(e=t.createLinearGradient(0,0,0,t.lineWidth)).addColorStop(0,"white"),e.addColorStop(1,this.color.toString()),t.strokeStyle=e,t.beginPath(),t.moveTo(s/2,.5*t.lineWidth),t.lineTo(i-s/2,.5*t.lineWidth),t.stroke(),(e=t.createLinearGradient(0,s-t.lineWidth,0,s)).addColorStop(0,this.color.toString()),e.addColorStop(1,"black"),t.strokeStyle=e,t.beginPath(),t.moveTo(s/2,s-.5*t.lineWidth),t.lineTo(i-s/2,s-.5*t.lineWidth),t.stroke(),this.hasMiddleDip&&(o=s/4,(e=t.createLinearGradient(0,t.lineWidth,0,s-t.lineWidth)).addColorStop(0,"black"),e.addColorStop(.35,this.color.toString()),e.addColorStop(.65,this.color.toString()),e.addColorStop(1,"white"),t.fillStyle=e,t.beginPath(),t.arc(this.width()/2,this.height()/2,o,radians(0),radians(360),!1),t.closePath(),t.fill()))},SliderButtonMorph.prototype.mouseEnter=function(){this.userState="highlight",this.rerender()},SliderButtonMorph.prototype.mouseLeave=function(){this.userState="normal",this.rerender()},SliderButtonMorph.prototype.mouseDownLeft=function(t){this.userState="pressed",this.rerender(),this.escalateEvent("mouseDownLeft",t)},SliderButtonMorph.prototype.mouseClickLeft=function(){this.userState="highlight",this.rerender()},SliderButtonMorph.prototype.mouseMove=function(){nop()},SliderMorph.prototype=new CircleBoxMorph,SliderMorph.prototype.constructor=SliderMorph,SliderMorph.uber=CircleBoxMorph.prototype,SliderMorph.prototype.init=function(t,e,o,i,s,r){this.target=null,this.action=null,this.start=t,this.stop=e,this.value=o,this.size=i,this.offset=null,this.button=new SliderButtonMorph,this.button.isDraggable=!1,this.button.color=new Color(200,200,200),this.button.highlightColor=new Color(210,210,255),this.button.pressColor=new Color(180,180,255),SliderMorph.uber.init.call(this,s),this.add(this.button),this.alpha=.3,this.color=r||new Color(0,0,0),this.setExtent(new Point(20,100)),this.fixLayout()},SliderMorph.prototype.autoOrientation=nop,SliderMorph.prototype.rangeSize=function(){return this.stop-this.start},SliderMorph.prototype.ratio=function(){return this.size/(this.rangeSize()+1)},SliderMorph.prototype.unitSize=function(){return"vertical"===this.orientation?(this.height()-this.button.height())/this.rangeSize():(this.width()-this.button.width())/this.rangeSize()},SliderMorph.prototype.fixLayout=function(){var t,e,o,i;this.button.orientation=this.orientation,"vertical"===this.orientation?(t=this.width()-2,e=Math.max(t,Math.round(this.height()*this.ratio())),this.button.setExtent(new Point(t,e)),o=1,i=Math.max(Math.min(Math.round((this.value-this.start)*this.unitSize()),this.height()-this.button.height()),0)):(e=this.height()-2,t=Math.max(e,Math.round(this.width()*this.ratio())),this.button.setExtent(new Point(t,e)),i=1,o=Math.max(Math.min(Math.round((this.value-this.start)*this.unitSize()),this.width()-this.button.width()),0)),this.button.setPosition(new Point(o,i).add(this.bounds.origin))},SliderMorph.prototype.updateValue=function(){var t;t="vertical"===this.orientation?this.button.top()-this.top():this.button.left()-this.left(),this.value=Math.round(t/this.unitSize()+this.start),this.updateTarget()},SliderMorph.prototype.updateTarget=function(){this.action&&("function"==typeof this.action?this.action.call(this.target,this.value):this.target[this.action](this.value))},SliderMorph.prototype.developersMenu=function(){var t=SliderMorph.uber.developersMenu.call(this);return t.addItem("show value...","showValue","display a dialog box\nshowing the selected number"),t.addItem("floor...",(()=>{this.prompt(t.title+"\nfloor:",this.setStart,this,this.start.toString(),null,0,this.stop-this.size,!0)}),"set the minimum value\nwhich can be selected"),t.addItem("ceiling...",(()=>{this.prompt(t.title+"\nceiling:",this.setStop,this,this.stop.toString(),null,this.start+this.size,100*this.size,!0)}),"set the maximum value\nwhich can be selected"),t.addItem("button size...",(()=>{this.prompt(t.title+"\nbutton size:",this.setSize,this,this.size.toString(),null,1,this.stop-this.start,!0)}),"set the range\ncovered by\nthe slider button"),t.addLine(),t.addItem("set target","setTarget","select another morph\nwhose numerical property\nwill be controlled by this one"),t},SliderMorph.prototype.showValue=function(){this.inform(this.value)},SliderMorph.prototype.userSetStart=function(t){this.start=Math.max(t,this.stop)},SliderMorph.prototype.setStart=function(t,e){var o;"number"==typeof t?this.start=Math.min(t,this.stop-this.size):(o=parseFloat(t),isNaN(o)||(this.start=Math.min(o,this.stop-this.size))),this.value=Math.max(this.value,this.start),e||this.updateTarget(),this.fixLayout(),this.rerender()},SliderMorph.prototype.setStop=function(t,e){var o;"number"==typeof t?this.stop=Math.max(t,this.start+this.size):(o=parseFloat(t),isNaN(o)||(this.stop=Math.max(o,this.start+this.size))),this.value=Math.min(this.value,this.stop),e||this.updateTarget(),this.fixLayout(),this.rerender()},SliderMorph.prototype.setSize=function(t,e){var o;"number"==typeof t?this.size=Math.min(Math.max(t,1),this.stop-this.start):(o=parseFloat(t),isNaN(o)||(this.size=Math.min(Math.max(o,1),this.stop-this.start))),this.value=Math.min(this.value,this.stop-this.size),e||this.updateTarget(),this.fixLayout(),this.rerender()},SliderMorph.prototype.setTarget=function(){var t=this.overlappedMorphs(),e=new MenuMorph(this,"choose target:");t.push(this.world()),t.forEach((t=>{e.addItem(t.toString().slice(0,50),(()=>{this.target=t,this.setTargetSetter()}))})),1===t.length?(this.target=t[0],this.setTargetSetter()):t.length>0&&e.popUpAtHand(this.world())},SliderMorph.prototype.setTargetSetter=function(){var t=this.target.numericalSetters(),e=new MenuMorph(this,"choose target property:");t.forEach((t=>{e.addItem(t,(()=>this.action=t))})),1===t.length?this.action=t[0]:t.length>0&&e.popUpAtHand(this.world())},SliderMorph.prototype.numericalSetters=function(){var t=SliderMorph.uber.numericalSetters.call(this);return t.push("setStart","setStop","setSize"),t},SliderMorph.prototype.step=null,SliderMorph.prototype.mouseDownLeft=function(t){var e;this.button.bounds.containsPoint(t)?this.offset=t.subtract(this.button.bounds.origin):this.offset=new Point,e=this.root(),this.step=()=>{var t,o,i;e.hand.mouseButton?(t=e.hand.bounds.origin,"vertical"===this.orientation?(o=this.button.bounds.origin.x,i=Math.max(Math.min(t.y-this.offset.y,this.bottom()-this.button.height()),this.top())):(i=this.button.bounds.origin.y,o=Math.max(Math.min(t.x-this.offset.x,this.right()-this.button.width()),this.left())),this.button.setPosition(new Point(o,i)),this.updateValue()):this.step=null}},MouseSensorMorph.prototype=new BoxMorph,MouseSensorMorph.prototype.constructor=MouseSensorMorph,MouseSensorMorph.uber=BoxMorph.prototype,MouseSensorMorph.prototype.init=function(t,e,o){MouseSensorMorph.uber.init.call(this),this.edge=t||4,this.border=e||2,this.color=WHITE,this.borderColor=o||BLACK,this.isTouched=!1,this.upStep=.05,this.downStep=.02},MouseSensorMorph.prototype.touch=function(){this.isTouched||(this.isTouched=!0,this.alpha=.6,this.step=()=>{this.isTouched?this.alpha<1&&(this.alpha+=this.upStep):this.alpha>this.downStep?this.alpha-=this.downStep:(this.alpha=0,this.step=null),this.changed()})},MouseSensorMorph.prototype.unTouch=function(){this.isTouched=!1},MouseSensorMorph.prototype.mouseEnter=function(){this.touch()},MouseSensorMorph.prototype.mouseLeave=function(){this.unTouch()},MouseSensorMorph.prototype.mouseDownLeft=function(){this.touch()},MouseSensorMorph.prototype.mouseClickLeft=function(){this.unTouch()},InspectorMorph.prototype=new BoxMorph,InspectorMorph.prototype.constructor=InspectorMorph,InspectorMorph.uber=BoxMorph.prototype,InspectorMorph.prototype.init=function(t){this.target=t,this.currentProperty=null,this.showing="attributes",this.markOwnProperties=!1,this.hasUserEditedDetails=!1,InspectorMorph.uber.init.call(this),this.isDraggable=!0,this.border=1,this.edge=MorphicPreferences.isFlat?1:5,this.color=new Color(60,60,60),this.borderColor=new Color(95,95,95),this.fps=25,this.label=null,this.list=null,this.detail=null,this.work=null,this.buttonInspect=null,this.buttonClose=null,this.buttonSubset=null,this.buttonEdit=null,this.resizer=null,this.target&&this.buildPanes(),this.setExtent(new Point(20*MorphicPreferences.handleSize,20*MorphicPreferences.handleSize*2/3))},InspectorMorph.prototype.setTarget=function(t){this.target=t,this.currentProperty=null,this.buildPanes()},InspectorMorph.prototype.updateCurrentSelection=function(){var t,e,o,i=this.list.selected,s=this.detail.contents.children[0],r=this.root();r&&r.keyboardFocus instanceof CursorMorph&&r.keyboardFocus.target===s?this.hasUserEditedDetails=!0:isNil(i)||this.hasUserEditedDetails||(t=this.target[i],this.currentProperty=t,e=isNil(t)?"NULL":isString(t)?t:t.toString(),s.text!==e&&((o=new TextMorph(e)).isEditable=!0,o.enableSelecting(),o.setReceiver(this.target),this.detail.setContents(o)))},InspectorMorph.prototype.buildPanes=function(){var t,e,o,i,s=[];for(t in this.children.forEach((t=>{t!==this.work&&t.destroy()})),this.children=[],this.label=new TextMorph(this.target.toString()),this.label.fontSize=MorphicPreferences.menuFontSize,this.label.isBold=!0,this.label.color=WHITE,this.add(this.label),this.target)t&&s.push(t);"attributes"===this.showing?s=s.filter((t=>"function"!=typeof this.target[t])):"methods"===this.showing&&(s=s.filter((t=>"function"==typeof this.target[t]))),i=()=>{var t,e;isObject(this.currentProperty)&&(t=this.world(),(e=new InspectorMorph(this.currentProperty)).setPosition(t.hand.position()),e.keepWithin(t),t.add(e),e.changed())},this.list=new ListMorph(this.target instanceof Array?s:s.sort(),null,this.markOwnProperties?[[new Color(0,0,180),t=>Object.prototype.hasOwnProperty.call(this.target,t)]]:null,i),this.list.action=()=>{this.hasUserEditedDetails=!1,this.updateCurrentSelection()},this.list.hBar.alpha=.6,this.list.vBar.alpha=.6,this.list.contents.step=null,this.add(this.list),this.detail=new ScrollFrameMorph,this.detail.acceptsDrops=!1,this.detail.contents.acceptsDrops=!1,this.detail.isTextLineWrapping=!0,this.detail.color=WHITE,this.detail.hBar.alpha=.6,this.detail.vBar.alpha=.6,(e=new TextMorph("")).isEditable=!0,e.enableSelecting(),e.setReceiver(this.target),this.detail.setContents(e),this.add(this.detail),null===this.work&&(this.work=new ScrollFrameMorph,this.work.acceptsDrops=!1,this.work.contents.acceptsDrops=!1,this.work.isTextLineWrapping=!0,this.work.color=WHITE,this.work.hBar.alpha=.6,this.work.vBar.alpha=.6,(o=new TextMorph("")).isEditable=!0,o.enableSelecting(),o.setReceiver(this.target),this.work.setContents(o)),this.add(this.work),this.buttonSubset=new TriggerMorph,this.buttonSubset.labelString="show...",this.buttonSubset.createLabel(),this.buttonSubset.action=()=>{var t;(t=new MenuMorph).addItem("attributes",(()=>{this.showing="attributes",this.buildPanes()})),t.addItem("methods",(()=>{this.showing="methods",this.buildPanes()})),t.addItem("all",(()=>{this.showing="all",this.buildPanes()})),t.addLine(),t.addItem(this.markOwnProperties?"un-mark own":"mark own",(()=>{this.markOwnProperties=!this.markOwnProperties,this.buildPanes()}),"highlight\n'own' properties"),t.popUpAtHand(this.world())},this.add(this.buttonSubset),this.buttonInspect=new TriggerMorph,this.buttonInspect.labelString="inspect...",this.buttonInspect.createLabel(),this.buttonInspect.action=()=>{var t,e,o;isObject(this.currentProperty)?((t=new MenuMorph).addItem("in new inspector...",(()=>{e=this.world(),(o=new InspectorMorph(this.currentProperty)).setPosition(e.hand.position()),o.keepWithin(e),e.add(o),o.changed()})),t.addItem("here...",(()=>this.setTarget(this.currentProperty))),t.popUpAtHand(this.world())):this.inform((null===this.currentProperty?"null":typeof this.currentProperty)+"\nis not inspectable")},this.add(this.buttonInspect),this.buttonEdit=new TriggerMorph,this.buttonEdit.labelString="edit...",this.buttonEdit.createLabel(),this.buttonEdit.action=()=>{var t=new MenuMorph(this);t.addItem("save","save","accept changes"),t.addLine(),t.addItem("add property...","addProperty"),t.addItem("rename...","renameProperty"),t.addItem("remove...","removeProperty"),t.popUpAtHand(this.world())},this.add(this.buttonEdit),this.buttonClose=new TriggerMorph,this.buttonClose.labelString="close",this.buttonClose.createLabel(),this.buttonClose.action=()=>this.destroy(),this.add(this.buttonClose),this.resizer=new HandleMorph(this,150,100,this.edge,this.edge),this.fixLayout()},InspectorMorph.prototype.fixLayout=function(){var t,e,o,i;t=this.left()+this.edge,e=this.top()+this.edge,o=this.right()-this.edge-t,this.label.setPosition(new Point(t,e)),this.label.setWidth(o),this.label.height()>this.height()-50&&this.bounds.setHeight(this.label.height()+50),e=this.label.bottom()+2,o=Math.min(Math.floor(this.width()/3),this.list.listContents.width()),o-=this.edge,i=this.bottom()-2*this.edge-MorphicPreferences.handleSize-e,this.list.setPosition(new Point(t,e)),this.list.setExtent(new Point(o,i)),t=this.list.right()+this.edge,o=this.right()-this.edge-t,this.detail.setPosition(new Point(t,e)),this.detail.setExtent(new Point(o,2*i/3-this.edge)),e=this.detail.bottom()+this.edge,this.work.setPosition(new Point(t,e)),this.work.setExtent(new Point(o,i/3)),t=this.list.left(),e=this.list.bottom()+this.edge,o=this.list.width(),i=MorphicPreferences.handleSize,this.buttonSubset.setPosition(new Point(t,e)),this.buttonSubset.setExtent(new Point(o,i)),t=this.detail.left(),o=(o=this.detail.width()-this.edge-MorphicPreferences.handleSize)/3-this.edge/3,this.buttonInspect.setPosition(new Point(t,e)),this.buttonInspect.setExtent(new Point(o,i)),t=this.buttonInspect.right()+this.edge,this.buttonEdit.setPosition(new Point(t,e)),this.buttonEdit.setExtent(new Point(o,i)),t=this.buttonEdit.right()+this.edge,o=this.detail.right()-this.edge-MorphicPreferences.handleSize-t,this.buttonClose.setPosition(new Point(t,e)),this.buttonClose.setExtent(new Point(o,i)),this.resizer.fixLayout()},InspectorMorph.prototype.save=function(){var t=this.detail.contents.children[0].text.toString(),e=this.list.selected;try{this.target.evaluateString("this."+e+" = "+t),this.hasUserEditedDetails=!1,this.target.changed()}catch(t){this.inform(t)}},InspectorMorph.prototype.addProperty=function(){this.prompt("new property name:",(t=>{t&&(this.target[t]=null,this.buildPanes(),this.target.changed())}),this,"property")},InspectorMorph.prototype.renameProperty=function(){var t=this.list.selected;this.prompt("property name:",(e=>{try{delete this.target[t],this.target[e]=this.currentProperty}catch(t){this.inform(t)}this.buildPanes(),this.target.changed()}),this,t)},InspectorMorph.prototype.removeProperty=function(){var t=this.list.selected;try{delete this.target[t],this.currentProperty=null,this.buildPanes(),this.target.changed()}catch(t){this.inform(t)}},InspectorMorph.prototype.step=function(){this.updateCurrentSelection();var t=this.target.toString();this.label.text!==t&&(this.label.text=t,this.fixLayout())},InspectorMorph.prototype.updateReferences=function(t){var e=this.list.activeIndex();InspectorMorph.uber.updateReferences.call(this,t),this.buildPanes(),this.list.activateIndex(e)},MenuMorph.prototype=new BoxMorph,MenuMorph.prototype.constructor=MenuMorph,MenuMorph.uber=BoxMorph.prototype,MenuMorph.prototype.init=function(t,e,o,i){this.target=t,this.title=e||null,this.environment=o||null,this.fontSize=i||null,this.items=[],this.label=null,this.world=null,this.isListContents=!1,this.hasFocus=!1,this.selection=null,this.submenu=null,MenuMorph.uber.init.call(this),this.isDraggable=!1,this.noDropShadow=!0,this.fullShadowSource=!1,this.border=null,this.edge=null},MenuMorph.prototype.addItem=function(t,e,o,i,s,r,n,a,h){this.items.push([h?t||"close":localize(t||"close"),0===e?0:e||nop,o,i,s||!1,r||!1,n,a,h])},MenuMorph.prototype.addMenu=function(t,e,o,i){this.addPair(t,e,isNil(o)?"►":o,null,i)},MenuMorph.prototype.addPair=function(t,e,o,i,s){this.addItem(t,e,i,null,null,null,null,o,s)},MenuMorph.prototype.addLine=function(t){this.items.push([0,t||1])},MenuMorph.prototype.createLabel=function(){var t;null!==this.label&&this.label.destroy(),(t=new TextMorph(localize(this.title),this.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,!0,!1,"center")).alignment="center",t.color=WHITE,t.backgroundColor=this.borderColor,t.fixLayout(),this.label=new BoxMorph(3,0),MorphicPreferences.isFlat&&(this.label.edge=0),this.label.color=this.borderColor,this.label.borderColor=this.borderColor,this.label.setExtent(t.extent().add(4)),this.label.add(t),this.label.text=t},MenuMorph.prototype.createItems=function(){var t,e,o,i,s=!1;this.children.forEach((t=>t.destroy())),this.children=[],this.isListContents||(this.edge=MorphicPreferences.isFlat?0:5,this.border=MorphicPreferences.isFlat?1:2),this.color=WHITE,this.borderColor=new Color(60,60,60),this.setExtent(new Point(0,0)),i=2,o=this.left()+4,this.isListContents||(this.title?(this.createLabel(),this.label.setPosition(this.bounds.origin.add(4)),this.add(this.label),i=this.label.bottom()):i=this.top()+4),i+=1,this.items.forEach((e=>{s=!1,e instanceof StringFieldMorph||e instanceof ColorPickerMorph||e instanceof SliderMorph||e instanceof DialMorph?t=e:0===e[0]?(s=!0,(t=new Morph).color=this.borderColor,t.setHeight(e[1])):t=new MenuItemMorph(this.target,e[1],e[0],this.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,this.environment,e[2],e[3],e[4],e[5],e[6],e[7]),s&&(i+=1),t.setPosition(new Point(o,i)),this.add(t),i+=t.height(),s&&(i+=1)})),e=this.fullBounds(),this.setExtent(e.extent().add(4)),this.adjustWidths()},MenuMorph.prototype.maxWidth=function(){var t=0;return this.parent instanceof FrameMorph&&this.parent.scrollFrame instanceof ScrollFrameMorph&&(t=this.parent.scrollFrame.width()),this.children.forEach((e=>{e instanceof MenuItemMorph?t=Math.max(t,e.label.width()+8+(e.shortcut?e.shortcut.width()+4:0)):(e instanceof StringFieldMorph||e instanceof ColorPickerMorph||e instanceof SliderMorph||e instanceof DialMorph)&&(t=Math.max(t,e.width()))})),this.label&&(t=Math.max(t,this.label.width())),t},MenuMorph.prototype.adjustWidths=function(){var t=this.maxWidth();this.children.forEach((e=>{e instanceof DialMorph||e.setWidth(t),e.fixLayout(),e===this.label&&e.text.setPosition(e.center().subtract(e.text.extent().floorDivideBy(2)))}))},MenuMorph.prototype.unselectAllItems=function(){this.children.forEach((t=>{t instanceof MenuItemMorph?"normal"!==t.userState&&(t.userState="normal",t.rerender()):t instanceof ScrollFrameMorph&&t.contents.children.forEach((t=>{t instanceof MenuItemMorph&&"normal"!==t.userState&&(t.userState="normal",t.rerender())}))}))},MenuMorph.prototype.popup=function(t,e){var o;this.createItems(),this.setPosition(e),this.addShadow(new Point(2,2),80),this.keepWithin(t),this.bottom()>t.bottom()&&(this.removeShadow(),o=this.scroll(),this.bounds.corner.y=t.bottom()-2,this.addShadow(new Point(2,2),80),o.setHeight(t.bottom()-o.top()-6),o.adjustScrollBars()),t.activeMenu&&t.activeMenu.destroy(),this.items.length<1&&!this.title||(t.add(this),t.activeMenu=this,this.world=t,this.fullChanged())},MenuMorph.prototype.scroll=function(){var t=new ScrollFrameMorph,e=this.label?1:0,o=this.children[e];return t.setPosition(o.position()),this.children.slice(e).forEach((e=>t.addContents(e))),this.add(t),t.setWidth(o.width()),t},MenuMorph.prototype.popUpAtHand=function(t){var e=t||this.world;this.popup(e,e.hand.position())},MenuMorph.prototype.popUpCenteredAtHand=function(t){var e=t||this.world;this.fixLayout(),this.popup(e,e.hand.position().subtract(this.extent().floorDivideBy(2)))},MenuMorph.prototype.popUpCenteredInWorld=function(t){var e=t||this.world;this.fixLayout(),this.popup(e,e.center().subtract(this.extent().floorDivideBy(2)))},MenuMorph.prototype.closeRootMenu=function(){this.parent instanceof MenuMorph?this.parent.closeRootMenu():this.destroy()},MenuMorph.prototype.closeSubmenu=function(){this.submenu&&(this.submenu.destroy(),this.submenu=null,this.unselectAllItems(),this.world.activeMenu=this)},MenuMorph.prototype.getFocus=function(){this.world.keyboardFocus=this,this.selection=null,this.selectFirst(),this.hasFocus=!0},MenuMorph.prototype.processKeyDown=function(t){switch(t.keyCode){case 13:case 32:return void(this.selection&&(this.selection.mouseClickLeft(),this.submenu&&this.submenu.getFocus()));case 27:return this.destroy();case 37:return this.leaveSubmenu();case 38:return this.selectUp();case 39:return this.enterSubmenu();case 40:return this.selectDown();default:nop()}},MenuMorph.prototype.processKeyUp=function(t){nop(t)},MenuMorph.prototype.processKeyPress=function(t){nop(t)},MenuMorph.prototype.selectFirst=function(){var t,e,o;for(e=(t=detect(this.children,(t=>t instanceof ScrollFrameMorph)))?t.contents.children:this.children,o=0;o<e.length;o+=1)if(e[o]instanceof MenuItemMorph)return void this.select(e[o])},MenuMorph.prototype.selectUp=function(){var t,e,o;e=((t=detect(this.children,(t=>t instanceof ScrollFrameMorph)))?t.contents.children:this.children).filter((t=>t instanceof MenuItemMorph)),this.selection?((o=e.indexOf(this.selection)-1)<0&&(o=e.length-1),this.select(e[o])):e.length&&this.select(e[0])},MenuMorph.prototype.selectDown=function(){var t,e,o;e=((t=detect(this.children,(t=>t instanceof ScrollFrameMorph)))?t.contents.children:this.children).filter((t=>t instanceof MenuItemMorph)),this.selection?((o=e.indexOf(this.selection)+1)>=e.length&&(o=0),this.select(e[o])):e.length&&this.select(e[0])},MenuMorph.prototype.enterSubmenu=function(){this.selection&&this.selection.action instanceof MenuMorph&&(this.selection.popUpSubmenu(),this.submenu&&this.submenu.getFocus())},MenuMorph.prototype.leaveSubmenu=function(){var t=this.parent;this.parent instanceof MenuMorph&&(t.submenu=null,t.hasFocus=!0,this.destroy(),t.world.keyboardFocus=t,t.world.activeMenu=t)},MenuMorph.prototype.select=function(t){this.unselectAllItems(),t.userState="highlight",t.rerender(),t.scrollIntoView(),this.selection=t},MenuMorph.prototype.destroy=function(){this.hasFocus&&(this.world.keyboardFocus=null),this.isListContents||(this.world.activeMenu=null),MenuMorph.uber.destroy.call(this)},StringMorph.prototype=new Morph,StringMorph.prototype.constructor=StringMorph,StringMorph.uber=Morph.prototype,StringMorph.prototype.measureCtx=newCanvas().getContext("2d"),StringMorph.prototype.init=function(t,e,o,i,s,r,n,a,h,l){this.text=t||(""===t?"":"StringMorph"),this.fontSize=e||12,this.fontName=l||MorphicPreferences.globalFontFamily,this.fontStyle=o||"sans-serif",this.isBold=i||!1,this.isItalic=s||!1,this.isEditable=!1,this.enableLinks=!1,this.isNumeric=r||!1,this.isPassword=!1,this.shadowOffset=n||ZERO,this.shadowColor=a||null,this.isShowingBlanks=!1,this.blanksColor=new Color(180,140,140),this.isScrollable=!0,this.currentlySelecting=!1,this.startMark=0,this.endMark=0,this.markedTextColor=WHITE,this.markedBackgoundColor=new Color(60,60,120),StringMorph.uber.init.call(this,!0),this.color=h||new Color(0,0,0),this.fixLayout()},StringMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+'("'+this.text.slice(0,30)+'...")'},StringMorph.prototype.password=function(t,e){var o,i="";for(o=0;o<e;o+=1)i+=t;return i},StringMorph.prototype.font=function(){var t="";return this.isBold&&(t+="bold "),this.isItalic&&(t+="italic "),t+this.fontSize+"px "+(this.fontName?this.fontName+", ":"")+this.fontStyle},StringMorph.prototype.getShadowRenderColor=function(){return this.shadowColor},StringMorph.prototype.fixLayout=function(t){var e,o=this.shadowOffset||ZERO,i=this.isPassword?this.password("*",this.text.length):this.text;this.measureCtx.font=this.font(),e=Math.max(this.measureCtx.measureText(i).width+Math.abs(o.x),1),this.bounds.corner=this.bounds.origin.add(new Point(e,fontHeight(this.fontSize)+Math.abs(o.y))),!t&&this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},StringMorph.prototype.render=function(t){var e,o,i,s,r,n,a,h=this.shadowOffset||ZERO,l=this.getShadowRenderColor(),p=this.isPassword?this.password("*",this.text.length):this.text;for(t.font=this.font(),t.textAlign="left",t.textBaseline="bottom",l&&(n=Math.max(h.x,0),a=Math.max(h.y,0),t.fillStyle=l.toString(),t.fillText(p,n,fontHeight(this.fontSize)+a)),n=Math.abs(Math.min(h.x,0)),a=Math.abs(Math.min(h.y,0)),t.fillStyle=this.getRenderColor().toString(),this.isShowingBlanks?this.renderWithBlanks(t,n,fontHeight(this.fontSize)+a):t.fillText(p,n,fontHeight(this.fontSize)+a),e=Math.min(this.startMark,this.endMark),o=Math.max(this.startMark,this.endMark),i=e;i<o;i+=1)s=this.slotPosition(i).subtract(this.position()),r=p.charAt(i),t.fillStyle=this.markedBackgoundColor.toString(),t.fillRect(s.x,s.y,t.measureText(r).width+1+n,fontHeight(this.fontSize)+a),t.fillStyle=this.markedTextColor.toString(),t.fillText(r,s.x,fontHeight(this.fontSize)+s.y)},StringMorph.prototype.renderWithBlanks=function(t,e,o){var i=t.measureText(" ").width,s=this.blanksColor.toString(),r=o-this.height()/2,n=this.text.split(" "),a=e||0,h=!0;n.forEach((e=>{h||(t.fillStyle=s,t.beginPath(),t.arc(a+i/2,r,i/2,radians(0),radians(360)),t.fill(),a+=i),h=!1,""!==e&&(t.fillStyle=this.getRenderColor().toString(),t.fillText(e,a,o),a+=t.measureText(e).width)}))},StringMorph.prototype.slotPosition=function(t){var e=this.isPassword?this.password("*",this.text.length):this.text,o=Math.min(Math.max(t,0),e.length);return this.measureCtx.font=this.font(),this.pos=o,new Point(this.left()+this.measureCtx.measureText(e.slice(0,o)).width,this.top())},StringMorph.prototype.slotAt=function(t){var e=this.isPassword?this.password("*",this.text.length):this.text,o=0,i=0;for(this.measureCtx.font=this.font();t.x-this.left()>i;)if(i+=this.measureCtx.measureText(e[o]).width,(o+=1)===e.length&&this.measureCtx.measureText(e).width-this.measureCtx.measureText(e[o-1]).width/2<t.x-this.left())return o;return t.x-this.left()>i-this.measureCtx.measureText(e[o-1]).width/2?o:o-1},StringMorph.prototype.upFrom=function(t){return t},StringMorph.prototype.downFrom=function(t){return t},StringMorph.prototype.startOfLine=function(){return 0},StringMorph.prototype.endOfLine=function(){return this.text.length},StringMorph.prototype.previousWordFrom=function(t){for(var e=t-1;e>0&&!isWordChar(this.text[e]);)e-=1;for(;e>0&&isWordChar(this.text[e-1]);)e-=1;return e},StringMorph.prototype.nextWordFrom=function(t){for(var e=t;e<this.endOfLine()&&!isWordChar(this.text[e]);)e+=1;for(;e<this.endOfLine()&&isWordChar(this.text[e]);)e+=1;return e},StringMorph.prototype.rawHeight=function(){return this.height()/1.2},StringMorph.prototype.developersMenu=function(){var t=StringMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("edit","edit"),t.addItem("font size...",(()=>{this.prompt(t.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,500,!0)}),"set this String's\nfont point size"),"serif"!==this.fontStyle&&t.addItem("serif","setSerif"),"sans-serif"!==this.fontStyle&&t.addItem("sans-serif","setSansSerif"),this.isBold?t.addItem("normal weight","toggleWeight"):t.addItem("bold","toggleWeight"),this.isItalic?t.addItem("normal style","toggleItalic"):t.addItem("italic","toggleItalic"),this.isShowingBlanks?t.addItem("hide blanks","toggleShowBlanks"):t.addItem("show blanks","toggleShowBlanks"),this.isPassword?t.addItem("show characters","toggleIsPassword"):t.addItem("hide characters","toggleIsPassword"),t},StringMorph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable,this.isDraggable?this.disableSelecting():this.enableSelecting()},StringMorph.prototype.toggleShowBlanks=function(){this.isShowingBlanks=!this.isShowingBlanks,this.changed(),this.fixLayout(),this.rerender()},StringMorph.prototype.toggleWeight=function(){this.isBold=!this.isBold,this.changed(),this.fixLayout(),this.rerender()},StringMorph.prototype.toggleItalic=function(){this.isItalic=!this.isItalic,this.changed(),this.fixLayout(),this.rerender()},StringMorph.prototype.toggleIsPassword=function(){this.isPassword=!this.isPassword,this.changed(),this.fixLayout(),this.rerender()},StringMorph.prototype.setSerif=function(){this.fontStyle="serif",this.changed(),this.fixLayout(),this.rerender()},StringMorph.prototype.setSansSerif=function(){this.fontStyle="sans-serif",this.changed(),this.fixLayout(),this.rerender()},StringMorph.prototype.setFontSize=function(t){var e;"number"==typeof t?this.fontSize=Math.round(Math.min(Math.max(t,4),500)):(e=parseFloat(t),isNaN(e)||(this.fontSize=Math.round(Math.min(Math.max(e,4),500)))),this.changed(),this.fixLayout(),this.rerender()},StringMorph.prototype.setText=function(t){this.text=Math.round(t).toString(),this.changed(),this.fixLayout(),this.rerender()},StringMorph.prototype.numericalSetters=function(){return["setLeft","setTop","setAlphaScaled","setFontSize","setText"]},StringMorph.prototype.edit=function(){this.root().edit(this)},StringMorph.prototype.selection=function(){var t,e;return t=Math.min(this.startMark,this.endMark),e=Math.max(this.startMark,this.endMark),this.text.slice(t,e)},StringMorph.prototype.selectionStartSlot=function(){return Math.min(this.startMark,this.endMark)},StringMorph.prototype.clearSelection=function(){!this.currentlySelecting&&isNil(this.startMark)&&isNil(this.endMark)||(this.currentlySelecting=!1,this.startMark=null,this.endMark=null,this.changed())},StringMorph.prototype.deleteSelection=function(){var t,e,o;o=this.text,t=Math.min(this.startMark,this.endMark),e=Math.max(this.startMark,this.endMark),this.text=o.slice(0,t)+o.slice(e),this.changed(),this.clearSelection()},StringMorph.prototype.selectAll=function(){var t;this.isEditable&&(this.startMark=0,t=this.root().cursor,this.endMark=this.text.length,t&&(t.gotoSlot(this.text.length),t.syncTextareaSelectionWith(this)),this.fixLayout(),this.rerender())},StringMorph.prototype.mouseDownLeft=function(t){16===this.world().currentKey?this.shiftClick(t):this.isEditable?this.clearSelection():this.escalateEvent("mouseDownLeft",t)},StringMorph.prototype.shiftClick=function(t){var e=this.root().cursor;e&&(this.startMark||(this.startMark=e.slot),e.gotoPos(t),this.endMark=e.slot,e.syncTextareaSelectionWith(this),this.changed()),this.currentlySelecting=!1,this.escalateEvent("mouseDownLeft",t)},StringMorph.prototype.mouseClickLeft=function(t){var e,o,i,s,r;if(this.isEditable)this.currentlySelecting||this.edit(),(e=this.root().cursor)&&e.gotoPos(t),this.currentlySelecting=!0;else if(this.enableLinks){for((o=this.slotAt(t))===this.text.length&&(o-=1),s=o;s>1&&isURLChar(this.text[s-1]);)s-=1;for(r=o;r<this.text.length-1&&isURLChar(this.text[r+1]);)r+=1;isURL(i=this.text.substring(s,r+1))?window.open(i,"_blank"):this.escalateEvent("mouseClickLeft",t)}else this.escalateEvent("mouseClickLeft",t)},StringMorph.prototype.mouseDoubleClick=function(t){var e=this.slotAt(t);this.isEditable?(this.edit(),e===this.text.length&&(e-=1),this.text[e]&&isWordChar(this.text[e])?this.selectWordAt(e):this.text[e]?this.selectBetweenWordsAt(e):this.selectAll(),this.root().cursor.syncTextareaSelectionWith(this)):this.escalateEvent("mouseDoubleClick",t)},StringMorph.prototype.selectWordAt=function(t){var e=this.root().cursor;0===t||isWordChar(this.text[t-1])?(e.gotoSlot(this.previousWordFrom(t)),this.startMark=e.slot,this.endMark=this.nextWordFrom(e.slot)):(e.gotoSlot(t),this.startMark=t,this.endMark=this.nextWordFrom(t)),this.changed()},StringMorph.prototype.selectBetweenWordsAt=function(t){var e=this.root().cursor;for(e.gotoSlot(this.nextWordFrom(this.previousWordFrom(t))),this.startMark=e.slot,this.endMark=e.slot;this.endMark<this.text.length&&!isWordChar(this.text[this.endMark]);)this.endMark+=1;this.changed()},StringMorph.prototype.enableSelecting=function(){this.mouseDownLeft=function(t){var e=this.root().cursor,o=!!e&&e.target===this;16===this.world().currentKey?this.shiftClick(t):(this.clearSelection(),this.isEditable&&!this.isDraggable&&(this.edit(),this.root().cursor.gotoPos(t),this.startMark=this.slotAt(t),this.endMark=this.startMark,this.currentlySelecting=!0,this.root().cursor.syncTextareaSelectionWith(this),o||this.escalateEvent("mouseDownLeft",t)))},this.mouseMove=function(t){if(this.isEditable&&this.currentlySelecting&&!this.isDraggable){var e=this.slotAt(t);e!==this.endMark&&(this.endMark=e,this.root().cursor.syncTextareaSelectionWith(this),this.changed())}}},StringMorph.prototype.disableSelecting=function(){this.mouseDownLeft=StringMorph.prototype.mouseDownLeft,delete this.mouseMove},TextMorph.prototype=new Morph,TextMorph.prototype.constructor=TextMorph,TextMorph.uber=Morph.prototype,TextMorph.prototype.measureCtx=StringMorph.prototype.measureCtx,TextMorph.prototype.init=function(t,e,o,i,s,r,n,a,h,l){this.text=t||(""===t?t:"TextMorph"),this.words=[],this.lines=[],this.lineSlots=[],this.fontSize=e||12,this.fontName=a||MorphicPreferences.globalFontFamily,this.fontStyle=o||"sans-serif",this.isBold=i||!1,this.isItalic=s||!1,this.alignment=r||"left",this.shadowOffset=h||ZERO,this.shadowColor=l||null,this.maxWidth=n||0,this.maxLineWidth=0,this.backgroundColor=null,this.isEditable=!1,this.enableLinks=!1,this.receiver=null,this.isScrollable=!0,this.currentlySelecting=!1,this.startMark=0,this.endMark=0,this.markedTextColor=WHITE,this.markedBackgoundColor=new Color(60,60,120),TextMorph.uber.init.call(this),this.color=new Color(0,0,0),this.fixLayout()},TextMorph.prototype.toString=function(){return'a TextMorph("'+this.text.slice(0,30)+'...")'},TextMorph.prototype.font=StringMorph.prototype.font,TextMorph.prototype.parse=function(){var t,e=this.text.split("\n"),o=this.measureCtx,i="",s=0;o.font=this.font(),this.maxLineWidth=0,this.lines=[],this.lineSlots=[0],this.words=[],e.forEach((t=>{this.words=this.words.concat(t.split(" ")),this.words.push("\n")})),this.words.forEach((e=>{"\n"===e?(this.lines.push(i),this.lineSlots.push(s),this.maxLineWidth=Math.max(this.maxLineWidth,o.measureText(i).width),i=""):(this.maxWidth>0?(t=i+e+" ",o.measureText(t).width>this.maxWidth?(this.lines.push(i),this.lineSlots.push(s),this.maxLineWidth=Math.max(this.maxLineWidth,o.measureText(i).width),i=e+" "):i=t):i=i+e+" ",s+=e.length+1)}))},TextMorph.prototype.fixLayout=function(){var t,e,o;this.parse(),o=Math.abs(this.shadowOffset.x),e=Math.abs(this.shadowOffset.y),t=this.lines.length*(fontHeight(this.fontSize)+e),0===this.maxWidth?this.bounds=this.bounds.origin.extent(new Point(this.maxLineWidth+o,t)):this.bounds=this.bounds.origin.extent(new Point(this.maxWidth+o,t)),this.parent&&this.parent.layoutChanged&&this.parent.layoutChanged()},TextMorph.prototype.render=function(t){var e,o,i,s,r,n,a,h,l,p,c,d=Math.abs(this.shadowOffset.x),u=Math.abs(this.shadowOffset.y),f=this.getShadowRenderColor();if(t.font=this.font(),t.textAlign="left",t.textBaseline="bottom",this.backgroundColor&&(t.fillStyle=this.backgroundColor.toString(),t.fillRect(0,0,this.width(),this.height())),f)for(s=Math.max(this.shadowOffset.x,0),r=Math.max(this.shadowOffset.y,0),t.fillStyle=f.toString(),e=0;e<this.lines.length;e+=1)o=this.lines[e],i=t.measureText(o).width+d,n="right"===this.alignment?this.width()-i:"center"===this.alignment?(this.width()-i)/2:0,a=(e+1)*(fontHeight(this.fontSize)+u)-u,t.fillText(o,n+s,a+r);for(s=Math.abs(Math.min(this.shadowOffset.x,0)),r=Math.abs(Math.min(this.shadowOffset.y,0)),t.fillStyle=this.getRenderColor().toString(),e=0;e<this.lines.length;e+=1)o=this.lines[e],i=t.measureText(o).width+d,n="right"===this.alignment?this.width()-i:"center"===this.alignment?(this.width()-i)/2:0,a=(e+1)*(fontHeight(this.fontSize)+u)-u,t.fillText(o,n+s,a+r);for(h=Math.min(this.startMark,this.endMark),l=Math.max(this.startMark,this.endMark),e=h;e<l;e+=1)p=this.slotPosition(e).subtract(this.position()),c=this.text.charAt(e),t.fillStyle=this.markedBackgoundColor.toString(),t.fillRect(p.x,p.y,t.measureText(c).width+1,fontHeight(this.fontSize)),t.fillStyle=this.markedTextColor.toString(),t.fillText(c,p.x,p.y+fontHeight(this.fontSize))},TextMorph.prototype.getShadowRenderColor=StringMorph.prototype.getShadowRenderColor,TextMorph.prototype.setExtent=function(t){this.maxWidth=Math.max(t.x,0),this.changed(),this.fixLayout(),this.rerender()},TextMorph.prototype.columnRow=function(t){var e,o,i=0;for(e=0;e<this.lines.length;e+=1)for(i=this.lineSlots[e],o=0;o<this.lines[e].length;o+=1){if(i===t)return new Point(o,e);i+=1}return new Point(this.lines[this.lines.length-1].length-1,this.lines.length-1)},TextMorph.prototype.slotPosition=function(t){var e,o,i=this.columnRow(t),s=this.measureCtx,r=Math.abs(this.shadowOffset.y);return s.font=this.font(),o=i.y*(fontHeight(this.fontSize)+r),e=s.measureText(this.lines[i.y].slice(0,i.x)).width,new Point(this.left()+e,this.top()+o)},TextMorph.prototype.slotAt=function(t){for(var e,o,i,s=0,r=0,n=Math.abs(this.shadowOffset.y),a=this.measureCtx;t.y-this.top()>(fontHeight(this.fontSize)+n)*s;)s+=1;for(s=Math.max(s,1),a.font=this.font(),i=a.measureText(this.lines[s-1]).width,e="right"===this.alignment?this.width()-i:"center"===this.alignment?(this.width()-i)/2:0,o=this.lines[s-1].length;r<o-1&&t.x-this.left()>e;)e+=a.measureText(this.lines[s-1][r]).width,r+=1;return t.x-this.left()>e-a.measureText(this.lines[s-1][r]).width/2?this.lineSlots[Math.max(s-1,0)]+r:this.lineSlots[Math.max(s-1,0)]+r-1},TextMorph.prototype.upFrom=function(t){var e,o=this.columnRow(t);return o.y<1?t:(e=this.lines[o.y-1]).length<o.x-1?this.lineSlots[o.y-1]+e.length:this.lineSlots[o.y-1]+o.x},TextMorph.prototype.downFrom=function(t){var e,o=this.columnRow(t);return o.y>this.lines.length-2?t:(e=this.lines[o.y+1]).length<o.x-1?this.lineSlots[o.y+1]+e.length:this.lineSlots[o.y+1]+o.x},TextMorph.prototype.startOfLine=function(t){return this.lineSlots[this.columnRow(t).y]},TextMorph.prototype.endOfLine=function(t){return this.startOfLine(t)+this.lines[this.columnRow(t).y].length-1},TextMorph.prototype.previousWordFrom=StringMorph.prototype.previousWordFrom,TextMorph.prototype.nextWordFrom=StringMorph.prototype.nextWordFrom,TextMorph.prototype.edit=StringMorph.prototype.edit,TextMorph.prototype.selection=StringMorph.prototype.selection,TextMorph.prototype.selectionStartSlot=StringMorph.prototype.selectionStartSlot,TextMorph.prototype.clearSelection=StringMorph.prototype.clearSelection,TextMorph.prototype.deleteSelection=StringMorph.prototype.deleteSelection,TextMorph.prototype.selectAll=StringMorph.prototype.selectAll,TextMorph.prototype.mouseDownLeft=StringMorph.prototype.mouseDownLeft,TextMorph.prototype.shiftClick=StringMorph.prototype.shiftClick,TextMorph.prototype.mouseClickLeft=StringMorph.prototype.mouseClickLeft,TextMorph.prototype.mouseDoubleClick=StringMorph.prototype.mouseDoubleClick,TextMorph.prototype.selectWordAt=StringMorph.prototype.selectWordAt,TextMorph.prototype.selectBetweenWordsAt=StringMorph.prototype.selectBetweenWordsAt,TextMorph.prototype.enableSelecting=StringMorph.prototype.enableSelecting,TextMorph.prototype.disableSelecting=StringMorph.prototype.disableSelecting,TextMorph.prototype.selectAllAndEdit=function(){this.edit(),this.selectAll()},TextMorph.prototype.developersMenu=function(){var t=TextMorph.uber.developersMenu.call(this);return t.addLine(),t.addItem("edit","edit"),t.addItem("font size...",(()=>{this.prompt(t.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,100,!0)}),"set this Text's\nfont point size"),"left"!==this.alignment&&t.addItem("align left","setAlignmentToLeft"),"right"!==this.alignment&&t.addItem("align right","setAlignmentToRight"),"center"!==this.alignment&&t.addItem("align center","setAlignmentToCenter"),t.addLine(),"serif"!==this.fontStyle&&t.addItem("serif","setSerif"),"sans-serif"!==this.fontStyle&&t.addItem("sans-serif","setSansSerif"),this.isBold?t.addItem("normal weight","toggleWeight"):t.addItem("bold","toggleWeight"),this.isItalic?t.addItem("normal style","toggleItalic"):t.addItem("italic","toggleItalic"),t},TextMorph.prototype.setAlignmentToLeft=function(){this.alignment="left",this.rerender()},TextMorph.prototype.setAlignmentToRight=function(){this.alignment="right",this.rerender()},TextMorph.prototype.setAlignmentToCenter=function(){this.alignment="center",this.rerender()},TextMorph.prototype.toggleIsDraggable=StringMorph.prototype.toggleIsDraggable,TextMorph.prototype.toggleWeight=StringMorph.prototype.toggleWeight,TextMorph.prototype.toggleItalic=StringMorph.prototype.toggleItalic,TextMorph.prototype.setSerif=StringMorph.prototype.setSerif,TextMorph.prototype.setSansSerif=StringMorph.prototype.setSansSerif,TextMorph.prototype.setText=StringMorph.prototype.setText,TextMorph.prototype.setFontSize=StringMorph.prototype.setFontSize,TextMorph.prototype.numericalSetters=StringMorph.prototype.numericalSetters,TextMorph.prototype.evaluationMenu=function(){var t=new MenuMorph(this,null);return t.addItem("do it","doIt","evaluate the\nselected expression"),t.addItem("show it","showIt","evaluate the\nselected expression\nand show the result"),t.addItem("inspect it","inspectIt","evaluate the\nselected expression\nand inspect the result"),t.addLine(),t.addItem("select all","selectAllAndEdit"),t},TextMorph.prototype.setReceiver=function(t){this.receiver=t,this.customContextMenu=this.evaluationMenu()},TextMorph.prototype.doIt=function(){this.receiver.evaluateString(this.selection()),this.edit()},TextMorph.prototype.showIt=function(){var t=this.receiver.evaluateString(this.selection());null!==t&&this.inform(t)},TextMorph.prototype.inspectIt=function(){var t,e=this.receiver.evaluateString(this.selection()),o=this.world();isObject(e)&&((t=new InspectorMorph(e)).setPosition(o.hand.position()),t.keepWithin(o),o.add(t),t.changed())},TriggerMorph.prototype=new Morph,TriggerMorph.prototype.constructor=TriggerMorph,TriggerMorph.uber=Morph.prototype,TriggerMorph.prototype.init=function(t,e,o,i,s,r,n,a,h,l,p){this.target=t||null,this.action=0===e?0:e||null,this.doubleClickAction=p||null,this.environment=r||null,this.labelString=o||" ",this.label=null,this.hint=n||null,this.schedule=null,this.fontSize=i||MorphicPreferences.menuFontSize,this.fontStyle=s||"sans-serif",this.highlightColor=new Color(192,192,192),this.pressColor=new Color(128,128,128),this.labelColor=a||new Color(0,0,0),this.labelBold=h||!1,this.labelItalic=l||!1,this.userState="normal",TriggerMorph.uber.init.call(this),this.color=WHITE,this.createLabel()},TriggerMorph.prototype.render=function(t){var e=this.color;"highlight"===this.userState?this.color=this.highlightColor:"pressed"===this.userState&&(this.color=this.pressColor),TriggerMorph.uber.render.call(this,t),this.color=e},TriggerMorph.prototype.createLabel=function(){null!==this.label&&this.label.destroy(),this.label=new StringMorph(this.labelString,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic,!1,null,null,this.labelColor),this.fixLayout(),this.add(this.label)},TriggerMorph.prototype.fixLayout=function(){this.label.setPosition(this.center().subtract(this.label.extent().floorDivideBy(2)))},TriggerMorph.prototype.trigger=function(){this.schedule&&(this.schedule.isActive=!1),"function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call(),this):this.target.call(this.environment,this.action,this):"function"==typeof this.action?this.action.call(this.target):this.target[this.action]()},TriggerMorph.prototype.triggerDoubleClick=function(){this.doubleClickAction&&(this.schedule&&(this.schedule.isActive=!1),"function"==typeof this.target?"function"==typeof this.doubleClickAction?this.target.call(this.environment,this.doubleClickAction.call(),this):this.target.call(this.environment,this.doubleClickAction,this):"function"==typeof this.doubleClickAction?this.doubleClickAction.call(this.target):this.target[this.doubleClickAction]())},TriggerMorph.prototype.mouseEnter=function(){var t=this.hint instanceof Function?this.hint():this.hint;this.userState="highlight",this.rerender(),t&&this.bubbleHelp(t)},TriggerMorph.prototype.mouseLeave=function(){this.userState="normal",this.rerender(),this.schedule&&(this.schedule.isActive=!1),this.hint&&this.world().hand.destroyTemporaries()},TriggerMorph.prototype.mouseDownLeft=function(){this.userState="pressed",this.rerender()},TriggerMorph.prototype.mouseClickLeft=function(){this.userState="highlight",this.rerender(),this.trigger()},TriggerMorph.prototype.mouseDoubleClick=function(){this.triggerDoubleClick()},TriggerMorph.prototype.rootForGrab=function(){return this.isDraggable?TriggerMorph.uber.rootForGrab.call(this):null},TriggerMorph.prototype.bubbleHelp=function(t){var e=this.world();this.schedule=new Animation(nop,nop,0,500,nop,(()=>this.popUpbubbleHelp(t))),e.animations.push(this.schedule)},TriggerMorph.prototype.popUpbubbleHelp=function(t){new SpeechBubbleMorph(localize(t),null,null,1).popUp(this.world(),this.rightCenter().add(new Point(-8,0)))},MenuItemMorph.prototype=new TriggerMorph,MenuItemMorph.prototype.constructor=MenuItemMorph,MenuItemMorph.uber=TriggerMorph.prototype,MenuItemMorph.prototype.createLabel=function(){var t,e;this.label&&this.label.destroy(),this.label=this.createLabelPart(this.labelString),this.add(this.label),t=this.label.width(),e=this.label.height(),this.shortcut&&this.shortcut.destroy(),this.shortcutString&&(this.shortcut=this.createLabelPart(this.shortcutString),t+=this.shortcut.width()+4,e=Math.max(e,this.shortcut.height()),this.add(this.shortcut)),this.setExtent(new Point(t+8,e))},MenuItemMorph.prototype.fixLayout=function(){var t=this.center();this.label.setCenter(t),this.label.setLeft(this.left()+4),this.shortcut&&(this.shortcut.setCenter(t),this.shortcut.setRight(this.right()-4))},MenuItemMorph.prototype.createLabelPart=function(t){var e,o,i;return isString(t)?this.createLabelString(t):t instanceof Array?((e=new Morph).alpha=0,o=this.createIcon(t[0]),e.add(o),i=this.createLabelString(t[1]),e.add(i),i.setCenter(o.center()),i.setLeft(o.right()+4),e.bounds=o.bounds.merge(i.bounds),e.rerender(),e):this.createIcon(t)},MenuItemMorph.prototype.createIcon=function(t){var e;return t instanceof Morph?t.fullCopy():((e=new Morph).isCachingImage=!0,e.cachedImage=t,e.bounds.setWidth(t.width),e.bounds.setHeight(t.height),e)},MenuItemMorph.prototype.createLabelString=function(t){var e=new TextMorph(t,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic);return e.setColor(this.labelColor),e},MenuItemMorph.prototype.mouseEnter=function(){var t=this.parentThatIsA(MenuMorph);this.isShowingSubmenu()||(t&&t.closeSubmenu(),this.isListItem()||(this.userState="highlight",this.rerender()),this.action instanceof MenuMorph?this.delaySubmenu():this.hint&&this.bubbleHelp(this.hint))},MenuItemMorph.prototype.mouseLeave=function(){this.isListItem()||(this.isShowingSubmenu()?this.userState="highlight":this.userState="normal",this.rerender()),this.schedule&&(this.schedule.isActive=!1),this.hint&&this.world().hand.destroyTemporaries()},MenuItemMorph.prototype.mouseDownLeft=function(t){this.isListItem()&&(this.parentThatIsA(MenuMorph).unselectAllItems(),this.escalateEvent("mouseDownLeft",t)),this.userState="pressed",this.rerender()},MenuItemMorph.prototype.mouseMove=function(){this.isListItem()&&this.escalateEvent("mouseMove")},MenuItemMorph.prototype.mouseClickLeft=function(){this.action instanceof MenuMorph?this.popUpSubmenu():(this.isListItem()||(this.parentThatIsA(MenuMorph).closeRootMenu(),this.world().activeMenu=null),this.trigger())},MenuItemMorph.prototype.isListItem=function(){var t=this.parentThatIsA(MenuMorph);return!!t&&t.isListContents},MenuItemMorph.prototype.isSelectedListItem=function(){return!!this.isListItem()&&"pressed"===this.userState},MenuItemMorph.prototype.isShowingSubmenu=function(){var t=this.parentThatIsA(MenuMorph);return!!(t&&this.action instanceof MenuMorph)&&t.submenu===this.action},MenuItemMorph.prototype.delaySubmenu=function(){var t=this.world();this.schedule=new Animation(nop,nop,0,500,nop,(()=>this.popUpSubmenu())),t.animations.push(this.schedule)},MenuItemMorph.prototype.popUpSubmenu=function(){var t,e=this.parentThatIsA(MenuMorph),o=this.world();this.action instanceof MenuMorph&&(this.action.createItems(),this.action.setPosition(this.topRight().subtract(new Point(0,5))),this.action.addShadow(new Point(2,2),80),this.action.keepWithin(this.world()),this.action.items.length<1&&!this.action.title||(this.action.bottom()>o.bottom()&&(this.action.removeShadow(),t=this.action.scroll(),this.action.bounds.corner.y=o.bottom()-2,this.action.addShadow(new Point(2,2),80),t.setHeight(o.bottom()-t.top()-6),t.adjustScrollBars()),e.add(this.action),e.submenu=this.action,e.submenu.world=e.world,this.action.fullChanged()))},FrameMorph.prototype=new Morph,FrameMorph.prototype.constructor=FrameMorph,FrameMorph.uber=Morph.prototype,FrameMorph.prototype.init=function(t){this.scrollFrame=t||null,FrameMorph.uber.init.call(this),this.color=new Color(255,250,245),this.acceptsDrops=!0,this.scrollFrame&&(this.isDraggable=!1,this.alpha=0)},FrameMorph.prototype.fullBounds=function(){var t=this.getShadow();return null!==t?this.bounds.merge(t.bounds):this.bounds},FrameMorph.prototype.fullImage=function(){return this.getImage()},FrameMorph.prototype.fullDrawOn=function(t,e){var o,i;this.isVisible&&(i=this.bounds.intersect(e)).extent().gt(ZERO)&&(this.drawOn(t,i),this.children.forEach((e=>{e instanceof ShadowMorph?o=e:e.fullDrawOn(t,i)})),o&&o.drawOn(t,e))},FrameMorph.prototype.topMorphAt=function(t){var e,o;if(!this.isVisible||!this.bounds.containsPoint(t))return null;for(e=this.children.length-1;e>=0;e-=1)if(o=this.children[e].topMorphAt(t))return o;return this.isFreeForm&&this.isTransparentAt(t)?null:this},FrameMorph.prototype.submorphBounds=function(){var t=null;return this.children.length>0&&(t=this.children[0].bounds,this.children.forEach((e=>{t=t.merge(e.fullBounds())}))),t},FrameMorph.prototype.keepInScrollFrame=function(){if(null===this.scrollFrame)return null;this.left()>this.scrollFrame.left()&&this.moveBy(new Point(this.scrollFrame.left()-this.left(),0)),this.right()<this.scrollFrame.right()&&this.moveBy(new Point(this.scrollFrame.right()-this.right(),0)),this.top()>this.scrollFrame.top()&&this.moveBy(new Point(0,this.scrollFrame.top()-this.top())),this.bottom()<this.scrollFrame.bottom()&&this.moveBy(0,new Point(this.scrollFrame.bottom()-this.bottom(),0))},FrameMorph.prototype.adjustBounds=function(){var t,e;null!==this.scrollFrame&&(e=(t=this.submorphBounds())&&!this.scrollFrame.isTextLineWrapping?t.expandBy(this.scrollFrame.padding).growBy(this.scrollFrame.growth).merge(this.scrollFrame.bounds):this.scrollFrame.bounds.copy(),this.bounds.eq(e)||(this.bounds=e,this.keepInScrollFrame()),this.scrollFrame.isTextLineWrapping&&this.children.forEach((t=>{t instanceof TextMorph&&(t.setWidth(this.width()),this.setHeight(Math.max(t.height(),this.scrollFrame.height())))})),this.scrollFrame.adjustScrollBars())},FrameMorph.prototype.reactToDropOf=function(){this.adjustBounds()},FrameMorph.prototype.reactToGrabOf=function(){this.adjustBounds()},FrameMorph.prototype.developersMenu=function(){var t=FrameMorph.uber.developersMenu.call(this);return this.children.length>0&&(t.addLine(),t.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible")),t},FrameMorph.prototype.keepAllSubmorphsWithin=function(){this.children.forEach((t=>t.keepWithin(this)))},ScrollFrameMorph.prototype=new FrameMorph,ScrollFrameMorph.prototype.constructor=ScrollFrameMorph,ScrollFrameMorph.uber=FrameMorph.prototype,ScrollFrameMorph.prototype.init=function(t,e,o){ScrollFrameMorph.uber.init.call(this),this.scrollBarSize=e||MorphicPreferences.scrollBarSize,this.autoScrollTrigger=null,this.enableAutoScrolling=!0,this.isScrollingByDragging=!0,this.hasVelocity=!0,this.padding=0,this.growth=0,this.isTextLineWrapping=!1,this.contents=t||new FrameMorph(this),this.add(this.contents),this.hBar=new SliderMorph(null,null,null,null,"horizontal",o),this.hBar.setHeight(this.scrollBarSize),this.hBar.action=t=>{this.contents.setPosition(new Point(this.left()-t,this.contents.position().y))},this.hBar.isDraggable=!1,this.add(this.hBar),this.vBar=new SliderMorph(null,null,null,null,"vertical",o),this.vBar.setWidth(this.scrollBarSize),this.vBar.action=t=>{this.contents.setPosition(new Point(this.contents.position().x,this.top()-t))},this.vBar.isDraggable=!1,this.add(this.vBar),this.toolBar=null},ScrollFrameMorph.prototype.adjustScrollBars=function(){var t=this.width()-this.scrollBarSize,e=this.height()-this.scrollBarSize;this.changed(),this.contents.width()>this.width()?(this.hBar.show(),this.hBar.width()!==t&&this.hBar.setWidth(t),this.hBar.setPosition(new Point(this.left(),this.bottom()-this.hBar.height())),this.hBar.start=0,this.hBar.stop=this.contents.width()-this.width()+this.scrollBarSize,this.hBar.size=this.width()/this.contents.width()*this.hBar.stop,this.hBar.value=this.left()-this.contents.left(),this.hBar.fixLayout()):this.hBar.hide(),this.contents.height()>this.height()?(this.vBar.show(),this.vBar.height()!==e&&this.vBar.setHeight(e),this.vBar.setPosition(new Point(this.right()-this.vBar.width(),this.top())),this.vBar.start=0,this.vBar.stop=this.contents.height()-this.height()+this.scrollBarSize,this.vBar.size=this.height()/this.contents.height()*this.vBar.stop,this.vBar.value=this.top()-this.contents.top(),this.vBar.fixLayout()):this.vBar.hide(),this.adjustToolBar()},ScrollFrameMorph.prototype.adjustToolBar=function(){this.toolBar&&(this.toolBar.setTop(this.top()+3),this.toolBar.setRight((this.vBar.isVisible?this.vBar.left():this.right())-3))},ScrollFrameMorph.prototype.addContents=function(t){this.contents.add(t),this.contents.adjustBounds()},ScrollFrameMorph.prototype.setContents=function(t){this.contents.children.forEach((t=>t.destroy())),this.contents.children=[],t.setPosition(this.position().add(this.padding+2)),this.addContents(t)},ScrollFrameMorph.prototype.setExtent=function(t){this.isTextLineWrapping&&this.contents.setPosition(this.position().copy()),ScrollFrameMorph.uber.setExtent.call(this,t),this.contents.adjustBounds()},ScrollFrameMorph.prototype.scrollX=function(t){var e,o=this.contents.left(),i=this.left(),s=this.contents.width(),r=this.right();this.vBar.isVisible&&(r-=this.scrollBarSize),(e=o+t)+s<r&&(e=r-s),e>i&&(e=i),e!==o&&this.contents.setLeft(e)},ScrollFrameMorph.prototype.scrollY=function(t){var e,o=this.contents.top(),i=this.top(),s=this.contents.height(),r=this.bottom();this.hBar.isVisible&&(r-=this.scrollBarSize),(e=o+t)+s<r&&(e=r-s),e>i&&(e=i),e!==o&&this.contents.setTop(e)},ScrollFrameMorph.prototype.step=nop,ScrollFrameMorph.prototype.mouseDownLeft=function(t){if(!this.isScrollingByDragging)return null;var e=this.root().hand,o=t,i=0,s=0;this.step=()=>{var t;if(e.mouseButton&&0===e.children.length&&this.bounds.containsPoint(e.bounds.origin)){if(e.grabPosition&&e.grabPosition.distanceTo(e.position())<=MorphicPreferences.grabThreshold)return null;t=e.bounds.origin,0!=(i=t.x-o.x)&&this.scrollX(i),0!=(s=t.y-o.y)&&this.scrollY(s),o=t}else this.hasVelocity?Math.abs(i)<.5&&Math.abs(s)<.5?this.step=nop:(i*=.8,this.scrollX(Math.round(i)),s*=.8,this.scrollY(Math.round(s))):this.step=nop;this.adjustScrollBars()}},ScrollFrameMorph.prototype.startAutoScrolling=function(){var t,e,o,i=3*MorphicPreferences.scrollBarSize,s=this.world();if(!s)return null;t=s.hand,this.autoScrollTrigger||(this.autoScrollTrigger=Date.now()),this.step=()=>{o=t.bounds.origin,e=this.bounds.insetBy(i),this.bounds.containsPoint(o)&&!e.containsPoint(o)&&t.children.length>0?this.autoScroll(o):(this.step=nop,this.autoScrollTrigger=null)}},ScrollFrameMorph.prototype.autoScroll=function(t){var e;if(Date.now()-this.autoScrollTrigger<500)return null;e=3*MorphicPreferences.scrollBarSize,this.topLeft().extent(new Point(this.width(),e)).containsPoint(t)&&this.scrollY(e-(t.y-this.top())),this.topLeft().extent(new Point(e,this.height())).containsPoint(t)&&this.scrollX(e-(t.x-this.left())),new Point(this.right()-e,this.top()).extent(new Point(e,this.height())).containsPoint(t)&&this.scrollX(-(e-(this.right()-t.x))),new Point(this.left(),this.bottom()-e).extent(new Point(this.width(),e)).containsPoint(t)&&this.scrollY(-(e-(this.bottom()-t.y))),this.adjustScrollBars()},ScrollFrameMorph.prototype.scrollCursorIntoView=function(t){var e=t.target,o=e.position().subtract(this.contents.position()),i=this.top()+this.padding,s=this.bottom()-this.padding;this.contents.setExtent(e.extent().add(o).add(this.padding)),t.top()<i?(this.contents.setTop(this.contents.top()+i-t.top()),t.setTop(i)):t.bottom()>s&&(this.contents.setBottom(this.contents.bottom()+s-t.bottom()),t.setBottom(s)),this.adjustScrollBars()},ScrollFrameMorph.prototype.mouseScroll=function(t,e){t&&this.scrollY(t*MorphicPreferences.mouseScrollAmount),e&&this.scrollX(e*MorphicPreferences.mouseScrollAmount),this.adjustScrollBars()},ScrollFrameMorph.prototype.updateReferences=function(t){ScrollFrameMorph.uber.updateReferences.call(this,t),this.hBar&&(this.hBar.action=t=>{this.contents.setPosition(new Point(this.left()-t,this.contents.position().y))}),this.vBar&&(this.vBar.action=t=>{this.contents.setPosition(new Point(this.contents.position().x,this.top()-t))})},ScrollFrameMorph.prototype.developersMenu=function(){var t=ScrollFrameMorph.uber.developersMenu.call(this);return this.isTextLineWrapping?t.addItem("auto line wrap off...","toggleTextLineWrapping","turn automatic\nline wrapping\noff"):t.addItem("auto line wrap on...","toggleTextLineWrapping","enable automatic\nline wrapping"),t},ScrollFrameMorph.prototype.toggleTextLineWrapping=function(){this.isTextLineWrapping=!this.isTextLineWrapping},ListMorph.prototype=new ScrollFrameMorph,ListMorph.prototype.constructor=ListMorph,ListMorph.uber=ScrollFrameMorph.prototype,ListMorph.prototype.init=function(t,e,o,i,s){ListMorph.uber.init.call(this),this.contents.acceptsDrops=!1,this.color=WHITE,this.hBar.alpha=.6,this.vBar.alpha=.6,this.elements=t||[],this.labelGetter=e,this.format=o,this.listContents=null,this.selected=null,this.active=null,this.action=null,this.doubleClickAction=i||null,this.separator=s||"",this.acceptsDrops=!1,this.buildListContents()},ListMorph.prototype.buildListContents=function(){this.listContents&&this.listContents.destroy(),this.listContents=new MenuMorph(this.select,null,this),0===this.elements.length&&(this.elements=["(empty)"]),this.elements.forEach((t=>{var e,o=null,i=!1,s=!1;this.format.forEach((e=>{e[1].call(null,t)&&("bold"===e[0]?i=!0:"italic"===e[0]?s=!0:o=e[0])})),(e=this.labelGetter(t))===this.separator?this.listContents.addLine():this.listContents.addItem(e,t,null,o,i,s,this.doubleClickAction,null,!0)})),this.listContents.isListContents=!0,this.listContents.createItems(),this.listContents.setPosition(this.contents.position()),this.addContents(this.listContents)},ListMorph.prototype.select=function(t,e){isNil(t)||(this.selected=t,this.active=e,this.action&&this.action.call(null,t))},ListMorph.prototype.setExtent=function(t){var e=this.listContents.bounds,o=this.bounds.origin.copy().corner(this.bounds.origin.add(t));o.right()>e.right()&&o.width()<=e.width()&&this.listContents.setRight(o.right()),o.bottom()>e.bottom()&&o.height()<=e.height()&&this.listContents.setBottom(o.bottom()),ListMorph.uber.setExtent.call(this,t)},ListMorph.prototype.activeIndex=function(){return this.listContents.children.indexOf(this.active)},ListMorph.prototype.activateIndex=function(t){var e=this.listContents.children[t];e&&(e.userState="pressed",e.rerender(),e.trigger())},StringFieldMorph.prototype=new FrameMorph,StringFieldMorph.prototype.constructor=StringFieldMorph,StringFieldMorph.uber=FrameMorph.prototype,StringFieldMorph.prototype.init=function(t,e,o,i,s,r,n){this.defaultContents=t,this.minWidth=e,this.fontSize=o,this.fontStyle=i,this.isBold=s,this.isItalic=r,this.isNumeric=n||!1,this.text=null,StringFieldMorph.uber.init.call(this),this.color=WHITE,this.isEditable=!0,this.acceptsDrops=!1,this.createText()},StringFieldMorph.prototype.createText=function(){var t;t=this.text?this.string():this.defaultContents,this.text=null,this.children.forEach((t=>t.destroy())),this.children=[],this.text=new StringMorph(t,this.fontSize,this.fontStyle,this.isBold,this.isItalic,this.isNumeric),this.text.isNumeric=this.isNumeric,this.text.setPosition(this.bounds.origin.copy()),this.text.isEditable=this.isEditable,this.text.isDraggable=!1,this.text.enableSelecting(),this.setExtent(new Point(Math.max(this.width(),this.minWidth),this.text.height())),this.add(this.text)},StringFieldMorph.prototype.string=function(){return this.text.text},StringFieldMorph.prototype.mouseClickLeft=function(t){this.isEditable?this.text.edit():this.escalateEvent("mouseClickLeft",t)},BouncerMorph.prototype=new Morph,BouncerMorph.prototype.constructor=BouncerMorph,BouncerMorph.uber=Morph.prototype,BouncerMorph.prototype.init=function(t,e){BouncerMorph.uber.init.call(this),this.fps=50,this.isStopped=!1,this.type=t||"vertical","vertical"===this.type?this.direction="down":this.direction="right",this.speed=e||1},BouncerMorph.prototype.moveUp=function(){this.moveBy(new Point(0,-this.speed))},BouncerMorph.prototype.moveDown=function(){this.moveBy(new Point(0,this.speed))},BouncerMorph.prototype.moveRight=function(){this.moveBy(new Point(this.speed,0))},BouncerMorph.prototype.moveLeft=function(){this.moveBy(new Point(-this.speed,0))},BouncerMorph.prototype.step=function(){this.isStopped||("vertical"===this.type?("down"===this.direction?this.moveDown():this.moveUp(),this.fullBounds().top()<this.parent.top()&&"up"===this.direction&&(this.direction="down"),this.fullBounds().bottom()>this.parent.bottom()&&"down"===this.direction&&(this.direction="up")):"horizontal"===this.type&&("right"===this.direction?this.moveRight():this.moveLeft(),this.fullBounds().left()<this.parent.left()&&"left"===this.direction&&(this.direction="right"),this.fullBounds().right()>this.parent.right()&&"right"===this.direction&&(this.direction="left")))},HandMorph.prototype=new Morph,HandMorph.prototype.constructor=HandMorph,HandMorph.uber=Morph.prototype,HandMorph.prototype.init=function(t){HandMorph.uber.init.call(this,!0),this.bounds=new Rectangle,this.world=t,this.mouseButton=null,this.mouseOverList=[],this.mouseOverBounds=[],this.morphToGrab=null,this.grabPosition=null,this.grabOrigin=null,this.temporaries=[],this.touchHoldTimeout=null,this.contextMenuEnabled=!1,this.cachedFullImage=null,this.cachedFullBounds=null},HandMorph.prototype.changed=function(){var t;null!==this.world&&((t=this.cachedFullBounds||this.fullBounds()).extent().eq(ZERO)||this.world.broken.push(t.spread()))},HandMorph.prototype.moveBy=function(t){var e=this.children,o=e.length;for(this.changed(),this.bounds=this.bounds.translateBy(t),this.cachedFullBounds&&(this.cachedFullBounds=this.cachedFullBounds.translateBy(t)),this.changed();o>0;o-=1)e[o-1].moveBy(t)},HandMorph.prototype.fullChanged=HandMorph.prototype.changed,HandMorph.prototype.fullDrawOn=function(t,e){if(this.cachedFullBounds){var o,i,s,r,n,a,h=e.intersect(this.cachedFullBounds),l=this.cachedFullBounds.origin;h.extent().gt(ZERO)&&(t.save(),t.globalAlpha=this.alpha,o=this.cachedFullImage,n=(i=h.translateBy(l.neg())).left(),a=i.top(),s=Math.min(i.width(),o.width-n),r=Math.min(i.height(),o.height-a),s<1||r<1||(t.drawImage(o,n,a,s,r,h.left(),h.top(),s,r),t.restore()))}else HandMorph.uber.fullDrawOn.call(this,t,e)},HandMorph.prototype.morphAtPointer=function(){return this.world.topMorphAt(this.bounds.origin)||this.world},HandMorph.prototype.allMorphsAtPointer=function(){return this.world.allChildren().filter((t=>t.isVisible&&t.visibleBounds().containsPoint(this.bounds.origin)&&!t.holes.some((e=>e.translateBy(t.position()).containsPoint(this.bounds.origin)))))},HandMorph.prototype.dropTargetFor=function(t){for(var e=this.morphAtPointer();!e.wantsDropOf(t);)e=e.parent;return e},HandMorph.prototype.grab=function(t){var e=t.parent;if(t instanceof WorldMorph)return null;0===this.children.length&&(this.world.stopEditing(),this.grabOrigin=t.situation(),t.prepareToBeGrabbed&&t.prepareToBeGrabbed(this),t.noDropShadow||t.addShadow(),this.add(t),this.cachedFullImage=t.fullImage(),this.cachedFullBounds=t.fullBounds(),this.changed(),e&&e.reactToGrabOf&&e.reactToGrabOf(t))},HandMorph.prototype.drop=function(){var t,e;this.alpha=1,0!==this.children.length&&(e=this.children[0],t=(t=this.dropTargetFor(e)).selectForEdit?t.selectForEdit():t,this.changed(),t.add(e),e.changed(),this.cachedFullImage=null,this.cachedFullBounds=null,e.noDropShadow||e.removeShadow(),this.children=[],this.setExtent(new Point),e.justDropped&&e.justDropped(this),t.reactToDropOf&&t.reactToDropOf(e,this))},HandMorph.prototype.processMouseDown=function(t){var e,o,i=getDocumentPositionOf(this.world.worldCanvas);if(t.pageX&&this.setPosition(new Point(t.pageX-i.x,t.pageY-i.y)),this.destroyTemporaries(),this.contextMenuEnabled=!0,this.morphToGrab=null,this.grabPosition=null,0!==this.children.length)this.drop(),this.mouseButton=null;else{for(e=this.morphAtPointer(),this.world.activeMenu&&(contains(e.allParents(),this.world.activeMenu)?clearInterval(this.touchHoldTimeout):this.world.activeMenu.destroy()),this.world.activeHandle&&e!==this.world.activeHandle&&this.world.activeHandle.destroy(),this.world.cursor&&e!==this.world.cursor.target&&this.world.stopEditing(),e.mouseMove||(this.morphToGrab=e.rootForGrab(),this.grabPosition=this.bounds.origin.copy()),2===t.button||t.ctrlKey?(this.mouseButton="right",o="mouseDownRight"):(this.mouseButton="left",o="mouseDownLeft");!e[o];)e=e.parent;e[o](this.bounds.origin)}},HandMorph.prototype.processTouchStart=function(t){MorphicPreferences.isTouchDevice=!0,clearInterval(this.touchHoldTimeout),1===t.touches.length&&(this.touchHoldTimeout=setInterval((()=>{this.processMouseDown({button:2}),this.processMouseUp({button:2}),t.preventDefault(),clearInterval(this.touchHoldTimeout)}),400),this.processMouseMove(t.touches[0]),this.processMouseDown({button:0}),t.preventDefault())},HandMorph.prototype.processTouchMove=function(t){if(MorphicPreferences.isTouchDevice=!0,1===t.touches.length){var e=t.touches[0];this.processMouseMove(e),clearInterval(this.touchHoldTimeout)}},HandMorph.prototype.processTouchEnd=function(t){MorphicPreferences.isTouchDevice=!0,clearInterval(this.touchHoldTimeout),nop(t),this.processMouseUp({button:0})},HandMorph.prototype.processMouseUp=function(){var t,e,o,i=this.morphAtPointer();if(this.destroyTemporaries(),0!==this.children.length)this.drop();else{if("left"===this.mouseButton)o="mouseClickLeft";else if(o="mouseClickRight",this.mouseButton&&this.contextMenuEnabled){for(e=(t=i).contextMenu();!e&&t.parent;)e=(t=t.parent).contextMenu();e&&e.popUpAtHand(this.world)}for(;!i[o];)i=i.parent;i[o](this.bounds.origin)}this.mouseButton=null},HandMorph.prototype.processDoubleClick=function(){var t=this.morphAtPointer();if(this.destroyTemporaries(),0!==this.children.length)this.drop();else{for(;t&&!t.mouseDoubleClick;)t=t.parent;t&&t.mouseDoubleClick(this.bounds.origin)}this.mouseButton=null},HandMorph.prototype.processMouseMove=function(t){var e,o,i,s,r,n=getDocumentPositionOf(this.world.worldCanvas);e=new Point(t.pageX-n.x,t.pageY-n.y),this.setPosition(e),o=this.morphAtPointer().allParents(),i=o.filter((t=>t.isVisible&&t.visibleBounds().containsPoint(this.bounds.origin)&&!t.holes.some((e=>e.translateBy(t.position()).containsPoint(this.bounds.origin))))),!this.children.length&&this.mouseButton&&(s=(r=this.morphAtPointer()).rootForGrab(),r.mouseMove&&(r.mouseMove(e,this.mouseButton),"right"===this.mouseButton&&(this.contextMenuEnabled=!1)),"left"===this.mouseButton&&this.morphToGrab&&this.grabPosition.distanceTo(this.bounds.origin)>MorphicPreferences.grabThreshold&&(this.setPosition(this.grabPosition),this.morphToGrab.isDraggable?(s=this.morphToGrab.selectForEdit?this.morphToGrab.selectForEdit():this.morphToGrab,this.grab(s)):this.morphToGrab.isTemplate&&(this.world.stopEditing(),(s=this.morphToGrab.fullCopy()).isTemplate=!1,s.isDraggable=!0,s.reactToTemplateCopy&&s.reactToTemplateCopy(),this.grab(s),this.grabOrigin=this.morphToGrab.situation()),this.setPosition(e))),this.mouseOverBounds.forEach((t=>{contains(i,t)||t.mouseLeaveBounds&&t.mouseLeaveBounds(this.children[0])})),i.forEach((t=>{contains(this.mouseOverBounds,t)||t.mouseEnterBounds&&t.mouseEnterBounds(this.children[0])})),this.mouseOverList.forEach((t=>{contains(o,t)||(t.mouseLeave&&t.mouseLeave(),t.mouseLeaveDragging&&this.mouseButton&&t.mouseLeaveDragging(this.children[0]))})),o.forEach((t=>{contains(this.mouseOverList,t)||(t.mouseEnter&&t.mouseEnter(),t.mouseEnterDragging&&this.mouseButton&&t.mouseEnterDragging(this.children[0])),this.children.length>0&&t instanceof ScrollFrameMorph&&t.enableAutoScrolling&&t.contents.allChildren().some((t=>t.wantsDropOf(this.children[0])))&&(t.bounds.insetBy(3*MorphicPreferences.scrollBarSize).containsPoint(this.bounds.origin)||t.startAutoScrolling())})),this.mouseOverList=o,this.mouseOverBounds=i},HandMorph.prototype.processMouseScroll=function(t){for(var e=this.morphAtPointer();e&&!e.mouseScroll;)e=e.parent;e&&e.mouseScroll(t.detail/-3||(Object.prototype.hasOwnProperty.call(t,"wheelDeltaY")?t.wheelDeltaY/120:t.wheelDelta/120),t.wheelDeltaX/120||0)},HandMorph.prototype.processDrop=function(t){var e,o,i,s,r,n=t instanceof FileList?t:t.target.files||t.dataTransfer.files,a=t.dataTransfer?t.dataTransfer.getData("URL"):null,h=t.dataTransfer?t.dataTransfer.getData("Text/HTML"):null,l=this.morphAtPointer(),p=new Image;function c(t){for(var e=new Image,o=new FileReader;!l.droppedSVG;)l=l.parent;e.onload=()=>l.droppedSVG(e,t.name),(o=new FileReader).onloadend=t=>e.src=t.target.result,o.readAsDataURL(t)}function d(t){for(var e=new Image,o=new FileReader;!l.droppedImage;)l=l.parent;e.onload=()=>{(s=newCanvas(new Point(e.width,e.height),!0)).getContext("2d").drawImage(e,0,0),l.droppedImage(s,t.name)},(o=new FileReader).onloadend=t=>e.src=t.target.result,o.readAsDataURL(t)}function u(t){for(var e=new Audio,o=new FileReader;!l.droppedAudio;)l=l.parent;o.onloadend=o=>{e.src=o.target.result,l.droppedAudio(e,t.name)},o.readAsDataURL(t)}function f(t){for(var e=new FileReader;!l.droppedText;)l=l.parent;e.onloadend=e=>{l.droppedText(e.target.result,t.name,t.type)},e.readAsText(t)}function g(t){for(var e=new FileReader;!l.droppedBinary;)l=l.parent;e.onloadend=e=>{l.droppedBinary(e.target.result,t.name)},e.readAsArrayBuffer(t)}if(n.length>0)for(r=0;r<n.length;r+=1)o=(e=n[r]).name.slice(e.name.lastIndexOf(".")+1).toLowerCase(),-1===e.type.indexOf("svg")||MorphicPreferences.rasterizeSVGs?0===e.type.indexOf("image")?d(e):0===e.type.indexOf("audio")||e.type.indexOf("ogg")>-1?u(e):0===e.type.indexOf("text")||contains(["txt","csv","json"],o)?f(e):g(e):c(e);else if(a){if(contains(["gif","png","jpg","jpeg","bmp"],o=a.slice(a.lastIndexOf(".")+1).toLowerCase())){for(;!l.droppedImage;)l=l.parent;(p=new Image).onload=()=>{(s=newCanvas(new Point(p.width,p.height),!0)).getContext("2d").drawImage(p,0,0),l.droppedImage(s)},p.src=a}else if("svg"===o&&!MorphicPreferences.rasterizeSVGs){for(;!l.droppedSVG;)l=l.parent;!function(t,e){var o=new XMLHttpRequest;o.open("GET",t),o.onreadystatechange=()=>{if(4===o.readyState){if(!o.responseText)throw new Error("unable to retrieve "+t);e(o.responseText)}},o.send()}(a,(t=>{var e=new Image;e.onload=()=>{l.droppedSVG(e,a.slice(a.lastIndexOf("/")+1,a.lastIndexOf(".")))},e.src="data:image/svg+xml;utf8,"+encodeURIComponent(t)}))}}else if(h){for(;!l.droppedImage;)l=l.parent;(p=new Image).onload=()=>{(s=newCanvas(new Point(p.width,p.height),!0)).getContext("2d").drawImage(p,0,0),l.droppedImage(s)},(i=function(t){var e,o,i="",s=t.indexOf('<img src="');if(-1===s)return null;for(e=s+=10;e<t.length;e+=1){if('"'===(o=t[e]))return i;i=i.concat(o)}return null}(h))&&(p.src=i)}},HandMorph.prototype.destroyTemporaries=function(){this.temporaries.forEach((t=>{t.isClickable&&t.bounds.containsPoint(this.position())||(t.destroy(),this.temporaries.splice(this.temporaries.indexOf(t),1))}))},WorldMorph.prototype=new FrameMorph,WorldMorph.prototype.constructor=WorldMorph,WorldMorph.uber=FrameMorph.prototype,WorldMorph.prototype.customMorphs=[],WorldMorph.prototype.init=function(t,e){for(WorldMorph.uber.init.call(this),this.color=new Color(205,205,205),this.alpha=1,this.bounds=new Rectangle(0,0,t.width,t.height),this.isVisible=!0,this.isDraggable=!1,this.currentKey=null,this.worldCanvas=t,this.stamp=Date.now();this.stamp===Date.now();)nop();this.stamp=Date.now(),this.useFillPage=e,void 0===this.useFillPage&&(this.useFillPage=!0),this.isDevMode=!1,this.broken=[],this.animations=[],this.hand=new HandMorph(this),this.keyboardHandler=null,this.keyboardFocus=null,this.cursor=null,this.lastEditedText=null,this.activeMenu=null,this.activeHandle=null,this.initKeyboardHandler(),this.resetKeyboardHandler(),this.initEventListeners()},WorldMorph.prototype.fullDrawOn=function(t,e){WorldMorph.uber.fullDrawOn.call(this,t,e),this.hand.fullDrawOn(t,e)},WorldMorph.prototype.updateBroken=function(){var t=this.worldCanvas.getContext("2d");this.condenseDamages(),this.broken.forEach((e=>{e.extent().gt(ZERO)&&this.fullDrawOn(t,e)})),this.broken=[]},WorldMorph.prototype.stepAnimations=function(){this.animations.forEach((t=>t.step())),this.animations=this.animations.filter((t=>t.isActive))},WorldMorph.prototype.condenseDamages=function(){this.broken.length>1e3?this.broken=[function(t){var e,o,i=t[0].origin.x,s=t[0].origin.y,r=t[0].corner.x,n=t[0].corner.y,a=t.length;for(o=1;o<a;o+=1)e=t[o],i=Math.min(i,e.origin.x),s=Math.min(s,e.origin.y),r=Math.max(r,e.corner.x),n=Math.max(n,e.corner.y);return new Rectangle(i,s,r,n)}(this.broken)]:this.broken=function(t){var e,o,i,s=[],r=t.length,n=t=>t.isNearTo(e,20);for(i=0;i<r;i+=1)e=t[i],(o=detect(s,n))?o.mergeWith(e):s.push(e);return s}(this.broken)},WorldMorph.prototype.doOneCycle=function(){this.stepFrame(),this.stepAnimations(),this.updateBroken()},WorldMorph.prototype.fillPage=function(){var t=window.innerHeight,e=window.innerWidth;this.worldCanvas.style.position="absolute",this.worldCanvas.style.left="0px",this.worldCanvas.style.right="0px",this.worldCanvas.style.width="100%",this.worldCanvas.style.height="100%",document.documentElement.scrollTop&&(t=document.documentElement.clientHeight),document.documentElement.scrollLeft&&(e=document.documentElement.clientWidth),this.worldCanvas.width!==e&&(this.worldCanvas.width=e,this.setWidth(e)),this.worldCanvas.height!==t&&(this.worldCanvas.height=t,this.setHeight(t)),this.children.forEach((t=>{t.reactToWorldResize&&t.reactToWorldResize(this.bounds.copy())}))},WorldMorph.prototype.getGlobalPixelColor=function(t){var e=this.worldCanvas.getContext("2d").getImageData(t.x,t.y,1,1).data;return new Color(e[0],e[1],e[2])},WorldMorph.prototype.initKeyboardHandler=function(){var t=document.getElementById("morphic_keyboard");t?this.keyboardHandler=t:((t=document.createElement("textarea")).setAttribute("id","morphic_keyboard"),t.setAttribute("style","caret-color:transparent;"),t.style.position="absolute",t.style.overflow="hidden",t.style.border="none",t.style.resize="none",t.wrap="off",t.world=this,t.style.zIndex=-1,t.autofocus=!0,document.body.appendChild(t),this.keyboardHandler=t,t.addEventListener("keydown",(e=>{t.world.currentKey=e.keyCode,t.world.activeMenu&&!t.world.activeMenu.hasFocus&&(t.world.stopEditing(),t.world.activeMenu.getFocus()),t.world.keyboardFocus&&t.world.keyboardFocus.processKeyDown&&t.world.keyboardFocus.processKeyDown(e),9===e.keyCode&&(t.world.keyboardFocus&&t.world.keyboardFocus.processKeyPress&&t.world.keyboardFocus.processKeyPress(e),e.preventDefault()),(e.ctrlKey||e.metaKey)&&"dfips".includes(e.key)&&e.preventDefault()}),!0),t.addEventListener("keyup",(e=>{t.world.currentKey=null,t.world.keyboardFocus&&t.world.keyboardFocus.processKeyUp&&t.world.keyboardFocus.processKeyUp(e),e.preventDefault()}),!1),t.addEventListener("keypress",(e=>{t.world.keyboardFocus&&t.world.keyboardFocus.processKeyPress&&(t.world.keyboardFocus.processKeyPress(e),e.preventDefault())}),!1),t.addEventListener("input",(e=>{t.world.keyboardFocus&&t.world.keyboardFocus.processInput?(t.world.currentKey=null,t.world.keyboardFocus.processInput(e)):t.world.keyboardHandler.value="",e.preventDefault()}),!1))},WorldMorph.prototype.resetKeyboardHandler=function(t){var e=getDocumentPositionOf(this.worldCanvas);function o(t){return Math.ceil(t)+"px"}t||(this.keyboardHandler.value=""),this.keyboardHandler.style.top=o(e.y),this.keyboardHandler.style.left=o(e.x)},WorldMorph.prototype.initEventListeners=function(){var t=this.worldCanvas;this.useFillPage?this.fillPage():this.changed(),t.addEventListener("mousedown",(t=>{t.preventDefault(),this.keyboardHandler.world=this,this.resetKeyboardHandler(!0),this.onNextStep||(this.keyboardHandler.blur(),this.onNextStep=()=>this.keyboardHandler.focus()),this.hand.processMouseDown(t)}),!0),t.addEventListener("touchstart",(t=>this.hand.processTouchStart(t)),!1),t.addEventListener("mouseup",(t=>{t.preventDefault(),this.hand.processMouseUp(t)}),!1),t.addEventListener("dblclick",(t=>{t.preventDefault(),this.hand.processDoubleClick(t)}),!1),t.addEventListener("touchend",(t=>this.hand.processTouchEnd(t)),!1),t.addEventListener("mousemove",(t=>this.hand.processMouseMove(t)),!1),t.addEventListener("touchmove",(t=>this.hand.processTouchMove(t)),{passive:!0}),t.addEventListener("contextmenu",(t=>t.preventDefault()),!0),t.addEventListener("mousewheel",(t=>{this.hand.processMouseScroll(t),t.preventDefault()}),!1),t.addEventListener("DOMMouseScroll",(t=>{this.hand.processMouseScroll(t),t.preventDefault()}),!1),window.addEventListener("dragover",(t=>t.preventDefault()),!0),window.addEventListener("drop",(t=>{this.hand.processDrop(t),t.preventDefault()}),!1),window.addEventListener("resize",(()=>{this.useFillPage&&this.fillPage()}),!1),window.onbeforeunload=t=>{var e=t||window.event,o="Are you sure you want to leave?";return e&&(e.returnValue=o),o}},WorldMorph.prototype.mouseDownLeft=nop,WorldMorph.prototype.mouseClickLeft=nop,WorldMorph.prototype.mouseDownRight=nop,WorldMorph.prototype.mouseClickRight=nop,WorldMorph.prototype.wantsDropOf=function(){return this.acceptsDrops},WorldMorph.prototype.droppedImage=function(){return null},WorldMorph.prototype.droppedSVG=function(){return null},WorldMorph.prototype.nextTab=function(t){var e=this.nextEntryField(t);e&&(t.clearSelection(),e.selectAll(),e.edit())},WorldMorph.prototype.previousTab=function(t){var e=this.previousEntryField(t);e&&(t.clearSelection(),e.selectAll(),e.edit())},WorldMorph.prototype.contextMenu=function(){var t;return t=this.isDevMode?new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]):new MenuMorph(this,"Morphic"),this.isDevMode&&(t.addItem("demo...","userCreateMorph","sample morphs"),t.addLine(),t.addItem("hide all...","hideAll"),t.addItem("show all...","showAllHiddens"),t.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible"),t.addItem("inspect...","inspect","open a window on\nall properties"),t.addItem("screenshot...",(()=>window.open(this.fullImage().toDataURL())),"open a new window\nwith a picture of this morph"),t.addLine(),t.addItem("restore display","changed","redraw the\nscreen once"),t.addItem("fill page...","fillPage","let the World automatically\nadjust to browser resizing"),useBlurredShadows?t.addItem("sharp shadows...","toggleBlurredShadows","sharp drop shadows\nuse for old browsers"):t.addItem("blurred shadows...","toggleBlurredShadows","blurry shades,\n use for new browsers"),t.addItem("color...",(()=>{this.pickColor(t.title+localize("\ncolor:"),this.setColor,this,this.color)}),"choose the World's\nbackground color"),MorphicPreferences===standardSettings?t.addItem("touch screen settings","togglePreferences","bigger menu fonts\nand sliders"):t.addItem("standard settings","togglePreferences","smaller menu fonts\nand sliders"),MorphicPreferences.showHoles?t.addItem("hide holes","toggleHolesDisplay","debug untouchable regions"):t.addItem("show holes","toggleHolesDisplay","debug untouchable regions"),t.addLine()),this.isDevMode?t.addItem("user mode...","toggleDevMode","disable developers'\ncontext menus"):t.addItem("development mode...","toggleDevMode"),t.addItem("about morphic.js...","about"),t},WorldMorph.prototype.userCreateMorph=function(){var t,e,o=this;function i(t){var e=t.fullCopy();e.isDraggable=!0,e.pickUp(o)}(t=new MenuMorph(this,"make a morph")).addItem("rectangle",(()=>i(new Morph))),t.addItem("box",(()=>i(new BoxMorph))),t.addItem("circle box",(()=>i(new CircleBoxMorph))),t.addLine(),t.addItem("slider",(()=>i(new SliderMorph))),t.addItem("dial",(()=>{(e=new DialMorph).pickUp(this)})),t.addItem("frame",(()=>{(e=new FrameMorph).setExtent(new Point(350,250)),i(e)})),t.addItem("scroll frame",(()=>{(e=new ScrollFrameMorph).contents.acceptsDrops=!0,e.contents.adjustBounds(),e.setExtent(new Point(350,250)),i(e)})),t.addItem("handle",(()=>i(new HandleMorph))),t.addLine(),t.addItem("string",(()=>{(e=new StringMorph("Hello, World!")).isEditable=!0,i(e)})),t.addItem("text",(()=>{(e=new TextMorph("Ich weiß nicht, was soll es bedeuten, dass ich so traurig bin, ein Märchen aus uralten Zeiten, das kommt mir nicht aus dem Sinn. Die Luft ist kühl und es dunkelt, und ruhig fließt der Rhein; der Gipfel des Berges funkelt im Abendsonnenschein. Die schönste Jungfrau sitzet dort oben wunderbar, ihr gold'nes Geschmeide blitzet, sie kämmt ihr goldenes Haar, sie kämmt es mit goldenem Kamme, und singt ein Lied dabei; das hat eine wundersame, gewalt'ge Melodei. Den Schiffer im kleinen Schiffe, ergreift es mit wildem Weh; er schaut nicht die Felsenriffe, er schaut nur hinauf in die Höh'. Ich glaube, die Wellen verschlingen am Ende Schiffer und Kahn, und das hat mit ihrem Singen, die Loreley getan.")).isEditable=!0,e.maxWidth=300,e.fixLayout(),i(e)})),t.addItem("speech bubble",(()=>{i(e=new SpeechBubbleMorph("Hello, World!"))})),t.addLine(),t.addItem("gray scale palette",(()=>i(new GrayPaletteMorph))),t.addItem("color palette",(()=>i(new ColorPaletteMorph))),t.addItem("color picker",(()=>i(new ColorPickerMorph))),t.addLine(),t.addItem("sensor demo",(()=>{(e=new MouseSensorMorph).setColor(new Color(230,200,100)),e.edge=35,e.border=15,e.borderColor=new Color(200,100,50),e.alpha=.2,e.setExtent(new Point(100,100)),i(e)})),t.addItem("animation demo",(()=>{var t,e,o,s,r;(t=new BouncerMorph).setPosition(new Point(50,20)),t.setExtent(new Point(300,200)),t.alpha=.9,t.speed=3,(e=new BouncerMorph).setColor(new Color(50,50,50)),e.setPosition(new Point(80,80)),e.setExtent(new Point(80,250)),e.type="horizontal",e.direction="right",e.alpha=.9,e.speed=5,(o=new BouncerMorph).setColor(new Color(20,20,20)),o.setPosition(new Point(90,140)),o.setExtent(new Point(40,30)),o.type="horizontal",o.direction="right",o.speed=3,(s=new BouncerMorph).setColor(new Color(200,20,20)),s.setPosition(new Point(90,140)),s.setExtent(new Point(20,20)),s.type="vertical",s.direction="up",s.speed=8,(r=new BouncerMorph).setColor(new Color(20,200,20)),r.setPosition(new Point(120,140)),r.setExtent(new Point(20,20)),r.type="vertical",r.direction="down",r.speed=4,e.add(s),e.add(o),t.add(r),t.add(e),i(t)})),t.addItem("pen",(()=>i(new PenMorph))),this.customMorphs.length&&(t.addLine(),this.customMorphs.forEach((e=>{var o;e instanceof Array?(o=new MenuMorph,e[1].forEach((t=>o.addItem(t,(()=>i(t instanceof Array?t[0]:t))))),t.addMenu(e[0],o)):t.addItem(e.toString(),(()=>i(e)))}))),t.popUpAtHand(this)},WorldMorph.prototype.toggleDevMode=function(){this.isDevMode=!this.isDevMode},WorldMorph.prototype.hideAll=function(){this.children.forEach((t=>t.hide()))},WorldMorph.prototype.showAllHiddens=function(){this.forAllChildren((t=>{t.isVisible||t.show()}))},WorldMorph.prototype.about=function(){var t,e="";for(t in modules)Object.prototype.hasOwnProperty.call(modules,t)&&(e+="\n"+t+" ("+modules[t]+")");""!==e&&(e="\n\nmodules:\n\nmorphic ("+morphicVersion+")"+e),this.inform("morphic.js\n\na lively Web GUI\ninspired by Squeak\n"+morphicVersion+"\n\nwritten by Jens Mönig\njens@moenig.org"+e)},WorldMorph.prototype.edit=function(t){if(this.lastEditedText!==t){if(isNil(this.lastEditedText)||this.stopEditing(),!t.isEditable)return null;this.cursor&&this.cursor.destroy(),this.worldCanvas.focus(),this.keyboardHandler.focus(),this.cursor=new CursorMorph(t,this.keyboardHandler),this.keyboardFocus=this.cursor,t.parent.add(this.cursor),MorphicPreferences.useSliderForInput&&(t.parentThatIsA(MenuMorph)||this.slide(t)),this.lastEditedText!==t&&t.escalateEvent("freshTextEdit",t),this.lastEditedText=t}},WorldMorph.prototype.slide=function(t){var e,o,i=parseFloat(t.text);isNaN(i)&&(i=0),e=new MenuMorph,(o=new SliderMorph(i-25,i+25,i,10,"horizontal")).alpha=1,o.color=new Color(225,225,225),o.button.color=e.borderColor,o.button.highlightColor=o.button.color.copy(),o.button.highlightColor.b+=100,o.button.pressColor=o.button.color.copy(),o.button.pressColor.b+=150,o.setExtent(new Point(10*MorphicPreferences.scrollBarSize,MorphicPreferences.menuFontSize)),o.action=e=>{t.changed(),t.text=Math.round(e).toString(),t.fixLayout(),t.rerender(),t.escalateEvent("reactToSliderEdit",t)},e.items.push(o),e.popup(this,t.bottomLeft().add(new Point(0,5)))},WorldMorph.prototype.stopEditing=function(){this.cursor&&(this.cursor.target.escalateEvent("reactToEdit",this.cursor.target),this.cursor.target.clearSelection(),this.cursor.destroy(),this.cursor=null),this.keyboardFocus&&this.keyboardFocus.stopEditing&&this.keyboardFocus.stopEditing(),this.keyboardFocus=null,this.lastEditedText=null},WorldMorph.prototype.toggleBlurredShadows=function(){useBlurredShadows=!useBlurredShadows},WorldMorph.prototype.togglePreferences=function(){MorphicPreferences=MorphicPreferences===standardSettings?touchScreenSettings:standardSettings},WorldMorph.prototype.toggleHolesDisplay=function(){MorphicPreferences.showHoles=!MorphicPreferences.showHoles,this.rerender()}}},__webpack_module_cache__={};function __webpack_require__(t){var e=__webpack_module_cache__[t];if(void 0!==e)return e.exports;var o=__webpack_module_cache__[t]={id:t,loaded:!1,exports:{}};return __webpack_modules__[t](o,o.exports,__webpack_require__),o.loaded=!0,o.exports}__webpack_require__.amdO={},__webpack_require__.d=function(t,e){for(var o in e)__webpack_require__.o(e,o)&&!__webpack_require__.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},__webpack_require__.hmd=function(t){return(t=Object.create(t)).children||(t.children=[]),Object.defineProperty(t,"exports",{enumerable:!0,set:function(){throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+t.id)}}),t},__webpack_require__.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},__webpack_require__.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var __webpack_exports__={};!function(){var t={};__webpack_require__.r(t),__webpack_require__.d(t,{_y:function(){return h},xU:function(){return c},I9:function(){return r},An:function(){return a},qR:function(){return n},_w:function(){return l},Eg:function(){return p}});var e={};__webpack_require__.r(e),__webpack_require__.d(e,{Rq:function(){return bt},xP:function(){return Tt},FU:function(){return Bt},zH:function(){return xt},WI:function(){return vt},rW:function(){return Pt},fs:function(){return ft},w5:function(){return gt},i0:function(){return yt},sX:function(){return kt},bL:function(){return wt},sm:function(){return Mt}});var o=__webpack_require__(253),i=function(t){function e(t,e){var o;for(o in e)e.hasOwnProperty(o)&&(t[o]=e[o])}var o;return t.$extend=e,e((t.Ref=function(t){this.id=t}).prototype,{isRef:!0}),e((t.Dictionary=function(t,e){this.keys=t,this.values=e}).prototype,{get:function(t){return this.values[this.keys.indexOf(t)]},set:function(t,e){var o=this.keys.indexOf(t);-1===o?(this.keys.push(t),this.values.push(e)):this.values[o]=e}}),t.Color=function(t,e){this.r=(t/1048576|0)%1024/1023,this.g=(t/1024|0)%1024/1023,this.b=t%1024/1023,this.a=e/255},t.Point=function(t,e){this.x=t,this.y=e},t.Rectangle=function(e,o,i,s){this.origin=new t.Point(e,o),this.corner=new t.Point(i,s)},t.indexedColors=[[1,1,1,1],[0,0,0,1],[1,1,1,1],[.5,.5,.5,1],[1,0,0,1],[0,1,0,1],[0,0,1,1],[0,1,1,1],[1,1,0,1],[1,0,1,1],[.125,.125,.125,1],[.25,.25,.25,1],[.375,.375,.375,1],[.625,.625,.625,1],[.75,.75,.75,1],[.875,.875,.875,1]],function(){var e,o,i,s,r;for(e=1;e<=31;++e)e%4!=0&&(r=e/32,t.indexedColors[e+15]=[r,r,r,1]);for(o=0;o<6;++o)for(i=0;i<6;++i)for(s=0;s<6;++s)e=40+36*o+6*s+i,t.indexedColors[e]=[o/5,i/5,s/5,1]}(),t.colorDepthLengths={1:1,2:2,4:4,8:8,15:5,16:5,12:4,9:3},e((t.ColorStream=function(e,o){var i,s=0,r=e.length,n=this.bits=[];for(this.length=t.colorDepthLengths[this.depth=o],this.position=0;s<r;)i=e[s++],n.push(i/128&1),n.push(i/64&1),n.push(i/32&1),n.push(i/16&1),n.push(i/8&1),n.push(i/4&1),n.push(i/2&1),n.push(1&i)}).prototype,{read:function(){for(var t=this.length,e=this.bits,o=0;t--;)o=2*o+e[this.position++];return o}}),e((t.ColorStreamIndexed=function(e,o){t.ColorStream.call(this,e,o)}).prototype=Object.create(t.ColorStream.prototype),{next:function(e){var o=t.indexedColors[this.read()];if(!o)return o;e[0]=o[0],e[1]=o[1],e[2]=o[2],e[3]=o[3]}}),e((t.ColorStreamRGB=function(e,o){t.ColorStream.call(this,e,o),this.max=Math.pow(2,this.length)-1}).prototype=Object.create(t.ColorStream.prototype),{next:function(t){var e;switch(this.depth){case 16:return++this.position,(e=[this.read()/this.max,this.read()/this.max,this.read()/this.max,1])[0]+e[1]+e[2]===0?t[0]=t[1]=t[2]=t[3]=0:(t[0]=e[0],t[1]=e[1],t[2]=e[2],void(t[3]=e[3]));case 12:this.position+=3}t[0]=this.read()/this.max,t[1]=this.read()/this.max,t[2]=this.read()/this.max,t[3]=1}}),e((t.ColorStream32=function(t,e){this.bytes=t,32===e&&(this.next=this.nextAlpha),this.position=0}).prototype,{next:function(t){t[0]=this.read()/255,t[1]=this.read()/255,t[2]=this.read()/255,t[3]=1},nextAlpha:function(t){var e=this.read()/255;t[0]=this.read()/255,t[1]=this.read()/255,t[2]=this.read()/255,t[3]=e},read:function(){return this.bytes[this.position++]}}),t.colorStreams={1:t.ColorStreamIndexed,2:t.ColorStreamIndexed,4:t.ColorStreamIndexed,8:t.ColorStreamIndexed,15:t.ColorStreamRGB,16:t.ColorStreamRGB,32:t.ColorStream32,24:t.ColorStream32,12:t.ColorStreamRGB,9:t.ColorStreamRGB},t.getColorStream=function(e,o){return new t.colorStreams[o](e,o)},e((t.Form=function(t,e,o,i,s){this.width=t,this.height=e,this.depth=o,this.offset=i,this.bits=s}).prototype,{init:function(t){this.bits.isBitmap?this.bitmap=this.bits:this.decompress(t),this.image=document.createElement("canvas"),this.image.width=this.width,this.image.height=this.height},decompress:function(t){var e,o,i,s,r,n,a=this.bits,h=0,l=0,p=!!t;for((e=a[h++])<=223||(e<255||(a[h++],a[h++],a[h++]),a[h++]),this.bitmap=t||(t=[]);h<a.length;)switch((e=a[h++])>223&&(e=e<255?256*(e-224)+a[h++]:(a[h++]<<24)+(a[h++]<<16)+(a[h++]<<8)+a[h++]),o=e>>2,3&e){case 1:for(i=a[h++],o*=4;o--;)t[l++]=i;break;case 2:for(i=a[h++],s=a[h++],r=a[h++],n=a[h++];o--;)p?(t[l++]=s,t[l++]=r,t[l++]=n,t[l++]=i):(t[l++]=i,t[l++]=s,t[l++]=r,t[l++]=n);break;case 3:for(;o--;)p?(i=a[h++],t[l++]=a[h++],t[l++]=a[h++],t[l++]=a[h++],t[l++]=i):(t[l++]=a[h++],t[l++]=a[h++],t[l++]=a[h++],t[l++]=a[h++])}},load:function(){var e,o,i,s,r,n,a,h,l=this.width,p=this.height;if(32===this.depth)return this.image=document.createElement("canvas"),this.image.width=this.width,this.image.height=this.height,r=(s=(n=this.image.getContext("2d")).createImageData(this.width,this.height)).data,this.decompress(r),void n.putImageData(s,0,0);for(h=[0,0,0,0],16===this.depth&&(l=this.width+=1),this.init(),a=t.getColorStream(this.bitmap,this.depth),r=(s=(n=this.image.getContext("2d")).createImageData(this.width,this.height)).data,e=0;e<l;++e)for(o=0;o<p;++o)a.next(h),h&&(r[i=4*(e*p+o)]=255*h[0],r[i+1]=255*h[1],r[i+2]=255*h[2],r[i+3]=255*h[3]);n.putImageData(s,0,0)}}),e((t.ColorForm=function(t,e,o,i,s,r){this.width=t,this.height=e,this.depth=o,this.offset=i,this.bits=s,this.colors=r}).prototype=Object.create(t.Form.prototype),{load:function(){var t,e,o,i,s,r,n,a,h=this.width,l=this.height,p=this.colors;for(this.init(),r=(s=(n=this.image.getContext("2d")).createImageData(this.width,this.height)).data,t=this.bitmap,e=0;e<h;++e)for(o=0;o<l;++o)(a=p[t[e*l+o]])&&(r[i=4*(e*l+o)]=255*a.r,r[i+1]=255*a.g,r[i+2]=255*a.b,r[i+3]=255*a.a);n.putImageData(s,0,0)}}),t.fields={},t.classIDs={},t.classNames={},t.addFields=function(e,o,i,s){if(t.classIDs[o]=e,t.classNames[e]=o,s=s.length?s.split(","):[],i){if(!(i=t.fields[t.classIDs[i]]))throw new Error("Initialization error");s=i.concat(s)}t.fields[e]=s},t.addFields(100,"Morph","","bounds,owner,submorphs,color,flags,properties"),t.addFields(101,"BorderedMorph","Morph","borderWidth,borderColor"),t.addFields(102,"RectangleMorph","BorderedMorph",""),t.addFields(103,"EllipseMorph","BorderedMorph",""),t.addFields(104,"AlignmentMorph","RectangleMorph","orientation,centering,hResizing,vResizing,inset"),t.addFields(105,"StringMorph","Morph","fontSpec,emphasis,contents"),t.addFields(-1,"Slider","BorderedMorph","slider,value,setValueSelector,sliderShadow,sliderColor,descending,model"),t.addFields(-2,"AbstractSound","",""),t.addFields(-3,"ScriptableScratchMorph","Morph","objName,vars,blocksBin,customBlocks,isTemporary,media,costume"),t.addFields(-4,"ArgMorph","BorderedMorph","labelMorph"),t.addFields(-5,"PasteUpMorph","BorderedMorph",""),t.addFields(-6,"ScratchMedia","","mediaName"),t.addFields(-7,"ScrollFrameMorph","BorderedMorph",""),t.addFields(106,"UpdatingStringMorph","StringMorph","format,target,getSelector,putSelector,parameter,floatPrecision,growable,stepTime"),t.addFields(107,"SimpleSliderMorph","Slider","target,arguments,minVal,maxVal,truncate,sliderThickness"),t.addFields(108,"SimpleButtonMorph","RectangleMorph","target,actionSelector,arguments,actWhen"),t.addFields(109,"SampledSound","AbstractSound","envelopes,scaledVol,initialCount,samples,originalSamplingRate,samplesSize,scaledIncrement,scaledInitialIndex"),t.addFields(110,"ImageMorph","Morph","form,transparency"),t.addFields(111,"SketchMorph","Morph","originalForm,rotationCenter,rotationDegrees,rotationStyle,scalePoint,offsetWhenRotated"),t.addFields(123,"SensorBoardMorph","Morph","portNum"),t.addFields(124,"ScratchSpriteMorph","ScriptableScratchMorph","visibility,scalePoint,rotationDegrees,rotationStyle,volume,tempoBPM,draggable,sceneStates,lists,virtualScale,ownerSprite,subsprites,rotateWithOwner,refPos,prototype,deletedAttributes"),t.addFields(125,"ScratchStageMorph","ScriptableScratchMorph","zoom,hPan,vPan,obsoleteSavedState,sprites,volume,tempoBPM,sceneStates,lists"),t.addFields(140,"ChoiceArgMorph","ArgMorph","isBoolean,options,choice,getOptionsSelector"),t.addFields(141,"ColorArgMorph","ArgMorph",""),t.addFields(142,"ExpressionArgMorph","ArgMorph","isNumber"),t.addFields(145,"SpriteArgMorph","ArgMorph","morph"),t.addFields(147,"BlockMorph","Morph","isSpecialForm,oldColor"),t.addFields(148,"CommandBlockMorph","BlockMorph","commandSpec,argMorphs,titleMorph,receiver,selector,isReporter,isTimed,wantsName,wantsPossession"),t.addFields(149,"CBlockMorph","CommandBlockMorph","nestedBlock,nextBlock"),t.addFields(151,"HatBlockMorph","CommandBlockMorph","scriptNameMorph,indicatorMorph,scriptOwner,parameters,isClickable"),t.addFields(153,"ScratchScriptsMorph","PasteUpMorph",""),t.addFields(154,"ScratchSliderMorph","AlignmentMorph","slider,sliderMin,sliderMax,variable"),t.addFields(155,"WatcherMorph","AlignmentMorph","titleMorph,readout,readoutFrame,scratchSlider,watcher,isSpriteSpecific,unused,sliderMin,sliderMax,isLarge"),t.addFields(157,"SetterBlockMorph","CommandBlockMorph","variable"),t.addFields(158,"EventHatMorph","HatBlockMorph",""),t.addFields(170,"ReporterBlockMorph","CommandBlockMorph","isBoolean"),t.addFields(160,"VariableBlockMorph","ReporterBlockMorph",""),t.addFields(162,"ImageMedia","ScratchMedia","form,rotationCenter,textBox,jpegBytes,compositeForm"),t.addFields(163,"MovieMedia","ScratchMedia","fileName,fade,fadeColor,zoom,hPan,vPan,msecsPerFrame,currentFrame,moviePlaying"),t.addFields(164,"SoundMedia","ScratchMedia","originalSound,volume,balance,compressedSampleRate,compressedBitsPerSample,compressedData"),t.addFields(165,"KeyEventHatMorph","HatBlockMorph",""),t.addFields(166,"BooleanArgMorph","ArgMorph",""),t.addFields(167,"EventTitleMorph","ArgMorph",""),t.addFields(168,"MouseClickEventHatMorph","HatBlockMorph",""),t.addFields(169,"ExpressionArgMorphWithMenu","ExpressionArgMorph","menuMorph,getMenuSelector,specialValue"),t.addFields(171,"MultilineStringMorph","BorderedMorph","fontSpec,textColor,selectionColor,lines"),t.addFields(172,"ToggleButton","SimpleButtonMorph","onForm,offForm,overForm,disabledForm,isMomentary,toggleMode,isOn,isDisabled"),t.addFields(173,"WatcherReadoutFrameMorph","BorderedMorph",""),t.addFields(174,"WatcherSliderMorph","SimpleSliderMorph",""),t.addFields(175,"ScratchListMorph","BorderedMorph","listName,strings,target,complex"),t.addFields(176,"ScrollingStringMorph","BorderedMorph","fontSpec,showScrollbar,firstVisibleLine,textColor,selectionColor,lines"),t.addFields(180,"ScrollFrameMorph2","ScrollFrameMorph",""),t.addFields(181,"ListMultilineStringMorph","MultilineStringMorph",""),t.addFields(182,"ScratchScrollBar","Morph",""),t.addFields(200,"CustomCommandBlockMorph","CommandBlockMorph","userSpec"),t.addFields(201,"CustomBlockDefinition","","userSpec,blockVars,isAtomic,isReporter,isBoolean,body,answer,type,category,declarations,defaults,isGlobal"),t.addFields(203,"ReporterScriptBlockMorph","ReporterBlockMorph",""),t.addFields(202,"CommandScriptBlockMorph","ReporterScriptBlockMorph",""),t.addFields(205,"VariableFrame","","vars"),t.addFields(206,"CustomReporterBlockMorph","ReporterBlockMorph","userSpec"),t.addFields(207,"CReporterSlotMorph","ReporterScriptBlockMorph",""),t.addFields(300,"StringFieldMorph","BorderedMorph",""),t.addFields(301,"MultiArgReporterBlockMorph","ReporterBlockMorph",""),t.Reader=function(){},(o=t.Reader.prototype).on=function(t){return this.bytes=t,t.subarray||(t.subarray=t.slice),this.position=0,this},o.readYPR=function(t){var e,o,i;if(console.time("readSB"),this.on(t),this.matchBytes([66,108,111,120,69,120,112,86]),+(String.fromCharCode(this.next())+String.fromCharCode(this.next()))<1)throw new Error("Invalid version");e=this.uint32(),o=this.read(),this.position=e+14,i=this.read(),this.onload({reader:this,info:o,stage:i}),console.timeEnd("readSB")},o.readInfo=function(t){var e;if(this.on(t),this.matchBytes([66,108,111,120,69,120,112,86]),+(String.fromCharCode(this.next())+String.fromCharCode(this.next()))<1)throw new Error("Invalid version");this.uint32(),e=this.read(),this.onload({reader:this,info:e})},o.read=function(){var t,e;for(this.objects=[],this.readHeader(),t=e=this.uint32();t--;)this.objects.push(this.readObject());for(t=e;t--;)this.fixReferences(this.objects[t]);return this.objects[0][1]},o.fixReferences=function(e){var o,i,s=e[0],r=e[1],n=0;if(s<99)this.fixFixedFormat(s,r);else{if(this.fixArray(e[3]),!(o=t.fields[s]))throw new Error("Invalid class ID "+s);for(i=r.fields,delete r.fields,r.className=t.classNames[s],n=o.length;n--;)r[o[n]]=i[n]}},o.fixArray=function(t){for(var e,o=t.length;o--;)if((e=t[o])&&e.isRef){if(e.id>this.objects.length)throw new Error("Invalid object reference");t[o]=this.objects[e.id-1][1]}},o.targetObjectFor=function(t){if(t&&t.isRef){if(t.id>this.objects.length)throw new Error("Invalid object reference");return this.objects[t.id-1][1]}return t},o.fixFixedFormat=function(t,e){switch(t){case 20:case 21:case 22:case 23:return this.fixArray(e),e;case 24:case 25:this.fixArray(e.keys),this.fixArray(e.values);break;case 32:e.x=this.targetObjectFor(e.x),e.y=this.targetObjectFor(e.y);break;case 33:e.origin.x=this.targetObjectFor(e.origin.x),e.origin.y=this.targetObjectFor(e.origin.y),e.corner.x=this.targetObjectFor(e.corner.x),e.corner.y=this.targetObjectFor(e.corner.y);break;case 34:e.offset=this.targetObjectFor(e.offset),e.bits=this.targetObjectFor(e.bits),e.load();break;case 35:e.offset=this.targetObjectFor(e.offset),e.bits=this.targetObjectFor(e.bits),e.colors=this.targetObjectFor(e.colors),e.load()}return e},o.readObject=function(){var t,e,o,i=this.next();if(i>99){for(t=this.next(),e=this.next(),o=[];e--;)o.push(this.readField());return[i,{fields:o},t,o]}return[i,this.readFixedFormat(i)]},o.readField=function(){var e=this.next();return 99===e?new t.Ref(this.uint24()):this.readFixedFormat(e)},o.readFixedFormat=function(e){var o,i;switch(e){case 1:return null;case 2:return!0;case 3:return!1;case 4:return this.int32();case 5:return this.int16();case 6:case 7:for(i=this.uint16(),o=0;i--;)o*=256,o+=this.next();return o;case 8:return this.float64();case 9:case 10:case 14:for(o=[].slice.call(this.readBytes(i=this.uint32()));i--;)o[i]=String.fromCharCode(o[i]);return o.join("");case 11:return this.readBytes(this.uint32());case 12:for(o=[],i=this.uint32();i--;)o.push(this.int16());return o;case 13:for((o=[]).isBitmap=!0,i=this.uint32();i--;)o.push(this.uint32());return o;case 20:case 21:case 22:case 23:for(o=[],i=this.uint32();i--;)o.push(this.readField());return o;case 24:case 25:for(o=new t.Dictionary([],[]),i=this.uint32();i--;)o.keys.push(this.readField()),o.values.push(this.readField());return o;case 30:return new t.Color(this.uint32(),255);case 31:return new t.Color(this.uint32(),this.uint8());case 32:return new t.Point(this.readField(),this.readField());case 33:return new t.Rectangle(this.readField(),this.readField(),this.readField(),this.readField());case 34:return new t.Form(this.readField(),this.readField(),this.readField(),this.readField(),this.readField());case 35:return new t.ColorForm(this.readField(),this.readField(),this.readField(),this.readField(),this.readField(),this.readField())}throw new Error("Invalid fixed-format class ID")},o.readHeader=function(){this.matchBytes([79,98,106,83,1,83,116,99,104,1])},o.readBytes=function(t){return this.bytes.subarray(this.position,this.position+=t)},o.matchBytes=function(t){for(var e=t.length,o=this.readBytes(e);e--;)if(o[e]!==t[e])throw new Error("Invalid format")},o.skip=function(t){this.position+=t},o.next=o.uint8=function(){return this.bytes[this.position++]},o.hasNext=function(){return this.position<this.bytes.length},o.uint16=function(){return 256*this.next()+this.next()},o.uint24=function(){return 65536*this.next()+256*this.next()+this.next()},o.uint32=function(){return 16777216*this.next()+65536*this.next()+256*this.next()+this.next()},o.int8=function(){var t=this.bytes[++this.position];return t>=128?t-256:t},o.int16=function(){var t=this.next(),e=256*t+this.next();return t>=128?e-65536:e},o.int24=function(){var t=this.next(),e=65536*t+256*this.next()+this.next();return t>=128?e-16777216:e},o.int32=function(){var t=this.next(),e=16777216*t+65536*this.next()+256*this.next()+this.next();return t>=128?e-4294967296:e},o.string=function(){for(var t=this.uint16(),e=this.readBytes(t),o=t;o--;)e[o]=String.fromCharCode(e[o]);return e.join("")},o.float64=function(){return this.ieee(8,11,52,1023)},o.ieee=function(t,e,o){for(var i,s,r,n,a=(1<<e-1)-1,h="",l=t;l--;)i=this.next().toString(2),h=h+Array(9-i.length).join("0")+i;return s="0"===h.charAt(0)?1:-1,r=parseInt(h.substr(1,e),2),n=parseInt(h.substr(e+1),2),0===r?0===n?0*s:s*Math.pow(2,1-a)*n/Math.pow(2,o):r===(1<<e)-1?0===n?s/0:NaN:s*Math.pow(2,r-a)*(1+n/Math.pow(2,o))},function(e,o){var i={normal:1,leftRight:2,none:0},s={object:"%obj",objectList:"%mult%obj",number:"%n",numberList:"%mult%n",text:"%txt",textList:"%mult%txt",list:"%l",listList:"%mult%l",any:"%s",anyList:"%mult%s",boolean:"%b",booleanList:"%mult%b",command:"%cmdRing",commandList:"%mult%cmdRing",reporter:"%repRing",reporterList:"%mult%repRing",predicate:"%predRing",predicateList:"%mult%predRing",loop:"%cs",loopList:"%mult%cs",unevaluated:"%anyUE",unevaluatedList:"%mult%anyUE",unevaluatedBoolean:"%boolUE",unevaluatedBooleanList:"%mult%boolUE",template:"%upvar"},r={"forward:":"forward","turnLeft:":"turnLeft","turnRight:":"turn","heading:":"setHeading","pointTowards:":"doFaceTowards","gotoX:y:":"gotoXY","gotoSpriteOrMouse:":"doGotoObject","glideSecs:toX:y:elapsed:from:":"doGlide","changeXposBy:":"changeXPosition","xpos:":"setXPosition","changeYposBy:":"changeYPosition","ypos:":"setYPosition",bounceOffEdge:"bounceOffEdge",xpos:"xPosition",ypos:"yPosition",heading:"direction","lookLike:":"doSwitchToCostume","showBackground:":"doSwitchToCostume",nextCostume:"doWearNextCostume",nextBackground:"doWearNextCostume",costumeIndex:"getCostumeIdx","say:duration:elapsed:from:":"doSayFor","say:":"bubble","think:duration:elapsed:from:":"doThinkFor","think:":"doThink","changeGraphicEffect:by:":"changeEffect","setGraphicEffect:to:":"setEffect",filterReset:"clearEffects","setSizeTo:":"setScale","changeSizeBy:":"changeScale",scale:"getScale",show:"show",hide:"hide",comeToFront:"comeToFront","goBackByLayers:":"goBack","playSound:":"playSound",doPlaySoundAndWait:"doPlaySoundUntilDone",stopAllSounds:"doStopAllSounds","rest:elapsed:from:":"doRest","noteOn:duration:elapsed:from:":"doPlayNote","changeTempoBy:":"doChangeTempo","setTempoTo:":"doSetTempo",tempo:"getTempo",clearPenTrails:"clear",putPenDown:"down",putPenUp:"up","penColor:":"setColor","changePenHueBy:":"changeHue","setPenHueTo:":"setHue","_changePenHueBy:":"changeHue","_setPenHueTo:":"setHue","changePenShadeBy:":"changeBrightness","setPenShadeTo:":"setBrightness","changePenSizeBy:":"changeSize","penSize:":"setSize",stampCostume:"doStamp","wait:elapsed:from:":"doWait",doForever:"doForever",doRepeat:"doRepeat","broadcast:":"doBroadcast",doBroadcastAndWait:"doBroadcastAndWait",doIf:"doIf",doIfElse:"doIfElse",doWaitUntil:"doWaitUntil",doUntil:"doUntil",doReturn:"doStop",stopAll:"doStopAll",doRun:"doRun",doRunBlockWithArgs:"doRun",doRunBlockWithArgList:"doRun",doFork:"fork",doForkBlockWithArgs:"fork",doForkBlockWithArgList:"fork",doReport:"evaluate",doCallBlockWithArgs:"evaluate",doCallBlockWithArgList:"evaluate",doAnswer:"doReport",doStopBlock:"doStopBlock","touching:":"reportTouchingObject","touchingColor:":"reportTouchingColor","color:sees:":"reportColorIsTouchingColor",doAsk:"doAsk",answer:"reportLastAnswer",mouseX:"reportMouseX",mouseY:"reportMouseY",mousePressed:"reportMouseDown","keyPressed:":"reportKeyPressed","distanceTo:":"reportDistanceTo",timerReset:"doResetTimer",timer:"reportTimer","getAttribute:of:":"reportAttributeOf","+":"reportSum","-":"reportDifference","*":"reportProduct","/":"reportQuotient","randomFrom:to:":"reportRandom","<":"reportLessThan","=":"reportEquals",">":"reportGreaterThan","&":"reportAnd","|":"reportOr",not:"reportNot",getTrue:"reportTrue",getFalse:"reportFalse","concatenate:with:":"reportJoinWords","letter:of:":"reportLetter","stringLength:":"reportStringSize","asciiCodeOf:":"reportUnicode","asciiLetter:":"reportUnicodeAsLetter","\\\\":"reportModulus",rounded:"reportRound","computeFunction:of:":"reportMonadic","isObject:type:":"reportIsA","setVar:to:":"doSetVar","changeVar:by:":"doChangeVar","showVariable:":"doShowVar","hideVariable:":"doHideVar",doDeclareVariables:"doDeclareVariables","newList:":"reportNewList","append:toList:":"doAddToList","deleteLine:ofList:":"doDeleteFromList","insert:at:ofList:":"doInsertInList","setLine:ofList:to:":"doReplaceInList","getLine:ofList:":"reportListItem","lineCountOfList:":"reportListLength","list:contains:":"reportListContainsItem",_warp:"doWarp"};function n(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}function a(t){return t.media.filter((function(t){return"ImageMedia"===t.className})).indexOf(t.costume)+1}function h(t){this.value=""+t}function l(t){this.tagName=t}function p(t,e,o){var i=new l(t);return i.attributes=e||{},i.children=o||[],i}function c(t){return new h(t)}h.prototype.toXML=function(t){t.push(n(this.value))},h.prototype.toDOM=function(){return document.createTextNode(this.value)},l.prototype.toXML=function(t){var e,o=this.attributes;for(e in t.push("<",this.tagName),o)o.hasOwnProperty(e)&&t.push(" ",e,'="',n(""+o[e]),'"');this.children.length?(t.push(">"),this.children.forEach((function(e){e.toXML||console.error("Invalid",e),e.toXML(t)})),t.push("</",this.tagName,">")):t.push("/>")},l.prototype.toDOM=function(){var t,e,o=document.createElement(this.tagName),i=this.attributes,s=this.children,r=0;for(t in i)i.hasOwnProperty(t)&&o.setAttribute(t,i[t]);for(;e=s[r++];)o.appendChild(e.toDOM());return o},o.write=function(e,o){var n,h,l,d,u,f=0,g={};function y(t){return t.attributes.id?t("ref",{id:t.attributes.id}):t.attributes.id=++f,t}function m(t,e){var o=g[t]={};e&&e.forEach((function(t){o[t.userSpec]=t,t.userSpec=t.userSpec.replace(/^\s+|\s+$/g,"").replace(/\s{2,}/g," ").replace(/'/g,""),t.__blockSpec__=t.userSpec.replace(/%(\S+)/g,(function(e,o){var i=s[t.declarations.get(o)];return void 0===i&&(void 0===t.declarations.get(o)?i="%s":console.warn("Missing input type "+t.declarations.get(o))),i})),t.__types__=(t.userSpec.match(/%\S+/g)||[]).map((function(e){return t.declarations.get(e.substr(1))||"any"}))}))}function b(t,e){return t?(e?t:t.filter((function(t){return!t.isGlobal}))).map((function(t){var e=(t.userSpec.match(/%\S+/g)||[]).map((function(e){var o=e.substr(1),i=s[t.declarations.get(o)];return void 0===i&&(i="%s"),p("input",{type:i},[c(t.defaults.get(o))])})),o=t.userSpec.replace(/%(\S+)/g,"%'$1'");return t.body=t.body||[],t.answer&&t.answer.pop&&t.body.push(["byob","","doAnswer",t.answer[0]]),t.blockVars.length&&t.body.unshift(["byob","","doDeclareVariables"].concat(t.blockVars.map((function(t){return[0,0,0,t]})))),t.isAtomic&&(t.body=[["byob","","_warp",t.body]]),p("block-definition",{s:o,type:"boolean"===t.type?"predicate":null!==t.answer?"reporter":"command",category:"none"===t.category?"other":"list"===t.category?"lists":t.category},[p("inputs",{},e),p("script",{},w(t.body))])})):[]}function w(t){return t.map((function(t){return C(t)}))}function C(t){var e,o;switch(e=p("block"),t[2]){case"EventHatMorph":return"Scratch-StartClicked"===t[3]?e.attributes.s="receiveGo":(e.attributes.s="receiveMessage",e.children.push(p("l",{},[c(t[3])]))),e;case"MouseClickEventHatMorph":return e.attributes.s="receiveClick",e;case"KeyEventHatMorph":return e.attributes.s="receiveKey",e.children.push(p("l",{},[c(t[3])])),e;case"doRunBlockWithArgs":case"doCallBlockWithArgs":case"doForkBlockWithArgs":for(o=t.length-5;o--;)t[5+o].pop&&(t[5+o]=["block","",[t[5+o]]]);o={className:"ScratchListMorph",complex:t.slice(5)},(t=t.slice(0,4)).push(o);break;case"doRunBlockWithArgList":case"doCallBlockWithArgList":case"doForkBlockWithArgList":o=t[5],(t=t.slice(0,4)).push(o);break;case"doDeclareVariables":t=["byob","","doDeclareVariables",{className:"ScratchListMorph",complex:t.slice(3).map((function(t){return t[3]}))}];break;case"getLine:ofList:":case"append:toList:":case"deleteLine:ofList:":case"setLine:ofList:to:":case"getLine:ofList:":case"insert:at:ofList:":case"lineCountOfList:":case"list:contains:":o="insert:at:ofList:"===t[2]?5:"lineCountOfList:"===t[2]||"list:contains:"===t[2]?3:4,"string"==typeof t[o]&&(t[o]=""===t[o]?null:["byob","","readVariable",t[o]]);break;case"readBlockVariable":case"readVariable":case"listNamed:":return e.attributes.var=t[3],e;case"function":case"functionWithArgs":return e.attributes.s="reifyReporter",t.pop(),e.children.push(p("autolambda",{},[C(t[8])])),"functionWithArgs"===t[2]&&e.children.push(p("list",{},t.slice(9).map((function(t){return p("l",{},[c(t[3])])})))),e;case"procedure":case"procedureWithArgs":return e.attributes.s="reifyScript",e.children.push(p("script",{},w(t.pop()))),e.children.push(p("list",{},t.slice(8).map((function(t){return p("l",{},[c(t[3])])})))),e;case"autoBlock":case"autoPredicate":return e.attributes.s="autoPredicate"===t[2]?"reifyPredicate":"reifyReporter",e.children.push(p("autolambda",{},t[3]?[C(t[3][0])]:[])),e;case"concatenate:with:":for(t=t.slice(0,3).concat({className:"ScratchListMorph",complex:t.slice(3)}),o=2;o--;)t[3].complex[o].pop&&(t[3].complex[o]=["block","",[t[3].complex[o]]]);break;case"loopLambda":return p("script",{},t[8]?w(t[8]):[]);case"autoLambda":return e.attributes.s="reifyScript",e.children.push(p("script",{},t[8]?w(t[8]):[])),e;case"changeVariable":case"changeBlockVariable":t=[0,0,t[4],t[3],t["changeBlockVariable"===t[2]?6:5]];break;case"distanceTo:":case"gotoSpriteOrMouse:":case"pointTowards:":case"touching:":"mouse"===t[3]?t[3]="mouse-pointer":t[3]=t[3].objName;break;case"doForeverIf":t=[0,0,"doForever",[[0,0,"doIf",t[3],t[4]]]];break;case"\\\\":case"+":case"-":case"*":case"/":" "===t[3]&&(t[3]="")," "===t[4]&&(t[4]="");break;case"setPenHueTo:":case"changePenHueBy:":t[3]=["byob",0,"/",t[3],"2"]}return"doCustomBlock"===t[2]?(o=g["Stage"===t[1]?"__global__":t[1]][t[3]],e=p("custom-block",{s:o.__blockSpec__}),"Stage"===t[1]||o.isGlobal||(e.attributes.scope=t[1]),o.__types__.forEach((function(e,o){"template"===e&&(t[4+o]=t[4+o][3])})),t.shift()):void 0===(e.attributes.s=r[t[2]])&&console.warn('Missing selector mapping for "'+t[2]+'"',t),t.slice(3).forEach((function(t){t&&t.pop?"string"==typeof t[0]?e.children.push(C(t)):e.children.push(p("script",{},w(t))):(delete(o=v(t)).attributes.id,e.children.push(o))})),e}function S(t,e){return t.keys.map((function(e,o){return p("variable",{name:e},[v(t.values[o],!0)])})).concat(e.keys.map((function(t,o){return p("variable",{name:t},[v(e.values[o],!0)])})))}function v(e,o){return"string"==typeof e||"number"==typeof e?p("l",{},[c(e)]):null==e||"boolean"==typeof e?p("l"):"ScratchListMorph"===e.className?y(p("list",{},e.complex.map((function(t,i){var s=null==t?p("l",{},[c("nil"===(s=e.strings[i])?"":s)]):"string"==typeof t?v(t):t&&"block"===t[0]?w(t[2])[0]:p("l");return o?p("item",{},[s]):s})))):e.constructor===t.Color?p("color",{},[c([255*e.r,255*e.g,255*e.b,255*e.a])]):e.constructor===t.Dictionary?y(p("list")):(console.warn("No serializer for",e),p("__undefined__"))}function x(t){return[y(p("list",{},t.filter((function(t){return"ImageMedia"===t.className})).map((function(t){return p("item",{},[p("costume",{name:t.mediaName,"center-x":t.rotationCenter.x,"center-y":t.rotationCenter.y,image:t.form.image.toDataURL()})])}))))]}function k(t){return t.filter((function(t){return"SoundMedia"===t.className})).length>0&&console.warn("Sounds are unimplemented"),[y(p("list"))]}function M(t){return t.map((function(t){return t[1][0]&&"scratchComment"===t[1][0][2]?p("comment",{x:t[0].x,y:t[0].y,w:t[1][0][5],collapsed:!t[1][0][4]},[c(t[1][0][3])]):p("script",{x:t[0].x,y:t[0].y},w(t[1]))}))}return console.log(o),m("__global__",o.stage.customBlocks),o.stage.sprites.forEach((function(t){m(t.objName,t.customBlocks)})),p("project",{name:e,app:"Snap! 4.0, http://snap.berkeley.edu; serialized by yprxml, http://dl.dropbox.com/u/10715865/Web/snap/app/yprxml.html",version:"1"},[p("notes",{},[c(o.info.get("comment")||"")]),p("thumbnail",{},[c((n=o.info.get("thumbnail"))?n.image.toDataURL():"")]),y(p("stage",{name:"Stage",tempo:o.stage.tempoBPM,costume:a(o.stage),threadsafe:"false",scheduled:!0},[p("pentrails",{},[c((n=o.info.get("penTrails"))?n.image.toDataURL():"")]),p("costumes",{},x(o.stage.media)),p("sounds",{},k(o.stage.media)),p("blocks",{},[]),p("variables",{},[]),p("scripts",{},M(o.stage.blocksBin)),p("sprites",{},(l=o.stage.sprites,d=o.stage.vars,u=o.stage.lists,l.map((function(t,e){return y(p("sprite",{name:t.objName,x:(t.bounds.origin.x+t.bounds.corner.x)/2-240,y:180-(t.bounds.origin.y+t.bounds.corner.y)/2,hidden:1===t.flags,heading:t.rotationDegrees+90,scale:t.scalePoint.x,rotation:i[t.rotationStyle],draggable:t.draggable,costume:a(t),color:(255*t.color.r|0)+","+(255*t.color.g|0)+","+(255*t.color.b|0),pen:"tip",idx:e},[p("variables",{},S(t.vars,t.lists)),p("costumes",{},x(t.media)),p("sounds",{},k(t.media)),p("blocks",{},b(t.customBlocks,!1)),p("scripts",{},M(t.blocksBin))]))})).concat(d.keys.concat(u.keys).map((function(t){return p("watcher",{var:t,style:"normal",x:10,y:10,color:"243,118,29",hidden:!0})})))))])),p("variables",{},S(o.stage.vars,o.stage.lists)),p("blocks",{},b(o.stage.customBlocks,!0))]).toXML(h=[]),h.join("")}}(t.XMLWriter=function(){},t.XMLWriter.prototype),t}({});function s(t,e,o,i,s){this.init(t,e,o,i,s)}o.qz.symbols="2020-October-07",s.prototype=new o._V,s.prototype.constructor=s,s.uber=o._V.prototype,s.prototype.names=["square","pointRight","stepForward","gears","gearPartial","gearBig","file","fullScreen","grow","normalScreen","shrink","smallStage","normalStage","turtle","turtleOutline","stage","pause","flag","octagon","cloud","cloudGradient","cloudOutline","turnRight","turnLeft","turnAround","storage","poster","flash","brush","tick","checkedBox","rectangle","rectangleSolid","circle","circleSolid","ellipse","line","cross","crosshairs","paintbucket","eraser","pipette","speechBubble","speechBubbleOutline","loop","turnBack","turnForward","arrowUp","arrowUpOutline","arrowUpThin","arrowUpDownThin","arrowLeft","arrowLeftOutline","arrowLeftThin","arrowLeftRightThin","arrowDown","arrowDownOutline","arrowDownThin","arrowRight","arrowRightOutline","arrowRightThin","robot","magnifyingGlass","magnifierOutline","selection","polygon","closedBrush","notes","camera","location","footprints","keyboard","keyboardFilled","globe","globeBig","list","flipVertical","flipHorizontal"],s.prototype.init=function(t,e,i,r,n){this.isProtectedLabel=!1,this.isReadOnly=!0,this.name=t||"square",this.size=e||50,this.shadowOffset=r||o.xE,this.shadowColor=n||null,s.uber.init.call(this),this.color=i||o.E5,this.fixLayout(),this.rerender()},s.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+': "'+this.name+'" '+this.bounds},s.prototype.setLabelColor=function(t,e,i){this.shadowOffset=i||new o.E9,this.shadowColor=e,this.setColor(t)},s.prototype.getShadowRenderColor=function(){return this.shadowColor},s.prototype.setExtent=function(t){this.size!==t.y&&(this.changed(),this.size=t.y,this.fixLayout(),this.rerender())},s.prototype.fixLayout=function(){this.bounds.setWidth(this.symbolWidth()+Math.abs(this.shadowOffset.x)),this.bounds.setHeight(this.size+Math.abs(this.shadowOffset.y))},s.prototype.render=function(t){var e=this.shadowOffset.x<0?0:this.shadowOffset.x,o=this.shadowOffset.y<0?0:this.shadowOffset.y,i=this.shadowOffset.x<0?Math.abs(this.shadowOffset.x):0,s=this.shadowOffset.y<0?Math.abs(this.shadowOffset.y):0;this.shadowColor&&(t.save(),t.translate(e,o),this.renderShape(t,this.getShadowRenderColor()),t.restore()),t.save(),t.translate(i,s),this.renderShape(t,this.getRenderColor()),t.restore()},s.prototype.renderShape=function(t,e){switch(this.name){case"square":this.renderSymbolStop(t,e);break;case"pointRight":this.renderSymbolPointRight(t,e);break;case"stepForward":this.renderSymbolStepForward(t,e);break;case"gears":this.renderSymbolGears(t,e);break;case"gearBig":this.renderSymbolGearBig(t,e);break;case"gearPartial":this.renderSymbolGearPartial(t,e);break;case"file":this.renderSymbolFile(t,e);break;case"fullScreen":this.renderSymbolFullScreen(t,e);break;case"grow":this.renderSymbolGrow(t,e);break;case"normalScreen":this.renderSymbolNormalScreen(t,e);break;case"smallStage":this.renderSymbolSmallStage(t,e);break;case"normalStage":this.renderSymbolNormalStage(t,e);break;case"shrink":this.renderSymbolShrink(t,e);break;case"turtle":this.renderSymbolTurtle(t,e);break;case"turtleOutline":this.renderSymbolTurtleOutline(t,e);break;case"stage":this.renderSymbolStop(t,e);break;case"pause":this.renderSymbolPause(t,e);break;case"flag":this.renderSymbolFlag(t,e);break;case"octagon":this.renderSymbolOctagon(t,e);break;case"cloud":this.renderSymbolCloud(t,e);break;case"cloudGradient":this.renderSymbolCloudGradient(t,e);break;case"cloudOutline":this.renderSymbolCloudOutline(t,e);break;case"turnRight":this.renderSymbolTurnRight(t,e);break;case"turnLeft":this.renderSymbolTurnLeft(t,e);break;case"turnAround":this.renderSymbolTurnAround(t,e);break;case"storage":this.renderSymbolStorage(t,e);break;case"poster":this.renderSymbolPoster(t,e);break;case"flash":this.renderSymbolFlash(t,e);break;case"brush":this.renderSymbolBrush(t,e);break;case"tick":this.renderSymbolTick(t,e);break;case"checkedBox":this.renderSymbolCheckedBox(t,e);break;case"rectangle":this.renderSymbolRectangle(t,e);break;case"rectangleSolid":this.renderSymbolRectangleSolid(t,e);break;case"circle":this.renderSymbolCircle(t,e);break;case"circleSolid":this.renderSymbolCircleSolid(t,e);break;case"ellipse":this.renderSymbolCircle(t,e);break;case"line":this.renderSymbolLine(t,e);break;case"cross":this.renderSymbolCross(t,e);break;case"crosshairs":this.renderSymbolCrosshairs(t,e);break;case"paintbucket":this.renderSymbolPaintbucket(t,e);break;case"eraser":this.renderSymbolEraser(t,e);break;case"pipette":this.renderSymbolPipette(t,e);break;case"speechBubble":this.renderSymbolSpeechBubble(t,e);break;case"speechBubbleOutline":this.renderSymbolSpeechBubbleOutline(t,e);break;case"loop":this.renderSymbolLoop(t,e);break;case"turnBack":this.renderSymbolTurnBack(t,e);break;case"turnForward":this.renderSymbolTurnForward(t,e);break;case"arrowUp":this.renderSymbolArrowUp(t,e);break;case"arrowUpOutline":this.renderSymbolArrowUpOutline(t,e);break;case"arrowUpThin":this.renderSymbolArrowUpThin(t,e);break;case"arrowUpDownThin":this.renderSymbolArrowUpDownThin(t,e);break;case"arrowLeft":this.renderSymbolArrowLeft(t,e);break;case"arrowLeftOutline":this.renderSymbolArrowLeftOutline(t,e);break;case"arrowLeftThin":this.renderSymbolArrowLeftThin(t,e);break;case"arrowLeftRightThin":this.renderSymbolArrowLeftRightThin(t,e);break;case"arrowDown":this.renderSymbolArrowDown(t,e);break;case"arrowDownOutline":this.renderSymbolArrowDownOutline(t,e);break;case"arrowDownThin":this.renderSymbolArrowDownThin(t,e);break;case"arrowRight":this.renderSymbolArrowRight(t,e);break;case"arrowRightOutline":this.renderSymbolArrowRightOutline(t,e);break;case"arrowRightThin":this.renderSymbolArrowRightThin(t,e);break;case"robot":this.renderSymbolRobot(t,e);break;case"magnifyingGlass":this.renderSymbolMagnifyingGlass(t,e);break;case"magnifierOutline":this.renderSymbolMagnifierOutline(t,e);break;case"selection":this.renderSymbolSelection(t,e);break;case"polygon":this.renderSymbolOctagonOutline(t,e);break;case"closedBrush":this.renderSymbolClosedBrushPath(t,e);break;case"notes":this.renderSymbolNotes(t,e);break;case"camera":this.renderSymbolCamera(t,e);break;case"location":this.renderSymbolLocation(t,e);break;case"footprints":this.renderSymbolFootprints(t,e);break;case"keyboard":this.renderSymbolKeyboard(t,e);break;case"keyboardFilled":this.renderSymbolKeyboardFilled(t,e);break;case"globe":this.renderSymbolGlobe(t,e);break;case"globeBig":this.renderSymbolGlobeBig(t,e);break;case"list":this.renderSymbolList(t,e);break;case"flipVertical":this.renderSymbolFlipVertical(t,e);break;case"flipHorizontal":this.renderSymbolFlipHorizontal(t,e);break;default:throw new Error('unknown symbol name: "'+this.name+'"')}},s.prototype.symbolWidth=function(){var t=this.size;switch(this.name){case"pointRight":return Math.sqrt(t*t-Math.pow(t/2,2));case"location":return.6*t;case"flash":case"file":case"list":return.8*t;case"smallStage":case"normalStage":return 1.2*t;case"turtle":case"turtleOutline":case"stage":return 1.3*t;case"cloud":case"cloudGradient":case"cloudOutline":case"turnBack":case"turnForward":case"keyboard":case"keyboardFilled":return 1.6*t;case"turnRight":case"turnLeft":return t/3*2;case"loop":return 2*t;default:return t}},s.prototype.renderSymbolStop=function(t,e){t.fillStyle=e.toString(),t.fillRect(0,0,this.symbolWidth(),this.size)},s.prototype.renderSymbolPointRight=function(t,e){t.fillStyle=e.toString(),t.beginPath(),t.moveTo(0,0),t.lineTo(this.symbolWidth(),Math.round(this.size/2)),t.lineTo(0,this.size),t.lineTo(0,0),t.closePath(),t.fill()},s.prototype.renderSymbolStepForward=function(t,e){var o=this.symbolWidth(),i=this.size;t.fillStyle=e.toString(),t.beginPath(),t.moveTo(0,0),t.lineTo(.75*o,Math.round(i/2)),t.lineTo(0,i),t.lineTo(0,0),t.closePath(),t.fill(),t.fillRect(.75*o,0,.25*o,i)},s.prototype.renderSymbolGears=function(t,e){var i,s,r,n=this.symbolWidth(),a=n/2;for(t.fillStyle=e.toString(),t.beginPath(),t.moveTo(n,a),i=45,s=22.5,r=0;r<8;r+=1)t.arc(a,a,a,(0,o.uR)(r*i+s),(0,o.uR)(r*i+8+s)),t.arc(a,a,.7*a,(0,o.uR)(r*i-10+22.5+s),(0,o.uR)(r*i+10+22.5+s)),t.arc(a,a,a,(0,o.uR)((r+1)*i-8+s),(0,o.uR)((r+1)*i+s));t.lineTo(n,a),t.arc(a,a,.3*a,(0,o.uR)(0),(0,o.uR)(360)),t.clip("evenodd"),t.fillRect(0,0,n,n)},s.prototype.renderSymbolGearBig=function(t,e){var i,s,r=this.symbolWidth(),n=r/2;for(t.fillStyle=e.toString(),t.beginPath(),t.moveTo(r,n),i=36,s=0;s<10;s+=1)t.arc(n,n,n,(0,o.uR)(s*i),(0,o.uR)(s*i+7)),t.arc(n,n,.8*n,(0,o.uR)(s*i-8+18),(0,o.uR)(s*i+8+18)),t.arc(n,n,n,(0,o.uR)((s+1)*i-7),(0,o.uR)((s+1)*i));t.lineTo(r,n),t.arc(n,n,.6*n,(0,o.uR)(0),(0,o.uR)(360)),t.arc(n,n,.2*n,(0,o.uR)(0),(0,o.uR)(360)),t.clip("evenodd"),t.fillRect(0,0,r,r)},s.prototype.renderSymbolGearPartial=function(t,e){var i,s,r,n=this.symbolWidth(),a=.75*n;for(t.fillStyle=e.toString(),t.beginPath(),t.moveTo(n,a),i=45,s=22.5,r=0;r<8;r+=1)t.arc(a,a,a,(0,o.uR)(r*i+s),(0,o.uR)(r*i+8+s)),t.arc(a,a,.7*a,(0,o.uR)(r*i-10+22.5+s),(0,o.uR)(r*i+10+22.5+s)),t.arc(a,a,a,(0,o.uR)((r+1)*i-8+s),(0,o.uR)((r+1)*i+s));t.lineTo(n,a),t.arc(a,a,.3*a,(0,o.uR)(0),(0,o.uR)(360)),t.clip("evenodd"),t.fillRect(0,0,n,n)},s.prototype.renderSymbolFile=function(t,e){var o=this.size,i=this.symbolWidth(),s=Math.min(i,o)/2;t.fillStyle=e.toString(),t.beginPath(),t.moveTo(0,0),t.lineTo(s,0),t.lineTo(s,s),t.lineTo(i,s),t.lineTo(i,o),t.lineTo(0,o),t.closePath(),t.fill(),t.fillStyle=e.darker(25).toString(),t.beginPath(),t.moveTo(s,0),t.lineTo(i,s),t.lineTo(s,s),t.lineTo(s,0),t.closePath(),t.fill()},s.prototype.renderSymbolFullScreen=function(t,e){var o=this.size,i=this.symbolWidth(),s=i/2,r=i/20,n=i/2;t.strokeStyle=e.toString(),t.lineWidth=i/5,t.beginPath(),t.moveTo(s-r,s+r),t.lineTo(2*r,o-2*r),t.stroke(),t.strokeStyle=e.toString(),t.lineWidth=i/5,t.beginPath(),t.moveTo(s+r,s-r),t.lineTo(o-2*r,2*r),t.stroke(),t.fillStyle=e.toString(),t.beginPath(),t.moveTo(0,o),t.lineTo(0,o-n),t.lineTo(n,o),t.closePath(),t.fill(),t.fillStyle=e.toString(),t.beginPath(),t.moveTo(o,0),t.lineTo(o-n,0),t.lineTo(o,n),t.closePath(),t.fill()},s.prototype.renderSymbolGrow=function(t,e){var i=this.size,s=this.symbolWidth(),r=s/2,n=s/20,a=s/3;function h(){t.strokeStyle=e.toString(),t.lineWidth=s/7,t.beginPath(),t.moveTo(r-3*n,r+3*n),t.lineTo(2*n,i-2*n),t.stroke(),t.strokeStyle=e.toString(),t.lineWidth=s/7,t.beginPath(),t.moveTo(r+3*n,r-3*n),t.lineTo(i-2*n,2*n),t.stroke(),t.fillStyle=e.toString(),t.beginPath(),t.moveTo(0,i),t.lineTo(0,i-a),t.lineTo(a,i),t.closePath(),t.fill(),t.fillStyle=e.toString(),t.beginPath(),t.moveTo(i,0),t.lineTo(i-a,0),t.lineTo(i,a),t.closePath(),t.fill()}h(),t.translate(this.size,0),t.rotate((0,o.uR)(90)),h()},s.prototype.renderSymbolNormalScreen=function(t,e){var o=this.size,i=this.symbolWidth(),s=i/2,r=i/20;t.strokeStyle=e.toString(),t.lineWidth=i/5,t.beginPath(),t.moveTo(s-3*r,s+3*r),t.lineTo(r,o-r),t.stroke(),t.strokeStyle=e.toString(),t.lineWidth=i/5,t.beginPath(),t.moveTo(s+3*r,s-3*r),t.lineTo(o-r,r),t.stroke(),t.fillStyle=e.toString(),t.beginPath(),t.moveTo(s+r,s-r),t.lineTo(i,s-r),t.lineTo(s+r,0),t.closePath(),t.fill(),t.fillStyle=e.toString(),t.beginPath(),t.moveTo(s-r,s+r),t.lineTo(0,s+r),t.lineTo(s-r,i),t.closePath(),t.fill()},s.prototype.renderSymbolShrink=function(t,e){var i=this.size,s=this.symbolWidth(),r=s/2,n=s/20;function a(){t.strokeStyle=e.toString(),t.lineWidth=s/8,t.beginPath(),t.moveTo(r-3*n,r+3*n),t.lineTo(n,i-n),t.stroke(),t.strokeStyle=e.toString(),t.lineWidth=s/8,t.beginPath(),t.moveTo(r+3*n,r-3*n),t.lineTo(i-n,n),t.stroke(),t.fillStyle=e.toString(),t.beginPath(),t.moveTo(r+2*n,r-2*n),t.lineTo(s-n,r-2*n),t.lineTo(r+2*n,0+n),t.closePath(),t.fill(),t.fillStyle=e.toString(),t.beginPath(),t.moveTo(r-2*n,r+2*n),t.lineTo(0+n,r+2*n),t.lineTo(r-2*n,s-n),t.closePath(),t.fill()}a(),t.translate(this.size,0),t.rotate((0,o.uR)(90)),a()},s.prototype.renderSymbolSmallStage=function(t,e){var o=this.symbolWidth(),i=this.size,s=o/2,r=i/2;t.fillStyle=e.darker(50).toString(),t.fillRect(0,0,o,i),t.fillStyle=e.toString(),t.fillRect(s,0,s,r)},s.prototype.renderSymbolNormalStage=function(t,e){var o=this.symbolWidth(),i=this.size,s=o/2,r=i/2;t.fillStyle=e.toString(),t.fillRect(0,0,o,i),t.fillStyle=e.darker(50).toString(),t.fillRect(s,0,s,r)},s.prototype.renderSymbolTurtle=function(t,e){var o=this.symbolWidth(),i=this.size;t.fillStyle=e.toString(),t.beginPath(),t.moveTo(0,0),t.lineTo(o,i/2),t.lineTo(0,i),t.lineTo(i/2,i/2),t.closePath(),t.fill()},s.prototype.renderSymbolTurtleOutline=function(t,e){var o=this.symbolWidth(),i=this.size;t.strokeStyle=e.toString(),t.beginPath(),t.moveTo(0,0),t.lineTo(o,i/2),t.lineTo(0,i),t.lineTo(i/2,i/2),t.closePath(),t.stroke()},s.prototype.renderSymbolPause=function(t,e){var o=this.symbolWidth()/5,i=this.size;t.fillStyle=e.toString(),t.fillRect(0,0,2*o,i),t.fillRect(3*o,0,2*o,i)},s.prototype.renderSymbolFlag=function(t,e){var o=this.symbolWidth(),i=this.size,s=Math.max(o/12,1);t.lineWidth=s,t.strokeStyle=e.toString(),t.beginPath(),t.moveTo(s/2,0),t.lineTo(s/2,i),t.stroke(),t.lineWidth=i/2,t.beginPath(),t.moveTo(0,i/4),t.bezierCurveTo(.8*o,i/4,.1*o,.5*i,o,.5*i),t.stroke()},s.prototype.renderSymbolOctagon=function(t,e){var o=this.symbolWidth(),i=(o-.383*o)/2;t.fillStyle=e.toString(),t.beginPath(),t.moveTo(i,0),t.lineTo(o-i,0),t.lineTo(o,i),t.lineTo(o,o-i),t.lineTo(o-i,o),t.lineTo(i,o),t.lineTo(0,o-i),t.lineTo(0,i),t.closePath(),t.fill()},s.prototype.renderSymbolCloud=function(t,e){var i=this.symbolWidth(),s=this.size,r=2*s/5,n=s/4,a=3*s/10,h=s/5;t.fillStyle=e.toString(),t.beginPath(),t.arc(n,s-n,n,(0,o.uR)(90),(0,o.uR)(259),!1),t.arc(i/20*5,s/9*4,h,(0,o.uR)(165),(0,o.uR)(300),!1),t.arc(i/20*11,r,r,(0,o.uR)(200),(0,o.uR)(357),!1),t.arc(i-a,s-a,a,(0,o.uR)(269),(0,o.uR)(90),!1),t.closePath(),t.fill()},s.prototype.renderSymbolCloudGradient=function(t,e){var i,s=this.symbolWidth(),r=this.size,n=2*r/5,a=r/4,h=3*r/10,l=r/5;(i=t.createRadialGradient(0,0,0,0,0,s)).addColorStop(0,e.lighter(25).toString()),i.addColorStop(1,e.darker(25).toString()),t.fillStyle=i,t.beginPath(),t.arc(a,r-a,a,(0,o.uR)(90),(0,o.uR)(259),!1),t.arc(s/20*5,r/9*4,l,(0,o.uR)(165),(0,o.uR)(300),!1),t.arc(s/20*11,n,n,(0,o.uR)(200),(0,o.uR)(357),!1),t.arc(s-h,r-h,h,(0,o.uR)(269),(0,o.uR)(90),!1),t.closePath(),t.fill()},s.prototype.renderSymbolCloudOutline=function(t,e){var i=this.symbolWidth(),s=this.size,r=2*s/5,n=s/4,a=3*s/10,h=s/5;t.strokeStyle=e.toString(),t.beginPath(),t.arc(n+1,s-n-1,n,(0,o.uR)(90),(0,o.uR)(180),!1),t.arc(i/20*5,s/9*4,h,(0,o.uR)(150),(0,o.uR)(300),!1),t.arc(i/20*11,r+1,r,(0,o.uR)(210),(0,o.uR)(335),!1),t.arc(i-a-1,s-a-1,a,(0,o.uR)(280),(0,o.uR)(90),!1),t.closePath(),t.stroke()},s.prototype.renderSymbolTurnRight=function(t,e){var i=this.symbolWidth(),s=Math.max(i/10,1),r=i/2;t.lineWidth=s,t.strokeStyle=e.toString(),t.beginPath(),t.arc(r,2*r,r-s/2,(0,o.uR)(0),(0,o.uR)(-90),!1),t.stroke(),t.fillStyle=e.toString(),t.beginPath(),t.moveTo(i,r),t.lineTo(r,0),t.lineTo(r,2*r),t.closePath(),t.fill()},s.prototype.renderSymbolTurnLeft=function(t,e){var i=this.symbolWidth(),s=Math.max(i/10,1),r=i/2;t.lineWidth=s,t.strokeStyle=e.toString(),t.beginPath(),t.arc(r,2*r,r-s/2,(0,o.uR)(180),(0,o.uR)(-90),!0),t.stroke(),t.fillStyle=e.toString(),t.beginPath(),t.moveTo(0,r),t.lineTo(r,0),t.lineTo(r,2*r),t.closePath(),t.fill()},s.prototype.renderSymbolTurnAround=function(t,e){var i=this.symbolWidth(),s=Math.max(i/10,1),r=i/2;t.lineWidth=s,t.strokeStyle=e.toString(),t.beginPath(),t.arc(r,r,r-s/2,(0,o.uR)(-45),(0,o.uR)(225),!1),t.stroke(),t.fillStyle=e.toString(),t.beginPath(),t.moveTo(0,.1*r),t.lineTo(.8*r,0),t.lineTo(.7*r,.7*r),t.closePath(),t.fill()},s.prototype.renderSymbolStorage=function(t,e){var i=this.symbolWidth(),s=this.size,r=s,n=s/11;function a(a){t.fillStyle=e.toString(),t.beginPath(),t.arc(i/2,a-s,r,(0,o.uR)(60),(0,o.uR)(120),!1),t.lineTo(0,a-2*n),t.arc(i/2,a-s-2*n,r,(0,o.uR)(120),(0,o.uR)(60),!0),t.closePath(),t.fill(),t.fillStyle=e.darker(25).toString(),t.beginPath(),t.arc(i/2,a+6*n+1,r,(0,o.uR)(-120),(0,o.uR)(-60),!1),t.stroke()}t.strokeStyle=e.toString(),a(s),a(s-3*n),a(s-6*n)},s.prototype.renderSymbolPoster=function(t,e){var o=this.symbolWidth(),i=this.size,s=.75*i,r=i/5;t.fillStyle=e.toString(),t.strokeStyle=e.toString(),t.lineWidth=o/15,t.beginPath(),t.moveTo(o/2,i/3),t.lineTo(o/6,i),t.stroke(),t.beginPath(),t.moveTo(o/2,i/3),t.lineTo(o/2,i),t.stroke(),t.beginPath(),t.moveTo(o/2,i/3),t.lineTo(5*o/6,i),t.stroke(),t.beginPath(),t.moveTo(0,0),t.lineTo(o,0),t.lineTo(o,s-r),t.lineTo(o-r,s-r),t.lineTo(o-r,s),t.lineTo(0,s),t.closePath(),t.fill(),t.fillStyle=e.darker(25).toString(),t.beginPath(),t.moveTo(o,s-r),t.lineTo(o-r,s-r),t.lineTo(o-r,s),t.closePath(),t.fill()},s.prototype.renderSymbolFlash=function(t,e){var o=this.symbolWidth(),i=this.size,s=o/3,r=i/3,n=r/3;t.fillStyle=e.toString(),t.beginPath(),t.moveTo(s,0),t.lineTo(0,r),t.lineTo(s,r),t.lineTo(0,2*r),t.lineTo(s,2*r),t.lineTo(0,i),t.lineTo(o,2*r-n),t.lineTo(2*s,2*r-n),t.lineTo(o,r-n),t.lineTo(2*s,r-n),t.lineTo(o,0),t.closePath(),t.fill()},s.prototype.renderSymbolBrush=function(t,e){var o=this.symbolWidth(),i=this.size,s=Math.max(o/30,.5);t.fillStyle=e.toString(),t.lineWidth=2*s,t.beginPath(),t.moveTo(o/8*3,i/2),t.quadraticCurveTo(0,i/2,s,i-s),t.quadraticCurveTo(o/2,i,o/2,i/8*5),t.closePath(),t.fill(),t.lineJoin="round",t.lineCap="round",t.strokeStyle=e.toString(),t.moveTo(o/8*3,i/2),t.lineTo(.75*o,s),t.quadraticCurveTo(o,0,o-s,.25*i),t.stroke(),t.moveTo(o/2,i/8*5),t.lineTo(o-s,.25*i),t.stroke()},s.prototype.renderSymbolTick=function(t,e){var o=this.symbolWidth(),i=this.size;t.fillStyle=e.toString(),t.beginPath(),t.moveTo(.2*o,.5*i),t.lineTo(.5*o,i),t.lineTo(.8*o,.3*i),t.lineTo(o,0),t.lineTo(.65*o,.2*i),t.lineTo(.5*o,.65*i),t.closePath(),t.fill()},s.prototype.renderSymbolCheckedBox=function(t,e){this.renderSymbolRectangle(t,e),this.renderSymbolTick(t,e)},s.prototype.renderSymbolRectangle=function(t,e){var o=this.symbolWidth(),i=this.size,s=Math.max(o/20,.5);t.strokeStyle=e.toString(),t.lineWidth=2*s,t.beginPath(),t.moveTo(s,s),t.lineTo(o-s,s),t.lineTo(o-s,i-s),t.lineTo(s,i-s),t.closePath(),t.stroke()},s.prototype.renderSymbolRectangleSolid=function(t,e){var o=this.symbolWidth(),i=this.size;t.fillStyle=e.toString(),t.beginPath(),t.moveTo(0,0),t.lineTo(o,0),t.lineTo(o,i),t.lineTo(0,i),t.closePath(),t.fill()},s.prototype.renderSymbolCircle=function(t,e){var i=this.symbolWidth(),s=Math.max(i/20,.5);t.strokeStyle=e.toString(),t.lineWidth=2*s,t.beginPath(),t.arc(i/2,i/2,i/2-s,(0,o.uR)(0),(0,o.uR)(360),!1),t.stroke()},s.prototype.renderSymbolCircleSolid=function(t,e){var i=this.symbolWidth();t.fillStyle=e.toString(),t.beginPath(),t.arc(i/2,i/2,i/2,(0,o.uR)(0),(0,o.uR)(360),!1),t.fill()},s.prototype.renderSymbolLine=function(t,e){var o=this.symbolWidth(),i=this.size,s=Math.max(o/20,.5);t.strokeStyle=e.toString(),t.lineWidth=2*s,t.lineCap="round",t.beginPath(),t.moveTo(s,s),t.lineTo(o-s,i-s),t.stroke()},s.prototype.renderSymbolCross=function(t,e){var o=this.symbolWidth(),i=Math.max(o/20,.5);t.strokeStyle=e.toString(),t.lineWidth=2*i,t.lineCap="round",t.beginPath(),t.moveTo(i,o/2),t.lineTo(o-i,o/2),t.stroke(),t.beginPath(),t.moveTo(o/2,i),t.lineTo(o/2,o-i),t.stroke()},s.prototype.renderSymbolCrosshairs=function(t,e){var i=this.symbolWidth(),s=this.size,r=.5;t.strokeStyle=e.toString(),t.lineWidth=1,t.beginPath(),t.moveTo(r,s/2),t.lineTo(i-r,s/2),t.stroke(),t.beginPath(),t.moveTo(i/2,r),t.lineTo(i/2,s-r),t.stroke(),t.beginPath(),t.moveTo(i/2,s/2),t.arc(i/2,i/2,i/3-r,(0,o.uR)(0),(0,o.uR)(360),!1),t.stroke()},s.prototype.renderSymbolPaintbucket=function(t,e){var i=this.symbolWidth(),s=this.size,r=i/5,n=Math.max(i/30,.5);t.strokeStyle=e.toString(),t.lineWidth=2*n,t.beginPath(),t.moveTo(2*r,r),t.lineTo(4*r,3*r),t.lineTo(3*r,4*r),t.quadraticCurveTo(2*r,s,r,4*r),t.quadraticCurveTo(0,3*r,r,2*r),t.closePath(),t.stroke(),t.lineWidth=n,t.moveTo(2*r,2.5*r),t.arc(2*r,2.5*r,n,(0,o.uR)(0),(0,o.uR)(360),!1),t.stroke(),t.moveTo(2*r,2.5*r),t.lineTo(2*r,r/2+n),t.stroke(),t.arc(1.5*r,r/2+n,r/2,(0,o.uR)(0),(0,o.uR)(180),!0),t.stroke(),t.moveTo(r,r/2+n),t.lineTo(r,2*r),t.stroke(),t.fillStyle=e.toString(),t.beginPath(),t.moveTo(3.5*r,3.5*r),t.quadraticCurveTo(i,3.5*r,i-n,s),t.lineTo(i,s),t.quadraticCurveTo(i,2*r,2.5*r,1.5*r),t.lineTo(4*r,3*r),t.closePath(),t.fill()},s.prototype.renderSymbolEraser=function(t,e){var o=this.symbolWidth(),i=this.size,s=o/4,r=Math.max(o/20,.5);t.strokeStyle=e.toString(),t.lineWidth=2*r,t.beginPath(),t.moveTo(3*s,r),t.lineTo(r,3*s),t.quadraticCurveTo(s,i,2*s,3*s),t.lineTo(o-r,s),t.closePath(),t.stroke(),t.fillStyle=e.toString(),t.beginPath(),t.moveTo(3*s,0),t.lineTo(1.5*s,1.5*s),t.lineTo(2.5*s,2.5*s),t.lineTo(o,s),t.closePath(),t.fill()},s.prototype.renderSymbolPipette=function(t,e){var i=this.symbolWidth(),s=this.size,r=i/4,n=r/2,a=Math.max(i/20,.5);t.strokeStyle=e.toString(),t.lineWidth=2*a,t.beginPath(),t.moveTo(a,s-a),t.quadraticCurveTo(n,s-n,n,s-r),t.lineTo(2*r,1.5*r),t.stroke(),t.beginPath(),t.moveTo(a,s-a),t.quadraticCurveTo(n,s-n,r,s-n),t.lineTo(2.5*r,2*r),t.stroke(),t.fillStyle=e.toString(),t.arc(3*r,r,r-a,(0,o.uR)(0),(0,o.uR)(360),!1),t.fill(),t.beginPath(),t.moveTo(2*r,r),t.lineTo(3*r,2*r),t.stroke()},s.prototype.renderSymbolSpeechBubble=function(t,e){var o=this.symbolWidth(),i=this.size,s=o/3,r=Math.max(o/20,.5);t.fillStyle=e.toString(),t.lineWidth=2*r,t.beginPath(),t.moveTo(s,2*s),t.quadraticCurveTo(r,2*s,r,s),t.quadraticCurveTo(r,r,s,r),t.lineTo(2*s,r),t.quadraticCurveTo(o-r,r,o-r,s),t.quadraticCurveTo(o-r,2*s,2*s,2*s),t.lineTo(s/2,i-r),t.closePath(),t.fill()},s.prototype.renderSymbolSpeechBubbleOutline=function(t,e){var o=this.symbolWidth(),i=this.size,s=o/3,r=Math.max(o/20,.5);t.strokeStyle=e.toString(),t.lineWidth=2*r,t.beginPath(),t.moveTo(s,2*s),t.quadraticCurveTo(r,2*s,r,s),t.quadraticCurveTo(r,r,s,r),t.lineTo(2*s,r),t.quadraticCurveTo(o-r,r,o-r,s),t.quadraticCurveTo(o-r,2*s,2*s,2*s),t.lineTo(s/2,i-r),t.closePath(),t.stroke()},s.prototype.renderSymbolLoop=function(t,e){var i=this.symbolWidth(),s=this.size,r=i/2,n=r/2,a=s/2,h=Math.max(s/10,.5);t.lineWidth=2*h,t.strokeStyle=e.toString(),t.beginPath(),t.moveTo(0,s-h),t.lineTo(r,s-h),t.arc(r,a,a-h,(0,o.uR)(90),(0,o.uR)(0),!0),t.stroke(),t.fillStyle=e.toString(),t.beginPath(),t.moveTo(3*n-h,0),t.lineTo(r-h,a),t.lineTo(i,a),t.closePath(),t.fill()},s.prototype.renderSymbolTurnBack=function(t,e){var i=this.symbolWidth(),s=this.size,r=i/2,n=s/2,a=Math.max(i/20,.5);t.fillStyle=e.toString(),t.lineWidth=2*a,t.beginPath(),t.moveTo(0,n),t.lineTo(r,0),t.lineTo(r,s),t.closePath(),t.fill(),t.lineWidth=3*a,t.strokeStyle=e.toString(),t.beginPath(),t.arc(r,s,n,(0,o.uR)(0),(0,o.uR)(-90),!0),t.stroke()},s.prototype.renderSymbolTurnForward=function(t,e){var i=this.symbolWidth(),s=this.size,r=i/2,n=s/2,a=Math.max(i/20,.5);t.fillStyle=e.toString(),t.lineWidth=2*a,t.beginPath(),t.moveTo(i,n),t.lineTo(r,0),t.lineTo(r,s),t.closePath(),t.fill(),t.lineWidth=3*a,t.strokeStyle=e.toString(),t.beginPath(),t.arc(r,s,n,(0,o.uR)(-180),(0,o.uR)(-90),!1),t.stroke()},s.prototype.renderSymbolArrowUp=function(t,e){var o=this.symbolWidth(),i=this.size,s=o/2,r=Math.max(o/20,.5);t.fillStyle=e.toString(),t.lineWidth=2*r,t.beginPath(),t.moveTo(r,s),t.lineTo(s,r),t.lineTo(o-r,s),t.lineTo(.65*o,s),t.lineTo(.65*o,i-r),t.lineTo(.35*o,i-r),t.lineTo(.35*o,s),t.closePath(),t.fill()},s.prototype.renderSymbolArrowUpOutline=function(t,e){var o=this.symbolWidth(),i=this.size,s=o/2,r=Math.max(o/20,.5);t.strokeStyle=e.toString(),t.lineWidth=2*r,t.beginPath(),t.moveTo(r,s),t.lineTo(s,r),t.lineTo(o-r,s),t.lineTo(.65*o,s),t.lineTo(.65*o,i-r),t.lineTo(.35*o,i-r),t.lineTo(.35*o,s),t.closePath(),t.stroke()},s.prototype.renderSymbolArrowUpThin=function(t,e){var o=this.symbolWidth(),i=this.size,s=o/3,r=Math.max(o/20,.5);t.strokeStyle=e.toString(),t.lineWidth=2*r,t.beginPath(),t.moveTo(o-s,s),t.lineTo(o/2,2*r),t.lineTo(s,s),t.moveTo(o/2,2*r),t.lineTo(o/2,i-r),t.stroke()},s.prototype.renderSymbolArrowUpDownThin=function(t,e){var o=this.symbolWidth(),i=this.size,s=o/3,r=Math.max(o/20,.5);t.strokeStyle=e.toString(),t.lineWidth=2*r,t.beginPath(),t.moveTo(o-s,s),t.lineTo(o/2,2*r),t.lineTo(s,s),t.moveTo(o-s,i-s),t.lineTo(o/2,i-2*r),t.lineTo(s,i-s),t.moveTo(o/2,2*r),t.lineTo(o/2,i-2*r),t.stroke()},s.prototype.renderSymbolArrowDown=function(t,e){var i=this.symbolWidth();t.save(),t.translate(i,i),t.rotate((0,o.uR)(180)),this.renderSymbolArrowUp(t,e),t.restore()},s.prototype.renderSymbolArrowDownOutline=function(t,e){var i=this.symbolWidth();t.save(),t.translate(i,i),t.rotate((0,o.uR)(180)),this.renderSymbolArrowUpOutline(t,e),t.restore()},s.prototype.renderSymbolArrowDownThin=function(t,e){var i=this.symbolWidth();t.save(),t.translate(i,i),t.rotate((0,o.uR)(180)),this.renderSymbolArrowUpThin(t,e),t.restore()},s.prototype.renderSymbolArrowLeft=function(t,e){var i=this.symbolWidth();t.save(),t.translate(0,i),t.rotate((0,o.uR)(-90)),this.renderSymbolArrowUp(t,e),t.restore()},s.prototype.renderSymbolArrowLeftOutline=function(t,e){var i=this.symbolWidth();t.save(),t.translate(0,i),t.rotate((0,o.uR)(-90)),this.renderSymbolArrowUpOutline(t,e),t.restore()},s.prototype.renderSymbolArrowLeftThin=function(t,e){var i=this.symbolWidth();t.save(),t.translate(0,i),t.rotate((0,o.uR)(-90)),this.renderSymbolArrowUpThin(t,e),t.restore()},s.prototype.renderSymbolArrowLeftRightThin=function(t,e){var i=this.symbolWidth();t.save(),t.translate(0,i),t.rotate((0,o.uR)(-90)),this.renderSymbolArrowUpDownThin(t,e),t.restore()},s.prototype.renderSymbolArrowRight=function(t,e){var i=this.symbolWidth();t.save(),t.translate(i,0),t.rotate((0,o.uR)(90)),this.renderSymbolArrowUp(t,e),t.restore()},s.prototype.renderSymbolArrowRightOutline=function(t,e){var i=this.symbolWidth();t.save(),t.translate(i,0),t.rotate((0,o.uR)(90)),this.renderSymbolArrowUpOutline(t,e),t.restore()},s.prototype.renderSymbolArrowRightThin=function(t,e){var i=this.symbolWidth();t.save(),t.translate(i,0),t.rotate((0,o.uR)(90)),this.renderSymbolArrowUpThin(t,e),t.restore()},s.prototype.renderSymbolRobot=function(t,e){var o=this.symbolWidth(),i=this.size,s=o/6,r=s/2,n=Math.max(o/20,.5);t.fillStyle=e.toString(),t.beginPath(),t.moveTo(s+n,s),t.lineTo(2*s,s),t.lineTo(2.5*s,1.5*s),t.lineTo(3.5*s,1.5*s),t.lineTo(4*s,s),t.lineTo(5*s-n,s),t.lineTo(4*s,3*s),t.lineTo(4*s,4*s-n),t.lineTo(2*s,4*s-n),t.lineTo(2*s,3*s),t.closePath(),t.fill(),t.beginPath(),t.moveTo(2.75*s,s+n),t.lineTo(2.4*s,s),t.lineTo(2.2*s,0),t.lineTo(3.8*s,0),t.lineTo(3.6*s,s),t.lineTo(3.25*s,s+n),t.closePath(),t.fill(),t.beginPath(),t.moveTo(2.5*s,4*s),t.lineTo(s,4*s),t.lineTo(r+n,i),t.lineTo(2*s,i),t.closePath(),t.fill(),t.beginPath(),t.moveTo(3.5*s,4*s),t.lineTo(5*s,4*s),t.lineTo(o-(r+n),i),t.lineTo(4*s,i),t.closePath(),t.fill(),t.beginPath(),t.moveTo(s,s),t.lineTo(n,1.5*s),t.lineTo(n,3.25*s),t.lineTo(1.5*s,3.5*s),t.closePath(),t.fill(),t.beginPath(),t.moveTo(5*s,s),t.lineTo(o-n,1.5*s),t.lineTo(o-n,3.25*s),t.lineTo(4.5*s,3.5*s),t.closePath(),t.fill()},s.prototype.renderSymbolMagnifyingGlass=function(t,e){var i,s=this.symbolWidth(),r=this.size,n=.3*s,a=2*s/3-Math.sqrt(n),h=r/3+Math.sqrt(n),l=Math.max(s/5,.5);t.strokeStyle=e.toString(),(i=t.createRadialGradient(a,h,0,a+n,h+n,s)).addColorStop(0,e.inverted().lighter(50).toString()),i.addColorStop(1,e.inverted().darker(25).toString()),t.fillStyle=i,t.beginPath(),t.arc(a,h,n,(0,o.uR)(0),(0,o.uR)(360),!1),t.fill(),t.lineWidth=l/2,t.beginPath(),t.arc(a,h,n,(0,o.uR)(0),(0,o.uR)(360),!1),t.stroke(),t.lineWidth=l,t.beginPath(),t.moveTo(l/2,r-l/2),t.lineTo(a-Math.sqrt(n+l),h+Math.sqrt(n+l)),t.closePath(),t.stroke()},s.prototype.renderSymbolMagnifierOutline=function(t,e){var i=this.symbolWidth(),s=this.size,r=.3*i,n=2*i/3-Math.sqrt(r),a=s/3+Math.sqrt(r),h=Math.max(i/5,.5);t.strokeStyle=e.toString(),t.lineWidth=.5*h,t.beginPath(),t.arc(n,a,r,(0,o.uR)(0),(0,o.uR)(360),!1),t.stroke(),t.lineWidth=h,t.beginPath(),t.moveTo(h/2,s-h/2),t.lineTo(n-Math.sqrt(r+h),a+Math.sqrt(r+h)),t.closePath(),t.stroke()},s.prototype.renderSymbolSelection=function(t,e){var i=this.symbolWidth(),s=this.size;t.save(),t.setLineDash([3]),this.renderSymbolRectangle(t,e),t.restore(),t.save(),t.fillStyle=e.toString(),t.translate(.7*i,.4*s),t.scale(.5,.5),t.rotate((0,o.uR)(135)),this.renderSymbolArrowDownOutline(t,e),t.fill(),t.restore()},s.prototype.renderSymbolOctagonOutline=function(t,e){var o=this.symbolWidth(),i=(o-.383*o)/2,s=Math.max(o/20,.5);t.strokeStyle=e.toString(),t.lineWidth=2*s,t.beginPath(),t.moveTo(i,s),t.lineTo(o-i,s),t.lineTo(o-s,i),t.lineTo(o-s,o-i),t.lineTo(o-i,o-s),t.lineTo(i,o-s),t.lineTo(s,o-i),t.lineTo(s,i),t.closePath(),t.stroke()},s.prototype.renderSymbolClosedBrushPath=s.prototype.renderSymbolCloudOutline,s.prototype.renderSymbolNotes=function(t,e){var i=this.symbolWidth(),s=i/6,r=Math.max(s/3,1);t.strokeStyle=e.toString(),t.fillStyle=e.toString(),t.beginPath(),t.arc(s,i-s,s,(0,o.uR)(0),(0,o.uR)(360),!1),t.fill(),t.beginPath(),t.arc(i-s,i-2*s,s,(0,o.uR)(0),(0,o.uR)(360),!1),t.fill(),t.beginPath(),t.moveTo(2*s-r,s),t.lineTo(i,0),t.lineTo(i,s),t.lineTo(2*s-r,2*s),t.closePath(),t.fill(),t.lineWidth=r,t.beginPath(),t.moveTo(2*s-r/2,i-s),t.lineTo(2*s-r/2,s+r),t.stroke(),t.beginPath(),t.moveTo(i-r/2,i-2*s),t.lineTo(i-r/2,r),t.stroke()},s.prototype.renderSymbolCamera=function(t,e){var i=this.symbolWidth(),s=this.size,r=.16*i,n=Math.max(i/20,.5);t.lineWidth=2*n,t.fillStyle=e.toString(),t.beginPath(),t.moveTo(n,5*s/6),t.lineTo(i-n,5*s/6),t.lineTo(i-n,s/4),t.lineTo(3*i/4,s/4),t.lineTo(5*i/8,n),t.lineTo(3*i/8,n),t.lineTo(i/4,s/4),t.lineTo(n,s/4),t.lineTo(n,5*s/6),t.arc(i/2,s/2,r,(0,o.uR)(0),(0,o.uR)(360),!1),t.clip(),t.fillRect(0,0,i,s)},s.prototype.renderSymbolLocation=function(t,e){var i=this.symbolWidth(),s=this.size,r=i/2;t.fillStyle=e.toString(),t.beginPath(),t.moveTo(0,r),t.arc(r,r,r,(0,o.uR)(-180),(0,o.uR)(0),!1),t.lineTo(r,s),t.lineTo(0,r),t.arc(r,r,.5*r,(0,o.uR)(0),(0,o.uR)(360),!1),t.clip("evenodd"),t.fillRect(0,0,i,s)},s.prototype.renderSymbolFootprints=function(t,e){var i=this.symbolWidth(),s=i/10,r=1.5*s;t.fillStyle=e.toString(),t.beginPath(),t.arc(r,r,r,(0,o.uR)(-200),(0,o.uR)(0),!1),t.lineTo(2*r,5.5*s),t.lineTo(s,6*s),t.closePath(),t.fill(),t.beginPath(),t.arc(2.25*s,6.75*s,s,(0,o.uR)(-40),(0,o.uR)(-170),!1),t.closePath(),t.fill(),t.beginPath(),t.arc(i-r,4.5*s,r,(0,o.uR)(-180),(0,o.uR)(20),!1),t.lineTo(i-s,8.5*s),t.lineTo(i-2*r,8*s),t.closePath(),t.fill(),t.beginPath(),t.arc(i-2.25*s,9*s,s,(0,o.uR)(0),(0,o.uR)(-150),!1),t.closePath(),t.fill()},s.prototype.renderSymbolKeyboard=function(t,e){var o,i,s=this.size,r=s/10,n=s/5;for(t.fillStyle=e.toString(),o=0;o<2;o+=1)for(i=0;i<5;i+=1)t.fillRect((r+n)*i+r,(r+n)*o+r,n,n);t.fillRect(4*r,7*r,4*n,n)},s.prototype.renderSymbolKeyboardFilled=function(t,e){var o,i,s=this.symbolWidth(),r=this.size,n=r/10,a=r/5;for(t.fillStyle=e.toString(),t.beginPath(),t.rect(0,0,s,r),o=0;o<2;o+=1)for(i=0;i<5;i+=1)t.rect((n+a)*i+n,(n+a)*o+n,a,a);t.rect(4*n,7*n,4*a,a),t.clip("evenodd"),t.fillRect(0,0,s,r)},s.prototype.renderSymbolGlobeBig=function(t,e){this.renderSymbolGlobe(t,e,!0)},s.prototype.renderSymbolGlobe=function(t,e,i){var s=this.symbolWidth(),r=Math.max(s/30,.5);t.strokeStyle=e.toString(),t.lineWidth=2*r,t.beginPath(),t.arc(s/2,s/2,s/2-r,(0,o.uR)(0),(0,o.uR)(360),!1),t.stroke(),i&&(t.moveTo(3*r,.3*s),t.lineTo(s-3*r,.3*s),t.stroke(),t.moveTo(3*r,.7*s),t.lineTo(s-3*r,.7*s),t.stroke()),t.beginPath(),t.moveTo(r,s/2),t.lineTo(s-r,s/2),t.stroke(),t.beginPath(),t.moveTo(s/2,r/2),t.arcTo(0,s/2,s/2,s,.75*s),t.stroke(),t.beginPath(),t.moveTo(s/2,r/2),t.arcTo(s,s/2,s/2,s,.75*s),t.stroke()},s.prototype.renderSymbolList=function(t,e){var o,i=this.symbolWidth(),s=this.size,r=s/10,n=s/5;for(t.fillStyle=e.toString(),t.beginPath(),t.rect(0,0,i,s),o=0;o<4;o+=1)t.rect(r,(r+n)*o+r,i-n,n);t.clip("evenodd"),t.fillRect(0,0,i,s)},s.prototype.renderSymbolFlipHorizontal=function(t,e){var o=this.symbolWidth(),i=this.size,s=o/2,r=o/15;t.strokeStyle=e.toString(),t.lineWidth=o/15,t.beginPath(),t.moveTo(0+r,i-r/2),t.lineTo(s-1.2*r,i-r/2),t.lineTo(s-1.2*r,2*r),t.closePath(),t.stroke(),t.fillStyle=e.toString(),t.lineWidth=o/15,t.beginPath(),t.moveTo(o-r,i-r/2),t.lineTo(s+1.2*r,i-r/2),t.lineTo(s+1.2*r,2*r),t.closePath(),t.stroke(),t.fill()},s.prototype.renderSymbolFlipVertical=function(t,e){t.translate(0,this.size),t.rotate((0,o.uR)(-90)),this.renderSymbolFlipHorizontal(t,e)},o.qz.threads="2020-November-20";const r=[!0,!1,""];function n(){this.processes=[],this.wantsToPause=!1}function a(t,e,o,i){this.topBlock=t||null,this.receiver=e,this.instrument=e?e.instrument:null,this.readyToYield=!1,this.readyToTerminate=!1,this.isDead=!1,this.isClicked=!1,this.isShowingResult=!1,this.errorFlag=!1,this.context=null,this.homeContext=new h(null,null,null,e),this.lastYield=Date.now(),this.isFirstStep=!0,this.isAtomic=!1,this.prompter=null,this.httpRequest=null,this.isPaused=!1,this.pauseOffset=null,this.frameCount=0,this.exportResult=!1,this.onComplete=o||null,this.procedureCount=0,this.flashingContext=null,this.isInterrupted=!1,this.canBroadcast=!0,t&&(this.homeContext.variables.parentFrame=this.homeContext.receiver.variables,this.context=new h(null,t.blockSequence(),this.homeContext),i&&this.pushContext("doYield"))}function h(t,e,o,i){this.outerContext=o||null,this.parentContext=t||null,this.expression=e||null,this.receiver=i||null,this.origin=i||null,this.variables=new p,this.outerContext&&(this.variables.parentFrame=this.outerContext.variables,this.receiver=this.outerContext.receiver),this.inputs=[],this.pc=0,this.isContinuation=!1,this.startTime=null,this.activeSends=null,this.activeAudio=null,this.activeNote=null,this.isCustomBlock=!1,this.isCustomCommand=null,this.emptySlots=0,this.tag=null,this.isFlashing=!1,this.accumulator=null}function l(t,e){this.value=t,this.isTransient=e||!1}function p(t,e){this.vars={},this.parentFrame=t||null,this.owner=e||null}function c(t){this.process=t,this.source=null,this.gensyms=null,this.implicitParams=null,this.paramCount=null}function d(t){this.type=null,this.contents=t||[],this.first=null,this.rest=null,this.isLinked=!1,this.lastChanged=Date.now()}function u(t,e){this.init(t,e)}function f(t){this.tileServers={OpenStreetMap:{url:"tile.openstreetmap.org",type:"zxy",subdomains:["a","b","c"],key:null,min:0,max:19,credits:"Map data © OpenStreetMap contributorsCC-BY-SA, Imagery © Mapnik"},Wikimedia:{url:"maps.wikimedia.org/osm-intl",type:"zxy",subdomains:null,key:null,min:0,max:19,credits:"Map data © OpenStreetMap contributors, CC-BY-SA, Imagery © Wikimedia"},Watercolor:{url:"stamen-tiles.a.ssl.fastly.net/watercolor",type:"zxy",subdomains:null,key:null,min:0,max:20,credits:"Map data © OpenStreetMap contributors, CC-BY-SA, Imagery © Stamen, CC-BY-3.0."},Toner:{url:"stamen-tiles.a.ssl.fastly.net/toner",type:"zxy",subdomains:null,key:null,min:0,max:20,credits:"Map data © OpenStreetMap contributors, CC-BY-SA, Imagery © Stamen, CC-BY-3.0."},Terrain:{url:"stamen-tiles.a.ssl.fastly.net/terrain",type:"zxy",subdomains:null,key:null,min:0,max:16,credits:"Map data © OpenStreetMap contributors, CC-BY-SA, Imagery © Stamen, CC-BY-3.0."},Topographic:{url:"tile.opentopomap.org",type:"zxy",subdomains:null,key:null,min:0,max:17,credits:"Map data © OpenStreetMap contributors, CC-BY-SA, Imagery © Opentopomaps"},Satellite:{url:"services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile",type:"zyx",subdomains:null,key:null,min:0,max:19,credits:"Imagery © ArcGIS"},Streets:{url:"services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile",type:"zyx",subdomains:null,key:null,min:0,max:19,credits:"Imagery © ArcGIS"},Shading:{url:"services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile",type:"zyx",subdomains:null,key:null,min:0,max:19,credits:"Imagery © ArcGIS"},"Mapbox (experimental)":{url:"api.tiles.mapbox.com/v4/mapbox.streets",type:"zxy",subdomains:null,key:"?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw",min:0,max:20,credits:"Map data © OpenStreetMap contributors, CC-BY-SA, Imagery © Mapbox"}},this.api=this.tileServers[t||"Wikimedia"],this.lon=-122.257852,this.lat=37.872099,this.zoom=13,this.position=new o.E9(this.tileXfromLon(this.lon),this.tileYfromLat(this.lat)),this.extent=new o.E9(480,360),this.tileSize=256,this.canvas=null,this.creditsTxt=null,this.creditsBG=null,this.initializeCredits(),this.loading=0}function g(t){return t instanceof y||t instanceof b}function y(t){this.init(t)}function m(){this.init()}function b(t){this.init(t)}function w(t,e,o,i){this.init(t,e,o,i)}function C(t,e,i,s){this.contents=t?(0,o.bl)(t,!0):(0,o.oM)(null,!0),s||this.shrinkToFit(this.maxExtent()),this.name=e||null,this.rotationCenter=i||this.center(),this.version=Date.now(),this.loaded=null}function S(t,e,o){this.contents=t,this.shapes=[],this.shrinkToFit(this.maxExtent()),this.name=e||null,this.rotationCenter=o||this.center(),this.version=Date.now(),this.loaded=null}function v(t){this.init(t)}function x(t,e){this.audio=t,this.name=e||"Sound",this.cachedSamples=null,this.audioBuffer=null,this.isDecoding=!1,this.loaded=null}function k(t){this.pitch=0===t?0:t||69,this.frequency=null,this.setupContext(),this.oscillator=null,this.fader=null,this.ended=!1}function M(){this.audioContext=null,this.sourceStream=null,this.processor=null,this.analyser=null,this.resolution=2,this.GOOD_ENOUGH_CORRELATION=.96,this.modifier=null,this.compiledModifier=null,this.compilerProcess=null,this.correlations=[],this.wrapper=new d([0]),this.outChannels=[],this.volume=0,this.signals=[],this.output=[],this.frequencies=[],this.pitch=-1,this.isStarted=!1,this.isReady=!1,this.isAutoStop="file:"!==location.protocol,this.lastTime=Date.now()}function T(t,e,o,i){this.init(t,e,o,i)}function B(t,e,o,i,s){this.init(t,e,o,i,s)}function P(t){this.init(t)}function I(){this.init()}function E(t,e,o,i,s,r,n,a,h,l){this.init(t,e,o,i,s,r,n,a,h,l)}function L(t,e,o,i,s){this.init(t,e,o,i,s)}function A(){this.init()}function R(){this.init()}function F(){this.init()}function D(t){this.init(t)}function O(){this.init()}function N(){this.init()}function j(t){this.init(t)}function V(){this.init()}function W(){this.init()}function z(){this.init()}function H(t,e,o,i){this.init(t,e,o,i)}function U(t,e,o,i,s,r,n,a,h,l){this.init(t,e,o,i,s,r,n,a,h,l)}function _(t,e,o,i,s,r,n,a,h,l){this.init(t,e,o,i,s,r,n,a,h,l)}function G(t){this.init(t)}function q(t){this.init(t)}function Y(t,e,o,i,s){this.init(t,e,o,i,s)}function K(t,e,o,i){this.init(t,e,o,i)}function X(t){this.init(t)}function J(){this.threadCount=0,this.init()}function Z(t,e,o,i,s,r,n,a,h){this.init(t,e,o,i,s,r,n,a,h)}function $(t,e){this.init(t,e)}function Q(t){this.init(t)}function tt(t){this.init(t)}function et(t){this.init(t)}function ot(t){this.init(t)}function it(t,e,o){this.init(t,e,o)}function st(t,e,o,i,s){this.init(t,e,o,i,s)}function rt(t,e,o,i,s,r,n,a,h,l){this.init(t,e,o,i,s,r,n,a,h,l)}function nt(t,e,o,i,s,r,n){this.init(t,e,o,i,s,r,n)}function at(t,e,o,i,s,r,n,a,h){this.init(t,e,o,i,s,r,n,a,h)}function ht(t,e,o,i,s,r,n,a){this.init(t,e,o,i,s,r,n,a)}function lt(t,e,o){this.init(t,e,o)}function pt(t,e){this.init(t,e)}function ct(t,e,o,i){this.init(t,e,o,i)}function dt(t,e,o,i){this.init(t,e,o,i)}function ut(t,e,o,i,s,r,n,a,h,l,p,c){this.init(t,e,o,i,s,r,n,a,h,l,p,c),this.feedback=c}function ft(t,e){this.body=null,this.scripts=[],this.category=null,this.isGlobal=!1,this.type="command",this.spec=t||"",this.declarations=new Map,this.variableNames=[],this.comment=null,this.codeMapping=null,this.codeHeader=null,this.translations={},this.receiver=e||null,this.editorDimensions=null,this.cachedIsRecursive=null,this.cachedTranslation=null,this.storedSemanticSpec=null,this.guid="snap-module",this.isImported=!1}function gt(t,e){this.init(t,e)}function yt(t,e,o){this.init(t,e,o)}function mt(t){this.init(t)}function bt(t,e,o){this.init(t,e,o)}function wt(t){this.init(t)}function Ct(t){this.labelString=t||"",this.type="%s",this.defaultValue="",this.options="",this.isReadOnly=!1,this.isDeleted=!1}function St(t){this.init(t)}function vt(){this.init()}function xt(t){this.init(t)}function kt(t,e,o,i,s){this.init(t,e,o,i,s)}function Mt(t,e,o){this.init(t,e,o)}function Tt(t,e){this.init(t,e)}function Bt(t,e,o){this.init(t,e,o)}function Pt(t,e){this.init(t,e)}function It(t,e){this.colCount=+t,this.rowCount=+e,this.colNames=[],this.rowNames=[],this.contents=new Array(+e);for(var o=0;o<e;o+=1)this.contents[o]=new Array(+t);this.lastChanged=Date.now()}function Et(t,e,o){this.init(t,e,o)}function Lt(t,e,o,i,s,r,n,a,h,l){this.init(t,e,o,i,s,r,n,a,h,l)}function At(t,e){this.init(t,e)}function Rt(t,e,o,i){this.init(t,e,o,i)}!function(){for(var t=9;t<=13;t+=1)r.push(String.fromCharCode(t));r.push(String.fromCharCode(160))}(),a.prototype={},a.prototype.constructor=a,a.prototype.timeout=500,a.prototype.isCatchingErrors=!0,a.prototype.enableHyperOps=!0,a.prototype.enableLiveCoding=!1,a.prototype.enableSingleStepping=!1,a.prototype.enableCompiling=!1,a.prototype.flashTime=0,l.prototype.toString=function(){return"a "+(this.isTransient?"transient ":"")+"Variable ["+this.value+"]"},l.prototype.copy=function(){return new l(this.value,this.isTransient)},c.prototype.toString=function(){return"a JSCompiler"},c.prototype.compileFunction=function(t,e){var i,s,r=t.expression,n=t.inputs,a=[];if(this.source=t,this.implicitParams=e||1,i=!(0,o.kK)((0,o.qY)(r.allChildren(),(t=>t.isEmptySlot&&t.isEmptySlot()))),this.gensyms={},this.paramCount=0,n.length){if(i)throw new Error("compiling does not yet support\nmixing explicit formal parameters\nwith empty input slots");n.forEach(((t,e)=>{var o="p"+e;a.push(o),this.gensyms[t]=o}))}else if(i)if(this.implicitParams>1)for(s=0;s<this.implicitParams;s+=1)a.push("p"+s);else a=["p0"];return r instanceof R?Function.apply(null,a.concat([this.compileSequence(r)])):Function.apply(null,a.concat(["return "+this.compileExpression(r)]))},c.prototype.compileExpression=function(t){var e,o,i,s=t.selector,r=t.inputs();switch(s){case"reportOr":return this.compileInfix("||",r);case"reportAnd":return this.compileInfix("&&",r);case"reportIfElse":return"("+this.compileInput(r[0])+" ? "+this.compileInput(r[1])+" : "+this.compileInput(r[2])+")";case"evaluateCustomBlock":throw new Error("compiling does not yet support\ncustom blocks");case"doSetVar":return"arguments[arguments.length - 1].setVarNamed("+this.compileInput(r[0])+","+this.compileInput(r[1])+")";case"doChangeVar":return"arguments[arguments.length - 1].incrementVarNamed("+this.compileInput(r[0])+","+this.compileInput(r[1])+")";case"doReport":return"return "+this.compileInput(r[0]);case"doIf":return"if ("+this.compileInput(r[0])+") {\n"+this.compileSequence(r[1].evaluate())+"}";case"doIfElse":return"if ("+this.compileInput(r[0])+") {\n"+this.compileSequence(r[1].evaluate())+"} else {\n"+this.compileSequence(r[2].evaluate())+"}";default:return o=(e=this.process[s]?this.process:this.source.receiver||this.process.receiver).constructor.name+".prototype",i=this.compileInputs(r),isSnapObject(e)?o+"."+s+".apply("+o+", ["+i+"])":"arguments[arguments.length - 1]."+s+".apply(arguments[arguments.length - 1], ["+i+"])"}},c.prototype.compileSequence=function(t){var e="";return t.blockSequence().forEach((t=>{e+=this.compileExpression(t),e+=";\n"})),e},c.prototype.compileInfix=function(t,e){return"("+this.compileInput(e[0])+" "+t+" "+this.compileInput(e[1])+")"},c.prototype.compileInputs=function(t){var e="";return t.forEach((t=>{e.length&&(e+=", "),e+=this.compileInput(t)})),e},c.prototype.compileInput=function(t){var e,i;if(t.isEmptySlot&&t.isEmptySlot()){if(this.implicitParams>1){if(this.paramCount<this.implicitParams)return this.paramCount+=1,"p"+(this.paramCount-1);throw new Error((0,o.NC)("expecting")+" "+this.implicitParams+" "+(0,o.NC)("input(s), but getting")+" "+this.paramCount)}return"p0"}if(t instanceof Z)return"new List(["+this.compileInputs(t.inputs())+"])";if(t instanceof $)return this.compileInput(t.argMorph());if(!(t instanceof j)){if(t instanceof A)return"reportGetVar"===t.selector?(0,o.r3)(this.source.inputs,t.blockSpec)?this.gensyms[t.blockSpec]:'arguments[arguments.length - 1].getVarNamed("'+t.blockSpec+'")':this.compileExpression(t);throw new Error("compiling does not yet support\ninput slots of type\n"+t.constructor.name)}switch(e=t.evaluate(),i=this.process.reportTypeOf(e)){case"number":case"Boolean":return""+e;case"text":return'"'+e+'"';case"list":return"new List(["+this.compileInputs(e)+"])";default:if(e instanceof Array)return'"'+e[0]+'"';throw new Error("compiling does not yet support\ninputs of type\n"+i)}},o.qz.lists="2020-July-01",d.prototype.enableTables=!0,d.prototype.toString=function(){return"a List ["+this.length()+" elements]"},d.prototype.changed=function(){this.lastChanged=Date.now()},d.prototype.cons=function(t,e){var i=new d;if(!(e instanceof d||(0,o.kK)(e)))throw new Error("cdr isn't a list: "+e);return i.first=(0,o.kK)(t)?null:t,i.rest=e||null,i.isLinked=!0,i},d.prototype.cdr=function(){var t,e;if(this.isLinked)return this.rest||new d;if(this.contents.length<2)return new d;for(t=new d,e=this.contents.length;e>1;e-=1)t=this.cons(this.at(e),t);return t},d.prototype.add=function(t,e){var i=e||this.length()+1,s=(0,o.kK)(t)?null:t;this.becomeArray(),this.contents.splice(i-1,0,s),this.changed()},d.prototype.put=function(t,e){var o=0===t?0:!1!==t&&(t||null);this.becomeArray(),this.contents[e-1]=o,this.changed()},d.prototype.remove=function(t){this.becomeArray(),this.contents.splice(t-1,1),this.changed()},d.prototype.clear=function(){this.contents=[],this.first=null,this.rest=null,this.isLinked=!1,this.changed()},d.prototype.map=function(t){return new d(this.asArray().map(t))},d.prototype.length=function(){if(this.isLinked){for(var t=this,e=0;t&&t.isLinked;)e+=1,t=t.rest;return e+(t?t.contents.length:0)}return this.contents.length},d.prototype.at=function(t){for(var e,i=+t,s=this;s.isLinked;){if(!(i>1))return s.first;s=s.rest,i-=1}return e=s.contents[i-1],(0,o.kK)(e)?"":e},d.prototype.contains=function(t){for(var e=this;e.isLinked;){if(snapEquals(e.first,t))return!0;e=e.rest}return e.contents.some((e=>snapEquals(e,t)))},d.prototype.isEmpty=function(){return this.isLinked?(0,o.kK)(this.first):!this.contents.length},d.prototype.indexOf=function(t){for(var e,o,i=this,s=1;i.isLinked;){if(snapEquals(i.first,t))return s;i=i.rest,s+=1}for(o=i.contents.length,e=0;e<o;e+=1)if(snapEquals(i.contents[e],t))return s+e;return 0},d.prototype.isTable=function(){return this.enableTables&&(this.length()>100||this.cols()>1)},d.prototype.get=function(t,e){var i,s,r;return t?e?(i=this.at(e))instanceof d?(s=i.length(),r=this.cols(),t>s?null:1===r&&s>1?[i]:t>=r&&s>r?new Variable(i.at(t)):i.at(t)):1===t&&e<=this.rows()?[i]:null:1===this.cols()?(0,o.NC)("items"):this.colName(t):e?e>this.rows()?null:this.rowName(e):[this.length()]},d.prototype.rows=function(){return this.length()},d.prototype.cols=function(){var t,e,o=Math.min(10,this.length()),i=1;for(e=1;e<=o;e+=1)(t=this.at(e))instanceof d&&(i=Math.max(i,t.length()));return i},d.prototype.colName=function(t){return t>this.cols()?null:String.fromCharCode(64+(t%26||26)).repeat(Math.floor((t-1)/26)+1)},d.prototype.rowName=function(t){return t},d.prototype.columnNames=function(){return[]},d.prototype.version=function(t,e,o,i){var s,r,n=Math.min(t+e,this.length()),a=this.lastChanged;for(r=t;r<=n;r+=1)a=(s=this.at(r))instanceof C?Math.max(a,s.version):s instanceof d?Math.max(a,s.version(o,i)):Math.max(a,s.lastChanged?s.lastChanged:0);return a},d.prototype.asArray=function(){return this.becomeArray(),this.contents},d.prototype.itemsArray=function(){if(this.isLinked){for(var t,e=this,o=[];e&&e.isLinked;)o.push(e.first),e=e.rest;if(e)for(t=1;t<=e.contents.length;t+=1)o.push(e.at(t));return o}return this.contents},d.prototype.asText=function(){for(var t,e,i,s="",r=this;r.isLinked;)(e=r.first)instanceof d?s=s.concat(e.asText()):(e=(0,o.kK)(e)?"":e.toString(),s=s.concat(e)),r=r.rest;for(t=r.length(),i=1;i<=t;i+=1)(e=r.at(i))instanceof d?s=s.concat(e.asText()):(e=(0,o.kK)(e)?"":e.toString(),s=s.concat(e));return s},d.prototype.becomeArray=function(){this.isLinked&&(this.contents=this.itemsArray(),this.isLinked=!1,this.first=null,this.rest=null)},d.prototype.becomeLinked=function(){var t,e,o=this;if(!this.isLinked){for(e=this.length(),t=0;t<e;t+=1)o.first=this.contents[t],t<e&&(o.rest=new d,o.isLinked=!0,o=o.rest);this.contents=[],this.isLinked=!0}},d.prototype.asCSV=function(){var t=this.itemsArray(),e=[];function i(t){var e,i=(0,o.kK)(t)?"":t.toString();return-1===i.indexOf('"')&&-1===i.indexOf("\n")&&-1===i.indexOf(",")?i:(e=['"'],i.split("").forEach((t=>{e.push(t),'"'===t&&e.push(t)})),e.push('"'),e.join(""))}return t.some((t=>t instanceof d))?(t.forEach((t=>{t instanceof d?e.push(t.itemsArray().map(i).join(",")):e.push(i(t))})),e.join("\n")):t.map(i).join(",")},d.prototype.asJSON=function(t){return JSON.stringify(function t(e,i){var s=e.itemsArray(),r={};return function(t){var e;if(t.every((t=>t instanceof d&&t.length()<3)))return(e=t.map((t=>t.at(1)))).every((t=>(0,o.HD)(t)&&function(t,e){return e.indexOf(t)===e.lastIndexOf(t)}(t,e)))}(s)?(s.forEach((e=>{var o=2===e.length()?e.at(2):void 0;r[e.at(1)]=o instanceof d?t(o,i):o})),r):s.map((e=>e instanceof d?t(e,i):e))}(this,t))},d.prototype.equalTo=function(t){var e,o,i,s=this,r=t;if(!(t instanceof d))return!1;for(;s.isLinked&&r.isLinked;){if(!snapEquals(s.first,r.first))return!1;s=s.rest,r=r.rest}for(r.isLinked&&(e=r,r=s,s=e),o=0;s.isLinked;){if(!snapEquals(s.first,r.contents[o]))return!1;s=s.rest,o+=1}if(e=0,s.contents.length!==r.contents.length-o)return!1;for(i=s.contents.length;i>0;){if(i-=1,!snapEquals(s.contents[e],r.contents[o]))return!1;e+=1,o+=1}return!0},d.prototype.canBeCSV=function(){return this.itemsArray().every((t=>!isNaN(+t)&&"boolean"!=typeof t||(0,o.HD)(t)||t instanceof d&&t.hasOnlyAtomicData()))},d.prototype.canBeJSON=function(){return this.itemsArray().every((t=>!isNaN(+t)||(0,o.HD)(t)||!0===t||!1===t||t instanceof d&&t.canBeJSON()))},d.prototype.hasOnlyAtomicData=function(){return this.itemsArray().every((t=>!isNaN(+t)&&"boolean"!=typeof t||(0,o.HD)(t)))},d.prototype.blockify=function(t=500,e=[0]){var o,i,s,r=y.prototype.blockForSelector("reportNewList"),n=r.inputs()[0],a=this.length();for(r.isDraggable=!0,n.removeInput(),i=0;i<a&&e[0]<t;i+=1)(s=this.at(i+1))instanceof d?n.replaceInput(n.addInput(),s.blockify(t,e)):"boolean"==typeof s?((o=y.prototype.blockForSelector("reportBoolean")).inputs()[0].setContents(s),o.isDraggable=!0,n.replaceInput(n.addInput(),o)):n.addInput(s),e[0]+=1;return n.fixBlockColor(null,!0),r},u.prototype=new o.RC,u.prototype.constructor=u,u.uber=o.RC.prototype,u.prototype.cellColor=new o.Il(217,77,17),u.prototype.init=function(t,e){var i,s=this;this.list=t||new d,this.start=1,this.range=100,this.lastUpdated=0,this.lastCell=null,this.parentCell=e||null,this.label=new o.XC((0,o.NC)("length: ")+this.list.length(),I.prototype.fontSize,null,!1,!1,!1,o.tU.isFlat?o.xE:new o.E9(1,1),o.Cj),this.label.mouseClickLeft=function(){s.startIndexMenu()},this.frame=new o.yR(null,10),this.frame.alpha=0,this.frame.acceptsDrops=!1,this.frame.contents.acceptsDrops=!1,this.handle=new o.LG(this,80,70,3,3),this.handle.setExtent(new o.E9(13,13)),this.arrow=new ArrowMorph("down",I.prototype.fontSize),this.arrow.mouseClickLeft=function(){s.startIndexMenu()},this.arrow.setRight(this.handle.right()),this.arrow.setBottom(this.handle.top()),this.handle.add(this.arrow),(i=this.list.type&&!(0,o.r3)(["text","number"],this.list.type))?this.plusButton=null:(this.plusButton=new st(this.list,"add","+"),this.plusButton.padding=0,this.plusButton.edge=0,this.plusButton.outlineColor=this.color,this.plusButton.fixLayout()),u.uber.init.call(this,I.prototype.rounding,1,new o.Il(120,120,120)),this.color=new o.Il(220,220,220),this.isDraggable=!1,this.setExtent(new o.E9(80,70).multiplyBy(I.prototype.scale)),this.add(this.label),this.add(this.frame),i||this.add(this.plusButton),this.add(this.handle),this.handle.fixLayout(),this.update(),this.fixLayout()},u.prototype.update=function(t){var e,i,s,r,n,a,h,l,p,c;if(this.frame.contents.children.forEach((t=>{t instanceof CellMorph&&(t.contentsMorph instanceof u?t.contentsMorph.update():(g(t.contents)||t.contents instanceof C)&&t.update())})),this.lastUpdated===this.list.lastChanged&&!t)return null;for(this.updateLength(!0),this.start=Math.max(Math.min(this.start,Math.floor((this.list.length()-1)/this.range)*this.range+1),1),p=Math.min(this.start+this.range-1,this.list.length()),s=Math.min(3*(p-this.start+1),this.frame.contents.children.length),e=0;e<s;e+=3)i=this.start+e/3,n=this.frame.contents.children[e],h=this.frame.contents.children[e+1],l=this.frame.contents.children[e+2],a=this.list.at(i),n.contents!==a&&(n.contents=a,n.fixLayout(),this.lastCell&&n.setLeft(this.lastCell.left())),this.lastCell=n,h.text!==i.toString()&&(h.text=i.toString(),h.fixLayout()),l.action=i;for(r=3*(p-this.start+1);this.frame.contents.children.length>r;)this.frame.contents.children[r].destroy();if(s=r,e=this.frame.contents.children.length,c=Date.now(),s>e+1)for(;e<s;e+=3){if(Date.now()-c>1e3)return this.fixLayout(),this.frame.contents.adjustBounds(),this.frame.contents.setLeft(this.frame.left()),null;i=this.start+e/3,h=new o.XC(i.toString(),I.prototype.fontSize,null,!1,!1,!1,o.tU.isFlat?o.xE:new o.E9(1,1),o.Cj),n=new CellMorph(this.list.at(i),this.cellColor,i,this.parentCell),(l=new st(this.list.remove,i,"-",this.list)).padding=1,l.edge=0,l.corner=1,l.outlineColor=this.color.darker(),l.fixLayout(),this.frame.contents.add(n),this.lastCell?n.setPosition(this.lastCell.bottomLeft()):n.setTop(this.frame.contents.top()),this.lastCell=n,h.setCenter(n.center()),h.setRight(n.left()-2),this.frame.contents.add(h),this.frame.contents.add(l)}this.lastCell=null,this.fixLayout(),this.frame.contents.adjustBounds(),this.frame.contents.setLeft(this.frame.left()),this.updateLength(),this.lastUpdated=this.list.lastChanged},u.prototype.updateLength=function(t){this.label.text=(0,o.NC)("length: ")+this.list.length(),this.label.color=t?new o.Il(0,0,100):new o.Il(0,0,0),this.label.fixLayout(),this.label.setCenter(this.center()),this.label.setBottom(this.bottom()-3)},u.prototype.startIndexMenu=function(){var t,e,i=Math.ceil(this.list.length()/this.range),s=new o.wR((t=>this.setStartIndex(t)),null,this);for(s.addItem("1...",1),t=1;t<i;t+=1)e=100*t+1,s.addItem(e+"...",e);s.popUpAtHand(this.world())},u.prototype.setStartIndex=function(t){this.start=t,this.list.changed(),this.update()},u.prototype.fixLayout=function(){this.label&&(this.frame&&(this.arrangeCells(),this.frame.setPosition(this.position().add(3)),this.frame.bounds.corner=this.bounds.corner.subtract(new o.E9(3,17)),this.frame.fixLayout(),this.frame.contents.adjustBounds()),this.label.setCenter(this.center()),this.label.setBottom(this.bottom()-3),this.plusButton&&(this.plusButton.setLeft(this.left()+3),this.plusButton.setBottom(this.bottom()-3)),this.parent&&(this.parent.changed(),this.parent.fixLayout(),this.parent.rerender()))},u.prototype.arrangeCells=function(){var t,e,o,i,s,r=this.frame.contents.children.length;for(t=0;t<r;t+=3)e=this.frame.contents.children[t],o=this.frame.contents.children[t+1],i=this.frame.contents.children[t+2],s&&e.setTop(s.bottom()),o&&(o.setTop(e.center().y-o.height()/2),o.setRight(e.left()-2)),i&&(i.setCenter(e.center()),i.setLeft(e.right()+2)),s=e;this.frame.contents.adjustBounds()},u.prototype.expand=function(t){var e=this.frame.contents.extent(),i=new o.E9(e.x+6,e.y+this.label.height()+6);t&&(i=i.min(t)),this.setExtent(i),this.handle.setRight(this.right()-3),this.handle.setBottom(this.bottom()-3)},u.prototype.userMenu=function(){if(!d.prototype.enableTables)return this.escalateEvent("userMenu");var t=new o.wR(this);return t.addItem("table view...","showTableView"),this.list.canBeJSON()&&t.addItem("blockify",(()=>{var t=this.world(),e=(0,o.qY)(t.children,(t=>t instanceof IDE_Morph));this.list.blockify().pickUp(t),t.hand.grabOrigin={origin:e.palette,position:e.palette.center()}})),t.addLine(),t.addItem("open in dialog...",(()=>new TableDialogMorph(this.list).popUp(this.world()))),t},u.prototype.showTableView=function(){var t=this.parentThatIsA(w,o.KE,CellMorph);t&&(t instanceof w?(t.contentsMorph.destroy(),t.contentsMorph=new TableFrameMorph(new TableMorph(this.list,10)),t.contentsMorph.expand(this.extent()),t.parent.positionTalkBubble()):t instanceof o.KE?(t.contents=new TableFrameMorph(new TableMorph(this.list,10)),t.contents.expand(this.extent())):(t.changed(),t.contentsMorph.destroy(),t.contentsMorph=new TableFrameMorph(new TableMorph(this.list,10)),t.add(t.contentsMorph),t.contentsMorph.setPosition(this.position()),t.contentsMorph.expand(this.extent())),t.fixLayout(),t.rerender())},u.prototype.mouseDoubleClick=function(t){d.prototype.enableTables?new TableDialogMorph(this.list).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},u.prototype.show=function(){u.uber.show.call(this),this.frame.contents.adjustBounds()},u.prototype.render=B.prototype.render,o.qz.maps="2020-March-25",f.prototype.setHost=function(t){this.api=this.tileServers[t||"Wikimedia"],this.initializeCredits(),this.setZoom(this.zoom)},f.prototype.setView=function(t,e){this.lat=e,this.lon=t,this.refresh()},f.prototype.setZoom=function(t){this.zoom=Math.max(Math.min(this.api.max,Math.floor(t)),this.api.min),this.refresh()},f.prototype.panBy=function(t,e){this.lon=this.lonFromTileX(this.position.x+t/this.tileSize),this.lat=this.latFromTileY(this.position.y+e/this.tileSize),this.refresh()},f.prototype.refresh=function(){this.position=new o.E9(this.wrapTile(this.tileXfromLon(this.lon)),this.tileYfromLat(this.lat))},f.prototype.wrapTile=function(t){var e=Math.pow(2,this.zoom);return t<0?e+t:t%e},f.prototype.tileXfromLon=function(t){return(parseFloat(t)+180)/360*Math.pow(2,this.zoom)},f.prototype.tileYfromLat=function(t){return(1-Math.log(Math.tan(parseFloat(t)*Math.PI/180)+1/Math.cos(parseFloat(t)*Math.PI/180))/Math.PI)/2*Math.pow(2,this.zoom)},f.prototype.lonFromTileX=function(t){return t/Math.pow(2,this.zoom)*360-180},f.prototype.latFromTileY=function(t){var e=Math.PI-2*Math.PI*t/Math.pow(2,this.zoom);return 180/Math.PI*Math.atan(.5*(Math.exp(e)-Math.exp(-e)))},f.prototype.lonFromSnapX=function(t){return this.lonFromTileX(this.position.x+t/this.tileSize)},f.prototype.latFromSnapY=function(t){return this.latFromTileY(this.position.y-t/this.tileSize)},f.prototype.snapXfromLon=function(t){return(this.tileXfromLon(t)-this.position.x)*this.tileSize},f.prototype.snapYfromLat=function(t){return(this.tileYfromLat(t)-this.position.y)*-this.tileSize},f.prototype.distanceInKm=function(t,e,i,s){var r=(0,o.uR)(+i-t),n=(0,o.uR)(+s-e),a=Math.sin(r/2)*Math.sin(r/2)+Math.cos((0,o.uR)(+t))*Math.cos((0,o.uR)(+i))*Math.sin(n/2)*Math.sin(n/2);return 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))*6371},f.prototype.render=function(){var t,e,i,s,r,n,a,h=this.extent.divideBy(2),l=this.tileSize,p=this.position.floor(),c=new o.E9(this.position.x%1,this.position.y%1).multiplyBy(l),d=h.subtract(c),u=d.floorDivideBy(l).add(1),f=this.extent.floorDivideBy(l).add(2),g=p.subtract(u),y=d.subtract(u.multiplyBy(l)),m=0,b=this,w=Math.pow(2,this.zoom);function C(){b.loading-=1,s.drawImage(this,y.x+this.cx*l,y.y+this.cy*l),v()}function S(){b.loading-=1,v()}function v(){b.loading||b.addCredits()}for(this.canvas=(0,o.oM)(this.extent,!0),s=this.canvas.getContext("2d"),t=0;t<f.x;t+=1)for(e=0;e<f.y;e+=1)if(r=this.wrapTile(g.x+t),n=g.y+e,r>=0&&r<w&&n>=0&&n<w){switch((i=new Image).cx=t,i.cy=e,i.crossOrigin="",i.onload=C,i.onerror=S,b.loading+=1,this.api.type){case"zxy":a=this.zoom+"/"+r+"/"+n;break;case"zyx":a=this.zoom+"/"+n+"/"+r;break;case"xyz":a=r+"/"+n+"/"+this.zoom}i.src="https://"+(this.api.subdomains?this.api.subdomains[m]+".":"")+this.api.url+"/"+a+".png"+(this.api.key||""),this.api.subdomains&&(m+=1)===this.api.subdomains.length&&(m=0)}},f.prototype.initializeCredits=function(){var t;this.creditsTxt=new o.XC(" "+this.api.credits+" ",8),this.creditsTxt.isCachingImage=!0,this.creditsTxt.cachedImage=(0,o.bl)(this.creditsTxt.getImage(),!0),this.creditsBG=(0,o.oM)(this.creditsTxt.extent(),!0),(t=this.creditsBG.getContext("2d")).fillStyle="white",t.fillRect(0,0,this.creditsBG.width,this.creditsBG.height)},f.prototype.addCredits=function(){var t=this.canvas.getContext("2d"),e=this.creditsTxt.getImage();t.globalAlpha=.5,t.drawImage(this.creditsBG,this.canvas.width-e.width,this.canvas.height-e.height),t.globalAlpha=1,t.drawImage(e,this.canvas.width-e.width,this.canvas.height-e.height)},o.qz.objects="2020-November-20",y.prototype=new o.I_,y.prototype.constructor=y,y.uber=o.I_.prototype,y.prototype.attributes=["x position","y position","direction","size","costumes","costume #","volume","balance","sounds","shown?","pen down?","scripts"],y.prototype.categories=["motion","control","looks","sensing","sound","operators","pen","variables","lists","other"],y.prototype.blockColor={motion:new o.Il(74,108,212),looks:new o.Il(143,86,227),sound:new o.Il(207,74,217),pen:new o.Il(0,161,120),control:new o.Il(230,168,34),sensing:new o.Il(4,148,220),operators:new o.Il(98,194,19),variables:new o.Il(243,118,29),lists:new o.Il(217,77,17),other:new o.Il(150,150,150)},y.prototype.paletteColor=new o.Il(55,55,55),y.prototype.paletteTextColor=new o.Il(230,230,230),y.prototype.sliderColor=y.prototype.paletteColor.lighter(30),y.prototype.isCachingPrimitives=!0,y.prototype.enableNesting=!0,y.prototype.enableFirstClass=!0,y.prototype.useFlatLineEnds=!1,y.prototype.highlightColor=new o.Il(250,200,130),y.prototype.highlightBorder=8,y.prototype.bubbleColor=o.Cj,y.prototype.bubbleFontSize=14,y.prototype.bubbleFontIsBold=!0,y.prototype.bubbleCorner=10,y.prototype.bubbleBorder=3,y.prototype.bubbleBorderColor=new o.Il(190,190,190),y.prototype.bubbleMaxTextWidth=130,y.prototype.initBlocks=function(){y.prototype.blocks={forward:{only:y,type:"command",category:"motion",spec:"move %n steps",defaults:[10]},turn:{only:y,type:"command",category:"motion",spec:"turn %clockwise %n degrees",defaults:[15]},turnLeft:{only:y,type:"command",category:"motion",spec:"turn %counterclockwise %n degrees",defaults:[15]},setHeading:{only:y,type:"command",category:"motion",spec:"point in direction %dir",defaults:[90]},doFaceTowards:{only:y,type:"command",category:"motion",spec:"point towards %dst",defaults:[["mouse-pointer"]]},gotoXY:{only:y,type:"command",category:"motion",spec:"go to x: %n y: %n",defaults:[0,0]},doGotoObject:{only:y,type:"command",category:"motion",spec:"go to %dst",defaults:[["random position"]]},doGlide:{only:y,type:"command",category:"motion",spec:"glide %n secs to x: %n y: %n",defaults:[1,0,0]},changeXPosition:{only:y,type:"command",category:"motion",spec:"change x by %n",defaults:[10]},setXPosition:{only:y,type:"command",category:"motion",spec:"set x to %n",defaults:[0]},changeYPosition:{only:y,type:"command",category:"motion",spec:"change y by %n",defaults:[10]},setYPosition:{only:y,type:"command",category:"motion",spec:"set y to %n",defaults:[0]},bounceOffEdge:{only:y,type:"command",category:"motion",spec:"if on edge, bounce"},xPosition:{only:y,type:"reporter",category:"motion",spec:"x position"},yPosition:{only:y,type:"reporter",category:"motion",spec:"y position"},direction:{only:y,type:"reporter",category:"motion",spec:"direction"},doSwitchToCostume:{type:"command",category:"looks",spec:"switch to costume %cst"},doWearNextCostume:{type:"command",category:"looks",spec:"next costume"},getCostumeIdx:{type:"reporter",category:"looks",spec:"costume #"},reportGetImageAttribute:{type:"reporter",category:"looks",spec:"%img of costume %cst",defaults:[["width"],["current"]]},reportNewCostume:{type:"reporter",category:"looks",spec:"new costume %l width %dim height %dim"},reportNewCostumeStretched:{type:"reporter",category:"looks",spec:"stretch %cst x: %n y: %n %",defaults:[["current"],100,50]},doSayFor:{only:y,type:"command",category:"looks",spec:"say %s for %n secs",defaults:[(0,o.NC)("Hello!"),2]},bubble:{only:y,type:"command",category:"looks",spec:"say %s",defaults:[(0,o.NC)("Hello!")]},doThinkFor:{only:y,type:"command",category:"looks",spec:"think %s for %n secs",defaults:[(0,o.NC)("Hmm..."),2]},doThink:{only:y,type:"command",category:"looks",spec:"think %s",defaults:[(0,o.NC)("Hmm...")]},changeEffect:{type:"command",category:"looks",spec:"change %eff effect by %n",defaults:[["ghost"],25]},setEffect:{type:"command",category:"looks",spec:"set %eff effect to %n",defaults:[["ghost"],0]},getEffect:{type:"reporter",category:"looks",spec:"%eff effect",defaults:[["ghost"]]},clearEffects:{type:"command",category:"looks",spec:"clear graphic effects"},changeScale:{only:y,type:"command",category:"looks",spec:"change size by %n",defaults:[10]},setScale:{only:y,type:"command",category:"looks",spec:"set size to %n %",defaults:[100]},getScale:{only:y,type:"reporter",category:"looks",spec:"size"},show:{type:"command",category:"looks",spec:"show"},hide:{type:"command",category:"looks",spec:"hide"},reportShown:{type:"predicate",category:"looks",spec:"shown?"},goToLayer:{only:y,type:"command",category:"looks",spec:"go to %layer layer",defaults:[["front"]]},goBack:{only:y,type:"command",category:"looks",spec:"go back %n layers",defaults:[1]},doScreenshot:{dev:!0,type:"command",category:"looks",spec:"save %imgsource as costume named %s",defaults:[["pen trails"],(0,o.NC)("screenshot")]},reportCostumes:{dev:!0,type:"reporter",category:"looks",spec:"wardrobe"},alert:{dev:!0,type:"command",category:"looks",spec:"alert %mult%s"},log:{dev:!0,type:"command",category:"looks",spec:"console log %mult%s"},playSound:{type:"command",category:"sound",spec:"play sound %snd"},doPlaySoundUntilDone:{type:"command",category:"sound",spec:"play sound %snd until done"},doPlaySoundAtRate:{type:"command",category:"sound",spec:"play sound %snd at %rate Hz",defaults:["",44100]},doStopAllSounds:{type:"command",category:"sound",spec:"stop all sounds"},reportGetSoundAttribute:{type:"reporter",category:"sound",spec:"%aa of sound %snd",defaults:[["duration"]]},reportNewSoundFromSamples:{type:"reporter",category:"sound",spec:"new sound %l rate %rate Hz",defaults:[null,44100]},doRest:{type:"command",category:"sound",spec:"rest for %n beats",defaults:[.2]},doPlayNote:{type:"command",category:"sound",spec:"play note %note for %n beats",defaults:[60,.5]},doPlayFrequency:{dev:!0,type:"command",category:"sound",spec:"play %n Hz for %n secs",defaults:[440,2]},doSetInstrument:{type:"command",category:"sound",spec:"set instrument to %inst",defaults:[1]},doChangeTempo:{type:"command",category:"sound",spec:"change tempo by %n",defaults:[20]},doSetTempo:{type:"command",category:"sound",spec:"set tempo to %n bpm",defaults:[60]},getTempo:{type:"reporter",category:"sound",spec:"tempo"},changeVolume:{type:"command",category:"sound",spec:"change volume by %n",defaults:[10]},setVolume:{type:"command",category:"sound",spec:"set volume to %n %",defaults:[100]},getVolume:{type:"reporter",category:"sound",spec:"volume"},changePan:{type:"command",category:"sound",spec:"change balance by %n",defaults:[10]},setPan:{type:"command",category:"sound",spec:"set balance to %n",defaults:[0]},getPan:{type:"reporter",category:"sound",spec:"balance"},playFreq:{type:"command",category:"sound",spec:"play frequency %n Hz",defaults:[440]},stopFreq:{type:"command",category:"sound",spec:"stop frequency"},reportSounds:{dev:!0,type:"reporter",category:"sound",spec:"jukebox"},clear:{type:"command",category:"pen",spec:"clear"},down:{only:y,type:"command",category:"pen",spec:"pen down"},up:{only:y,type:"command",category:"pen",spec:"pen up"},getPenDown:{only:y,type:"predicate",category:"pen",spec:"pen down?"},setColor:{only:y,type:"command",category:"pen",spec:"set pen color to %clr"},setPenHSVA:{only:y,type:"command",category:"pen",spec:"set pen %hsva to %n",defaults:[["hue"],50]},changePenHSVA:{only:y,type:"command",category:"pen",spec:"change pen %hsva by %n",defaults:[["hue"],10]},getPenAttribute:{type:"reporter",category:"pen",spec:"pen %pen",defaults:[["hue"]]},setBackgroundColor:{only:b,type:"command",category:"pen",spec:"set background color to %clr"},setBackgroundHSVA:{only:b,type:"command",category:"pen",spec:"set background %hsva to %n",defaults:[["hue"],50]},changeBackgroundHSVA:{only:b,type:"command",category:"pen",spec:"change background %hsva by %n",defaults:[["hue"],10]},changeSize:{only:y,type:"command",category:"pen",spec:"change pen size by %n",defaults:[1]},setSize:{only:y,type:"command",category:"pen",spec:"set pen size to %n",defaults:[1]},doStamp:{only:y,type:"command",category:"pen",spec:"stamp"},floodFill:{only:y,type:"command",category:"pen",spec:"fill"},write:{only:y,type:"command",category:"pen",spec:"write %s size %n",defaults:[(0,o.NC)("Hello!"),12]},reportPenTrailsAsCostume:{type:"reporter",category:"pen",spec:"pen trails"},reportPentrailsAsSVG:{type:"reporter",category:"pen",spec:"pen vectors"},doPasteOn:{type:"command",category:"pen",spec:"paste on %spr"},doCutFrom:{type:"command",category:"pen",spec:"cut from %spr"},receiveGo:{type:"hat",category:"control",spec:"when %greenflag clicked"},receiveKey:{type:"hat",category:"control",spec:"when %keyHat key pressed",defaults:[["space"]]},receiveInteraction:{type:"hat",category:"control",spec:"when I am %interaction",defaults:["clicked"]},receiveMessage:{type:"hat",category:"control",spec:"when I receive %msgHat"},receiveCondition:{type:"hat",category:"control",spec:"when %b"},doBroadcast:{type:"command",category:"control",spec:"broadcast %msg"},doBroadcastAndWait:{type:"command",category:"control",spec:"broadcast %msg and wait"},getLastMessage:{type:"reporter",category:"control",spec:"message"},doSend:{type:"command",category:"control",spec:"send %msg to %spr"},doWait:{type:"command",category:"control",spec:"wait %n secs",defaults:[1]},doWaitUntil:{type:"command",category:"control",spec:"wait until %b"},doForever:{type:"command",category:"control",spec:"forever %loop"},doRepeat:{type:"command",category:"control",spec:"repeat %n %loop",defaults:[10]},doUntil:{type:"command",category:"control",spec:"repeat until %b %loop"},doFor:{type:"command",category:"control",spec:"for %upvar = %n to %n %cla",defaults:["i",1,10]},doIf:{type:"command",category:"control",spec:"if %b %c"},doIfElse:{type:"command",category:"control",spec:"if %b %c else %c"},reportIfElse:{type:"reporter",category:"control",spec:"if %b then %s else %s"},doStopThis:{type:"command",category:"control",spec:"stop %stopChoices",defaults:[["all"]]},doRun:{type:"command",category:"control",spec:"run %cmdRing %inputs"},fork:{type:"command",category:"control",spec:"launch %cmdRing %inputs"},evaluate:{type:"reporter",category:"control",spec:"call %repRing %inputs"},doReport:{type:"command",category:"control",spec:"report %s"},doCallCC:{type:"command",category:"control",spec:"run %cmdRing w/continuation"},reportCallCC:{type:"reporter",category:"control",spec:"call %cmdRing w/continuation"},doWarp:{type:"command",category:"other",spec:"warp %c"},doTellTo:{type:"command",category:"control",spec:"tell %spr to %cmdRing %inputs"},reportAskFor:{type:"reporter",category:"control",spec:"ask %spr for %repRing %inputs"},receiveOnClone:{type:"hat",category:"control",spec:"when I start as a clone"},createClone:{type:"command",category:"control",spec:"create a clone of %cln",defaults:[["myself"]]},newClone:{type:"reporter",category:"control",spec:"a new clone of %cln",defaults:[["myself"]]},removeClone:{type:"command",category:"control",spec:"delete this clone"},doPauseAll:{type:"command",category:"control",spec:"pause all %pause"},reportTouchingObject:{only:y,type:"predicate",category:"sensing",spec:"touching %col ?",defaults:[["mouse-pointer"]]},reportTouchingColor:{only:y,type:"predicate",category:"sensing",spec:"touching %clr ?"},reportColorIsTouchingColor:{only:y,type:"predicate",category:"sensing",spec:"color %clr is touching %clr ?"},reportAspect:{type:"reporter",category:"sensing",spec:"%asp at %loc",defaults:[["hue"],["mouse-pointer"]]},reportStackSize:{dev:!0,type:"reporter",category:"sensing",spec:"stack size"},reportFrameCount:{dev:!0,type:"reporter",category:"sensing",spec:"frames"},reportThreadCount:{dev:!0,type:"reporter",category:"sensing",spec:"processes"},doAsk:{type:"command",category:"sensing",spec:"ask %s and wait",defaults:[(0,o.NC)("what's your name?")]},reportLastAnswer:{dev:!0,type:"reporter",category:"sensing",spec:"answer"},getLastAnswer:{type:"reporter",category:"sensing",spec:"answer"},reportMouseX:{type:"reporter",category:"sensing",spec:"mouse x"},reportMouseY:{type:"reporter",category:"sensing",spec:"mouse y"},reportMouseDown:{type:"predicate",category:"sensing",spec:"mouse down?"},reportKeyPressed:{type:"predicate",category:"sensing",spec:"key %key pressed?",defaults:[["space"]]},reportRelationTo:{only:y,type:"reporter",category:"sensing",spec:"%rel to %dst",defaults:[["distance"],["mouse-pointer"]]},doResetTimer:{type:"command",category:"sensing",spec:"reset timer"},reportTimer:{dev:!0,type:"reporter",category:"sensing",spec:"timer"},getTimer:{type:"reporter",category:"sensing",spec:"timer"},reportAttributeOf:{type:"reporter",category:"sensing",spec:"%att of %spr",defaults:[["costume #"]]},reportObject:{type:"reporter",category:"sensing",spec:"object %self",defaults:[["myself"]]},reportURL:{type:"reporter",category:"sensing",spec:"url %s",defaults:["snap.berkeley.edu"]},doSetGlobalFlag:{type:"command",category:"sensing",spec:"set %setting to %b",defaults:[["video capture"]]},reportGlobalFlag:{type:"predicate",category:"sensing",spec:"is %setting on?",defaults:[["turbo mode"]]},reportDate:{type:"reporter",category:"sensing",spec:"current %dates",defaults:[["date"]]},reportGet:{type:"reporter",category:"sensing",spec:"my %get",defaults:[["neighbors"]]},reportAudio:{type:"reporter",category:"sensing",spec:"microphone %audio",defaults:[["volume"]]},reifyScript:{type:"ring",category:"other",spec:"%rc %ringparms",alias:"command ring lambda"},reifyReporter:{type:"ring",category:"other",spec:"%rr %ringparms",alias:"reporter ring lambda"},reifyPredicate:{type:"ring",category:"other",spec:"%rp %ringparms",alias:"predicate ring lambda"},reportSum:{type:"reporter",category:"operators",spec:"%n + %n"},reportDifference:{type:"reporter",category:"operators",spec:"%n − %n",alias:"-"},reportProduct:{type:"reporter",category:"operators",spec:"%n × %n",alias:"*"},reportQuotient:{type:"reporter",category:"operators",spec:"%n / %n"},reportRound:{type:"reporter",category:"operators",spec:"round %n"},reportMonadic:{type:"reporter",category:"operators",spec:"%fun of %n",defaults:[["sqrt"],10]},reportPower:{type:"reporter",category:"operators",spec:"%n ^ %n"},reportModulus:{type:"reporter",category:"operators",spec:"%n mod %n"},reportRandom:{type:"reporter",category:"operators",spec:"pick random %n to %n",defaults:[1,10]},reportLessThan:{type:"predicate",category:"operators",spec:"%s < %s"},reportEquals:{type:"predicate",category:"operators",spec:"%s = %s"},reportGreaterThan:{type:"predicate",category:"operators",spec:"%s > %s"},reportAnd:{type:"predicate",category:"operators",spec:"%b and %b"},reportOr:{type:"predicate",category:"operators",spec:"%b or %b"},reportNot:{type:"predicate",category:"operators",spec:"not %b"},reportBoolean:{type:"predicate",category:"operators",spec:"%bool",alias:"true boolean"},reportFalse:{type:"predicate",category:"operators",spec:"%bool",defaults:[!1],alias:"false boolean"},reportJoinWords:{type:"reporter",category:"operators",spec:"join %words",defaults:[(0,o.NC)("hello")+" ",(0,o.NC)("world")]},reportLetter:{type:"reporter",category:"operators",spec:"letter %idx of %s",defaults:[1,(0,o.NC)("world")]},reportStringSize:{type:"reporter",category:"operators",spec:"length of %s",defaults:[(0,o.NC)("world")]},reportUnicode:{type:"reporter",category:"operators",spec:"unicode of %s",defaults:["a"]},reportUnicodeAsLetter:{type:"reporter",category:"operators",spec:"unicode %n as letter",defaults:[65]},reportIsA:{type:"predicate",category:"operators",spec:"is %s a %typ ?",defaults:[5,["number"]]},reportIsIdentical:{type:"predicate",category:"operators",spec:"is %s identical to %s ?"},reportTextSplit:{type:"reporter",category:"operators",spec:"split %s by %delim",defaults:[(0,o.NC)("hello")+" "+(0,o.NC)("world")," "]},reportJSFunction:{type:"reporter",category:"operators",spec:"JavaScript function ( %mult%s ) { %code }"},reportTypeOf:{dev:!0,type:"reporter",category:"operators",spec:"type of %s",defaults:[5]},reportTextFunction:{dev:!0,type:"reporter",category:"operators",spec:"%txtfun of %s",defaults:[["encode URI"],"Abelson & Sussman"]},reportCompiled:{type:"reporter",category:"operators",spec:"compile %repRing for %n args",defaults:[null,0]},doSetVar:{type:"command",category:"variables",spec:"set %var to %s",defaults:[null,0]},doChangeVar:{type:"command",category:"variables",spec:"change %var by %n",defaults:[null,1]},doShowVar:{type:"command",category:"variables",spec:"show variable %var"},doHideVar:{type:"command",category:"variables",spec:"hide variable %var"},doDeclareVariables:{type:"command",category:"other",spec:"script variables %scriptVars"},doDeleteAttr:{type:"command",category:"variables",spec:"inherit %shd"},reportNewList:{type:"reporter",category:"lists",spec:"list %exp"},reportCONS:{type:"reporter",category:"lists",spec:"%s in front of %l"},reportListItem:{type:"reporter",category:"lists",spec:"item %idx of %l",defaults:[1]},reportCDR:{type:"reporter",category:"lists",spec:"all but first of %l"},reportListLength:{type:"reporter",category:"lists",spec:"length of %l"},reportListContainsItem:{type:"predicate",category:"lists",spec:"%l contains %s",defaults:[null,(0,o.NC)("thing")]},reportListIsEmpty:{type:"predicate",category:"lists",spec:"is %l empty?"},reportListIndex:{dev:!0,type:"reporter",category:"lists",spec:"index of %s in %l",defaults:[(0,o.NC)("thing")]},doAddToList:{type:"command",category:"lists",spec:"add %s to %l",defaults:[(0,o.NC)("thing")]},doDeleteFromList:{type:"command",category:"lists",spec:"delete %ida of %l",defaults:[1]},doInsertInList:{type:"command",category:"lists",spec:"insert %s at %idx of %l",defaults:[(0,o.NC)("thing"),1]},doReplaceInList:{type:"command",category:"lists",spec:"replace item %idx of %l with %s",defaults:[1,null,(0,o.NC)("thing")]},reportNumbers:{type:"reporter",category:"lists",spec:"numbers from %n to %n",defaults:[1,10]},reportConcatenatedLists:{type:"reporter",category:"lists",spec:"append %lists"},reportMap:{type:"reporter",category:"lists",spec:"map %repRing over %l"},reportAtomicMap:{dev:!0,type:"reporter",category:"lists",spec:"%blitz map %repRing over %l"},reportKeep:{type:"reporter",category:"lists",spec:"keep items %predRing from %l"},reportAtomicKeep:{dev:!0,type:"reporter",category:"lists",spec:"%blitz keep items %predRing from %l"},reportFindFirst:{type:"reporter",category:"lists",spec:"find first item %predRing in %l"},reportAtomicFindFirst:{dev:!0,type:"reporter",category:"lists",spec:"%blitz find first item %predRing in %l"},reportCombine:{type:"reporter",category:"lists",spec:"combine %l using %repRing"},reportAtomicCombine:{dev:!0,type:"reporter",category:"lists",spec:"%blitz combine %l using %repRing"},doForEach:{type:"command",category:"lists",spec:"for each %upvar in %l %cla",defaults:[(0,o.NC)("item")]},doShowTable:{dev:!0,type:"command",category:"lists",spec:"show table %l"},doMapCodeOrHeader:{type:"command",category:"other",spec:"map %cmdRing to %codeKind %code",defaults:[null,["code"]]},doMapValueCode:{type:"command",category:"other",spec:"map %mapValue to code %code",defaults:[["String"],"<#1>"]},doMapListCode:{type:"command",category:"other",spec:"map %codeListPart of %codeListKind to code %code"},reportMappedCode:{type:"reporter",category:"other",spec:"code of %cmdRing"},doSetVideoTransparency:{type:"command",category:"sensing",spec:"set video transparency to %n",defaults:[50]},reportVideo:{type:"reporter",category:"sensing",spec:"video %vid on %self",defaults:[["motion"],["myself"]]}}},y.prototype.initBlocks(),y.prototype.initBlockMigrations=function(){y.prototype.blockMigrations={doStopAll:{selector:"doStopThis",inputs:[["all"]]},doStop:{selector:"doStopThis",inputs:[["this script"]]},doStopBlock:{selector:"doStopThis",inputs:[["this block"]]},doStopOthers:{selector:"doStopThis",inputs:[["all"]],offset:0},receiveClick:{selector:"receiveInteraction",inputs:[["clicked"]]},reportTrue:{selector:"reportBoolean",inputs:[!0]},reportFalse:{selector:"reportBoolean",inputs:[!1]},reportCostumes:{selector:"reportGet",inputs:[["costumes"]]},reportSounds:{selector:"reportGet",inputs:[["sounds"]]},doMapStringCode:{selector:"doMapValueCode",inputs:[["String"],"<#1>"],offset:1},reportDistanceTo:{selector:"reportRelationTo",inputs:[["distance"]],offset:1},comeToFront:{selector:"goToLayer",inputs:[["front"]]},setHue:{selector:"setPenHSVA",inputs:[["hue"]],offset:1},setBrightness:{selector:"setPenHSVA",inputs:[["brightness"]],offset:1},changeHue:{selector:"changePenHSVA",inputs:[["hue"]],offset:1},changeBrightness:{selector:"changePenHSVA",inputs:[["brightness"]],offset:1},reportIsFastTracking:{selector:"reportGlobalFlag",inputs:[["turbo mode"]],offset:1},doSetFastTracking:{selector:"doSetGlobalFlag",inputs:[["turbo mode"]],offset:1}}},y.prototype.initBlockMigrations(),y.prototype.blockAlternatives={forward:["changeXPosition","changeYPosition"],turn:["turnLeft"],turnLeft:["turn"],doFaceTowards:["doGotoObject"],gotoXY:[["doGlide",1]],doGotoObject:["doFaceTowards"],doGlide:[["gotoXY",-1]],changeXPosition:["changeYPosition","setXPosition","setYPosition","forward"],setXPosition:["setYPosition","changeXPosition","changeYPosition"],changeYPosition:["changeXPosition","setYPosition","setXPosition","forward"],setYPosition:["setXPosition","changeYPosition","changeXPosition"],xPosition:["yPosition"],yPosition:["xPosition"],doSayFor:["doThinkFor","bubble","doThink","doAsk"],doThinkFor:["doSayFor","doThink","bubble","doAsk"],bubble:["doThink","doAsk","doSayFor","doThinkFor"],doThink:["bubble","doAsk","doSayFor","doThinkFor"],show:["hide"],hide:["show"],changeEffect:["setEffect"],setEffect:["changeEffect"],changeScale:["setScale"],setScale:["changeScale"],playSound:["doPlaySoundUntilDone","doPlaySoundAtRate"],doPlaySoundUntilDone:["playSound","doPlaySoundAtRate"],doPlaySoundAtRate:["playSound","doPlaySoundUntilDone"],doPlayNote:[["doRest",-1]],doRest:[["doPlayNote",1]],doChangeTempo:["doSetTempo"],doSetTempo:["doChangeTempo"],setVolume:["changeVolume"],changeVolume:["setVolume"],setPan:["changePan"],changePan:["setPan"],getVolume:["getTempo","getPan"],getTempo:["getVolume","getPan"],getPan:["getVolume","getTempo"],clear:["down","up","doStamp"],down:["up","clear","doStamp"],up:["down","clear","doStamp"],doPasteOn:["doCutFrom"],doCutFrom:["doPasteOn"],doStamp:["clear","down","up"],setPenHSVA:["changePenHSVA"],changePenHSVA:["setPenHSVA"],setBackgroundHSVA:["changeBackgroundHSVA"],changeBackgroundHSVA:["setBackgroundHSVA"],changeSize:["setSize"],setSize:["changeSize"],doBroadcast:["doBroadcastAndWait","doSend"],doBroadcastAndWait:["doBroadcast","doSend"],doSend:["doBroadcast","doBroadcastAndWait"],doIf:["doIfElse","doUntil"],doIfElse:["doIf","doUntil"],doRepeat:["doUntil",["doForever",-1],["doFor",2],["doForEach",1]],doUntil:["doRepeat","doIf",["doForever",-1],["doFor",2],["doForEach",1]],doForever:[["doUntil",1],["doRepeat",1],["doFor",3],["doForEach",2]],doFor:[["doForever",-3],["doRepeat",-2],["doUntil",-2],["doForEach",-1]],doAsk:["bubble","doThink","doSayFor","doThinkFor"],getLastAnswer:["getTimer"],getTimer:["getLastAnswer"],reportMouseX:["reportMouseY"],reportMouseY:["reportMouseX"],reportSum:["reportDifference","reportProduct","reportQuotient","reportPower","reportModulus"],reportDifference:["reportSum","reportProduct","reportQuotient","reportPower","reportModulus"],reportProduct:["reportDifference","reportSum","reportQuotient","reportPower","reportModulus"],reportQuotient:["reportDifference","reportProduct","reportSum","reportPower","reportModulus"],reportPower:["reportDifference","reportProduct","reportSum","reportQuotient","reportModulus"],reportModulus:["reportDifference","reportProduct","reportSum","reportQuotient","reportPower"],reportLessThan:["reportEquals","reportGreaterThan"],reportEquals:["reportLessThan","reportGreaterThan"],reportGreaterThan:["reportEquals","reportLessThan"],reportAnd:["reportOr"],reportOr:["reportAnd"],doSetVar:["doChangeVar"],doChangeVar:["doSetVar"],doShowVar:["doHideVar"],doHideVar:["doShowVar"],reportMap:["reportKeep","reportFindFirst"],reportKeep:["reportFindFirst","reportMap"],reportFindFirst:["reportKeep","reportMap"],doForEach:[["doFor",1],["doForever",-2],["doRepeat",-1],["doUntil",-1]]},y.prototype.init=function(t){this.name=(0,o.NC)("Sprite"),this.variables=new p(t||null,this),this.scripts=new N,this.customBlocks=[],this.costumes=new d,this.costumes.type="costume",this.costume=null,this.sounds=new d,this.sounds.type="sound",this.normalExtent=new o.E9(60,60),this.scale=1,this.rotationStyle=1,this.instrument=null,this.version=Date.now(),this.isTemporary=!1,this.isCorpse=!1,this.cloneOriginName="",this.volume=100,this.gainNode=null,this.pan=0,this.pannerNode=null,this.freqPlayer=null,this.cachedHSV=[0,0,0],this.inheritedMethodsCache=[],this.parts=[],this.anchor=null,this.nestingScale=1,this.rotatesWithAnchor=!0,this.layers=null,this.blocksCache={},this.paletteCache={},this.rotationOffset=o.xE,this.idx=0,this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0},this.exemplar=null,this.instances=[],this.cachedPropagation=!1,this.inheritedAttributes=[],this.imageExtent=o.xE,this.imageOffset=o.xE,this.imageData={},this.motionAmount=0,this.motionDirection=0,this.frameNumber=0,y.uber.init.call(this),this.isCachingImage=!0,this.isFreeForm=!0,this.cachedHSV=this.color.hsv(),this.isDraggable=!0,this.isDown=!1,this.heading=90,this.fixLayout(),this.rerender()},y.prototype.fullCopy=function(t){var e,i,s=y.uber.fullCopy.call(this),r=[];for(i in s.cachedImage=(0,o.TJ)(this.cachedImage),s.instances=[],s.stopTalking(),s.color=this.color.copy(),s.gainNode=null,s.pannerNode=null,s.freqPlayer=null,s.blocksCache={},s.paletteCache={},s.imageData={},s.cachedHSV=s.color.hsv(),r=[],this.inheritedAttributes.forEach((t=>r.push(t))),s.inheritedAttributes=r,t?(s.exemplar=this,s.customBlocks=[],s.variables=new p(null,s),s.variables.parentFrame=this.variables,s.inheritedVariableNames().forEach((t=>s.shadowVar(t,s.variables.getVar(t)))),this.addSpecimen(s),this.cachedPropagation=!1,["scripts","costumes","sounds"].forEach((t=>{(0,o.r3)(s.inheritedAttributes,t)||s.inheritedAttributes.push(t)}))):(s.variables=this.variables.copy(),s.variables.owner=s,s.scripts=this.scripts.fullCopy(),s.customBlocks=[],this.customBlocks.forEach((t=>{e=t.copyAndBindTo(s),s.customBlocks.push(e),s.allBlockInstances(t).forEach((t=>t.definition=e))})),r=[],this.costumes.asArray().forEach((e=>{var o=t?e:e.copy();r.push(o),e===this.costume&&(s.costume=o)})),s.costumes=new d(r),r=[],this.sounds.asArray().forEach((e=>{var o=t?e:e.copy();r.push(o)})),s.sounds=new d(r),r=[]),s.nestingScale=1,s.rotatesWithAnchor=!0,s.anchor=null,s.parts=[],this.parts.forEach((e=>{var o=e.fullCopy(t);o.nestingScale=e.nestingScale,o.rotatesWithAnchor=e.rotatesWithAnchor,s.attachPart(o)})),s.graphicsValues={},this.graphicsValues)this.graphicsValues.hasOwnProperty(i)&&(s.graphicsValues[i]=this.graphicsValues[i]);return s},y.prototype.appearIn=function(t){this.isTemporary||(this.name=t.newSpriteName(this.name),t.corral.addSprite(this),t.sprites.add(this)),t.stage.add(this),this.parts.forEach((e=>e.appearIn(t)))},y.prototype.setName=function(t){this.name=t||this.name,name,this.name,this.version=Date.now()},y.prototype.getImage=function(){return!this.shouldRerender&&this.cachedImage||(this.cachedImage=(0,o.oM)(this.costume?this.imageExtent:this.extent(),!(0,o.kK)(this.costume),this.cachedImage),this.render(this.cachedImage.getContext("2d")),this.shouldRerender=!1),this.cachedImage},y.prototype.fixLayout=function(){var t,e,i,s,r,n,a,h,l,p,c,d=[];t=this.center(),s=this.costume&&"function"==typeof this.costume.loaded,a=this.parent instanceof b?this.parent.scale:1,e=this.rotationStyle?this.heading:90,2===this.rotationStyle&&(e=90,(this.heading>180&&this.heading<360||this.heading<0&&this.heading>-180)&&(i=!0)),this.costume&&!s?(d=(r=i?this.costume.flipped():this.costume).bounds().corners().map((t=>t.rotateBy((0,o.uR)(e-90),this.costume.center()))),l=d[0],p=d[0],d.forEach((t=>{l=l.min(t),p=p.max(t)})),c=l.corner(p).extent().multiplyBy(this.scale*a),this.imageOffset=o.xE.rotateBy((0,o.uR)(-(e-90)),r.center()).subtract(l),1===this.rotationStyle?(n=Math.sqrt(Math.pow(r.width(),2)+Math.pow(r.height(),2))*this.scale*a,this.imageExtent=new o.E9(n,n)):this.imageExtent=c,this.bounds.setExtent(c),this.setCenter(t,!0),this.rotationOffset=this.imageOffset.translateBy(r.rotationCenter).rotateBy((0,o.uR)(-(e-90)),this.imageOffset).scaleBy(this.scale*a)):(e=i?-90:e,h=Math.min(Math.max(this.normalExtent.x*this.scale*a,5),1e3),this.bounds.setWidth(h),this.bounds.setHeight(h),this.setCenter(t,!0),this.rotationOffset=this.extent().divideBy(2))},y.prototype.render=function(t){var e,i,s,r,n,a,h,l=this;if(s=this.costume&&"function"==typeof this.costume.loaded,a=this.parent instanceof b?this.parent.scale:1,e=this.rotationStyle?this.heading:90,2===this.rotationStyle&&(e=90,(this.heading>180&&this.heading<360||this.heading<0&&this.heading>-180)&&(i=!0)),this.costume&&!s)n=i?this.costume.flipped():this.costume,t.save(),t.scale(this.scale*a,this.scale*a),t.translate(this.imageOffset.x,this.imageOffset.y),t.rotate((0,o.uR)(e-90)),t.drawImage(n.contents,0,0),t.restore();else if(e=i?-90:e,y.uber.render.call(this,t,e),s)return r=this.costume,h=setInterval((function(){l.wearCostume(r,!0),clearInterval(h)}),100),this.wearCostume(null,!0);this.cachedImage=this.applyGraphicsEffects(this.cachedImage),this.version=Date.now()},y.prototype.rotationCenter=function(){return this.position().add(this.rotationOffset)},y.prototype.getImageData=function(){if(this.version!==this.imageData.version){var t,e,i=this.parentThatIsA(b),s=this.extent(),r=new o.E9(Math.floor(s.x/i.scale),Math.floor(s.y/i.scale));(t=(0,o.oM)(r,!0).getContext("2d")).drawImage(this.getImage(),0,0,Math.floor(s.x),Math.floor(s.y),0,0,r.x,r.y),e=t.getImageData(0,0,r.x,r.y).data,this.imageData={version:this.version,pixels:new Uint32Array(e.buffer.slice(0))}}return this.imageData.pixels},y.prototype.projectionSnap=function(){var t,e,i,s,r,n,a=this.parentThatIsA(b),h=this.center().subtract(a.position()).divideBy(a.scale),l=this.costume||this.getImage();return l instanceof C?(i=l.rotationCenter.copy(),t=(l=l.contents).width,e=l.height):(t=this.width(),e=this.height()),s=new o.E9(Math.floor(h.x-t/2),Math.floor(h.y-e/2)),(n=(r=(0,o.oM)(new o.E9(t,e),!0)).getContext("2d")).drawImage(l,0,0),n.globalCompositeOperation="source-atop",n.drawImage(a.projectionLayer(),-s.x,-s.y),new C(r,this.newCostumeName((0,o.NC)("snap")),i)},y.prototype.blockForSelector=function(t,e){var i,s,r,n,a,h;if(i=this.blockMigrations[t],!(s=this.blocks[i?i.selector:t]))return null;if((r="command"===s.type?new R:"hat"===s.type?new F:"ring"===s.type?new O:new D("predicate"===s.type)).color=this.blockColor[s.category],r.category=s.category,r.selector=i?i.selector:t,(0,o.r3)(["reifyReporter","reifyPredicate"],r.selector)&&(r.isStatic=!0),r.setSpec((0,o.NC)(s.spec)),e&&s.defaults||i&&i.inputs)if(n=i?i.inputs:s.defaults,r.defaults=n,(a=r.inputs())[0]instanceof Z)a[0].setContents(n),a[0].defaults=n;else for(h=0;h<n.length;h+=1)null!==n[h]&&a[h].setContents(n[h]);return r},y.prototype.variableBlock=function(t,e){var o=new D(!1);return o.selector="reportGetVar",o.color=this.blockColor.variables,o.category="variables",o.isLocalVarTemplate=e,o.setSpec(t),o.isDraggable=!0,o},y.prototype.makeBlockButton=function(t){var e=new st(this,"makeBlock","Make a block");return e.userMenu=function(){var t=new o.wR(this);return t.addItem("help...","showHelp"),t},e.selector="addCustomBlock",e.showHelp=A.prototype.showHelp,e},y.prototype.palette=function(t){return this.paletteCache[t]||(this.paletteCache[t]=this.freshPalette(t)),this.paletteCache[t]},y.prototype.freshPalette=function(t){var e,i,r,n=new o.yR(null,null,this.sliderColor),a=I.prototype.fontSize,h=0,l=5,p=0,c=!1,d=this.parentThatIsA(b),u=new o.Il(140,140,140);return n.owner=this,n.padding=a/2,n.color=this.paletteColor,n.growth=new o.E9(0,o.tU.scrollBarSize),n.toolBar=new pt("column"),(i=new st(this,"searchBlocks",new s("magnifierOutline",16))).alpha=.2,i.padding=1,i.hint=(0,o.NC)("find blocks")+"...",i.labelShadowColor=u,i.edge=0,i.padding=3,i.fixLayout(),n.toolBar.add(i),(r=new st(this,"makeBlock",new s("cross",16))).alpha=.2,r.padding=1,r.hint=(0,o.NC)("Make a block")+"...",r.labelShadowColor=u,r.edge=0,r.padding=3,r.fixLayout(),n.toolBar.add(r),n.toolBar.fixLayout(),n.add(n.toolBar),n.userMenu=function(){var e,i,r=new o.wR,a=this.parentThatIsA(Kt),h={operators:["reifyScript","reifyReporter","reifyPredicate"],control:["doWarp"],variables:["doDeclareVariables","reportNewList","reportNumbers","reportCONS","reportListItem","reportCDR","reportListLength","reportListIndex","reportConcatenatedLists","reportListContainsItem","reportListIsEmpty","doForEach","reportMap","reportKeep","reportFindFirst","reportCombine","doAddToList","doDeleteFromList","doInsertInList","doReplaceInList"]};return r.addPair([new s("magnifyingGlass",o.tU.menuFontSize),(0,o.NC)("find blocks")+"..."],(()=>this.searchBlocks()),"^F"),n.contents.children.some((t=>(0,o.r3)(Object.keys(y.prototype.blocks),t.selector)))&&r.addItem("hide primitives",(function(){var e=y.prototype.blocks;Object.keys(e).forEach((o=>{e[o].category===t&&(b.prototype.hiddenPrimitives[o]=!0)})),(h[t]||[]).forEach((t=>b.prototype.hiddenPrimitives[t]=!0)),a.flushBlocksCache(t),a.refreshPalette()})),e=y.prototype.blocks,i=b.prototype.hiddenPrimitives,Object.keys(i).some((i=>!(0,o.kK)(e[i])&&(e[i].category===t||(0,o.r3)(h[t]||[],i))))&&r.addItem("show primitives",(function(){var e=b.prototype.hiddenPrimitives,o=y.prototype.blocks;Object.keys(e).forEach((e=>{o[e]&&o[e].category===t&&delete b.prototype.hiddenPrimitives[e]})),(h[t]||[]).forEach((t=>delete b.prototype.hiddenPrimitives[t])),a.flushBlocksCache(t),a.refreshPalette()})),r},(e=this.blocksCache[t])||(e=this.blockTemplates(t),this.isCachingPrimitives&&(this.blocksCache[t]=e)),e.forEach((t=>{if(null!==t)if("-"===t){if(c)return;l+=.8*a,c=!0}else if("="===t){if(c)return;l+=1.6*a,c=!0}else"#"===t?(h=0,l=p):(c=!1,0===h&&(l+=.3*a),t.setPosition(new o.E9(h,l)),n.addContents(t),t instanceof at||t instanceof O?(h=t.right()+a/2,p=t.bottom()):(h=0,l+=t.height()))})),d&&(l+=1.6*a,d.globalBlocks.forEach((e=>{var i;(e.category===t||"variables"===t&&(0,o.r3)(["lists","other"],e.category))&&(i=e.templateInstance(),l+=.3*a,i.setPosition(new o.E9(h,l)),n.addContents(i),h=0,l+=i.height())}))),l+=1.6*a,this.customBlocks.forEach((e=>{var i;(e.category===t||"variables"===t&&(0,o.r3)(["lists","other"],e.category))&&(i=e.templateInstance(),l+=.3*a,i.setPosition(new o.E9(h,l)),n.addContents(i),h=0,l+=i.height())})),this.exemplar&&this.inheritedBlocks(!0).forEach((e=>{var i;(e.category===t||"variables"===t&&(0,o.r3)(["lists","other"],e.category))&&(i=e.templateInstance(),l+=.3*a,i.setPosition(new o.E9(h,l)),n.addContents(i),i.ghost(),h=0,l+=i.height())})),n.scrollX(n.padding),n.scrollY(n.padding),n},y.prototype.blocksMatching=function(t,e,i,s){var r,n,a=[],h=t.toLowerCase(),l=this.parentThatIsA(b);function p(t){return A.prototype.parseSpec(t).filter((t=>0!==t.indexOf("%"))).join(" ")}function c(t,o){var i,s=" "+t,r=s.indexOf(o);return-1===r?-1:(i=" "===s.charAt(r-1),e&&!i?-1:(i?"1":"2")+function(t,e,o){for(var i=String(t);i.length<4;)i="0"+i;return i}(r))}function d(t){var e=y.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}return i&&i.length||(i=["hat","command","reporter","predicate","ring"]),s||(s=[]),s.forEach((t=>{var e=c(p(t.toLowerCase()),h);-1!==e&&a.push([this.variableBlock(t),e+"1"])})),[this.customBlocks,l.globalBlocks].forEach((t=>t.forEach((t=>{if((0,o.r3)(i,t.type)){var e=c(p(t.localizedSpec().toLowerCase()),h);-1!==e&&a.push([t.templateInstance(),e+"2"])}})))),r=y.prototype.blocks,Object.keys(r).forEach((t=>{if(!b.prototype.hiddenPrimitives[t]&&(0,o.r3)(i,r[t].type)){var e=r[t],s=c(p((0,o.NC)(e.alias||e.spec).toLowerCase()),h);-1===s||e.dev||e.only&&e.only!==this.constructor||a.push([d(t),s+"3"])}})),(0,o.r3)(i,"reporter")&&(n=this.reporterize(t))&&a.push([n,""]),a.sort(((t,e)=>t[1]<e[1]?-1:1)),a.map((t=>t[0]))},y.prototype.searchBlocks=function(t,e,i,s){var r,n,a=this,h=I.prototype.fontSize,l=this.parentThatIsA(Kt),p="",c=new ct(t||""),d=l.createPalette("forSearch"),u=[];function f(){n&&n.destroy(),r&&s&&(n=r.outline(o.tU.isFlat?new o.Il(150,200,255):o.Cj,2),d.contents.add(n),n.scrollIntoView())}function g(t){var e=d.contents.left()+5,i=c.bottom()+h;u=t,r=null,t.length&&s&&(r=t[0]),d.contents.children=[d.contents.children[0]],t.forEach((t=>{t.setPosition(new o.E9(e,i)),d.addContents(t),i+=t.height(),i+=.3*h})),f(),d.changed()}d.owner=this,d.color=this.paletteColor,d.contents.color=this.paletteColor,d.addContents(c),c.setWidth(l.logo.width()-30),c.contrast=90,c.setPosition(d.contents.topLeft().add(new o.E9(10,10))),c.fixLayout(),d.accept=function(){var t;s?(c.cancel(),r&&s.insertBlock(r)):(t=c.getValue()).length>0&&g(a.blocksMatching(t))},d.reactToKeystroke=function(t){var e;switch(t?t.keyCode:0){case 38:if(!s||!r)return;return(e=u.indexOf(r)-1)<0&&(e=u.length-1),r=u[e],void f();case 40:if(!s||!r)return;return(e=u.indexOf(r)+1)>=u.length&&(e=0),r=u[e],void f();default:(0,o.WY)()}},d.reactToInput=function(t){var o=c.getValue();o!==p&&(p=o,g(a.blocksMatching(o,o.length<2,e,i)))},c.cancel=function(){l.refreshPalette(),l.palette.adjustScrollBars()},l.fixLayout("refreshPalette"),c.edit(),t&&d.reactToKeystroke()},y.prototype.reporterize=function(t){var e;if(t.length>100)return null;try{return(e=function t(e,o,i){var s,r=["",""],n=0;function a(t){return t instanceof Array||isNaN(+t)?t:+t}function h(){for(var t=1,o="";n<e.length;){switch(s=e[n],n+=1,s){case"(":t+=1;break;case")":if(!(t-=1))return o}o+=s}}for(;n<e.length;)switch(s=e[n],n+=1,s){case" ":break;case"(":r[o?1:0].length?r[o?1:0]=[r[o?1:0],t(h())]:r[o?1:0]=t(h());break;case"-":case"+":case"*":case"/":case"%":case"^":case"=":case"<":case">":case"&":case"|":if(o||r[0].length)if(o){if(r[1].length)return t(e.slice(n),s,[o,i,a(r[1])]);r[1]=s}else o=s,i=a(r[0]);else r[0]=s;break;default:r[o?1:0]+=s}return o?[o,i,a(r[1])]:a(r[0])}(t))instanceof Array?function t(e){var i,s,r,n,a,h,l,p,c=1,d={};for(s={"+":"reportSum","-":"reportDifference","*":"reportProduct","/":"reportQuotient","%":"reportModulus","^":"reportPower","=":"reportEquals","<":"reportLessThan",">":"reportGreaterThan","&":"reportAnd","|":"reportOr",round:"reportRound",not:"reportNot"},n={ceil:"ceiling","!":"not","-":"neg"},(r=["abs","neg","ceiling","floor","sqrt","sin","cos","tan","asin","acos","atan","ln","log","lg","id","round","not"]).concat(["true","false"]).forEach((t=>d[(0,o.NC)(t).toLowerCase()]=t)),a=n[e[0]]||d[e[0].toLowerCase()]||e[0],(0,o.r3)(r,a)?(h=s[a])?p=(i=y.prototype.blockForSelector(h)).inputs():((p=(i=y.prototype.blockForSelector("reportMonadic")).inputs())[0].setContents([a]),c=0):p=(i=y.prototype.blockForSelector(s[a])).inputs(),l=1;l<e.length;l+=1)e[l]instanceof Array?i.replaceInput(p[l-c],t(e[l])):(0,o.HD)(e[l])?(0,o.r3)(["true","false"],d[e[l]]||e[l])?i.replaceInput(p[l-c],y.prototype.blockForSelector("true"===(d[e[l]]||e[l])?"reportTrue":"reportFalse")):"_"!==e[l]&&i.replaceInput(p[l-c],y.prototype.variableBlock(e[l])):p[l-c].setContents(e[l]);return i.isDraggable=!0,i.fixLayout(),i.fixBlockColor(null,!0),i}(e):null}catch(t){return null}},y.prototype.addVariable=function(t,e){var o=this.parentThatIsA(Kt);e?(this.globalVariables().addVar(t),o&&o.flushBlocksCache("variables")):(this.variables.addVar(t),this.blocksCache.variables=null)},y.prototype.deleteVariable=function(t){var e=this.parentThatIsA(Kt);(0,o.r3)(this.inheritedVariableNames(!0),t)||this.deleteVariableWatcher(t),this.variables.deleteVar(t),e&&(e.flushBlocksCache("variables"),e.refreshPalette())},y.prototype.addCostume=function(t){t.name||(t.name="costume"+(this.costumes.length()+1)),this.shadowAttribute("costumes"),this.costumes.add(t)},y.prototype.wearCostume=function(t,e){var i=this.xPosition?this.xPosition():null,s=this.yPosition?this.yPosition():null,r=(0,o.kK)(t)?null:this.costumes.asArray().indexOf(t);this.changed(),this.costume=t,this.fixLayout(),this.rerender(),null!==i&&this.silentGotoXY(i,s,!0),this.positionTalkBubble&&this.positionTalkBubble(),this.version=Date.now(),e||this.shadowAttribute("costume #"),this.specimens().forEach((e=>{e.cachedPropagation&&e.inheritsAttribute("costume #")&&(null===r?e.wearCostume(null,!0):-1===r?e.wearCostume(t,!0):e.doSwitchToCostume(r+1,!0))}))},y.prototype.getCostumeIdx=function(){return this.inheritsAttribute("costume #")?this.exemplar.getCostumeIdx():this.costumes.asArray().indexOf(this.costume)+1},y.prototype.doWearNextCostume=function(){var t,e=this.costumes.asArray();e.length>1&&(t=e.indexOf(this.costume))>-1&&((t+=1)>e.length-1&&(t=0),this.wearCostume(e[t]))},y.prototype.doWearPreviousCostume=function(){var t,e=this.costumes.asArray();e.length>1&&(t=e.indexOf(this.costume))>-1&&((t-=1)<0&&(t=e.length-1),this.wearCostume(e[t]))},y.prototype.doSwitchToCostume=function(t,e){var i=0,s=0;if(t instanceof d&&(this.costume&&(i=this.costume.width(),s=this.costume.height()),i*s!==t.length()&&(i=b.prototype.dimensions.x,s=b.prototype.dimensions.y),t=a.prototype.reportNewCostume(t,i,s,this.newCostumeName((0,o.NC)("snap")))),t instanceof C)this.wearCostume(t,e);else if(!(t instanceof Array&&"current"===t[0])){var r,n,h=this.costumes.asArray();if((0,o.r3)([(0,o.NC)("Turtle"),(0,o.NC)("Empty")],t instanceof Array?t[0]:null))n=null;else{if(-1===t)return void this.doWearPreviousCostume();null===(n=(0,o.qY)(h,(e=>e.name===t)))&&(n=0===(r=parseFloat(t))?null:h[r-1]||null)}this.wearCostume(n,e)}},y.prototype.reportCostumes=function(){return this.costumes},y.prototype.addSound=function(t,e){var o=new x(t,e);return this.shadowAttribute("sounds"),this.sounds.add(o),o},y.prototype.doPlaySound=function(t){var e,i=this.parentThatIsA(b),s=t instanceof x?t:"number"==typeof t?this.sounds.at(t):(0,o.qY)(this.sounds.asArray(),(e=>e.name===t.toString())),r=this.audioContext(),n=this.getGainNode(),a=this.getPannerNode();if(s)return(e=document.createElement("audio")).src=s.audio.src,r.resume(),r.createMediaElementSource(e).connect(n),a?(n.connect(a),a.connect(r.destination),this.setPan(this.getPan())):n.connect(r.destination),this.setVolume(this.getVolume()),e.play(),i&&(i.activeSounds.push(e),i.activeSounds=i.activeSounds.filter((t=>!t.ended&&!t.terminated))),e},y.prototype.reportSounds=function(){return this.sounds},y.prototype.setVolume=function(t,e){this.volume=Math.max(Math.min(+t||0,100),0),this.getGainNode().gain.setValueAtTime(1/Math.pow(10,Math.log2(100/this.volume)),this.audioContext().currentTime),this instanceof b||(e||this.shadowAttribute("volume"),this.instances.forEach((e=>{e.cachedPropagation&&e.inheritsAttribute("volume")&&e.setVolume(t,!0)})))},y.prototype.changeVolume=function(t){this.setVolume(this.getVolume()+(+t||0))},y.prototype.getVolume=function(){return this.inheritsAttribute("volume")?this.exemplar.getVolume():this.volume},y.prototype.getGainNode=function(){return this.gainNode||(this.gainNode=this.audioContext().createGain()),this.gainNode},y.prototype.audioContext=function(){return k.prototype.getAudioContext()},y.prototype.setPan=function(t,e){var o=this.getPannerNode();o&&(this.pan=Math.max(Math.min(+t||0,100),-100),o.pan.setValueAtTime(this.pan/100,this.audioContext().currentTime),this instanceof b||(e||this.shadowAttribute("balance"),this.instances.forEach((e=>{e.cachedPropagation&&e.inheritsAttribute("balance")&&e.setPan(t,!0)}))))},y.prototype.changePan=function(t){this.setPan(this.getPan()+(+t||0))},y.prototype.getPan=function(){return this.inheritsAttribute("balance")?this.exemplar.getPan():this.pan},y.prototype.getPannerNode=function(){return this.pannerNode||this.audioContext().createStereoPanner&&(this.pannerNode=this.audioContext().createStereoPanner()),this.pannerNode},y.prototype.playFreq=function(t){var e,o=this.audioContext(),i=this.getGainNode(),s=this.getPannerNode(),r=this.parentThatIsA(b);this.freqPlayer||(this.freqPlayer=new k),(e=this.freqPlayer).fader=o.createGain(),e.oscillator?e.oscillator.frequency.value=t:(e.oscillator=o.createOscillator(),e.oscillator.start||(e.oscillator.start=e.oscillator.noteOn),e.oscillator.stop||(e.oscillator.stop=e.oscillator.noteOff),e.setInstrument(this.instrument),e.oscillator.frequency.value=t,this.setVolume(this.getVolume()),e.oscillator.connect(e.fader),e.fader.connect(i),s?(i.connect(s),s.connect(o.destination),this.setPan(this.pan)):i.connect(o.destination),e.ended=!1,r&&(r.activeSounds.push(e),r.activeSounds=r.activeSounds.filter((t=>!t.ended&&!t.terminated))),e.fader.gain.setValueCurveAtTime(e.fadeIn,o.currentTime,e.fadeTime),e.oscillator.start(0))},y.prototype.stopFreq=function(){this.freqPlayer&&this.freqPlayer.stop()},y.prototype.userMenu=function(){var t,e,i=this.parentThatIsA(Kt),s=new o.wR(this);return i&&i.isAppMode||(this.isTemporary||(s.addItem("duplicate","duplicate"),b.prototype.enableInheritance&&(s.addItem("clone","instantiate"),s.addLine())),s.addItem("delete","remove"),s.addItem("move","moveCenter"),s.addItem("rotate","setRotation"),this.costume&&s.addItem("pivot","moveRotationCenter","edit the costume's\nrotation center"),this.isTemporary?b.prototype.enableInheritance&&s.addItem("edit","perpetuateAndEdit","make permanent and\nshow in the sprite corral"):s.addItem("edit","edit"),s.addLine(),this.anchor?s.addItem((0,o.NC)("detach from")+" "+this.anchor.name,"detachFromAnchor"):(t=this.allParts(),(e=this.parent.children.filter((e=>e instanceof y&&!(0,o.r3)(t,e)))).length&&s.addMenu("stick to",this.anchorsMenu(e))),this.parts.length&&s.addItem("detach all parts","detachAllParts"),s.addItem("export...","exportSprite")),s},y.prototype.anchorsMenu=function(t){var e=new o.wR(this.attachTo,null,this);return t.forEach((t=>e.addItem([t.thumbnail(new o.E9(24,24)),t.name],t))),e},y.prototype.exportSprite=function(){if(!this.isTemporary){var t=this.parentThatIsA(Kt);t&&t.exportSprite(this)}},y.prototype.edit=function(){var t=this.parentThatIsA(Kt);t&&!t.isAppMode&&t.selectSprite(this)},y.prototype.showOnStage=function(){var t=this.parentThatIsA(b);t&&(this.keepWithin(t),t.add(this)),this.show()},y.prototype.duplicate=function(){var t=this.parentThatIsA(Kt);t&&t.duplicateSprite(this)},y.prototype.instantiate=function(){var t=this.parentThatIsA(Kt);t&&t.instantiateSprite(this)},y.prototype.remove=function(){var t=this.parentThatIsA(Kt);t&&t.removeSprite(this)},y.prototype.createClone=function(t){var e,o=this.parentThatIsA(b);return o&&o.cloneCount<=5e3&&(e=this.fullCopy(!0)).clonify(o,t),e},y.prototype.newClone=function(t){var e=this.createClone(t);if((0,o.kK)(e))throw new Error("exceeding maximum number of clones");return e},y.prototype.clonify=function(t,e){this.parts.forEach((e=>e.clonify(t))),t.cloneCount+=1,this.cloneOriginName=this.isTemporary?this.cloneOriginName:this.name,this.isTemporary=!0,this.name="",t.add(this),this.allHatBlocksFor("__clone__init__").forEach((o=>t.threads.startProcess(o,this,t.isThreadSafe,null,null,null,e))),this.endWarp()},y.prototype.initClone=function(t){var e=this.parentThatIsA(b);e&&(t.forEach((t=>e.threads.startProcess(t,this,e.isThreadSafe))),this.endWarp())},y.prototype.removeClone=function(){var t=this.exemplar;this.isTemporary&&(this.parent.threads.stopAllForReceiver(this),this.parts.slice().forEach((t=>{this.detachPart(t),t.removeClone()})),this.corpsify(),this.instances.forEach((e=>{e.isTemporary&&e.setExemplar(t)})),this.destroy(),this.parent.cloneCount-=1)},y.prototype.perpetuate=function(){var t=this.parentThatIsA(b),e=this.parentThatIsA(Kt);this.exemplar&&this.exemplar.perpetuate(),this.isTemporary&&t&&e&&(this.isTemporary=!1,this.name=e.newSpriteName(this.cloneOriginName),this.cloneOriginName="",t.cloneCount-=1,e.corral.addSprite(this),e.sprites.add(this),this.parts.forEach((t=>t.perpetuate())))},y.prototype.perpetuateAndEdit=function(){var t=this.parentThatIsA(Kt);t&&(this.perpetuate(),t.selectSprite(this))},y.prototype.release=function(){var t,e=this.parentThatIsA(b),i=this.parentThatIsA(Kt);!this.isTemporary&&this.exemplar&&e&&i&&(this.parts.forEach((t=>t.release())),this.instances.forEach((t=>t.release())),this.isTemporary=!0,this.name="",this.cloneOriginName=this.exemplar.name,e.cloneCount+=1,t=i.sprites.asArray().indexOf(this)+1,e.watchers().forEach((t=>{t.object()===this&&t.destroy()})),t>0&&i.sprites.remove(t),i.createCorral(),i.fixLayout(),i.currentSprite===this&&(i.currentSprite=(0,o.qY)(e.children,(t=>t instanceof y&&!t.isTemporary))||this.stage),i.selectSprite(i.currentSprite),i.isAppMode&&i.toggleAppMode(!0))},y.prototype.corpsify=function(){this.isCorpse=!0,this.version=Date.now()},y.prototype.show=function(){this.setVisibility(!0)},y.prototype.hide=function(){this.setVisibility(!1)},y.prototype.setVisibility=function(t,e){var o=this.talkBubble();t?y.uber.show.call(this):y.uber.hide.call(this),o&&(t?o.show():o.hide()),this.parts.forEach((e=>e.setVisibility(t))),e||this.shadowAttribute("shown?"),this.instances.forEach((e=>{e.cachedPropagation&&e.inheritsAttribute("shown?")&&e.setVisibility(t,!0)}))},y.prototype.reportShown=function(){return this.inheritsAttribute("shown?")?this.exemplar.reportShown():this.isVisible},y.prototype.setColorComponentHSVA=function(t,e){var o=this.xPosition(),i=this.yPosition(),s=+e;(t=+t)<0||t>3||(0==t?(s<0||s>100)&&(s=(s<0?100:0)+s%100):s=Math.min(100,Math.max(0,s)),3===t?this.color.a=1-s/100:(this.cachedHSV[t]=s/100,this.color.set_hsv.apply(this.color,this.cachedHSV)),this.costume||this.rerender(),this.gotoXY(o,i))},y.prototype.getColorComponentHSLA=function(t){return 3==(t=+t)?100*(1-this.color.a):100*(this.cachedHSV[t]||0)},y.prototype.changeColorComponentHSVA=function(t,e){this.setColorComponentHSVA(t,this.getColorComponentHSLA(t)+(+e||0))},y.prototype.setColor=function(t){var e=this.xPosition(),o=this.yPosition();this.color.eq(t,!0)||(this.color=t.copy(),this.costume||(this.rerender(),this.silentGotoXY(e,o)),this.cachedHSV=this.color.hsv())},y.prototype.setBackgroundColor=y.prototype.setColor,y.prototype.getPenAttribute=function(t){var e=t instanceof Array?t[0]:t.toString();return"size"===e?this.size||0:this.getColorComponentHSLA(["hue","saturation","brightness","transparency"].indexOf(e))},y.prototype.comeToFront=function(){this.parent&&(this.parent.add(this),this.changed())},y.prototype.goToBack=function(){this.parent&&(this.parent.addBack(this),this.changed())},y.prototype.goBack=function(t){var e,o,i=+t;if(!this.parent)return null;e=this.parent.children.indexOf(this),this.parent.removeChild(this),o=Math.max(e-i,0),this.parent.children.splice(o,null,this),this.parent.changed()},y.prototype.reportTouchingColor=function(t){var e,o,i,s=this.parentThatIsA(b);if(s){if(!(e=this.overlappingPixels(s)))return!1;for(o=e[0].length,i=3;i<o;i+=4)if(e[0][i]&&e[1][i]&&e[1][i-3]===t.r&&e[1][i-2]===t.g&&e[1][i-1]===t.b)return!0}return!1},y.prototype.reportColorIsTouchingColor=function(t,e){var o,i,s,r=this.parentThatIsA(b);if(r){if(!(o=this.overlappingPixels(r)))return!1;for(i=o[0].length,s=3;s<i;s+=4)if(o[0][s]&&o[1][s]&&o[0][s-3]===t.r&&o[0][s-2]===t.g&&o[0][s-1]===t.b&&o[1][s-3]===e.r&&o[1][s-2]===e.g&&o[1][s-1]===e.b)return!0}return!1},y.prototype.overlappingPixels=function(t){var e=this.bounds.intersect(t.bounds),i=this.getImage(),s=t.getImage();return t instanceof b&&(s=t.fancyThumbnail(t.extent(),this,!0)),!!(!(e.width()<1||e.height()<1)&&i&&s&&i.width&&i.height&&s.width&&s.height)&&(i.isRetinaEnabled!==s.isRetinaEnabled&&(i=(0,o.bl)(i,!0),s=(0,o.bl)(s,!0)),[i.getContext("2d").getImageData(e.left()-this.left(),e.top()-this.top(),e.width(),e.height()).data,s.getContext("2d").getImageData(e.left()-t.left(),e.top()-t.top(),e.width(),e.height()).data])},y.prototype.neighbors=function(t){var e=t||this.parentThatIsA(b),o=this.perimeter(e);return new d(e.children.filter((t=>{var i;return!!(t instanceof y&&t.isVisible&&t!==this)&&(i=t.perimeter(e),o.center.distanceTo(i.center)-o.radius-i.radius<0)})))},y.prototype.perimeter=function(t){var e,o=t||this.parentThatIsA(b),i=this instanceof b?1:o.scale;return e=this.costume?Math.max(this.costume.width(),this.costume.height())*this.scale*i:Math.max(this.width(),this.height()),{center:this.center(),radius:e}},y.prototype.doStamp=function(){var t=this.parent,e=t.penTrails().getContext("2d"),o=this.getImage();o.width<1||o.height<1||(e.save(),e.scale(1/t.scale,1/t.scale),e.globalAlpha=this.alpha,e.drawImage(o,this.left()-t.left(),this.top()-t.top()),e.restore(),this.changed(),t.cachedPenTrailsMorph=null)},y.prototype.clear=function(){this.parent.clearPenTrails()},y.prototype.write=function(t,e){if("string"!=typeof t&&"number"!=typeof t)throw new Error("LABEL can only draw text or numbers, not a "+typeof t);var i,s,r=this.parentThatIsA(b),n=r.penTrails().getContext("2d"),a=(0,o.uR)(this.direction()-90),h=new o.E9(this.rotationCenter().x-r.left(),this.rotationCenter().y-r.top());n.save(),n.font=e+"px monospace",n.textAlign="left",n.textBaseline="alphabetic",n.fillStyle=this.color.toString(),i=n.measureText(t).width,h=h.multiplyBy(1/r.scale),n.translate(h.x,h.y),n.rotate(a),n.fillText(t,0,0),n.translate(-h.x,-h.y),n.restore(),s=(s=new o.E9(i*Math.sin((0,o.uR)(this.direction())),i*Math.cos((0,o.uR)(this.direction())))).add(new o.E9(this.xPosition(),this.yPosition())),this.gotoXY(s.x,s.y,!1),this.changed(),r.changed()},y.prototype.setSize=function(t){isNaN(t)||(this.size=Math.min(Math.max(+t,1e-4),1e3))},y.prototype.changeSize=function(t){this.setSize(this.size+(+t||0))},y.prototype.blitOn=function(t,e="source-atop"){var i,s,r,n,a,h,l,p,c,d,u,f,g,m=1===this.rotationStyle?this.heading:90,w=1===t.rotationStyle?t.heading:90;this!==t&&this.costume&&t.costume&&((i=this.costume)instanceof S&&(i=i.rasterized()),s=t.costume instanceof S?t.costume.rasterized():t.costume.copy(),t instanceof y?this instanceof y?(n=m-w,a=this.scale/t.scale,h=this.parentThatIsA(b).scale,l=t.center().distanceTo(this.center()),p=this.center().subtract(t.center()),c=Math.atan2(p.y,p.x),u=(d=new o.E9(i.width(),i.height()).multiplyBy(.5*this.scale*h)).distanceTo(o.xE),f=Math.atan2(d.y,d.x),g=new o.E9(t.costume.width(),t.costume.height()).multiplyBy(.5*t.scale*h).rotateBy((0,o.uR)(n)).distanceAngle(l,(0,o.RW)(c)-m+180).distanceAngle(u,(0,o.RW)(f)-90).divideBy(h).divideBy(a).divideBy(t.scale)):(n=90-w,a=1/t.scale,l=t.center().distanceTo(this.position()),p=this.position().subtract(t.center()),c=Math.atan2(p.y,p.x),g=(d=new o.E9(t.costume.width(),t.costume.height()).multiplyBy(.5*t.scale).rotateBy((0,o.uR)(90-w))).distanceAngle(l/this.scale,(0,o.RW)(c)+90)):(n=m-90,a=this.scale,g=(d=this.center().subtract(t.position()).divideBy(this.scale*t.scale).rotateBy((0,o.uR)(m-90))).subtract(new o.E9(i.width(),i.height()).multiplyBy(.5))),(r=s.contents.getContext("2d")).rotate((0,o.uR)(n)),r.scale(a,a),r.globalCompositeOperation=e,r.drawImage(i.contents,g.x,g.y),t.doSwitchToCostume(s))},y.prototype.down=function(){this.setPenDown(!0)},y.prototype.up=function(){this.setPenDown(!1)},y.prototype.setPenDown=function(t,e){t?y.uber.down.call(this):y.uber.up.call(this),e||this.shadowAttribute("pen down?"),this.instances.forEach((e=>{e.cachedPropagation&&e.inheritsAttribute("pen down?")&&e.setPenDown(t,!0)}))},y.prototype.getPenDown=function(){return this.inheritsAttribute("pen down?")?this.exemplar.getPenDown():this.isDown},y.prototype.getScale=function(){return this.inheritsAttribute("size")?this.exemplar.getScale():100*this.scale},y.prototype.setScale=function(t,e){var o,i,s=this.xPosition(),r=this.yPosition();i=(o=(+t||0)/100)/this.nestingScale,this.nestingScale=o,this.scale=Math.max(o,.01),this.changed(),this.fixLayout(),this.rerender(),this.silentGotoXY(s,r,!0),this.positionTalkBubble(),this.parts.forEach((t=>{var e=t.xPosition()-s,o=t.yPosition()-r;t.setScale(100*t.scale*i),t.silentGotoXY(s+e*i,r+o*i)})),e||this.shadowAttribute("size"),this.instances.forEach((e=>{e.cachedPropagation&&e.inheritsAttribute("size")&&e.setScale(t,!0)}))},y.prototype.changeScale=function(t){this.setScale(this.getScale()+(+t||0))},y.prototype.graphicsChanged=function(){return Object.keys(this.graphicsValues).some((t=>this.graphicsValues[t]<0||this.graphicsValues[t]>0))},y.prototype.applyGraphicsEffects=function(t){var e,i,s,r;if(this.graphicsChanged()){if(s=Math.ceil(this.width()),r=Math.ceil(this.height()),!(t.width&&t.height&&s&&r))return t;i=(e=t.getContext("2d")).getImageData(0,0,s,r),this.graphicsValues.fisheye&&(i=function(t,o){var i,s,r,n,a,h,l,p,c,d,u,f,g,y,m,b,w;for(h=t.width,l=t.height,i=t.data,r=(s=e.createImageData(h,l)).data,n=h/2,a=l/2,o=Math.max(0,(o+100)/100),c=0;c<l;c++)for(p=0;p<h;p++)d=(p-n)/n,u=(c-a)/a,(f=Math.pow(Math.sqrt(d*d+u*u),o))<=1?(g=Math.atan2(u,d),y=Math.floor(n+f*Math.cos(g)*n),m=Math.floor(a+f*Math.sin(g)*a)):(y=p,m=c),w=4*(m*h+y),r[b=4*(c*h+p)]=i[w],r[b+1]=i[w+1],r[b+2]=i[w+2],r[b+3]=i[w+3];return s}(i,this.graphicsValues.fisheye)),this.graphicsValues.whirl&&(i=function(t,i){var s,r,n,a,h,l,p,c,d,u,f,g,y,m,b,w,C,S,v,x,k,M,T,B,P;for(a=t.width,h=t.height,s=t.data,n=(r=e.createImageData(a,h)).data,l=a/2,p=h/2,u=Math.min(l,p),a<h?(f=h/a,g=1):(f=1,g=a/h),y=-(0,o.uR)(i),m=u*u,d=0;d<h;d++)for(c=0;c<a;c++)(C=(b=f*(c-l))*b+(w=g*(d-p))*w)<m?(v=y*((S=1-Math.sqrt(C)/u)*S),B=Math.sin(v),P=Math.cos(v),x=Math.floor((P*b-B*w)/f+l),k=Math.floor((B*b+P*w)/g+p)):(x=c,k=d),T=4*(k*a+x),n[M=4*(d*a+c)]=s[T],n[M+1]=s[T+1],n[M+2]=s[T+2],n[M+3]=s[T+3];return r}(i,this.graphicsValues.whirl)),this.graphicsValues.pixelate&&(i=function(t,o){var i,s,r,n,a,h,l,p,c,d;for(n=t.width,a=t.height,i=t.data,r=(s=e.createImageData(n,a)).data,o=Math.floor(Math.abs(o/10)+1),l=0;l<a;l++)for(h=0;h<n;h++)p=Math.floor(h/o)*o,d=4*(Math.floor(l/o)*o*n+p),r[c=4*(l*n+h)]=i[d],r[c+1]=i[d+1],r[c+2]=i[d+2],r[c+3]=i[d+3];return s}(i,this.graphicsValues.pixelate)),this.graphicsValues.mosaic&&(i=function(t,o){var i,s,r,n,a,h;for(i=t.data,a=(n=e.createImageData(t.width,t.height)).data,o=Math.round((Math.abs(o)+10)/10),o=Math.max(0,Math.min(o,Math.min(t.width,t.height))),s=0,r=i.length;s<r;s+=4)h=s*o%r,a[s]=i[h],a[s+1]=i[h+1],a[s+2]=i[h+2],a[s+3]=i[h+3];return n}(i,this.graphicsValues.mosaic)),this.graphicsValues.duplicate&&(i=function(t,e){var o,i;for(o=t.data,i=0;i<o.length;i+=4)o[i]=o[i*e],o[i+1]=o[i*e+1],o[i+2]=o[i*e+2],o[i+3]=o[i*e+3];return t}(i,this.graphicsValues.duplicate)),(this.graphicsValues.color||this.graphicsValues.saturation||this.graphicsValues.brightness)&&(i=function(t,e,o,i){var s,r,n,a,h,l,p,c,d,u,f,g,y,m,b,w,C,S,v,x;for(r=0,n=(s=t.data).length;r<n;r+=4)a=s[r],h=s[r+1],l=s[r+2],0==(d=(p=Math.max(a,h,l))-(c=Math.min(a,h,l)))?u=f=0:(p===a?u=60*(h-l)/d:p===h?u=120+60*(l-a)/d:p===l&&(u=240+60*(a-h)/d),f=(p-c)/p),u<0&&(u+=360),g=p/255,u=(u+360*e/200)%360,f=Math.max(0,Math.min(f+o/100,1)),b=(g=Math.max(0,Math.min(g+i/100,1)))*(1-f),w=g*(1-f*(m=u/60-(y=Math.floor(u/60)))),C=g*(1-f*(1-m)),0===y||6===y?(S=g,v=C,x=b):1===y?(S=w,v=g,x=b):2===y?(S=b,v=g,x=C):3===y?(S=b,v=w,x=g):4===y?(S=C,v=b,x=g):5===y&&(S=g,v=b,x=w),s[r]=255*S,s[r+1]=255*v,s[r+2]=255*x;return t}(i,this.graphicsValues.color,this.graphicsValues.saturation,this.graphicsValues.brightness)),this.graphicsValues.negative&&(i=function(t,e){var o,i,s,r,n,a;for(i=0,s=(o=t.data).length;i<s;i+=4)r=255-o[i],n=255-o[i+1],a=255-o[i+2],o[i]<r?o[i]+=e:o[i]>r&&(o[i]-=e),o[i+1]<n?o[i+1]+=e:o[i+1]>n&&(o[i+1]-=e),o[i+2]<a?o[i+2]+=e:o[i+2]>a&&(o[i+2]-=e);return t}(i,this.graphicsValues.negative)),this.graphicsValues.comic&&(i=function(t,e){var o,i,s;for(i=0,s=(o=t.data).length;i<s;i+=4)o[i]+=127*Math.sin(i*e)+128,o[i+1]+=127*Math.sin(i*e)+128,o[i+2]+=127*Math.sin(i*e)+128;return t}(i,this.graphicsValues.comic)),this.graphicsValues.confetti&&(i=function(t,e){var o,i,s;for(i=0,s=(o=t.data).length;i<s;i+=1)o[i]=127*Math.sin(e*o[i])+o[i];return t}(i,this.graphicsValues.confetti)),e.putImageData(i,0,0)}return t},y.prototype.setEffect=function(t,e){var i=t instanceof Array?t[0]:t.toString();if(!(0,o.r3)(["color","saturation","brightness","ghost","fisheye","whirl","pixelate","mosaic","negative","duplicate","comic","confetti"],i))throw new Error((0,o.NC)("unsupported graphic effect")+":\n"+i);"ghost"===i?this.alpha=1-Math.min(Math.max(+e||0,0),100)/100:this.graphicsValues[i]=+e,this.rerender()},y.prototype.getEffect=function(t){var e=t instanceof Array?t[0]:t.toString();return"ghost"===e?this.getGhostEffect():this.graphicsValues[e]||0},y.prototype.getGhostEffect=function(){return 100*(1-this.alpha)},y.prototype.changeEffect=function(t,e){var o=t instanceof Array?t[0]:t.toString();"ghost"===o?this.setEffect(t,this.getGhostEffect()+(+e||0)):this.setEffect(t,+this.graphicsValues[o]+ +e)},y.prototype.clearEffects=function(){var t;for(t in this.graphicsValues)this.graphicsValues.hasOwnProperty(t)&&this.setEffect([t],0);this.setEffect(["ghost"],0)},y.prototype.stopTalking=function(){var t=this.talkBubble();t&&t.destroy()},y.prototype.doThink=function(t){this.bubble(t,!0)},y.prototype.bubble=function(t,e,i){var s,r=this.parentThatIsA(b);this.stopTalking(),""===t||(0,o.kK)(t)||(s=new w(t,r,e,i),this.add(s),this.positionTalkBubble())},y.prototype.talkBubble=function(){return(0,o.qY)(this.children,(t=>t instanceof o.KE))},y.prototype.positionTalkBubble=function(){var t=this.parentThatIsA(b),e=t?t.scale:1,i=this.talkBubble(),s=this.center().y;if(!i)return null;for(i.show(),i.isPointingRight||(i.isPointingRight=!0,i.fixLayout(),i.rerender()),i.setLeft(this.right()),i.setBottom(this.top());!this.isTouching(i)&&i.bottom()<s;)i.moveBy(new o.E9(-1,1).scaleBy(e));if(!t)return null;i.right()>t.right()&&(i.isPointingRight=!1,i.fixLayout(),i.rerender(),i.setRight(this.center().x)),i.keepWithin(t)},y.prototype.prepareToBeGrabbed=function(t){this.recordLayers(),this.shadowAttribute("x position"),this.shadowAttribute("y position"),!this.bounds.containsPoint(t.position())&&this.isCorrectingOutsideDrag()&&this.setCenter(t.position())},y.prototype.isCorrectingOutsideDrag=function(){return!this.parts.length},y.prototype.justDropped=function(){var t=this.parentThatIsA(b);t&&(t.enableCustomHatBlocks=!0),this.exemplar&&this.inheritedAttributes.forEach((t=>{(0,o.r3)(["direction","size","costume #"],t)&&this.refreshInheritedAttribute(t)})),this.restoreLayers(),this.positionTalkBubble(),this.receiveUserInteraction("dropped")},y.prototype.drawLine=function(t,e){var o=this.parent.bounds.origin,i=this.parent.scale,s=this.parent.penTrails().getContext("2d"),r=t.subtract(o).divideBy(i),n=e.subtract(o).divideBy(i),a=r.multiplyBy(i).add(o),h=n.multiplyBy(i).add(o),l=a.rectangle(h).expandBy(Math.max(this.size*i/2,1)).intersect(this.parent.visibleBounds()).spread();this.isDown&&(b.prototype.enablePenLogging&&this.parent.trailsLog.push([this.snapPoint(t),this.snapPoint(e),this.color.copy(),this.size,this.useFlatLineEnds?"butt":"round"]),s.lineWidth=this.size,s.strokeStyle=this.color.toString(),this.useFlatLineEnds?(s.lineCap="butt",s.lineJoin="miter"):(s.lineCap="round",s.lineJoin="round"),s.beginPath(),s.moveTo(r.x,r.y),s.lineTo(n.x,n.y),s.stroke(),!1===this.isWarped&&this.world().broken.push(l),this.parent.cachedPenTrailsMorph=null)},y.prototype.floodFill=function(){if(this.parent.bounds.containsPoint(this.rotationCenter())){this.parent.cachedPenTrailsMorph=null,this.color.a>1&&(this.color.a=this.color.a/255);var t,e,i=(0,o.bl)(this.parent.penTrails()),s=i.width,r=i.height,n=i.getContext("2d"),a=n.getImageData(0,0,s,r),h=a.data,l=[Math.round(r/2-this.yPosition())*s+Math.round(this.xPosition()+s/2)];if((e=c(l[0]))[0]!==Math.round(this.color.r)||e[1]!==Math.round(this.color.g)||e[2]!==Math.round(this.color.b)||e[3]!==Math.round(255*this.color.a)){for(;l.length>0;)(p=c(t=l.pop()))[0]===e[0]&&p[1]===e[1]&&p[2]===e[2]&&p[3]===e[3]&&(t%s>1&&(l.push(t+1),l.push(t-1)),t>0&&t<r*s&&(l.push(t+s),l.push(t-s))),h[4*t]=Math.round(this.color.r),h[4*t+1]=Math.round(this.color.g),h[4*t+2]=Math.round(this.color.b),h[4*t+3]=Math.round(255*this.color.a);var p;n.putImageData(a,0,0),this.parent.changed()}}function c(t){var e=4*t;return[h[e],h[e+1],h[e+2],h[e+3]]}},y.prototype.reportPenTrailsAsCostume=function(){var t=new C(this.parentThatIsA(b).trailsCanvas,this.newCostumeName((0,o.NC)("Costume")));return t.shrinkWrap(),t.rotationCenter=t.rotationCenter.translateBy(new o.E9(this.xPosition(),-this.yPosition())),t},y.prototype.moveBy=function(t,e){var i=this.isDown&&!e&&this.parent?this.rotationCenter():null;y.uber.moveBy.call(this,t),i&&this.drawLine(i,this.rotationCenter()),e||(this.parts.forEach((e=>e.moveBy(t))),this.instances.forEach((e=>{if(e.cachedPropagation){var i=e.inheritsAttribute("x position"),s=e.inheritsAttribute("y position");i&&s?e.moveBy(t):i?e.moveBy(new o.E9(t.x,0)):s&&e.moveBy(new o.E9(0,t.y))}})))},y.prototype.rootForGrab=function(){return this.anchor?this.anchor.rootForGrab():y.uber.rootForGrab.call(this)},y.prototype.setCenter=function(t,e){var o=t.subtract(this.center());this.moveBy(o,e)},y.prototype.nestingBounds=function(){var t=this.bounds;return!this.costume&&this.penBounds&&(t=this.penBounds.translateBy(this.position())),this.parts.forEach((e=>{e.isVisible&&(t=t.merge(e.nestingBounds()))})),t},y.prototype.setPosition=function(t,e){var o=t.subtract(this.topLeft());0===o.x&&0===o.y||this.moveBy(o,e)},y.prototype.forward=function(t){var e,o=t*this.parent.scale||0;if(0===o&&this.isDown)return this.isDown=!1,this.forward(-.05),this.isDown=!0,this.forward(.1),this.isDown=!1,this.forward(-.05),void(this.isDown=!0);e=o>=0?this.position().distanceAngle(o,this.heading):this.position().distanceAngle(Math.abs(o),this.heading-180),this.shadowAttribute("x position"),this.shadowAttribute("y position"),this.setPosition(e),this.positionTalkBubble()},y.prototype.setHeading=function(t,e){var i=this.xPosition(),s=this.yPosition(),r=isFinite(t)?+t:0,n=r-this.heading;this.rotationStyle?(this.changed(),y.uber.setHeading.call(this,r),this.silentGotoXY(i,s,!0),this.positionTalkBubble()):this.heading=(+t%360+360)%360,this.parts.forEach((t=>{var e=new o.E9(t.xPosition(),t.yPosition()).rotateBy((0,o.uR)(n),new o.E9(i,s));t.rotatesWithAnchor&&t.turn(n),t.gotoXY(e.x,e.y)})),e||this.shadowAttribute("direction"),this.instances.forEach((e=>{e.cachedPropagation&&e.inheritsAttribute("direction")&&e.setHeading(t,!0)}))},y.prototype.faceToXY=function(t,e){this.setHeading(this.angleToXY(t,e))},y.prototype.angleToXY=function(t,e){var o=(t-this.xPosition())*this.parent.scale,i=(e-this.yPosition())*this.parent.scale;return(Math.abs(o)<.001?i<0?90:270:Math.round((o>=0?0:180)-57.2957795131*Math.atan(i/o)))+90},y.prototype.turn=function(t){this.setHeading(this.heading+(+t||0))},y.prototype.turnLeft=function(t){this.setHeading(this.heading-(+t||0))},y.prototype.xPosition=function(){if(this.inheritsAttribute("x position"))return this.exemplar.xPosition();var t=this.parentThatIsA(b);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(this.rotationCenter().x-t.center().x)/t.scale:this.rotationCenter().x},y.prototype.yPosition=function(){if(this.inheritsAttribute("y position"))return this.exemplar.yPosition();var t=this.parentThatIsA(b);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(t.center().y-this.rotationCenter().y)/t.scale:this.rotationCenter().y},y.prototype.direction=function(){return this.inheritsAttribute("direction")?this.exemplar.direction():this.heading},y.prototype.penSize=function(){return this.size},y.prototype.gotoXY=function(t,e,i,s){var r,n,a,h=this.parentThatIsA(b);h&&(s||(this.shadowAttribute("x position"),this.shadowAttribute("y position")),t=isFinite(+t)?+t:0,e=isFinite(+e)?+e:0,r=h.center().x+t*h.scale,n=h.center().y-e*h.scale,a=this.costume?new o.E9(r,n).subtract(this.rotationOffset):new o.E9(r,n).subtract(this.extent().divideBy(2)),this.setPosition(a,i),this.positionTalkBubble())},y.prototype.silentGotoXY=function(t,e,o){var i=this.isDown;this.isDown=!1,this.gotoXY(t,e,o,!0),this.isDown=i},y.prototype.setXPosition=function(t){this.shadowAttribute("x position"),this.gotoXY(+t||0,this.yPosition(),!1,!0)},y.prototype.changeXPosition=function(t){this.setXPosition(this.xPosition()+(+t||0))},y.prototype.setYPosition=function(t){this.shadowAttribute("y position"),this.gotoXY(this.xPosition(),+t||0,!1,!0)},y.prototype.changeYPosition=function(t){this.setYPosition(this.yPosition()+(+t||0))},y.prototype.glide=function(t,e,i,s,r){var n,a,h;a=new o.E9(e,i),n=Math.max(Math.min(s/t,1),0),h=r.add(a.subtract(r).multiplyBy(n)),this.gotoXY(h.x,h.y)},y.prototype.bounceOffEdge=function(){var t,e,i=this.parentThatIsA(b),s=this.nestingBounds();return i?i.bounds.containsRectangle(s)?null:(t=Math.cos((0,o.uR)(this.heading-90)),e=-Math.sin((0,o.uR)(this.heading-90)),s.left()<i.left()&&(t=Math.abs(t)),s.right()>i.right()&&(t=-Math.abs(t)),s.top()<i.top()&&(e=-Math.abs(e)),s.bottom()>i.bottom()&&(e=Math.abs(e)),this.shadowAttribute("x position"),this.shadowAttribute("y position"),this.shadowAttribute("direction"),this.setHeading((0,o.RW)(Math.atan2(-e,t))+90),this.setPosition(this.position().add(s.amountToTranslateWithin(i.bounds))),void this.positionTalkBubble()):null},y.prototype.snapPoint=function(t){var e=this.parentThatIsA(b),i=e.center();return new o.E9((t.x-i.x)/e.scale,(i.y-t.y)/e.scale)},y.prototype.setRotationX=function(t){this.setRotationCenter(new o.E9(t,this.yPosition()))},y.prototype.setRotationY=function(t){this.setRotationCenter(new o.E9(this.xPosition(),t))},y.prototype.setRotationCenter=function(t){var e,i;if(!this.costume)throw new Error("setting the rotation center requires a costume");e=t.subtract(new o.E9(this.xPosition(),this.yPosition())).divideBy(this.scale).rotateBy((0,o.uR)(90-this.heading)),i=this.costume.rotationCenter.add(new o.E9(e.x,-e.y)),this.costume.rotationCenter=i,this.changed(),this.fixLayout(),this.changed()},y.prototype.moveRotationCenter=function(){this.world().activeHandle=new o.LG(this,null,null,null,null,"movePivot")},y.prototype.setPivot=function(t){var e,i=this.parentThatIsA(b);i&&(e=i.center(),this.setRotationCenter(new o.E9((t.x-e.x)/i.scale,(e.y-t.y)/i.scale)))},y.prototype.xCenter=function(){var t=this.parentThatIsA(b);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(this.center().x-t.center().x)/t.scale:this.center().x},y.prototype.yCenter=function(){var t=this.parentThatIsA(b);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(t.center().y-this.center().y)/t.scale:this.center().y},y.prototype.xLeft=function(){var t=this.parentThatIsA(b);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(this.left()-t.center().x)/t.scale:this.left()},y.prototype.xRight=function(){var t=this.parentThatIsA(b);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(this.right()-t.center().x)/t.scale:this.right()},y.prototype.yTop=function(){var t=this.parentThatIsA(b);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(t.center().y-this.top())/t.scale:this.top()},y.prototype.yBottom=function(){var t=this.parentThatIsA(b);return!t&&this.parent.grabOrigin&&(t=this.parent.grabOrigin.origin),t?(t.center().y-this.bottom())/t.scale:this.bottom()},y.prototype.allMessageNames=function(){var t=[];return this.allScripts().forEach((e=>{e.allChildren().forEach((e=>{var i;e instanceof H&&e.choices&&(0,o.r3)(["messagesMenu","messagesReceivedMenu"],e.choices)&&(i=e.evaluate(),(0,o.HD)(i)&&""!==i&&((0,o.r3)(t,i)||t.push(i)))}))})),t},y.prototype.allSendersOf=function(t,e,o){return this.allScripts().filter((i=>i.isSending&&i.isSending(t,e,o)))},y.prototype.allHatBlocksFor=function(t){return"number"==typeof t&&(t=t.toString()),this.scripts.children.filter((e=>{var o;if(e.selector){if("receiveMessage"===e.selector)return(o=e.inputs()[0].evaluate())===t||o instanceof Array&&"__shout__go__"!==t&&"__clone__init__"!==t;if("receiveGo"===e.selector)return"__shout__go__"===t;if("receiveOnClone"===e.selector)return"__clone__init__"===t}return!1}))},y.prototype.allHatBlocksForKey=function(t){return this.scripts.children.filter((e=>{if(e.selector&&"receiveKey"===e.selector){var o=e.inputs()[0].evaluate()[0];return o===t||"any key"===o}return!1}))},y.prototype.allHatBlocksForInteraction=function(t){return this.scripts.children.filter((e=>!(!e.selector||"receiveInteraction"!==e.selector)&&e.inputs()[0].evaluate()[0]===t))},y.prototype.hasGenericHatBlocks=function(){return this.scripts.children.some((t=>"receiveCondition"===t.selector))},y.prototype.allGenericHatBlocks=function(){return this.scripts.children.filter((t=>!!t.selector&&"receiveCondition"===t.selector))},y.prototype.allScripts=function(){var t=this.scripts.children.slice();return this.customBlocks.forEach((e=>{e.body&&t.push(e.body.expression),e.scripts.forEach((e=>t.push(e)))})),this.globalBlocks&&this.globalBlocks.forEach((e=>{e.body&&t.push(e.body.expression),e.scripts.forEach((e=>t.push(e)))})),t},y.prototype.mouseClickLeft=function(){return this.receiveUserInteraction("clicked")},y.prototype.mouseEnter=function(){return this.receiveUserInteraction("mouse-entered")},y.prototype.mouseDownLeft=function(){return this.receiveUserInteraction("pressed")},y.prototype.mouseScroll=function(t){return this.receiveUserInteraction("scrolled-"+(t>0?"up":"down"))},y.prototype.receiveUserInteraction=function(t,e,o){var i=this.parentThatIsA(b),s=[];if(i)return this.allHatBlocksForInteraction(t).forEach((r=>s.push(i.threads.startProcess(r,this,o||i.isThreadSafe,null,null,null,e,"stopped"===t)))),s},y.prototype.mouseDoubleClick=function(){this.isTemporary||this.edit()},y.prototype.getTimer=function(){var t=this.parentThatIsA(b);return t?t.getTimer():0},y.prototype.getTempo=function(){var t=this.parentThatIsA(b);return t?t.getTempo():0},y.prototype.getLastMessage=function(){var t=this.parentThatIsA(b);return t?t.getLastMessage():""},y.prototype.getLastAnswer=function(){return this.parentThatIsA(b).lastAnswer},y.prototype.reportMouseX=function(){var t=this.parentThatIsA(b);return t?t.reportMouseX():0},y.prototype.reportMouseY=function(){var t=this.parentThatIsA(b);return t?t.reportMouseY():0},y.prototype.reportThreadCount=function(){var t=this.parentThatIsA(b);return t?t.threads.processes.length:0},y.prototype.refactorVariableInstances=function(t,e,o){o&&this.hasSpriteVariable(t)||this.scripts.children.forEach((o=>{o instanceof A&&o.refactorVarInStack(t,e)}))},y.prototype.findVariableWatcher=function(t){var e=this.parentThatIsA(b),i=this.globalVariables();return null===e?null:(0,o.qY)(e.children,(e=>e instanceof B&&(e.target===this.variables||e.target===i)&&e.getter===t))},y.prototype.toggleVariableWatcher=function(t,e){var i,s,r=this.parentThatIsA(b),n=this.parentThatIsA(Kt),a=this.globalVariables();return null===r?null:((0,o.kK)(e)&&(e=(0,o.r3)(a.names(),t)),null!==(i=this.findVariableWatcher(t))?(i.isVisible?i.hide():(i.show(),i.fixLayout(),i.keepWithin(r)),void(e&&(n.flushBlocksCache("variables"),n.refreshPalette()))):((i=new B(t,this.blockColor.variables,e?a:this.variables,t)).setPosition(r.position().add(10)),(s=r.watchers(i.left())).length>0&&i.setTop(s[s.length-1].bottom()),i.fixLayout(),i.keepWithin(r),r.add(i),i.changed(),i))},y.prototype.showingVariableWatcher=function(t){var e;return null!==this.parentThatIsA(b)&&!!(e=this.findVariableWatcher(t))&&e.isVisible},y.prototype.deleteVariableWatcher=function(t){var e;if(null===this.parentThatIsA(b))return null;null!==(e=this.findVariableWatcher(t))&&e.destroy()},y.prototype.toggleWatcher=function(t,e,o){var i,s,r=this.parentThatIsA(b),n=this.parentThatIsA(Kt);if(r){if(i=this.watcherFor(r,t))return i.isVisible?i.hide():(i.show(),i.fixLayout(),i.keepWithin(r)),void(i.isGlobal(t)&&(n.flushBlocksCache(),n.refreshPalette()));(i=new B(e,o,B.prototype.isGlobal(t)?r:this,t)).setPosition(r.position().add(10)),(s=r.watchers(i.left())).length>0&&i.setTop(s[s.length-1].bottom()),r.add(i),i.fixLayout(),i.keepWithin(r),i.changed(),i.isGlobal(t)&&(n.flushBlocksCache(),n.refreshPalette())}},y.prototype.showingWatcher=function(t){var e,o=this.parentThatIsA(b);return null!==o&&!!(e=this.watcherFor(o,t))&&e.isVisible},y.prototype.watcherFor=function(t,e){return(0,o.qY)(t.children,(o=>o instanceof B&&o.getter===e&&o.target===(o.isGlobal(e)?t:this)))},y.prototype.deleteAllBlockInstances=function(t){var e;(t.isGlobal?this.allBlockInstances(t):this.allIndependentInvocationsOf(t.blockSpec())).forEach((t=>t.deleteBlock())),t.isGlobal?(e=this.parentThatIsA(b))&&(e.globalBlocks.forEach((t=>t.purgeCorpses())),e.children.concat(e).forEach((t=>{t.isSnapObject&&t.customBlocks.forEach((t=>t.purgeCorpses()))}))):this.allSpecimens().concat(this).forEach((t=>t.customBlocks.forEach((t=>t.purgeCorpses()))))},y.prototype.allBlockInstances=function(t){var e,o,i,s=[];return t.isGlobal?((o=(e=this.parentThatIsA(b)).children.filter((t=>t instanceof y))).push(e),o.forEach((e=>s=s.concat(e.allLocalBlockInstances(t)))),i=[],e.globalBlocks.forEach((e=>{e.scripts.forEach((e=>e.allChildren().forEach((e=>{e.isCustomBlock&&e.definition===t&&i.push(e)})))),e.body&&e.body.expression.allChildren().forEach((e=>{e.isCustomBlock&&e.definition===t&&i.push(e)}))})),s.concat(i)):this.allLocalBlockInstances(t)},y.prototype.allIndependentInvocationsOf=function(t){var e;return this.exemplar&&this.exemplar.getMethod(t)?[]:(e=this.allInvocationsOf(t),this.instances.forEach((o=>o.addAllInvocationsOf(t,e))),e)},y.prototype.allDependentInvocationsOf=function(t){var e;return e=this.allInvocationsOf(t),this.instances.forEach((o=>o.addAllInvocationsOf(t,e))),e},y.prototype.allInvocationsOf=function(t){var e,o,i;return e=this.scripts.allChildren().filter((e=>e.isCustomBlock&&!e.isGlobal&&e.blockSpec===t)),o=[],this.customBlocks.forEach((e=>{e.scripts.forEach((e=>e.allChildren().forEach((e=>{e.isCustomBlock&&!e.isGlobal&&e.blockSpec===t&&o.push(e)})))),e.body&&e.body.expression.allChildren().forEach((e=>{e.isCustomBlock&&!e.isGlobal&&e.blockSpec===t&&o.push(e)}))})),i=this.allEditorBlockInstances(null,t),e.concat(o).concat(i)},y.prototype.addAllInvocationsOf=function(t,e){this.getLocalMethod(t)||(this.allInvocationsOf(t).forEach((t=>e.push(t))),this.instances.forEach((o=>o.addAllInvocationsOf(t,e))))},y.prototype.allLocalBlockInstances=function(t){var e,o,i,s,r;return e=this.scripts.allChildren().filter((e=>e.isCustomBlock&&e.definition===t)),o=[],this.customBlocks.forEach((e=>{e.body&&e.body.expression.allChildren().forEach((e=>{e.isCustomBlock&&e.definition===t&&o.push(e)}))})),i=this.allEditorBlockInstances(t),s=this.paletteBlockInstance(t),r=e.concat(o).concat(i),s&&r.push(s),r},y.prototype.allEditorBlockInstances=function(t,e){var o=[];return this.world()?(this.world().children.forEach((i=>{i instanceof BlockEditorMorph&&i.body.contents.allChildren().forEach((i=>{t?i.isPrototype||i instanceof PrototypeHatBlockMorph||i.definition!==t||o.push(i):!i.isCustomBlock||i.isGlobal||i.isPrototype||i instanceof PrototypeHatBlockMorph||i.blockSpec!==e||o.push(i)}))})),o):[]},y.prototype.paletteBlockInstance=function(t){var e=this.parentThatIsA(Kt);return e?(0,o.qY)(e.palette.contents.children,(e=>e.isCustomBlock&&e.definition===t)):null},y.prototype.usesBlockInstance=function(t,e,i,s){var r;return!!(0,o.qY)(this.scripts.allChildren(),(e=>e.isCustomBlock&&e.definition===t))||!!(t.isGlobal&&!i&&(r=[],this.parentThatIsA(b).globalBlocks.forEach((i=>{e&&t===i||s&&(0,o.r3)(s,i)||i.body&&i.body.expression.allChildren().forEach((e=>{e.isCustomBlock&&e.definition===t&&r.push(e)}))})),r.length>0))||(r=[],this.customBlocks.forEach((e=>{e.body&&e.body.expression.allChildren().forEach((e=>{e.isCustomBlock&&e.definition===t&&r.push(e)}))})),r.length>0)},y.prototype.doubleDefinitionsFor=function(t){var e,o,i,s=t.blockSpec();if(t.isGlobal){if(!(i=this.parentThatIsA(b)))return[];e=i.globalBlocks}else e=this.customBlocks;return-1===(o=e.indexOf(t))?[]:e.filter(((t,e)=>t.blockSpec()===s&&e!==o))},y.prototype.replaceDoubleDefinitionsFor=function(t){var e,i,s=this.doubleDefinitionsFor(t);s.forEach((e=>this.allBlockInstances(e).forEach((e=>{e.definition=t,e.refresh()})))),t.isGlobal?(e=this.parentThatIsA(b)).globalBlocks=e.globalBlocks.filter((t=>!(0,o.r3)(s,t))):this.customBlocks=this.customBlocks.filter((t=>!(0,o.r3)(s,t))),(i=this.parentThatIsA(Kt))&&(i.flushPaletteCache(),i.refreshPalette())},y.prototype.pauseGenericHatBlocks=function(){var t=this.parentThatIsA(b),e=this.parentThatIsA(Kt);this.hasGenericHatBlocks()&&(t.enableCustomHatBlocks=!0,t.threads.pauseCustomHatBlocks=!0,e.controlBar.stopButton.refresh())},y.prototype.chooseExemplar=function(){var t,e=this.parentThatIsA(b).children.filter((t=>t instanceof y&&!t.isTemporary&&!(0,o.r3)(t.allExemplars(),this)));t=new o.wR((t=>this.setExemplar(t)),(0,o.NC)("current parent")+":\n"+(this.exemplar?this.exemplar.name:(0,o.NC)("none"))),e.forEach((e=>t.addItem(e.name,e,null,null,null,null,null,null,!0))),t.addLine(),t.addItem((0,o.NC)("none"),null),t.popUpAtHand(this.world())},y.prototype.setExemplar=function(t,e){var i;if(t instanceof y&&(0,o.r3)(t.allExemplars(),this)){if(e)throw new Error((0,o.NC)("unable to inherit\n(disabled or circular?)"))}else this.emancipate(),this.exemplar=t,t?(this.variables.parentFrame=t.variables,t.addSpecimen(this)):this.variables.parentFrame=this.globalVariables(),this.isTemporary?this.cloneOriginName=t.cloneOriginName||t.name:(i=this.parentThatIsA(Kt))&&(i.flushBlocksCache(),i.refreshPalette())},y.prototype.prune=function(){this.instances.forEach((t=>{t.shadowAllAttributes(),t.shadowAllMethods(),t.shadowAllVars(),t.exemplar=null})),this.instances=[]},y.prototype.emancipate=function(){this.exemplar&&(this.isTemporary||(this.shadowAllAttributes(),this.shadowAllMethods(),this.shadowAllVars()),this.exemplar.removeSpecimen(this),this.exemplar=null)},y.prototype.allExemplars=function(){for(var t=[],e=this;!(0,o.kK)(e);)t.push(e),e=e.exemplar;return t},y.prototype.specimens=function(){return this.instances},y.prototype.allSpecimens=function(){var t=this.instances.slice();return this.instances.forEach((e=>t.push.apply(t,e.allSpecimens()))),t},y.prototype.addSpecimen=function(t){this.instances.push(t)},y.prototype.removeSpecimen=function(t){var e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1)},y.prototype.inheritsAttribute=function(t){return!(0,o.kK)(this.exemplar)&&(0,o.r3)(this.inheritedAttributes,t)},y.prototype.updatePropagationCache=function(){this.cachedPropagation=!(0,o.kK)(this.exemplar)&&(0,o.qY)(["x position","y position","direction","size","costume #","volume","balance","shown?","pen down?"],(t=>(0,o.r3)(this.inheritedAttributes,t)))},y.prototype.shadowedAttributes=function(){var t=this.inheritedAttributes;return this.attributes.filter((e=>!(0,o.r3)(t,e)))},y.prototype.shadowAllAttributes=function(){this.attributes.forEach((t=>this.shadowAttribute(t)))},y.prototype.shadowAttribute=function(t){var e,i,s,r;this.inheritsAttribute(t)&&(e=this.parentThatIsA(Kt),this.inheritedAttributes=this.inheritedAttributes.filter((e=>e!==t)),"costumes"===t?(i=new d,this.costumes.asArray().forEach((t=>{var e=t.copy();i.add(e),t===this.costume&&this.wearCostume(e)})),this.costumes=i,this.instances.forEach((t=>{t.inheritsAttribute("costumes")&&t.refreshInheritedAttribute("costumes")}))):"sounds"===t?(s=new d,this.sounds.asArray().forEach((t=>s.add(t.copy()))),this.sounds=s,this.instances.forEach((t=>{t.inheritsAttribute("sounds")&&t.refreshInheritedAttribute("sounds")}))):"scripts"===t?(e.stage.threads.stopAllForReceiver(this),r=this.scripts.position(),this.scripts=this.exemplar.scripts.fullCopy(),e&&(0,o.r3)(e.currentSprite.allExemplars(),this)&&(e.createSpriteEditor(),e.fixLayout("selectSprite"),this.scripts.fixMultiArgs(),this.scripts.setPosition(r),e.spriteEditor.adjustScrollBars()),this.instances.forEach((t=>{t.inheritsAttribute("scripts")&&t.refreshInheritedAttribute("scripts")}))):(this.updatePropagationCache(),e&&!this.isTemporary&&(e.flushBlocksCache(),e.refreshPalette())))},y.prototype.inheritAttribute=function(t){var e=this.parentThatIsA(Kt);this.exemplar&&(0,o.r3)(this.attributes,t)&&(this.inheritsAttribute(t)||(this.inheritedAttributes.push(t),this.refreshInheritedAttribute(t),e&&(e.flushBlocksCache(),e.refreshPalette())))},y.prototype.refreshInheritedAttribute=function(t){var e,i;switch(t){case"x position":case"y position":this.cachedPropagation=!0,this.gotoXY(this.xPosition(),this.yPosition(),!1,!0);break;case"direction":this.cachedPropagation=!0,this.setHeading(this.direction(),!0);break;case"size":this.cachedPropagation=!0,this.setScale(this.getScale(),!0);break;case"costume #":this.cachedPropagation=!0,this.inheritsAttribute("costumes")?this.wearCostume(this.exemplar.costume,!0):this.doSwitchToCostume(this.getCostumeIdx(),!0);break;case"volume":this.cachedPropagation=!0,this.setVolume(this.getVolume(),!0);break;case"shown?":this.cachedPropagation=!0,this.setVisibility(this.reportShown(),!0);break;case"pen down?":this.cachedPropagation=!0,this.setPenDown(this.getPenDown(),!0);break;case"balance":this.cachedPropagation=!0,this.setPan(this.getPan(),!0);break;case"costumes":i=this.getCostumeIdx(),this.costumes=this.exemplar.costumes,this.doSwitchToCostume(i,!0),this.instances.forEach((t=>{t.inheritsAttribute("costumes")&&t.refreshInheritedAttribute("costumes")}));break;case"sounds":this.sounds=this.exemplar.sounds,this.instances.forEach((t=>{t.inheritsAttribute("sounds")&&t.refreshInheritedAttribute("sounds")}));break;case"scripts":this.scripts=this.exemplar.scripts,(e=this.parentThatIsA(Kt))&&(e.stage.threads.stopAllForReceiver(this),(0,o.r3)(e.currentSprite.allExemplars(),this)&&(e.createSpriteEditor(),e.fixLayout("selectSprite"))),this.instances.forEach((t=>{t.inheritsAttribute("scripts")&&t.refreshInheritedAttribute("scripts")}));break;default:(0,o.WY)()}},y.prototype.toggleInheritanceForAttribute=function(t){this.inheritsAttribute(t)?this.shadowAttribute(t):this.inheritAttribute(t)},y.prototype.isVariableNameInUse=function(t,e){return e?(0,o.r3)(this.variables.allNames(),t):!!(0,o.r3)(this.variables.names(),t)||(0,o.r3)(this.globalVariables().names(),t)},y.prototype.globalVariables=function(){for(var t=this.variables.parentFrame;t.owner;)t=t.parentFrame;return t},y.prototype.shadowAllVars=function(){this.inheritedVariableNames().forEach((t=>this.shadowVar(t,this.variables.getVar(t))))},y.prototype.shadowVar=function(t,e){var o;this.variables.addVar(t,e),this.isTemporary||(o=this.parentThatIsA(Kt))&&(o.flushBlocksCache("variables"),o.refreshPalette())},y.prototype.toggleInheritedVariable=function(t){(0,o.r3)(this.inheritedVariableNames(!0),t)?this.deleteVariable(t):(0,o.r3)(this.inheritedVariableNames(),t)&&this.shadowVar(t,this.variables.getVar(t))},y.prototype.inheritedVariableNames=function(t){var e=[],i=this.variables.names(),s=this.variables.parentFrame;function r(e){return t?(0,o.r3)(i,e):!(0,o.r3)(i,e)}for(;s.owner instanceof y;)e.push.apply(e,s.names().filter(r)),s=s.parentFrame;return e},y.prototype.deletableVariableNames=function(){var t=this.variables.names(),e=this.inheritedVariableNames();return t.concat(this.globalVariables().names().filter((i=>!(0,o.r3)(t,i)&&!(0,o.r3)(e,i))))},y.prototype.hasSpriteVariable=function(t){return(0,o.r3)(this.variables.names(),t)},y.prototype.allLocalVariableNames=function(t){var e;return e=this.variables.names(),t&&e.sort((function(t,e){return t.toLowerCase()<e.toLowerCase()?-1:1})),e},y.prototype.reachableGlobalVariableNames=function(t){var e,i=this.allLocalVariableNames();return e=this.globalVariables().names().filter((t=>!(0,o.r3)(i,t))),t&&e.sort((function(t,e){return t.toLowerCase()<e.toLowerCase()?-1:1})),e},y.prototype.getMethod=function(t){return this.allBlocks()[t]},y.prototype.getLocalMethod=function(t){return this.ownBlocks()[t]},y.prototype.ownBlocks=function(){var t={};return this.customBlocks.forEach((e=>t[e.blockSpec()]=e)),t},y.prototype.allBlocks=function(t){var e={};return this.allExemplars().reverse().forEach((t=>t.customBlocks.forEach((t=>e[t.blockSpec()]=t)))),t?Object.keys(e).map((t=>e[t])):e},y.prototype.inheritedBlocks=function(t){var e={},i=Object.keys(this.ownBlocks()),s=this.allExemplars().reverse();return s.pop(),s.forEach((t=>t.customBlocks.forEach((t=>{var s=t.blockSpec();(0,o.r3)(i,s)||(e[s]=t)})))),t?Object.keys(e).map((t=>e[t])):e},y.prototype.shadowAllMethods=function(){var t;this.inheritedMethods().forEach((t=>this.customBlocks.push(t))),this.isTemporary||(t=this.parentThatIsA(Kt))&&(t.flushPaletteCache(),t.refreshPalette())},y.prototype.inheritedMethods=function(){return this.inheritedBlocks(!0).map((t=>t.copyAndBindTo(this,!0)))},y.prototype.thumbnail=function(t,e){var i=this.getImage(),s=this.width(),r=this.height(),n=Math.min(t.x/s,t.y/r),a=(t.x-s*n)/2,h=(t.y-r*n)/2,l=(0,o.oM)(t,!1,e),p=l.getContext("2d");function c(e,o,i){var s=Math.min(t.x,t.y)/10;p.strokeStyle=e,p.globalAlpha=o,p.compositeOperation="lighter",p.lineWidth=i||1,p.moveTo(s,s),p.lineTo(l.width-s,l.height-s),p.moveTo(s,l.height-s),p.lineTo(l.width-s,s),p.stroke()}return p.save(),this.isCorpse&&(p.globalAlpha=.3),s&&r&&i.width&&i.height&&(p.scale(n,n),p.drawImage(i,Math.floor(a/n),Math.floor(h/n))),this.isCorpse&&(p.restore(),c("white",.8,6),c("black",.8,1)),p.restore(),l},y.prototype.fullThumbnail=function(t,e){var o=this.thumbnail(t,e),i=o.getContext("2d"),s=t.divideBy(3),r=0;for(i.restore(),this.anchor&&i.drawImage(this.anchor.thumbnail(s),0,0),r=0;r<3;r+=1)this.parts[r]&&i.drawImage(this.parts[r].thumbnail(s),r*s.x,t.y-s.y);return o},y.prototype.booleanMorph=function(t){var e=new q(t);return e.isStatic=!0,e.fixLayout(),e},y.prototype.attachTo=function(t){t.attachPart(this)},y.prototype.attachPart=function(t){var e=Date.now();t.anchor&&t.anchor.detachPart(t),this.parts.push(t),this.version=e,t.anchor=this,this.allParts().forEach((t=>t.nestingScale=t.scale)),t.version=e},y.prototype.detachPart=function(t){var e,o=this.parts.indexOf(t);-1!==o&&(e=Date.now(),this.parts.splice(o,1),this.version=e,t.anchor=null,t.version=e)},y.prototype.detachAllParts=function(){var t=Date.now();this.parts.forEach((e=>{e.anchor=null,e.version=t})),this.parts=[],this.version=t},y.prototype.detachFromAnchor=function(){this.anchor&&this.anchor.detachPart(this)},y.prototype.allParts=function(){var t=[this];return this.parts.forEach((e=>t=t.concat(e.allParts()))),t},y.prototype.allAnchors=function(){var t=[this];return null!==this.anchor&&(t=t.concat(this.anchor.allAnchors())),t},y.prototype.recordLayers=function(){var t=this.parentThatIsA(b);t?(this.layers=this.allParts(),this.layers.forEach((t=>{var e=t.talkBubble();e&&e.hide()})),this.layers.sort(((e,o)=>t.children.indexOf(e)<t.children.indexOf(o)?-1:1))):this.layerCache=null},y.prototype.restoreLayers=function(){this.layers&&this.layers.length>1&&this.layers.forEach((t=>{t.comeToFront(),t.positionTalkBubble()})),this.layers=null},y.prototype.destroy=function(){this.anchor&&this.anchor.detachPart(this),this.emancipate(),this.isTemporary||this.prune(),y.uber.destroy.call(this)},y.prototype.flash=function(){var t=this.world();this.addHighlight(),t.animations.push(new o.fw(o.WY,o.WY,0,800,o.WY,(()=>this.removeHighlight())))},y.prototype.addHighlight=function(t){var e,o=!this.isVisible;return o&&this.show(),e=this.highlight(t?t.color:this.highlightColor,this.highlightBorder),this.addBack(e),this.fullChanged(),o&&this.hide(),e},y.prototype.removeHighlight=function(){var t=this.getHighlight();return null!==t&&(this.fullChanged(),this.removeChild(t)),t},y.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()},y.prototype.highlight=function(t,e){var i,s=new m,r=this.bounds,n=e;return s.bounds.setExtent(r.extent().add(2*n)),s.color=t,s.cachedImage=this.highlightImage(t,e),(i=s.cachedImage.getContext("2d")).drawImage(this.highlightImage(o.Cj,4),e-4,e-4),i.drawImage(this.highlightImage(new o.Il(50,50,50),2),e-2,e-2),i.drawImage(this.highlightImage(o.Cj,1),e-1,e-1),s.setPosition(r.origin.subtract(new o.E9(n,n))),s},y.prototype.highlightImage=function(t,e){var i,s,r,n,a;return i=this.extent(),s=this.getImage(),(n=(r=(0,o.oM)(i.add(2*e))).getContext("2d")).drawImage(s,0,0),n.drawImage(s,e,0),n.drawImage(s,2*e,0),n.drawImage(s,2*e,e),n.drawImage(s,2*e,2*e),n.drawImage(s,e,2*e),n.drawImage(s,0,2*e),n.drawImage(s,0,e),n.globalCompositeOperation="destination-out",n.drawImage(s,e,e),(n=(a=(0,o.oM)(i.add(2*e))).getContext("2d")).drawImage(r,0,0),n.globalCompositeOperation="source-atop",n.fillStyle=t.toString(),n.fillRect(0,0,a.width,a.height),a},y.prototype.getHighlight=function(){var t=this.children.slice(0).reverse().filter((t=>t instanceof m));return 0!==t.length?t[0]:null},y.prototype.mouseEnterDragging=function(){var t;this.enableNesting&&(t=this.world().hand.children[0],this.wantsDropOf(t)&&this.addHighlight())},y.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed"),this.enableNesting&&this.removeHighlight()},y.prototype.wantsDropOf=function(t){return this.enableNesting&&t instanceof SpriteIconMorph&&!(0,o.r3)(t.object.allParts(),this)},y.prototype.reactToDropOf=function(t,e){this.removeHighlight(),this.attachPart(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin)},y.prototype.newCostumeName=function(t,e){for(var i=t.indexOf("("),s=i<0?t:t.substring(0,i),r=1,n=s,a=this.costumes.asArray().filter((t=>t!==e)).map((t=>t.name));(0,o.r3)(a,n);)n=s+"("+(r+=1)+")";return n},y.prototype.doScreenshot=function(t,e){var o,i=this.parentThatIsA(b);e=this.newCostumeName(e),void 0!==t[0]&&("pen trails"===t[0]?o=new C(i.trailsCanvas,e).copy():"stage image"===t[0]&&(o=new C(i.fullImage(),e)),this.addCostume(o))},y.prototype.newSoundName=function(t,e){for(var i=t.indexOf("("),s=i<0?t:t.substring(0,i),r=1,n=s,a=this.sounds.asArray().filter((t=>t!==e)).map((t=>t.name));(0,o.r3)(a,n);)n=s+"("+(r+=1)+")";return n},m.prototype=new o._V,m.prototype.constructor=m,m.uber=o._V.prototype,m.prototype.init=function(){m.uber.init.call(this),this.isCachingImage=!0},b.prototype=new o.xZ,b.prototype.constructor=b,b.uber=o.xZ.prototype,b.prototype.dimensions=new o.E9(480,360),b.prototype.frameRate=0,b.prototype.isCachingPrimitives=y.prototype.isCachingPrimitives,b.prototype.sliderColor=y.prototype.sliderColor,b.prototype.paletteTextColor=y.prototype.paletteTextColor,b.prototype.hiddenPrimitives={},b.prototype.codeMappings={},b.prototype.codeHeaders={},b.prototype.enableCodeMapping=!1,b.prototype.enableInheritance=!0,b.prototype.enableSublistIDs=!1,b.prototype.enablePenLogging=!1,b.prototype.init=function(t){this.name=(0,o.NC)("Stage"),this.guid="testGUID",this.instrument=null,this.threads=new n,this.variables=new p(t||null,this),this.scripts=new N,this.customBlocks=[],this.globalBlocks=[],this.costumes=new d,this.costume=null,this.sounds=new d,this.version=Date.now(),this.isFastTracked=!1,this.enableCustomHatBlocks=!0,this.cloneCount=0,this.timerStart=Date.now(),this.tempo=60,this.lastMessage="",this.volume=100,this.gainNode=null,this.pan=0,this.pannerNode=null,this.freqPlayer=null,this.watcherUpdateFrequency=2,this.lastWatcherUpdate=Date.now(),this.scale=1,this.cachedHSV=[0,0,0],this.keysPressed={},this.blocksCache={},this.paletteCache={},this.lastAnswer="",this.activeSounds=[],this.trailsCanvas=null,this.trailsLog=[],this.isThreadSafe=!1,this.microphone=new M,this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0},this.cachedPenTrailsMorph=null,this.remixID=null,this.projectionSource=null,this.getProjectionImage=null,this.stopProjectionSource=null,this.continuousProjection=!1,this.projectionCanvas=null,this.projectionTransparency=50,this.mirrorVideo=!0,this.videoMotion=null,this.worldMap=new f,this.messageCallbacks={},b.uber.init.call(this),this.isCachingImage=!0,this.cachedHSV=this.color.hsv(),this.acceptsDrops=!1,this.setColor(new o.Il(255,255,255)),this.fps=this.frameRate},b.prototype.setScale=function(t){var e,o,i=t/this.scale,s=this.position();1!==i&&(this.cachedPenTrailsMorph=null,this.scale=t,this.setExtent(this.dimensions.multiplyBy(t)),this.children.forEach((r=>{e=r.position().subtract(s),r.fixLayout(),r.setPosition(e.multiplyBy(i).add(s),!0),r instanceof y?(r.rerender(),(o=r.talkBubble())&&(o.setScale(t),r.positionTalkBubble())):r instanceof P&&(this.scale<1?r.setWidth(this.width()-10):r.setWidth(this.dimensions.x-20),r.setCenter(this.center()),r.setBottom(this.bottom()))})))},b.prototype.moveBy=function(t){var e=this.children,o=e.length;for(this.changed(),this.bounds=this.bounds.translateBy(t),this.changed();o>0;o-=1)e[o-1].moveBy(t,!0)},b.prototype.render=function(t){t.save(),t.fillStyle=this.color.toString(),t.fillRect(0,0,this.width(),this.height()),this.costume&&(t.scale(this.scale,this.scale),t.drawImage(this.costume.contents,(this.width()/this.scale-this.costume.width())/2,(this.height()/this.scale-this.costume.height())/2),this.cachedImage=this.applyGraphicsEffects(this.cachedImage)),t.restore(),this.version=Date.now()},b.prototype.drawOn=function(t,e){var i,s,r,n,a,h,l,p,c=e.intersect(this.bounds);this.isVisible&&c.extent().gt(o.xE)&&(b.uber.drawOn.call(this,t,e),i=this.position(),a=(s=c.translateBy(i.neg())).left(),h=s.top(),r=s.width(),n=s.height(),l=r/this.scale,p=n/this.scale,t.save(),t.scale(this.scale,this.scale),this.projectionSource&&(t.globalAlpha=1-this.projectionTransparency/100,t.drawImage(this.projectionLayer(),a/this.scale,h/this.scale,l,p,c.left()/this.scale,c.top()/this.scale,l,p),this.version=Date.now()),t.globalAlpha=1,t.drawImage(this.penTrails(),a/this.scale,h/this.scale,l,p,c.left()/this.scale,c.top()/this.scale,l,p),t.restore())},b.prototype.clearPenTrails=function(){this.cachedPenTrailsMorph=null,this.trailsCanvas=(0,o.oM)(this.dimensions,null,this.trailsCanvas),this.trailsLog=[],this.changed()},b.prototype.penTrails=function(){return this.trailsCanvas||(this.trailsCanvas=(0,o.oM)(this.dimensions)),this.trailsCanvas},b.prototype.penTrailsMorph=function(){var t,e;return this.cachedPenTrailsMorph?this.cachedPenTrailsMorph:((t=new o._V).isCachingImage=!0,e=this.penTrails(),t.bounds=this.bounds.copy(),t.cachedImage=(0,o.oM)(this.extent(),!0),t.cachedImage.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,this.width(),this.height()),this.cachedPenTrailsMorph=t,t)},b.prototype.projectionLayer=function(){return this.projectionCanvas||(this.projectionCanvas=(0,o.oM)(this.dimensions,!0)),this.projectionCanvas},b.prototype.clearProjectionLayer=function(){this.projectionCanvas=null,this.changed()},b.prototype.startVideo=function(){var t=this;function e(){var e=new lt;e.inform((0,o.NC)("Camera not supported"),(0,o.NC)('Please make sure your web browser is up to date\nand your camera is properly configured. \n\nSome browsers also require you to access Snap!\nthrough HTTPS to use the camera.\n\nPlease replace the "http://" part of the address\nin your browser by "https://" and try again.'),this.world),e.fixLayout(),t.projectionSource&&(t.projectionSource.remove(),t.projectionSource=null)}this.projectionSource||(this.projectionSource=document.createElement("video"),this.projectionSource.width=this.dimensions.x,this.projectionSource.height=this.dimensions.y,this.projectionSource.hidden=!0,document.body.appendChild(this.projectionSource),this.videoMotion||(this.videoMotion=new VideoMotion(this.dimensions.x,this.dimensions.y)),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then((function(o){t.getProjectionImage=t.getVideoImage,t.stopProjectionSource=t.stopVideo,t.continuousProjection=!0,t.projectionSource.srcObject=o,t.projectionSource.play().catch(e),t.projectionSource.stream=o})).catch(e))},b.prototype.getVideoImage=function(){return this.projectionSource},b.prototype.stopVideo=function(){this.projectionSource&&this.projectionSource.stream&&this.projectionSource.stream.getTracks().forEach((t=>t.stop())),this.videoMotion=null},b.prototype.stopProjection=function(){this.projectionSource&&(this.stopProjectionSource(),this.projectionSource.remove(),this.projectionSource=null,this.continuousProjection=!1),this.clearProjectionLayer()},b.prototype.projectionSnap=function(){var t=(0,o.oM)(this.dimensions,!0);return t.getContext("2d").drawImage(this.projectionLayer(),0,0),new C(t,this.newCostumeName((0,o.NC)("snap")))},b.prototype.getPixelColor=function(t){var e,i;if(this.trailsCanvas)return e=t.subtract(this.bounds.origin),0===(i=this.penTrailsMorph().getImage().getContext("2d").getImageData(e.x,e.y,1,1)).data[3]?this.projectionCanvas?(e=e.divideBy(this.scale),i=this.projectionCanvas.getContext("2d").getImageData(e.x,e.y,1,1),new o.Il(i.data[0],i.data[1],i.data[2],i.data[3]/255)):b.uber.getPixelColor.call(this,t):new o.Il(i.data[0],i.data[1],i.data[2],i.data[3]/255)},b.prototype.watchers=function(t){return this.children.filter((e=>e instanceof B&&(t?e.left()===t:e.isVisible)))},b.prototype.resetTimer=function(){this.timerStart=Date.now()},b.prototype.getTimer=function(){return Math.floor((Date.now()-this.timerStart)/100)/10},b.prototype.setTempo=function(t){this.tempo=Math.max(20,+t||0)},b.prototype.changeTempo=function(t){this.setTempo(this.getTempo()+(+t||0))},b.prototype.getTempo=function(){return+this.tempo},b.prototype.getLastMessage=function(){return this.lastMessage||""},b.prototype.reportMouseX=function(){var t=this.world();return t?(t.hand.position().x-this.center().x)/this.scale:0},b.prototype.reportMouseY=function(){var t=this.world();return t?(this.center().y-t.hand.position().y)/this.scale:0},b.prototype.reactToDropOf=function(t,e){t instanceof SpriteIconMorph&&(t.object.anchor&&t.object.anchor.detachPart(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin))},b.prototype.step=function(){var t,e,o=this.world();if(null===o.keyboardFocus&&(o.keyboardFocus=this),null===o.currentKey&&(this.keyPressed=null),this.enableCustomHatBlocks&&this.stepGenericConditions(),this.isFastTracked&&this.threads.processes.length){for(;this.isFastTracked&&Date.now()-this.lastTime<15;)this.threads.step();this.changed()}else this.threads.step(),this.threads.wantsToPause&&(e=this.parentThatIsA(Kt))&&e.controlBar.pauseButton.refresh();t=Date.now()-this.lastWatcherUpdate,1e3/this.watcherUpdateFrequency-t<1&&(this.watchers().forEach((t=>t.update())),this.lastWatcherUpdate=Date.now()),this.continuousProjection&&this.projectionSource&&this.updateProjection()},b.prototype.updateProjection=function(){var t=this.projectionLayer().getContext("2d");t.save(),this.mirrorVideo&&(t.translate(this.dimensions.x,0),t.scale(-1,1)),t.drawImage(this.getProjectionImage(),0,0,this.projectionSource.width,this.projectionSource.height),this.videoMotion&&this.videoMotion.addFrame(t.getImageData(0,0,this.projectionSource.width,this.projectionSource.height).data),t.restore(),this.changed()},b.prototype.stepGenericConditions=function(t){var e,o=0;this.children.concat(this).forEach((e=>{g(e)&&e.allGenericHatBlocks().forEach((i=>{o+=1,this.threads.doWhen(i,e,t)}))})),o||(this.enableCustomHatBlocks=!1,(e=this.parentThatIsA(Kt))&&e.controlBar.stopButton.refresh())},b.prototype.developersMenu=function(){var t=b.uber.developersMenu.call(this);return t.addItem("stop",(()=>this.threads.stopAll()),"terminate all running threads"),t},b.prototype.processKeyDown=function(t){this.processKeyEvent(t,this.fireKeyEvent)},b.prototype.processKeyUp=function(t){this.processKeyEvent(t,this.removePressedKey)},b.prototype.processKeyEvent=function(t,e){var o;switch(t.keyCode){case 13:o="enter",t.ctrlKey||t.metaKey?o="ctrl enter":t.shiftKey&&(o="shift enter");break;case 27:o="esc";break;case 32:o="space";break;case 37:o="left arrow";break;case 39:o="right arrow";break;case 38:o="up arrow";break;case 40:o="down arrow";break;default:o=t.key||String.fromCharCode(t.keyCode||t.charCode),(t.ctrlKey||t.metaKey)&&(o="ctrl "+(t.shiftKey?"shift ":"")+o)}e.call(this,o)},b.prototype.fireKeyEvent=function(t){var e=t.toLowerCase(),o=[],i=this.parentThatIsA(Kt);if(this.keysPressed[e]=!0,"ctrl enter"===e&&!i.isAppMode)return this.fireGreenFlagEvent();if("shift enter"===e)return this.editScripts();if("ctrl f"!==e)if("ctrl z"!==e)if("ctrl shift z"!==e&&"ctrl y"!==e)if("ctrl n"!==e)if("ctrl o"!==e){if("ctrl s"!==e)return"ctrl shift s"===e?i.isAppMode?void 0:i.saveProjectsBrowser():"esc"!==e||i.isAppMode?(this.children.concat(this).forEach((t=>{g(t)&&t.allHatBlocksForKey(e).forEach((e=>o.push(this.threads.startProcess(e,t,!0))))})),o):this.fireStopAllEvent();i.isAppMode||i.save()}else i.isAppMode||i.openProjectsBrowser();else i.isAppMode||i.createNewProject();else i.isAppMode||i.currentSprite.scripts.redrop();else i.isAppMode||i.currentSprite.scripts.undrop();else i.isAppMode||i.currentSprite.searchBlocks()},b.prototype.removePressedKey=function(t){delete this.keysPressed[t.toLowerCase()]},b.prototype.processKeyPress=function(t){(0,o.WY)(t)},b.prototype.inspectKeyEvent=o.Hj.prototype.inspectKeyEvent,b.prototype.fireGreenFlagEvent=function(){var t=[],e=this.parentThatIsA(Kt);return this.removeAllClones(),this.children.concat(this).forEach((e=>{g(e)&&e.allHatBlocksFor("__shout__go__").forEach((o=>t.push(this.threads.startProcess(o,e,this.isThreadSafe))))})),e&&e.controlBar.pauseButton.refresh(),t},b.prototype.fireStopAllEvent=function(){var t=this.parentThatIsA(Kt);this.threads.resumeAll(this.stage),this.runStopScripts(),this.keysPressed={},this.threads.stopAll(),this.stopAllActiveSounds(),this.children.forEach((t=>{t.stopTalking&&t.stopTalking()})),this.removeAllClones(),t&&t.nextSteps([o.WY,()=>this.stopAllActiveSounds(),()=>this.stopProjection(),()=>t.controlBar.pauseButton.refresh()])},b.prototype.runStopScripts=function(){this.receiveUserInteraction("stopped",!0,!0),this.children.forEach((t=>{t instanceof y&&t.receiveUserInteraction("stopped",!0,!0)}))},b.prototype.removeAllClones=function(){this.children.filter((t=>t instanceof y&&t.isTemporary)).forEach((t=>{this.threads.stopAllForReceiver(t),t.detachFromAnchor(),t.corpsify(),t.destroy()})),this.cloneCount=0},b.prototype.editScripts=function(){var t,e;!this.parentThatIsA(Kt).isAppMode&&N.prototype.enableKeyboard&&((t=this.parentThatIsA(Kt).currentSprite.scripts.selectForEdit()).edit(t.position()),(e=t.focus.sortedScripts()).length?(t.focus.element=e[0],t.focus.element instanceof F&&t.focus.nextCommand()):t.focus.moveBy(new o.E9(50,50)),t.focus.fixLayout())},b.prototype.pauseGenericHatBlocks=function(){var t=this.parentThatIsA(Kt);(this.hasGenericHatBlocks()||t.sprites.asArray().some((t=>t.hasGenericHatBlocks())))&&(this.enableCustomHatBlocks=!0,this.threads.pauseCustomHatBlocks=!0,t.controlBar.stopButton.refresh())},b.prototype.blockTemplates=function(t){var e,i,s,r=[],n=this,h=t||"motion";function l(t){if(n.hiddenPrimitives[t])return null;var e=y.prototype.blockForSelector(t,!0);return e.isTemplate=!0,e}function p(t,e){var o=y.prototype.variableBlock(t,e);return o.isDraggable=!1,o.isTemplate=!0,o}function c(t){if(n.hiddenPrimitives[t])return null;var e=y.prototype.blocks[t];return new at("checkbox",this,(function(){n.toggleWatcher(t,(0,o.NC)(e.spec),n.blockColor[e.category])}),null,(function(){return n.showingWatcher(t)}),null)}function d(t){return new at("checkbox",this,(function(){n.toggleVariableWatcher(t)}),null,(function(){return n.showingVariableWatcher(t)}),null)}function u(t){t&&(n.isVariableNameInUse(t[0])?n.inform("that name is already in use"):(n.addVariable(t[0],t[1]),n.toggleVariableWatcher(t[0],t[1]),n.blocksCache[h]=null,n.paletteCache[h]=null,n.parentThatIsA(Kt).refreshPalette()))}return"motion"===h?((s=new o.$1((0,o.NC)("Stage selected:\nno motion primitives"))).fontSize=9,s.setColor(this.paletteTextColor),r.push(s),r.push("="),r.push(this.makeBlockButton(h))):"looks"===h?(r.push(l("doSwitchToCostume")),r.push(l("doWearNextCostume")),r.push(c("getCostumeIdx")),r.push(l("getCostumeIdx")),r.push("-"),r.push(l("reportGetImageAttribute")),r.push(l("reportNewCostumeStretched")),r.push(l("reportNewCostume")),r.push("-"),r.push(l("changeEffect")),r.push(l("setEffect")),r.push(l("clearEffects")),r.push(l("getEffect")),r.push("-"),r.push(l("show")),r.push(l("hide")),r.push(c("reportShown")),r.push(l("reportShown")),this.world().isDevMode&&(r.push("-"),(s=new o.$1((0,o.NC)("development mode \ndebugging primitives:"))).fontSize=9,s.setColor(this.paletteTextColor),r.push(s),r.push("-"),r.push(l("log")),r.push(l("alert")),r.push("-"),r.push(l("doScreenshot"))),r.push("="),r.push(this.makeBlockButton(h))):"sound"===h?(r.push(l("playSound")),r.push(l("doPlaySoundUntilDone")),r.push(l("doStopAllSounds")),r.push("-"),r.push(l("doPlaySoundAtRate")),r.push(l("reportGetSoundAttribute")),r.push(l("reportNewSoundFromSamples")),r.push("-"),r.push(l("doRest")),r.push(l("doPlayNote")),r.push(l("doSetInstrument")),r.push("-"),r.push(l("doChangeTempo")),r.push(l("doSetTempo")),r.push(c("getTempo")),r.push(l("getTempo")),r.push("-"),r.push(l("changeVolume")),r.push(l("setVolume")),r.push(c("getVolume")),r.push(l("getVolume")),r.push("-"),r.push(l("changePan")),r.push(l("setPan")),r.push(c("getPan")),r.push(l("getPan")),r.push("-"),r.push(l("playFreq")),r.push(l("stopFreq")),this.world().isDevMode&&(r.push("-"),(s=new o.$1((0,o.NC)("development mode \ndebugging primitives:"))).fontSize=9,s.setColor(this.paletteTextColor),r.push(s),r.push("-"),r.push(l("doPlayFrequency"))),r.push("="),r.push(this.makeBlockButton(h))):"pen"===h?(r.push(l("clear")),r.push("-"),r.push(l("setBackgroundColor")),r.push(l("changeBackgroundHSVA")),r.push(l("setBackgroundHSVA")),r.push("-"),r.push(l("reportPenTrailsAsCostume")),r.push("-"),r.push(l("doPasteOn")),r.push(l("doCutFrom")),r.push("="),r.push(this.makeBlockButton(h))):"control"===h?(r.push(l("receiveGo")),r.push(l("receiveKey")),r.push(l("receiveInteraction")),r.push(l("receiveCondition")),r.push(l("receiveMessage")),r.push("-"),r.push(l("doBroadcast")),r.push(l("doBroadcastAndWait")),r.push(l("doSend")),r.push(c("getLastMessage")),r.push(l("getLastMessage")),r.push("-"),r.push(l("doWarp")),r.push("-"),r.push(l("doWait")),r.push(l("doWaitUntil")),r.push("-"),r.push(l("doForever")),r.push(l("doRepeat")),r.push(l("doUntil")),r.push(l("doFor")),r.push("-"),r.push(l("doIf")),r.push(l("doIfElse")),r.push(l("reportIfElse")),r.push("-"),r.push(l("doReport")),r.push(l("doStopThis")),r.push("-"),r.push(l("doRun")),r.push(l("fork")),r.push(l("evaluate")),r.push("-"),r.push(l("doTellTo")),r.push(l("reportAskFor")),r.push("-"),r.push(l("doCallCC")),r.push(l("reportCallCC")),r.push("-"),r.push(l("createClone")),r.push(l("newClone")),r.push("-"),r.push(l("doPauseAll")),r.push("="),r.push(this.makeBlockButton(h))):"sensing"===h?(r.push(l("doAsk")),r.push(c("getLastAnswer")),r.push(l("getLastAnswer")),r.push("-"),r.push(c("reportMouseX")),r.push(l("reportMouseX")),r.push(c("reportMouseY")),r.push(l("reportMouseY")),r.push(l("reportMouseDown")),r.push("-"),r.push(l("reportKeyPressed")),r.push("-"),r.push(l("reportAspect")),r.push("-"),r.push(l("doResetTimer")),r.push(c("getTimer")),r.push(l("getTimer")),r.push("-"),r.push(l("reportAttributeOf")),y.prototype.enableFirstClass&&r.push(l("reportGet")),r.push(l("reportObject")),r.push("-"),r.push(l("reportURL")),r.push(l("reportAudio")),r.push(l("reportVideo")),r.push(l("doSetVideoTransparency")),r.push("-"),r.push(l("reportGlobalFlag")),r.push(l("doSetGlobalFlag")),r.push("-"),r.push(l("reportDate")),this.world().isDevMode&&(r.push("-"),(s=new o.$1((0,o.NC)("development mode \ndebugging primitives:"))).fontSize=9,s.setColor(this.paletteTextColor),r.push(s),r.push("-"),r.push(c("reportThreadCount")),r.push(l("reportThreadCount")),r.push(l("reportStackSize")),r.push(l("reportFrameCount"))),r.push("="),r.push(this.makeBlockButton(h))):"operators"===h?(r.push(l("reifyScript")),r.push(l("reifyReporter")),r.push(l("reifyPredicate")),r.push("#"),r.push("-"),r.push(l("reportSum")),r.push(l("reportDifference")),r.push(l("reportProduct")),r.push(l("reportQuotient")),r.push(l("reportPower")),r.push("-"),r.push(l("reportModulus")),r.push(l("reportRound")),r.push(l("reportMonadic")),r.push(l("reportRandom")),r.push("-"),r.push(l("reportLessThan")),r.push(l("reportEquals")),r.push(l("reportGreaterThan")),r.push("-"),r.push(l("reportAnd")),r.push(l("reportOr")),r.push(l("reportNot")),r.push(l("reportBoolean")),r.push("-"),r.push(l("reportJoinWords")),r.push(l("reportTextSplit")),r.push(l("reportLetter")),r.push(l("reportStringSize")),r.push("-"),r.push(l("reportUnicode")),r.push(l("reportUnicodeAsLetter")),r.push("-"),r.push(l("reportIsA")),r.push(l("reportIsIdentical")),r.push("-"),r.push(l("reportJSFunction")),a.prototype.enableCompiling&&r.push(l("reportCompiled")),this.world().isDevMode&&(r.push("-"),(s=new o.$1("development mode \ndebugging primitives:")).fontSize=9,s.setColor(this.paletteTextColor),r.push(s),r.push("-"),r.push(l("reportTypeOf")),r.push(l("reportTextFunction"))),r.push("="),r.push(this.makeBlockButton(h))):"variables"===h&&(i=new st(null,(function(){new VariableDialogMorph(null,u,n).prompt("Variable name",null,n.world())}),"Make a variable"),r.push(i),this.variables.allNames().length>0&&(i=new st(null,(function(){var t=new o.wR(n.deleteVariable,null,n);n.variables.allNames().forEach((e=>t.addItem(e,e,null,null,null,null,null,null,!0))),t.popUpAtHand(n.world())}),"Delete a variable"),r.push(i)),r.push("-"),(e=this.reachableGlobalVariableNames(!0)).length>0&&(e.forEach((t=>{r.push(d(t)),r.push(p(t))})),r.push("-")),(e=this.allLocalVariableNames(!0)).length>0&&(e.forEach((t=>{r.push(d(t)),r.push(p(t,!0))})),r.push("-")),r.push(l("doSetVar")),r.push(l("doChangeVar")),r.push(l("doShowVar")),r.push(l("doHideVar")),r.push(l("doDeclareVariables")),r.push("="),r.push(l("reportNewList")),r.push(l("reportNumbers")),r.push("-"),r.push(l("reportCONS")),r.push(l("reportListItem")),r.push(l("reportCDR")),r.push("-"),r.push(l("reportListLength")),r.push(l("reportListIndex")),r.push(l("reportListContainsItem")),r.push(l("reportListIsEmpty")),r.push("-"),r.push(l("reportMap")),r.push(l("reportKeep")),r.push(l("reportFindFirst")),r.push(l("reportCombine")),r.push("-"),r.push(l("doForEach")),r.push("-"),r.push(l("reportConcatenatedLists")),r.push("-"),r.push(l("doAddToList")),r.push(l("doDeleteFromList")),r.push(l("doInsertInList")),r.push(l("doReplaceInList")),this.world().isDevMode&&(r.push("-"),(s=new o.$1((0,o.NC)("development mode \ndebugging primitives:"))).fontSize=9,s.setColor(this.paletteTextColor),r.push(s),r.push("-"),r.push(l("doShowTable"))),r.push("="),b.prototype.enableCodeMapping&&(r.push(l("doMapCodeOrHeader")),r.push(l("doMapValueCode")),r.push(l("doMapListCode")),r.push("-"),r.push(l("reportMappedCode")),r.push("=")),r.push(this.makeBlockButton())),r},b.prototype.clear=function(){this.clearPenTrails()},b.prototype.userMenu=function(){var t=this.parentThatIsA(Kt),e=new o.wR(this);return t&&t.isAppMode||(e.addItem("edit","edit"),e.addItem("show all","showAll"),e.addItem("pic...",(()=>t.saveCanvasAs(this.fullImage(),this.name)),"save a picture\nof the stage"),e.addLine(),e.addItem("pen trails",(()=>{var e=t.currentSprite.reportPenTrailsAsCostume().copy();t.currentSprite.addCostume(e),t.currentSprite.wearCostume(e),t.hasChangedMedia=!0,t.spriteBar.tabBar.tabTo("costumes")}),t.currentSprite instanceof y?"turn all pen trails and stamps\ninto a new costume for the\ncurrently selected sprite":"turn all pen trails and stamps\ninto a new background for the stage"),this.trailsLog.length&&e.addItem("svg...","exportTrailsLogAsSVG","export pen trails\nline segments as SVG")),e},b.prototype.showAll=function(){this.children.forEach((t=>{t instanceof y?t.anchor||(t.show(),t.keepWithin(this)):(t.show(),t.keepWithin(this),t.fixLayout&&t.fixLayout())}))},b.prototype.edit=y.prototype.edit,b.prototype.fullImage=o._V.prototype.fullImage,b.prototype.thumbnail=function(t,e){return this.fancyThumbnail(t,null,!1,e)},b.prototype.fancyThumbnail=function(t,e,i,s){var r,n,a=this.getImage(),h=Math.min(t.x/a.width,t.y/a.height),l=(0,o.oM)(t,i,s),p=l.getContext("2d");return p.save(),p.scale(h,h),p.drawImage(a,0,0),p.drawImage(this.penTrails(),0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale),this.projectionSource&&(p.save(),p.globalAlpha=1-this.projectionTransparency/100,p.drawImage(this.projectionLayer(),0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale),p.restore()),this.children.forEach((t=>{t.isVisible&&t!==e&&(r=t.fullBounds(),(n=t.fullImage()).width&&n.height&&p.drawImage(t.fullImage(),r.origin.x-this.bounds.origin.x,r.origin.y-this.bounds.origin.y))})),p.restore(),l},b.prototype.exportTrailsLogAsSVG=function(){var t=this.parentThatIsA(Kt);t.saveFileAs(this.trailsLogAsSVG().src,"image/svg",t.projectName||this.name)},b.prototype.trailsLogAsSVG=function(){var t,e,i,s,r,n=this.trailsLog[0][0],a=n,h=this.trailsLog[0][3];return this.trailsLog.forEach((t=>{n=(n=n.min(t[0])).min(t[1]),a=(a=a.max(t[0])).max(t[1]),h=Math.max(h,t[3])})),e=n.corner(a).expandBy(h/2),t=new o.E9(-n.x,a.y).translateBy(h/2),r='<svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" viewBox="0 0 '+e.width()+" "+e.height()+'" width="'+e.width()+'" height="'+e.height()+'" >',r+="\x3c!-- Generated by Snap! - http://snap.berkeley.edu/ --\x3e",this.trailsLog.forEach((e=>{i=this.normalizePoint(e[0]).translateBy(t),s=this.normalizePoint(e[1]).translateBy(t),r+='<line x1="'+i.x+'" y1="'+i.y+'" x2="'+s.x+'" y2="'+s.y+'" style="stroke:'+e[2].toRGBstring()+";stroke-opacity:"+e[2].a+";stroke-width:"+e[3]+";stroke-linecap:"+e[4]+'" />'})),{src:r+="</svg>",rot:new o.E9(-e.origin.x,e.corner.y)}},b.prototype.normalizePoint=function(t){return new o.E9(t.x,-t.y)},b.prototype.hide=function(){this.isVisible=!1,this.changed()},b.prototype.show=function(){this.isVisible=!0,this.changed()},b.prototype.reportShown=y.prototype.reportShown,b.prototype.createClone=o.WY,b.prototype.newClone=o.WY,b.prototype.setColorComponentHSVA=function(t,e){var o=+e;(t=+t)<0||t>3||(0==t?(o<0||o>100)&&(o=(o<0?100:0)+o%100):o=Math.min(100,Math.max(0,o)),3===t?this.color.a=1-o/100:(this.cachedHSV[t]=o/100,this.color.set_hsv.apply(this.color,this.cachedHSV)),this.rerender())},b.prototype.getColorComponentHSLA=y.prototype.getColorComponentHSLA,b.prototype.changeColorComponentHSVA=y.prototype.changeColorComponentHSVA,b.prototype.setColor=function(t){this.color.eq(t,!0)||(this.color=t.copy(),this.rerender(),this.cachedHSV=this.color.hsv())},b.prototype.setBackgroundColor=b.prototype.setColor,b.prototype.getPenAttribute=y.prototype.getPenAttribute,b.prototype.blitOn=y.prototype.blitOn,b.prototype.categories=y.prototype.categories,b.prototype.blockColor=y.prototype.blockColor,b.prototype.paletteColor=y.prototype.paletteColor,b.prototype.setName=y.prototype.setName,b.prototype.makeBlockButton=y.prototype.makeBlockButton,b.prototype.makeBlock=y.prototype.makeBlock,b.prototype.palette=y.prototype.palette,b.prototype.freshPalette=y.prototype.freshPalette,b.prototype.blocksMatching=y.prototype.blocksMatching,b.prototype.searchBlocks=y.prototype.searchBlocks,b.prototype.reporterize=y.prototype.reporterize,b.prototype.showingWatcher=y.prototype.showingWatcher,b.prototype.addVariable=y.prototype.addVariable,b.prototype.deleteVariable=y.prototype.deleteVariable,b.prototype.neighbors=y.prototype.neighbors,b.prototype.perimeter=y.prototype.perimeter,b.prototype.doScreenshot=y.prototype.doScreenshot,b.prototype.newCostumeName=y.prototype.newCostumeName,b.prototype.blockForSelector=y.prototype.blockForSelector,b.prototype.findVariableWatcher=y.prototype.findVariableWatcher,b.prototype.toggleVariableWatcher=y.prototype.toggleVariableWatcher,b.prototype.showingVariableWatcher=y.prototype.showingVariableWatcher,b.prototype.deleteVariableWatcher=y.prototype.deleteVariableWatcher,b.prototype.addCostume=y.prototype.addCostume,b.prototype.wearCostume=y.prototype.wearCostume,b.prototype.getCostumeIdx=y.prototype.getCostumeIdx,b.prototype.doWearNextCostume=y.prototype.doWearNextCostume,b.prototype.doWearPreviousCostume=y.prototype.doWearPreviousCostume,b.prototype.doSwitchToCostume=y.prototype.doSwitchToCostume,b.prototype.reportCostumes=y.prototype.reportCostumes,b.prototype.graphicsChanged=y.prototype.graphicsChanged,b.prototype.applyGraphicsEffects=y.prototype.applyGraphicsEffects,b.prototype.setEffect=y.prototype.setEffect,b.prototype.getEffect=y.prototype.getEffect,b.prototype.getGhostEffect=y.prototype.getGhostEffect,b.prototype.changeEffect=y.prototype.changeEffect,b.prototype.clearEffects=y.prototype.clearEffects,b.prototype.addSound=y.prototype.addSound,b.prototype.doPlaySound=y.prototype.doPlaySound,b.prototype.stopAllActiveSounds=function(){this.activeSounds.forEach((t=>t.pause())),this.activeSounds=[],this.microphone.modifier&&this.microphone.isReady&&this.microphone.stop()},b.prototype.pauseAllActiveSounds=function(){this.activeSounds.forEach((t=>t.pause()))},b.prototype.resumeAllActiveSounds=function(){this.activeSounds.forEach((t=>t.play()))},b.prototype.reportSounds=y.prototype.reportSounds,b.prototype.newSoundName=y.prototype.newSoundName,b.prototype.setVolume=y.prototype.setVolume,b.prototype.changeVolume=y.prototype.changeVolume,b.prototype.getVolume=y.prototype.getVolume,b.prototype.getGainNode=y.prototype.getGainNode,b.prototype.audioContext=y.prototype.audioContext,b.prototype.setPan=y.prototype.setPan,b.prototype.changePan=y.prototype.changePan,b.prototype.getPan=y.prototype.getPan,b.prototype.getPannerNode=y.prototype.getPannerNode,b.prototype.playFreq=y.prototype.playFreq,b.prototype.stopFreq=y.prototype.stopFreq,b.prototype.toggleWatcher=y.prototype.toggleWatcher,b.prototype.showingWatcher=y.prototype.showingWatcher,b.prototype.watcherFor=y.prototype.watcherFor,b.prototype.getLastAnswer=y.prototype.getLastAnswer,b.prototype.reportThreadCount=y.prototype.reportThreadCount,b.prototype.xCenter=function(){return 0},b.prototype.yCenter=function(){return 0},b.prototype.xLeft=function(){return-.5*this.dimensions.x},b.prototype.xRight=function(){return this.dimensions.x/2},b.prototype.yTop=function(){return this.dimensions.y/2},b.prototype.yBottom=function(){return-.5*this.dimensions.y},b.prototype.allMessageNames=y.prototype.allMessageNames,b.prototype.allSendersOf=y.prototype.allSendersOf,b.prototype.allHatBlocksFor=y.prototype.allHatBlocksFor,b.prototype.allHatBlocksForKey=y.prototype.allHatBlocksForKey,b.prototype.allHatBlocksForInteraction=y.prototype.allHatBlocksForInteraction,b.prototype.hasGenericHatBlocks=y.prototype.hasGenericHatBlocks,b.prototype.allGenericHatBlocks=y.prototype.allGenericHatBlocks,b.prototype.allScripts=y.prototype.allScripts,b.prototype.mouseClickLeft=y.prototype.mouseClickLeft,b.prototype.mouseEnter=y.prototype.mouseEnter,b.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed")},b.prototype.mouseDownLeft=y.prototype.mouseDownLeft,b.prototype.mouseScroll=y.prototype.mouseScroll,b.prototype.receiveUserInteraction=y.prototype.receiveUserInteraction,b.prototype.deleteAllBlockInstances=y.prototype.deleteAllBlockInstances,b.prototype.allBlockInstances=y.prototype.allBlockInstances,b.prototype.allLocalBlockInstances=y.prototype.allLocalBlockInstances,b.prototype.allEditorBlockInstances=y.prototype.allEditorBlockInstances,b.prototype.paletteBlockInstance=y.prototype.paletteBlockInstance,b.prototype.usesBlockInstance=y.prototype.usesBlockInstance,b.prototype.doubleDefinitionsFor=y.prototype.doubleDefinitionsFor,b.prototype.replaceDoubleDefinitionsFor=y.prototype.replaceDoubleDefinitionsFor,b.prototype.allInvocationsOf=y.prototype.allInvocationsOf,b.prototype.allIndependentInvocationsOf=y.prototype.allInvocationsOf,b.prototype.allDependentInvocationsOf=y.prototype.allInvocationsOf,b.prototype.specimens=function(){return[]},b.prototype.allSpecimens=function(){return[]},b.prototype.shadowAttribute=o.WY,b.prototype.inheritsAttribute=function(){return!1},b.prototype.isVariableNameInUse=y.prototype.isVariableNameInUse,b.prototype.globalVariables=y.prototype.globalVariables,b.prototype.inheritedVariableNames=function(){return[]},b.prototype.allLocalVariableNames=y.prototype.allLocalVariableNames,b.prototype.reachableGlobalVariableNames=y.prototype.reachableGlobalVariableNames,b.prototype.getMethod=y.prototype.getMethod,b.prototype.getLocalMethod=y.prototype.getLocalMethod,b.prototype.ownBlocks=y.prototype.ownBlocks,b.prototype.allBlocks=function(t){var e=this.ownBlocks();return t?Object.keys(e).map((t=>e[t])):e},b.prototype.inheritedBlocks=function(){return[]},b.prototype.hasSpriteVariable=y.prototype.hasSpriteVariable,b.prototype.refactorVariableInstances=y.prototype.refactorVariableInstances,b.prototype.reportPenTrailsAsCostume=function(){return new C(this.trailsCanvas,this.newCostumeName((0,o.NC)("Background")))},b.prototype.globalBlocksSending=function(t,e){var i=this.globalBlocks.filter((o=>o.isSending(t,e)));return this.globalBlocks.forEach((t=>{t.collectDependencies().some((t=>(0,o.r3)(i,t)))&&i.push(t)})),i},w.prototype=new o.KE,w.prototype.constructor=w,w.uber=o.KE.prototype,w.prototype.init=function(t,e,o,i){var s=y.prototype;this.stage=e,this.scale=e?e.scale:1,this.data=t,this.isQuestion=i,w.uber.init.call(this,this.data,s.bubbleColor,null,null,i?s.blockColor.sensing:s.bubbleBorderColor,null,o,!0),this.isCachingImage=!0,this.rerender()},C.prototype.maxExtent=function(){return b.prototype.dimensions},C.prototype.toString=function(){return"a Costume("+this.name+")"},C.prototype.extent=function(){return new o.E9(this.contents.width,this.contents.height)},C.prototype.center=function(){return this.extent().divideBy(2)},C.prototype.width=function(){return this.contents.width},C.prototype.height=function(){return this.contents.height},C.prototype.bounds=function(){return new o.Ae(0,0,this.width(),this.height())},C.prototype.shrinkWrap=function(){var t=this.boundingBox(),e=t.extent(),i=(0,o.oM)(e,!0);i.getContext("2d").drawImage(this.contents,t.origin.x,t.origin.y,e.x,e.y,0,0,e.x,e.y),this.rotationCenter=this.rotationCenter.subtract(t.origin),this.contents=i,this.version=Date.now()},C.prototype.canvasBoundingBox=function(t){var e,i,s=t.width,r=t.height,n=t.getContext("2d").getImageData(0,0,s,r);function a(t,e){return n.data[e*s*4+4*t+3]}return new o.Ae(function(){for(i=0;i<s;i+=1)for(e=0;e<r;e+=1)if(a(i,e))return i;return 0}(),function(){for(e=0;e<r;e+=1)for(i=0;i<s;i+=1)if(a(i,e))return e;return 0}(),function(){for(i=s-1;i>=0;i-=1)for(e=r-1;e>=0;e-=1)if(a(i,e))return Math.min(i+1,s);return s}(),function(){for(e=r-1;e>=0;e-=1)for(i=s-1;i>=0;i-=1)if(a(i,e))return Math.min(e+1,r);return r}())},C.prototype.boundingBox=function(){return this.canvasBoundingBox(this.contents)},C.prototype.copy=function(){var t,e=(0,o.oM)(this.extent(),!0);return e.getContext("2d").drawImage(this.contents,0,0),(t=new C(e,this.name?(0,o.JG)(this.name):null)).rotationCenter=this.rotationCenter.copy(),t},C.prototype.flipped=function(){var t=(0,o.oM)(this.extent(),!0),e=t.getContext("2d");return e.translate(this.width(),0),e.scale(-1,1),e.drawImage(this.contents,0,0),new C(t,this.name,new o.E9(this.width()-this.rotationCenter.x,this.rotationCenter.y))},C.prototype.stretched=function(t,e){t=(Math.sign(t)||1)*Math.max(1,Math.abs(t)),e=(Math.sign(e)||1)*Math.max(1,Math.abs(e));var i=(0,o.oM)(new o.E9(Math.abs(t),Math.abs(e)),!0),s=i.getContext("2d"),r=t/this.width(),n=e/this.height(),a=this.rotationCenter.multiplyBy(new o.E9(r,n));return r<0&&(a.x=i.width-Math.abs(a.x)),n<0&&(a.y=i.height-Math.abs(a.y)),s.translate(Math.abs(Math.min(t,0)),Math.abs(Math.min(e,0))),s.scale(r,n),s.drawImage(this.rasterized().contents,0,0),new C(i,this.name,a,!0)},C.prototype.editRotationPointOnly=function(t,e){var i,s,r=new v(this);r.fixLayout(),i=new lt(this,(()=>{r.accept(),e.currentSprite.wearCostume(this,!0)})),s=new o.$1((0,o.NC)("click or drag crosshairs to move the rotation center"),i.fontSize,i.fontStyle,!0,!1,"center",null,null,new o.E9(1,1),o.Cj),i.labelString="Costume Editor",i.createLabel(),i.setPicture(r),i.addBody(s),i.addButton("ok","Ok"),i.addButton("cancel","Cancel"),i.fixLayout(),i.popUp(t)},C.prototype.shrinkToFit=function(t){(t.x<this.width()||t.y<this.height())&&(this.contents=this.thumbnail(t,null,!0))},C.prototype.thumbnail=function(t,e,i){var s,r,n=this.contents,a=n?n.width:1,h=n?n.height:1,l=Math.min(t.x/a,t.y/h),p=i?0:Math.floor((t.x-a*l)/2),c=i?0:Math.floor((t.y-h*l)/2);return s=(0,o.oM)(i?new o.E9(this.width()*l,this.height()*l):t,!0,e),n&&n.width+n.height!==0?((r=s.getContext("2d")).save(),r.scale(l,l),r.drawImage(n,Math.floor(p/l),Math.floor(c/l)),r.restore(),s):s},C.prototype.rasterized=function(){return this},C.prototype.pixels=function(){var t,e,o=[];if(!this.contents.width||!this.contents.height)return o;for(t=this.contents.getContext("2d").getImageData(0,0,this.contents.width,this.contents.height),e=0;e<t.data.length;e+=4)o.push(new d([t.data[e],t.data[e+1],t.data[e+2],t.data[e+3]]));return new d(o)},C.prototype.isTainted=function(){try{this.contents.getContext("2d").getImageData(0,0,this.contents.width,this.contents.height)}catch(t){return!0}return!1},S.prototype=new C,S.prototype.constructor=S,S.uber=C.prototype,S.prototype.toString=function(){return"an SVG_Costume("+this.name+")"},S.prototype.copy=function(){var t,e=new Image;return e.src=this.contents.src,(t=new S(e,this.name?(0,o.JG)(this.name):null)).rotationCenter=this.rotationCenter.copy(),t.shapes=this.shapes.map((t=>t.copy())),t},S.prototype.shrinkToFit=function(t){(0,o.WY)(t)},S.prototype.parseShapes=function(){var t=new XML_Element,e=this.contents.src.replace(/^data:image\/.*?, */,"");this.contents.src.indexOf("base64")>-1&&(e=atob(e)),t.parseString(e),0===this.shapes.length&&t.attributes.snap&&(this.shapes=t.children.map((t=>window[t.attributes.prototype].fromSVG(t))))},S.prototype.edit=function(t,e,i,s,r){var n=new VectorPaintEditorMorph,a=this;n.oncancel=s||o.WY,n.openIn(t,i?(0,o.oM)(b.prototype.dimensions):this.contents,i?new o.E9(240,180):this.rotationCenter,((s,n,h)=>{a.contents=s,a.rotationCenter=n,a.shapes=h,a.version=Date.now(),t.changed(),e&&(i&&e.currentSprite.addCostume(a),e.currentSprite.wearCostume(a),e.hasChangedMedia=!0),(r||o.WY)()}),e,this.shapes||[])},S.prototype.rasterized=function(){var t=(0,o.oM)(this.extent(),!0);return t.getContext("2d").drawImage(this.contents,0,0),new C(t,this.name,this.rotationCenter.copy())},v.prototype=new o._V,v.prototype.constructor=v,v.uber=o._V.prototype,v.prototype.size=C.prototype.maxExtent(),v.prototype.init=function(t){this.costume=t||new C,this.rotationCenter=this.costume.rotationCenter.copy(),this.margin=o.xE,v.uber.init.call(this)},v.prototype.accept=function(){this.costume.rotationCenter=this.rotationCenter.copy(),this.costume.version=Date.now()},v.prototype.fixLayout=function(){this.bounds.setExtent(this.size)},v.prototype.render=function(t){var e;this.margin=this.size.subtract(this.costume.extent()).divideBy(2),e=this.rotationCenter.add(this.margin),this.cachedTexture||(this.cachedTexture=this.createTexture()),this.renderCachedTexture(t),t.drawImage(this.costume.contents,this.margin.x,this.margin.y),t.globalAlpha=.5,t.fillStyle="white",t.beginPath(),t.arc(e.x,e.y,20,(0,o.uR)(0),(0,o.uR)(360),!1),t.closePath(),t.fill(),t.stroke(),t.beginPath(),t.arc(e.x,e.y,10,(0,o.uR)(0),(0,o.uR)(360),!1),t.stroke(),t.beginPath(),t.moveTo(0,e.y),t.lineTo(this.costume.width()+2*this.margin.x,e.y),t.stroke(),t.beginPath(),t.moveTo(e.x,0),t.lineTo(e.x,this.costume.height()+2*this.margin.y),t.stroke()},v.prototype.createTexture=function(){var t=(0,o.oM)(new o.E9(10,10)),e=t.getContext("2d"),i=new o.Il(230,230,230);return e.fillStyle="white",e.fillRect(0,0,10,10),e.fillStyle=i.toString(),e.fillRect(0,0,5,5),e.fillRect(5,5,5,5),t},v.prototype.mouseDownLeft=function(t){this.rotationCenter=t.subtract(this.position().add(this.margin)),this.rerender()},v.prototype.mouseMove=v.prototype.mouseDownLeft,x.prototype.play=function(){var t=document.createElement("audio");return t.src=this.audio.src,t.play(),t},x.prototype.copy=function(){var t=document.createElement("audio");return t.src=this.audio.src,new x(t,this.name?(0,o.JG)(this.name):null)},x.prototype.toDataURL=function(){return this.audio.src},k.prototype.audioContext=null,k.prototype.fadeIn=new Float32Array(2),k.prototype.fadeIn[0]=[0],k.prototype.fadeIn[1]=[.2],k.prototype.fadeOut=new Float32Array(2),k.prototype.fadeOut[0]=[.2],k.prototype.fadeOut[1]=[0],k.prototype.fadeTime=.01,k.prototype.setupContext=function(){if(!this.audioContext){var t,e=((t=window.AudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext||window.webkitAudioContext).prototype.createGain||(t.prototype.createGain=t.prototype.createGainNode),t);if(!e)throw new Error("Web Audio API is not supported\nin this browser");k.prototype.audioContext=new e}},k.prototype.getAudioContext=function(){return this.audioContext||this.setupContext(),this.audioContext.resume(),this.audioContext},k.prototype.play=function(t,e,i){e||(e=this.audioContext.createGain()),this.fader=this.audioContext.createGain(),this.oscillator=this.audioContext.createOscillator(),this.oscillator.start||(this.oscillator.start=this.oscillator.noteOn),this.oscillator.stop||(this.oscillator.stop=this.oscillator.noteOff),this.setInstrument(t),this.oscillator.frequency.value=(0,o.kK)(this.frequency)?440*Math.pow(2,(this.pitch-69)/12):this.frequency,this.oscillator.connect(this.fader),this.fader.connect(e),i?(e.connect(i),i.connect(this.audioContext.destination)):e.connect(this.audioContext.destination),this.ended=!1,this.fader.gain.setValueCurveAtTime(this.fadeIn,this.audioContext.currentTime,this.fadeTime),this.oscillator.start(0)},k.prototype.setInstrument=function(t){this.oscillator&&(this.oscillator.type=["sine","square","sawtooth","triangle"][(t||1)-1])},k.prototype.stop=function(t){var e=!t;if(t&&this.oscillator)this.oscillator.stop(0);else{if(this.fader)try{this.fader.gain.setValueCurveAtTime(this.fadeOut,this.audioContext.currentTime,this.fadeTime)}catch(t){e=!1}this.oscillator&&(this.oscillator.stop(e?this.audioContext.currentTime+this.fadeTime:0),this.oscillator=null),this.ended=!0}},k.prototype.pause=function(){this.stop()},M.prototype.isOn=function(){return this.isReady?(this.lastTime=Date.now(),!0):(this.start(),!1)},M.prototype.binSizes=[256,512,1024,2048,4096],M.prototype.binSize=function(){return this.binSizes[this.resolution-1]},M.prototype.setResolution=function(t){(0,o.r3)([1,2,3,4],t)&&(this.isReady&&this.stop(),this.resolution=t)},M.prototype.start=function(){this.isStarted||(this.isStarted=!0,this.isReady=!1,this.audioContext=k.prototype.getAudioContext(),navigator.mediaDevices.getUserMedia({audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"},optional:[]}}).then((t=>this.setupNodes(t))).catch(o.WY))},M.prototype.stop=function(){this.processor.onaudioprocess=null,this.sourceStream.getTracks().forEach((t=>t.stop())),this.processor.disconnect(),this.analyser.disconnect(),this.processor=null,this.analyser=null,this.audioContext=null,this.isReady=!1,this.isStarted=!1},M.prototype.setupNodes=function(t){this.sourceStream=t,this.createProcessor(),this.createAnalyser(),this.analyser.connect(this.processor),this.processor.connect(this.audioContext.destination),this.audioContext.createMediaStreamSource(t).connect(this.analyser),this.lastTime=Date.now()},M.prototype.createAnalyser=function(){var t;this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.binSizes[this.resolution],t=this.analyser.frequencyBinCount,this.frequencies=new Uint8Array(t),this.correlations=new Array(Math.floor(t/2))},M.prototype.createProcessor=function(){var t=this;this.processor=this.audioContext.createScriptProcessor(this.binSizes[this.resolution-1]),this.processor.onaudioprocess=function(e){t.stepAudio(e)},this.processor.clipping=!1,this.processor.lastClip=0,this.processor.clipLevel=.98,this.processor.averaging=.95,this.processor.clipLag=750},M.prototype.stepAudio=function(t){var e,o;if(this.isAutoStop&&Date.now()-this.lastTime>5e3&&!this.modifier)this.stop();else{if(this.signals=t.inputBuffer.getChannelData(0),this.modifier){for(e=t.outputBuffer.numberOfChannels,this.outChannels.length!==e&&(this.outChannels=new Array(e)),o=0;o<e;o+=1)this.outChannels[o]=t.outputBuffer.getChannelData(o);this.output=this.outChannels[0]}else this.output=t.outputBuffer.getChannelData(0);this.analyser.getByteFrequencyData(this.frequencies),this.pitch=this.detectPitchAndVolume(this.signals,this.audioContext.sampleRate),this.pitch>0&&(this.note=Math.round(Math.log(this.pitch/440)/Math.log(2)*12)+69),this.isReady=!0,this.isStarted=!1}},M.prototype.detectPitchAndVolume=function(e,o){var i,s,r,n,a,h,l,p=e.length,c=Math.floor(p/2),d=-1,u=0,f=0,g=!1,y=this.correlations,m=this.outChannels.length;for(n=0;n<p;n+=1)if(h=e[n],Math.abs(h)>=this.processor.clipLevel&&(this.processor.clipping=!0,this.processor.lastClip=window.performance.now()),f+=h*h,this.modifier)for(this.wrapper.contents[0]=h,l=(0,t.invoke)(this.compiledModifier,this.wrapper,null,null,null,null,this.compilerProcess),a=0;a<m;a+=1)this.outChannels[a][n]=l;if(f=Math.sqrt(f/p),this.volume=Math.max(f,this.volume*this.processor.averaging),f<.01)return this.pitch;for(s=1,r=1;r<c;r+=1){for(i=0,n=0;n<c;n+=1)i+=Math.abs(e[n]-e[n+r]);if(i=1-i/c,y[r]=i,i>this.GOOD_ENOUGH_CORRELATION&&i>s)g=!0,i>u&&(u=i,d=r);else if(g)return o/(d+(y[d+1]-y[d-1])/y[d]*8);s=i}return u>.01?o/d:this.pitch},T.prototype=new o.RC,T.prototype.constructor=T,T.uber=o.RC.prototype,T.prototype.init=function(t,e,i,s){this.contents=0===t?0:!1!==t&&(t||""),this.isEditable=!(0,o.kK)(i),this.idx=i||null,this.parentCell=s||null,T.uber.init.call(this,I.prototype.corner,1,o.Cj),this.color=e||new o.Il(255,140,0),this.isBig=!1,this.version=null,this.fixLayout()},B.prototype=new o.RC,B.prototype.constructor=B,B.uber=o.RC.prototype,B.prototype.init=function(t,e,i,s,r){this.labelText=t||"",this.version=null,this.objName="",this.isGhosted=!1,B.uber.init.call(this,I.prototype.rounding,1.000001,new o.Il(120,120,120)),this.color=new o.Il(220,220,220),this.readoutColor=e,this.style="normal",this.target=i||null,this.getter=s||null,this.currentValue=null,this.labelMorph=null,this.sliderMorph=null,this.cellMorph=null,this.isDraggable=!0,this.fixLayout(),this.update(),r&&this.hide()},B.prototype.isTemporary=function(){var t=this.parentThatIsA(b);return this.target instanceof p&&(!t||this.target!==t.variables.parentFrame)&&null===this.target.owner},B.prototype.object=function(){return this.target instanceof p?this.target.owner:this.target},B.prototype.isGlobal=function(t){return(0,o.r3)(["getLastAnswer","getLastMessage","getTempo","getTimer","reportMouseX","reportMouseY","reportThreadCount"],t)},B.prototype.setSliderMin=function(t,e){this.target instanceof p&&(this.sliderMorph.setSize(1,e),this.sliderMorph.setStart(t,e),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,e))},B.prototype.setSliderMax=function(t,e){this.target instanceof p&&(this.sliderMorph.setSize(1,e),this.sliderMorph.setStop(t,e),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,e))},B.prototype.updateLabel=function(){var t=this.object();t&&!this.isGlobal(this.getter)&&t.version!==this.version&&(this.objName=t.name?t.name+" ":" ",this.labelMorph&&(this.labelMorph.destroy(),this.labelMorph=null,this.fixLayout()))},B.prototype.fixLayout=function(){var t,e=I.prototype.fontSize,i=this;if(null===this.labelMorph&&(this.labelMorph=new o.XC(this.objName+this.labelText,e,null,!0,!1,!1,o.tU.isFlat?new o.E9:new o.E9(1,1),o.Cj),this.add(this.labelMorph)),null===this.cellMorph&&(this.cellMorph=new T("",this.readoutColor),this.add(this.cellMorph)),null===this.sliderMorph&&(this.sliderMorph=new o.Vl(0,100,0,20,"horizontal"),this.sliderMorph.alpha=1,this.sliderMorph.button.color=this.color.darker(),this.sliderMorph.color=this.color.lighter(60),this.sliderMorph.button.highlightColor=this.color.darker(),this.sliderMorph.button.highlightColor.b+=50,this.sliderMorph.button.pressColor=this.color.darker(),this.sliderMorph.button.pressColor.b+=100,this.sliderMorph.setHeight(e),this.sliderMorph.action=function(t){i.target.setVar(i.getter,Math.round(t),i.target.owner)},this.add(this.sliderMorph)),(t=this.cellMorph.contents instanceof d)&&(this.style="normal"),"large"===this.style)return this.labelMorph.hide(),this.sliderMorph.hide(),this.cellMorph.big(),this.cellMorph.setPosition(this.position()),void this.bounds.setExtent(this.cellMorph.extent().subtract(1));this.labelMorph.show(),this.sliderMorph.show(),this.cellMorph.normal(),this.labelMorph.setPosition(this.position().add(new o.E9(this.edge,this.border+I.prototype.typeInPadding))),t?this.cellMorph.setPosition(this.labelMorph.bottomLeft().add(new o.E9(0,I.prototype.typeInPadding))):(this.cellMorph.setPosition(this.labelMorph.topRight().add(new o.E9(e/3,0))),this.labelMorph.setTop(this.cellMorph.top()+(this.cellMorph.height()-this.labelMorph.height())/2)),"slider"===this.style?(this.sliderMorph.setPosition(new o.E9(this.labelMorph.left(),this.cellMorph.bottom()+I.prototype.typeInPadding)),this.sliderMorph.setWidth(this.cellMorph.right()-this.labelMorph.left()),this.bounds.setHeight(this.cellMorph.height()+this.sliderMorph.height()+2*this.border+3*I.prototype.typeInPadding)):(this.sliderMorph.hide(),this.bounds.corner.y=this.cellMorph.bottom()+this.border+I.prototype.typeInPadding),this.bounds.corner.x=Math.max(this.cellMorph.right(),this.labelMorph.right())+this.edge+I.prototype.typeInPadding},B.prototype.mouseDoubleClick=function(t){d.prototype.enableTables&&this.currentValue instanceof d?new TableDialogMorph(this.currentValue).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},B.prototype.rootForGrab=function(){var t=this.parentThatIsA(Kt);return t&&t.isAppMode?t:this},B.prototype.userMenu=function(){var t,e=this,i=this.parentThatIsA(Kt),s=16===this.world().currentKey,r=new o.wR(this);if(!i||!i.isAppMode)return r.addItem(("normal"===this.style?"●":"○")+" "+(0,o.NC)("normal"),"styleNormal"),r.addItem(("large"===this.style?"●":"○")+" "+(0,o.NC)("large"),"styleLarge"),this.target instanceof p&&(r.addItem(("slider"===this.style?"●":"○")+" "+(0,o.NC)("slider"),"styleSlider"),r.addLine(),r.addItem("slider min...","userSetSliderMin"),r.addItem("slider max...","userSetSliderMax"),r.addLine(),r.addItem("import...","importData"),r.addItem("raw data...",(()=>this.importData(!0)),"import without attempting to\nparse or format data"),s&&(this.currentValue instanceof d&&this.currentValue.canBeCSV()&&r.addItem("export as CSV...",(()=>{this.parentThatIsA(Kt).saveFileAs(this.currentValue.asCSV(),"text/csv;charset=utf-8",this.getter)}),null,new o.Il(100,0,0)),this.currentValue instanceof d&&this.currentValue.canBeJSON()&&r.addItem("export as JSON...",(()=>{this.parentThatIsA(Kt).saveFileAs(this.currentValue.asJSON(!0),"text/json;charset=utf-8",this.getter)}),null,new o.Il(100,0,0))),(0,o.HD)(this.currentValue)||!isNaN(+this.currentValue)?(s&&r.addItem("parse","parseTxt","try to convert\nraw data into a list",new o.Il(100,0,0)),r.addItem("export...",(()=>{this.parentThatIsA(Kt).saveFileAs(this.currentValue.toString(),"text/plain;charset=utf-8",this.getter)}))):this.currentValue instanceof d&&this.currentValue.canBeCSV()?(r.addItem("export...",(()=>{this.parentThatIsA(Kt).saveFileAs(this.currentValue.asCSV(),"text/csv;charset=utf-8",this.getter)})),this.currentValue.canBeJSON()&&r.addItem("blockify",(()=>{var t=i.world();this.currentValue.blockify().pickUp(t),t.hand.grabOrigin={origin:i.palette,position:i.palette.center()}}))):this.currentValue instanceof d&&this.currentValue.canBeJSON()?r.addItem("export...",(()=>{this.parentThatIsA(Kt).saveFileAs(this.currentValue.asJSON(!0),"text/json;charset=utf-8",this.getter)})):this.currentValue instanceof d&&this.currentValue.canBeCSV()?r.addItem("export...",(function(){e.parentThatIsA(Kt).saveFileAs(e.currentValue.asCSV(),"text/csv;charset=utf-8",e.getter)})):this.currentValue instanceof d&&this.currentValue.canBeJSON()?r.addItem("export...",(function(){e.parentThatIsA(Kt).saveFileAs(e.currentValue.asJSON(!0),"text/json;charset=utf-8",e.getter)})):this.currentValue instanceof h&&(t=this.currentValue.outerContext.variables.names()).length&&(r.addLine(),t.forEach((t=>function(t){var i=e.parentThatIsA(b),s=e.currentValue.outerContext.variables;r.addItem(t+"...",(function(){var e,r=(0,o.qY)(i.children,(e=>e instanceof B&&e.target===s&&e.getter===t));if(null!==r)return r.show(),void r.fixLayout();(r=new B(t+" "+(0,o.NC)("(temporary)"),y.prototype.blockColor.variables,s,t)).setPosition(i.position().add(10)),(e=i.watchers(r.left())).length>0&&r.setTop(e[e.length-1].bottom()),i.add(r),r.fixLayout()}))}(t))))),r},B.prototype.importData=function(t){var e=document.createElement("input"),i=this.parentThatIsA(Kt),s=this;i.filePicker&&(document.body.removeChild(i.filePicker),i.filePicker=null),e.type="file",e.style.color="transparent",e.style.backgroundColor="transparent",e.style.border="none",e.style.outline="none",e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="0px",e.style.height="0px",e.style.display="none",e.addEventListener("change",(function(){document.body.removeChild(e),i.filePicker=null,e.files.length>0&&function(e){var r,n,h=new FileReader,l=e.name.split(".").pop().toLowerCase();function p(t,e){return-1!==t.type.indexOf(e)||l===e}h.onloadend=function(o){!t&&p(e,"csv")?s.target.setVar(s.getter,a.prototype.parseCSV(o.target.result)):!t&&p(e,"json")?s.target.setVar(s.getter,a.prototype.parseJSON(o.target.result)):s.target.setVar(s.getter,o.target.result)},t||function(t){return-1!==t.type.indexOf("text")||(0,o.r3)(["txt","csv","xml","json","tsv"],l)}(e)?h.readAsText(e):(r=e.type,n=()=>h.readAsText(e),i.confirm((0,o.NC)('Snap! can only import "text" files.\nYou selected a file of type "'+r+'".')+"\n\n"+(0,o.NC)("Open anyway?"),"Unable to import",n))}(e.files[e.files.length-1])}),!1),document.body.appendChild(e),i.filePicker=e,e.click()},B.prototype.parseTxt=function(){var t=this.target.vars[this.getter].value;this.target.setVar(this.getter,0===t.indexOf("[")?a.prototype.parseJSON(t):a.prototype.parseCSV(t))},B.prototype.setStyle=function(t){this.style=t,this.fixLayout()},B.prototype.styleNormal=function(){this.setStyle("normal")},B.prototype.styleLarge=function(){this.setStyle("large")},B.prototype.styleSlider=function(){this.setStyle("slider")},B.prototype.userSetSliderMin=function(){new lt(this,this.setSliderMin,this).prompt("Slider minimum value",this.sliderMorph.start.toString(),this.world(),null,null,null,!0)},B.prototype.userSetSliderMax=function(){new lt(this,this.setSliderMax,this).prompt("Slider maximum value",this.sliderMorph.stop.toString(),this.world(),null,null,null,!0)},B.prototype.render=function(t){var e;o.tU.isFlat||0===this.edge&&0===this.border?o.RC.uber.render.call(this,t):((e=t.createLinearGradient(0,0,0,this.height())).addColorStop(0,this.color.lighter().toString()),e.addColorStop(1,this.color.darker().toString()),t.fillStyle=e,t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),this.border>0&&((e=t.createLinearGradient(0,0,0,this.height())).addColorStop(0,this.borderColor.lighter().toString()),e.addColorStop(1,this.borderColor.darker().toString()),t.lineWidth=this.border,t.strokeStyle=e,t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke()))},P.prototype=new o.RC,P.prototype.constructor=P,P.uber=o.RC.prototype,P.prototype.init=function(t){this.isDone=!1,this.label=t?new o.XC(t,y.prototype.bubbleFontSize,null,y.prototype.bubbleFontIsBold,!1,"left"):null,this.inputField=new ct,this.button=new st(null,(()=>this.accept()),"✓"),P.uber.init.call(this,I.prototype.rounding,y.prototype.bubbleBorder,y.prototype.blockColor.sensing),this.color=o.Cj,this.label&&this.add(this.label),this.add(this.inputField),this.add(this.button),this.setWidth(b.prototype.dimensions.x-20),this.fixLayout()},P.prototype.fixLayout=function(){var t=0;this.label&&(this.label.setPosition(new o.E9(this.left()+this.edge,this.top()+this.edge)),t=this.label.bottom()-this.top()),this.inputField.setPosition(new o.E9(this.left()+this.edge,this.top()+t+this.edge)),this.inputField.setWidth(this.width()-2*this.edge-this.button.width()-this.border),this.button.setCenter(this.inputField.center()),this.button.setLeft(this.inputField.right()+this.border),this.setHeight(this.inputField.bottom()-this.top()+this.edge)},P.prototype.mouseClickLeft=function(){this.inputField.edit()},P.prototype.accept=function(){this.isDone=!0},o.qz.blocks="2020-November-17",I.prototype=new o._V,I.prototype.constructor=I,I.uber=o._V.prototype,I.prototype.contrast=65,I.prototype.setScale=function(t){var e=Math.min(Math.max(t,1),25);this.scale=e,this.corner=3*e,this.rounding=9*e,this.edge=e,this.flatEdge=.5*e,this.jag=5*e,this.inset=6*e,this.hatHeight=12*e,this.hatWidth=70*e,this.rfBorder=3*e,this.minWidth=0,this.dent=8*e,this.bottomPadding=3*e,this.cSlotPadding=4*e,this.typeInPadding=e,this.labelPadding=4*e,this.labelFontName="Verdana",this.labelFontStyle="sans-serif",this.fontSize=10*e,this.embossing=new o.E9(-1*Math.max(e/2,1),-1*Math.max(e/2,1)),this.labelWidth=450*e,this.labelWordWrap=!0,this.dynamicInputLabels=!0,this.feedbackMinHeight=5,this.minSnapDistance=20,this.reporterDropFeedbackPadding=10*e,this.labelContrast=25,this.activeHighlight=new o.Il(153,255,213),this.errorHighlight=new o.Il(173,15,0),this.activeBlur=20,this.activeBorder=4,this.rfColor=new o.Il(120,120,120)},I.prototype.setScale(1),I.prototype.isCachingInputs=!1,I.prototype.alpha=1,I.prototype.init=function(){this.cachedClr=null,this.cachedClrBright=null,this.cachedClrDark=null,this.cachedNormalColor=null,this.isStatic=!1,I.uber.init.call(this),this.defaults=[],this.cachedInputs=null,delete this.alpha},I.prototype.isNonPartMorph=function(t){return t instanceof o.qs||t instanceof J},I.prototype.parts=function(){var t=null;return this.nextBlock&&(t=this.nextBlock()),this.children.filter((e=>e!==t&&!this.isNonPartMorph(e)))},I.prototype.inputs=function(){return!(0,o.kK)(this.cachedInputs)&&this.isCachingInputs||(this.cachedInputs=this.parts().filter((t=>t instanceof I))),this.cachedInputs},I.prototype.debugCachedInputs=function(){var t,e;if((0,o.kK)(this.cachedInputs)||(t=this.parts().filter((t=>t instanceof I))),this.cachedInputs.length!==t.length)throw new Error("cached inputs size do not match: "+this.constructor.name);for(e=0;e<t.length;e+=1)if(this.cachedInputs[e]!==t[e])throw new Error("cached input does not match: "+this.constructor.name+" #"+e+" "+this.cachedInputs[e].constructor.name+" != "+t[e].constructor.name)},I.prototype.allInputs=function(){return this.allChildren().slice(0).reverse().filter((t=>t instanceof j||t instanceof D&&t!==this))},I.prototype.allEmptySlots=function(){var t=[];return this instanceof O||"reportJSFunction"===this.selector||this.children.forEach((e=>{e.isEmptySlot&&e.isEmptySlot()?t.push(e):e.allEmptySlots&&(t=t.concat(e.allEmptySlots()))})),t},I.prototype.tagExitBlocks=function(t,e){"doReport"===this.selector?this.partOfCustomCommand=e:"doStopThis"===this.selector?this.exitTag=t:this instanceof O||this.children.forEach((o=>{o.tagExitBlocks&&o.tagExitBlocks(t,e)}))},I.prototype.replaceInput=function(t,e){var o=this.parentThatIsA(N),i=e,s=this.children.indexOf(t),r=0;-1===s&&e instanceof Z&&this.children.forEach((e=>{e instanceof $&&e.argMorph()===t&&(s=r),r+=1})),t.cachedSlotSpec&&(t.cachedSlotSpec=null),e.cachedSlotSpec&&(e.cachedSlotSpec=null),this.changed(),e.parent&&e.parent.removeChild(e),t instanceof Z&&(t.inputs().forEach((e=>t.replaceInput(e,new H))),this.dynamicInputLabels&&(i=new $(e))),i.parent=this,this.children[s]=i,t instanceof D&&o&&!t.isPrototype&&(t instanceof O&&!(t instanceof O&&t.contents())||(o.add(t),t.moveBy(i.extent()),t.fixBlockColor())),i instanceof Z||i instanceof $||i.constructor===V?(i.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):this.fixLayout(),this.cachedInputs=null},I.prototype.revertToDefaultInput=function(t,e){var i,s=this.parts().indexOf(t),r=this.inputs().indexOf(t),n=new H;-1!==s&&(this instanceof A?(n=this.labelPart(this.parseSpec(this.blockSpec)[s]),this.isCustomBlock&&(i=this.isGlobal?this.definition:this.scriptTarget().getMethod(this.blockSpec),n instanceof H&&n.setChoices.apply(n,i.inputOptionsOfIdx(r)),(n instanceof H||n instanceof q)&&n.setContents(i.defaultValueOfInputIdx(r)))):this instanceof Z?n=this.labelPart(this.slotSpec):this instanceof tt&&(n=this.emptySlot())),e||-1!==r&&(n instanceof Z?(n.setContents(this.defaults),n.defaults=this.defaults):(0,o.kK)(this.defaults[r])||n.setContents(this.defaults[r])),(n.icon||n instanceof q)&&n.fixLayout(),this.replaceInput(t,n),n instanceof Z?n.refresh():n instanceof O&&n.fixBlockColor(),this.cachedInputs=null},I.prototype.isLocked=function(){return this.isStatic},I.prototype.topBlock=function(){return this.parent&&this.parent.topBlock?this.parent.topBlock():this},I.prototype.refactorVarInStack=function(t,e,i){if(!(this instanceof O&&(0,o.r3)(this.inputNames(),t)||!i&&this.definesScriptVariable(t))&&("reportGetVar"===this.selector&&this.blockSpec===t&&(this.setSpec(e),this.fullChanged(),this.fixLabelColor()),"getVarNamesDict"===this.choices&&this.contents().text===t&&this.setContents(e),this instanceof CustomCommandBlockMorph&&this.definition.body&&(0,o.kK)(this.definition.declarations.get(t))&&!(0,o.r3)(this.definition.variableNames,t)&&this.definition.body.expression.refactorVarInStack(t,e),this.inputs().forEach((o=>o.refactorVarInStack(t,e))),this.nextBlock)){var s=this.nextBlock();s&&s.refactorVarInStack(t,e)}},I.prototype.definesScriptVariable=function(t){return("doDeclareVariables"===this.selector||this.blockSpec&&this.blockSpec.match("%upvar"))&&(0,o.qY)(this.inputs()[0].allInputs(),(e=>"reportGetVar"===e.selector&&e.blockSpec===t))},I.prototype.selectForEdit=function(){var t,e=this.parentThatIsA(N),i=this.parentThatIsA(Kt),s=i?i.currentSprite:null;return e&&s&&s.inheritsAttribute("scripts")?(this.selectionID=!0,s.shadowAttribute("scripts"),t=(0,o.qY)(s.scripts.allChildren(),(t=>t.selectionID)),delete this.selectionID,delete t.selectionID,t):this},I.prototype.reactToGrabOf=function(t){var e,o=this.topBlock();t instanceof R&&(e=this.parentThatIsA(V,tt))&&e.fixLayout(),o&&(o.allComments().forEach((t=>t.align(o))),o.getHighlight()&&o.addHighlight(o.removeHighlight()))},I.prototype.bright=function(){return this.color.lighter(this.contrast).toString()},I.prototype.dark=function(){return this.color.darker(this.contrast).toString()},I.prototype.setColor=function(t){var e;t&&(this.color.eq(t)||(e=this.parentThatIsA(A),this.color=t,this.children.forEach((i=>{e&&(i instanceof o.XC||i instanceof s)?(i.shadowColor=e.color.darker(e.labelContrast),i.rerender()):i instanceof V&&i.setColor(t)})),this.rerender()))},I.prototype.setLabelColor=function(t,e,i){this.children.forEach((r=>{r instanceof o.XC&&!r.isProtectedLabel?(r.shadowOffset=i||r.shadowOffset,r.shadowColor=e||r.shadowColor,r.setColor(t)):r instanceof Z||r instanceof $||r instanceof s&&!r.isProtectedLabel||r instanceof H&&r.isReadOnly?r.setLabelColor(t,e,i):r.isLoop}))},I.prototype.flash=function(){this.cachedNormalColor||(this.cachedNormalColor=this.color,this.setColor(this.activeHighlight))},I.prototype.unflash=function(){if(this.cachedNormalColor){var t=this.cachedNormalColor;this.cachedNormalColor=null,this.setColor(t)}},I.prototype.doWithAlpha=function(t,e){var o,i=I.prototype.alpha;return I.prototype.alpha=t,o=e(),I.prototype.alpha=i,o},I.prototype.fixBlockColor=function(t,e){this.children.forEach((o=>{o instanceof I&&o.fixBlockColor(t,e)}))},I.prototype.labelPart=function(t){var e,i;if("%"===t[0]&&t.length>1&&("reportGetVar"!==this.selector||"%turtleOutline"===t&&this.isObjInputFragment())){if(t.length>5&&"%mult"===t.slice(0,5))return(e=new Z(t.slice(5))).addInput(),e;switch(t){case"%imgsource":e=new H(null,!1,{"pen trails":["pen trails"],"stage image":["stage image"]},!0);break;case"%inputs":(e=new Z("%s","with inputs")).isStatic=!1,e.canBeEmpty=!1;break;case"%scriptVars":(e=new Z("%t",null,1,t)).canBeEmpty=!1;break;case"%blockVars":(e=new Z("%t","block variables",0,t)).canBeEmpty=!1;break;case"%parms":(e=new Z("%t","Input Names:",0,t)).canBeEmpty=!1;break;case"%ringparms":e=new Z("%t","input names:",0,t);break;case"%cmdRing":(e=new O).color=y.prototype.blockColor.other,e.selector="reifyScript",e.setSpec("%rc %ringparms"),e.isDraggable=!0;break;case"%repRing":(e=new O).color=y.prototype.blockColor.other,e.selector="reifyReporter",e.setSpec("%rr %ringparms"),e.isDraggable=!0,e.isStatic=!0;break;case"%predRing":(e=new O(!0)).color=y.prototype.blockColor.other,e.selector="reifyPredicate",e.setSpec("%rp %ringparms"),e.isDraggable=!0,e.isStatic=!0;break;case"%words":(e=new Z("%s",null,0)).addInput(),e.addInput();break;case"%lists":(e=new Z("%l",null,0)).addInput(),e.addInput();break;case"%exp":(e=new Z("%s",null,0)).addInput(),e.isStatic=!0,e.canBeEmpty=!1;break;case"%br":(e=new o._V).setExtent(o.xE),e.isBlockLabelBreak=!0,e.getSpec=()=>"%br";break;case"%inputName":(e=new D).category="variables",e.color=y.prototype.blockColor.variables,e.setSpec((0,o.NC)("Input name"));break;case"%s":e=new H;break;case"%anyUE":(e=new H).isUnevaluated=!0;break;case"%txt":(e=new H).minWidth=1.7*e.height(),e.fixLayout();break;case"%mlt":(e=new K).fixLayout();break;case"%code":(e=new K).contents().fontName="monospace",e.contents().fontStyle="monospace",e.fixLayout();break;case"%obj":e=new j("object");break;case"%n":e=new H(null,!0);break;case"%dir":e=new H(null,!0,{"§_dir":null,"(90) right":90,"(-90) left":-90,"(0) up":0,"(180) down":180,random:["random"]});break;case"%note":e=new H(null,!0,"pianoKeyboardMenu",!1);break;case"%inst":e=new H(null,!0,{"(1) sine":1,"(2) square":2,"(3) sawtooth":3,"(4) triangle":4});break;case"%audio":e=new H(null,!1,"audioMenu",!0);break;case"%aa":e=new H(null,!1,{name:["name"],duration:["duration"],length:["length"],"number of channels":["number of channels"],"sample rate":["sample rate"],samples:["samples"]},!0);break;case"%img":e=new H(null,!1,{name:["name"],width:["width"],height:["height"],pixels:["pixels"]},!0);break;case"%rate":e=new H(null,!0,{"22.05 kHz":22050,"44.1 kHz":44100,"48 kHz":48e3,"88.2 kHz":88200,"96 kHz":96e3});break;case"%interaction":(e=new H(null,!1,{clicked:["clicked"],pressed:["pressed"],dropped:["dropped"],"mouse-entered":["mouse-entered"],"mouse-departed":["mouse-departed"],"scrolled-up":["scrolled-up"],"scrolled-down":["scrolled-down"],stopped:["stopped"]},!0)).isStatic=!0;break;case"%dates":e=new H(null,!1,{year:["year"],month:["month"],date:["date"],"day of week":["day of week"],hour:["hour"],minute:["minute"],second:["second"],"time in milliseconds":["time in milliseconds"]},!0);break;case"%delim":e=new H(null,!1,{letter:["letter"],word:["word"],line:["line"],tab:["tab"],cr:["cr"],csv:["csv"],json:["json"]},!1);break;case"%ida":e=new H(null,!0,{1:1,last:["last"],"~":null,all:["all"]});break;case"%idx":e=new H(null,!0,{1:1,last:["last"],any:["any"]});break;case"%dim":e=new H(null,!0,{current:["current"]});break;case"%rel":e=new H(null,!1,{distance:["distance"],direction:["direction"]},!0);break;case"%loc":e=new H(null,!1,"locationMenu",!0);break;case"%spr":e=new H(null,!1,"objectsMenu",!0);break;case"%self":e=new H(null,!1,"objectsMenuWithSelf",!0);break;case"%col":e=new H(null,!1,"collidablesMenu",!0);break;case"%dst":e=new H(null,!1,"distancesMenu",!0);break;case"%cln":e=new H(null,!1,"clonablesMenu",!0);break;case"%get":(e=new H(null,!1,"gettablesMenu",!0)).isStatic=!0;break;case"%cst":e=new H(null,!1,"costumesMenu",!0);break;case"%eff":e=new H(null,!1,{color:["color"],saturation:["saturation"],brightness:["brightness"],ghost:["ghost"],fisheye:["fisheye"],whirl:["whirl"],pixelate:["pixelate"],mosaic:["mosaic"],negative:["negative"]},!0);break;case"%snd":e=new H(null,!1,"soundsMenu",!0);break;case"%key":e=new H(null,!1,{"any key":["any key"],"up arrow":["up arrow"],"down arrow":["down arrow"],"right arrow":["right arrow"],"left arrow":["left arrow"],space:["space"],"+":["+"],"-":["-"],a:["a"],b:["b"],c:["c"],d:["d"],e:["e"],f:["f"],g:["g"],h:["h"],i:["i"],j:["j"],k:["k"],l:["l"],m:["m"],n:["n"],o:["o"],p:["p"],q:["q"],r:["r"],s:["s"],t:["t"],u:["u"],v:["v"],w:["w"],x:["x"],y:["y"],z:["z"],0:["0"],1:["1"],2:["2"],3:["3"],4:["4"],5:["5"],6:["6"],7:["7"],8:["8"],9:["9"]},!0);break;case"%keyHat":(e=this.labelPart("%key")).isStatic=!0;break;case"%msg":e=new H(null,!1,"messagesMenu",!0);break;case"%msgHat":(e=new H(null,!1,"messagesReceivedMenu",!0)).isStatic=!0;break;case"%att":e=new H(null,!1,"attributesMenu",!0);break;case"%fun":e=new H(null,!1,{abs:["abs"],neg:["neg"],ceiling:["ceiling"],floor:["floor"],sqrt:["sqrt"],sin:["sin"],cos:["cos"],tan:["tan"],asin:["asin"],acos:["acos"],atan:["atan"],ln:["ln"],log:["log"],lg:["lg"],"e^":["e^"],"10^":["10^"],"2^":["2^"],id:["id"]},!0);break;case"%layer":e=new H(null,!1,{front:["front"],back:["back"]},!0);break;case"%hsva":e=new H(null,!1,{hue:["hue"],saturation:["saturation"],brightness:["brightness"],transparency:["transparency"]},!0);break;case"%pen":e=new H(null,!1,{size:["size"],hue:["hue"],saturation:["saturation"],brightness:["brightness"],transparency:["transparency"]},!0);break;case"%asp":e=new H(null,!1,{hue:["hue"],saturation:["saturation"],brightness:["brightness"],transparency:["transparency"],"r-g-b-a":["r-g-b-a"],"~":null,sprites:["sprites"]},!0);break;case"%layer":(e=new H(null,!1,{front:["front"],back:["back"]},!0)).setContents(["front"]);break;case"%hsva":(e=new H(null,!1,{hue:["hue"],saturation:["saturation"],brightness:["brightness"],transparency:["transparency"]},!0)).setContents(["hue"]);break;case"%asp":(e=new H(null,!1,{hue:["hue"],saturation:["saturation"],brightness:["brightness"],transparency:["transparency"],"~":null,sprites:["sprites"]},!0)).setContents(["hue"]);break;case"%txtfun":e=new H(null,!1,{"encode URI":["encode URI"],"decode URI":["decode URI"],"encode URI component":["encode URI component"],"decode URI component":["decode URI component"],"XML escape":["XML escape"],"XML unescape":["XML unescape"],"hex sha512 hash":["hex sha512 hash"]},!0);break;case"%stopChoices":(e=new H(null,!1,{all:["all"],"this script":["this script"],"this block":["this block"],"all but this script":["all but this script"],"other scripts in sprite":["other scripts in sprite"]},!0)).isStatic=!0;break;case"%setting":(e=new H(null,!1,{"turbo mode":["turbo mode"],"flat line ends":["flat line ends"],"log pen vectors":["log pen vectors"],"video capture":["video capture"],"mirror video":["mirror video"]},!0)).isStatic=!0;break;case"%typ":e=new H(null,!1,"typesMenu",!0);break;case"%mapValue":(e=new H(null,!1,{String:["String"],Number:["Number"],true:["true"],false:["false"]},!0)).isStatic=!0;break;case"%var":(e=new H(null,!1,"getVarNamesDict",!0)).isStatic=!0;break;case"%shd":e=new H(null,!1,"shadowedVariablesMenu",!0);break;case"%codeKind":e=new H(null,!1,{code:["code"],header:["header"]},!0);break;case"%l":e=new j("list");break;case"%b":e=new q;break;case"%boolUE":(e=new q).isUnevaluated=!0;break;case"%bool":(e=new q(!0)).isStatic=!0;break;case"%cmd":e=new V;break;case"%rc":(e=new W).isStatic=!0;break;case"%rr":(e=new et).isStatic=!0;break;case"%rp":(e=new et(!0)).isStatic=!0;break;case"%c":(e=new z).isStatic=!0;break;case"%cs":e=new z;break;case"%ca":(e=new z).isLoop=!0,e.add(this.labelPart("%loopArrow"));break;case"%cl":(e=new z).isStatic=!0,e.isLambda=!0;break;case"%cla":(e=new z).isStatic=!0,e.isLambda=!0,e.isLoop=!0;break;case"%loop":(e=new z).isStatic=!0,e.isLoop=!0;break;case"%loopArrow":break;case"%clr":(e=new X).isStatic=!0;break;case"%t":e=new G("a");break;case"%upvar":e=new G("↑");break;case"%f":e=new Q;break;case"%r":e=new tt;break;case"%p":e=new tt(!0);break;case"%codeListPart":e=new H(null,!1,{list:["list"],item:["item"],delimiter:["delimiter"]},!0);break;case"%codeListKind":e=new H(null,!1,{collection:["collection"],variables:["variables"],parameters:["parameters"]},!0);break;case"%turtle":(e=new L("turtle")).size=1.2*this.fontSize,e.color=o.Cj,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=o.tU.isFlat?o.xE:this.embossing,e.fixLayout();break;case"%turtleOutline":(e=new L("turtleOutline")).size=this.fontSize,e.color=o.Cj,e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=o.tU.isFlat?o.xE:this.embossing,e.fixLayout();break;case"%clockwise":(e=new L("turnRight")).size=1.5*this.fontSize,e.color=o.Cj,e.isProtectedLabel=!1,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=o.tU.isFlat?o.xE:this.embossing,e.fixLayout();break;case"%counterclockwise":(e=new L("turnLeft")).size=1.5*this.fontSize,e.color=o.Cj,e.isProtectedLabel=!1,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=o.tU.isFlat?o.xE:this.embossing,e.fixLayout();break;case"%greenflag":(e=new L("flag")).size=1.5*this.fontSize,e.color=new o.Il(0,200,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=o.tU.isFlat?o.xE:this.embossing,e.fixLayout();break;case"%stop":(e=new L("octagon")).size=1.5*this.fontSize,e.color=new o.Il(200,0,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=o.tU.isFlat?o.xE:this.embossing,e.fixLayout();break;case"%pause":(e=new L("pause")).size=this.fontSize,e.color=new o.Il(255,220,0),e.isProtectedLabel=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=o.tU.isFlat?o.xE:this.embossing,e.fixLayout();break;case"%blitz":(e=new L("flash")).size=this.fontSize,e.color=o.Cj,e.isProtectedLabel=!1,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=o.tU.isFlat?o.xE:this.embossing,e.fixLayout();break;case"%list":(e=new L("list")).size=this.fontSize,e.color=o.Cj,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=o.tU.isFlat?o.xE:this.embossing,e.fixLayout();break;case"%vid":e=new H(null,!1,{snap:["snap"],motion:["motion"],direction:["direction"]},!0);break;case"%on":e=new H(null,!1,{"this sprite":["this sprite"],stage:["stage"]},!0);break;default:(0,o.WY)()}}else"$"===t[0]&&t.length>1&&"reportGetVar"!==this.selector?(i=t.slice(1).split("-"),(0,o.r3)(s.prototype.names,i[0])?(e=new L(i[0])).size=this.fontSize*(+i[1]||1.2):((e=new o.XC(i[0])).fontName=this.labelFontName,e.fontStyle=this.labelFontStyle,e.fontSize=this.fontSize*(+i[1]||1)),e.color=new o.Il(0==+i[2]?0:+i[2]||255,0==+i[3]?0:+i[3]||255,0==+i[4]?0:+i[4]||255),e.isProtectedLabel=i.length>2,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=o.tU.isFlat?o.xE:this.embossing,e.fixLayout()):e=new E(t,this.fontSize,this.labelFontStyle,!0,!1,!1,o.tU.isFlat?o.xE:this.embossing,this.color.darker(this.labelContrast),o.Cj,this.labelFontName);return e},I.prototype.isObjInputFragment=function(){return"reportGetVar"===this.selector&&"%t"===this.getSlotSpec()&&"%obj"===this.parent.fragment.type},I.prototype.fixLayout=function(){var t,e,i,s,r=this.parts(),n=this.position(),a=0,h=0,l=0,p=this.minWidth,c=[],d=[],u=this.isPrototype?1:Math.floor((0,o.SW)(this.fontSize)/3),f=this instanceof A&&this.hasLocationPin()?this.methodIconExtent().x+u:0,g=!1,y=!1;this instanceof Z&&"%cs"!==this.slotSpec?p+=this.arrows().width():p+=this instanceof D?2*this.rounding+2*this.edge:4*this.corner+2*this.edge+3*this.inset+this.dent,this.nextBlock&&(t=this.nextBlock()),r.forEach((t=>{t instanceof z||"%cs"===t.slotSpec?c.length>0?(d.push(c),d.push([t]),c=[],a=0):d.push([t]):this.isNonPartMorph(t)?(0,o.WY)():(t.isVisible&&(a+=t.fullBounds().width()+u),(a>this.labelWidth||t.isBlockLabelBreak)&&c.length>0&&(d.push(c),c=[],a=t.fullBounds().width()+u),c.push(t),t.isBlockLabelBreak&&(a=0))})),c.length>0&&d.push(c),this instanceof R?(e=this.top()+this.corner+this.edge,this instanceof F&&(e+=this.hatHeight)):this instanceof D?e=this.top()+2*this.edge:(this instanceof Z||this instanceof $)&&(e=this.top(),"%cs"===this.slotSpec&&this.inputs().length>0&&(e-=this.rounding)),d.forEach((t=>{g&&(y=!0,g=!1),a=this.left()+f+this.edge+this.labelPadding,this instanceof O?a=this.left()+u:this.isPredicate?a=this.left()+f+this.rounding:(this instanceof Z||this instanceof $)&&(a=this.left()),e+=h,h=0,t.forEach((t=>{t.isLoop&&(g=!0),t instanceof z?(a-=this.labelPadding,this.isPredicate&&(a=this.left()+f+this.rounding),t.setColor(this.color),t.setPosition(new o.E9(a,e)),h=t.height()):t instanceof Z&&"%cs"===t.slotSpec?(this.isPredicate&&(a+=this.corner),t.setPosition(new o.E9(a,e)),h=t.height()):t instanceof Z&&"%cs"===t.slotSpec?(myself.isPredicate&&(a+=myself.corner),t.setPosition(new o.E9(a,e)),h=t.height()):(t.setPosition(new o.E9(a,e)),t.isBlockLabelBreak||("%c"===t.slotSpec||"%loop"===t.slotSpec?a+=t.width():t.isVisible&&(a+=t.fullBounds().width()+u)),l=Math.max(l,a),h=Math.max(h,t instanceof o.XC?t.rawHeight():t.height()))})),y&&(a+=1.5*this.fontSize,l=Math.max(l,a),y=!1),t.forEach((t=>{t.moveBy(new o.E9(0,Math.floor((h-t.height())/2)))}))})),e+=h,this.children.some((t=>t instanceof z))&&(s=this.bottomPadding,this instanceof D&&!this.isPredicate&&(s=Math.max(this.bottomPadding,this.rounding-this.bottomPadding)),e+=s),this instanceof R?i=e-this.top()+2*this.corner:this instanceof D?i=e-this.top()+2*this.edge:(this instanceof Z||this instanceof $)&&(i=e-this.top()),this.isPredicate?p=Math.max(p,l-this.left()+this.rounding):this instanceof Z&&"%cs"!==this.slotSpec||this instanceof $?p=Math.max(p,l-this.left()-u):(p=Math.max(p,l-this.left()+this.labelPadding-this.edge),r[r.length-1]instanceof Z&&1===d.length&&(p-=u),this instanceof F&&(p=Math.max(p,1.5*this.hatWidth))),this.bounds.setWidth(p),this.bounds.setHeight(i),this.holes=[],r.forEach((t=>{var e=0;(t instanceof z||"%cs"===t.slotSpec)&&(this.isPredicate?(t.bounds.setWidth(p-f-this.rounding-this.inset-this.corner),e=this.corner):(t.bounds.setWidth(p-this.edge-f),e=this.corner+this.edge),t.fixLoopLayout&&t.fixLoopLayout()),"%cs"===t.slotSpec&&t.inputs().forEach((o=>o.bounds.setWidth(t.right()-o.left()-e))),t.fixHolesLayout(),this.holes.push.apply(this.holes,t.holes.map((e=>e.translateBy(t.position().subtract(n)))))})),t&&t.setPosition(new o.E9(this.left(),this.bottom()-this.corner)),this instanceof A&&this.parent&&this.parent.fixLayout&&(this.parent.fixLayout(),this.parent.changed(),this.parent instanceof I)||this.fixHighlight()},I.prototype.fixHighlight=function(){var t=this.topBlock();t.getHighlight&&t.getHighlight()&&t.addHighlight(t.removeHighlight())},I.prototype.methodIconExtent=function(){var t=1.2*this.fontSize;return this.hasLocationPin()?new o.E9(.66*t,t):new o.E9(0,0)},I.prototype.evaluate=function(){return null},I.prototype.isEmptySlot=function(){return!1},I.prototype.exportPictureWithResult=function(t){var e=this.parentThatIsA(Kt)||this.parentThatIsA(BlockEditorMorph).target.parentThatIsA(Kt),i=this.fullImage(),s=t.fullImage(),r=Math.max(0,s.height-i.height),n=(0,o.oM)(new o.E9(i.width+s.width+2,i.height+r)),a=n.getContext("2d");a.drawImage(i,0,n.height-i.height),a.drawImage(s,i.width+2,0),e.saveCanvasAs(n,(e.projectName||(0,o.NC)("untitled"))+" "+(0,o.NC)("script pic"))},I.prototype.mappedCode=function(t){var e=this.evaluate();return e instanceof A?e.mappedCode(t):e},E.prototype=new o.XC,E.prototype.constructor=E,E.uber=o.XC.prototype,E.prototype.getRenderColor=function(){var t=this.parentThatIsA(A);return o.tU.isFlat?t.alpha>.5?this.color:t.color.solid().darker(Math.max(200*t.alpha,.1)):t.alpha>.5?this.color:t.color.solid().lighter(Math.max(200*t.alpha,.1))},E.prototype.getShadowRenderColor=function(){return this.parentThatIsA(A).alpha>.5?this.shadowColor:o.EO},L.prototype=new s,L.prototype.constructor=L,L.uber=s.prototype,L.prototype.getRenderColor=function(){var t=this.parentThatIsA(A);return o.tU.isFlat?this.isFading?this.color.mixed(t.alpha,o.Cj):this.color.eq(o.Cj)||this.color.eq(o.E5)?this.parent.alpha>.5?this.color:t.color.solid().darker(Math.max(200*t.alpha,.1)):this.color:this.isFading?this.color.mixed(t.alpha,y.prototype.paletteColor):this.color.eq(o.E5)?t.alpha>.5?this.color:t.color.solid().lighter(Math.max(200*t.alpha,.1)):this.color.eq(o.Cj)?this.parent.alpha>.5?this.color:t.color.solid().lighter(Math.max(200*t.alpha,.1)):this.color},L.prototype.getShadowRenderColor=function(){return this.parent.alpha>.5?this.shadowColor:o.EO},A.prototype=new I,A.prototype.constructor=A,A.uber=I.prototype,A.nextId=0,A.copyIDs=!1,A.prototype.isCachingInputs=!0,A.prototype.zebraContrast=40,A.prototype.snapSound=null,A.prototype.toggleSnapSound=function(){null!==this.snapSound?this.snapSound=null:(A.prototype.snapSound=document.createElement("audio"),A.prototype.snapSound.src="src/click.wav"),ot.prototype.snapSound=A.prototype.snapSound},A.prototype.init=function(){this.id=A.nextId++,this.selector=null,this.blockSpec="",this.comment=null,this.instantiationSpec=null,this.category=null,this.isCorpse=!1,A.uber.init.call(this),this.color=new o.Il(102,102,102),this.cachedInputs=null},A.prototype.getNewID=function(){this.id=A.nextId++},A.prototype.scriptTarget=function(){var t,e=this.parentThatIsA(N);if(e)return e.scriptTarget();if(t=this.parentThatIsA(Kt))return t.currentSprite;throw new Error("script target cannot be found for orphaned block")},A.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+' ("'+this.blockSpec.slice(0,30)+'...")'},A.prototype.blockId=function(){return{selector:this.selector,id:this.id,template:this.isTemplate,spec:this.blockSpec}},A.prototype.userDestroy=function(){},A.prototype.parseSpec=function(t){var e,i=[],s="";return 0===(e=(0,o.HD)(t)?t.split(" "):[]).length&&(e=[t]),this.labelWordWrap?e:(e.forEach((t=>{var e;"%"===(e=t)[0]&&e.length>1?(""!==s&&(i.push(s),s=""),i.push(e)):""!==s?s+=" "+e:s=e})),""!==s&&i.push(s),i)},A.prototype.setSpec=function(t,e){var i,s=-1;t&&(this.parts().forEach((t=>t.destroy())),this.isPrototype&&this.add(this.placeHolder()),this.parseSpec(t).forEach(((t,r,n)=>{"%"===t[0]&&"%br"!==t&&(s+=1),i=this.labelPart(t),(0,o.kK)(i)||(this.add(i),i instanceof V||i instanceof o.XC||(i.fixLayout(),i.rerender()),i instanceof O&&i.fixBlockColor(),(i instanceof Z||i.constructor===V||i.constructor===W)&&i.fixLayout(),this.isPrototype&&this.add(this.placeHolder()),i instanceof H&&this.isCustomBlock&&i.setChoices.apply(i,(e||this.definition).inputOptionsOfIdx(s)))})),this.blockSpec=t,this.fixLayout(),this.rerender(),this.cachedInputs=null)},A.prototype.userSetSpec=function(t){var e=this.topBlock();e.fullChanged(),this.setSpec(t),e.fullChanged()},A.prototype.buildSpec=function(){this.blockSpec="",this.parts().forEach((t=>{t instanceof o.XC?this.blockSpec+=t.text:t instanceof j||t.isBlockLabelBreak?this.blockSpec+=t.getSpec():this.blockSpec+="[undefined]",this.blockSpec+=" "})),this.blockSpec=this.blockSpec.trim()},A.prototype.rebuild=function(t){this.setSpec(this.blockSpec),t&&this.inputs().forEach((e=>{e instanceof D&&(e.setColor(e.color.lighter(t)),e.setSpec(e.blockSpec))}))},A.prototype.showMessageUsers=function(){var t,e,o,i=this.parentThatIsA(Kt)||this.parentThatIsA(BlockEditorMorph).target.parentThatIsA(Kt),s=i.corral,r=0===this.selector.indexOf("receive")?"allSendersOf":"allHatBlocksFor",n=this.inputs();"receiveGo"===this.selector?t="__shout__go__":"receiveOnClone"===this.selector?t="__clone__init__":n[0]instanceof H&&(t=n[0].evaluate()),"doSend"===this.selector&&n[1]instanceof H?e=this.inputs()[1].evaluate():0===this.selector.indexOf("receive")&&(e=this.scriptTarget().name),""!==t&&("allSendersOf"===r&&(o=i.stage.globalBlocksSending(t,e)),s.frame.contents.children.concat(s.stageIcon).forEach((i=>{i.object&&("doSend"!==this.selector||e===i.object.name)&&i.object[r](t,e,o).length>0&&i.flash()})))},A.prototype.isSending=function(t,e,i=[]){return"number"==typeof t&&(t=t.toString()),this.allChildren().some((s=>{var r,n;return!!(s.isCustomBlock&&s.isGlobal&&(0,o.r3)(i,s.definition))||!(!s.selector||!(0,o.r3)(["doBroadcast","doBroadcastAndWait","doSend"],s.selector))&&(r=s.inputs()[0].evaluate(),"doSend"===s.selector&&(n=s.inputs()[1].evaluate()),("doSend"!==s.selector||e===n)&&(r===t||t instanceof Array&&"any message"===t[0]))}))},A.prototype.developersMenu=function(){var t=A.uber.developersMenu.call(this);return t.addLine(),t.addItem("delete block","deleteBlock"),t.addItem("spec...",(()=>new lt(this,this.userSetSpec,this).prompt(t.title+"\nspec",this.blockSpec,this.world()))),t},A.prototype.hidePrimitive=function(){var t,e=this.parentThatIsA(Kt);e&&(b.prototype.hiddenPrimitives[this.selector]=!0,"lists"===(t={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"}[this.selector]||this.category)&&(t="variables"),e.flushBlocksCache(t),e.refreshPalette())},A.prototype.isInheritedVariable=function(t){return!!(this.isTemplate&&"reportGetVar"===this.selector&&this.parent instanceof o.xZ)&&(0,o.r3)(this.scriptTarget().inheritedVariableNames(t),this.blockSpec)},A.prototype.isTransientVariable=function(){var t=this.scriptTarget().variables.silentFind(this.blockSpec);return!!t&&t.vars[this.blockSpec].isTransient},A.prototype.toggleTransientVariable=function(){var t=this.scriptTarget().variables.silentFind(this.blockSpec);t&&(t.vars[this.blockSpec].isTransient=!t.vars[this.blockSpec].isTransient)},A.prototype.deleteBlock=function(){var t,e,o=this.parentThatIsA(N),i=this.nextBlock?this.nextBlock():null;o&&(i&&o.add(i),this.inputs().forEach((t=>{t instanceof A&&o.add(t)}))),this instanceof D&&(this.parent instanceof A||this.parent instanceof Z||this.parent instanceof tt)?this.parent.revertToDefaultInput(this):this.parent&&this.parent.fixLayout?t=this.parentThatIsA(j):e=!0,this.destroy(),e&&(this.isCorpse=!0),t&&t.fixLayout()},A.prototype.ringify=function(){var t,e,o,i=this.selectForEdit();if(i!==this)return this.ringify.call(i);if(t=new O,o=(e=this.topBlock()).fullBounds().center(),null===this.parent)return null;if(e.fullChanged(),this.parent instanceof I){if(this instanceof D)this.parent.replaceInput(this,t,!0),t.embed(this,null,!0);else if(e){if(e instanceof F)return;e.parent.add(t),t.embed(e),t.setCenter(o)}}else this.parent.add(t),t.embed(this),t.setCenter(o);this.fixBlockColor(null,!0),e.fullChanged()},A.prototype.unringify=function(){var t,e,o,i,s,r=this.selectForEdit();return r!==this?this.unringify.call(r):(t=this.parent.parentThatIsA(O),e=this.topBlock(),i=this.parentThatIsA(N),null===t?null:(s=t.contents(),o=t.center(),e.fullChanged(),t.parent instanceof I?s instanceof D?t.parent.replaceInput(t,s):i&&(i.add(s),s.setFullCenter(o),s.moveBy(20),t.parent.revertToDefaultInput(t)):(t.parent.add(s),s.setFullCenter(o),t.destroy()),this.fixBlockColor(null,!0),void e.fullChanged()))},A.prototype.relabel=function(t){var e,i,s=this.selectForEdit();if(s!==this)return this.relabel.call(s,t);e=new o.wR(this),i=this.inputs(),t.forEach((t=>{var s,r,n;t instanceof Array?(r=t[0],n=-t[1]):(r=t,n=0),(s=y.prototype.blockForSelector(r,!0)).restoreInputs(i,n),s.fixBlockColor(null,!0),s.addShadow(new o.E9(3,3)),e.addItem(s.doWithAlpha(1,(()=>s.fullImage())),(()=>{this.setSelector(r,-n)}))})),e.popup(this.world(),this.bottomLeft().subtract(new o.E9(8,this instanceof R?this.corner:0)))},A.prototype.setSelector=function(t,e=0){var i,s,r,n,a=this.inputs(),h=this.parentThatIsA(N);if(s=y.prototype.blocks[t],this.setCategory(s.category),this.selector=t,this.setSpec((0,o.NC)(s.spec)),this.defaults=s.defaults||[],(r=this.inputs())[0]instanceof Z)r[0].setContents(this.defaults),r[0].defaults=this.defaults;else for(n=0;n<this.defaults.length;n+=1)null!==this.defaults[n]&&r[n].setContents&&r[n].setContents(this.defaults[n]);i=this.restoreInputs(a,-e),this.fixLabelColor(),h&&i.length&&i.forEach((t=>{t.moveBy(10),h.add(t)}))},A.prototype.restoreInputs=function(t,e=0){var o,i,s,r=[];for(A.copyIDs=!0,s=0;s<e;s+=1)(o=t[s])instanceof D?r.push(o):o instanceof V&&(i=o.nestedBlock())&&r.push(i);for(this.inputs().forEach((s=>{(o=t[e])instanceof O?o.contents()&&this.replaceInput(s,o.fullCopy()):o instanceof D?s instanceof G||s.isStatic?r.push(o):this.replaceInput(s,o.fullCopy()):o&&s instanceof H?o.contents&&(s.setContents(o.contents().text),o.constant&&(s.constant=o.constant)):o instanceof z&&s instanceof z&&(i=o.nestedBlock())&&s.nestedBlock(i.fullCopy()),e+=1}));e<t.length;e+=1)(o=t[e])instanceof D?r.push(o):o instanceof V&&(i=o.nestedBlock())&&r.push(i);return this.cachedInputs=null,A.copyIDs=!1,r},A.prototype.showHelp=function(){var t,e,i,s,r,n,a=this,h=this.parentThatIsA(Kt),l=new Image;if(n=this.isCustomBlock?this.isGlobal?this.definition.helpSpec():this.scriptTarget().getMethod(this.blockSpec).helpSpec():this.selector,h||(t=this.parentThatIsA(BlockEditorMorph))&&(h=t.target.parentThatIsA(Kt)),l.onload=function(){(e=(0,o.oM)(new o.E9(l.width,l.height),!0)).getContext("2d").drawImage(l,0,0),(new lt).inform("Help",null,a.world(),e)},this.isCustomBlock&&(s=(i=this.isGlobal?this.definition:this.scriptTarget().getMethod(this.blockSpec)).comment))return(r=i.blockInstance()).refreshDefaults(i),(s=s.fullCopy()).contents.parse(),e="",s.contents.lines.forEach((t=>e=e+"\n"+t)),void(new lt).inform("Help",e.substr(1),a.world(),r.doWithAlpha(1,(()=>(r.addShadow(),r.fullImage()))));l.src=h.resourceURL("help",n+".png")},A.prototype.exportResultPic=function(){var t,e=this.topBlock(),o=e.scriptTarget();e===this&&(o&&(t=o.parentThatIsA(b))&&(t.threads.stopProcess(e),t.threads.startProcess(e,o,!1,!0)),pic.src=ide.resourceURL("help",spec+".png"))},A.prototype.mapToHeader=function(){var t,e,i="reify"===this.selector.substr(0,5)?"reify":this.selector,s=this.codeDefinitionHeader();s.addShadow(new o.E9(3,3)),e=s.doWithAlpha(1,(()=>s.fullImage())),t=this.isCustomBlock?"Enter code that corresponds to the block's definition. Use the formal parameter\nnames as shown and <body> to reference the definition body's generated text code.":"Enter code that corresponds to the block's definition. Choose your own\nformal parameter names (ignoring the ones shown).",new lt(this,(t=>{"evaluateCustomBlock"===i?this.definition.codeHeader=t:b.prototype.codeHeaders[i]=t}),this).promptCode("Header mapping","evaluateCustomBlock"===i?this.definition.codeHeader||"":b.prototype.codeHeaders[i]||"",this.world(),e,t)},A.prototype.mapToCode=function(){var t,e="reify"===this.selector.substr(0,5)?"reify":this.selector,i=this.codeMappingHeader();i.addShadow(new o.E9(3,3)),t=i.doWithAlpha(1,(()=>i.fullImage())),new lt(this,(t=>{"evaluateCustomBlock"===e?this.definition.codeMapping=t:b.prototype.codeMappings[e]=t}),this).promptCode("Code mapping","evaluateCustomBlock"===e?this.definition.codeMapping||"":b.prototype.codeMappings[e]||"",this.world(),t,"Enter code that corresponds to the block's operation (usually a single\nfunction invocation). Use <#n> to reference actual arguments as shown.")},A.prototype.mapHeader=function(t,e){var o=e||"reify"===this.selector.substr(0,5)?"reify":this.selector;t&&(this.isCustomBlock?this.definition.codeHeader=t:b.prototype.codeHeaders[o]=t)},A.prototype.mapCode=function(t,e){var o=e||"reify"===this.selector.substr(0,5)?"reify":this.selector;t&&(this.isCustomBlock?this.definition.codeMapping=t:b.prototype.codeMappings[o]=t)},A.prototype.mappedCode=function(t){var e,o,i,s,r,n,a,h="reify"===this.selector.substr(0,5)?"reify":this.selector,l=1,p=this.isCustomBlock?this.definition.spec:h,c=t||{},d=[];return e="reportGetVar"===h?this.blockSpec:this.isCustomBlock?this.definition.codeMapping||"":b.prototype.codeMappings[h]||"","reportGetVar"===h||c.hasOwnProperty(p)||(c[p]=null,this.isCustomBlock?(-1!==(i=this.definition.codeHeader||"").indexOf("<body")&&(n="",this.definition.body&&(n=this.definition.body.expression.mappedCode(c)),a=n.split("\n"),(r=i.split("\n")).forEach(((t,e)=>{var o,i="";0===t.trimLeft().indexOf("<body")&&(o=t.indexOf("<body"),i=t.slice(0,o)),r[e]=t.replace(new RegExp("<body>"),a.join("\n"+i)),r[e]=r[e].replace(new RegExp("<body>","g"),a.join("\n"))})),i=r.join("\n")),c[p]=i):c[p]=b.prototype.codeHeaders[p]),o=e.split("\n"),this.inputs().forEach((t=>d.push(t.mappedCode(c).toString()))),d.forEach((t=>{var e=t.split("\n"),i="<#"+l+">",s=new RegExp(i,"g");o.forEach(((t,r)=>{var n,a="";0===t.trimLeft().indexOf(i)&&(n=t.indexOf(i),a=t.slice(0,n)),o[r]=t.replace(new RegExp(i),e.join("\n"+a)),o[r]=o[r].replace(s,e.join("\n"))})),l+=1})),e=o.join("\n"),this.nextBlock&&this.nextBlock()&&(e+="\n"+this.nextBlock().mappedCode(c)),!t&&(s=[],Object.keys(c).forEach((t=>{c[t]&&s.push(c[t])})),s.length)?s.join("\n\n")+"\n\n"+e:e},A.prototype.codeMappingHeader=function(){var t=this.isCustomBlock?this.definition.blockInstance():y.prototype.blockForSelector(this.selector),e=new F,o=1;return t.inputs().forEach((e=>{var i=new G("<#"+o+">");t.replaceInput(e,i),o+=1})),t.isPrototype=!0,e.setCategory("control"),e.setSpec("%s"),e.replaceInput(e.inputs()[0],t),"control"===this.category&&e.alternateBlockColor(),e},A.prototype.refactorThisVar=function(t){var e=this.scriptTarget(),o=this.instantiationSpec||this.blockSpec,i=this.fullCopy();i.addShadow(),new lt(this,(function(i){this.parent instanceof I?this.parentThatIsA(BlockEditorMorph)?this.doRefactorBlockParameter(o,i,t):this.parentThatIsA(O)?this.doRefactorRingParameter(o,i,t):this.doRefactorScriptVar(o,i,t):e.hasSpriteVariable(o)?this.doRefactorSpriteVar(o,i,t):this.doRefactorGlobalVar(o,i,t)}),this).prompt("Variable name",o,this.world(),i.doWithAlpha(1,(()=>i.fullImage())),H.prototype.getVarNamesDict.call(this))},A.prototype.varExistsError=function(t,e){t.inform("Variable exists","A variable with this name already exists "+(e||"in this context")+".")},A.prototype.doRefactorBlockParameter=function(t,e,o){var i=this.parentThatIsA(BlockInputFragmentMorph),s=i.fragment.copy(),r=i.parent,n=this.parentThatIsA(BlockEditorMorph),a=n.body.contents;r.anyChild((t=>t.blockSpec===e))?this.varExistsError(n.target.parentThatIsA(Kt)):(s.labelString=e,i.updateBlockLabel(s),o||a.children.forEach((o=>o.refactorVarInStack(t,e))))},A.prototype.doRefactorRingParameter=function(t,e,i){var s=this.parentThatIsA(O),r=s.contents(),n=this.topBlock();(0,o.r3)(s.inputNames(),e)?this.varExistsError(this.parentThatIsA(Kt)):(n.fullChanged(),this.setSpec(e),i||r&&r.refactorVarInStack(t,e),n.fullChanged())},A.prototype.doRefactorScriptVar=function(t,e,o){var i,s=this.parentThatIsA(R);if(s.definesScriptVariable(e))return i=this.scriptTarget().parentThatIsA(Kt),void this.varExistsError(i);this.userSetSpec(e),o||s.refactorVarInStack(t,e,!0)},A.prototype.doRefactorSpriteVar=function(t,e,i){var s,r=this.scriptTarget(),n=r.parentThatIsA(Kt),a=r.findVariableWatcher(t);r.hasSpriteVariable(e)?this.varExistsError(n):(0,o.kK)(n.globalVariables.vars[e])?(s=r.variables.getVar(t),r.deleteVariable(t),r.addVariable(e,!1),r.variables.setVar(e,s),a&&a.isVisible&&r.toggleVariableWatcher(e,!1).setPosition(a.position()),i||(r.refactorVariableInstances(t,e,!1),r.customBlocks.forEach((o=>o.body.expression.refactorVarInStack(t,e)))),n.flushBlocksCache("variables"),n.refreshPalette()):this.varExistsError(n,"as a global variable")},A.prototype.doRefactorGlobalVar=function(t,e,i){var s,r=this.scriptTarget(),n=r.parentThatIsA(Kt),a=n?n.stage:null,h=r.findVariableWatcher(t);(0,o.kK)(n.globalVariables.vars[e])?(0,o.qY)(a.children,(t=>t instanceof y&&t.hasSpriteVariable(e)))?this.varExistsError(n,"as a sprite local variable"):(s=n.globalVariables.getVar(t),a.deleteVariable(t),a.addVariable(e,!0),n.globalVariables.setVar(e,s),h&&h.isVisible&&r.toggleVariableWatcher(e,!0).setPosition(h.position()),i||(a.refactorVariableInstances(t,e,!0),a.globalBlocks.forEach((o=>{o.body&&o.body.expression.refactorVarInStack(t,e)})),a.forAllChildren((o=>{o instanceof y&&(o.refactorVariableInstances(t,e,!0),o.customBlocks.forEach((o=>o.body.expression.refactorVarInStack(t,e))))}))),n.flushBlocksCache("variables"),n.refreshPalette()):this.varExistsError(n)},A.prototype.thumbnail=function(t,e){var i,s,r,n,a=this.nextBlock();return a&&(a.isVisible=!1),i=this.fullBounds().extent(),(r=(s=(0,o.oM)(new o.E9(e?Math.min(i.x*t,e):i.x*t,i.y*t))).getContext("2d")).scale(t,t),r.drawImage(this.fullImage(),0,0),e&&i.x*t>e&&((n=r.createLinearGradient(s.width/t-12,0,s.width/t,0)).addColorStop(0,"transparent"),n.addColorStop(1,"black"),r.globalCompositeOperation="destination-out",r.fillStyle=n,r.fillRect(s.width/t-12,0,s.width/t,s.height/t)),a&&(a.isVisible=!0),s},A.prototype.scriptPic=function(){var t=this.fullImage(),e=this.stackFullBounds(),i=(0,o.oM)(e.extent()),s=i.getContext("2d");return this.allComments().forEach((t=>s.drawImage(t.fullImage(),t.fullBounds().left()-e.left(),t.top()-e.top()))),s.drawImage(t,0,0),i},A.prototype.fullImage=function(){var t,e,i,s;return 1===this.alpha?A.uber.fullImage.call(this):(this.forAllChildren((t=>{t instanceof A&&t.mouseLeaveBounds()})),t=A.uber.fullImage.call(this),e=this.doWithAlpha(1,(()=>A.uber.fullImage.call(this))),(s=(i=(0,o.oM)(this.fullBounds().extent())).getContext("2d")).fillStyle=N.prototype.getRenderColor().toString(),s.fillRect(0,0,i.width,i.height),s.globalCompositeOperation="destination-in",s.drawImage(e,0,0),s.globalCompositeOperation="source-over",s.drawImage(t,0,0),i)},A.prototype.clearAlpha=function(){this.forAllChildren((t=>{t instanceof A&&delete t.alpha}))},A.prototype.render=function(t){this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),o.tU.isFlat?(t.fillStyle=this.cachedClrDark,t.beginPath(),this.outlinePath(t,0),t.closePath(),t.fill(),t.fillStyle=this.cachedClr,t.beginPath(),this.outlinePath(t,this.flatEdge),t.closePath(),t.fill()):(t.fillStyle=this.cachedClr,t.beginPath(),this.outlinePath(t,0),t.closePath(),t.fill(),this.drawEdges(t)),this.hasLocationPin()&&this.drawMethodIcon(t)},A.prototype.drawMethodIcon=function(t){var e=this.methodIconExtent(),i=e.x,s=e.y,r=i/2,n=this.edge+this.labelPadding,a=this.edge,h=this.color===y.prototype.blockColor[this.category];this.isPredicate&&(n=this.rounding),this instanceof R&&(a+=this.corner),t.fillStyle=h?this.cachedClrBright:this.cachedClrDark,t.beginPath(),t.arc(n+r,a+r,r,(0,o.uR)(-210),(0,o.uR)(30),!1),t.lineTo(n+r,a+s),t.closePath(),t.fill(),t.fillStyle=this.cachedClr,t.beginPath(),t.arc(n+r,a+r,.4*r,(0,o.uR)(0),(0,o.uR)(360),!1),t.closePath(),t.fill()},A.prototype.cSlots=function(){var t=[];return this.parts().forEach((e=>{e instanceof z?t.push(e):e instanceof Z&&e.parts().forEach((e=>{e instanceof z&&t.push(e)}))})),t},A.prototype.hasLocationPin=function(){return this.isCustomBlock&&!this.isGlobal||this.isLocalVarTemplate},A.prototype.addHighlight=function(t){var e,o=!this.isVisible;return o&&this.show(),I.prototype.alpha<1&&this.clearAlpha(),e=this.highlight(t?t.color:this.activeHighlight,this.activeBlur,this.activeBorder),this.addBack(e),this.fullChanged(),o&&this.hide(),e},A.prototype.addErrorHighlight=function(){var t,e=!this.isVisible;return e&&this.show(),this.removeHighlight(),t=this.highlight(this.errorHighlight,this.activeBlur,this.activeBorder),this.addBack(t),this.fullChanged(),e&&this.hide(),t},A.prototype.removeHighlight=function(){var t=this.getHighlight();return null!==t&&(this.fullChanged(),this.removeChild(t)),t},A.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()},A.prototype.highlight=function(t,e,i){var s=new J,r=this.fullBounds(),n=o.A3&&!o.tU.isFlat?e:i;return s.bounds.setExtent(r.extent().add(2*n)),s.holes=[s.bounds],s.color=t,s.cachedImage=o.A3&&!o.tU.isFlat?this.highlightImageBlurred(t,e):this.highlightImage(t,i),s.setPosition(r.origin.subtract(new o.E9(n,n))),s},A.prototype.highlightImage=function(t,e){var i,s,r,n,a;return i=this.fullBounds().extent(),this.doWithAlpha(1,(()=>s=this.fullImage())),(n=(r=(0,o.oM)(i.add(2*e))).getContext("2d")).drawImage(s,0,0),n.drawImage(s,e,0),n.drawImage(s,2*e,0),n.drawImage(s,2*e,e),n.drawImage(s,2*e,2*e),n.drawImage(s,e,2*e),n.drawImage(s,0,2*e),n.drawImage(s,0,e),n.globalCompositeOperation="destination-out",n.drawImage(s,e,e),(n=(a=(0,o.oM)(i.add(2*e))).getContext("2d")).drawImage(r,0,0),n.globalCompositeOperation="source-atop",n.fillStyle=t.toString(),n.fillRect(0,0,a.width,a.height),a},A.prototype.highlightImageBlurred=function(t,e){var i,s,r,n;return i=this.fullBounds().extent(),this.doWithAlpha(1,(()=>s=this.fullImage())),(n=(r=(0,o.oM)(i.add(2*e))).getContext("2d")).shadowBlur=e,n.shadowColor=t.toString(),n.drawImage(s,e,e),n.shadowBlur=0,n.globalCompositeOperation="destination-out",n.drawImage(s,e,e),r},A.prototype.getHighlight=function(){var t;return 0!==(t=this.children.slice(0).reverse().filter((t=>t instanceof J))).length?t[0]:null},A.prototype.outline=function(t,e){var i=new J,s=this.fullBounds(),r=e;return i.bounds.setExtent(s.extent().add(2*r)),i.color=t,i.cachedImage=this.highlightImage(t,e),i.setPosition(s.origin.subtract(new o.E9(r,r))),i},A.prototype.fixBlockColor=function(t,e){var o,i,s=t;if(this.zebraContrast||e){if(!this.zebraContrast&&e)return this.forceNormalColoring(!0);s||this.parent&&(this.isPrototype?s=null:this instanceof D?s=this.parent.parentThatIsA(A):(i=this.parentThatIsA(V,tt))&&(s=i.parentThatIsA(A))),s?s.category===this.category?s.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(y.prototype.blockColor[this.category])&&this.alternateBlockColor():(o=y.prototype.blockColor[this.category],this.color.eq(o)||this.alternateBlockColor()),e&&this.fixChildrensBlockColor(!0)}},A.prototype.forceNormalColoring=function(){var t=y.prototype.blockColor[this.category];this.setColor(t),this.setLabelColor(o.Cj,t.darker(this.labelContrast),o.tU.isFlat?o.xE:this.embossing),this.fixChildrensBlockColor(!0)},A.prototype.alternateBlockColor=function(){var t=y.prototype.blockColor[this.category];this.color.eq(t)?this.setColor(this.zebraContrast<0?t.darker(Math.abs(this.zebraContrast)):t.lighter(this.zebraContrast),this.hasLabels()):this.setColor(t,this.hasLabels()),this.fixLabelColor(),this.fixChildrensBlockColor(!0)},A.prototype.ghost=function(){this.setColor(y.prototype.blockColor[this.category].lighter(35))},A.prototype.fixLabelColor=function(){if(this.zebraContrast>0&&this.category){var t=y.prototype.blockColor[this.category];this.color.eq(t)?this.setLabelColor(o.Cj,t.darker(this.labelContrast),o.tU.isFlat?null:this.embossing):this.setLabelColor(o.E5,t.lighter(this.zebraContrast).lighter(2*this.labelContrast),o.tU.isFlat?null:this.embossing.neg())}},A.prototype.fixChildrensBlockColor=function(t){this.children.forEach((e=>{e instanceof R?e.fixBlockColor(null,t):e instanceof I&&(e.fixBlockColor(this,t),e instanceof q&&e.fixLayout())}))},A.prototype.setCategory=function(t){this.category=t,this.fixBlockColor()},A.prototype.hasLabels=function(){return this.children.some((t=>t instanceof o.XC))},A.prototype.copy=function(){var t=A.uber.copy.call(this);return A.copyIDs||(t.id=A.nextId++),t},A.prototype.fullCopy=function(){var t=A.uber.fullCopy.call(this);return t.removeHighlight(),t.isDraggable=!0,this.instantiationSpec&&t.setSpec(this.instantiationSpec),t.allChildren().filter((t=>(t instanceof I&&(t.cachedInputs=null,t.isCustomBlock&&t.initializeVariables()),!(0,o.kK)(t.comment)))).forEach((t=>{var e=t.comment.fullCopy();t.comment=e,e.block=t})),t.cachedInputs=null,t},A.prototype.reactToTemplateCopy=function(){this.isLocalVarTemplate&&(this.isLocalVarTemplate=null,this.fixLayout()),this.forceNormalColoring()},A.prototype.hasBlockVars=function(){return this.anyChild((t=>t.isCustomBlock&&t.isGlobal&&t.definition.variableNames.length))},A.prototype.pickUp=function(t){var e=t||this.world();this.setPosition(e.hand.position().subtract(this.rounding)),e.hand.grab(this)},A.prototype.focus=function(){var t,e=this.parentThatIsA(N),o=this.world();e&&N.prototype.enableKeyboard&&(e.focus&&e.focus.stopEditing(),o.stopEditing(),t=new it(e,this),e.focus=t,t.getFocus(o),this instanceof F&&t.nextCommand())},A.prototype.mouseEnterBounds=function(t){!t&&this.alpha<1&&(this.alpha=Math.min(this.alpha+.2,1),this.rerender())},A.prototype.mouseLeaveBounds=function(t){I.prototype.alpha<1&&(delete this.alpha,this.rerender())},A.prototype.rootForGrab=function(){return this},A.prototype.wantsDropOf=function(t){return(t instanceof j||t instanceof o.XC||t instanceof o.$1)&&!this.isTemplate},A.prototype.reactToDropOf=function(t){t.isDraggable=!1,t.fixLayout(),this.fixLayout(),this.buildSpec()},A.prototype.situation=function(){if(!(this.parent instanceof G)){var t=this.parentThatIsA(N);if(t)return{origin:t,position:this.position().subtract(t.position())}}return A.uber.situation.call(this)};A.prototype.prepareToBeGrabbed=function(t){var e=t?t.world:this.world();this.allInputs().forEach((t=>delete t.bindingID)),this.allComments().forEach((t=>t.startFollowing(this,e)))},A.prototype.justDropped=function(){delete this.alpha,this.allComments().forEach((t=>t.stopFollowing()))},A.prototype.allComments=function(){return this.allChildren().filter((t=>!(0,o.kK)(t.comment))).map((t=>t.comment))},A.prototype.destroy=function(t){t?(0,o.kK)(this.comment)||this.comment.destroy():this.allComments().forEach((t=>t.destroy())),A.uber.destroy.call(this)},A.prototype.stackHeight=function(){var t=this.fullBounds(),e=Math.max(this.allComments().map((t=>t.bottom())))||this.bottom();return Math.max(t.bottom(),e)-t.top()},A.prototype.stackFullBounds=function(){var t=this.fullBounds();return this.allComments().forEach((e=>t.mergeWith(e.bounds))),t},A.prototype.stackWidth=function(){var t=this.fullBounds(),e=Math.max(this.allComments().map((t=>t.right())))||this.right();return Math.max(t.right(),e)-t.left()},A.prototype.snap=function(){var t,e,o,i=this.topBlock();i.allComments().forEach((t=>t.align(i))),this.getHighlight()&&this!==i&&this.removeHighlight(),i.getHighlight()&&i.addHighlight(i.removeHighlight()),"receiveCondition"===this.selector&&(t=i.scriptTarget())&&(e=t.parentThatIsA(b))&&(e.enableCustomHatBlocks=!0,e.threads.pauseCustomHatBlocks=!1,(o=e.parentThatIsA(Kt))&&o.controlBar.stopButton.refresh())},R.prototype=new A,R.prototype.constructor=R,R.uber=A.prototype,R.prototype.init=function(){R.uber.init.call(this),this.bounds.setExtent(new o.E9(60,24).multiplyBy(this.scale)),this.fixLayout(),this.rerender(),this.partOfCustomCommand=!1,this.exitTag=null},R.prototype.blockSequence=function(){var t=this.nextBlock(),e=[this];return t&&(e=e.concat(t.blockSequence())),e},R.prototype.bottomBlock=function(){return this.nextBlock()?this.nextBlock().bottomBlock():this},R.prototype.nextBlock=function(t){if(!t)return(0,o.qY)(this.children,(t=>t instanceof R&&!t.isPrototype));var e=this.nextBlock(),i=this.parentThatIsA(V,tt);this.add(t),e&&t.bottomBlock().nextBlock(e),t.setPosition(new o.E9(this.left(),this.bottom()-this.corner)),i&&i.fixLayout()},R.prototype.topAttachPoint=function(){return new o.E9(this.dentCenter(),this.top())},R.prototype.bottomAttachPoint=function(){return new o.E9(this.dentCenter(),this.bottom())},R.prototype.wrapAttachPoint=function(){var t=(0,o.qY)(this.inputs(),(t=>t instanceof z));return t&&!t.nestedBlock()?new o.E9(t.left()+2*t.inset+t.corner,t.top()+2*t.corner):null},R.prototype.dentLeft=function(){return this.left()+this.corner+this.inset},R.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent},R.prototype.attachTargets=function(){var t,e=[];return this instanceof F||(t=this.topAttachPoint(),this.parent instanceof I||e.push({point:t,element:this,loc:"top",type:"block"}),!N.prototype.enableNestedAutoWrapping&&this.parentThatIsA(V)||e.push({point:t,element:this,loc:"wrap",type:"block"})),this.isStop()||e.push({point:this.bottomAttachPoint(),element:this,loc:"bottom",type:"block"}),e},R.prototype.allAttachTargets=function(t){var e=t||this.parent,o=[];return this instanceof F&&t.rejectsHats||e.children.filter((t=>t!==this&&t instanceof I&&!t.isTemplate)).forEach((t=>t.forAllChildren((t=>{t.attachTargets&&t.attachTargets().forEach((t=>o.push(t)))})))),o},R.prototype.closestAttachTarget=function(t){var e,o,i=t||this.parent,s=this.bottomBlock(),r=null,n=Math.max(2*this.corner+this.dent,this.minSnapDistance),a=[],h=1e3;return this instanceof F||(a.push({point:this.topAttachPoint(),loc:"top"}),(o=this.wrapAttachPoint())&&a.push({point:o,loc:"wrap"})),s.isStop()||a.push({point:s.bottomAttachPoint(),loc:"bottom"}),this.allAttachTargets(i).forEach((t=>a.forEach((o=>{("wrap"===o.loc&&"wrap"===t.loc||o.loc!==t.loc&&"wrap"!==o.loc&&"wrap"!==t.loc)&&(e=o.point.distanceTo(t.point))<n&&e<h&&(h=e,r=t)})))),r},R.prototype.snap=function(t){var e,i,s,r,n,a=this.closestAttachTarget(),h=this.parentThatIsA(N);if(h.clearDropInfo(),h.lastDroppedBlock=this,null===a)return this.fixBlockColor(),R.uber.snap.call(this),void(t&&h.recordDrop(t.grabOrigin));h.lastDropTarget=a,"bottom"===a.loc?("slot"===a.type?(this.removeHighlight(),h.lastNextBlock=a.element.nestedBlock(),a.element.nestedBlock(this)):(h.lastNextBlock=a.element.nextBlock(),a.element.nextBlock(this)),this.isStop()&&(i=this.nextBlock())&&(h.add(i),i.moveBy(this.extent().floorDivideBy(2)),(n=this.parentThatIsA(V,tt))&&n.fixLayout())):"top"===a.loc?(a.element.removeHighlight(),s=this.bottomBlock().bottom()-this.bottom(),this.setBottom(a.element.top()+this.corner-s),this.setLeft(a.element.left()),this.bottomBlock().nextBlock(a.element)):"wrap"===a.loc&&(r=(0,o.qY)(this.inputs(),(t=>t instanceof z)),e=a.element.parent,h.lastWrapParent=e,this.moveBy(a.point.subtract(r.slotAttachPoint())),r.nestedBlock(a.element),e instanceof R?e.nextBlock(this):e instanceof V?e.nestedBlock(this):e instanceof et&&(e.add(this),e.fixLayout()),a.element.blockSequence().forEach((t=>t.fixBlockColor()))),this.fixBlockColor(),R.uber.snap.call(this),t&&h.recordDrop(t.grabOrigin),this.snapSound&&this.snapSound.play()},R.prototype.prepareToBeGrabbed=function(t){if(t&&16===t.world.currentKey&&this.nextBlock())return this.extract(),void(t.grabOrigin.action="extract");var e=this.position();this.parent instanceof et&&(this.parent.revertToDefaultInput(this),this.setPosition(e)),R.uber.prepareToBeGrabbed.call(this,t)},R.prototype.isStop=function(){var t;return"doStopThis"===this.selector?(t=this.inputs()[0].evaluate())instanceof Array&&t[0].length<12:["doForever","doReport","removeClone"].indexOf(this.selector)>-1},R.prototype.userDestroy=function(){R.uber.userDestroy.call(this);var t=this.selectForEdit();if(t!==this)return this.userDestroy.call(t);if(this.nextBlock())this.userDestroyJustThis();else{var e=this.parentThatIsA(N),o=this.parentThatIsA(Kt),i=this.parentThatIsA(I),s=this.parentThatIsA(z);e&&(e.clearDropInfo(),e.lastDroppedBlock=this,e.recordDrop(this.situation()),e.dropRecord.action="delete"),this.prepareToBeGrabbed(),o?o.removeBlock(this):this.destroy(),s&&s.fixLayout(),i&&i.reactToGrabOf(this)}},R.prototype.userDestroyJustThis=function(){var t=this.parentThatIsA(N),e=this.nextBlock();t&&(t.clearDropInfo(),t.lastDroppedBlock=this,t.recordDrop(this.situation()),t.dropRecord.lastNextBlock=e,t.dropRecord.action="delete"),this.extract()},R.prototype.userExtractJustThis=function(){var t=this.situation();t.action="extract",this.extract(),this.pickUp(t.origin.world()),this.parent.grabOrigin=t},R.prototype.extract=function(){var t,e,o=this.parentThatIsA(N),i=this.parentThatIsA(Kt),s=this.parentThatIsA(V,et),r=this.nextBlock(),n=this.parentThatIsA(I),a=this.parentThatIsA(z,et);this.topBlock().fullChanged(),this.parent&&(t=this.parent.parentThatIsA(R)),t&&t.nextBlock()===this?e=t:s&&s.nestedBlock()===this&&(e=s,this.prepareToBeGrabbed()),i?i.removeBlock(this,!0):this.destroy(!0),r?e instanceof V||e instanceof et?e.nestedBlock(r):e instanceof R?e.nextBlock(r):o.add(r):a&&a.fixLayout(),n&&n.reactToGrabOf(this)},R.prototype.outlinePath=function(t,e){var i=2*this.corner+this.inset,s=this.height()-this.corner,r=this.height()-2*this.corner,n=Math.max(this.corner-e,0),a=this.position();t.arc(this.corner,this.corner,n,(0,o.uR)(-180),(0,o.uR)(-90),!1),t.lineTo(this.corner+this.inset,e),t.lineTo(i,this.corner+e),t.lineTo(i+this.dent,this.corner+e),t.lineTo(3*this.corner+this.inset+this.dent,e),t.lineTo(this.width()-this.corner,e),t.arc(this.width()-this.corner,this.corner,n,(0,o.uR)(-90),(0,o.uR)(-0),!1),this.cSlots().forEach((o=>{o.outlinePath(t,e,o.position().subtract(a))})),t.arc(this.width()-this.corner,r,n,(0,o.uR)(0),(0,o.uR)(90),!1),this.isStop()||(t.lineTo(this.width()-this.corner,s-e),t.lineTo(3*this.corner+this.inset+this.dent,s-e),t.lineTo(i+this.dent,s+this.corner-e),t.lineTo(i,s+this.corner-e),t.lineTo(this.corner+this.inset,s-e)),t.arc(this.corner,r,n,(0,o.uR)(90),(0,o.uR)(180),!1)},R.prototype.drawEdges=function(t){this.drawTopDentEdge(t,0,0),this.drawBottomDentEdge(t,0,this.height()-this.corner),this.drawLeftEdge(t),this.drawRightEdge(t),this.drawTopLeftEdge(t),this.drawBottomRightEdge(t)},R.prototype.drawTopDentEdge=function(t,e,o){var i,s,r,n,a=.5*this.edge,h=e+2*this.corner+this.inset;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(i=t.createLinearGradient(0,o,0,o+this.edge)).addColorStop(0,this.cachedClrBright),i.addColorStop(1,this.cachedClr),t.strokeStyle=i,t.beginPath(),t.moveTo(this.corner,o+a),t.lineTo(e+this.corner+this.inset,o+a),t.stroke(),t.strokeStyle=i,t.beginPath(),t.moveTo(e+3*this.corner+this.inset+this.dent+a,o+a),t.lineTo(this.width()-this.corner,o+a),t.stroke(),n=e+this.corner+this.inset,(r=t.createLinearGradient(n-this.edge,o+this.edge,n,o)).addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrBright),t.strokeStyle=r,t.beginPath(),t.moveTo(e+this.corner+this.inset,o+a),t.lineTo(h,o+this.corner+a),t.stroke(),(s=t.createLinearGradient(0,o+this.corner,0,o+this.corner+this.edge)).addColorStop(0,this.cachedClrBright),s.addColorStop(1,this.cachedClr),t.strokeStyle=s,t.beginPath(),t.moveTo(h,o+this.corner+a),t.lineTo(h+this.dent,o+this.corner+a),t.stroke()},R.prototype.drawBottomDentEdge=function(t,e,o){var i,s,r,n=.5*this.edge,a=e+2*this.corner+this.inset;if(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(i=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(this.corner,o-n),this.isStop()?t.lineTo(this.width()-this.corner,o-n):t.lineTo(e+this.corner+this.inset-n,o-n),t.stroke(),this.isStop())return null;(s=t.createLinearGradient(0,o+this.corner-this.edge,0,o+this.corner)).addColorStop(0,this.cachedClr),s.addColorStop(1,this.cachedClrDark),t.strokeStyle=s,t.beginPath(),t.moveTo(a+n,o+this.corner-n),t.lineTo(a+this.dent,o+this.corner-n),t.stroke(),(r=t.createLinearGradient(e+a+this.dent-this.edge,o+this.corner-this.edge,e+a+this.dent,o+this.corner)).addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(e+a+this.dent,o+this.corner-n),t.lineTo(e+3*this.corner+this.inset+this.dent,o-n),t.stroke(),t.strokeStyle=i,t.beginPath(),t.moveTo(e+3*this.corner+this.inset+this.dent,o-n),t.lineTo(this.width()-this.corner,o-n),t.stroke()},R.prototype.drawFlatBottomDentEdge=function(t){this.isStop()||(t.fillStyle=this.color.darker(this.contrast/2).toString(),t.beginPath(),this.drawDent(t,0,this.height()-this.corner),t.closePath(),t.fill())},R.prototype.drawLeftEdge=function(t){var e=.5*this.edge,o=t.createLinearGradient(0,0,this.edge,0);o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.moveTo(e,this.corner),t.lineTo(e,this.height()-2*this.corner-e),t.stroke()},R.prototype.drawRightEdge=function(t){var e,o,i=.5*this.edge,s=this.cSlots(),r=this.top(),n=this.width();(o=t.createLinearGradient(n-this.edge,0,n,0)).addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,s.length?(t.beginPath(),t.moveTo(n-i,this.corner+i),s.forEach((o=>{e=o.top()-r,t.lineTo(n-i,e),t.stroke(),t.beginPath(),t.moveTo(n-i,e+o.height())}))):(t.beginPath(),t.moveTo(n-i,this.corner+i)),t.lineTo(n-i,this.height()-2*this.corner),t.stroke()},R.prototype.drawTopLeftEdge=function(t){var e,i=.5*this.edge;(e=t.createRadialGradient(this.corner,this.corner,this.corner,this.corner,this.corner,this.corner-this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(this.corner,this.corner,this.corner-i,(0,o.uR)(-180),(0,o.uR)(-90),!1),t.stroke()},R.prototype.drawBottomRightEdge=function(t){var e,i=.5*this.edge,s=this.width()-this.corner,r=this.height()-2*this.corner;(e=t.createRadialGradient(s,r,this.corner,s,r,this.corner-this.edge)).addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(s,r,this.corner-i,(0,o.uR)(90),(0,o.uR)(0),!0),t.stroke()},F.prototype=new R,F.prototype.constructor=F,F.uber=R.prototype,F.prototype.init=function(){F.uber.init.call(this),this.bounds.setExtent(new o.E9(120,36).multiplyBy(this.scale)),this.fixLayout(),this.rerender()},F.prototype.blockSequence=function(){var t=F.uber.blockSequence.call(this);return t.shift(),t},F.prototype.outlinePath=function(t,e){var i=2*this.corner+this.inset,s=this.height()-this.corner,r=this.height()-2*this.corner,n=Math.max(this.corner-e,0),a=this.hatWidth,h=this.hatHeight,l=(4*h*h+a*a)/(8*h),p=(0,o.RW)(4*Math.atan(2*h/a))/2,c=Math.min(1.7*a,this.width()-this.corner);t.moveTo(e,h+this.corner),t.arc(a/2,l,l,(0,o.uR)(-p-90),(0,o.uR)(-90),!1),t.bezierCurveTo(a,0,a,h,c,h),t.arc(this.width()-this.corner,h+this.corner,n,(0,o.uR)(-90),(0,o.uR)(-0),!1),t.arc(this.width()-this.corner,r,n,(0,o.uR)(0),(0,o.uR)(90),!1),this.isStop()||(t.lineTo(this.width()-this.corner,s-e),t.lineTo(3*this.corner+this.inset+this.dent,s-e),t.lineTo(i+this.dent,s+this.corner-e),t.lineTo(i,s+this.corner-e),t.lineTo(this.corner+this.inset,s-e)),t.arc(this.corner,r,n,(0,o.uR)(90),(0,o.uR)(180),!1)},F.prototype.drawLeftEdge=function(t){var e=.5*this.edge,o=t.createLinearGradient(0,0,this.edge,0);o.addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.moveTo(e,this.hatHeight+e),t.lineTo(e,this.height()-2*this.corner-e),t.stroke()},F.prototype.drawRightEdge=function(t){var e,o=.5*this.edge,i=this.width();(e=t.createLinearGradient(i-this.edge,0,i,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(i-o,this.corner+this.hatHeight+o),t.lineTo(i-o,this.height()-2*this.corner),t.stroke()},F.prototype.drawTopDentEdge=o.WY,F.prototype.drawTopLeftEdge=function(t){var e,i=.5*this.edge,s=this.hatWidth,r=this.hatHeight,n=(4*r*r+s*s)/(8*r),a=(0,o.RW)(4*Math.atan(2*r/s))/2,h=Math.min(1.7*s,this.width()-this.corner);(e=t.createRadialGradient(s/2,n,n-this.edge,s/2,n,n)).addColorStop(1,this.cachedClrBright),e.addColorStop(0,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(Math.round(s/2),n,n-i,(0,o.uR)(-a-90),(0,o.uR)(-90),!1),t.moveTo(s/2,i),t.bezierCurveTo(s,i,s,r+i,h,r+i),t.lineTo(this.width()-this.corner,r+i),t.stroke()},D.prototype=new A,D.prototype.constructor=D,D.uber=A.prototype,D.prototype.init=function(t){D.uber.init.call(this),this.isPredicate=t||!1,this.bounds.setExtent(new o.E9(50,22).multiplyBy(this.scale)),this.fixLayout(),this.rerender(),this.cachedSlotSpec=null,this.isLocalVarTemplate=null},D.prototype.snap=function(t){var e,o,i=this.parent;if(this.cachedSlotSpec=null,!(i instanceof N))return null;i.clearDropInfo(),i.lastDroppedBlock=this,null!==(o=i.closestInput(this,t))&&(i.lastReplacedInput=o,i.lastDropTarget=o.parent,o instanceof Z?(i.lastPreservedBlocks=o.inputs(),i.lastReplacedInput=o.fullCopy()):o instanceof V&&(i.lastReplacedInput=o,(e=o.nestedBlock())&&(e=e.fullCopy(),i.add(e),e.moveBy(e.extent()),e.fixBlockColor(),i.lastPreservedBlocks=[e])),o.parent.replaceInput(o,this),this.snapSound&&this.snapSound.play()),this.fixBlockColor(),D.uber.snap.call(this),t&&i.recordDrop(t.grabOrigin)},D.prototype.prepareToBeGrabbed=function(t){var e=this.position();(this.parent instanceof A||this.parent instanceof Z||this.parent instanceof tt)&&(this.parent.revertToDefaultInput(this),this.setPosition(e)),D.uber.prepareToBeGrabbed.call(this,t),t.alpha=this.alpha<1?1:.85,this.cachedSlotSpec=null},D.prototype.blockSequence=function(){return this},D.prototype.isUnevaluated=function(){var t=this.getSlotSpec();return"%anyUE"===t||"%boolUE"===t||"%f"===t},D.prototype.isLocked=function(){return this.isStatic||"%t"===this.getSlotSpec()},D.prototype.getSlotSpec=function(){return this.cachedSlotSpec||(this.cachedSlotSpec=this.determineSlotSpec()),this.cachedSlotSpec},D.prototype.determineSlotSpec=function(){var t;return this.parent instanceof A&&-1!==(t=this.parent.parts().filter((t=>!this.isNonPartMorph(t))).indexOf(this))&&this.parent.blockSpec?this.parseSpec(this.parent.blockSpec)[t]:this.parent instanceof Z?this.parent.slotSpec:this.parent instanceof G?this.parent.getSpec():null},D.prototype.userDestroy=function(){D.uber.userDestroy.call(this);var t=this.selectForEdit();if(t!==this)return this.userDestroy.call(t);var e=this.parentThatIsA(N);e&&(e.clearDropInfo(),e.lastDroppedBlock=this,e.recordDrop(this.situation()),e.dropRecord.action="delete"),this.topBlock().fullChanged(),this.prepareToBeGrabbed(this.world().hand),this.destroy()},D.prototype.outlinePath=function(t,e){this.isPredicate?this.outlinePathDiamond(t,e):this.outlinePathOval(t,e)},D.prototype.outlinePathOval=function(t,e){var i=this.height(),s=Math.min(this.rounding,i/2),r=Math.max(s-e,0),n=this.width(),a=this.position();t.arc(s,s,r,(0,o.uR)(-180),(0,o.uR)(-90),!1),t.arc(n-s,s,r,(0,o.uR)(-90),(0,o.uR)(-0),!1),this.cSlots().forEach((o=>{o.outlinePath(t,e,o.position().subtract(a))})),t.arc(n-s,i-s,r,(0,o.uR)(0),(0,o.uR)(90),!1),t.arc(s,i-s,r,(0,o.uR)(90),(0,o.uR)(180),!1),t.lineTo(s-r,s)},D.prototype.outlinePathDiamond=function(t,e){var o=this.width(),i=this.height(),s=Math.floor(i/2),r=this.rounding,n=o-r,a=this.position(),h=this.cSlots();t.moveTo(e,s),t.lineTo(r,e),t.lineTo(n-e,e),h.length?this.cSlots().forEach((o=>{o.outlinePath(t,e,o.position().subtract(a))})):t.lineTo(o-e,s),t.lineTo(n-e,i-e),t.lineTo(r,i-e)},D.prototype.drawEdges=function(t){this.isPredicate?this.drawEdgesDiamond(t):this.drawEdgesOval(t)},D.prototype.drawEdgesOval=function(t){var e,i,s=this.height(),r=Math.max(Math.min(this.rounding,s/2),this.edge),n=this.width(),a=this.edge/2,h=this.top(),l=this.cSlots();t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(i=t.createRadialGradient(r,s-r,r-this.edge,r,s-r,r+this.edge)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrBright),t.strokeStyle=i,t.beginPath(),t.arc(r,s-r,r-a,(0,o.uR)(90),(0,o.uR)(180),!1),t.stroke(),(i=t.createRadialGradient(n-r,r,r-this.edge,n-r,r,r+this.edge)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.arc(n-r,r,r-a,(0,o.uR)(-90),(0,o.uR)(0),!1),t.stroke(),(i=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClrBright),i.addColorStop(1,this.cachedClr),t.strokeStyle=i,t.beginPath(),t.moveTo(r-a,a),t.lineTo(n-r+a,a),t.stroke(),(i=t.createRadialGradient(r,r,r-this.edge,r,r,r)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrBright),t.strokeStyle=i,t.beginPath(),t.arc(r,r,r-a,(0,o.uR)(180),(0,o.uR)(270),!1),t.stroke(),(i=t.createRadialGradient(n-r,s-r,r-this.edge,n-r,s-r,r)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.arc(n-r,s-r,r-a,(0,o.uR)(0),(0,o.uR)(90),!1),t.stroke(),(i=t.createLinearGradient(0,s-this.edge,0,s)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(r-a,s-a),t.lineTo(n-r+a,s-a),t.stroke(),(i=t.createLinearGradient(0,0,this.edge,0)).addColorStop(0,this.cachedClrBright),i.addColorStop(1,this.cachedClr),t.strokeStyle=i,t.beginPath(),t.moveTo(a,r),t.lineTo(a,s-r),t.stroke(),(i=t.createLinearGradient(n-this.edge,0,n,0)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,l.length?(t.beginPath(),t.moveTo(n-a,r+a),l.forEach((o=>{e=o.top()-h,t.lineTo(n-a,e),t.stroke(),t.beginPath(),t.moveTo(n-a,e+o.height())}))):(t.beginPath(),t.moveTo(n-a,r+a)),t.lineTo(n-a,s-r),t.stroke()},D.prototype.drawEdgesDiamond=function(t){var e,o,i=this.width(),s=this.height(),r=Math.floor(s/2),n=this.rounding,a=this.edge/2,h=this.cSlots(),l=this.top();t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(o=t.createLinearGradient(-n,0,n,0)).addColorStop(1,this.cachedClr),o.addColorStop(0,this.cachedClrBright),t.strokeStyle=o,t.beginPath(),t.moveTo(a,r),t.lineTo(n,s-a),t.closePath(),t.stroke(),(o=t.createLinearGradient(0,0,n,0)).addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(a,r),t.lineTo(n,a),t.closePath(),t.stroke(),(o=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClrBright),o.addColorStop(1,this.cachedClr),t.strokeStyle=o,t.beginPath(),t.moveTo(n,a),h.length?(t.lineTo(i-n-a,a),t.closePath(),t.stroke(),(o=t.createLinearGradient(i-n-this.edge,0,i-n,0)).addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=o,t.beginPath(),t.moveTo(i-n-a,this.edge+a),h.forEach((o=>{e=o.top()-l,t.lineTo(i-n-a,e),t.stroke(),t.beginPath(),t.moveTo(i-n-a,e+o.height())})),t.lineTo(i-n-a,s-a),t.stroke()):(t.lineTo(i-n,a),t.closePath(),t.stroke(),(o=t.createLinearGradient(i-n,0,i+n,0)).addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.strokeStyle=o,t.beginPath(),t.moveTo(i-a,r),t.lineTo(i-n,a),t.closePath(),t.stroke(),(o=t.createLinearGradient(i-n,0,i,0)).addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.strokeStyle=o,t.beginPath(),t.moveTo(i-n,s-a),t.lineTo(i-a,r),t.closePath(),t.stroke()),(o=t.createLinearGradient(0,s-this.edge,0,s)).addColorStop(0,this.cachedClr),o.addColorStop(1,this.cachedClrDark),t.strokeStyle=o,t.beginPath(),t.moveTo(n+a,s-a),t.lineTo(i-n-a,s-a),t.closePath(),t.stroke()},O.prototype=new D,O.prototype.constructor=O,O.uber=D.prototype,O.prototype.isCachingInputs=!1,O.prototype.init=function(){O.uber.init.call(this),this.category="other",this.contrast=O.prototype.contrast,this.setExtent(new o.E9(200,80))},O.prototype.render=function(t){var e=this.inputs()[0],i=this.position();this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),o.tU.isFlat?(t.fillStyle=this.cachedClrDark,t.beginPath(),this.outlinePath(t,0),e.outlinePath(t,e.position().subtract(i)),t.clip("evenodd"),t.fillRect(0,0,this.width(),this.height()),t.fillStyle=this.cachedClr,t.beginPath(),this.outlinePath(t,this.flatEdge),e.outlinePath(t,e.position().subtract(i)),t.clip("evenodd"),t.fillRect(0,0,this.width(),this.height())):(t.fillStyle=this.cachedClr,t.beginPath(),this.outlinePath(t,0),e.outlinePath(t,e.position().subtract(i)),t.clip("evenodd"),t.fillRect(0,0,this.width(),this.height()),this.drawEdges(t))},O.prototype.rootForGrab=function(){return this.isDraggable?this:A.uber.rootForGrab.call(this)},O.prototype.embed=function(t,e,o){var i;this.color=y.prototype.blockColor.other,this.isDraggable=!0,t instanceof R?(this.isStatic=!1,this.setSpec("%rc %ringparms"),this.selector="reifyScript",(i=this.parts()[0]).nestedBlock(t)):t.isPredicate?(this.isStatic=!0,this.setSpec("%rp %ringparms"),this.selector="reifyPredicate",(i=this.parts()[0]).replaceInput(i.contents(),t)):t instanceof q?(this.isStatic=!1,this.setSpec("%rp %ringparms"),this.selector="reifyPredicate",(i=this.parts()[0]).replaceInput(i.contents(),t)):(this.isStatic=!1,this.setSpec("%rr %ringparms"),this.selector="reifyReporter",(i=this.parts()[0]).replaceInput(i.contents(),t,o)),i=this.parts()[1],e&&e.forEach((t=>i.addInput(t))),this.fixBlockColor(null,!0)},O.prototype.vanishForSimilar=function(){var t=this.parts()[0].nestedBlock();return t&&this.parent instanceof I?this.parent instanceof et||this.parent instanceof W?null:void(("reportGetVar"===t.selector&&!(0,o.r3)(this.inputNames(),t.blockSpec)||"reportJSFunction"===t.selector||"reportAttributeOf"===t.selector||"reportCompiled"===t.selector||t instanceof O)&&this.parent.replaceInput(this,t)):null},O.prototype.contents=function(){return this.parts()[0].nestedBlock()},O.prototype.inputNames=function(){return this.parts()[1].evaluate()},O.prototype.dataType=function(){switch(this.selector){case"reifyScript":return"command";case"reifyPredicate":return"predicate";default:return"reporter"}},O.prototype.fixBlockColor=function(t,e){var o=this.parts()[0];O.uber.fixBlockColor.call(this,t,e),o.fixLayout()},N.prototype=new o.xZ,N.prototype.constructor=N,N.uber=o.xZ.prototype,N.prototype.cleanUpMargin=20,N.prototype.cleanUpSpacing=15,N.prototype.isPreferringEmptySlots=!0,N.prototype.enableKeyboard=!0,N.prototype.enableNestedAutoWrapping=!0,N.prototype.feedbackColor=o.Cj,N.prototype.init=function(){this.feedbackMorph=new o.RC,this.rejectsHats=!1,this.lastDroppedBlock=null,this.lastReplacedInput=null,this.lastDropTarget=null,this.lastPreservedBlocks=null,this.lastNextBlock=null,this.lastWrapParent=null,this.focus=null,N.uber.init.call(this),this.setColor(new o.Il(70,70,70)),this.isAnimating=!1,this.dropRecord=null,this.recordDrop()},N.prototype.fullCopy=function(){var t,e=new N,o=this.position();return this.focus&&this.focus.stopEditing(),this.children.forEach((i=>{i.block||(t=i.fullCopy(),e.add(t),t.setPosition(i.position().subtract(o)),t instanceof A&&t.allComments().forEach((e=>e.align(t))))})),e.adjustBounds(),e},N.prototype.render=function(t){t.fillStyle=this.getRenderColor().toString(),t.fillRect(0,0,this.width(),this.height()),this.cachedTexture?this.renderCachedTexture(t):this.texture&&this.renderTexture(this.texture,t)},N.prototype.getRenderColor=function(){return o.tU.isFlat||I.prototype.alpha>.85?this.color:this.color.mixed(Math.max(I.prototype.alpha-.15,0),y.prototype.paletteColor)},N.prototype.renderCachedTexture=function(t){I.prototype.alpha>.8&&N.uber.renderCachedTexture.call(this,t)},N.prototype.step=function(){var t,e=this.world(),i=e.hand;return this.feedbackMorph.parent&&(this.feedbackMorph.destroy(),this.feedbackMorph.parent=null),this.focus&&(!e.keyboardFocus||e.keyboardFocus instanceof b)&&this.focus.getFocus(e),0===i.children.length?null:this.bounds.containsPoint(i.bounds.origin)&&((t=i.children[0])instanceof A||t instanceof ot)&&(0,o.r3)(i.morphAtPointer().allParents(),this)?void(t instanceof ot?this.showCommentDropFeedback(t,i):t instanceof D?this.showReporterDropFeedback(t,i):this.showCommandDropFeedback(t)):null},N.prototype.showReporterDropFeedback=function(t,e){var o=this.closestInput(t,e);this.showReporterDropFeedbackFromTarget(t,o)},N.prototype.showReporterDropFeedbackFromTarget=function(t,e){if(null===e)return null;this.feedbackMorph.bounds=e.fullBounds().expandBy(Math.max(2*t.edge,t.reporterDropFeedbackPadding)),this.feedbackMorph.edge=I.prototype.rounding,this.feedbackMorph.border=Math.max(I.prototype.edge,3),this.add(this.feedbackMorph),e instanceof Z?(this.feedbackMorph.color=y.prototype.blockColor.lists.copy(),this.feedbackMorph.borderColor=y.prototype.blockColor.lists):(this.feedbackMorph.color=this.feedbackColor.copy(),this.feedbackMorph.borderColor=this.feedbackColor),this.feedbackMorph.color.a=.5,this.feedbackMorph.rerender()},N.prototype.showCommandDropFeedback=function(t){var e,i;if(!(i=t.closestAttachTarget(this)))return null;"wrap"!==i.loc?(this.add(this.feedbackMorph),this.feedbackMorph.border=0,this.feedbackMorph.edge=0,this.feedbackMorph.alpha=1,this.feedbackMorph.bounds.setWidth(i.element.width()),this.feedbackMorph.bounds.setHeight(Math.max(I.prototype.corner,I.prototype.feedbackMinHeight)),this.feedbackMorph.color=this.feedbackColor,e=i.point.y,"bottom"===i.loc&&("block"===i.type?i.element.nextBlock()&&(e-=I.prototype.corner):"slot"===i.type&&i.element.nestedBlock()&&(e-=I.prototype.corner)),this.feedbackMorph.setPosition(new o.E9(i.element.left(),e))):this.showCSlotWrapFeedback(t,i.element)},N.prototype.showCommentDropFeedback=function(t,e){var o=this.closestBlock(t,e);if(!o)return null;this.feedbackMorph.bounds=o.bounds.expandBy(Math.max(2*A.prototype.edge,A.prototype.reporterDropFeedbackPadding)),this.feedbackMorph.edge=I.prototype.rounding,this.feedbackMorph.border=Math.max(I.prototype.edge,3),this.add(this.feedbackMorph),this.feedbackMorph.color=t.color.copy(),this.feedbackMorph.color.a=.25,this.feedbackMorph.borderColor=t.titleBar.color,this.feedbackMorph.rerender()},N.prototype.showCSlotWrapFeedback=function(t,e){var o;this.feedbackMorph.bounds=e.fullBounds().expandBy(A.prototype.corner),this.feedbackMorph.edge=I.prototype.corner,this.feedbackMorph.border=Math.max(I.prototype.edge,3),this.add(this.feedbackMorph),o=t.color.lighter(40),this.feedbackMorph.color=o.copy(),this.feedbackMorph.color.a=.1,this.feedbackMorph.borderColor=o,this.feedbackMorph.rerender()},N.prototype.closestBlock=function(t,e){var i,s,r,n=t.bounds,a=this.children.filter((t=>t instanceof A&&t.fullBounds().intersects(n)));return r=[],a.forEach((t=>{r=r.concat(t.allChildren().slice(0).reverse().filter((t=>t instanceof A&&!t.isTemplate)))})),0===r.length?null:e&&(i=e.position(),s=(0,o.qY)(r,(t=>!t.comment&&!t.isPrototype&&t.bounds.containsPoint(i))))?s:(0,o.qY)(r,(t=>!t.comment&&!t.isPrototype&&t.bounds.intersects(n)))},N.prototype.userMenu=function(){var t,e,i,r,n,a=new o.wR(this),h=this.parentThatIsA(Kt),l=16===this.world().currentKey,p=this.scriptTarget(),c=p.parentThatIsA(b);return h||(t=this.parentThatIsA(BlockEditorMorph))&&(h=t.target.parentThatIsA(Kt)),this.dropRecord&&(this.dropRecord.lastRecord&&(e=!0,a.addPair([new s("turnBack",o.tU.menuFontSize),(0,o.NC)("undrop")],"undrop","^Z","undo the last\nblock drop\nin this pane")),this.dropRecord.nextRecord&&(e=!0,a.addPair([new s("turnForward",o.tU.menuFontSize),(0,o.NC)("redrop")],"redrop","^Y","redo the last undone\nblock drop\nin this pane")),e&&(l&&a.addItem("clear undrop queue",(()=>{this.dropRecord=null,this.clearDropInfo(),this.recordDrop()}),"forget recorded block drops\non this pane",new o.Il(100,0,0)),a.addLine())),a.addItem("clean up","cleanUp","arrange scripts\nvertically"),a.addItem("add comment","addComment"),a.addItem("scripts pic...","exportScriptsPicture","save a picture\nof all scripts"),h&&(a.addLine(),!t&&p.exemplar&&("inherited",i=()=>p.toggleInheritanceForAttribute("scripts"),r=p.inheritsAttribute("scripts"),"uncheck to\ndisinherit",n=(0,o.NC)("check to inherit\nfrom")+" "+p.exemplar.name,a.addItem([new s(r?"checkedBox":"rectangle",.75*o.tU.menuFontSize),(0,o.NC)("inherited")],i,r?"uncheck to\ndisinherit":n)),a.addItem("make a block...",(()=>new BlockDialogMorph(null,(t=>{""!==t.spec&&(t.isGlobal?c.globalBlocks.push(t):p.customBlocks.push(t),h.flushPaletteCache(),h.refreshPalette(),new BlockEditorMorph(t,p).popUp())}),this).prompt("Make a block",null,this.world())))),a},N.prototype.exportScriptsPicture=function(){var t=this.scriptsPicture(),e=this.world().children[0];t&&e.saveCanvasAs(t,(e.projectName||(0,o.NC)("untitled"))+" "+(0,o.NC)("script pic"))},N.prototype.scriptsPicture=function(){var t,e,i;if(0!==this.children.length)return t=this.children[0].fullBounds(),this.children.forEach((e=>{e.isVisible&&(t=t.merge(e.fullBounds()))})),e=(0,o.oM)(t.extent()),i=e.getContext("2d"),this.children.forEach((e=>{var o=e.fullBounds().origin;e.isVisible&&i.drawImage(e.fullImage(),o.x-t.origin.x,o.y-t.origin.y)})),e},N.prototype.addComment=function(){var t=this.parentThatIsA(Kt),e=this.parentThatIsA(BlockEditorMorph),o=this.world();(new ot).pickUp(o),!t&&e&&(t=e.target.parentThatIsA(Kt)),t&&(o.hand.grabOrigin={origin:t.palette,position:t.palette.center()})},N.prototype.undrop=function(){this.isAnimating||this.dropRecord&&this.dropRecord.lastRecord&&(this.dropRecord.situation||(this.dropRecord.situation=this.dropRecord.lastDroppedBlock.situation()),this.isAnimating=!0,this.dropRecord.lastDroppedBlock.slideBackTo(this.dropRecord.lastOrigin,null,this.recoverLastDrop(),(()=>{this.updateToolbar(),this.isAnimating=!1})),this.dropRecord=this.dropRecord.lastRecord)},N.prototype.redrop=function(){this.isAnimating||this.dropRecord&&this.dropRecord.nextRecord&&(this.dropRecord=this.dropRecord.nextRecord,"delete"===this.dropRecord.action?(this.recoverLastDrop(!0),this.dropRecord.lastDroppedBlock.destroy(),this.updateToolbar()):(this.isAnimating=!0,"extract"===this.dropRecord.action&&this.dropRecord.lastDroppedBlock.extract(),this.dropRecord.lastDroppedBlock.slideBackTo(this.dropRecord.situation,null,this.recoverLastDrop(!0),(()=>{this.updateToolbar(),this.isAnimating=!1}))))},N.prototype.recoverLastDrop=function(t){var e,i,s,r=this.dropRecord;if(!r||!r.lastDroppedBlock)throw new Error("nothing to undrop");if(s=(e=r.lastDroppedBlock).parent,e instanceof R){if(r.lastNextBlock&&("delete"===r.action?t&&this.add(r.lastNextBlock):this.add(r.lastNextBlock)),r.lastDropTarget)if("bottom"===r.lastDropTarget.loc)"slot"===r.lastDropTarget.type?r.lastNextBlock&&r.lastDropTarget.element.nestedBlock(r.lastNextBlock):r.lastNextBlock&&r.lastDropTarget.element.nextBlock(r.lastNextBlock);else if("top"===r.lastDropTarget.loc)this.add(r.lastDropTarget.element);else if("wrap"===r.lastDropTarget.loc){var n=(0,o.qY)(r.lastDroppedBlock.inputs(),(t=>t instanceof z));r.lastWrapParent instanceof R?t?i=()=>n.nestedBlock(r.lastDropTarget.element):r.lastWrapParent.nextBlock(r.lastDropTarget.element):r.lastWrapParent instanceof V?t?i=()=>n.nestedBlock(r.lastDropTarget.element):r.lastWrapParent.nestedBlock(r.lastDropTarget.element):this.add(r.lastDropTarget.element),r.lastDropTarget.element.blockSequence().forEach((t=>t.fixBlockColor())),n.fixLayout()}}else if(e instanceof D)r.lastDropTarget&&(t?r.lastDropTarget.replaceInput(r.lastReplacedInput,r.lastDroppedBlock):r.lastDropTarget.replaceInput(r.lastDroppedBlock,r.lastReplacedInput),r.lastDropTarget.fixBlockColor(null,!0),r.lastPreservedBlocks&&r.lastPreservedBlocks.forEach((t=>t.destroy())));else{if(!(e instanceof ot))throw new Error("unsupported action for "+e);t&&r.lastDropTarget&&(i=()=>{r.lastDropTarget.element.comment=e,e.block=r.lastDropTarget.element,e.align()})}return this.clearDropInfo(),e.prepareToBeGrabbed(this.world().hand),e instanceof ot&&e.removeShadow(),this.add(e),s.reactToGrabOf(e),e instanceof D&&s instanceof A&&s.changed(),"delete"===r.action&&(t&&r.lastNextBlock&&(s instanceof R?s.nextBlock(r.lastNextBlock):s instanceof V&&s.nestedBlock(r.lastNextBlock)),t||e.moveBy(new o.E9(-100,-20))),i},N.prototype.clearDropInfo=function(){this.lastDroppedBlock=null,this.lastReplacedInput=null,this.lastDropTarget=null,this.lastPreservedBlocks=null,this.lastNextBlock=null,this.lastWrapParent=null},N.prototype.recordDrop=function(t){var e={lastDroppedBlock:this.lastDroppedBlock,lastReplacedInput:this.lastReplacedInput,lastDropTarget:this.lastDropTarget,lastPreservedBlocks:this.lastPreservedBlocks,lastNextBlock:this.lastNextBlock,lastWrapParent:this.lastWrapParent,lastOrigin:t,action:t&&t.action||null,situation:null,lastRecord:this.dropRecord,nextRecord:null};this.dropRecord&&(this.dropRecord.nextRecord=e),this.dropRecord=e,this.updateToolbar()},N.prototype.addToolbar=function(){var t=new pt,e=new o.Il(140,140,140);return t.respectHiddens=!0,t.undoButton=new st(this,"undrop",new s("turnBack",12)),t.undoButton.alpha=.2,t.undoButton.padding=4,t.undoButton.labelShadowColor=e,t.undoButton.edge=0,t.undoButton.fixLayout(),t.add(t.undoButton),t.redoButton=new st(this,"redrop",new s("turnForward",12)),t.redoButton.alpha=.2,t.redoButton.padding=4,t.redoButton.labelShadowColor=e,t.redoButton.edge=0,t.redoButton.fixLayout(),t.add(t.redoButton),t.keyboardButton=new rt(null,this,"toggleKeyboardEntry",[new s("keyboard",12),new s("keyboardFilled",12)],(()=>!(0,o.kK)(this.focus))),t.keyboardButton.alpha=.2,t.keyboardButton.padding=4,t.keyboardButton.edge=0,t.keyboardButton.hint="use the keyboard\nto enter blocks",t.keyboardButton.labelShadowColor=e,t.keyboardButton.fixLayout(),t.add(t.keyboardButton),t},N.prototype.updateToolbar=function(){var t=this.parentThatIsA(o.yR);t&&(t.toolBar||(t.toolBar=this.addToolbar(),t.add(t.toolBar)),this.enableKeyboard?(t.toolBar.keyboardButton.show(),t.toolBar.keyboardButton.refresh()):t.toolBar.keyboardButton.hide(),this.dropRecord&&(this.dropRecord.lastRecord?t.toolBar.undoButton.isVisible||t.toolBar.undoButton.show():t.toolBar.undoButton.isVisible&&t.toolBar.undoButton.hide(),this.dropRecord.nextRecord?t.toolBar.redoButton.isVisible||(t.toolBar.redoButton.show(),t.toolBar.undoButton.mouseLeave()):t.toolBar.redoButton.isVisible&&t.toolBar.redoButton.hide()),(0,o.qY)(t.toolBar.children,(t=>t.isVisible))&&(t.toolBar.fixLayout(),t.adjustToolBar()))},N.prototype.fixMultiArgs=function(){this.forAllChildren((t=>{t instanceof Z&&t.fixLayout()}))},N.prototype.wantsDropOf=function(t){return t instanceof F?!this.rejectsHats:t instanceof I||t instanceof ot},N.prototype.reactToDropOf=function(t,e){(t instanceof A||t instanceof ot)&&t.snap(e),this.adjustBounds()},N.prototype.mouseClickLeft=function(t){if(16===this.world().currentKey)return this.edit(t);this.focus&&this.focus.stopEditing()},N.prototype.selectForEdit=function(){var t=this.parentThatIsA(Kt),e=t?t.currentSprite:null;return e&&e.inheritsAttribute("scripts")?(this.feedbackMorph.destroy(),e.shadowAttribute("scripts"),e.scripts):this},N.prototype.edit=function(t){var e,o=this.world();this.focus&&this.focus.stopEditing(),o.stopEditing(),N.prototype.enableKeyboard&&((e=this.selectForEdit()).focus=new it(e,e,t),e.focus.getFocus(o))},N.prototype.toggleKeyboardEntry=function(){var t,e,i=this.world();this.focus?this.focus.stopEditing():(i.stopEditing(),N.prototype.enableKeyboard&&((t=this.selectForEdit()).focus=new it(t,t,t.position()),t.focus.getFocus(i),(e=t.focus.sortedScripts()).length?(t.focus.element=e[0],t.focus.element instanceof F&&t.focus.nextCommand()):t.focus.moveBy(new o.E9(50,50)),t.focus.fixLayout()))},N.prototype.scriptTarget=function(){var t=this.parentThatIsA(Kt);if(t)return t.currentSprite;if(t=this.parentThatIsA(BlockEditorMorph))return t.target;throw new Error("script target cannot be found for orphaned scripts")},j.prototype=new I,j.prototype.constructor=j,j.uber=I.prototype,j.prototype.init=function(t){this.type=t||null,this.icon=null,j.uber.init.call(this),this.color=new o.Il(0,17,173),this.createIcon(),"list"===t&&(this.alpha=1)},j.prototype.argId=function(){var t=this.parentThatIsA(A);if(!t)return null;var e=this.parent.children.filter((function(t){return t instanceof j})).indexOf(this),o=t.blockId();return o.argIndex=e,o},j.prototype.executeOnSliderEdit=!1,j.prototype.justDropped=function(){this instanceof V||(this.fixLayout(),this.rerender())},j.prototype.getSpec=function(){return"%s"},j.prototype.createIcon=function(){switch(this.type){case"list":this.icon=this.labelPart("%list"),this.add(this.icon);break;case"object":this.icon=this.labelPart("%turtle"),this.add(this.icon);break;default:(0,o.WY)()}},j.prototype.fixLayout=function(){this.icon?(this.icon.setPosition(this.position()),this.bounds.setExtent(this.icon.extent())):j.uber.fixLayout.call(this)},j.prototype.render=function(t){var e;if(this.icon)switch((e=this.parentThatIsA(A))&&(this.icon.shadowColor=e.color.darker(this.labelContrast)),this.type){case"list":this.color=new o.Il(255,140,0);break;default:return}j.uber.render.call(this,t)},j.prototype.isEmptySlot=function(){return null!==this.type},V.prototype=new j,V.prototype.constructor=V,V.uber=j.prototype,V.prototype.init=function(){V.uber.init.call(this),this.color=new o.Il(0,17,173),this.setExtent(new o.E9(230,4*this.corner+this.cSlotPadding))},V.prototype.getSpec=function(){return"%cmd"},V.prototype.topBlock=function(){return this.parent.topBlock?this.parent.topBlock():this.nestedBlock()},V.prototype.nestedBlock=function(t){if(!t)return(0,o.qY)(this.children,(t=>t instanceof R));var e=this.nestedBlock();this.add(t),e&&t.bottomBlock().nextBlock(e),this.fixLayout()},V.prototype.slotAttachPoint=function(){return new o.E9(this.dentCenter(),this.top()+2*this.corner)},V.prototype.dentLeft=function(){return this.left()+this.corner+2*this.inset},V.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent},V.prototype.attachTargets=function(){var t=[];return t.push({point:this.slotAttachPoint(),element:this,loc:"bottom",type:"slot"}),t},V.prototype.fixLayout=function(){var t=this.nestedBlock();this.parent&&(this.color.eq(this.parent.color)||this.setColor(this.parent.color)),t?(t.setPosition(new o.E9(this.left()+this.edge+this.rfBorder,this.top()+this.edge+this.rfBorder)),this.bounds.setWidth(t.fullBounds().width()+2*(this.edge+this.rfBorder)),this.bounds.setHeight(t.fullBounds().height()+this.edge+2*this.rfBorder-(this.corner-this.edge))):(this.bounds.setHeight(4*this.corner),this.bounds.setWidth(4*this.corner+this.inset+this.dent)),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},V.prototype.evaluate=function(){return this.nestedBlock()},V.prototype.isEmptySlot=function(){return!this.isStatic&&null===this.nestedBlock()},V.prototype.attach=function(){var t=this.overlappedMorphs(),e=new o.wR(this,"choose new parent:");t.forEach((t=>e.addItem(t.toString().slice(0,50),(()=>{t.add(this),this.isDraggable=!1,t.fixLayout&&t.fixLayout()})))),t.length>0&&e.popUpAtHand(this.world())},V.prototype.render=function(t){this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),t.fillStyle=this.cachedClr,t.fillRect(0,0,this.width(),this.height()),t.fillStyle=this.rfColor.toString(),this.drawFlat(t),o.tU.isFlat||this.drawEdges(t)},V.prototype.drawFlat=function(t){var e=null!==this.nestedBlock(),i=e?this.inset:this.inset/2,s=e?this.dent:this.dent/2,r=2*this.corner+i,n=this.edge,a=e?this.rfBorder:0,h=this.height()-this.corner-n;t.beginPath(),t.arc(this.corner+n,this.corner+n,this.corner,(0,o.uR)(-180),(0,o.uR)(-90),!1),t.lineTo(this.corner+i+n+2*a,n),t.lineTo(r+n+2*a,this.corner+n),t.lineTo(r+n+2*a+(s-2*a),this.corner+n),t.lineTo(r+n+2*a+(s-2*a)+this.corner,n),t.lineTo(this.width()-this.corner-n,n),t.arc(this.width()-this.corner-n,this.corner+n,this.corner,(0,o.uR)(-90),(0,o.uR)(-0),!1),t.arc(this.width()-this.corner-n,h,this.corner,(0,o.uR)(0),(0,o.uR)(90),!1),t.arc(this.corner+n,h,this.corner,(0,o.uR)(90),(0,o.uR)(180),!1),t.closePath(),t.fill()},V.prototype.drawEdges=function(t){var e,i,s,r,n=null!==this.nestedBlock(),a=n?this.inset:this.inset/2,h=n?this.dent:this.dent/2,l=2*this.corner+a,p=this.edge,c=n?this.rfBorder:0,d=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(e=t.createLinearGradient(0,this.height(),0,this.height()-this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner+p,this.height()-d),t.lineTo(this.width()-this.corner-p,this.height()-d),t.stroke(),(e=t.createRadialGradient(this.width()-(this.corner+p),this.height()-(this.corner+p),this.corner,this.width()-(this.corner+p),this.height()-(this.corner+p),this.corner+p)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.arc(this.width()-(this.corner+p),this.height()-(this.corner+p),this.corner+d,(0,o.uR)(0),(0,o.uR)(90),!1),t.stroke(),(e=t.createLinearGradient(this.width(),0,this.width()-this.edge,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(this.width()-d,this.height()-this.corner-this.edge),t.lineTo(this.width()-d,p+this.corner),t.stroke(),o.A3&&(t.shadowOffsetY=d,t.shadowBlur=this.edge,t.shadowColor=this.rfColor.darker(80).toString()),(e=t.createLinearGradient(0,0,p,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(d,p+this.corner),t.lineTo(d,this.height()-p-this.corner),t.stroke(),(e=t.createRadialGradient(this.corner+p,this.corner+p,this.corner,this.corner+p,this.corner+p,this.corner+p)).addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.arc(this.corner+p,this.corner+p,this.corner+d,(0,o.uR)(-180),(0,o.uR)(-90),!1),t.stroke(),(i=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(this.corner+p,d),t.lineTo(this.corner+a+p+2*c-d,d),t.stroke(),(s=t.createLinearGradient(0,this.corner,0,this.corner+p)).addColorStop(0,this.cachedClr),s.addColorStop(1,this.cachedClrDark),t.strokeStyle=s,t.beginPath(),t.moveTo(l+p+2*c+d,this.corner+d),t.lineTo(l+p+2*c+(h-2*c),this.corner+d),t.stroke(),(r=t.createLinearGradient(l+p+2*c+(h-2*c)-d,this.corner,l+p+2*c+(h-2*c)+.7*d,this.corner+d+.7*d)).addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(l+p+2*c+(h-2*c),this.corner+d),t.lineTo(l+p+2*c+(h-2*c)+this.corner,d),t.stroke(),t.strokeStyle=i,t.beginPath(),t.moveTo(l+p+2*c+(h-2*c)+this.corner,d),t.lineTo(this.width()-this.corner-p,d),t.stroke()},W.prototype=new V,W.prototype.constructor=W,W.uber=V.prototype,W.prototype.rfBorder=0,W.prototype.edge=O.prototype.edge,W.prototype.init=function(){W.uber.init.call(this),this.color=new o.Il(0,17,173),this.contrast=O.prototype.contrast},W.prototype.getSpec=function(){return"%rc"},W.prototype.render=function(t){o.tU.isFlat||(this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),t.fillStyle=this.cachedClr,this.drawEdges(t))},W.prototype.outlinePath=function(t,e){var i=e.x,s=e.y,r=null!==this.nestedBlock(),n=r?this.inset:this.inset/2,a=r?this.dent:this.dent/2,h=2*this.corner+n,l=this.edge,p=this.width(),c=this.height(),d=r?this.rfBorder:0,u=c-this.corner-l;t.arc(this.corner+l+i,this.corner+l+s,this.corner,(0,o.uR)(-180),(0,o.uR)(-90),!1),t.lineTo(this.corner+n+l+2*d+i,l+s),t.lineTo(h+l+2*d+i,this.corner+l+s),t.lineTo(h+l+2*d+(a-2*d)+i,this.corner+l+s),t.lineTo(h+l+2*d+(a-2*d)+this.corner+i,l+s),t.lineTo(this.width()-this.corner-l+i,l+s),t.arc(p-this.corner-l+i,this.corner+l+s,this.corner,(0,o.uR)(-90),(0,o.uR)(-0),!1),t.arc(this.width()-this.corner-l+i,u+s,this.corner,(0,o.uR)(0),(0,o.uR)(90),!1),t.arc(this.corner+l+i,u+s,this.corner,(0,o.uR)(90),(0,o.uR)(180),!1),t.lineTo(this.corner+l+i-this.corner,this.corner+l+s)},z.prototype=new V,z.prototype.constructor=z,z.uber=V.prototype,z.prototype.init=function(){V.uber.init.call(this),this.isLambda=!1,this.isLoop=!1,this.color=new o.Il(0,17,173),this.setExtent(new o.E9(230,4*this.corner+this.cSlotPadding))},z.prototype.getSpec=function(){return this.isLoop?"%loop":"%c"},z.prototype.mappedCode=function(t){var e=(b.prototype.codeMappings.reify||"<#1>").split("\n"),o=this.nestedBlock(),i=(o?o.mappedCode(t):"").toString().split("\n"),s=new RegExp("<#1>","g");return e.forEach(((t,o)=>{var r,n="";0===t.trimLeft().indexOf("<#1>")&&(r=t.indexOf("<#1>"),n=t.slice(0,r)),e[o]=t.replace(new RegExp("<#1>"),i.join("\n"+n)),e[o]=e[o].replace(s,i.join("\n"))})),e.join("\n")},z.prototype.fixLayout=function(){var t=this.nestedBlock();t?(t.setPosition(new o.E9(this.left()+this.inset,this.top()+this.corner)),this.bounds.setHeight(t.fullBounds().height()+this.corner),this.bounds.setWidth(t.fullBounds().width()+2*this.cSlotPadding)):(this.bounds.setHeight(4*this.corner+this.cSlotPadding),this.bounds.setWidth(4*this.corner+2*this.inset+this.dent+2*this.cSlotPadding)),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},z.prototype.fixLoopLayout=function(){var t;this.isLoop&&(t=this.loop())&&(t.setRight(this.right()-this.corner),t.setBottom(this.bottom()+this.cSlotPadding+this.edge))},z.prototype.loop=function(){return this.isLoop?(0,o.qY)(this.children,(t=>t instanceof s)):null},z.prototype.fixHolesLayout=function(){this.holes=[new o.Ae(this.inset,this.corner,this.width(),this.height()-this.corner)]},z.prototype.isLocked=function(){return this.isStatic||this.parent instanceof Z},z.prototype.render=function(t){o.tU.isFlat||(this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),t.fillStyle=this.cachedClr,this.drawTopRightEdge(t),this.drawTopEdge(t,this.inset,this.corner),this.drawTopLeftEdge(t),this.drawBottomEdge(t),this.drawRightEdge(t))},z.prototype.outlinePath=function(t,e,i){var s=i.x,r=i.y,n=Math.max(this.corner-e,0);t.lineTo(this.width()+s-e,r),t.arc(this.width()-this.corner+s,r,n,(0,o.uR)(90),(0,o.uR)(0),!0),t.lineTo(this.width()-this.corner+s,this.corner+r-e),t.lineTo(2*this.inset+3*this.corner+this.dent+s,this.corner+r-e),t.lineTo(2*this.inset+2*this.corner+this.dent+s,2*this.corner+r-e),t.lineTo(2*this.inset+2*this.corner+s,2*this.corner+r-e),t.lineTo(2*this.inset+this.corner+s,this.corner+r-e),t.lineTo(this.inset+this.corner+s,this.corner+r-e),t.arc(this.inset+this.corner+s,2*this.corner+r,this.corner+e,(0,o.uR)(270),(0,o.uR)(180),!0),t.lineTo(this.inset+s-e,this.height()-2*this.corner+r),t.arc(this.inset+this.corner+s,this.height()-2*this.corner+r,this.corner+e,(0,o.uR)(180),(0,o.uR)(90),!0),t.lineTo(this.width()-this.corner+s,this.height()-this.corner+r+e),t.arc(this.width()-this.corner+s,this.height()+r,n,(0,o.uR)(-90),(0,o.uR)(-0),!1)},z.prototype.drawTopRightEdge=function(t){var e,i=.5*this.edge,s=this.width()-this.corner;(e=t.createRadialGradient(s,0,this.corner,s,0,this.corner-this.edge)).addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(s,0,this.corner-i,(0,o.uR)(90),(0,o.uR)(0),!0),t.stroke()},z.prototype.drawTopEdge=function(t,e,o){var i,s,r,n=.5*this.edge,a=e+2*this.corner+this.inset;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(i=t.createLinearGradient(0,o-this.edge,0,o)).addColorStop(0,this.cachedClr),i.addColorStop(1,this.cachedClrDark),t.strokeStyle=i,t.beginPath(),t.moveTo(e+this.corner,o-n),t.lineTo(e+this.corner+this.inset-n,o-n),t.stroke(),(s=t.createLinearGradient(0,o+this.corner-this.edge,0,o+this.corner)).addColorStop(0,this.cachedClr),s.addColorStop(1,this.cachedClrDark),t.strokeStyle=s,t.beginPath(),t.moveTo(a+n,o+this.corner-n),t.lineTo(a+this.dent,o+this.corner-n),t.stroke(),(r=t.createLinearGradient(e+this.inset+2*this.corner+this.dent-n,o+this.corner-n-n,e+this.inset+2*this.corner+this.dent+.7*n,o+this.corner-n+.7*n)).addColorStop(0,this.cachedClr),r.addColorStop(1,this.cachedClrDark),t.strokeStyle=r,t.beginPath(),t.moveTo(e+this.inset+2*this.corner+this.dent,o+this.corner-n),t.lineTo(e+3*this.corner+this.inset+this.dent,o-n),t.stroke(),t.strokeStyle=i,t.beginPath(),t.moveTo(e+3*this.corner+this.inset+this.dent,o-n),t.lineTo(this.width()-this.corner,o-n),t.stroke()},z.prototype.drawTopLeftEdge=function(t){var e,i=.5*this.edge;(e=t.createRadialGradient(this.corner+this.inset,2*this.corner,this.corner,this.corner+this.inset,2*this.corner,this.corner+this.edge)).addColorStop(0,this.cachedClrDark),e.addColorStop(1,this.cachedClr),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.arc(this.corner+this.inset,2*this.corner,this.corner+i,(0,o.uR)(-180),(0,o.uR)(-90),!1),t.stroke()},z.prototype.drawRightEdge=function(t){var e,o=.5*this.edge,i=this.inset;(e=t.createLinearGradient(i-this.edge,0,i,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(i-o,2*this.corner),t.lineTo(i-o,this.height()-2*this.corner),t.stroke()},z.prototype.drawBottomEdge=function(t){var e,i,s=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(i=t.createRadialGradient(this.corner+this.inset,this.height()-2*this.corner,this.corner,this.corner+this.inset,this.height()-2*this.corner,this.corner+this.edge)).addColorStop(0,this.cachedClrBright),i.addColorStop(1,this.cachedClr),t.strokeStyle=i,t.beginPath(),t.arc(this.corner+this.inset,this.height()-2*this.corner,this.corner+s,(0,o.uR)(180),(0,o.uR)(90),!0),t.stroke(),(e=t.createLinearGradient(0,this.height()-this.corner,0,this.height()-this.corner+this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.inset+this.corner,this.height()-this.corner+s),t.lineTo(this.width()-this.corner,this.height()-this.corner+s),t.stroke()},H.prototype=new j,H.prototype.constructor=H,H.uber=j.prototype,H.prototype.init=function(t,e,i,s){var r=new U(""),n=new Y("down",0,Math.max(Math.floor(this.fontSize/6),1),o.E5,!0);r.fontSize=this.fontSize,r.isShowingBlanks=!0,this.selectedBlock=null,this.isUnevaluated=!1,this.choices=i||null,this.oldContentsExtent=r.extent(),this.isNumeric=e||!1,this.isReadOnly=s||!1,this.minWidth=0,this.constant=null,H.uber.init.call(this,null,!0),this.color=o.Cj,this.add(r),this.add(n),r.isEditable=!0,r.isDraggable=!1,r.enableSelecting(),this.setContents(t)},H.prototype.getSpec=function(){return this.isNumeric?"%n":"%s"},H.prototype.contents=function(){return(0,o.qY)(this.children,(t=>t instanceof o.XC))},H.prototype.arrow=function(){return(0,o.qY)(this.children,(t=>t instanceof Y))},H.prototype.setContents=function(t){var e=this.contents(),i=t,s=i instanceof Array;if(this.selectedBlock&&(this.selectedBlock=null),s)i=(0,o.NC)(i[0]),e.isItalic=!this.isReadOnly;else if(i instanceof A)this.selectedBlock=i,i="";else if(e.isItalic=!1,!(0,o.kK)(this.choices)&&this.choices[i]instanceof Array)return this.setContents(this.choices[i]);e.text=i,(0,o.kK)(i)?e.text="":i.toString&&(e.text=i.toString()),this.isReadOnly&&!o.tU.isFlat&&(e.shadowOffset=new o.E9(1,1)),e.fixLayout(),this.constant=s?t:null,this.isReadOnly&&this.parent instanceof A&&this.parent.fixLabelColor()},H.prototype.userSetContents=function(t){this.selectForEdit().setContents(t)},H.prototype.dropDownMenu=function(t){var e=this.menuFromDict(this.choices,null,t);e&&e.items.length>0&&(t?(e.popup(this.world(),this.bottomLeft()),e.getFocus()):e.popUpAtHand(this.world()))},H.prototype.menuFromDict=function(t,e,i){var r,n,a,h=this,l=new o.wR(this.userSetContents,null,this,this.fontSize);function p(t){h.setContents(t),h.reactToSliderEdit()}function c(t){return()=>t.fullImage()}if(t instanceof Function)t=t.call(this);else if((0,o.HD)(t)&&!(t=this[t](i)))return;for(r in e||l.addItem(" ",(function(){return" "})),t)Object.prototype.hasOwnProperty.call(t,r)&&("~"===r[0]?l.addLine():0===r.indexOf("§_def")?l.addItem(this.doWithAlpha(1,c(t[r])),t[r]):0===r.indexOf("§_dir")?((n=new o.ZZ).rootForGrab=function(){return this},n.target=this,n.action=p,n.fillColor=this.parent.color,n.setRadius(3*this.fontSize),n.setValue(+this.evaluate(),!1,!0),l.addLine(),l.items.push(n),l.addLine()):0===r.indexOf("§_")?16===this.world().currentKey&&l.addItem(r.slice(2),t[r],null,null,null,!0,null,null,!(t[r]instanceof Array)&&"function"!=typeof t[r]):"__shout__go__"===r?((a=new s("flag")).size=1.5*this.fontSize,a.setColor(new o.Il(0,200,0)),a.fixLayout(),l.addItem(a,["__shout__go__"])):t[r]instanceof Object&&!(t[r]instanceof Array)&&"function"!=typeof t[r]?l.addMenu(r,this.menuFromDict(t[r],!0),null,!0):t[r]instanceof Array&&t[r][0]instanceof Object&&"function"!=typeof t[r][0]?l.addMenu(r,this.menuFromDict(t[r][0],!0),null,!1):function(e){l.addItem(e,(function(){var o=t[e];return o instanceof Function?o():o}),null,null,null,null,null,null,!(t[e]instanceof Array)&&"function"!=typeof t[e]&&"number"!=typeof t[e])}(r));return l},H.prototype.messagesMenu=function(){var t={},e=this.parentThatIsA(A).scriptTarget().parentThatIsA(b),o=[];return e.children.concat(e).forEach((t=>{g(t)&&(o=o.concat(t.allMessageNames()))})),o.sort().forEach((e=>t[e]=e)),16===this.world().currentKey&&(t.__shout__go__=["__shout__go__"]),o.length>0&&(t["~"]=null),t["new..."]=()=>new lt(this,this.setContents,this).prompt("Message name",null,this.world()),t},H.prototype.messagesReceivedMenu=function(){var t={"any message":["any message"]},e=this.parentThatIsA(A).scriptTarget().parentThatIsA(b),o=[];return e.children.concat(e).forEach((t=>{g(t)&&(o=o.concat(t.allMessageNames()))})),o.sort().forEach((e=>{"__shout__go__"!==e&&(t[e]=e)})),t["~"]=null,t["new..."]=()=>new lt(this,this.setContents,this).prompt("Message name",null,this.world()),t},H.prototype.collidablesMenu=function(){var t={"mouse-pointer":["mouse-pointer"],edge:["edge"],"pen trails":["pen trails"]},e=this.parentThatIsA(A).scriptTarget(),o=e.parentThatIsA(b),i=[];return o.children.forEach((t=>{t instanceof y&&!t.isTemporary&&t.name!==e.name&&(i=i.concat(t.name))})),i.length>0&&(t["~"]=null,i.forEach((e=>t[e]=e))),t},H.prototype.locationMenu=function(){var t={"mouse-pointer":["mouse-pointer"],myself:["myself"]},e=this.parentThatIsA(A).scriptTarget(),o=e.parentThatIsA(b),i=[];return o.children.forEach((t=>{t instanceof y&&!t.isTemporary&&t.name!==e.name&&(i=i.concat(t.name))})),i.length>0&&(t["~"]=null,i.forEach((e=>t[e]=e))),t},H.prototype.distancesMenu=function(){var t=this.parentThatIsA(A),e={},o=this.parentThatIsA(A).scriptTarget(),i=o.parentThatIsA(b),s=[];return t&&"reportRelationTo"!==t.selector&&(e["random position"]=["random position"]),e["mouse-pointer"]=["mouse-pointer"],e.center=["center"],i.children.forEach((t=>{t instanceof y&&!t.isTemporary&&t.name!==o.name&&(s=s.concat(t.name))})),s.length>0&&(e["~"]=null,s.forEach((t=>e[t]=t))),e},H.prototype.distancesMenu=function(){var t=this.parentThatIsA(A),e={},o=this.parentThatIsA(A).scriptTarget(),i=o.parentThatIsA(b),s=[];return t&&"reportRelationTo"!==t.selector&&(e["random position"]=["random position"]),e["mouse-pointer"]=["mouse-pointer"],e.center=["center"],i.children.forEach((function(t){t instanceof y&&!t.isTemporary&&t.name!==o.name&&(s=s.concat(t.name))})),s.length>0&&(e["~"]=null,s.forEach((function(t){e[t]=t}))),e},H.prototype.clonablesMenu=function(){var t={},e=this.parentThatIsA(A).scriptTarget(),o=e.parentThatIsA(b),i=[];return e instanceof y&&(t.myself=["myself"]),o.children.forEach((t=>{t instanceof y&&!t.isTemporary&&(i=i.concat(t.name))})),i.length>0&&(t["~"]=null,i.forEach((e=>t[e]=e))),t},H.prototype.objectsMenuWithSelf=function(){return this.objectsMenu(!0)},H.prototype.objectsMenu=function(t){var e=this.parentThatIsA(A).scriptTarget().parentThatIsA(b),o={},i=[];return t&&(o.myself=["myself"]),o[e.name]=e.name,e.children.forEach((t=>{t instanceof y&&!t.isTemporary&&i.push(t.name)})),i.length>0&&(o["~"]=null,i.forEach((t=>o[t]=t))),o},H.prototype.typesMenu=function(){var t={number:["number"],text:["text"],Boolean:["Boolean"],list:["list"]};return y.prototype.enableFirstClass&&(t.sprite=["sprite"]),t.costume=["costume"],t.sound=["sound"],t.command=["command"],t.reporter=["reporter"],t.predicate=["predicate"],t},H.prototype.gettablesMenu=function(){var t={},e=y.prototype.enableNesting,o=b.prototype.enableInheritance;return t.neighbors=["neighbors"],t.self=["self"],t["other sprites"]=["other sprites"],t.clones=["clones"],t["other clones"]=["other clones"],e&&(t.parts=["parts"],t.anchor=["anchor"]),t.stage=["stage"],o&&(t.children=["children"],t.parent=["parent"],t["temporary?"]=["temporary?"]),t.name=["name"],t.costume=["costume"],t.costumes=["costumes"],t.sounds=["sounds"],t["dangling?"]=["dangling?"],t["draggable?"]=["draggable?"],t.width=["width"],t.height=["height"],t.left=["left"],t.right=["right"],t.top=["top"],t.bottom=["bottom"],t["rotation style"]=["rotation style"],t["rotation x"]=["rotation x"],t["rotation y"]=["rotation y"],t["center x"]=["center x"],t["center y"]=["center y"],t},H.prototype.attributesMenu=function(){var t,e=this.parentThatIsA(A),i=e.inputs()[1].evaluate(),s=e.scriptTarget().parentThatIsA(b),r={},n=[];return(t=i===s.name?s:(0,o.qY)(s.children,(t=>t.name===i)))?(r=t instanceof y?{"x position":["x position"],"y position":["y position"],direction:["direction"],"costume #":["costume #"],"costume name":["costume name"],size:["size"],width:["width"],height:["height"],left:["left"],right:["right"],top:["top"],bottom:["bottom"],volume:["volume"],balance:["balance"]}:{"costume #":["costume #"],"costume name":["costume name"],volume:["volume"],balance:["balance"],width:["width"],height:["height"],left:["left"],right:["right"],top:["top"],bottom:["bottom"]},(n=t.variables.names()).length>0&&(r["~"]=null,n.forEach((t=>r[t]=t))),t.allBlocks(!0).forEach(((t,e)=>r["§_def"+e]=t.blockInstance(!0))),r):r},H.prototype.costumesMenu=function(){var t,e=this.parentThatIsA(A),o=e.scriptTarget(),i=[];return t=o instanceof y?{Turtle:["Turtle"]}:{Empty:["Empty"]},"doSwitchToCostume"!==e.selector&&(t.current=["current"]),o.costumes.asArray().forEach((t=>i=i.concat(t.name))),i.length>0&&(t["~"]=null,i.forEach((e=>t[e]=e))),t},H.prototype.soundsMenu=function(){var t=this.parentThatIsA(A).scriptTarget(),e=[],o={};return t.sounds.asArray().forEach((t=>e=e.concat(t.name))),e.length>0&&e.sort().forEach((t=>o[t]=t)),o},H.prototype.shadowedVariablesMenu=function(){var t,e=this.parentThatIsA(A),o={};return e?(t=e.scriptTarget(),this.parentThatIsA(O)||"receiveOnClone"===this.topBlock().selector?(t.variables.names().forEach((t=>o[t]=t)),t.attributes.forEach((t=>o[t]=[t]))):t&&t.exemplar&&(t.inheritedVariableNames(!0).forEach((t=>o[t]=t)),t.shadowedAttributes().forEach((t=>o[t]=[t]))),o):o},H.prototype.pianoKeyboardMenu=function(){var t,e,i;(e=this.parentThatIsA(A))&&(i=e.scriptTarget().instrument),(t=new dt(this.setContents,this,this.fontSize,i)).popup(this.world(),new o.E9(this.right()-t.width()/2,this.bottom())),t.selectKey(+this.evaluate())},H.prototype.directionDialMenu=function(){return{"§_dir":null}},H.prototype.audioMenu=function(){var t={volume:["volume"],note:["note"],frequency:["frequency"],samples:["samples"],"sample rate":["sample rate"],spectrum:["spectrum"],resolution:["resolution"]};return 16===this.world().currentKey&&(t["~"]=null,t.modifier=["modifier"],t.output=["output"]),t},H.prototype.setChoices=function(t,e){var i=this.contents();this.choices=t,this.isReadOnly=e||!1,this.parent instanceof A&&(this.parent.fixLabelColor(),e||(i.shadowOffset=o.xE,i.shadowColor=null,i.setColor(o.E5))),this.fixLayout()},H.prototype.fixLayout=function(){var t,e,i,s=this.contents(),r=this.arrow(),n=this.topBlock();s.isNumeric=this.isNumeric,s.isEditable=!this.isReadOnly,this.isReadOnly?(s.disableSelecting(),s.color=o.Cj):(s.enableSelecting(),s.color=o.E5),this.choices?(r.setSize(this.fontSize),r.show()):r.hide(),i=r.isVisible?r.width():0,this.selectedBlock?(e=this.selectedBlock.height()+2*this.edge,t=this.selectedBlock.width()+i+2*this.edge+2*this.typeInPadding):(e=s.height()+2*this.edge,t=this.isNumeric?s.width()+Math.floor(.5*i)+e+2*this.typeInPadding:Math.max(s.width()+i+2*this.edge+2*this.typeInPadding,s.rawHeight?s.rawHeight()+i:(0,o.SW)(s.fontSize)/1.3+i,this.minWidth)),this.bounds.setExtent(new o.E9(t,e)),this.isNumeric?s.setPosition(new o.E9(Math.floor(e/2),this.edge).add(new o.E9(this.typeInPadding,0)).add(this.position())):s.setPosition(new o.E9(this.edge,this.edge).add(new o.E9(this.typeInPadding,0)).add(this.position())),r.isVisible&&r.setPosition(new o.E9(this.right()-i-this.edge,s.top())),this.parent&&this.parent.fixLayout&&(n.fullChanged(),this.parent.fixLayout(),n.fullChanged())},H.prototype.mouseDownLeft=function(t){this.isReadOnly||this.arrow().bounds.containsPoint(t)?this.escalateEvent("mouseDownLeft",t):this.selectForEdit().contents().edit()},H.prototype.mouseClickLeft=function(t){this.arrow().bounds.containsPoint(t)||this.isReadOnly?this.dropDownMenu():this.contents().edit()},H.prototype.reactToKeystroke=function(){var t;this.constant&&(t=this.contents(),this.constant=null,t.isItalic=!1,t.rerender())},H.prototype.reactToEdit=function(){this.contents().clearSelection()},H.prototype.freshTextEdit=function(t){this.onNextStep=()=>t.selectAll()},H.prototype.userMenu=function(){var t=new o.wR(this);return b.prototype.enableCodeMapping?(this.isNumeric?t.addItem("code number mapping...","mapNumberToCode"):t.addItem("code string mapping...","mapStringToCode"),t):this.parent.userMenu()},H.prototype.mapStringToCode=function(){new lt(this,(t=>b.prototype.codeMappings.string=t),this).promptCode("Code mapping - String <#1>",b.prototype.codeMappings.string||"",this.world())},H.prototype.mapNumberToCode=function(){new lt(this,(t=>b.prototype.codeMappings.number=t),this).promptCode("Code mapping - Number <#1>",b.prototype.codeMappings.number||"",this.world())},H.prototype.mappedCode=function(){var t=this.parentThatIsA(A),e=this.evaluate();return this.isNumeric?(b.prototype.codeMappings.number||"<#1>").replace(/<#1>/g,e):isNaN(parseFloat(e))&&(0,o.HD)(e)?t&&(0,o.r3)(["doSetVar","doChangeVar","doShowVar","doHideVar"],t.selector)?e:(b.prototype.codeMappings.string||"<#1>").replace(/<#1>/g,e):e},H.prototype.evaluate=function(){var t,e;return this.selectedBlock?this.selectedBlock:this.constant?this.constant:(e=this.contents(),this.isNumeric&&(t=parseFloat(e.text||"0"),!isNaN(t))?t:e.text)},H.prototype.isEmptySlot=function(){return""===this.contents().text&&!this.selectedBlock},H.prototype.flash=function(){this.cachedNormalColor||(this.cachedNormalColor=this.color,this.color=this.activeHighlight,this.rerender())},H.prototype.unflash=function(){if(this.cachedNormalColor){var t=this.cachedNormalColor;this.cachedNormalColor=null,this.color=t,this.rerender()}},H.prototype.render=function(t){var e,i;e=this.cachedNormalColor?this.color:this.parent?this.parent.color:new o.Il(120,120,120),t.fillStyle=this.color.toString(),this.isReadOnly&&!this.cachedNormalColor&&(t.fillStyle=e.darker().toString()),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),this.isNumeric?(i=Math.max((this.height()-2*this.edge)/2,0),t.beginPath(),t.arc(i+this.edge,i+this.edge,i,(0,o.uR)(90),(0,o.uR)(-90),!1),t.arc(this.width()-i-this.edge,i+this.edge,i,(0,o.uR)(-90),(0,o.uR)(90),!1),t.closePath(),t.fill(),o.tU.isFlat||this.drawRoundBorder(t)):(t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),o.tU.isFlat||this.drawRectBorder(t)),this.selectedBlock&&t.drawImage(this.doWithAlpha(1,(()=>this.selectedBlock.fullImage())),this.edge+this.typeInPadding,this.edge)},H.prototype.drawRectBorder=function(t){var e,i=.5*this.edge;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",o.A3&&(t.shadowOffsetY=i,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString()),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,i),t.lineTo(this.width()-this.edge-i,i),t.stroke(),t.shadowOffsetY=0,(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(i,this.edge),t.lineTo(i,this.height()-this.edge-i),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(0,this.height()-this.edge,0,this.height())).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,this.height()-i),t.lineTo(this.width()-this.edge,this.height()-i),t.stroke(),(e=t.createLinearGradient(this.width()-this.edge,0,this.width(),0)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.width()-i,this.edge),t.lineTo(this.width()-i,this.height()-this.edge),t.stroke()},H.prototype.drawRoundBorder=function(t){var e,i,s,r=.5*this.edge,n=Math.max((this.height()-2*this.edge)/2,0);t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",e=n+this.edge,(i=this.width()-n-this.edge)>e&&(o.A3&&(t.shadowOffsetX=r,t.shadowOffsetY=r,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString()),(s=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),s.addColorStop(1,this.cachedClrDark),t.strokeStyle=s,t.beginPath(),t.moveTo(e,r),t.lineTo(i,r),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0),(s=t.createLinearGradient(0,this.height()-this.edge,0,this.height())).addColorStop(0,this.cachedClrBright),s.addColorStop(1,this.cachedClr),t.strokeStyle=s,t.beginPath(),t.moveTo(n+this.edge,this.height()-r),t.lineTo(this.width()-n-this.edge,this.height()-r),t.stroke(),n=Math.max(this.height()/2,this.edge),o.A3&&(t.shadowOffsetX=r,t.shadowOffsetY=r,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString()),(s=t.createRadialGradient(n,n,n-this.edge,n,n,n)).addColorStop(1,this.cachedClr),s.addColorStop(0,this.cachedClrDark),t.strokeStyle=s,t.beginPath(),t.arc(n,n,n-r,(0,o.uR)(180),(0,o.uR)(270),!1),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(s=t.createRadialGradient(this.width()-n,n,n-this.edge,this.width()-n,n,n)).addColorStop(1,this.cachedClr),s.addColorStop(0,this.cachedClrBright),t.strokeStyle=s,t.beginPath(),t.arc(this.width()-n,n,n-r,(0,o.uR)(0),(0,o.uR)(90),!1),t.stroke()},U.prototype=new o.XC,U.prototype.constructor=U,U.uber=o.XC.prototype,U.prototype.getRenderColor=function(){return o.tU.isFlat?this.isEditable||this.parent.alpha>.5?this.color:o.E5:this.parent.alpha>.25?this.color:o.Cj},U.prototype.getShadowRenderColor=function(){return this.parent.alpha>.25?this.shadowColor:o.EO},_.prototype=new o.$1,_.prototype.constructor=_,_.uber=o.XC.prototype,_.prototype.getRenderColor=U.prototype.getRenderColor,_.prototype.getShadowRenderColor=U.prototype.getShadowRenderColor,G.prototype=new j,G.prototype.constructor=G,G.uber=j.prototype,G.prototype.init=function(t){var e=new D;this.labelString=t||"",e.isDraggable=!1,e.isTemplate=!0,void 0!==o.qz.objects?(e.color=y.prototype.blockColor.variables,e.category="variables"):(e.color=new o.Il(243,118,29),e.category=null),e.setSpec(this.labelString),e.selector="reportGetVar",G.uber.init.call(this),this.add(e),this.fixLayout(),this.isDraggable=!1,this.isStatic=!0},G.prototype.getSpec=function(){return"%t"},G.prototype.template=function(){return this.children[0]},G.prototype.contents=function(){return this.template().blockSpec},G.prototype.setContents=function(t){var e=this.template();e.setSpec(t),e.fixBlockColor(),e.fixLabelColor()},G.prototype.evaluate=function(){return this.contents()},G.prototype.fixLayout=function(){var t=this.template();this.bounds.setExtent(t.extent().add(2*this.edge+2)),t.setPosition(this.position().add(this.edge+1)),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},G.prototype.wantsDropOf=function(t){return"reportGetVar"===t.selector},G.prototype.reactToDropOf=function(t){"reportGetVar"===t.selector&&t.destroy()},G.prototype.render=function(t){this.parent instanceof o._V&&(this.color=this.parent.color.copy()),A.prototype.render.call(this,t)},G.prototype.outlinePath=D.prototype.outlinePathOval,G.prototype.outlinePath=D.prototype.outlinePathOval,G.prototype.drawEdges=D.prototype.drawEdgesOval,G.prototype.hasLocationPin=function(){return!1},G.prototype.cSlots=function(){return[]},G.prototype.flash=function(){this.template().flash()},G.prototype.unflash=function(){this.template().unflash()},q.prototype=new j,q.prototype.constructor=q,q.uber=j.prototype,q.prototype.isTernary=!1,q.prototype.init=function(t){this.value="boolean"==typeof t?t:null,this.isUnevaluated=!1,this.progress=0,q.uber.init.call(this),this.alpha=1,this.fixLayout()},q.prototype.getSpec=function(){return this.isUnevaluated?"%boolUE":"%b"},q.prototype.evaluate=function(){return this.value},q.prototype.isEmptySlot=function(){return null===this.value},q.prototype.isBinary=function(){return!this.isTernary&&(0,o.kK)(this.parentThatIsA(O))&&!(0,o.kK)(this.parentThatIsA(N))},q.prototype.setContents=function(t){this.value="boolean"==typeof t?t:null,this.rerender()},q.prototype.toggleValue=function(){var t,e=this.selectForEdit();if(e!==this)return this.toggleValue.call(e);t=this.parentThatIsA(Kt),this.value=this.nextValue(),!t||t.isAnimating?(this.progress=3,this.rerender(),this.nextSteps([()=>{this.progress=2,this.rerender()},()=>{this.progress=1,this.rerender()},()=>{this.progress=0,this.rerender()}])):this.rerender()},q.prototype.nextValue=function(){if(this.isStatic||this.isBinary())return!this.value;switch(this.value){case!0:return!1;case!1:return null;default:return!0}},q.prototype.mouseClickLeft=function(){this.toggleValue(),(0,o.kK)(this.value)||this.reactToSliderEdit()},q.prototype.mouseEnter=function(){this.isStatic||(null===this.nextValue()?this.progress=-1:this.progress=1,this.rerender())},q.prototype.mouseLeave=function(){this.isStatic||(this.progress=0,this.rerender())},q.prototype.userMenu=function(){var t=new o.wR(this);return b.prototype.enableCodeMapping?(!0===this.evaluate()?t.addItem("code true mapping...","mapTrueToCode"):t.addItem("code false mapping...","mapFalseToCode"),t):this.parent.userMenu()},q.prototype.mapTrueToCode=function(){new lt(this,(t=>b.prototype.codeMappings.true=t),this).promptCode("Code mapping - true",b.prototype.codeMappings.true||"true",this.world())},q.prototype.mapFalseToCode=function(){new lt(this,(t=>b.prototype.codeMappings.false=t),this).promptCode("Code mapping - false",b.prototype.codeMappings.false||"false",this.world())},q.prototype.mappedCode=function(){return!0===this.evaluate()?b.prototype.codeMappings.boolTrue||"true":b.prototype.codeMappings.boolFalse||"false"},q.prototype.fixLayout=function(){var t,e;this.isStatic?(e=(t=this.textLabelExtent()).y+3*this.edge,this.bounds.setWidth(t.x+1.5*e+2*this.edge),this.bounds.setHeight(e)):(this.bounds.setWidth(2*(this.fontSize+2*this.edge)),this.bounds.setHeight(this.fontSize+2*this.edge))},q.prototype.render=function(t){this.cachedNormalColor||(this.color=this.parent?this.parent.color:new o.Il(200,200,200)),this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),this.drawDiamond(t,this.progress),this.drawLabel(t),this.drawKnob(t,this.progress)},q.prototype.drawDiamond=function(t,e){var i,s=this.width(),r=this.height(),n=r/2,a=s/2,h=this.edge/2;if(this.cachedNormalColor)t.fillStyle=this.color.toString();else if(e<0)t.fillStyle=this.color.darker(25).toString();else switch(this.value){case!0:t.fillStyle="rgb(0, 200, 0)";break;case!1:t.fillStyle="rgb(200, 0, 0)";break;default:t.fillStyle=this.color.darker(25).toString()}e>0&&!this.isEmptySlot()?(t.fillStyle="rgb(0, 200, 0)",t.beginPath(),t.moveTo(0,n),t.lineTo(n,0),t.lineTo(a,0),t.lineTo(a,r),t.lineTo(n,r),t.closePath(),t.fill(),t.fillStyle="rgb(200, 0, 0)",t.beginPath(),t.moveTo(a,0),t.lineTo(s-n,0),t.lineTo(s,n),t.lineTo(s-n,r),t.lineTo(a,r),t.closePath(),t.fill()):(t.beginPath(),t.moveTo(0,n),t.lineTo(n,0),t.lineTo(s-n,0),t.lineTo(s,n),t.lineTo(s-n,r),t.lineTo(n,r),t.closePath(),t.fill()),o.tU.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",o.A3&&(t.shadowOffsetX=h,t.shadowBlur=h,t.shadowColor="black"),(i=t.createLinearGradient(0,n,.6*this.edge,n+.6*this.edge)).addColorStop(1,this.cachedClrDark),i.addColorStop(0,this.cachedClr),t.strokeStyle=i,t.beginPath(),t.moveTo(h,n),t.lineTo(n,h),t.closePath(),t.stroke(),o.A3&&(t.shadowOffsetX=0,t.shadowOffsetY=h,t.shadowBlur=this.edge),(i=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),i.addColorStop(0,this.cachedClr),t.strokeStyle=i,t.beginPath(),t.moveTo(n,h),t.lineTo(s-n,h),t.closePath(),t.stroke(),t.shadowOffsetY=0,t.shadowBlur=0,(i=t.createLinearGradient(s-n-.6*this.edge,r-.6*this.edge,s-n,r)).addColorStop(1,this.cachedClr),i.addColorStop(0,this.cachedClrBright),t.strokeStyle=i,t.beginPath(),t.moveTo(s-n,r-h),t.lineTo(s-h,n),t.closePath(),t.stroke(),(i=t.createLinearGradient(0,r-this.edge,0,r)).addColorStop(1,this.cachedClr),i.addColorStop(0,this.cachedClrBright),t.strokeStyle=i,t.beginPath(),t.moveTo(n,r-h),t.lineTo(s-n-h,r-h),t.closePath(),t.stroke())},q.prototype.drawLabel=function(t){var e,i,s=this.width(),r=this.height()/2-this.edge,n=r/2,a=this.edge/2,h=this.height()/2;if(!(this.isEmptySlot()||this.progress<0)){if(this.isStatic)return e=this.textLabelExtent(),h=this.height()-(this.height()-e.y)/2,i=this.value?this.height()/2:this.width()-this.height()/2-e.x,t.save(),!o.tU.isFlat&&o.A3&&(t.shadowOffsetX=-a,t.shadowOffsetY=-a,t.shadowBlur=a,t.shadowColor=this.value?"rgb(0, 100, 0)":"rgb(100, 0, 0)"),t.font=new o.XC(null,this.fontSize,null,!0).font(),t.textAlign="left",t.textBaseline="bottom",t.fillStyle="rgb(255, 255, 255",t.fillText((0,o.NC)(this.value?"true":"false"),i,h),void t.restore();i=r+2*this.edge+a,!o.tU.isFlat&&o.A3&&(t.shadowOffsetX=-a,t.shadowOffsetY=-a,t.shadowBlur=a,t.shadowColor="rgb(0, 100, 0)"),t.strokeStyle="white",t.lineWidth=this.edge+a,t.lineCap="round",t.lineJoin="miter",t.beginPath(),t.moveTo(i-n,h),t.lineTo(i,h+n),t.lineTo(i+n,n+this.edge),t.stroke(),i=s-h-2*this.edge,!o.tU.isFlat&&o.A3&&(t.shadowOffsetX=-a,t.shadowOffsetY=-a,t.shadowBlur=a,t.shadowColor="rgb(100, 0, 0)"),t.strokeStyle="white",t.lineWidth=this.edge,t.lineCap="butt",t.beginPath(),t.moveTo(i-n,h-n),t.lineTo(i+n,h+n),t.moveTo(i-n,h+n),t.lineTo(i+n,h-n),t.stroke()}},q.prototype.drawKnob=function(t,e){var i,s,r=this.width(),n=this.height()/2,a=this.edge/2,h=(this.width()-this.height())/4*Math.max(0,e||0),l=n,p=st.prototype.outline/2,c=st.prototype.outlineColor,d=st.prototype.color,u=st.prototype.contrast,f=d.lighter(u),g=d.darker(u);switch(this.value){case!1:s=n+h,!o.tU.isFlat&&o.A3&&(t.shadowOffsetX=a,t.shadowOffsetY=0,t.shadowBlur=a,t.shadowColor="black"),e<0&&(t.globalAlpha=.6);break;case!0:s=r-n-h,o.tU.isFlat||(t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0);break;default:if(!e)return;s=n,!o.tU.isFlat&&o.A3&&(t.shadowOffsetX=a,t.shadowOffsetY=0,t.shadowBlur=a,t.shadowColor="black"),t.globalAlpha=.6}t.fillStyle=d.toString(),t.beginPath(),t.arc(s,l,n,(0,o.uR)(0),(0,o.uR)(360)),t.closePath(),t.fill(),o.tU.isFlat?t.globalAlpha=1:(t.shadowOffsetX=0,t.shadowBlur=0,t.shadowColor="black",t.lineWidth=p,t.strokeStyle=c.toString(),t.beginPath(),t.arc(s,l,n-p/2,(0,o.uR)(0),(0,o.uR)(360)),t.stroke(),n<p+this.edge||((i=t.createRadialGradient(s,l,n-p-this.edge,s,l,n-p)).addColorStop(1,f.toString()),i.addColorStop(0,d.toString()),t.strokeStyle=i,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(s,l,n-p-this.edge/2,(0,o.uR)(180),(0,o.uR)(270),!1),t.stroke(),(i=t.createRadialGradient(s,l,n-p-this.edge,s,l,n-p)).addColorStop(1,g.toString()),i.addColorStop(0,d.toString()),t.strokeStyle=i,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(s,l,n-p-this.edge/2,(0,o.uR)(0),(0,o.uR)(90),!1),t.stroke(),t.globalAlpha=1))},q.prototype.textLabelExtent=function(){var t,e;return t=new o.XC((0,o.NC)("true"),this.fontSize,null,!0),e=new o.XC((0,o.NC)("false"),this.fontSize,null,!0),new o.E9(Math.max(t.width(),e.width()),t.height())},Y.prototype=new o._V,Y.prototype.constructor=Y,Y.uber=o._V.prototype,Y.prototype.init=function(t,e,i,s,r){this.direction=t||"down",this.size=e||(0===e?0:50),this.padding=i||0,this.isBlockLabel=r||!1,Y.uber.init.call(this),this.color=s||o.E5,this.bounds.setWidth(this.size),this.bounds.setHeight(this.size),this.rerender()},Y.prototype.setSize=function(t){var e=Math.max(t,1);this.size=t,this.changed(),this.bounds.setWidth(e),this.bounds.setHeight(e),this.rerender()},Y.prototype.render=function(t){var e=this.padding,o=this.height(),i=Math.floor(o/2),s=this.width(),r=Math.floor(s/2);t.fillStyle=this.getRenderColor().toString(),t.beginPath(),"down"===this.direction?(t.moveTo(e,i),t.lineTo(s-e,i),t.lineTo(r,o-e)):"up"===this.direction?(t.moveTo(e,i),t.lineTo(s-e,i),t.lineTo(r,e)):"left"===this.direction?(t.moveTo(e,i),t.lineTo(r,e),t.lineTo(r,o-e)):(t.moveTo(r,e),t.lineTo(s-e,i),t.lineTo(r,o-e)),t.closePath(),t.fill()},Y.prototype.getRenderColor=function(){return this.isBlockLabel?o.tU.isFlat||I.prototype.alpha>.5?this.color:o.Cj:this.color},K.prototype=new H,K.prototype.constructor=K,K.uber=H.prototype,K.prototype.init=function(t,e,i,s){var r=new _(""),n=new Y("down",0,Math.max(Math.floor(this.fontSize/6),1),o.E5,!0);r.fontSize=this.fontSize,r.fixLayout(),this.isUnevaluated=!1,this.choices=i||null,this.oldContentsExtent=r.extent(),this.isNumeric=e||!1,this.isReadOnly=s||!1,this.minWidth=0,this.constant=null,H.uber.init.call(this,null,null,null,null,!0),this.color=o.Cj,this.add(r),this.add(n),r.isEditable=!0,r.isDraggable=!1,r.enableSelecting(),this.setContents(t)},K.prototype.getSpec=function(){return this.isNumeric,"%mlt"},K.prototype.contents=function(){return(0,o.qY)(this.children,(t=>t instanceof o.$1))},K.prototype.layoutChanged=function(){this.fixLayout()},X.prototype=new j,X.prototype.constructor=X,X.uber=j.prototype,X.prototype.init=function(t){X.uber.init.call(this),this.alpha=1,this.setColor(t||new o.Il(145,26,68))},X.prototype.getSpec=function(){return"%clr"},X.prototype.getUserColor=function(){var t=this,e=this.world(),i=e.hand,s=(0,o.eg)(e.worldCanvas),r=i.processMouseMove,n=i.processMouseDown,a=i.processMouseUp,h=new o.kX(null,new o.E9(16*this.fontSize,10*this.fontSize));e.add(h),h.setPosition(this.bottomLeft().add(new o.E9(0,this.edge))),i.processMouseMove=function(r){var n=e.getGlobalPixelColor(i.position());i.setPosition(new o.E9(r.pageX-s.x,r.pageY-s.y)),n.a&&t.setColor(n)},i.processMouseDown=o.WY,i.processMouseUp=function(){h.destroy(),i.processMouseMove=r,i.processMouseDown=n,i.processMouseUp=a}},X.prototype.mouseClickLeft=function(){this.selectForEdit().getUserColor()},X.prototype.evaluate=function(){return this.color},X.prototype.fixLayout=function(){var t=this.fontSize+2*this.edge+2*this.typeInPadding;this.bounds.setWidth(t),this.bounds.setHeight(t)},X.prototype.render=function(t){var e;e=this.parent?this.parent.color:new o.Il(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),o.tU.isFlat||this.drawRectBorder(t)},X.prototype.drawRectBorder=H.prototype.drawRectBorder,J.prototype=new o._V,J.prototype.constructor=J,J.uber=o._V.prototype,J.prototype.init=function(){J.uber.init.call(this),this.isCachingImage=!0},J.prototype.readout=function(){return this.children.length?this.children[0]:null},J.prototype.updateReadout=function(){var t=this.readout(),e=o.A3&&!o.tU.isFlat?.4*I.prototype.activeBlur:-2*I.prototype.activeBorder;this.threadCount<2?t&&t.destroy():(t?(t.changed(),t.contents=this.threadCount.toString(),t.fixLayout(),t.rerender()):(t=new o.KE(this.threadCount.toString(),this.color,null,null,this.color.darker(),null,1,!0),this.add(t)),t.setPosition(this.position().add(e)))},Z.prototype=new j,Z.prototype.constructor=Z,Z.uber=j.prototype,Z.prototype.init=function(t,e,i,s,r,n,a,h,l){var p,c,d,u,f=new o.xZ;for(this.slotSpec=t||"%s",this.labelText=(0,o.NC)(e||""),this.minInputs=i||0,this.elementSpec=s||null,this.labelColor=n||null,this.shadowColor=a||null,this.shadowOffset=h||null,this.canBeEmpty=!0,Z.uber.init.call(this),this.alpha=!1===l?1:0,f.alpha=!1===l?1:0,(this.labelText||"%cs"===this.slotSpec)&&(p=this.labelPart(this.labelText),this.add(p),p.hide()),c=new Y("left",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),r,!0),d=new Y("right",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),r,!0),f.add(c),f.add(d),f.rerender(),f.acceptsDrops=!1,this.add(f),u=0;u<this.minInputs;u+=1)this.addInput()},Z.prototype.label=function(){return this.labelText?this.children[0]:null},Z.prototype.arrows=function(){return this.children[this.children.length-1]},Z.prototype.getSpec=function(){return"%mult"+this.slotSpec},Z.prototype.setContents=function(t){var e,o=this.inputs();for(e=0;e<t.length;e+=1)null!==t[e]&&o[e]&&o[e].setContents(t[e])},Z.prototype.hide=function(){this.isVisible=!1,this.changed()},Z.prototype.show=function(){this.isVisible=!0,this.changed()},Z.prototype.setLabelColor=function(t,e,o){this.textColor=t,this.shadowColor=e,this.shadowOffset=o,Z.uber.setLabelColor.call(this,t,e,o)},Z.prototype.fixLayout=function(){var t,e,o;"%t"===this.slotSpec&&(this.isStatic=!0),this.parent&&(t=this.label(),this.color=this.parent.color,this.arrows().color=this.color,t&&(e=this.shadowColor||this.parent.color.darker(this.labelContrast),o=this.shadowOffset||(t?t.shadowOffset:null),t.shadowColor.eq(e)||(t.shadowColor=e,t.shadowOffset=o,t.fixLayout(),t.rerender()))),this.fixArrowsLayout(),Z.uber.fixLayout.call(this),this.parent&&this.parent.fixLayout()},Z.prototype.fixArrowsLayout=function(){var t=this.label(),e=this.arrows(),i=e.children[0],s=e.children[1],r=this.inputs().length,n=new o.E9(s.width()/2,s.height());r<this.minInputs+1?(t&&t.hide(),i.hide(),s.setPosition(e.position().subtract(new o.E9(n.x,0))),e.setExtent(n)):this.is3ArgRingInHOF()&&r>2?(s.hide(),e.setExtent(n)):(t&&t.show(),i.show(),s.show(),s.setPosition(i.topCenter()),e.bounds.corner=s.bottomRight().copy()),e.rerender()},Z.prototype.fixHolesLayout=function(){var t;this.holes=[],"%cs"===this.slotSpec&&(t=this.position(),this.inputs().forEach((e=>{e instanceof z&&(e.fixHolesLayout(),this.holes.push(e.holes[0].translateBy(e.position().subtract(t))))})))},Z.prototype.refresh=function(){this.inputs().forEach((t=>{t.fixLayout(),t.rerender()}))},Z.prototype.addInput=function(t){var e,i,s=this.labelPart(this.slotSpec),r=this.children.length-1;if(t)s.setContents(t);else if("%scriptVars"===this.elementSpec||"%blockVars"===this.elementSpec){for(i="",e=r,"%scriptVars"===this.elementSpec&&(e+=1);e>0;)i=String.fromCharCode(97+(e-1)%26)+i,e=Math.floor((e-1)/26);s.setContents(i)}else(0,o.r3)(["%parms","%ringparms"],this.elementSpec)&&(this.is3ArgRingInHOF()&&r<4?s.setContents([(0,o.NC)("value"),(0,o.NC)("index"),(0,o.NC)("list")][r-1]):s.setContents("#"+r));return s.parent=this,this.children.splice(r,0,s),s.fixLayout(),this.fixLayout(),s},Z.prototype.removeInput=function(){var t,e;this.children.length>1&&(t=this.children[this.children.length-2],this.removeChild(t),!(t instanceof A)||t instanceof O&&!t.contents()||(e=this.parentThatIsA(N))&&e.add(t)),this.fixLayout()},Z.prototype.is3ArgRingInHOF=function(){var t,e=this.parent;return!!(e&&(t=e.parent)instanceof D)&&t.inputs()[0]===e&&(0,o.r3)(["reportMap","reportAtomicMap","reportKeep","reportAtomicKeep","reportFindFirst","reportAtomicFindFirst"],t.selector)},Z.prototype.mouseClickLeft=function(t){if(this.parentThatIsA(N)){var e,o=this.selectForEdit(),i=o.arrows(),s=i.children[0],r=i.children[1],n=16===o.world().currentKey?3:1;if(r.bounds.containsPoint(t))for(e=0;e<n;e+=1)r.isVisible&&o.addInput();else if(s.bounds.expandBy(this.fontSize/3).containsPoint(t))for(e=0;e<n;e+=1)s.isVisible&&o.removeInput();else o.escalateEvent("mouseClickLeft",t)}else this.escalateEvent("mouseClickLeft",t)},Z.prototype.userMenu=function(){var t=new o.wR(this),e=this.parentThatIsA(A),i="";return b.prototype.enableCodeMapping?(e&&(e instanceof O?i="parms_":"doDeclareVariables"===e.selector&&(i="tempvars_")),t.addItem("code list mapping...",(()=>this.mapCodeList(i))),t.addItem("code item mapping...",(()=>this.mapCodeItem(i))),t.addItem("code delimiter mapping...",(()=>this.mapCodeDelimiter(i))),t):this.parent.userMenu()},Z.prototype.mapCodeDelimiter=function(t){this.mapToCode(t+"delim","list item delimiter")},Z.prototype.mapCodeList=function(t){this.mapToCode(t+"list","list contents <#1>")},Z.prototype.mapCodeItem=function(t){this.mapToCode(t+"item","list item <#1>")},Z.prototype.mapToCode=function(t,e){new lt(this,(e=>b.prototype.codeMappings[t]=e),this).promptCode("Code mapping - "+e,b.prototype.codeMappings[t]||"",this.world())},Z.prototype.mappedCode=function(t){var e,o,i,s=this.parentThatIsA(A),r="",n="",a=0,h=[];return s&&(s instanceof O?r="parms_":"doDeclareVariables"===s.selector&&(r="tempvars_")),e=b.prototype.codeMappings[r+"list"]||"<#1>",o=b.prototype.codeMappings[r+"item"]||"<#1>",i=b.prototype.codeMappings[r+"delim"]||" ",this.inputs().forEach((e=>h.push(o.replace(/<#1>/g,e.mappedCode(t))))),h.forEach((t=>{a&&(n+=i),n+=t,a+=1})),e.replace(/<#1>/g,n)},Z.prototype.evaluate=function(){var t=[];return this.inputs().forEach((e=>t.push(e.evaluate()))),t},Z.prototype.isEmptySlot=function(){return!!this.canBeEmpty&&0===this.inputs().length},$.prototype=new j,$.prototype.constructor=$,$.uber=j.prototype,$.prototype.init=function(t,e){var i;this.labelText=(0,o.NC)(e||"input list:"),$.uber.init.call(this),this.isStatic=!0,this.alpha=0,i=this.labelPart(this.labelText),this.add(i),this.add(t)},$.prototype.label=function(){return this.children[0]},$.prototype.argMorph=function(){return this.children[1]},$.prototype.fixLayout=function(){var t,e,i=this.label();this.parent&&(this.color=this.parent.color,t=(e=i.shadowOffset||o.xE).x<0?this.parent.color.darker(this.labelContrast):this.parent.color.lighter(this.labelContrast),""!==this.labelText&&(i.shadowColor.eq(t)||(i.shadowColor=t,i.shadowOffset=e,i.rerender()))),$.uber.fixLayout.call(this),this.parent&&this.parent.fixLayout()},$.prototype.refresh=function(){this.inputs().forEach((t=>{t.fixLayout(),t.rerender()}))},$.prototype.setLabelColor=function(t,e,o){if(""!==this.labelText){var i=this.label();i.color=t,i.shadowColor=e,i.shadowOffset=o,i.rerender()}},$.prototype.reactToGrabOf=function(){this.parent instanceof I&&this.parent.revertToDefaultInput(this)},$.prototype.evaluate=function(){return this.argMorph().evaluate()},$.prototype.isEmptySlot=function(){return!1},Q.prototype=new j,Q.prototype.constructor=Q,Q.uber=j.prototype,Q.prototype.init=function(t){Q.uber.init.call(this),this.isPredicate=t||!1,this.color=this.rfColor},Q.prototype.getSpec=function(){return"%f"},Q.prototype.render=function(t){var e;e=this.parent?this.parent.color:new o.Il(120,120,120),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),this.isPredicate?this.drawDiamond(t):this.drawRounded(t)},Q.prototype.drawRounded=function(t){var e,i=this.height(),s=Math.min(this.rounding,i/2),r=this.width(),n=this.edge/2;t.fillStyle=this.color.toString(),t.beginPath(),t.arc(s,s,s,(0,o.uR)(-180),(0,o.uR)(-90),!1),t.arc(r-s,s,s,(0,o.uR)(-90),(0,o.uR)(-0),!1),t.arc(r-s,i-s,s,(0,o.uR)(0),(0,o.uR)(90),!1),t.arc(s,i-s,s,(0,o.uR)(90),(0,o.uR)(180),!1),t.closePath(),t.fill(),o.tU.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(s,i-s,s-n,(0,o.uR)(90),(0,o.uR)(180),!1),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(r-s,s,s-n,(0,o.uR)(-90),(0,o.uR)(0),!1),t.stroke(),o.A3&&(t.shadowOffsetX=n,t.shadowOffsetY=n,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString()),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(s-n,n),t.lineTo(r-s+n,n),t.stroke(),(e=t.createRadialGradient(s,s,s-this.edge,s,s,s)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(s,s,s-n,(0,o.uR)(180),(0,o.uR)(270),!1),t.stroke(),(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,s),t.lineTo(n,i-s),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createRadialGradient(r-s,i-s,s-this.edge,r-s,i-s,s)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(r-s,i-s,s-n,(0,o.uR)(0),(0,o.uR)(90),!1),t.stroke(),(e=t.createLinearGradient(0,i-this.edge,0,i)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(s-n,i-n),t.lineTo(r-s+n,i-n),t.stroke(),(e=t.createLinearGradient(r-this.edge,0,r,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,s+n),t.lineTo(r-n,i-s),t.stroke())},Q.prototype.drawDiamond=function(t){var e,i=this.width(),s=this.height(),r=Math.floor(s/2),n=Math.min(this.rounding,r),a=this.edge/2;t.fillStyle=this.color.toString(),t.beginPath(),t.moveTo(0,r),t.lineTo(n,0),t.lineTo(i-n,0),t.lineTo(i,r),t.lineTo(i-n,s),t.lineTo(n,s),t.closePath(),t.fill(),o.tU.isFlat||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(a,r),t.lineTo(n,s-a),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(i-a,r),t.lineTo(i-n,a),t.stroke(),o.A3&&(t.shadowOffsetX=a,t.shadowOffsetY=a,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString()),(e=t.createLinearGradient(0,0,n,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(a,r),t.lineTo(n,a),t.stroke(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,a),t.lineTo(i-n,a),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(i-n,0,i,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,s-a),t.lineTo(i-a,r),t.stroke(),(e=t.createLinearGradient(0,s-this.edge,0,s)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(n+a,s-a),t.lineTo(i-n-a,s-a),t.stroke())},tt.prototype=new Q,tt.prototype.constructor=tt,tt.uber=Q.prototype,tt.prototype.init=function(t){tt.uber.init.call(this,t,!0),this.add(this.emptySlot()),this.fixLayout()},tt.prototype.emptySlot=function(){var t=new j,e=2*this.rfBorder+2*this.edge;return t.color=this.rfColor,t.alpha=0,t.bounds.setExtent(new o.E9(2*(this.fontSize+2*this.edge)-e,this.fontSize+2*this.edge-e)),t},tt.prototype.getSpec=function(){return"%r"},tt.prototype.contents=function(){return this.children[0]},tt.prototype.nestedBlock=function(){var t=this.contents();return t instanceof D?t:null},tt.prototype.evaluate=function(){return this.nestedBlock()},tt.prototype.isEmptySlot=function(){return null===this.nestedBlock()},tt.prototype.fixLayout=function(){var t=this.contents();this.bounds.setExtent(t.extent().add(2*this.edge+2*this.rfBorder)),t.setCenter(this.center()),this.parent&&this.parent.fixLayout&&this.parent.fixLayout()},et.prototype=new tt,et.prototype.constructor=et,et.uber=tt.prototype,et.prototype.rfBorder=W.prototype.rfBorder,et.prototype.edge=W.prototype.edge,et.prototype.enableCommandDrops=!0,et.prototype.init=function(t){et.uber.init.call(this,t,!0),this.contrast=O.prototype.contrast},et.prototype.getSpec=function(){return"%rr"},et.prototype.replaceInput=function(t,e,o){et.uber.replaceInput.call(this,t,e),this.parent instanceof O&&!o&&this.parent.vanishForSimilar()},et.prototype.slotAttachPoint=V.prototype.slotAttachPoint,et.prototype.dentLeft=V.prototype.dentLeft,et.prototype.dentCenter=V.prototype.dentCenter,et.prototype.attachTargets=function(){return!et.prototype.enableCommandDrops||this.contents()instanceof D?[]:V.prototype.attachTargets.call(this)},et.prototype.nestedBlock=function(t){if(!t)return(0,o.qY)(this.children,(t=>t instanceof A));var e=this.nestedBlock();this.replaceInput(this.children[0],t),e&&t.bottomBlock().nextBlock(e),this.fixLayout()},et.prototype.fixLayout=function(){this.contents()instanceof R?V.prototype.fixLayout.call(this):et.uber.fixLayout.call(this)},et.prototype.render=function(t){o.tU.isFlat||(this.cachedClr=this.color.toString(),this.cachedClrBright=this.bright(),this.cachedClrDark=this.dark(),t.fillStyle=this.cachedClr,this.isPredicate?this.drawEdgesDiamond(t):this.drawEdgesOval(t))},et.prototype.outlinePath=function(t,e){this.isPredicate?this.outlinePathDiamond(t,e):this.outlinePathOval(t,e)},et.prototype.outlinePathOval=function(t,e){var i=e.x,s=e.y,r=this.width(),n=this.height(),a=Math.min(this.rounding,n/2);t.arc(a+this.edge+i,a+this.edge+s,a,(0,o.uR)(-180),(0,o.uR)(-90),!1),t.arc(r-a-this.edge+i,a+this.edge+s,a,(0,o.uR)(-90),(0,o.uR)(-0),!1),t.arc(r-a-this.edge+i,n-a-this.edge+s,a,(0,o.uR)(0),(0,o.uR)(90),!1),t.arc(a+this.edge+i,n-a-this.edge+s,a,(0,o.uR)(90),(0,o.uR)(180),!1),t.lineTo(this.edge+i,a+this.edge+s)},et.prototype.drawEdgesOval=function(t){var e,i=this.height(),s=Math.min(this.rounding,i/2),r=this.width(),n=this.edge/2;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(s,i-s,s-n,(0,o.uR)(90),(0,o.uR)(180),!1),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.arc(r-s,s,s-n,(0,o.uR)(-90),(0,o.uR)(0),!1),t.stroke(),o.A3&&(t.shadowOffsetX=n,t.shadowOffsetY=n,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString()),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(s-n,n),t.lineTo(r-s+n,n),t.stroke(),(e=t.createRadialGradient(s,s,s-this.edge,s,s,s)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.arc(s,s,s-n,(0,o.uR)(180),(0,o.uR)(270),!1),t.stroke(),(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,s),t.lineTo(n,i-s),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createRadialGradient(r-s,i-s,s-this.edge,r-s,i-s,s)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.arc(r-s,i-s,s-n,(0,o.uR)(0),(0,o.uR)(90),!1),t.stroke(),(e=t.createLinearGradient(0,i-this.edge,0,i)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(s-n,i-n),t.lineTo(r-s+n,i-n),t.stroke(),(e=t.createLinearGradient(r-this.edge,0,r,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(r-n,s+n),t.lineTo(r-n,i-s),t.stroke()},et.prototype.outlinePathDiamond=function(t,e){var o=e.x,i=e.y,s=this.width(),r=this.height(),n=Math.floor(r/2),a=Math.min(this.rounding,n);t.moveTo(o+this.edge,n+i),t.lineTo(a+this.edge+o,this.edge+i),t.lineTo(s-a-this.edge+o,this.edge+i),t.lineTo(s-this.edge+o,n+i),t.lineTo(s-a-this.edge+o,r-this.edge+i),t.lineTo(a+this.edge+o,r-this.edge+i),t.lineTo(o+this.edge,n+i)},et.prototype.drawEdgesDiamond=function(t){var e,i=this.width(),s=this.height(),r=Math.floor(s/2),n=Math.min(this.rounding,r),a=this.edge/2;t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(a,r),t.lineTo(n,s-a),t.stroke(),t.strokeStyle=this.cachedClr,t.beginPath(),t.moveTo(i-a,r),t.lineTo(i-n,a),t.stroke(),o.A3&&(t.shadowOffsetX=a,t.shadowOffsetY=a,t.shadowBlur=this.edge,t.shadowColor=this.color.darker(80).toString()),(e=t.createLinearGradient(0,0,n,0)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(a,r),t.lineTo(n,a),t.stroke(),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(1,this.cachedClrDark),e.addColorStop(0,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(n,a),t.lineTo(i-n,a),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(i-n,0,i,0)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(i-n,s-a),t.lineTo(i-a,r),t.stroke(),(e=t.createLinearGradient(0,s-this.edge,0,s)).addColorStop(1,this.cachedClr),e.addColorStop(0,this.cachedClrBright),t.strokeStyle=e,t.beginPath(),t.moveTo(n+a,s-a),t.lineTo(i-n-a,s-a),t.stroke()},ot.prototype=new o.RC,ot.prototype.constructor=ot,ot.uber=o.RC.prototype,ot.prototype.refreshScale=function(){ot.prototype.fontSize=I.prototype.fontSize,ot.prototype.padding=5*I.prototype.scale,ot.prototype.rounding=8*I.prototype.scale},ot.prototype.refreshScale(),ot.prototype.init=function(t){var e=I.prototype.scale;this.block=null,this.stickyOffset=null,this.isCollapsed=!1,this.titleBar=new o.RC(this.rounding,e,new o.Il(255,255,180)),this.titleBar.color=new o.Il(255,255,180),this.titleBar.setHeight((0,o.SW)(this.fontSize)+this.padding),this.title=null,this.arrow=new Y("down",this.fontSize),this.arrow.mouseClickLeft=()=>this.toggleExpand(),this.contents=new o.$1(t||(0,o.NC)("add comment here..."),this.fontSize),this.contents.isEditable=!0,this.contents.enableSelecting(),this.contents.maxWidth=90*e,this.contents.fixLayout(),this.handle=new o.LG(this.contents,80,2*this.fontSize,-2,-2),this.handle.setExtent(new o.E9(11*e,11*e)),this.anchor=null,ot.uber.init.call(this,this.rounding,e,new o.Il(255,255,180)),this.color=new o.Il(255,255,220),this.isDraggable=!0,this.add(this.titleBar),this.add(this.arrow),this.add(this.contents),this.add(this.handle),this.fixLayout()},ot.prototype.fullCopy=function(){var t=new ot(this.contents.text);return t.isCollapsed=this.isCollapsed,t.setTextWidth(this.textWidth()),this.selectionID&&(t.selectionID=!0),t},ot.prototype.setTextWidth=function(t){this.contents.maxWidth=t,this.contents.fixLayout(),this.fixLayout()},ot.prototype.textWidth=function(){return this.contents.maxWidth},ot.prototype.text=function(){return this.contents.text},ot.prototype.toggleExpand=function(){this.isCollapsed=!this.isCollapsed,this.fixLayout(),this.align(),this.isCollapsed||this.comeToFront()},ot.prototype.comeToFront=function(){this.parent&&(this.parent.add(this),this.changed())},ot.prototype.mouseClickLeft=function(){this.comeToFront()},ot.prototype.layoutChanged=function(){this.fixLayout(),this.align(),this.comeToFront()},ot.prototype.fixLayout=function(){var t,e=this.contents.width()+2*this.padding;this.title&&(this.title.destroy(),this.title=null),this.isCollapsed?(this.contents.hide(),this.title=new o.xZ,this.title.alpha=0,this.title.acceptsDrops=!1,(t=new o.XC(this.contents.text,this.fontSize,null,!0)).rootForGrab=()=>this,this.title.add(t),this.title.setHeight(t.height()),this.title.setWidth(e-this.arrow.width()-2*this.padding-this.rounding),this.add(this.title)):this.contents.show(),this.titleBar.setWidth(e),this.contents.setLeft(this.titleBar.left()+this.padding),this.contents.setTop(this.titleBar.bottom()+this.padding),this.arrow.direction=this.isCollapsed?"right":"down",this.arrow.rerender(),this.arrow.setCenter(this.titleBar.center()),this.arrow.setLeft(this.titleBar.left()+this.padding),this.title&&this.title.setPosition(this.arrow.topRight().add(new o.E9(this.padding,0))),this.changed(),this.bounds.setHeight(this.titleBar.height()+(this.isCollapsed?0:this.padding+this.contents.height()+this.padding)),this.bounds.setWidth(this.titleBar.width()),this.rerender(),this.handle.fixLayout()},ot.prototype.userMenu=function(){var t=new o.wR(this);return t.addItem("duplicate",(()=>{var t=this.fullCopy(),e=this.parentThatIsA(Kt),o=this.parentThatIsA(BlockEditorMorph),i=this.world();t.pickUp(i),!e&&o&&(e=o.target.parentThatIsA(Kt)),e&&(i.hand.grabOrigin={origin:e.palette,position:e.palette.center()})}),"make a copy\nand pick it up"),t.addItem("delete","userDestroy"),t.addItem("comment pic...",(()=>{var t=this.parentThatIsA(Kt);t.saveCanvasAs(this.fullImage(),(t.projectName||(0,o.NC)("untitled"))+" "+(0,o.NC)("comment pic"))}),"save a picture\nof this comment"),t},ot.prototype.userDestroy=function(){this.selectForEdit().destroy()},ot.prototype.hide=function(){this.isVisible=!1,this.changed()},ot.prototype.show=function(){this.isVisible=!0,this.changed()},ot.prototype.prepareToBeGrabbed=function(t){this.block&&(this.block.comment=null,this.block=null),this.anchor&&(this.anchor.destroy(),this.anchor=null)},ot.prototype.selectForEdit=I.prototype.selectForEdit,ot.prototype.snap=function(t){var e,o=this.parent;if(!(o instanceof N))return null;o.clearDropInfo(),null!==(e=o.closestBlock(this,t))&&(e.comment=this,this.block=e,this.snapSound&&this.snapSound.play(),o.lastDropTarget={element:e}),this.align(),o.lastDroppedBlock=this,t&&o.recordDrop(t.grabOrigin)},ot.prototype.align=function(t,e){if(this.block){var i,s,r,n,a=t||this.block.topBlock(),h=a.parentThatIsA(N);this.setTop(this.block.top()+this.block.corner),s=this.top(),r=this.bottom(),i=a.allChildren().filter((t=>t instanceof A&&t.bottom()>s&&t.top()<r)),n=Math.max.apply(null,i.map((t=>t.right()))),this.setLeft(n+5),!e&&h&&h.addBack(this),this.anchor||(this.anchor=new o._V,this.anchor.color=this.titleBar.color),this.anchor.setPosition(new o.E9(this.block.right(),this.top()+this.edge)),this.anchor.bounds.corner=new o.E9(this.left(),this.top()+this.edge+1),this.anchor.rerender(),this.addBack(this.anchor)}},ot.prototype.startFollowing=function(t,e){this.align(t),e.add(this),this.addShadow(),this.stickyOffset=this.position().subtract(this.block.position()),this.step=()=>{this.block?this.setPosition(this.block.position().add(this.stickyOffset)):this.stopFollowing()}},ot.prototype.stopFollowing=function(){this.removeShadow(),delete this.step},ot.prototype.destroy=function(){this.block&&(this.block.comment=null),ot.uber.destroy.call(this)},ot.prototype.stackHeight=function(){return this.height()},it.prototype=new o.RC,it.prototype.constructor=it,it.uber=o.RC.prototype,it.prototype.init=function(t,e,o){this.editor=t,this.element=e,this.atEnd=!1,it.uber.init.call(this),this.element instanceof N&&this.setPosition(o)},it.prototype.getFocus=function(t){t||(t=this.world()),t&&t.keyboardFocus!==this&&t.stopEditing(),t.keyboardFocus=this,this.fixLayout(),this.editor.updateToolbar()},it.prototype.fixLayout=function(){this.changed(),this.element instanceof R||this.element instanceof V||this.element instanceof N?this.manifestStatement():this.manifestExpression(),this.editor.add(this),this.scrollIntoView(),this.changed()},it.prototype.manifestStatement=function(){var t=this.element instanceof N,e=this.element.top();this.border=0,this.edge=0,this.alpha=1,this.color=this.editor.feedbackColor,this.bounds.setExtent(new o.E9(t?I.prototype.hatWidth:this.element.width(),Math.max(I.prototype.corner,I.prototype.feedbackMinHeight))),this.element instanceof V?e+=I.prototype.corner:this.atEnd&&(e=this.element.bottom()),t||this.setPosition(new o.E9(this.element.left(),e)),this.fps=2,this.show(),this.step=function(){this.toggleVisibility()}},it.prototype.manifestExpression=function(){this.edge=I.prototype.rounding,this.border=Math.max(I.prototype.edge,3),this.color=this.editor.feedbackColor.copy(),this.color.a=.5,this.borderColor=this.editor.feedbackColor,this.bounds=this.element.fullBounds().expandBy(Math.max(2*I.prototype.edge,I.prototype.reporterDropFeedbackPadding)),this.rerender(),delete this.fps,delete this.step,this.show()},it.prototype.trigger=function(){var t=this.element;t instanceof Z?t.arrows().children[1].isVisible&&(t.addInput(),this.fixLayout()):t.parent instanceof G?t.mouseClickLeft():t instanceof q?t.toggleValue():t instanceof H&&(t.isReadOnly?t.choices&&(t.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):(delete this.fps,delete this.step,this.hide(),this.world().onNextStep=()=>{t.contents().edit(),t.contents().selectAll()}))},it.prototype.menu=function(){var t=this.element;t instanceof H&&t.choices?(t.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):this.insertVariableGetter()},it.prototype.deleteLastElement=function(){var t=this.element;t.parent instanceof N?(this.atEnd||t instanceof D)&&(t.destroy(),this.element=this.editor,this.atEnd=!1):t instanceof Z?t.arrows().children[0].isVisible&&t.removeInput():t instanceof q?t.isStatic||t.setContents(null):t instanceof D?t.isTemplate||(this.lastElement(),t.prepareToBeGrabbed(),t.destroy()):t instanceof R&&(this.atEnd?(this.element=t.parent,t.userDestroy()):t.parent instanceof R&&t.parent.userDestroy()),this.editor.adjustBounds(),this.fixLayout()},it.prototype.insertBlock=function(t){this.world().add(t),t.glideTo(this.position(),null,null,(()=>this.fillInBlock(t)))},it.prototype.fillInBlock=function(t){var e,o,i,s;t.isTemplate=!1,t.isDraggable=!0,t.snapSound&&t.snapSound.play(),this.element instanceof N?(this.editor.add(t),this.element=t,t instanceof R?(t.setLeft(this.left()),t.isStop()?t.setTop(this.top()):(t.setBottom(this.top()),this.atEnd=!0)):(t.setCenter(this.center()),t.setLeft(this.left()))):this.element instanceof R?this.atEnd?(this.element.nextBlock(t),this.element=t,this.fixLayout()):(e=this.element.parent)instanceof N?(t.setLeft(this.element.left()),t.setBottom(this.element.top()+this.element.corner),this.editor.add(t),t.nextBlock(this.element),this.fixLayout()):e instanceof V?e.nestedBlock(t):e instanceof et?(t.nextBlock(e.nestedBlock()),e.add(t),e.fixLayout()):e instanceof R&&e.nextBlock(t):this.element instanceof V?(this.element.nestedBlock(t),this.element=t,this.atEnd=!0):((e=this.element.parent)instanceof N?(this.editor.add(t),t.setPosition(this.element.position()),this.element.destroy()):e.replaceInput(this.element,t),this.element=t),t.fixBlockColor(),this.editor.adjustBounds(),this.fixLayout(),"receiveCondition"===t.selector&&(s=this.editor.scriptTarget())&&(o=s.parentThatIsA(b))&&(o.enableCustomHatBlocks=!0,o.threads.pauseCustomHatBlocks=!1,(i=o.parentThatIsA(Kt))&&i.controlBar.stopButton.refresh()),t.inputs&&t.inputs().length&&(this.element=t,this.atEnd=!1,this.nextElement())},it.prototype.insertVariableGetter=function(){var t,e=this.blockTypes(),i=new o.wR;e&&(0,o.r3)(e,"reporter")&&(t=H.prototype.getVarNamesDict.call(this.element),Object.keys(t).forEach((t=>{var e=y.prototype.variableBlock(t);e.addShadow(new o.E9(3,3)),i.addItem(e,(()=>{e.removeShadow(),this.insertBlock(e)}))})),i.items.length>0&&(i.popup(this.world(),this.element.bottomLeft()),i.getFocus()))},it.prototype.stopEditing=function(){this.editor.focus=null,this.editor.updateToolbar(),this.world().keyboardFocus=null,this.destroy()},it.prototype.lastElement=function(){var t,e=this.items();e.length?(this.atEnd?(this.element=e[e.length-1],this.atEnd=!1):((t=e.indexOf(this.element)-1)<0&&(t=e.length-1),this.element=e[t]),this.element instanceof V&&this.element.nestedBlock()?this.lastElement():this.element instanceof F&&(e.length>1?this.lastElement():this.atEnd=!0),this.fixLayout()):this.shiftScript(new o.E9(-50,0))},it.prototype.nextElement=function(){var t,e,i=this.items();i.length?((t=i.indexOf(this.element)+1)>=i.length&&(t=0),this.atEnd=!1,this.element=i[t],this.element instanceof V?(e=this.element.nestedBlock())&&(this.element=e):this.element instanceof F&&(1===i.length?this.atEnd=!0:this.nextElement()),this.fixLayout()):this.shiftScript(new o.E9(50,0))},it.prototype.lastCommand=function(){var t,e=this.element.parentThatIsA(R);e?(this.element instanceof R?this.atEnd?this.atEnd=!1:(t=e.parent.parentThatIsA(R))?this.element=t:(t=e.topBlock().bottomBlock())&&(this.element=t,this.atEnd=!0):(this.element=e,this.atEnd=!1),this.element instanceof F&&!this.atEnd&&this.lastCommand(),this.fixLayout()):this.element instanceof N&&this.shiftScript(new o.E9(0,-50))},it.prototype.nextCommand=function(){var t,e,i,s=this.element;if(s instanceof N)this.shiftScript(new o.E9(0,50));else{for(;!(s instanceof R);)if((s=s.parent)instanceof N)return;this.atEnd?(i=s.parentThatIsA(V))?(this.element=i.parentThatIsA(R),this.atEnd=!1,this.nextCommand()):(t=s.topBlock().parentThatIsA(R))&&(this.element=t,this.atEnd=!1,this.element instanceof F&&this.nextCommand()):(e=s.nextBlock())?this.element=e:(this.element=s,this.atEnd=!0),this.fixLayout()}},it.prototype.nextScript=function(){var t,e=this.sortedScripts();if(!(e.length<1)){if(this.element instanceof N&&(this.element=e[0]),(t=e.indexOf(this.element.topBlock())+1)>=e.length&&(t=0),this.element=e[t],this.element.scrollIntoView(),this.atEnd=!1,this.element instanceof F)return this.nextElement();this.fixLayout()}},it.prototype.lastScript=function(){var t,e=this.sortedScripts();if(!(e.length<1)){if(this.element instanceof N&&(this.element=e[0]),(t=e.indexOf(this.element.topBlock())-1)<0&&(t=e.length-1),this.element=e[t],this.element.scrollIntoView(),this.atEnd=!1,this.element instanceof F)return this.nextElement();this.fixLayout()}},it.prototype.newScript=function(){var t=this.position();this.element instanceof N||(t=this.element.topBlock().fullBounds().bottomLeft().add(new o.E9(0,50))),this.setPosition(t),this.element=this.editor,this.editor.adjustBounds(),this.fixLayout()},it.prototype.runScript=function(){this.element instanceof N||this.element.topBlock().mouseClickLeft()},it.prototype.items=function(){return this.element instanceof N?[]:this.element.topBlock().allChildren().filter((t=>t instanceof I&&!(t instanceof G)&&(!t.isStatic||t.choices||t instanceof q||t instanceof O||t instanceof Z||t instanceof V)))},it.prototype.undrop=function(){this.editor.undrop()},it.prototype.redrop=function(){this.editor.redrop()},it.prototype.blockTypes=function(){return this.element.isTemplate?null:this.element instanceof N?["hat","command","reporter","predicate","ring"]:this.element instanceof F||this.element instanceof V?["command"]:this.element instanceof R?this.atEnd&&this.element.isStop()?null:this.element.parent instanceof N?["hat","command"]:["command"]:this.element instanceof D?"%n"===this.element.getSlotSpec()?["reporter"]:["reporter","predicate","ring"]:"%n"===this.element.getSpec()?["reporter"]:this.element.isStatic?null:["reporter","predicate","ring"]},it.prototype.processKeyDown=function(t){this.processKeyEvent(t,this.reactToKeyEvent)},it.prototype.processKeyUp=function(t){(0,o.WY)(t)},it.prototype.processKeyPress=function(t){(0,o.WY)(t)},it.prototype.processKeyEvent=function(t,e){var o;switch(this.world().hand.destroyTemporaries(),t.keyCode){case 8:o="backspace";break;case 9:o="tab";break;case 13:o="enter";break;case 16:case 17:case 18:return;case 27:o="esc";break;case 32:o="space";break;case 37:o="left arrow";break;case 39:o="right arrow";break;case 38:o="up arrow";break;case 40:o="down arrow";break;default:o=String.fromCharCode(t.keyCode||t.charCode)}o=(t.ctrlKey||t.metaKey?"ctrl ":"")+(t.shiftKey?"shift ":"")+o,e.call(this,o)},it.prototype.reactToKeyEvent=function(t){var e,i;switch(t.toLowerCase()){case"esc":return this.stopEditing();case"enter":return this.trigger();case"shift enter":return this.newScript();case"ctrl shift enter":return this.runScript();case"space":return this.menu();case"left arrow":return this.lastElement();case"shift left arrow":return this.shiftScript(new o.E9(-50,0));case"right arrow":return this.nextElement();case"shift right arrow":return this.shiftScript(new o.E9(50,0));case"up arrow":return this.lastCommand();case"shift up arrow":return this.shiftScript(new o.E9(0,-50));case"down arrow":return this.nextCommand();case"shift down arrow":return this.shiftScript(new o.E9(0,50));case"tab":return this.nextScript();case"shift tab":return this.lastScript();case"backspace":return this.deleteLastElement();case"ctrl z":return this.undrop();case"ctrl y":case"ctrl shift z":return this.redrop();case"ctrl [":return;default:e=this.blockTypes(),this.element instanceof N||!e||!(0,o.r3)(e,"reporter")||(i=Object.keys(this.element.getVarNamesDict())),e&&(delete this.fps,delete this.step,this.show(),this.editor.scriptTarget().searchBlocks(t,e,i,this))}},o.qz.widgets="2020-October-06",st.prototype=new o.xp,st.prototype.constructor=st,st.uber=o.xp.prototype,st.prototype.fontSize=10,st.prototype.fontStyle="sans-serif",st.prototype.labelColor=o.E5,st.prototype.labelShadowColor=o.Cj,st.prototype.labelShadowOffset=new o.E9(1,1),st.prototype.color=new o.Il(220,220,220),st.prototype.pressColor=new o.Il(115,180,240),st.prototype.highlightColor=st.prototype.pressColor.lighter(50),st.prototype.outlineColor=new o.Il(30,30,30),st.prototype.outlineGradient=!1,st.prototype.contrast=60,st.prototype.edge=2,st.prototype.corner=5,st.prototype.outline=1,st.prototype.padding=3,st.prototype.init=function(t,e,i,s,r){this.is3D=!1,this.target=t||null,this.action=e||null,this.environment=s||null,this.labelString=i||null,this.label=null,this.labelMinExtent=o.xE,this.hint=r||null,this.isDisabled=!1,o.xp.uber.init.call(this),this.color=st.prototype.color,this.createLabel(),this.fixLayout(),this.rerender()},st.prototype.fixLayout=function(){if(null!==this.label){this.updateLabelColors();var t=2*this.padding+2*this.outline+2*this.edge;this.bounds.setWidth(Math.max(this.label.width(),this.labelMinExtent.x)+t),this.bounds.setHeight(Math.max(this.label instanceof o.XC?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+t),this.label.setCenter(this.center())}},st.prototype.mouseDownLeft=function(){st.uber.mouseDownLeft.call(this),this.label&&this.label.setCenter(this.center().add(1))},st.prototype.mouseClickLeft=function(){this.isDisabled||(st.uber.mouseClickLeft.call(this),this.label&&this.label.setCenter(this.center()))},st.prototype.mouseLeave=function(){st.uber.mouseLeave.call(this),this.label&&this.label.setCenter(this.center())},st.prototype.render=function(t){"highlight"===this.userState?(this.drawOutline(t),this.drawBackground(t,this.highlightColor),this.drawEdges(t,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast))):"pressed"===this.userState?(this.drawOutline(t),this.drawBackground(t,this.pressColor),this.drawEdges(t,this.pressColor,this.pressColor.darker(this.contrast),this.pressColor.lighter(this.contrast))):(this.drawOutline(t),this.drawBackground(t,this.color),this.drawEdges(t,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast)))},st.prototype.drawOutline=function(t){var e,i=o.tU.isFlat&&!this.is3D;if(!this.outline||i)return null;this.outlineGradient?((e=t.createLinearGradient(0,0,0,this.height())).addColorStop(0,this.outlineColor.darker().toString()),e.addColorStop(1,"white")):e=this.outlineColor.toString(),t.fillStyle=e,t.beginPath(),this.outlinePath(t,i?0:this.corner,0),t.closePath(),t.fill()},st.prototype.drawBackground=function(t,e){var i=o.tU.isFlat&&!this.is3D;t.fillStyle=e.toString(),t.beginPath(),this.outlinePath(t,i?0:Math.max(this.corner-this.outline,0),this.outline),t.closePath(),t.fill(),t.lineWidth=this.outline},st.prototype.drawEdges=function(t,e,i,s){if(!o.tU.isFlat||this.is3D){var r,n=Math.max(this.corner,this.outline+this.edge),a=this.width(),h=this.height();(r=t.createLinearGradient(0,this.outline,0,this.outline+this.edge)).addColorStop(0,i.toString()),r.addColorStop(1,e.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(n,this.outline+this.edge/2),t.lineTo(a-n,this.outline+this.edge/2),t.stroke(),(r=t.createRadialGradient(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge,0),this.corner,this.corner,Math.max(this.corner-this.outline,0))).addColorStop(0,e.toString()),r.addColorStop(1,i.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge/2,0),(0,o.uR)(180),(0,o.uR)(270),!1),t.stroke(),(r=t.createLinearGradient(this.outline,0,this.outline+this.edge,0)).addColorStop(0,i.toString()),r.addColorStop(1,e.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(this.outline+this.edge/2,n),t.lineTo(this.outline+this.edge/2,h-n),t.stroke(),(r=t.createLinearGradient(0,h-this.outline,0,h-this.outline-this.edge)).addColorStop(0,s.toString()),r.addColorStop(1,e.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(n,h-this.outline-this.edge/2),t.lineTo(a-n,h-this.outline-this.edge/2),t.stroke(),(r=t.createRadialGradient(a-this.corner,h-this.corner,Math.max(this.corner-this.outline-this.edge,0),a-this.corner,h-this.corner,Math.max(this.corner-this.outline,0))).addColorStop(0,e.toString()),r.addColorStop(1,s.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.arc(a-this.corner,h-this.corner,Math.max(this.corner-this.outline-this.edge/2,0),(0,o.uR)(0),(0,o.uR)(90),!1),t.stroke(),(r=t.createLinearGradient(a-this.outline,0,a-this.outline-this.edge,0)).addColorStop(0,s.toString()),r.addColorStop(1,e.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=this.edge,t.beginPath(),t.moveTo(a-this.outline-this.edge/2,n),t.lineTo(a-this.outline-this.edge/2,h-n),t.stroke()}},st.prototype.outlinePath=o.RC.prototype.outlinePath,st.prototype.createLabel=function(){var t=!o.tU.isFlat||this.is3D;null!==this.label&&this.label.destroy(),this.labelString instanceof s?(this.label=this.labelString.fullCopy(),t&&(this.label.shadowOffset=this.labelShadowOffset,this.label.shadowColor=this.labelShadowColor),this.label.color=this.labelColor):this.label=new o.XC((0,o.NC)(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor),this.add(this.label)},st.prototype.updateLabelColors=function(){var t=!o.tU.isFlat||this.is3D;this.label&&(this.label.color=this.labelColor,this.label.fontSize=this.fontSize,t&&(this.label.shadowOffset=this.labelShadowOffset,this.label.shadowColor=this.labelShadowColor),this.label.fixLayout(!0))},st.prototype.disable=function(){this.isDisabled=!0,this.forAllChildren((t=>t.alpha=.3)),this.rerender()},st.prototype.enable=function(){this.isDisabled=!1,this.forAllChildren((t=>t.alpha=1)),this.rerender()},rt.prototype=new st,rt.prototype.constructor=rt,rt.uber=st.prototype,rt.prototype.contrast=30,rt.prototype.labelPressColor=null,rt.prototype.init=function(t,e,o,i,s,r,n,a,h,l){this.state=!1,this.query=s||(()=>!0),this.minWidth=a||null,this.hasPreview=h||!1,this.isPicture=l||!1,this.hasNeutralBackground=!1,this.trueStateLabel=null,rt.uber.init.call(this,e,o,i,r,n),t&&(this.color=t[0],this.highlightColor=t[1],this.pressColor=t[2]),this.refresh(),this.rerender()},rt.prototype.mouseEnter=function(){var t=this.hint instanceof Function?this.hint():this.hint;this.state&&!this.hasNeutralBackground||(this.userState="highlight",this.rerender()),t&&this.bubbleHelp(t)},rt.prototype.mouseLeave=function(){this.state&&!this.hasNeutralBackground||(this.userState="normal",this.rerender()),this.schedule&&(this.schedule.isActive=!1),this.hint&&this.world().hand.destroyTemporaries()},rt.prototype.mouseDownLeft=function(){this.state||(this.userState="pressed",this.rerender())},rt.prototype.mouseClickLeft=function(){this.state||(this.userState="highlight",this.rerender()),this.trigger()},rt.prototype.trigger=function(){rt.uber.trigger.call(this),this.refresh()},rt.prototype.refresh=function(){"function"==typeof this.query?this.state=this.query.call(this.target):this.state=this.target[this.query](),this.state?(this.userState="pressed",this.labelPressColor&&this.label.setColor(this.labelPressColor),this.trueStateLabel&&(this.label.hide(),this.trueStateLabel.show())):(this.userState="normal",this.labelPressColor&&this.label.setColor(this.labelColor),this.trueStateLabel&&(this.label.show(),this.trueStateLabel.hide())),this.rerender()},rt.prototype.fixLayout=function(){if(null!==this.label){var t,e=2*this.padding+2*this.outline+2*this.edge;this.updateLabelColors(),t=Math.max(this.label.width(),this.labelMinExtent.x),this.bounds.setWidth(this.minWidth?Math.max(this.minWidth,t)+e:t+e),this.bounds.setHeight(Math.max(this.label instanceof o.XC?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+e),this.label.setCenter(this.center()),this.trueStateLabel&&this.trueStateLabel.setCenter(this.center()),this.minWidth&&this.label.setLeft(this.left()+this.outline+this.edge+this.corner+this.padding)}},rt.prototype.render=function(t){switch(this.userState){case"highlight":this.drawOutline(t),this.drawBackground(t,this.highlightColor),this.drawEdges(t,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast));break;case"pressed":this.drawOutline(t),this.drawBackground(t,this.getPressRenderColor()),this.drawEdges(t,this.pressColor,this.pressColor.lighter(40),this.pressColor.darker(40));break;default:this.drawOutline(t),this.drawBackground(t,this.color),this.drawEdges(t,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast))}},rt.prototype.getPressRenderColor=function(){return this.pressColor},rt.prototype.drawEdges=function(t,e,i,s){var r;if(rt.uber.drawEdges.call(this,t,e,i,s),this.hasPreview){if(o.tU.isFlat&&!this.is3D)return t.fillStyle=this.pressColor.toString(),void t.fillRect(this.outline,this.outline,this.corner,this.height()-2*this.outline);(r=t.createLinearGradient(0,0,this.corner,0)).addColorStop(0,this.pressColor.lighter(40).toString()),r.addColorStop(1,this.pressColor.darker(40).toString()),t.fillStyle=r,t.beginPath(),this.previewPath(t,Math.max(this.corner-this.outline,0),this.outline),t.closePath(),t.fill()}},rt.prototype.previewPath=function(t,e,i){var s=e+i,r=this.height();t.arc(s,s,e,(0,o.uR)(-180),(0,o.uR)(-90),!1),t.arc(s,r-s,e,(0,o.uR)(90),(0,o.uR)(180),!1)},rt.prototype.createLabel=function(){var t=!o.tU.isFlat||this.is3D;null!==this.label&&this.label.destroy(),null!==this.trueStateLabel&&this.trueStateLabel.destroy(),this.labelString instanceof Array&&2===this.labelString.length?this.labelString[0]instanceof s?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy(),this.isPicture||(this.label.shadowOffset=t?this.labelShadowOffset:o.xE,this.label.shadowColor=this.labelShadowColor,this.label.color=this.labelColor,this.label.fixLayout(),this.label.rerender(),this.trueStateLabel.shadowOffset=t?this.labelShadowOffset:o.xE,this.trueStateLabel.shadowColor=this.labelShadowColor,this.trueStateLabel.color=this.labelColor,this.trueStateLabel.fixLayout(),this.trueStateLabel.rerender())):this.labelString[0]instanceof o._V?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy()):(this.label=new o.XC((0,o.NC)(this.labelString[0]),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor),this.trueStateLabel=new o.XC((0,o.NC)(this.labelString[1]),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor)):this.labelString instanceof s?(this.label=this.labelString.fullCopy(),this.isPicture||(this.label.shadowOffset=t?this.labelShadowOffset:o.xE,this.label.shadowColor=this.labelShadowColor,this.label.color=this.labelColor,this.label.fixLayout(),this.label.rerender())):this.labelString instanceof o._V?this.label=this.labelString.fullCopy():this.label=new o.XC((0,o.NC)(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,t?this.labelShadowOffset:o.xE,this.labelShadowColor,this.labelColor),this.add(this.label),this.trueStateLabel&&this.add(this.trueStateLabel)},rt.prototype.updateLabelColors=function(){var t=!o.tU.isFlat||this.is3D;rt.uber.updateLabelColors.call(this),this.trueStateLabel&&(this.trueStateLabel.color=this.labelColor,t&&(this.trueStateLabel.shadowOffset=this.labelShadowOffset,this.trueStateLabel.shadowColor=this.labelShadowColor),this.trueStateLabel.fixLayout(!0))},nt.prototype=new rt,nt.prototype.constructor=nt,nt.uber=rt.prototype,nt.prototype.fixLayout=function(){null!==this.label&&(this.updateLabelColors(),this.setExtent(new o.E9(this.label.width()+2*this.padding+3*this.corner+2*this.edge,(this.label instanceof o.XC?this.label.rawHeight():this.label.height())+2*this.padding+this.edge)),this.label.setCenter(this.center()))},nt.prototype.refresh=function(){this.state&&this.parent&&this.parent.add(this),nt.uber.refresh.call(this)},nt.prototype.drawBackground=function(t,e){var o=this.width(),i=this.height(),s=this.corner;t.fillStyle=e.toString(),t.beginPath(),t.moveTo(0,i),t.bezierCurveTo(s,i,s,0,2*s,0),t.lineTo(o-2*s,0),t.bezierCurveTo(o-s,0,o-s,i,o,i),t.closePath(),t.fill()},nt.prototype.drawOutline=function(){(0,o.WY)()},nt.prototype.drawEdges=function(t,e,i,s){if(!o.tU.isFlat||this.is3D){var r,n=this.width(),a=this.height(),h=this.corner,l=this.edge,p=l/2;(0,o.WY)(e),(r=t.createLinearGradient(0,0,n,0)).addColorStop(0,i.toString()),r.addColorStop(1,s.toString()),t.strokeStyle=r,t.lineCap="round",t.lineWidth=l,t.beginPath(),t.moveTo(0,a+p),t.bezierCurveTo(h,a,h,0,2*h,p),t.lineTo(n-2*h,p),t.bezierCurveTo(n-h,0,n-h,a,n,a+p),t.stroke()}},at.prototype=new st,at.prototype.constructor=at,at.uber=st.prototype,at.prototype.init=function(t,e,i,s,r,n,a,h,l){this.padding=1,t=t||"checkbox",this.corner="checkbox"===t?0:(0,o.SW)(this.fontSize)/2+this.outline+this.padding,this.state=!1,this.query=r||(()=>!0),this.tick=null,this.captionString=s||null,this.labelAlignment="right",this.element=h||null,this.builder=l||null,this.toggleElement=null,at.uber.init.call(this,e,i,"checkbox"===t?"✓":"●",n,a),this.fixLayout(),this.refresh()},at.prototype.fixLayout=function(){var t,e=2*this.padding+2*this.outline;null!==this.tick&&(this.bounds.setHeight(this.tick.rawHeight()+e),this.bounds.setWidth(this.tick.width()+e),this.bounds.setWidth(Math.max(this.width(),this.height())),this.bounds.setHeight(Math.max(this.width(),this.height())),this.tick.setCenter(this.center())),this.state?this.tick.show():this.tick.hide(),this.toggleElement&&"right"===this.labelAlignment&&(t=this.top()+(this.height()-this.toggleElement.height())/2,this.toggleElement.setPosition(new o.E9(this.right()+e,t))),null!==this.label&&(t=this.top()+(this.height()-this.label.height())/2,"right"===this.labelAlignment?this.label.setPosition(new o.E9(this.toggleElement?this.toggleElement instanceof ht?this.toggleElement.right():this.toggleElement.right()+e:this.right()+e,t)):this.label.setPosition(new o.E9(this.left()-this.label.width()-e,t)))},at.prototype.createLabel=function(){var t=!o.tU.isFlat||this.is3D;null===this.label&&this.captionString&&(this.label=new o.$1((0,o.NC)(this.captionString),this.fontSize,this.fontStyle,!0),this.add(this.label)),null===this.tick&&(this.tick=new o.XC((0,o.NC)(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,t?new o.E9(1,1):null,new o.Il(240,240,240)),this.add(this.tick)),null===this.toggleElement&&this.element&&(this.element instanceof o._V?this.toggleElement=new ht(this.target,this.action,this.element,this.query,this.environment,this.hint,this.builder):this.element instanceof HTMLCanvasElement&&(this.toggleElement=new o._V,this.toggleElement.isCachingImage=!0,this.toggleElement.bounds.setExtent(new o.E9(this.element.width,this.element.height)),this.toggleElement.cachedImage=this.element),this.add(this.toggleElement))},at.prototype.trigger=function(){at.uber.trigger.call(this),this.refresh()},at.prototype.refresh=function(){"function"==typeof this.query?this.state=this.query.call(this.target):this.state=this.target[this.query](),this.state?this.tick.show():this.tick.hide(),this.toggleElement&&this.toggleElement.refresh&&this.toggleElement.refresh()},at.prototype.mouseDownLeft=function(){st.uber.mouseDownLeft.call(this),this.tick&&this.tick.setCenter(this.center().add(1))},at.prototype.mouseClickLeft=function(){st.uber.mouseClickLeft.call(this),this.tick&&this.tick.setCenter(this.center())},at.prototype.mouseLeave=function(){st.uber.mouseLeave.call(this),this.tick&&this.tick.setCenter(this.center())},ht.prototype=new o.xp,ht.prototype.constructor=ht,ht.uber=o.xp.prototype,ht.prototype.contrast=50,ht.prototype.shadowOffset=new o.E9(2,2),ht.prototype.shadowAlpha=.6,ht.prototype.fontSize=10,ht.prototype.inactiveColor=new o.Il(180,180,180),ht.prototype.init=function(t,e,i,s,r,n,a,h){this.target=t||null,this.action=e||null,this.element=i,this.query=s||(()=>!0),this.environment=r||null,this.hint=n||null,this.builder=a||"nop",this.captionString=h||null,this.labelAlignment="right",this.state=!1,o.xp.uber.init.call(this),this.color=i.color,this.createLabel()},ht.prototype.render=function(t){var e=!o.tU.isFlat||this.is3D,i=()=>{e&&this.element.addShadow(this.shadowOffset,"normal"===this.userState?0:this.shadowAlpha)};this.color=this.element.color,this.element.removeShadow(),this.element[this.builder](),"pressed"!==this.userState&&(this.element.removeShadow(),this.element.setColor(this.inactiveColor),this.element[this.builder](this.contrast),"highlight"===this.userState&&(this.element.removeShadow(),this.element.setColor(this.color.lighter(this.contrast)),this.element[this.builder](this.contrast))),this.element.doWithAlpha?t.drawImage(this.element.doWithAlpha(1,(()=>(i(),this.element.fullImage()))),0,0):(i(),t.drawImage(this.element.fullImage(),0,0)),this.element.removeShadow(),this.element.setColor(this.color),this.element[this.builder]()},ht.prototype.setColor=function(t){this.element.setColor(t),this.fixLayout(),this.refresh()},ht.prototype.fixLayout=function(){this.element.fixLayout(),this.bounds.setExtent(this.element.fullBounds().extent().add(2*this.shadowBlur))},ht.prototype.createLabel=function(){var t;this.captionString&&(this.label=new o.XC(this.captionString,this.fontSize,this.fontStyle,!0),this.add(this.label),t=this.top()+(this.height()-this.label.height())/2,"right"===this.labelAlignment?this.label.setPosition(new o.E9(this.right(),t)):this.label.setPosition(new o.E9(this.left()-this.label.width(),t)))},ht.prototype.trigger=rt.prototype.trigger,ht.prototype.refresh=rt.prototype.refresh,ht.prototype.mouseEnter=rt.prototype.mouseEnter,ht.prototype.mouseLeave=rt.prototype.mouseLeave,ht.prototype.mouseDownLeft=rt.prototype.mouseDownLeft,ht.prototype.mouseClickLeft=rt.prototype.mouseClickLeft,lt.prototype=new o._V,lt.prototype.constructor=lt,lt.uber=o._V.prototype,lt.prototype.fontSize=12,lt.prototype.titleFontSize=14,lt.prototype.fontStyle="sans-serif",lt.prototype.color=st.prototype.color,lt.prototype.titleTextColor=o.Cj,lt.prototype.titleBarColor=st.prototype.pressColor,lt.prototype.contrast=40,lt.prototype.corner=12,lt.prototype.padding=14,lt.prototype.titlePadding=6,lt.prototype.buttonContrast=50,lt.prototype.buttonFontSize=12,lt.prototype.buttonCorner=12,lt.prototype.buttonEdge=6,lt.prototype.buttonPadding=0,lt.prototype.buttonOutline=3,lt.prototype.buttonOutlineColor=st.prototype.color,lt.prototype.buttonOutlineGradient=!0,lt.prototype.instances={},lt.prototype.init=function(t,e,i){this.is3D=!1,this.target=t||null,this.action=e||null,this.environment=i||null,this.key=null,this.labelString=null,this.label=null,this.head=null,this.body=null,this.buttons=null,lt.uber.init.call(this),this.isDraggable=!0,this.noDropShadow=!0,this.fullShadowSource=!1,this.color=st.prototype.color,this.createLabel(),this.createButtons(),this.setExtent(new o.E9(300,150))},lt.prototype.inform=function(t,e,i,s){var r=new o.$1(e,this.fontSize,this.fontStyle,!0,!1,"center",null,null,o.tU.isFlat?null:new o.E9(1,1),o.Cj);this.key||(this.key="inform"+t+e),r.enableLinks=!0,this.labelString=t,this.createLabel(),s&&this.setPicture(s),e&&this.addBody(r),this.addButton("ok","OK"),this.fixLayout(),this.popUp(i)},lt.prototype.askYesNo=function(t,e,i,s){var r=new o.$1(e,this.fontSize,this.fontStyle,!0,!1,"center",null,null,o.tU.isFlat?null:new o.E9(1,1),o.Cj);this.key||(this.key="decide"+t+e),this.labelString=t,this.createLabel(),s&&this.setPicture(s),this.addBody(r),this.addButton("ok","Yes"),this.addButton("cancel","No"),this.fixLayout(),this.popUp(i)},lt.prototype.prompt=function(t,e,i,s,r,n,a,h,l,p,c=2){var d,u,f=Math.pow(10,c),g=new ct(e,a||!1,r||null,r&&n||!1);g.setWidth(250),a?(s&&(u=new pt("column",this.padding),s.setPosition(u.position()),u.add(s)),(0,o.kK)(h)||(0,o.kK)(l)||((d=new o.Vl(h*f,l*f,parseFloat(e)*f,(l-h)/10*f,"horizontal")).alpha=1,d.color=this.color.lighter(50),d.setHeight(.7*g.height()),d.setWidth(g.width()),d.action=t=>{p&&p(t/f),g.setContents(t/f),g.edit()},u||(u=new pt("column",this.padding)),u.add(d)),u&&(u.fixLayout(),this.setPicture(u),u.fixLayout())):s&&this.setPicture(s),this.reactToChoice=function(t){d&&(d.value=t*f,d.fixLayout(),d.rerender()),p&&p(t)},g.reactToInput=function(){var t=g.getValue();d&&(t=Math.max(t,h),d.value=t*f,d.fixLayout(),d.rerender()),p&&p(t)},this.labelString=t,this.createLabel(),this.key||(this.key="prompt"+t+e),this.addBody(g),g.fixLayout(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.popUp(i)},lt.prototype.promptCode=function(t,e,i,s,r){var n,a=new o.yR,h=new o.$1(e||""),l=new pt("column",this.padding),p=s?Math.max(s.width,400):400;this.getInput=function(){return h.text},a.padding=6,a.setWidth(p),a.acceptsDrops=!1,a.contents.acceptsDrops=!1,h.fontName="monospace",h.fontStyle="monospace",h.fontSize=11,h.setPosition(a.topLeft().add(a.padding)),h.enableSelecting(),h.isEditable=!0,a.setHeight(p/4),a.fixLayout=o.WY,a.edge=ct.prototype.edge,a.fontSize=ct.prototype.fontSize,a.typeInPadding=ct.prototype.typeInPadding,a.contrast=ct.prototype.contrast,a.render=ct.prototype.render,a.drawRectBorder=ct.prototype.drawRectBorder,a.addContents(h),h.fixLayout(),s&&this.setPicture(s),this.labelString=t,this.createLabel(),this.key||(this.key="promptCode"+t+e),l.setColor(this.color),l.add(a),r&&l.add((n=r,new o.$1((0,o.NC)(n),10,null,!1,null,null,null,null,o.tU.isFlat?null:new o.E9(1,1),o.Cj))),l.fixLayout(),this.addBody(l),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.popUp(i),h.edit()},lt.prototype.promptVector=function(t,e,i,s,r,n,a,h){var l=new pt("row",4),p=new ct(e.x.toString(),!0),c=new ct(e.y.toString(),!0),d=new pt("column",2),u=new pt("column",2),f=new pt("column",2),g=new pt("column",this.padding);function y(t){return new o.$1((0,o.NC)(t),10,null,!1,null,null,null,null,o.tU.isFlat?null:new o.E9(1,1),o.Cj)}f.alignment="left",f.setColor(this.color),g.setColor(this.color),d.alignment="left",d.setColor(this.color),u.alignment="left",u.setColor(this.color),d.add(y(s)),d.add(p),u.add(y(r)),u.add(c),l.add(d),l.add(u),f.add(l),h&&g.add(y(h)),g.add(f),l.fixLayout(),d.fixLayout(),u.fixLayout(),f.fixLayout(),g.fixLayout(),this.labelString=t,this.createLabel(),a&&this.setPicture(a),this.addBody(g),this.addButton("ok","OK"),i instanceof o.E9&&this.addButton((()=>{p.setContents(i.x.toString()),c.setContents(i.y.toString())}),"Default"),this.addButton("cancel","Cancel"),this.fixLayout(),this.edit=function(){p.edit()},this.getInput=function(){return new o.E9(p.getValue(),c.getValue())},this.key||(this.key="vector"+t),this.popUp(n)},lt.prototype.promptCredentials=function(t,e,i,s,r,n,a,h,l,p){var c,d,u,f,g=new ct,y=new ct,m=new ct,b=new ct,w=new ct,C=!1,S=new pt("row",4),v=new pt("column",2),x=new pt("column",2),k=new pt("column",2),M=new pt("row",4),T=new pt("column",this.padding),B={},P=(new Date).getFullYear(),I=P-20,E=this;function L(t){return new o.$1((0,o.NC)(t),10,null,!1,null,null,null,null,o.tU.isFlat?null:new o.E9(1,1),o.Cj)}function A(t,e){var i=new st(E,(()=>window.open(e)),"  "+(0,o.NC)(t)+"  ");return i.fontSize=10,i.corner=E.buttonCorner,i.edge=E.buttonEdge,i.outline=E.buttonOutline,i.outlineColor=E.buttonOutlineColor,i.outlineGradient=E.buttonOutlineGradient,i.padding=E.buttonPadding,i.contrast=E.buttonContrast,i.fixLayout(),i}for(c=new ct(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},!0);P>I;P-=1)B[P.toString()+" "]=P;B[I+" "+(0,o.NC)("or before")]="< "+P,d=new ct(null,!1,B,!0),k.alignment="left",k.setColor(this.color),T.setColor(this.color),v.alignment="left",v.setColor(this.color),x.alignment="left",x.setColor(this.color),g.setWidth(200),c.setWidth(100),d.contents().minWidth=80,d.setWidth(80),y.setWidth(200),m.setWidth(200),b.setWidth(200),w.setWidth(200),m.contents().text.toggleIsPassword(),b.contents().text.toggleIsPassword(),w.contents().text.toggleIsPassword(),"login"===e&&(k.add(L("User name:")),k.add(g)),"signup"===e&&(k.add(L("User name:")),k.add(g),v.add(L("Birth date:")),v.add(c),x.add(L("year:")),x.add(d),S.add(v),S.add(x),k.add(S),u=L("foo"),k.add(u),k.add(y),k.add(L("Password:")),k.add(m),k.add(L("Repeat Password:")),k.add(b)),"login"===e&&(k.add(L("Password:")),k.add(m)),"changePassword"===e&&(k.add(L("Old password:")),k.add(w),k.add(L("New password:")),k.add(m),k.add(L("Repeat new password:")),k.add(b)),"resetPassword"!==e&&"resendVerification"!==e||(k.add(L("User name:")),k.add(g)),p&&T.add(L(p)),T.add(k),(i||r)&&T.add(M),i&&M.add(A(s,i)),r&&M.add(A(n,r)),a&&((f=new at("checkbox",this,(()=>C=!C),a,(()=>C))).edge=this.buttonEdge/2,f.outline=this.buttonOutline/2,f.outlineColor=this.buttonOutlineColor,f.outlineGradient=this.buttonOutlineGradient,f.contrast=this.buttonContrast,f.fixLayout(),T.add(f)),S.fixLayout(),v.fixLayout(),x.fixLayout(),k.fixLayout(),M.fixLayout(),T.fixLayout(),this.labelString=t,this.createLabel(),l&&this.setPicture(l),this.addBody(T),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.fixLayout(),this.accept=function(){(function(){var t,i,s=y.getValue();function r(t,e){var i=new o.KE((0,o.NC)(e));i.isPointingRight=!1,i.fixLayout(),i.popUp(h,t.leftCenter().subtract(new o.E9(i.width()+2,0))),t.edit&&t.edit()}if("login"===e?t=[g,m]:"signup"===e?t=[g,c,d,y,m,b]:"changePassword"===e?t=[w,m,b]:"resetPassword"!==e&&"resendVerification"!==e||(t=[g]),i=(0,o.qY)(t,(t=>!t.getValue())))return r(i,"please fill out\nthis field"),!1;if("signup"===e){if(g.getValue().length<4)return r(g,"User name must be four\ncharacters or longer"),!1;if(s.indexOf(" ")>-1||-1===s.indexOf("@")||-1===s.indexOf(".")||s.length<5)return r(y,"please provide a valid\nemail address"),!1}if("changePassword"===e||"signup"===e){if(m.getValue().length<6)return r(m,"password must be six\ncharacters or longer"),!1;if(m.getValue()!==b.getValue())return r(b,"passwords do\nnot match"),!1}return!("signup"===e&&!C&&(r(f,"please agree to\nthe TOS"),1))})()&&lt.prototype.accept.call(E)},this.edit=function(){"changePassword"===e?w.edit():g.edit()},this.getInput=function(){return{username:g.getValue(),email:y.getValue(),oldpassword:w.getValue(),password:m.getValue(),passwordRepeat:b.getValue(),choice:C}},this.reactToChoice=function(){var t,i,s,r;"signup"===e&&(u.changed(),u.text=(i=(new Date).getFullYear()+(new Date).getMonth()/12,s=+d.getValue()||0,(r=c.getValue())instanceof Array&&(r=r[0]),isNaN(s)&&(s=0),t=["January","February","March","April","May","June","July","August","September","October","November","December"].indexOf(r),isNaN(t)&&(t=0),i-(s+t/12)<=13?"E-mail address of parent or guardian:":"E-mail address:"),u.text=(0,o.NC)(u.text),u.fixLayout(),u.rerender())},this.reactToChoice(),this.key||(this.key="credentials"+t+e),this.popUp(h)},lt.prototype.accept=function(){this.action&&("function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action):"function"==typeof this.action?this.action.call(this.target,this.getInput()):this.target[this.action](this.getInput())),this.destroy()},lt.prototype.withKey=function(t){return this.key=t,this},lt.prototype.popUp=function(t){t&&(this.key&&(this.instances[t.stamp]?(this.instances[t.stamp][this.key]&&this.instances[t.stamp][this.key].destroy(),this.instances[t.stamp][this.key]=this):(this.instances[t.stamp]={},this.instances[t.stamp][this.key]=this)),t.add(this),t.keyboardFocus=this,this.setCenter(t.center()),this.edit())},lt.prototype.destroy=function(){lt.uber.destroy.call(this),this.key&&delete this.instances[this.key]},lt.prototype.ok=function(){this.accept()},lt.prototype.cancel=function(){this.destroy()},lt.prototype.edit=function(){this.children.forEach((t=>{t.edit&&t.edit()}))},lt.prototype.getInput=function(){return this.body instanceof ct?this.body.getValue():null},lt.prototype.justDropped=function(t){t.world.keyboardFocus=this,this.edit()},lt.prototype.destroy=function(){var t=this.world();t.keyboardFocus=null,t.hand.destroyTemporaries(),lt.uber.destroy.call(this)},lt.prototype.normalizeSpaces=function(t){var e,o,i="",s=!1;for(e=0;e<t.length;e+=1)" "===(o=t[e])?s&&(i+=o,s=!1):(i+=o,s=!0);return i.trim()},lt.prototype.createLabel=function(){var t=!o.tU.isFlat||this.is3D;this.label&&this.label.destroy(),this.labelString&&(this.label=new o.XC((0,o.NC)(this.labelString),this.titleFontSize,this.fontStyle,!0,!1,!1,t?new o.E9(2,1):null,this.titleBarColor.darker(this.contrast)),this.label.color=this.titleTextColor,this.label.fixLayout(),this.add(this.label))},lt.prototype.createButtons=function(){this.buttons&&this.buttons.destroy(),this.buttons=new pt("row",this.padding),this.add(this.buttons)},lt.prototype.addButton=function(t,e){var i=new st(this,t||"ok","  "+(0,o.NC)(e||"OK")+"  ");return i.fontSize=this.buttonFontSize,i.corner=this.buttonCorner,i.edge=this.buttonEdge,i.outline=this.buttonOutline,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.padding=this.buttonPadding,i.contrast=this.buttonContrast,i.fixLayout(),this.buttons.add(i),i},lt.prototype.setPicture=function(t){var e;t instanceof o._V?e=t:((e=new o._V).isCachingImage=!0,e.cachedImage=t,e.bounds.setWidth(t.width),e.bounds.setHeight(t.height)),this.addHead(e)},lt.prototype.addHead=function(t){this.head&&this.head.destroy(),this.head=t,this.add(this.head)},lt.prototype.addBody=function(t){this.body&&this.body.destroy(),this.body=t,this.add(this.body)},lt.prototype.fixLayout=function(){var t,e=(0,o.SW)(this.titleFontSize)+2*this.titlePadding;this.head&&(this.head.setPosition(this.position().add(new o.E9(this.padding,e+this.padding))),this.bounds.setWidth(this.head.width()+2*this.padding),this.bounds.setHeight(this.head.height()+2*this.padding+e)),this.body&&(this.head?(this.body.setPosition(this.head.bottomLeft().add(new o.E9(0,this.padding))),this.bounds.setWidth(Math.max(this.width(),this.body.width()+2*this.padding)),this.bounds.setHeight(this.height()+this.body.height()+this.padding),t=this.width(),this.head.setLeft(this.left()+Math.round((t-this.head.width())/2)),this.body.setLeft(this.left()+Math.round((t-this.body.width())/2))):(this.body.setPosition(this.position().add(new o.E9(this.padding,e+this.padding))),this.bounds.setWidth(this.body.width()+2*this.padding),this.bounds.setHeight(this.body.height()+2*this.padding+e))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(e-this.label.height())/2)),this.buttons&&this.buttons.children.length>0&&(this.buttons.fixLayout(),this.bounds.setHeight(this.height()+this.buttons.height()+this.padding),this.bounds.setWidth(Math.max(this.width(),this.buttons.width()+2*this.padding)),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),this.removeShadow(),this.addShadow()},lt.prototype.processKeyPress=o.WY,lt.prototype.processKeyDown=function(t){switch(t.keyCode){case 13:this.ok();break;case 27:this.cancel();break;default:(0,o.WY)()}},lt.prototype.render=function(t){var e,i,s,r=this.width(),n=this.height(),a=Math.floor((0,o.SW)(this.titleFontSize)+2*this.titlePadding),h=this.corner/2,l=o.tU.isFlat&&!this.is3D;l?t.fillStyle=this.titleBarColor.toString():((e=t.createLinearGradient(0,0,0,a)).addColorStop(0,this.titleBarColor.lighter(this.contrast/2).toString()),e.addColorStop(1,this.titleBarColor.darker(this.contrast).toString()),t.fillStyle=e),t.beginPath(),this.outlinePathTitle(t,l?0:this.corner),t.closePath(),t.fill(),t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePathBody(t,l?0:this.corner),t.closePath(),t.fill(),l||((e=t.createLinearGradient(0,n-this.corner,0,n)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast.toString())),t.lineWidth=this.corner,t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner,n-h),t.lineTo(this.corner+1,n-h),t.stroke(),(e=t.createLinearGradient(0,n-this.corner,0,n)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast.toString())),t.lineWidth=this.corner,t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.moveTo(this.corner,n-h),t.lineTo(r-this.corner,n-h),t.stroke(),(e=t.createLinearGradient(r-this.corner,0,r,0)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast).toString()),t.lineWidth=this.corner,t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.moveTo(r-h,a),t.lineTo(r-h,n-this.corner),t.stroke(),i=r-this.corner,s=n-this.corner,(e=t.createRadialGradient(i,s,0,i,s,this.corner)).addColorStop(0,this.color.toString()),e.addColorStop(1,this.color.darker(this.contrast.toString())),t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.arc(i,s,h,(0,o.uR)(90),(0,o.uR)(0),!0),t.stroke(),(e=t.createLinearGradient(0,0,this.corner,0)).addColorStop(0,this.color.lighter(this.contrast).toString()),e.addColorStop(1,this.color.toString()),t.lineCap="butt",t.strokeStyle=e,t.beginPath(),t.moveTo(h,a),t.lineTo(h,n-2*this.corner),t.stroke(),(e=t.createLinearGradient(0,0,this.corner,0)).addColorStop(0,this.color.lighter(this.contrast).toString()),e.addColorStop(1,this.color.toString()),t.lineCap="round",t.strokeStyle=e,t.beginPath(),t.moveTo(h,n-2*this.corner),t.lineTo(h,n-this.corner-h),t.stroke())},lt.prototype.outlinePathTitle=function(t,e){var i=this.width(),s=Math.ceil((0,o.SW)(this.titleFontSize))+2*this.titlePadding;t.arc(e,e,e,(0,o.uR)(-180),(0,o.uR)(-90),!1),t.arc(i-e,e,e,(0,o.uR)(-90),(0,o.uR)(-0),!1),t.lineTo(i,s),t.lineTo(0,s)},lt.prototype.outlinePathBody=function(t,e){var i=this.width(),s=this.height(),r=Math.floor((0,o.SW)(this.titleFontSize))+2*this.titlePadding;t.moveTo(0,r),t.lineTo(i,r),t.arc(i-e,s-e,e,(0,o.uR)(0),(0,o.uR)(90),!1),t.arc(e,s-e,e,(0,o.uR)(90),(0,o.uR)(180),!1)},pt.prototype=new o._V,pt.prototype.constructor=pt,pt.uber=o._V.prototype,pt.prototype.init=function(t,e){this.orientation=t||"row",this.alignment="center",this.padding=e||0,this.respectHiddens=!1,pt.uber.init.call(this)},pt.prototype.render=function(t){(0,o.WY)(t)},pt.prototype.fixLayout=function(){var t,e=null;if(0===this.children.length)return null;this.children.forEach((i=>{var s,r=i.fullBounds();(i.isVisible||this.respectHiddens)&&(e?(s=e.fullBounds(),"row"===this.orientation?i.setPosition(s.topRight().add(new o.E9(this.padding,(s.height()-r.height())/2))):i.setPosition(s.bottomLeft().add(new o.E9("center"===this.alignment?(s.width()-r.width())/2:0,this.padding))),r=i.fullBounds(),t=t.merge(r)):t=r,e=i)})),this.bounds=t},ct.prototype=new o._V,ct.prototype.constructor=ct,ct.uber=o._V.prototype,ct.prototype.edge=2,ct.prototype.fontSize=12,ct.prototype.typeInPadding=2,ct.prototype.contrast=65,ct.prototype.init=function(t,e,i,s){var r=new o.qi(t||"",null,null,null,null,null,e||!1),n=new Y("down",0,Math.max(Math.floor(this.fontSize/6),1));this.choices=i||null,this.isReadOnly=s||!1,this.isNumeric=e||!1,r.alpha=0,r.fontSize=this.fontSize,r.fixLayout(),this.oldContentsExtent=r.extent(),ct.uber.init.call(this),this.color=o.Cj,this.add(r),this.add(n),r.isDraggable=!1,this.fixLayout()},ct.prototype.contents=function(){return(0,o.qY)(this.children,(t=>t instanceof o.qi))},ct.prototype.arrow=function(){return(0,o.qY)(this.children,(t=>t instanceof Y))},ct.prototype.setChoice=function(t){this.setContents(t),this.escalateEvent("reactToChoice",t)},ct.prototype.setContents=function(t){var e=this.contents();if(e.text.text=t,void 0===t)return null;null===t?e.text.text="":t.toString&&(e.text.text=t.toString()),e.text.fixLayout(),e.changed(),e.fixLayout(),e.rerender()},ct.prototype.edit=function(){var t=this.contents();t.text.edit(),t.text.selectAll()},ct.prototype.setIsNumeric=function(t){var e;this.isNumeric=t,this.contents().isNumeric=t,this.contents().text.isNumeric=t,e=this.getValue(),this.isNumeric&&(e=parseFloat(e),isNaN(e)&&(e=null)),this.setContents(e)},ct.prototype.dropDownMenu=function(){var t,e=this.choices,i=new o.wR(this.setChoice,null,this,this.fontSize);if(e instanceof Function?e=e.call(this):(0,o.HD)(e)&&(e=this[e]()),!e)return null;if(i.addItem(" ",null),e instanceof Array)e.forEach((t=>i.addItem(t[0],t[1])));else for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&("~"===t[0]?i.addLine():i.addItem(t,e[t]));if(!(i.items.length>0))return null;i.popUpAtHand(this.world())},ct.prototype.fixLayout=function(){var t=this.contents(),e=this.arrow();if(!t)return null;t.isNumeric=this.isNumeric,t.isEditable=!this.isReadOnly,this.choices?(e.setSize(this.fontSize),e.show()):(e.setSize(0),e.hide()),this.bounds.setHeight(t.height()+2*this.edge+2*this.typeInPadding),this.bounds.setWidth(Math.max(t.minWidth+2*this.edge+2*this.typeInPadding,this.width())),t.setWidth(this.width()-this.edge-this.typeInPadding-(this.choices?e.width()+this.typeInPadding:0)),t.setPosition(new o.E9(this.edge,this.edge).add(this.typeInPadding).add(this.position())),e.setPosition(new o.E9(this.right()-e.width()-this.edge,t.top()))},ct.prototype.mouseClickLeft=function(t){this.arrow().bounds.containsPoint(t)||this.isReadOnly?this.dropDownMenu():this.escalateEvent("mouseClickLeft",t)},ct.prototype.getValue=function(){var t,e=this.contents();return this.isNumeric&&(t=parseFloat(e.text),!isNaN(t))?t:this.normalizeSpaces(e.string())},ct.prototype.normalizeSpaces=lt.prototype.normalizeSpaces,ct.prototype.render=function(t){var e;this.parent?(this.parent.color.eq(o.Cj)?this.color=this.parent.color.darker(.1*this.contrast):this.color=this.parent.color.lighter(.75*this.contrast),e=this.parent.color):e=new o.Il(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),t.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),this.drawRectBorder(t)},ct.prototype.drawRectBorder=function(t){var e,i=.5*this.edge;o.tU.isFlat&&!this.is3D||(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",o.A3&&(t.shadowOffsetY=i,t.shadowBlur=4*this.edge,t.shadowColor=this.cachedClrDark),(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,i),t.lineTo(this.width()-this.edge-i,i),t.stroke(),t.shadowOffsetY=0,(e=t.createLinearGradient(0,0,this.edge,0)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(i,this.edge),t.lineTo(i,this.height()-this.edge-i),t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=0,(e=t.createLinearGradient(0,this.height()-this.edge,0,this.height())).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.edge,this.height()-i),t.lineTo(this.width()-this.edge,this.height()-i),t.stroke(),(e=t.createLinearGradient(this.width()-this.edge,0,this.width(),0)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(this.width()-i,this.edge),t.lineTo(this.width()-i,this.height()-this.edge),t.stroke())},dt.prototype=new o.wR,dt.prototype.constructor=dt,dt.uber=o.wR.prototype,dt.prototype.init=function(t,e,o,i){var s,r;for(r in this.soundType=i,dt.uber.init.call(this,t,null,e,o),s={"C (48)":48,"D (50)":50,"C# (49)":49,"E (52)":52,"Eb (51)":51,"F (53)":53,"G (55)":55,"F# (54)":54,"A (57)":57,"G# (56)":56,"B (59)":59,"Bb (58)":58,"C (60)":60,"D (62)":62,"C# (61)":61,"E (64)":64,"Eb (63)":63,"F (65)":65,"G (67)":67,"F# (66)":66,"A (69)":69,"G# (68)":68,"B (71)":71,"Bb (70)":70,"C (72)":72})Object.prototype.hasOwnProperty.call(s,r)&&this.addItem(r,s[r])},dt.prototype.createItems=function(){var t,e,i,s,r,n,a,h,l,p,c;this.children.forEach((t=>t.destroy())),this.children=[],this.isListContents||(this.edge=o.tU.isFlat?0:5,this.border=o.tU.isFlat?1:2),this.color=o.Cj,this.borderColor=new o.Il(60,60,60),this.bounds.setExtent(o.xE),i=this.left()+1,s=this.top()+1.5*this.fontSize+2,r=new o.XC("",this.fontSize),this.items.forEach((e=>{n=" "!==e[0][1],a=new o.RC(1,1),n?(h=o.E5,l=this.fontSize,p=2.5*this.fontSize,c=new o.E9(i+2-2*this.fontSize,s)):(h=o.Cj,l=1.5*this.fontSize,p=4*this.fontSize,c=new o.E9(i+1,s),i+=l-1),a.setColor(h),a.setWidth(l),a.setHeight(p),(t=new ut(this.target,e[1],[a,e[0]],this.fontSize||o.tU.menuFontSize,o.tU.menuFontName,this.environment,e[2],e[3],e[4],e[5],e[6],r)).setPosition(c),this.add(t)})),e=this.fullBounds(),r.setPosition(new o.E9(e.width()/2-this.fontSize,2)),this.add(r),e=this.fullBounds(),this.bounds.setExtent(e.extent().add(2))},dt.prototype.select=function(t){this.unselectAllItems(),t.mouseEnter(),this.selection=t,this.world.keyboardFocus=this,this.hasFocus=!0},dt.prototype.unselectAllItems=function(){this.children.forEach((t=>{t instanceof o.xK&&t.mouseLeave()})),this.changed()},dt.prototype.selectKey=function(t){var e;(0,o.kK)(t)||((e=(0,o.qY)(this.children,(e=>e.action===t)))?this.select(e):this.selectKey(48))},dt.prototype.processKeyDown=function(t){switch(t.keyCode){case 13:case 32:return void(this.selection&&this.selection.mouseClickLeft());case 27:return this.destroy();case 37:case 40:case 189:return this.selectDown();case 38:case 39:case 187:case 220:return this.selectUp();default:switch(t.key){case"C":return this.selectKey(48);case"c":return this.selectKey(60);case"D":return this.selectKey(50);case"d":return this.selectKey(62);case"E":return this.selectKey(52);case"e":return this.selectKey(64);case"F":return this.selectKey(53);case"f":return this.selectKey(65);case"G":return this.selectKey(55);case"g":return this.selectKey(67);case"A":return this.selectKey(57);case"a":return this.selectKey(69);case"B":case"H":return this.selectKey(59);case"b":case"h":return this.selectKey(71);default:(0,o.WY)()}}},dt.prototype.selectUp=function(){var t=48;this.selection&&(t=this.selection.action+1)>72&&(t=48),this.selectKey(t)},dt.prototype.selectDown=function(){var t=48;this.selection&&(t=this.selection.action-1)<48&&(t=72),this.selectKey(t)},dt.prototype.destroy=function(){this.children.forEach((t=>{t.note&&t.note.stop()})),dt.uber.destroy.call(this)},ut.prototype=new o.xK,ut.prototype.constructor=ut,ut.uber=o.xK.prototype,ut.prototype.init=function(t,e,o,i,s,r,n,a,h,l,p,c){this.note=new Note(e),ut.uber.init.call(this,t,e,o,i,s,r,n,a,h,l,p,c)},ut.prototype.createLabel=function(){var t;null!==this.label&&this.label.destroy(),this.label=new o._V,t=this.createIcon(this.labelString[0]),this.label.add(t),this.bounds.setExtent(t.extent()),this.label.bounds=this.position().extent(this.label.extent()),this.label.bounds.setExtent(o.xE),this.add(this.label)},ut.prototype.mouseEnter=function(){var t=this.parentThatIsA(dt),e=t?t.soundType:1;t&&(t.unselectAllItems(),t.selection=this,t.world.keyboardFocus=t,t.hasFocus=!0),this.label.children[0].hide(),this.userState="highlight",this.rerender(),this.feedback.text=this.labelString[1],this.feedback.fixLayout(),this.note.play(e),setTimeout((()=>this.note.stop(!0)),400)},ut.prototype.mouseLeave=function(){this.note.stop(!0),this.label.children[0].show(),this.userState="normal",this.rerender()},o.qz.byob="2020-October-07",ft.prototype.blockInstance=function(t){var e;return(e="command"===this.type?new gt(this):new yt(this,"predicate"===this.type)).isDraggable=!0,t&&(e.storedTranslations=this.translationsAsText()),e},ft.prototype.templateInstance=function(){var t;return(t=this.blockInstance()).refreshDefaults(this),t.isDraggable=!1,t.isTemplate=!0,t},ft.prototype.prototypeInstance=function(){var t,e;return(t="command"===this.type?new gt(this,!0):new yt(this,"predicate"===this.type,!0)).parts().forEach((t=>{t instanceof xt&&(e=this.declarations.get(t.fragment.labelString))&&(t.fragment.type=e[0],t.fragment.defaultValue=e[1],t.fragment.options=e[2],t.fragment.isReadOnly=e[3]||!1)})),t},ft.prototype.copyAndBindTo=function(t,e){var o=copy(this);for(var[i,s]of(delete o[XML_Serializer.prototype.idProperty],o.receiver=t,o.declarations=new Map,this.declarations))o.declarations.set(i,s);return e?(o.body=null,o):(o.body&&(o.body=a.prototype.reify.call(null,this.body.expression,new d(this.inputNames())),o.body.outerContext=null),o)},ft.prototype.blockSpec=function(){if(this.storedSemanticSpec)return this.storedSemanticSpec;var t,e=[];return this.parseSpec(this.spec).forEach((o=>{t="%"===o[0]&&o.length>1?this.typeOf(o.slice(1)):"$nl"===o?"%br":o,e.push(t),e.push(" ")})),"".concat.apply("",e).trim()},ft.prototype.helpSpec=function(){var t=[];return this.parseSpec(this.spec).forEach((e=>{"%"!==e[0]&&t.push(e)})),"".concat.apply("",t).replace(/\?/g,"")},ft.prototype.typeOf=function(t){return this.declarations.has(t)?this.declarations.get(t)[0]:"%s"},ft.prototype.defaultValueOf=function(t){return this.declarations.has(t)?this.declarations.get(t)[1]:""},ft.prototype.defaultValueOfInputIdx=function(t){var e=this.inputNames()[t];return this.defaultValueOf(e)},ft.prototype.dropDownMenuOfInputIdx=function(t){var e=this.inputNames()[t];return this.dropDownMenuOf(e)},ft.prototype.isReadOnlyInputIdx=function(t){var e=this.inputNames()[t];return this.isReadOnlyInput(e)},ft.prototype.inputOptionsOfIdx=function(t){var e=this.inputNames()[t];return this.inputOptionsOf(e)},ft.prototype.dropDownMenuOf=function(t){var e;return this.declarations.has(t)&&this.declarations.get(t)[2]?0===this.declarations.get(t)[2].indexOf("§_")&&(e=this.declarations.get(t)[2].slice(2),(0,o.r3)(["messagesMenu","messagesReceivedMenu","objectsMenu","costumesMenu","soundsMenu","getVarNamesDict","pianoKeyboardMenu","directionDialMenu"],e))?e:this.parseChoices(this.declarations.get(t)[2]):null},ft.prototype.parseChoices=function(t){var e,i,s={},r=[s];return t.match(/^function\s*\(.*\)\s*{.*\n/)?(e=t.match(/^function\s*\((.*)\)/)[1].split(","),i=t.split("\n").slice(1,-1).join("\n"),Function.apply(null,e.concat([i]))):(t.split("\n").forEach((t=>{var e=t.split("=");"}"===e[0]?(r.pop(),s=r[r.length-1]):"{"===e[1]?(s={},r[r.length-1][e[0]]=s,r.push(s)):s[e[0]]=(0,o.kK)(e[1])?e[0]:e[1]})),s)},ft.prototype.isReadOnlyInput=function(t){return this.declarations.has(t)&&!0===this.declarations.get(t)[3]},ft.prototype.inputOptionsOf=function(t){return[this.dropDownMenuOf(t),this.isReadOnlyInput(t)]},ft.prototype.inputNames=function(){var t=[];return this.parseSpec(this.spec).forEach((e=>{"%"===e[0]&&e.length>1&&t.push(e.slice(1))})),t},ft.prototype.parseSpec=function(t){var e,o,i=[],s="",r=!1;for(e=0;e<t.length;e+=1)"'"===(o=t[e])?r=!r:" "!==o||r?s=s.concat(o):(i.push(s),s="");return i.push(s),i},ft.prototype.isDirectlyRecursive=function(){var t;return null!==this.cachedIsRecursive||(this.body?(t=this.blockSpec(),this.cachedIsRecursive=this.body.expression.anyChild((function(e){return e.isCustomBlock&&e.blockSpec===t}))):this.cachedIsRecursive=!1),this.cachedIsRecursive},ft.prototype.localizedSpec=function(){if(this.cachedTranslation)return this.cachedTranslation;var t,e,i=this.translations[SnapTranslator.language],s=this.blockSpec(),r=-1;function n(t){return t.length>1&&"%"===t[0]}return(0,o.kK)(i)?s:(e=A.prototype.parseSpec(s).filter((t=>n(t))),(t=A.prototype.parseSpec(i)).some((t=>n(t)))||t.filter((t=>"_"===t)).length!==e.length?this.cachedTranslation=s:(t=t.map((t=>"_"===t?e[r+=1]:t)),this.cachedTranslation=t.join(" ")),this.cachedTranslation)},ft.prototype.abstractBlockSpec=function(){return A.prototype.parseSpec(this.blockSpec()).map((t=>t.length>1&&"%"===t[0]?"_":t)).join(" ")},ft.prototype.translationsAsText=function(){var t="";return Object.keys(this.translations).forEach((e=>t+=e+":"+this.translations[e]+"\n")),t},ft.prototype.updateTranslations=function(t){var e=t.split("\n").filter((t=>t.length));this.translations={},e.forEach((t=>{var e=t.indexOf(":"),o=t.slice(0,e).trim(),i=t.slice(e+1).trim();e&&(this.translations[o]=i)}))},ft.prototype.scriptsPicture=function(){return this.scriptsModel().scriptsPicture()},ft.prototype.sortedElements=function(){return this.scriptsModel().sortedElements()},ft.prototype.scriptsModel=function(){var t,e,o,i,s;return(t=new N).cleanUpMargin=10,(e=new wt(this)).setPosition(t.position().add(10)),null!==this.comment&&(i=this.comment.fullCopy(),e.comment=i,i.block=e),null!==this.body&&e.nextBlock(this.body.expression.fullCopy()),t.add(e),e.fixBlockColor(null,!0),this.scripts.forEach((e=>{(o=e.fullCopy()).setPosition(t.position().add(e.position())),t.add(o),o instanceof A&&o.allComments().forEach((t=>t.align(o)))})),e.allComments().forEach((t=>t.align(e))),(s=e.parts()[0]).fixLayout(),s.forceNormalColoring(),s.fixBlockColor(e,!0),t.fixMultiArgs(),t},ft.prototype.purgeCorpses=function(){this.body&&this.body.expression.isCorpse&&(this.body=null),this.scripts=this.scripts.filter((t=>!t.isCorpse))},ft.prototype.collectDependencies=function(t=[],e=[]){if(!this.isGlobal)throw new Error("collecting dependencies is only supported\nfor global custom blocks");return t.push(this),this.scripts.concat(this.body?[this.body.expression]:[]).forEach((i=>{i.forAllChildren((i=>{i.isCustomBlock&&i.isGlobal&&!(0,o.r3)(t,i.definition)&&!(0,o.r3)(e,i.definition)&&(e.push(i.definition),i.definition.collectDependencies(t,e))}))})),e},ft.prototype.isSending=function(t,e){return this.scripts.concat(this.body?[this.body.expression]:[]).some((o=>o.isSending(t,e)))},gt.prototype=new R,gt.prototype.constructor=gt,gt.uber=R.prototype,gt.prototype.isCustomBlock=!0,gt.prototype.init=function(t,e){this.definition=t,this.semanticSpec="",this.isGlobal=!!t&&t.isGlobal,this.isPrototype=e||!1,gt.uber.init.call(this),this.category=t.category,this.selector="evaluateCustomBlock",this.variables=null,this.storedTranslations=null,this.initializeVariables(),t&&this.refresh()},gt.prototype.initializeVariables=function(t){this.variables=new p,this.isGlobal&&this.definition.variableNames.forEach((e=>{var o=t?t[e]:null;this.variables.addVar(e,o instanceof Variable?o.value:null)}))},gt.prototype.refresh=function(t){var e,o=t||this.definition,i=this.isPrototype?o.spec:o.localizedSpec();this.semanticSpec=o.blockSpec(),this.isGlobal||this.isPrototype||(this.definition=null),this.setCategory(o.category),this.blockSpec!==i?(e=this.inputs(),this.zebraContrast?this.fixBlockColor():this.forceNormalColoring(),this.setSpec(i,o),this.fixLabelColor(),this.restoreInputs(e)):this.inputs().forEach(((t,e)=>{t instanceof H&&t.setChoices.apply(t,o.inputOptionsOfIdx(e))})),this.cachedInputs=null,this.inputs().forEach(((t,e)=>{t instanceof G&&"↑"===t.contents()&&t.setContents(o.inputNames()[e])})),this.isGlobal&&this.initializeVariables(this.variables.vars),this.forceNormalColoring(),this.fixBlockColor(null,!0)},gt.prototype.restoreInputs=function(t){var e,o=0;this.isPrototype||(this.cachedInputs=null,this.inputs().forEach((i=>{(e=t[o])instanceof D&&!(i instanceof G)?this.replaceInput(i,e.fullCopy()):e instanceof H&&i instanceof H?e.isEmptySlot()?i.setContents(""):i.setContents(e.evaluate()):e instanceof q&&i instanceof q||e instanceof q&&i instanceof q||e instanceof G&&i instanceof G?i.setContents(e.evaluate()):e instanceof CSlotMorph&&i instanceof CSlotMorph&&i.nestedBlock(e.evaluate()),o+=1})),this.cachedInputs=null)},gt.prototype.refreshDefaults=function(t){var e=this.inputs(),o=0;e.forEach((e=>{(e instanceof H||e instanceof q)&&e.setContents((t||this.definition).defaultValueOfInputIdx(o)),o+=1})),this.cachedInputs=null},gt.prototype.refreshPrototype=function(){var t,e,o,i=[],s=this,r=0;if(!this.isPrototype)return null;t=this.parentThatIsA(wt),this.parts().forEach((t=>{t.fragment.isDeleted||(t.fragment.type?i.push(t.fragment):s.definition.parseSpec(t.fragment.labelString).forEach((e=>{(o=t.fragment.copy()).labelString=e,i.push(o)})))})),e=this.specFromFragments()||this.blockSpec,this instanceof gt&&("reporter"===t.type||"predicate"===t.type)?(s=new yt(this.definition,"predicate"===t.type,!0),t.replaceInput(this,s)):this instanceof yt&&("command"===t.type?(s=new gt(this.definition,!0),t.replaceInput(this,s)):(this.isPredicate="predicate"===t.type,this.fixLayout(),this.rerender())),s.setCategory(t.blockCategory||"other"),t.fixBlockColor(),s.setSpec(e),s.parts().forEach((t=>{t instanceof vt||(i[r]&&(t.fragment=i[r]),r+=1)})),this.refreshPrototypeSlotTypes(),t.fixLayout()},gt.prototype.refreshPrototypeSlotTypes=function(){this.parts().forEach((t=>{t instanceof xt&&(t.template().instantiationSpec=t.contents(),t.setContents(t.fragment.defTemplateSpecFragment()))})),this.fixBlockColor(null,!0)},gt.prototype.inputFragmentNames=function(){var t=[];return this.parts().forEach((e=>{!e.fragment.isDeleted&&e.fragment.type&&t.push(e.fragment.labelString)})),t},gt.prototype.upvarFragmentNames=function(){var t=[];return this.parts().forEach((e=>{e.fragment.isDeleted||"%upvar"!==e.fragment.type||t.push(e.fragment.labelString)})),t},gt.prototype.upvarFragmentName=function(t){return this.upvarFragmentNames()[t]||"↑"},gt.prototype.specFromFragments=function(){var t="";return this.parts().forEach((e=>{e.fragment.isDeleted||(t=t+e.fragment.defSpecFragment()+" ")})),t.trim()},gt.prototype.blockSpecFromFragments=function(){var t="";return this.parts().forEach((e=>{e.fragment.isDeleted||(t=t+e.fragment.blockSpecFragment()+" ")})),t.trim()},gt.prototype.declarationsFromFragments=function(){var t=new Map;return this.parts().forEach((e=>{e instanceof xt&&t.set(e.fragment.labelString,[e.fragment.type,e.fragment.defaultValue,e.fragment.options,e.fragment.isReadOnly])})),t},gt.prototype.parseSpec=function(t){return this.isPrototype?ft.prototype.parseSpec(t):gt.uber.parseSpec.call(this,t)},gt.prototype.mouseClickLeft=function(){if(!this.isPrototype)return gt.uber.mouseClickLeft.call(this);this.edit()},gt.prototype.labelPart=function(t){var e;return this.isPrototype?("%"===t[0]&&t.length>1?e=new xt(t.replace(/%/g,"")):((e=new St(t)).fontSize=this.fontSize,e.color=o.Cj,e.isBold=!0,e.shadowColor=this.color.darker(this.labelContrast),e.shadowOffset=this.embossing,e.fixLayout(),e.rerender()),e):gt.uber.labelPart.call(this,t)},gt.prototype.placeHolder=function(){var t;return(t=new vt).fontSize=1.4*this.fontSize,t.color=new o.Il(45,45,45),t.fixLayout(),t},gt.prototype.attachTargets=function(){return this.isPrototype?[]:gt.uber.attachTargets.call(this)},gt.prototype.relabel=function(t){var e=new o.wR(this),i=this.inputs().map((t=>t.fullCopy()));t.forEach((t=>{var s=t.blockInstance();s.restoreInputs(i),s.fixBlockColor(null,!0),s.addShadow(new o.E9(3,3)),e.addItem(s.doWithAlpha(1,(()=>s.fullImage())),(()=>{this.definition=t,this.refresh()}))})),e.popup(this.world(),this.bottomLeft().subtract(new o.E9(8,this instanceof R?this.corner:0)))},gt.prototype.alternatives=function(){var t=this.scriptTarget(),e=t.parentThatIsA(b),o=t.customBlocks.concat(e.globalBlocks),i=this instanceof R?"command":this.isPredicate?"predicate":"reporter";return o.filter((t=>t!==this.definition&&t.type===i))},yt.prototype=new D,yt.prototype.constructor=yt,yt.uber=D.prototype,yt.prototype.isCustomBlock=!0,yt.prototype.init=function(t,e,o){this.definition=t,this.semanticSpec="",this.isGlobal=!!t&&t.isGlobal,this.isPrototype=o||!1,yt.uber.init.call(this,e,!0),this.category=t.category,this.storedTranslations=null,this.variables=new p,this.initializeVariables(),this.selector="evaluateCustomBlock",t&&this.refresh()},yt.prototype.initializeVariables=gt.prototype.initializeVariables,yt.prototype.refresh=function(t){var e=t||this.definition;gt.prototype.refresh.call(this,t,!0),this.isPrototype||(this.isPredicate="predicate"===e.type),this.parent instanceof I&&(this.parent.cachedInputs=null),this.fixLayout()},yt.prototype.mouseClickLeft=function(){if(!this.isPrototype)return yt.uber.mouseClickLeft.call(this);this.edit()},yt.prototype.placeHolder=gt.prototype.placeHolder,yt.prototype.parseSpec=gt.prototype.parseSpec,yt.prototype.edit=gt.prototype.edit,yt.prototype.labelPart=gt.prototype.labelPart,yt.prototype.upvarFragmentNames=gt.prototype.upvarFragmentNames,yt.prototype.upvarFragmentName=gt.prototype.upvarFragmentName,yt.prototype.inputFragmentNames=gt.prototype.inputFragmentNames,yt.prototype.specFromFragments=gt.prototype.specFromFragments,yt.prototype.blockSpecFromFragments=gt.prototype.blockSpecFromFragments,yt.prototype.declarationsFromFragments=gt.prototype.declarationsFromFragments,yt.prototype.refreshPrototype=gt.prototype.refreshPrototype,yt.prototype.refreshPrototypeSlotTypes=gt.prototype.refreshPrototypeSlotTypes,yt.prototype.restoreInputs=gt.prototype.restoreInputs,yt.prototype.refreshDefaults=gt.prototype.refreshDefaults,yt.prototype.isInUse=gt.prototype.isInUse,yt.prototype.userMenu=gt.prototype.userMenu,yt.prototype.duplicateBlockDefinition=gt.prototype.duplicateBlockDefinition,yt.prototype.deleteBlockDefinition=gt.prototype.deleteBlockDefinition,yt.prototype.exportBlockDefinition=gt.prototype.exportBlockDefinition,yt.prototype.bubbleHelp=gt.prototype.bubbleHelp,yt.prototype.popUpbubbleHelp=gt.prototype.popUpbubbleHelp,yt.prototype.relabel=gt.prototype.relabel,yt.prototype.alternatives=gt.prototype.alternatives,mt.prototype=new D,mt.prototype.constructor=mt,mt.uber=D.prototype,mt.prototype.init=function(t){mt.uber.init.call(this),t&&this.setSpec(t),"%cs"!==t&&"%ca"!==t||(this.minWidth=25,this.fixLayout())},mt.prototype.outlinePath=function(t,e){var o,i,s,r,n=this.width(),a=this.position(),h=0;for(t.moveTo(e,e),t.lineTo(n-e,e),this.cSlots().forEach((o=>{o.outlinePath(t,e,o.position().subtract(a)),h+=o.height()})),s=(o=this.height()-h-e)/(i=Math.round(o/this.jag)),r=0;r<i;r+=1)h+=s/2,t.lineTo(n-this.jag/2-e,h),h+=s/2,t.lineTo(n-e,h);for(s=(o=this.height()-e)/(i=Math.round(o/this.jag)),t.lineTo(e,o-e),h=o,r=0;r<i;r+=1)h-=s/2,t.lineTo(this.jag/2+e,h),h-=s/2,t.lineTo(e,h)},mt.prototype.drawEdges=function(t){var e,o,i,s=this.width(),r=this.height(),n=Math.round(r/this.jag),a=r/n,h=this.edge/2;if(t.lineWidth=this.edge,t.lineJoin="round",t.lineCap="round",(e=t.createLinearGradient(0,0,0,this.edge)).addColorStop(0,this.cachedClrBright),e.addColorStop(1,this.cachedClr),t.strokeStyle=e,t.beginPath(),t.moveTo(h,h),t.lineTo(s-h,h),t.stroke(),!this.cSlots().length)for(i=0,o=0;o<n;o+=1)t.strokeStyle=this.cachedClrDark,t.beginPath(),t.moveTo(s-h,i),i+=a/2,t.lineTo(s-this.jag/2-h,i),t.stroke(),i+=a/2;for((e=t.createLinearGradient(0,r-this.edge,0,r)).addColorStop(0,this.cachedClr),e.addColorStop(1,this.cachedClrDark),t.strokeStyle=e,t.beginPath(),t.moveTo(s-h,r-h),t.lineTo(h,r-h),t.stroke(),i=r,o=0;o<n;o+=1)t.strokeStyle=this.cachedClrBright,t.beginPath(),t.moveTo(h,i),i-=a/2,t.lineTo(this.jag/2+h,i),t.stroke(),i-=a/2},bt.prototype=new lt,bt.prototype.constructor=bt,bt.uber=lt.prototype,bt.prototype.init=function(t,e,i){this.blockType="command",this.category="other",this.isGlobal=!0,this.types=null,this.categories=null,bt.uber.init.call(this,t,e,i),this.key="makeABlock",this.types=new pt("row",this.padding),this.add(this.types),this.scopes=new pt("row",this.padding),this.add(this.scopes),this.categories=new o.RC,this.categories.color=y.prototype.paletteColor.lighter(8),this.categories.borderColor=this.categories.color.lighter(40),this.createCategoryButtons(),this.fixCategoriesLayout(),this.add(this.categories),this.createTypeButtons(),this.createScopeButtons(),this.fixLayout()},bt.prototype.prompt=function(){bt.uber.prompt.apply(this,arguments)},bt.prototype.ok=function(){bt.uber.ok.apply(this,arguments)},bt.prototype.cancel=function(){bt.uber.cancel.apply(this,arguments)},bt.prototype.openForChange=function(t,e,o,i,s,r){var n=y.prototype.blockColor[e];this.key="changeABlock",this.category=e,this.blockType=o,this.categories.children.forEach((t=>t.refresh())),this.types.children.forEach((t=>{t.setColor(n),t.refresh()})),this.labelString=t,this.createLabel(),s&&this.setPicture(s),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),r&&(this.types.destroy(),this.types=null),this.scopes.destroy(),this.scopes=null,this.fixLayout(),this.rerender(),this.popUp(i)},bt.prototype.createCategoryButtons=function(){y.prototype.categories.forEach((t=>this.addCategoryButton(t)))},bt.prototype.fixCategoriesLayout=function(){var t,e,i=this.categories.children[0].width(),s=this.categories.children[0].height(),r=Math.ceil(this.categories.children.length/2),n=this.categories.left(),a=this.categories.top(),h=0;this.categories.children.forEach((r=>{h+=1,t=Math.ceil(h/2),e=2-h%2,r.setPosition(new o.E9(n+(15*e+(e-1)*i),a+(2*t+(t-1)*s+10)))})),o.tU.isFlat&&(this.categories.corner=0,this.categories.border=0,this.categories.edge=0),this.categories.setExtent(new o.E9(45+2*i,2*(r+1)+r*s+20))},bt.prototype.createTypeButtons=function(){var t,e=y.prototype.blockColor[this.category];(t=new R).setColor(e),t.setSpec((0,o.NC)("Command")),this.addBlockTypeButton((()=>this.setType("command")),t,(()=>"command"===this.blockType)),(t=new D).setColor(e),t.setSpec((0,o.NC)("Reporter")),this.addBlockTypeButton((()=>this.setType("reporter")),t,(()=>"reporter"===this.blockType)),(t=new D(!0)).setColor(e),t.setSpec((0,o.NC)("Predicate")),this.addBlockTypeButton((()=>this.setType("predicate")),t,(()=>"predicate"===this.blockType))},bt.prototype.addBlockTypeButton=function(t,e,o){var i=new ht(this,t,e,o,null,null,"rebuild");return i.refresh(),i.fixLayout(),this.types.add(i),i},bt.prototype.addTypeButton=function(t,e,o){var i=new at("radiobutton",this,t,e,o);return i.edge=this.buttonEdge/2,i.outline=this.buttonOutline/2,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.contrast=this.buttonContrast,i.fixLayout(),this.types.add(i),i},bt.prototype.setType=function(t){this.blockType=t||this.blockType,this.types.children.forEach((t=>t.refresh())),this.edit()},bt.prototype.createScopeButtons=function(){this.addScopeButton((()=>this.setScope("global")),"for all sprites",(()=>this.isGlobal)),this.addScopeButton((()=>this.setScope("local")),"for this sprite only",(()=>!this.isGlobal))},bt.prototype.addScopeButton=function(t,e,o){var i=new at("radiobutton",this,t,e,o);return i.edge=this.buttonEdge/2,i.outline=this.buttonOutline/2,i.outlineColor=this.buttonOutlineColor,i.outlineGradient=this.buttonOutlineGradient,i.contrast=this.buttonContrast,i.fixLayout(),this.scopes.add(i),i},bt.prototype.setScope=function(t){this.isGlobal="global"===t,this.scopes.children.forEach((t=>t.refresh())),this.edit()},bt.prototype.getInput=function(){var t,e,o;return this.body instanceof ct&&(t=this.normalizeSpaces(this.body.getValue())),(e=new ft(t)).type=this.blockType,e.category=this.category,e.isGlobal=this.isGlobal,"reporter"!==e.type&&"predicate"!==e.type||((o=a.prototype.reify.call(null,y.prototype.blockForSelector("doReport"),new d,!0)).outerContext=null,e.body=o),e},bt.prototype.fixLayout=function(){var t=(0,o.SW)(this.titleFontSize)+2*this.titlePadding;this.body?(this.body.setPosition(this.position().add(new o.E9(this.padding,t+this.padding))),this.bounds.setWidth(this.body.width()+2*this.padding),this.bounds.setHeight(this.body.height()+2*this.padding+t),this.categories&&(this.categories.setCenter(this.body.center()),this.categories.setTop(this.body.top()),this.body.setTop(this.categories.bottom()+this.padding),this.bounds.setHeight(this.height()+this.categories.height()+this.padding))):this.head&&(this.types?(this.types.fixLayout(),this.bounds.setWidth(Math.max(this.types.width(),this.head.width())+2*this.padding)):this.bounds.setWidth(Math.max(this.categories.width(),this.head.width())+2*this.padding),this.head.setCenter(this.center()),this.head.setTop(t+this.padding),this.bounds.setHeight(this.head.height()+2*this.padding+t),this.categories&&(this.categories.setCenter(this.center()),this.categories.setTop(this.head.bottom()+this.padding),this.bounds.setHeight(this.height()+this.categories.height()+this.padding))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.types&&(this.types.fixLayout(),this.bounds.setHeight(this.height()+this.types.height()+this.padding),this.bounds.setWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+this.padding)),this.scopes&&(this.scopes.fixLayout(),this.bounds.setHeight(this.height()+this.scopes.height()+this.padding/3),this.bounds.setWidth(Math.max(this.width(),this.scopes.width()+2*this.padding)),this.scopes.setCenter(this.center()),this.types&&this.scopes.setTop(this.types.bottom()+this.padding/3)),this.buttons&&this.buttons.children.length>0&&(this.buttons.fixLayout(),this.bounds.setHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),this.removeShadow(),this.addShadow()},bt.prototype.accept=function(){this.body instanceof ct&&""===this.normalizeSpaces(this.body.getValue())?this.edit():bt.uber.accept.call(this)},wt.prototype=new F,wt.prototype.constructor=wt,wt.uber=F.prototype,wt.prototype.init=function(t){var e,o=t.prototypeInstance();this.definition=t,this.blockCategory=t?t.category:null,this.type=t?t.type:null,F.uber.init.call(this),this.color=y.prototype.blockColor.control,this.category="control",this.add(o),t.variableNames.length&&(e=this.labelPart("%blockVars"),this.add(this.labelPart("%br")),this.add(e),t.variableNames.forEach((t=>e.addInput(t)))),o.refreshPrototypeSlotTypes(),this.fixLayout(),o.fixBlockColor(this,!0)},wt.prototype.mouseClickLeft=function(){if(16===this.world().currentKey)return this.focus();this.parts()[0].mouseClickLeft()},wt.prototype.userMenu=function(){return this.parts()[0].userMenu()},wt.prototype.fixBlockColor=function(t,e){var o=this.parts()[0]||t;if(this.zebraContrast||e){if(!this.zebraContrast&&e)return this.forceNormalColoring();o.category===this.category?o.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(y.prototype.blockColor[this.category])&&this.alternateBlockColor(),e&&this.fixChildrensBlockColor(!0)}},wt.prototype.variableNames=function(t){var e=this.parts();return e.length<3?[]:e[2].evaluate()},wt.prototype.enableBlockVars=function(t){var e=this.parts()[0];!1===t?this.setSpec("%s",!0):this.setSpec("%s %br %blockVars",!0),this.replaceInput(this.parts()[0],e),this.spec=null},Ct.prototype.defSpecFragment=function(){var t=this.type?"%'":"";return this.isDeleted?"":t+this.labelString+(this.type?"'":"")},Ct.prototype.defTemplateSpecFragment=function(){var t="";return this.type?(this.isUpvar()?t=" ↑":this.isMultipleInput()?t="...":"%cs"===this.type||"%ca"===this.type?t=" λ":"%b"===this.type?t=" ?":"%l"===this.type?t=" ︙":"%obj"===this.type?t=" %turtleOutline":(0,o.r3)(["%cmdRing","%repRing","%predRing","%anyUE","%boolUE"],this.type)?t=" λ":this.defaultValue?t="%n"===this.type?" # = "+this.defaultValue.toString():(0,o.r3)(["%mlt","%code"],this.type)?" ¶ = "+this.defaultValue.toString():" = "+this.defaultValue.toString():"%n"===this.type?t=" #":(0,o.r3)(["%mlt","%code"],this.type)&&(t=" ¶"),this.labelString+t):this.defSpecFragment()},Ct.prototype.blockSpecFragment=function(){return this.isDeleted?"":this.type||this.labelString},Ct.prototype.copy=function(){var t=new Ct(this.labelString);return t.type=this.type,t.defaultValue=this.defaultValue,t.options=this.options,t.isReadOnly=this.isReadOnly,t},Ct.prototype.hasOptions=function(){return""!==this.options&&!this.hasSpecialMenu()},Ct.prototype.hasSpecialMenu=function(){return(0,o.r3)(["§_messagesMenu","§_messagesReceivedMenu","§_objectsMenu","§_costumesMenu","§_soundsMenu","§_getVarNamesDict","§_pianoKeyboardMenu","§_directionDialMenu"],this.options)},Ct.prototype.isSingleInput=function(){return!this.isMultipleInput()&&"%upvar"!==this.type},Ct.prototype.isMultipleInput=function(){return!!this.type&&this.type.indexOf("%mult")>-1},Ct.prototype.isUpvar=function(){return!!this.type&&"%upvar"===this.type},Ct.prototype.setToSingleInput=function(){if(!this.type)return null;"%upvar"===this.type?this.type="%s":this.type=this.singleInputType()},Ct.prototype.setToMultipleInput=function(){if(!this.type)return null;"%upvar"===this.type?this.type="%s":"%ca"===this.type&&(this.type="%cs"),this.type="%mult".concat(this.singleInputType())},Ct.prototype.setToUpvar=function(){if(!this.type)return null;this.type="%upvar"},Ct.prototype.singleInputType=function(){return this.type?this.isMultipleInput()?this.type.substr(5):this.type:null},Ct.prototype.setSingleInputType=function(t){this.type&&this.isMultipleInput()?this.type="%mult".concat(t):this.type=t},St.prototype=new o.XC,St.prototype.constructor=St,St.uber=o.XC.prototype,St.prototype.init=function(t){this.fragment=new Ct(t),this.fragment.type=null,this.sO=null,St.uber.init.call(this,t,null,I.prototype.labelFontStyle,null,null,null,null,null,null,I.prototype.labelFontName)},St.prototype.mouseEnter=function(){this.sO=this.shadowOffset,this.shadowOffset=this.sO.neg(),this.fixLayout(),this.rerender()},St.prototype.mouseLeave=function(){this.shadowOffset=this.sO,this.fixLayout(),this.rerender()},St.prototype.mouseClickLeft=function(){var t=this.fragment.copy(),e=this instanceof vt,o=this.parent.parseSpec(this.parent.blockSpec).length<2;new kt(t,null,(()=>this.updateBlockLabel(t)),this,this.parent.definition.category).open(this instanceof St?"Edit label fragment":e?"Create input name":"Edit input name",t.labelString,this.world(),null,e||o)},St.prototype.updateBlockLabel=function(t){var e=this.parentThatIsA(A);this.fragment=t,e&&e.refreshPrototype()},St.prototype.userMenu=function(){var t=new o.Il(100,100,130),e=new o.wR((t=>{var e=this.text.split("-");this.changed(),e[0]="$"+t,this.text=e.join("-"),this.fragment.labelString=this.text,this.parent.parent.changed(),this.fixLayout(),this.parent.parent.fixLayout(),this.parent.parent.changed()}),null,this,this.fontSize);return s.prototype.names.forEach((i=>e.addItem([new s(i,e.fontSize,t),(0,o.NC)(i)],i))),e.addLine(),e.addItem("⏎ "+(0,o.NC)("new line"),"nl"),e},vt.prototype=new o.XC,vt.prototype.constructor=vt,vt.uber=o.XC.prototype,vt.prototype.plainLabel=!1,vt.prototype.init=function(){this.fragment=new Ct(""),this.fragment.type="%s",this.fragment.isDeleted=!0,this.isHighlighted=!1,this.isProtectedLabel=!0,St.uber.init.call(this,"+")},vt.prototype.fixLayout=function(){this.plainLabel&&(this.text=this.isHighlighted?" + ":""),this.measureCtx.font=this.font(),this.bounds.corner=this.bounds.origin.add(new o.E9(Math.max(this.measureCtx.measureText(this.text).width,I.prototype.scale),(0,o.SW)(this.fontSize))),this.parent&&(this.parent.fixLayout&&this.parent.fixLayout(),this.parent.parent instanceof wt&&this.parent.parent.fixLayout())},vt.prototype.render=function(t){var e,i;this.isHighlighted&&(e=this.width()/2,i=this.height()/2,t.fillStyle=this.color.toString(),t.beginPath(),t.arc(e,1.2*i,Math.min(e,i),radians(0),radians(360),!1),t.closePath(),t.fill()),t.font=this.font(),t.textAlign="left",t.textBaseline="bottom",t.fillStyle=this.isHighlighted?"white":this.color.toString(),t.fillText(this.text,0,(0,o.SW)(this.fontSize))},vt.prototype.mouseEnter=function(){var t=this.parentThatIsA(wt);this.isHighlighted=!0,this.plainLabel&&t?(t.changed(),this.fixLayout(),t.changed()):(this.fixLayout(),this.rerender())},vt.prototype.mouseLeave=function(){var t=this.parentThatIsA(wt);this.isHighlighted=!1,this.plainLabel&&t?(t.changed(),this.fixLayout(),t.changed()):(this.fixLayout(),this.rerender())},vt.prototype.mouseClickLeft=St.prototype.mouseClickLeft,vt.prototype.updateBlockLabel=St.prototype.updateBlockLabel,xt.prototype=new G,xt.prototype.constructor=xt,xt.uber=G.prototype,xt.prototype.init=function(t){this.fragment=new Ct(t),this.fragment.type="%s",xt.uber.init.call(this,t)},xt.prototype.mouseClickLeft=St.prototype.mouseClickLeft,xt.prototype.updateBlockLabel=St.prototype.updateBlockLabel,kt.prototype=new lt,kt.prototype.constructor=kt,kt.uber=lt.prototype,kt.prototype.isLaunchingExpanded=!1;kt.prototype.init=function(t,e,i,s,r){var n=I.prototype.scale,a=(0,o.SW)(10)/1.2*n;this.fragment=t||new Ct,this.textfield=null,this.types=null,this.slots=null,this.isExpanded=!1,this.category=r||"other",this.noDelete=!1,bt.uber.init.call(this,e,i,s),this.types=new pt("row",this.padding),this.types.respectHiddens=!0,this.add(this.types),this.slots=new o.RC,this.slots.color=new o.Il(55,55,55),this.slots.borderColor=this.slots.color.lighter(50),this.slots.setExtent(new o.E9(24*(a+10),10.4*(a+10*n))),this.add(this.slots),this.createSlotTypeButtons(),this.fixSlotsLayout(),this.addSlotsMenu(),this.createTypeButtons(),this.fixLayout()},kt.prototype.createTypeButtons=function(){var t,e,i=y.prototype.blockColor[this.category];(t=new mt((0,o.NC)("Title text"))).setColor(i),this.addBlockTypeButton((()=>this.setType(null)),t,(()=>null===this.fragment.type)),(t=new mt("%inputName")).setColor(i),this.addBlockTypeButton((()=>this.setType("%s")),t,(()=>null!==this.fragment.type)),(e=new Y("right",st.prototype.fontSize+4,2)).noticesTransparentClick=!0,this.types.add(e),this.types.fixLayout(),e.refresh=()=>{null===this.fragment.type?(this.isExpanded=!1,e.hide()):(e.show(),this.isExpanded?e.direction="down":e.direction="right",e.fixLayout(),e.rerender())},e.mouseClickLeft=()=>{e.isVisible&&(this.isExpanded=!this.isExpanded,this.types.children.forEach((t=>t.refresh())),this.changed(),this.fixLayout(),this.rerender(),this.edit())},e.refresh()},kt.prototype.addTypeButton=bt.prototype.addTypeButton,kt.prototype.addBlockTypeButton=bt.prototype.addBlockTypeButton,kt.prototype.setType=function(t){this.textfield.choices=t?null:this.symbolMenu,this.textfield.fixLayout(),this.fragment.type=t||null,this.types.children.forEach((t=>t.refresh())),this.slots.children.forEach((t=>t.refresh())),(0,o.kK)(t)&&(this.isExpanded=!1,this.types.children.forEach((t=>t.refresh())),this.changed(),this.fixLayout(),this.rerender()),this.edit()},kt.prototype.getInput=function(){var t;return this.body instanceof ct&&(t=this.normalizeSpaces(this.body.getValue())),t?(this.fragment.labelString=t,(0,o.r3)(["%b","%boolUE"],this.fragment.type)?this.fragment.defaultValue=this.slots.defaultSwitch.evaluate():this.fragment.defaultValue=this.slots.defaultInputField.getValue(),t):(this.fragment.isDeleted=!0,null)},kt.prototype.fixLayout=function(){var t,e=this.left(),i=(0,o.SW)(this.titleFontSize)+2*this.titlePadding;if(!this.isExpanded)return this.slots&&this.slots.hide(),bt.prototype.fixLayout.call(this);this.slots.show(),t=this.slots.width(),this.body.setPosition(this.position().add(new o.E9(this.padding+(t-this.body.width())/2,i+this.padding))),this.label.setLeft(e+this.padding+(t-this.label.width())/2),this.label.setTop(this.top()+(i-this.label.height())/2),this.types.fixLayout(),this.types.setTop(this.body.bottom()+this.padding),this.types.setLeft(e+this.padding+(t-this.types.width())/2),this.slots.setPosition(new o.E9(this.left()+this.padding,this.types.bottom()+this.padding)),this.slots.children.forEach((t=>t.refresh())),this.buttons.fixLayout(),this.buttons.setTop(this.slots.bottom()+this.padding),this.buttons.setLeft(e+this.padding+(t-this.buttons.width())/2),this.bounds.setHeight(this.buttons.bottom()-this.top()+this.padding),this.bounds.setWidth(this.slots.right()-this.left()+this.padding),this.removeShadow(),this.addShadow()},kt.prototype.open=function(t,e,o,i,s){var r=new ct(e);this.fragment.type||(r.choices=this.symbolMenu),this.isExpanded=this.isLaunchingExpanded,r.setWidth(250),this.labelString=t,this.createLabel(),i&&this.setPicture(i),this.addBody(r),this.textfield=r,this.addButton("ok","OK"),s?this.noDelete=!0:this.addButton("deleteFragment","Delete"),this.addButton("cancel","Cancel"),this.fixLayout(),this.popUp(o),this.add(this.types),this.changed()},kt.prototype.symbolMenu=function(){var t=[],e=new o.Il(100,100,130);return s.prototype.names.forEach((i=>t.push([[new s(i,this.fontSize,e),(0,o.NC)(i)],"$"+i]))),t.push(["⏎ "+(0,o.NC)("new line"),"$nl"]),t},kt.prototype.deleteFragment=function(){this.fragment.isDeleted=!0,this.accept()},kt.prototype.createSlotTypeButtons=function(){var t,e,i,r,n;this.addSlotTypeButton("Object","%obj"),this.addSlotTypeButton("Text","%txt"),this.addSlotTypeButton("List","%l"),this.addSlotTypeButton("Number","%n"),this.addSlotTypeButton("Any type","%s"),this.addSlotTypeButton("Boolean (T/F)","%b"),this.addSlotTypeButton("Command\n(inline)","%cmdRing"),this.addSlotTypeButton("Reporter","%repRing"),this.addSlotTypeButton("Predicate","%predRing"),this.addSlotTypeButton("Command\n(C-shape)",["%cs","%ca"]),this.addSlotTypeButton("Any\n(unevaluated)","%anyUE"),this.addSlotTypeButton("Boolean\n(unevaluated)","%boolUE"),this.slots.radioButtonSingle=this.addSlotArityButton((()=>this.setSlotArity("single")),"Single input.",(()=>this.fragment.isSingleInput())),this.addSlotArityButton((()=>this.setSlotArity("multiple")),"Multiple inputs (value is list of inputs)",(()=>this.fragment.isMultipleInput())),this.addSlotArityButton((()=>this.setSlotArity("upvar")),"Upvar - make internal variable visible to caller",(()=>this.fragment.isUpvar())),(t=new o.XC((0,o.NC)("Default Value:"))).fontSize=this.slots.radioButtonSingle.fontSize,t.setColor(o.Cj),t.refresh=()=>{this.isExpanded&&(0,o.r3)(["%s","%n","%txt","%anyUE","%b","%boolUE","%mlt","%code"],this.fragment.type)?t.show():t.hide()},this.slots.defaultInputLabel=t,this.slots.add(t),(e=new ct(this.fragment.defaultValue)).contents().fontSize=t.fontSize,e.contrast=90,e.setWidth(50),e.refresh=()=>{this.isExpanded&&(0,o.r3)(["%s","%n","%txt","%anyUE","%mlt","%code"],this.fragment.type)?(e.show(),"%n"===this.fragment.type?e.setIsNumeric(!0):e.setIsNumeric(!1)):e.hide()},this.slots.defaultInputField=e,this.slots.add(e),(i=new q(this.fragment.defaultValue)).refresh=()=>{this.isExpanded&&(0,o.r3)(["%b","%boolUE"],this.fragment.type)?i.show():i.hide()},this.slots.defaultSwitch=i,this.slots.add(i),(r=new at("checkbox",this,(()=>{"%ca"===this.fragment.type?this.setType("%cs"):this.setType("%ca")}),null,(()=>"%ca"===this.fragment.type),null,null,new s("loop",.7*this.fontSize,o.Cj).getImage(),null)).refresh=()=>{at.prototype.refresh.call(r),this.isExpanded&&(0,o.r3)(["%cs","%ca"],this.fragment.type)?r.show():r.hide()},this.slots.loopArrow=r,this.slots.add(r),(n=new st(this.slots,(()=>this.slots.userMenu().popUpAtHand(this.world())),new s("gearPartial",1.5*this.fontSize))).padding=0,n.fixLayout(),n.refresh=o.WY,this.slots.settingsButton=n,this.slots.add(n)},kt.prototype.setSlotType=function(t){this.fragment.setSingleInputType(t),this.slots.children.forEach((t=>t.refresh())),this.edit()},kt.prototype.setSlotArity=function(t){"single"===t?this.fragment.setToSingleInput():"multiple"===t?this.fragment.setToMultipleInput():"upvar"===t&&this.fragment.setToUpvar(),this.slots.children.forEach((t=>t.refresh())),this.edit()},kt.prototype.setSlotOptions=function(t){this.fragment.options=t},kt.prototype.addSlotTypeButton=function(t,e){var i,s,r=new mt(e instanceof Array?e[0]:e);return i=()=>e instanceof Array?(0,o.r3)(e,this.fragment.singleInputType()):this.fragment.singleInputType()===e,r.setCategory(this.category),r.rebuild(),(s=new at("radiobutton",this,(()=>{this.setSlotType(e instanceof Array?e[0]:e)}),t,i,null,null,r.doWithAlpha(1,(()=>r.fullImage())),"rebuild")).edge=this.buttonEdge/2,s.outline=this.buttonOutline/2,s.outlineColor=this.buttonOutlineColor,s.outlineGradient=this.buttonOutlineGradient,s.fixLayout(),s.label.isBold=!1,s.label.setColor(o.Cj),this.slots.add(s),s},kt.prototype.addSlotArityButton=function(t,e,i){var s=new at("radiobutton",this,t,e,i,null,null);return s.edge=this.buttonEdge/2,s.outline=this.buttonOutline/2,s.outlineColor=this.buttonOutlineColor,s.outlineGradient=this.buttonOutlineGradient,s.fixLayout(),s.label.setColor(o.Cj),this.slots.add(s),s},kt.prototype.fixSlotsLayout=function(){var t,e,i=this.slots,s=I.prototype.scale,r=10*s,n=14*s,a=((0,o.SW)(10)/1.2+15)*s,h=((0,o.SW)(10)/1.2+10)*s,l=[i.left()+r,i.left()+i.width()/3,i.left()+2*i.width()/3],p=[i.top()+n,i.top()+n+a,i.top()+n+2*a,i.top()+n+3*a,i.top()+n+4*a,i.top()+n+5*a,i.top()+n+5*a+h,i.top()+n+5*a+2*h],c=-1;for(t=0;t<12;t+=1)e=t%3,t%3==0&&(c+=1),i.children[t].setPosition(new o.E9(l[e],p[c]));for(e=0,c=5,t=12;t<15;t+=1)i.children[t].setPosition(new o.E9(l[e],p[c+t-12]));this.slots.defaultInputLabel.setPosition(this.slots.radioButtonSingle.label.topRight().add(new o.E9(5,0))),this.slots.defaultInputField.setCenter(this.slots.defaultInputLabel.center().add(new o.E9(this.slots.defaultInputField.width()/2+this.slots.defaultInputLabel.width()/2+5,0))),this.slots.defaultSwitch.setCenter(this.slots.defaultInputLabel.center().add(new o.E9(this.slots.defaultSwitch.width()/2+this.slots.defaultInputLabel.width()/2+5,0))),this.slots.loopArrow.setPosition(this.slots.defaultInputLabel.position()),this.slots.settingsButton.setPosition(this.slots.bottomRight().subtract(this.slots.settingsButton.extent().add(this.padding+this.slots.border))),this.slots.changed()},kt.prototype.addSlotsMenu=function(){this.slots.userMenu=()=>{if((0,o.r3)(["%s","%n","%txt","%anyUE","%mlt","%code"],this.fragment.type)){var t=new o.wR(this),e="☑ ",i="☐ ";return t.addItem((this.fragment.hasOptions()?e:i)+(0,o.NC)("options")+"...","editSlotOptions"),t.addItem((this.fragment.isReadOnly?e:i)+(0,o.NC)("read-only"),(()=>this.fragment.isReadOnly=!this.fragment.isReadOnly)),t.addLine(),t.addMenu((this.fragment.hasSpecialMenu()?e:i)+(0,o.NC)("menu"),this.specialOptionsMenu()),t.addMenu(((0,o.r3)(["%mlt","%code"],this.fragment.type)?e:i)+(0,o.NC)("special"),this.specialSlotsMenu()),t}return this.specialSlotsMenu()}},kt.prototype.editSlotOptions=function(){new lt(this,(t=>this.fragment.options=t.trim()),this).promptCode("Input Slot Options",this.fragment.options,this.world(),null,(0,o.NC)('Enter one option per line.\nOptionally use "=" as key/value delimiter and {} for submenus. e.g.\n   the answer=42'))},kt.prototype.specialSlotsMenu=function(){var t=new o.wR(this.setSlotType,null,this),e=this;function i(i,s){t.addItem((e.fragment.type===s?"⚫ ":"⚪ ")+(0,o.NC)(i),s)}return i("multi-line","%mlt"),i("code","%code"),t},kt.prototype.specialOptionsMenu=function(){var t=new o.wR(this.setSlotOptions,null,this),e=this;function i(i,s){t.addItem((e.fragment.options===s?"⚫ ":"⚪ ")+(0,o.NC)(i),s)}return i("(none)",""),i("messages","§_messagesMenu"),i("objects","§_objectsMenu"),i("costumes","§_costumesMenu"),i("sounds","§_soundsMenu"),i("variables","§_getVarNamesDict"),i("piano keyboard","§_pianoKeyboardMenu"),i("360° dial","§_directionDialMenu"),t},kt.prototype.hide=function(){this.isVisible=!1,this.changed()},kt.prototype.show=function(){this.isVisible=!0,this.changed()},Mt.prototype=new lt,Mt.prototype.constructor=Mt,Mt.uber=lt.prototype,Mt.prototype.init=function(t,e,o){this.types=null,this.isGlobal=!0,bt.uber.init.call(this,t,e,o),this.types=new pt("row",this.padding),this.add(this.types),this.createTypeButtons()},Mt.prototype.createTypeButtons=function(){this.addTypeButton((()=>this.setType("global")),"for all sprites",(()=>this.isGlobal)),this.addTypeButton((()=>this.setType("local")),"for this sprite only",(()=>!this.isGlobal))},Mt.prototype.addTypeButton=bt.prototype.addTypeButton,Mt.prototype.setType=function(t){this.isGlobal="global"===t,this.types.children.forEach((t=>t.refresh())),this.edit()},Mt.prototype.getInput=function(){var t=this.normalizeSpaces(this.body.getValue());return t?[t,this.isGlobal]:null},Mt.prototype.fixLayout=function(){var t=(0,o.SW)(this.titleFontSize)+2*this.titlePadding;this.body&&(this.body.setPosition(this.position().add(new o.E9(this.padding,t+this.padding))),this.bounds.setWidth(this.body.width()+2*this.padding),this.bounds.setHeight(this.body.height()+2*this.padding+t)),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.types&&(this.types.fixLayout(),this.bounds.setHeight(this.height()+this.types.height()+this.padding),this.bounds.setWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+this.padding)),this.buttons&&this.buttons.children.length>0&&(this.buttons.fixLayout(),this.bounds.setHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),this.removeShadow(),this.addShadow()},Tt.prototype=new lt,Tt.prototype.constructor=Tt,Tt.uber=lt.prototype,Tt.prototype.key="blockExport",Tt.prototype.init=function(t,e){this.serializer=t,this.blocks=e.slice(0),this.handle=null,Tt.uber.init.call(this,null,(()=>this.exportBlocks()),null),this.labelString="Export blocks",this.createLabel(),this.buildContents()},Tt.prototype.buildContents=function(){var t,e,i,s,r,n;(t=new o.yR(null,null,y.prototype.sliderColor)).color=y.prototype.paletteColor,t.padding=4,t.isDraggable=!1,t.acceptsDrops=!1,t.contents.acceptsDrops=!1,e=t.left()+4,i=t.top()+4,y.prototype.categories.forEach((a=>{this.blocks.forEach((h=>{h.category===a&&(n&&a!==n&&(i+=4),n=a,s=h.templateInstance(),(r=new at("checkbox",this,(()=>{var t=this.blocks.indexOf(h);t>-1?this.blocks.splice(t,1):this.blocks.push(h)}),null,(()=>(0,o.r3)(this.blocks,h)),null,null,s.fullImage())).setPosition(new o.E9(e,i+(r.top()-r.toggleElement.top()))),t.addContents(r),i+=r.fullBounds().height()+4)}))})),t.scrollX(4),t.scrollY(4),this.addBody(t),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.setExtent(new o.E9(220,300)),this.fixLayout()},Tt.prototype.popUp=function(t){var e=t||this.target.world();e&&(Tt.uber.popUp.call(this,e),this.handle=new o.LG(this,200,220,this.corner,this.corner))},Tt.prototype.userMenu=function(){var t=new o.wR(this,"select");return t.addItem("all","selectAll"),t.addItem("none","selectNone"),t},Tt.prototype.selectAll=function(){this.body.contents.children.forEach((t=>{t.state||t.trigger()}))},Tt.prototype.selectNone=function(){this.blocks=[],this.body.contents.children.forEach((t=>{t.refresh()}))},Tt.prototype.exportBlocks=function(){var t=this.serializer.serialize(this.blocks,!0),e=this.world().children[0];this.blocks.length>0?(t='<blocks app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+t+"</blocks>",e.saveXMLAs(t,(e.projectName||(0,o.NC)("untitled"))+" "+(0,o.NC)("blocks"))):(new lt).inform("Export blocks","no blocks were selected",this.world())},Bt.prototype=new lt,Bt.prototype.constructor=Bt,Bt.uber=lt.prototype,Bt.prototype.key="blockImport",Bt.prototype.init=function(t,e,i){this.blocks=t.slice(0),this.handle=null,Tt.uber.init.call(this,e,(()=>this.importBlocks(i)),null),this.labelString=(0,o.NC)("Import blocks")+(i?": ":"")+i||"",this.createLabel(),this.buildContents()},Bt.prototype.buildContents=Tt.prototype.buildContents,Bt.prototype.popUp=Tt.prototype.popUp,Bt.prototype.userMenu=Tt.prototype.userMenu,Bt.prototype.selectAll=Tt.prototype.selectAll,Bt.prototype.selectNone=Tt.prototype.selectNone,Pt.prototype=new lt,Pt.prototype.constructor=Bt,Pt.uber=lt.prototype,Pt.prototype.key="blockRemove",Pt.prototype.init=function(t,e){this.blocks=t.slice(0),this.handle=null,Tt.uber.init.call(this,e,(()=>this.removeBlocks()),null),this.labelString=(0,o.NC)("Remove unused blocks")+(name?": ":"")+name||"",this.createLabel(),this.buildContents()},Pt.prototype.buildContents=Tt.prototype.buildContents,Pt.prototype.popUp=Tt.prototype.popUp,Pt.prototype.userMenu=Tt.prototype.userMenu,Pt.prototype.selectAll=Tt.prototype.selectAll,Pt.prototype.selectNone=Tt.prototype.selectNone,Pt.prototype.removeBlocks=function(){var t=this.target.parentThatIsA(IDE_Morph);t&&(this.blocks.length>0?(this.blocks.forEach((e=>{var o=t.stage.globalBlocks.indexOf(e);-1!==o&&t.stage.globalBlocks.splice(o,1)})),t.flushPaletteCache(),t.refreshPalette(),t.showMessage(this.blocks.length+" "+(0,o.NC)("unused block(s) removed"),2)):(new lt).inform("Remove unused blocks","no blocks were selected",this.world()))},o.qz.tables="2020-October-06",It.prototype.demo=function(t){this.fillWithTestData(),new Rt(this).popUp(t)},It.prototype.changed=function(){this.lastChanged=Date.now()},It.prototype.get=function(t,e){return t?e?t>this.colCount||e>this.rowCount?null:(this.contents[e-1]||[])[t-1]:this.colName(t):e?this.rowName(e):[this.rowCount]},It.prototype.row=function(t){return this.contents[t-1]},It.prototype.col=function(t){var e,o=[],i=t-1;for(e=0;e<this.rowCount;e+=1)o.push(this.contents[e][i]);return o},It.prototype.colName=function(t){if(t>this.colCount)return null;var e=this.colNames[t-1];return void 0!==e?e:String.fromCharCode(64+(t%26||26)).repeat(Math.floor((t-1)/26)+1)},It.prototype.rowName=function(t){return t>this.rowCount?null:this.rowNames[t-1]||t},It.prototype.rows=function(){return this.rowCount},It.prototype.cols=function(){return this.colCount},It.prototype.columnNames=function(){return this.colNames},It.prototype.set=function(t,e,o){this.contents[o-1][e-1]=t,this.changed()},It.prototype.setRows=function(t,e,o){this.contents=t,e&&(this.colNames=e),o&&(this.rowNames=o),this.changed()},It.prototype.setCols=function(t,e,o){var i,s;for(s=0;s<this.colCount;s+=1)for(i=0;i<this.rowCount;i+=1)this.contents[i][s]=t[s][i];e&&(this.colNames=e),o&&(this.rowNames=o),this.changed()},It.prototype.setColNames=function(t){this.colNames=t||[],this.changed()},It.prototype.setRowNames=function(t){this.rowNames=t||[],this.changed()},It.prototype.setColName=function(t,e){this.colNames[t+1]=e,this.changed()},It.prototype.setRowName=function(t,e){this.rowNames[t+1]=e,this.changed()},It.prototype.addRow=function(t,e){this.contents[this.rowCount]=t||new Array(this.rowCount),this.rowNames[this.rowCount]=e,this.rowCount+=1,this.changed()},It.prototype.addCol=function(t,e){var o;if(t)for(o=0;o<this.col;o+=1)this.contents[o][this.colCount]=t[o];this.colNames[this.colCount]=e,this.colCount+=1,this.changed()},It.prototype.toList=function(){return new d(this.contents.map((t=>new d(t))))},It.prototype.fillWithTestData=function(){var t,e;for(t=1;t<=this.colCount;t+=1)for(e=1;e<=this.rowCount;e+=1)this.set(this.colName(t)+this.rowName(e),t,e)},Et.prototype=new o._V,Et.prototype.constructor=Et,Et.uber=o._V.prototype,Et.prototype.cachedListSymbol=null,Et.prototype.listSymbol=function(){return this.cachedListSymbol&&this.cachedListSymbol.height()===I.prototype.fontSize||(this.cachedListSymbol=new s("list",I.prototype.fontSize,y.prototype.blockColor.lists.darker(50))),this.cachedListSymbol.getImage()},Et.prototype.init=function(t,e,o){this.data=t,this.isLabel=o||!1,this.labelString=null,Et.uber.init.call(this,!0),e&&this.bounds.setExtent(e),this.fixLayout()},Et.prototype.setData=function(t,e){this.data=t,e&&!e.eq(this.extent())&&this.bounds.setExtent(e),this.rerender()},Et.prototype.getData=function(){return this.data instanceof Array?this.data[0]:this.data},Et.prototype.render=function(t){var e,i,s,r,n=this.labelString||this.dataRepresentation(this.data),a=I.prototype.fontSize,h=Lt.prototype.highContrast?"rgb(220, 220, 220)":"transparent",l=(this.isLabel?this.data instanceof Array?"italic":"":this.shouldBeList()?"bold":"")+" "+a+"px Helvetica, Arial, sans-serif",p=this.labelString?"rgb(220, 220, 250)":this.isLabel?h:this.shouldBeList()?"rgb(217, 77, 17)":this.isOvershooting()?"white":(0,o.kK)(this.data)?h:"white",c=!this.isLabel&&this.shouldBeList()?"white":"black",d=this.width(),u=this.height();t.fillStyle=p,this.shouldBeList()?(o.RC.prototype.outlinePath.call(this,t,I.prototype.corner+1,0),t.fill()):this.isOvershooting()?(this.raggedBoxPath(t),t.fill()):t.fillRect(0,0,d,u),n&&(n instanceof HTMLCanvasElement?(s=Math.max((d-n.width)/2,0),r=Math.max((u-n.height)/2,0),o.A3&&(t.shadowOffsetX=4,t.shadowOffsetY=4,t.shadowBlur=4,t.shadowColor="lightgray"),t.drawImage(n,s,r)):(t.font=l,t.textAlign="left",t.textBaseline="bottom",e=t.measureText(n).width,i=(0,o.SW)(a),t.fillStyle=c,s=Math.max((d-e)/2,0),r=Math.max((u-i)/2,0),t.fillText(n,s,i+r)))},Et.prototype.dataRepresentation=function(t){return t instanceof o._V?g(t)?t.thumbnail(new o.E9(40,40)):t.fullImage():(0,o.HD)(t)?t.length>100?t.slice(0,100)+"...":t:"number"==typeof t?t.toString():"boolean"==typeof t?y.prototype.booleanMorph.call(null,t).fullImage():t instanceof Array?this.dataRepresentation(t[0]):t instanceof l?this.dataRepresentation(t.value):t instanceof HTMLCanvasElement?t:t instanceof Context?t.image():t instanceof C?t.thumbnail(new o.E9(40,40)):t instanceof x?new s("notes",I.prototype.fontSize).getImage():t instanceof d?this.listSymbol():t?t.toString():0===t?"0":null},Et.prototype.raggedBoxPath=function(t){var e=this.width(),o=this.height(),i=.75*e,s=o/6,r=0;for(t.beginPath(),t.moveTo(0,0),t.lineTo(e,0),r=0;r<o;r+=2*s)t.lineTo(i,r+s),t.lineTo(e,r+2*s);t.lineTo(e,o),t.lineTo(0,o),t.closePath()},Et.prototype.shouldBeList=function(){return this.data instanceof Array},Et.prototype.isOvershooting=function(){return this.data instanceof l},Et.prototype.mouseDoubleClick=function(t){this.data instanceof It||this.data instanceof d?new Rt(this.data).popUp(this.world()):this.data instanceof Array&&this.data[0]instanceof d?new Rt(this.data[0]).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},Et.prototype.mouseEnter=function(){var t,e,o;this.isLabel&&(e=(t=this.parentThatIsA(Lt)).world().hand.left()-t.left(),(o=t.columnAt(e))>0&&(this.labelString=o,this.rerender()))},Et.prototype.mouseLeave=function(){this.isLabel&&(this.labelString=null,this.rerender())},Lt.prototype=new o.xZ,Lt.prototype.constructor=Lt,Lt.uber=o.xZ.prototype,Lt.prototype.highContrast=!1,Lt.prototype.init=function(t,e,i,s,r,n,a,h,l,p){this.table=t,this.scrollBarSize=e||o.tU.scrollBarSize,this.startRow=s||1,this.startCol=r||1,this.textHeight=Math.ceil(1.3*(0,o.SW)(I.prototype.fontSize)),this.rowHeight=h||this.textHeight,this.colWidths=a||[],this.globalColWidth=n||Math.ceil(3.5*this.textHeight),this.colLabelHeight=l||this.textHeight,this.padding=p||I.prototype.scale,this.tableVersion=this.table.lastChanged,this.hBar=null,this.vBar=null,this.rowLabelWidth=0,this.columns=[],this.rows=0,this.maxStartRow=null,this.maxStartCol=null,this.dragAnchor=null,this.resizeAnchor=null,this.resizeCol=null,this.resizeRow=null,this.wantsUpdate=!1,o._V.prototype.init.call(this,!0),i&&this.bounds.setExtent(i),this.initScrollBars(),this.fixLayout()},Lt.prototype.initScrollBars=function(){var t=this;this.hBar=new o.Vl(1,null,null,null,"horizontal"),this.hBar.setHeight(this.scrollBarSize),this.hBar.action=function(e){t.showData(e,null,!0)},this.hBar.isDraggable=!1,this.add(this.hBar),this.vBar=new o.Vl(1,null,null,null,"vertical"),this.vBar.setWidth(this.scrollBarSize),this.vBar.action=function(e){t.showData(null,e,!0)},this.vBar.isDraggable=!1,this.add(this.vBar)},Lt.prototype.updateScrollBars=function(){1===this.maxStartCol?this.hBar.hide():(this.hBar.show(),this.hBar.stop=this.maxStartCol,this.hBar.value=this.startCol,this.hBar.size=Math.max(this.hBar.rangeSize()*this.columns.length/this.table.cols(),this.hBar.rangeSize()/10),this.hBar.fixLayout()),this.vBar.stop=this.maxStartRow,this.vBar.value=this.startRow,1===this.maxStartRow?this.vBar.hide():(this.vBar.show(),this.vBar.size=Math.max(this.vBar.rangeSize()*this.rows/this.table.rows(),this.vBar.rangeSize()/10),this.vBar.fixLayout())},Lt.prototype.fixLayout=function(){Lt.uber.fixLayout.call(this),this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.buildCells(),this.hBar.setWidth(this.width()-this.vBar.width()),this.hBar.setLeft(this.left()),this.hBar.setBottom(this.bottom()),this.vBar.setHeight(this.height()-this.hBar.height()),this.vBar.setRight(this.right()),this.vBar.setTop(this.top())},Lt.prototype.render=function(t){var e,i;if(t.fillStyle="rgb(220, 220, 220)",o.RC.prototype.outlinePath.call(this,t,I.prototype.corner+1,0),t.fill(),this.highContrast&&this.table.cols()>1){for(e=this.padding,i=this.startCol;i<=this.table.cols();i+=1)e+=this.colWidth(i)+this.padding;t.fillStyle="darkGray",t.fillRect(this.padding+this.rowLabelWidth,this.padding+this.colLabelHeight,e,(this.rowHeight+this.padding)*(this.table.rows()+1-this.startRow)+this.padding)}},Lt.prototype.buildCells=function(){var t,e,i,s=this.position();for(this.children=[],i=0;i<=this.columns.length;i+=1)for(e=0;e<=this.rows;e+=1)(t=new Et(this.table.get(i?i+this.startCol-1:i,e?e+this.startRow-1:e),new o.E9(i?this.colWidth(i+this.startCol-1):this.rowLabelWidth,e?this.rowHeight:this.colLabelHeight),!(e&&i),!1)).setPosition(new o.E9(i?this.columns[i-1]:this.padding,e?2*this.padding+this.colLabelHeight+(e-1)*(this.rowHeight+this.padding):this.padding).add(s)),this.add(t),g(t.getData())&&(this.wantsUpdate=!0);this.add(this.hBar),this.add(this.vBar),this.updateScrollBars()},Lt.prototype.drawData=function(t){var e,o,i,s=0;for(i=0;i<=this.columns.length;i+=1)for(o=0;o<=this.rows;o+=1)e=this.children[s],s+=1,e.setData(this.table.get(i?i+this.startCol-1:i,o?o+this.startRow-1:o)),g(e.getData())&&(this.wantsUpdate=!0);t||this.updateScrollBars(),this.changed()},Lt.prototype.scroll=function(t,e){this.showData(Math.min(this.maxStartCol,Math.max(1,this.startCol+Math.round(t))),Math.min(this.maxStartRow,Math.max(1,this.startRow+Math.round(e)))),this.updateScrollBars()},Lt.prototype.showData=function(t,e,o){var i=t||this.startCol,s=e||this.startRow;if(i===this.startCol){if(s===this.startRow)return;this.startRow=s,this.rows=this.visibleRows(),this.drawData(o)}else this.startCol=i,this.startRow=s,this.rows=this.visibleRows(),this.colWidths.length?(this.columns=this.columnsLayout(),this.buildCells()):this.drawData(o)},Lt.prototype.step=function(){this.dragAnchor?this.shiftCells(this.world().hand.position()):this.resizeAnchor&&this.resizeCells(this.world().hand.position()),this.update()},Lt.prototype.update=function(){var t,e,o=this.table instanceof d?this.table.version(this.startRow,this.rows,this.startCol,this.columns.length):this.table.lastChanged;(this.tableVersion!==o||this.wantsUpdate)&&(this.wantsUpdate=!1,this.table instanceof d?(t=this.columns.length,e=this.rows,this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.columns.length!==t||this.rows!==e?this.buildCells():this.drawData()):this.drawData(),this.tableVersion=o)},Lt.prototype.rowLabelsWidth=function(){var t=o.XC.prototype.measureCtx;return t.font="italic "+I.prototype.fontSize+"px Helvetica, Arial, sans-serif",Math.max(0,Math.max.apply(null,this.table.columnNames().map((e=>e?t.measureText(e).width:0))))||t.measureText(this.table.rows().toString()).width+6*I.prototype.scale},Lt.prototype.columnsLayout=function(){var t,e,o=[],i=2*this.padding+this.rowLabelWidth;for(t=this.table.cols(),e=i;e<this.width()&&t>0;)e+=this.colWidth(t),t-=1;for(0===t&&e<this.width()?this.maxStartCol=1:this.maxStartCol=Math.min(t+2,this.table.cols()),this.startCol=Math.min(this.startCol,this.maxStartCol),t=this.startCol;i<this.width()&&t<this.table.cols()+this.startCol;)e=this.colWidth(t),o.push(i),i+=e,i+=this.padding,t+=1;return o},Lt.prototype.colWidth=function(t){return this.colWidths[t-1]||this.globalColWidth},Lt.prototype.visibleRows=function(){var t,e=this.height()-this.colLabelHeight-this.padding;return e<0?0:(t=Math.ceil(e/(this.rowHeight+this.padding)),this.maxStartRow=Math.max(1,this.table.rows()-t+2),this.startRow=Math.min(this.startRow,this.maxStartRow),Math.min(this.table.rows(),t))},Lt.prototype.globalExtent=function(){var t,e=this.rowLabelsWidth()+2,i=this.table.cols();for(t=0;t<i;t+=1)e+=this.colWidth(t+1),e+=this.padding;return 1===i&&(e+=this.scrollBarSize,e+=2*this.padding),new o.E9(e+this.padding,this.colLabelHeight+2*this.padding+(this.rowHeight+this.padding)*this.table.rows())},Lt.prototype.mouseScroll=function(t,e){this.scroll(-+e*o.tU.mouseScrollAmount/4,-+t*o.tU.mouseScrollAmount)},Lt.prototype.mouseDownLeft=function(t){var e=t.subtract(this.position());e.x<=this.rowLabelWidth||e.y<=this.colLabelHeight?(16===this.world().currentKey?this.resizeCol=0:this.resizeCol=this.columnAt(e.x),this.resizeRow=e.y>this.colLabelHeight,this.resizeAnchor=t):(this.resizeRow=null,this.dragAnchor=t)},Lt.prototype.mouseClickLeft=function(t){this.dragAnchor=null,this.resizeAnchor=null,this.resizeRow=null},Lt.prototype.mouseLeaveDragging=function(t){this.dragAnchor=null,this.resizeAnchor=null,this.resizeRow=null},Lt.prototype.mouseDoubleClick=function(t){this.parentThatIsA(Rt)?this.escalateEvent("mouseDoubleClick",t):new Rt(this.table,this.globalColWidth,this.colWidths,this.rowHeight).popUp(this.world())},Lt.prototype.shiftCells=function(t){var e=this.dragAnchor.subtract(t),o=Math.round(e.x/this.globalColWidth),i=Math.round(e.y/this.rowHeight);(o||i)&&(this.scroll(o,i),this.dragAnchor=t)},Lt.prototype.resizeCells=function(t){var e,o=t.subtract(this.resizeAnchor);if(this.resizeCol)this.colWidths[this.resizeCol-1]=Math.max(16,(this.colWidths[this.resizeCol-1]||this.globalColWidth)+o.x);else if(this.resizeRow)this.rowHeight=Math.max(16,this.rowHeight+o.y);else for(this.globalColWidth=Math.max(16,this.globalColWidth+o.x),e=0;e<this.colWidths.length;e+=1)this.colWidths[e]&&(this.colWidths[e]=Math.max(16,this.colWidths[e]+o.x));this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.buildCells(),this.resizeAnchor=t,this.changed()},Lt.prototype.columnAt=function(t){var e=0;if(t<this.columns[0])return 0;for(;t>this.columns[e];)e+=1;return e+this.startCol-1},Lt.prototype.userMenu=function(){var t=new o.wR(this);return this.parentThatIsA(Rt)?(this.colWidths.length&&(t.addItem("reset columns","resetColumns"),t.addLine()),this.table instanceof d&&this.table.canBeJSON()&&t.addItem("blockify",(()=>{var t=this.world(),e=(0,o.qY)(t.children,(t=>t instanceof IDE_Morph));this.table.blockify().pickUp(t),t.hand.grabOrigin={origin:e.palette,position:e.palette.center()}})),t.addItem("open in another dialog...","openInDialog"),t):(this.colWidths.length&&t.addItem("reset columns","resetColumns"),t.addItem("list view...","showListView"),this.table instanceof d&&this.table.canBeJSON()&&t.addItem("blockify",(()=>{var t=this.world(),e=(0,o.qY)(t.children,(t=>t instanceof IDE_Morph));this.table.blockify().pickUp(t),t.hand.grabOrigin={origin:e.palette,position:e.palette.center()}})),t.addLine(),t.addItem("open in dialog...","openInDialog"),t)},Lt.prototype.resetColumns=function(){this.colWidths=[],this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.buildCells(),this.changed()},Lt.prototype.openInDialog=function(){new Rt(this.table,this.globalColWidth,this.colWidths,this.rowHeight).popUp(this.world())},Lt.prototype.showListView=function(){var t=this.parentThatIsA(SpriteBubbleMorph,o.KE,T);t&&(t instanceof SpriteBubbleMorph?(t.changed(),t.contentsMorph.destroy(),t.contentsMorph=new u(this.table),t.contentsMorph.step=t.contents.update,t.contentsMorph.expand(this.extent()),t.parent.positionTalkBubble()):t instanceof o.KE?(t.contents=new u(this.table),t.contents.step=t.contents.update,t.contents.expand(this.extent())):(t.changed(),t.contentsMorph.destroy(),t.contentsMorph=new u(this.table),t.add(t.contentsMorph),t.contentsMorph.setPosition(this.position()),t.contentsMorph.expand(this.extent())),t.fixLayout(),t.rerender())},Lt.prototype.show=function(){Lt.uber.show.call(this),this.updateScrollBars()},At.prototype=new o._V,At.prototype.constructor=At,At.uber=o._V.prototype,At.prototype.init=function(t,e){this.tableMorph=t,this.handle=null,At.uber.init.call(this,!0),this.color="transparent",this.bounds=this.tableMorph.bounds.copy(),this.add(this.tableMorph),e||(this.handle=new o.LG(this,80,25,null,null)),this.fixLayout()},At.prototype.fixLayout=function(){var t=this.extent();this.tableMorph.extent().eq(t)||(this.tableMorph.setExtent(this.extent()),this.parent&&(this.parent.changed(),this.parent.fixLayout(),this.parent.rerender()))},At.prototype.expand=function(t){var e=this.tableMorph.globalExtent();t&&(e=e.min(t)),this.setExtent(e),this.handle.setRight(this.right()),this.handle.setBottom(this.bottom())},Rt.prototype=new lt,Rt.prototype.constructor=Rt,Rt.uber=lt.prototype,Rt.prototype.init=function(t,e,o,i){this.handle=null,this.data=t,this.tableView=null,Rt.uber.init.call(this),this.labelString="Table view",this.createLabel(),this.buildContents(t,e,o,i)},Rt.prototype.buildContents=function(t,e,o,i){this.tableView=new Lt(t,null,null,null,null,e,o,i,null,null),this.addBody(new At(this.tableView,!0)),this.addButton("ok","OK")},Rt.prototype.setInitialDimensions=function(){var t=this.world().extent().subtract(new o.E9(this.padding,this.padding)),e=(0,o.SW)(this.titleFontSize)+3*this.titlePadding,i=this.buttons.height();this.setExtent(this.tableView.globalExtent().add(new o.E9(2*this.padding,2*this.padding+e+i)).min(t).max(new o.E9(100,100))),this.setCenter(this.world().center())},Rt.prototype.popUp=function(t){t&&(Rt.uber.popUp.call(this,t),this.setInitialDimensions(),this.handle=new o.LG(this,100,100,this.corner,this.corner))},A.prototype.mouseClickLeft=function(){var t,e=this.topBlock(),o=e.scriptTarget();if(16===this.world().currentKey&&!this.isTemplate)return this.selectForEdit().focus();if(!(e instanceof wt)&&o&&(t=o.parentThatIsA(b))){var i=t.threads.findProcess(e);i&&i.readyToTerminate,window.lastRun=e,t.threads.toggleProcess(e,o)}},A.prototype.activeProcess=function(){var t,e=this.topBlock(),o=e.scriptTarget();return e instanceof wt?null:o&&(t=o.parentThatIsA(b))?t.threads.findProcess(e,o):null},N.prototype.closestInput=function(t,e){var i,s,r,n=t.fullBoundsNoShadow(),a=this.children.filter((t=>t instanceof A&&t.fullBounds().intersects(n))),h=t.allInputs();if(r=[],a.forEach((t=>r=r.concat(t.allInputs()))),0===r.length)return null;function l(t,e){return!(t instanceof Z)||(e?t.arrows().bounds.containsPoint(e):t.arrows().bounds.intersects(n))}if(this.isPreferringEmptySlots){if(e&&(i=e.position(),s=(0,o.qY)(r,(t=>(t instanceof H||t instanceof j&&!(t instanceof V)&&!(t instanceof Z)||t instanceof O&&!t.contents()||t.isEmptySlot())&&!t.isLocked()&&t.bounds.containsPoint(i)&&!(0,o.r3)(h,t)))))return s;if(s=(0,o.qY)(r,(t=>(t instanceof H||t instanceof j||t instanceof O&&!t.contents()||t.isEmptySlot())&&!t.isLocked()&&t.bounds.intersects(n)&&!(0,o.r3)(h,t)&&l(t,i))))return s}return e&&(i=e.position(),s=(0,o.qY)(r,(e=>e!==t&&!e.isLocked()&&e.bounds.containsPoint(i)&&!(e.parent instanceof wt)&&!(0,o.r3)(h,e)&&l(e,i))))?s:(0,o.qY)(r,(e=>e!==t&&!e.isLocked()&&e.fullBounds().intersects(n)&&!(e.parent instanceof wt)&&!(0,o.r3)(h,e)&&l(e)))},N.prototype.cleanUp=function(t){var e=this.selectForEdit(),i=e.topLeft(),s=e.cleanUpMargin;e.children.sort(((t,e)=>t instanceof wt?0:t.top()-e.top())).forEach((t=>{t instanceof ot&&t.block||(t.setPosition(i.add(new o.E9(e.cleanUpMargin,s))),t instanceof A&&t.allComments().forEach((e=>e.align(t,!0))),s+=t.stackHeight()+e.cleanUpSpacing)})),e.parent&&e.setPosition(e.parent.topLeft()),e.adjustBounds()},N.prototype.sortedElements=function(){var t=this.children.filter((t=>!(t instanceof ot&&t.block)));return t.sort(((t,e)=>t instanceof wt?0:t.top()-e.top())),t},j.prototype.reactToSliderEdit=function(){var t,e,o,i;if(this.executeOnSliderEdit&&(t=this.parentThatIsA(A))){if(o=(e=t.topBlock()).scriptTarget(),e instanceof wt)return;o&&((i=o.parentThatIsA(b))&&(i.isThreadSafe||a.prototype.enableSingleStepping)?i.threads.startProcess(e,o,i.isThreadSafe):e.mouseClickLeft())}},it.prototype.shiftScript=function(t){var e;this.element instanceof N?this.moveBy(t):!(e=this.element.topBlock())||e instanceof wt||e.moveBy(t),this.editor.adjustBounds(),this.fixLayout()},it.prototype.sortedScripts=function(){var t=this.editor.children.filter((t=>t instanceof A));return t.sort(((t,e)=>t instanceof wt?0:t.top()-e.top())),t},I.prototype.getVarNamesDict=function(){var t,e,o=this.parentThatIsA(A),i=[];return o?(t=o.scriptTarget(),o.allParents().forEach((t=>{t instanceof wt?(i.push.apply(i,t.variableNames()),i.push.apply(i,t.inputs()[0].inputFragmentNames())):t instanceof A&&t.inputs().forEach((t=>{t.allChildren().forEach((t=>{t instanceof G?i.push(t.contents()):t instanceof Z&&t.children.forEach((t=>{t instanceof G&&i.push(t.contents())}))}))}))})),t?(e=t.variables.allNamesDict(),i.forEach((t=>e[t]=t)),"doSetVar"===o.selector&&(e["~"]=null,e.my=[{anchor:["my anchor"],parent:["my parent"],name:["my name"],"temporary?":["my temporary?"],"dangling?":["my dangling?"],"draggable?":["my draggable?"],"rotation style":["my rotation style"],"rotation x":["my rotation x"],"rotation y":["my rotation y"]}],16===this.world().currentKey&&(e.my[0]["~"]=null,e.my[0]["microphone modifier"]=["microphone modifier"])),e):{}):{}},A.prototype.codeDefinitionHeader=function(){var t=this.isCustomBlock?new wt(this.definition):y.prototype.blockForSelector(this.selector),e=new F,o=1;return this.isCustomBlock?t:(t.inputs().forEach((e=>{var i=new G("#"+o);t.replaceInput(e,i),o+=1})),t.isPrototype=!0,e.setCategory("control"),e.setSpec("%s"),e.replaceInput(e.inputs()[0],t),"control"===this.category&&e.alternateBlockColor(),e)},D.prototype.mouseClickLeft=function(t){var e,o=this;if(this.parent instanceof xt)return this.parent.mouseClickLeft();this.parent instanceof G?(e=this.parent.parent&&this.parent.parent.parent&&this.parent.parent.parent instanceof O?"Input name":"%blockVars"===this.parent.parent.elementSpec?"Block variable name":"Script variable name",new lt(this,(function(t){o.userSetSpec(t)}),this).prompt(e,this.blockSpec,this.world())):D.uber.mouseClickLeft.call(this,t)},o.qz.locale="2020-November-20";var Ft=new Dt;function Dt(t,e){this.language=t||"en",this.dict=e||{}}function Ot(){this.init()}function Nt(t,e){this.init(t,e)}function jt(t){this.init(t)}function Vt(t,e){if(t instanceof d||e instanceof d)return t instanceof d&&e instanceof d&&t.equalTo(e);var i=+t,s=+e;return(isNaN(i)||isNaN(s)||[t,e].some((t=>(0,o.r3)(r,t)||(0,o.HD)(t)&&t.indexOf(" ")>-1)))&&(i=t,s=e),(0,o.HD)(i)&&(0,o.HD)(s)?i.toLowerCase()===s.toLowerCase():i===s}function Wt(t,e,i,s,r,n,l,p){var c=new a,u=s?Date.now()+s:null;if(t instanceof h)i&&(t=c.reportContextFor(i)),c.initializeFor(t,e||new d);else{if(!(t instanceof A)){if(t.evaluate)return t.evaluate();if(t instanceof Function)return t.apply(i,e.asArray().concat(l));throw new Error("expecting a block or ring but getting "+t)}if(c.topBlock=t,!i)throw new Error("expecting a receiver but getting "+i);c.homeContext=new h,c.homeContext.receiver=i,i.variables&&(c.homeContext.variables.parentFrame=i.variables),c.context=new h(null,t.blockSequence(),c.homeContext)}for(n&&(c.isCatchingErrors=!1);c.isRunning();){if(u&&Date.now()>u)throw new Error((0,o.NC)(r||"a synchronous Snap! script has timed out"));c.runStep(u)}return p?c.homeContext:c.homeContext.inputs[0]}function zt(t){this.contents=t||"",this.index=0}function Ht(t,e,o){this.init(t,e,o)}function Ut(){this.contents=[],this.media=[],this.isCollectingMedia=!1,this.isExportingBlocksLibrary=!1}function _t(){this.init()}function Gt(){this.init()}Dt.prototype.translate=function(t){return Object.prototype.hasOwnProperty.call(this.dict[this.language],t)?this.dict[this.language][t]:t},Dt.prototype.languages=function(){var t,e=[];for(t in this.dict)Object.prototype.hasOwnProperty.call(this.dict,t)&&e.push(t);return e.sort()},Dt.prototype.languageName=function(t){return this.dict[t].language_name||t},Dt.prototype.credits=function(){var t="";return this.languages().forEach((e=>{t=t+"\n"+this.languageName(e)+" ("+e+") - "+this.dict[e].language_translator+" - "+this.dict[e].last_changed})),t},Dt.prototype.unload=function(){var t,e=["language_name","language_translator","last_changed"];this.languages().forEach((i=>{var s;if("en"!==i)for(s in t=this.dict[i])Object.prototype.hasOwnProperty.call(t,s)&&!(0,o.r3)(e,s)&&delete t[s]}))},Ft.dict.en={language_name:"English",language_translator:"Jens Mönig","translator_e-mail":"jens@moenig.org",last_changed:"2020-07-09",__shout__go__:"green flag clicked",any:"random","length of %s":"length of text %s","file menu import hint":"load an exported project file\nor block library, a costume\nor a sound","settings menu prefer empty slots hint":"check to focus on empty slots\nwhen dragging & dropping reporters","costumes tab help":"import a picture from another web page or from\na file on your computer by dropping it here\n","block deletion dialog text":"Are you sure you want to delete this\ncustom block and all its instances?","download to disk text":"This item could not be opened in a new tab.\nIt has been saved to your browser's downloads folder.","unable to export text":"This item could not be exported from Snap!.\nIt's likely that your project may contain a lot of media (sounds and images) or that you are using an older browser.Please try using a recent version of Chrome, Firefox, or Safari."},Ft.dict.de={language_name:"Deutsch",language_translator:"Jens Mönig, Jadga Hügle","translator_e-mail":"jens@moenig.org, jadga.huegle@sap.com",last_changed:"2020-11-02"},Ft.dict.it={language_name:"Italiano",language_translator:"Stefano Federici, Alberto Firpo, Massimo Ghisalberti","translator_e-mail":"s_federici@yahoo.com, albertofirpo12@gmail.com, zairik@gmail.com",last_changed:"2020-11-19"},Ft.dict.ja={language_name:"日本語",language_translator:"Kazuhiro Abe","translator_e-mail":"abee@squeakland.jp",last_changed:"2020-07-03"},Ft.dict.ja_HIRA={language_name:"にほんご",language_translator:"Kazuhiro Abe","translator_e-mail":"abee@squeakland.jp",last_changed:"2018-10-23"},Ft.dict.ko={language_name:"한국어",language_translator:"Yunjae Jang","translator_e-mail":"janggoons@gmail.com",last_changed:"2015-01-21"},Ft.dict.pt={language_name:"Português",language_translator:"Manuel Menezes de Sequeira","translator_e-mail":"mmsequeira@gmail.com",last_changed:"2020-08-03"},Ft.dict.cs={language_name:"Česky",language_translator:"Michal Moc, Jan Tomsa","translator_e-mail":"info@iguru.eu, jan.tomsa.1976@gmail.com",last_changed:"2015-11-16"},Ft.dict.zh_CN={language_name:"简体中文",language_translator:"五百刀/邓江华/曹儒林","translator_e-mail":"ubertao@qq.com/djh@rhjxx.cn",last_changed:"2020-07-03"},Ft.dict.eo={language_name:"Esperanto",language_translator:"Sebastian Cyprych","translator_e-mail":"sebacyp(heliko)gmail(punkto)com",last_changed:"2017-10-01"},Ft.dict.fr={language_name:"Français",language_translator:"Jean-Jacques Valliet, Mark Rafter, Martin Quinson, Damien Caselli","translator_e-mail":"i.scool@mac.com",last_changed:"2020-10-28"},Ft.dict.si={language_name:"Slovenščina",language_translator:"Sasa Divjak, Gorazd Breskvar","translator_e-mail":"sasa.divjak@fri.uni-lj.si",last_changed:"2016-04-22"},Ft.dict.ru={language_name:"Русский",language_translator:"Svetlana Ptashnaya, Проскурнёв Артём, Pavel Belousov","translator_e-mail":"svetlanap@berkeley.edu, tema@school830.ru, pbsite@mail.ru",last_changed:"2020-11-02"},Ft.dict.es={language_name:"Español",language_translator:"Víctor Manuel Muratalla Morales / Cristián Rizzi Iribarren / Alfonso Ruzafa","translator_e-mail":"victor.muratalla@yahoo.com / rizzi.cristian@gmail.com",last_changed:"2020-11-19"},Ft.dict.nl={language_name:"Nederlands",language_translator:"Sjoerd Dirk Meijer, Frank Sierens, Jan-Gerard van der Toorn","translator_e-mail":"sjoerddirk@fromScratchEd.nl, frank.sierens@telenet.be, jg.2019@xs4all.nl",last_changed:"2017-09-01"},Ft.dict.pl={language_name:"Polski",language_translator:"Witek Kranas & deKrain","translator_e-mail":"witek@oeiizk.waw.pl",last_changed:"2017-11-09"},Ft.dict.zh_TW={language_name:"繁體中文",language_translator:"cch","translator_e-mail":"cchuang2009@gmail.com",last_changed:"2013-8-14"},Ft.dict.no={language_name:"Norsk",language_translator:"Olav A Marschall","translator_e-mail":"olavmarschall@gmail.com",last_changed:"2020-08-19"},Ft.dict.dk={language_name:"Dansk",language_translator:"FAB, Pelle Hjek","translator_e-mail":"fab@nielsen.mail.dk, hjek@mail.com",last_changed:"2016-11-16"},Ft.dict.el={language_name:"Ελληνικά",language_translator:"Ino Samaras, Alexandros Prekates, HM100","translator_e-mail":"ino.samaras@berkeley.edu, aprekates@sch.gr",last_changed:"2020-10-09"},Ft.dict.ca={language_name:"Català",language_translator:"Bernat Romagosa Carrasquer, Joan Guillén i Pelegay","translator_e-mail":"bernat@snap4arduino.rocks, jguille2@xtec.cat",last_changed:"2020-08-31"},Ft.dict.ca_VA={language_name:"Català - Valencià",language_translator:"Bernat Romagosa Carrasquer, Joan Guillén i Pelegay, Pilar Embid","translator_e-mail":"bernat@snap4arduino.rocks, jguille2@xtec.cat, embid_mar@gva.es",last_changed:"2018-02-08"},Ft.dict.fi={language_name:"suomi",language_translator:"Jouni K. Seppänen","translator_e-mail":"jks@iki.fi",last_changed:"2014-04-18"},Ft.dict.sv={language_name:"svenska",language_translator:"Erik A. Olsson","translator_e-mail":"eolsson@gmail.com",last_changed:"2016-06-09"},Ft.dict.pt_BR={language_name:"Português do Brasil",language_translator:"Aldo von Wangenheim","translator_e-mail":"awangenh@inf.ufsc.br",last_changed:"2014-04-20"},Ft.dict.bn={language_name:"বাংলা",language_translator:"Dr. Mokter Hossain, Radman Siddiki","translator_e-mail":"mokter@gmail.com, radman.siddiki@outlook.com",last_changed:"2020-07-04"},Ft.dict.kn={language_name:"ಕನ್ನಡ",language_translator:"Vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2014-12-02"},Ft.dict.ml={language_name:"Malayalam",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"},Ft.dict.ta={language_name:"Tamil",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"},Ft.dict.te={language_name:"Telagu",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"},Ft.dict.tr={language_name:"Türkçe",language_translator:"Turgut Güneysu, Hakan Atas","translator_e-mail":"tguneysu@msn.com",last_changed:"2020-09-20"},Ft.dict.hu={language_name:"Magyar",language_translator:"Makány György","translator_e-mail":"makany.gyorgy@gmail.com",last_changed:"2015-07-27"},Ft.dict.ia={language_name:"Interlingua",language_translator:"Ken Dickey","translator_e-mail":"Ken.Dickey@whidbey.com",last_changed:"2015-08-09"},Ft.dict.hr={language_name:"Hrvatski",language_translator:"Željko Hrvoj","translator_e-mail":"zeljko.hrvoj@zg.t-com.hr",last_changed:"2017-08-15"},Ft.dict.bg={language_name:"Български",language_translator:"Ivan Savov","translator_e-mail":"ivan.savov@gmail.com",last_changed:"2015-11-16"},Ft.dict.ro={language_name:"Român",language_translator:"Cristian Macarascu","translator_e-mail":"",last_changed:"2015-10-24"},Ft.dict.ar={language_name:"العربية",language_translator:"طارق جلال","translator_e-mail":"tarekgalal46@hotmail.com",last_changed:"2016-02-24"},Ft.dict.id={language_name:"Bahasa Indonesia",language_translator:"Alexander Raphael Liu, Emmanuella Rumanti","translator_e-mail":"raphaxander@gmail.com",last_changed:"2019-01-21"},Ft.dict.et={language_name:"Eesti",language_translator:"Hasso Tepper","translator_e-mail":"hasso.tepper@gmail.com",last_changed:"2016-05-03"},Ft.dict.gl={language_name:"Galego",language_translator:"tecnoloxia <2016>,Miguel A. Bouzada <2019>","translator_e-mail":"mbouzada@gmail.com",last_changed:"2019-07-29"},Ft.dict.eu={language_name:"Euskara",language_translator:"Asier Iturralde Sarasola","translator_e-mail":"aiturralde@iametza.eus",last_changed:"2018-06-26"},Ft.dict.ua={language_name:"Українська",language_translator:"Serhiy Kryzhanovsky","translator_e-mail":"kseryj@gmail.com",last_changed:"2018-08-21"},Ft.dict.sk={language_name:"Slovenčina",language_translator:"Peter Lukačovič","translator_e-mail":"peter_lukacovic@outlook.com",last_changed:"2019-12-10"},Ft.dict.he={language_name:"עברית",language_translator:"יוסי כהן","translator_e-mail":"cohenyossi81@gmail.com",last_changed:"2020-04-21"},Ft.dict.eu={language_name:"Euskara",language_translator:"Asier Iturralde Sarasola","translator_e-mail":"aiturralde@iametza.eus",last_changed:"2018-06-26"},Ft.dict.ua={language_name:"Українська",language_translator:"Serhiy Kryzhanovsky","translator_e-mail":"kseryj@gmail.com",last_changed:"2018-10-14"},o.qz.paint="2020-July-13",Ot.prototype=new lt,Ot.prototype.constructor=Ot,Ot.uber=lt.prototype,Ot.prototype.padding=10,Ot.prototype.init=function(){this.paper=null,this.oncancel=null,Ot.uber.init.call(this),this.labelString="Paint Editor",this.createLabel(),this.buildContents()},Ot.prototype.buildContents=function(){var t=this;this.paper=new jt((function(){return t.shift})),this.paper.setExtent(b.prototype.dimensions),this.addBody(new pt("row",this.padding)),this.controls=new pt("column",this.padding/2),this.controls.alignment="center",this.edits=new pt("row",this.padding/2),this.buildEdits(),this.controls.add(this.edits),this.body.color=this.color,this.body.add(this.controls),this.body.add(this.paper),this.toolbox=new o.RC,this.toolbox.color=y.prototype.paletteColor.lighter(8),this.toolbox.borderColor=this.toolbox.color.lighter(40),o.tU.isFlat&&(this.toolbox.edge=0),this.buildToolbox(),this.controls.add(this.toolbox),this.scaleBox=new pt("row",this.padding/2),this.buildScaleBox(),this.controls.add(this.scaleBox),this.propertiesControls={colorpicker:null,penSizeSlider:null,penSizeField:null,primaryColorButton:null,primaryColorViewer:null,constrain:null},this.populatePropertiesMenu(),this.addButton("ok","OK"),this.addButton("cancel","Cancel"),this.refreshToolButtons(),this.fixLayout()},Ot.prototype.buildToolbox=function(){var t={brush:"Paintbrush tool\n(free draw)",rectangle:"Stroked Rectangle\n(shift: square)",circle:"Stroked Ellipse\n(shift: circle)",eraser:"Eraser tool",crosshairs:"Set the rotation center",line:"Line tool\n(shift: vertical/horizontal)",rectangleSolid:"Filled Rectangle\n(shift: square)",circleSolid:"Filled Ellipse\n(shift: circle)",paintbucket:"Fill a region",pipette:"Pipette tool\n(pick a color anywhere)"},e=this,i=this.toolbox.left(),s=this.toolbox.top(),r=0,n=0;Object.keys(t).forEach((function(a){var h=e.toolButton(a,t[a]);h.setPosition(new o.E9(i+r,s+n)),r+=h.width()+2,"crosshairs"===a&&(r=0,n+=h.height()+2,e.paper.drawcrosshair()),e.toolbox[a]=h,e.toolbox.add(h)})),this.toolbox.bounds=this.toolbox.fullBounds().expandBy(10)},Ot.prototype.buildEdits=function(){var t=this,e=this.paper;this.edits.add(this.pushButton("undo",(function(){e.undo()}))),this.edits.add(this.pushButton("clear",(function(){e.clearCanvas()}))),this.edits.add(this.pushButton("Vector",(function(){t.paper.undoBuffer.length>0?t.ide.confirm("This will erase your current drawing.\nAre you sure you want to continue?","Switch to vector editor?",(()=>{setTimeout((()=>{t.switchToVector()}))})):t.switchToVector()}))),this.edits.fixLayout()},Ot.prototype.buildScaleBox=function(){var t=this.paper;this.scaleBox.add(this.pushButton(new s("grow",18),(function(){t.scale(.05,.05)}),"grow")),this.scaleBox.add(this.pushButton(new s("shrink",18),(function(){t.scale(-.05,-.05)}),"shrink")),this.scaleBox.add(this.pushButton(new s("flipHorizontal",18),(function(){t.scale(-2,0)}),"flip horizontal")),this.scaleBox.add(this.pushButton(new s("flipVertical",18),(function(){t.scale(0,-2)}),"flip vertical")),this.scaleBox.fixLayout()},Ot.prototype.openIn=function(t,e,i,s,r){var n=this;this.oldim=e,this.callback=s||o.WY,this.ide=r,this.processKeyUp=function(){n.shift=!1,n.propertiesControls.constrain.refresh()},this.processKeyDown=function(){n.shift=16===n.world().currentKey,n.propertiesControls.constrain.refresh()},this.oldim&&(this.paper.automaticCrosshairs=(0,o.kK)(i),this.paper.centermerge(this.oldim,this.paper.paper),this.paper.rotationCenter=(i||new o.E9(0,0)).add(new o.E9((this.paper.paper.width-this.oldim.width)/2,(this.paper.paper.height-this.oldim.height)/2)),this.paper.drawNew()),this.key="paint",this.popUp(t)},Ot.prototype.fixLayout=function(){this.changed(),this.paper&&(this.paper.buildContents(),this.paper.drawNew()),this.controls&&this.controls.fixLayout(),this.body&&this.body.fixLayout(),Ot.uber.fixLayout.call(this),this.changed()},Ot.prototype.refreshToolButtons=function(){this.toolbox.children.forEach((function(t){t.refresh()}))},Ot.prototype.ok=function(){this.paper.updateAutomaticCenter(),this.callback(this.paper.paper,this.paper.rotationCenter),this.destroy()},Ot.prototype.cancel=function(){this.oncancel&&this.oncancel(),this.destroy()},Ot.prototype.switchToVector=function(){this.object=new S(new Image,"",new o.E9(0,0)),this.object.edit(this.world(),this.ide,!0)},Ot.prototype.populatePropertiesMenu=function(){var t=this.controls,e=this,i=this.propertiesControls,s=new pt("row",this.padding),r=new pt("column",3);r.alignment="left",i.primaryColorViewer=new o._V,i.primaryColorViewer.isCachingImage=!0,i.primaryColorViewer.render=function(t){var o,i,s=e.paper.settings.primarycolor;if("transparent"===s)for(o=0;o<180;o+=5)for(i=0;i<15;i+=5)t.fillStyle=(i+o)/5%2==0?"rgba(0, 0, 0, 0.2)":"rgba(0, 0, 0, 0.5)",t.fillRect(o,i,5,5);else t.fillStyle=s.toString(),t.fillRect(0,0,180,15);t.strokeStyle="black",t.lineWidth=Math.min(e.paper.settings.linewidth,20),t.beginPath(),t.lineCap="round",t.moveTo(20,30),t.lineTo(160,30),t.stroke()},i.primaryColorViewer.setExtent(new o.E9(180,40)),i.primaryColorViewer.color=new o.Il(0,0,0),i.colorpicker=new Nt(new o.E9(180,100),(function(t){e.paper.settings.primarycolor=t,i.primaryColorViewer.rerender()})),i.colorpicker.isCachingImage=!0,i.colorpicker.action(new o.Il(0,0,0)),i.penSizeSlider=new o.Vl(0,20,5,5),i.penSizeSlider.orientation="horizontal",i.penSizeSlider.setHeight(15),i.penSizeSlider.setWidth(150),i.penSizeSlider.action=function(t){i.penSizeField&&i.penSizeField.setContents(t),e.paper.settings.linewidth=t,i.colorpicker.action(e.paper.settings.primarycolor)},i.penSizeField=new ct("5",!0,null,!1),i.penSizeField.contents().minWidth=20,i.penSizeField.setWidth(25),i.penSizeField.accept=function(){var t=parseFloat(i.penSizeField.getValue());i.penSizeSlider.value=t,i.penSizeSlider.updateValue(),this.setContents(t),e.paper.settings.linewidth=t,this.world().keyboardFocus=e,i.colorpicker.action(e.paper.settings.primarycolor)},s.add(i.penSizeSlider),s.add(i.penSizeField),s.color=e.color,s.fixLayout(),i.penSizeField.fixLayout(),i.constrain=new at("checkbox",this,(function(){e.shift=!e.shift}),"Constrain proportions of shapes?\n(you can also hold shift)",(function(){return e.shift})),i.constrain.label.isBold=!1,t.add(i.colorpicker),t.add(i.primaryColorViewer),r.add(new o.XC(("Brush size",Ft.translate("Brush size")+":"),10,null,!0)),r.add(s),r.add(i.constrain),r.fixLayout(),t.add(r)},Ot.prototype.toolButton=function(t,e){var o,i=this;return(o=new rt(null,this,(function(){i.paper.currentTool=t,i.paper.toolChanged(t),i.refreshToolButtons(),"pipette"===t&&i.getUserColor()}),new s(t,18),(function(){return i.paper.currentTool===t}))).hint=e,o},Ot.prototype.pushButton=function(t,e,o){return new st(this,e,t,null,o)},Ot.prototype.getUserColor=function(){var t=this,e=this.world(),i=e.hand,s=(0,o.eg)(e.worldCanvas),r=i.processMouseMove,n=i.processMouseDown,a=i.processMouseUp;i.processMouseMove=function(r){var n;i.setPosition(new o.E9(r.pageX-s.x,r.pageY-s.y)),(n=e.getGlobalPixelColor(i.position())).a&&(n.a=1,t.propertiesControls.colorpicker.action(n))},i.processMouseDown=o.WY,i.processMouseUp=function(){t.paper.currentTool="brush",t.paper.toolChanged("brush"),t.refreshToolButtons(),i.processMouseMove=r,i.processMouseDown=n,i.processMouseUp=a}},Nt.prototype=new o._V,Nt.prototype.constructor=Nt,Nt.uber=o._V.prototype,Nt.prototype.init=function(t,e){this.isCachingImage=!0,this.setExtent(t||new o.E9(200,100)),this.action=e||o.WY},Nt.prototype.render=function(t){var e,o,i=0,s=0;for(i=0;i<this.width();i+=1)for(s=0;s<this.height()-20;s+=1)t.fillStyle="hsl("+360*i/this.width()+",100%,"+100*s/(this.height()-20)+"%)",t.fillRect(i,s,1,1);for(i=0;i<this.width();i+=1)o=Math.floor(255*i/this.width()),t.fillStyle="rgb("+o+", "+o+", "+o+")",t.fillRect(i,this.height()-20,1,10);for(e=["black","white","gray"],i=0;i<e.length;i+=1)t.fillStyle=e[i],t.fillRect(i*this.width()/e.length,this.height()-10,this.width()/e.length,10);for(i=2*this.width()/3;i<this.width();i+=2)for(s=this.height()-10;s<this.height();s+=2)(i+s)/2%2==0&&(t.fillStyle="#DDD",t.fillRect(i,s,2,2))},Nt.prototype.mouseDownLeft=function(t){t.subtract(this.position()).x>2*this.width()/3&&t.subtract(this.position()).y>this.height()-10?this.action("transparent"):this.action(this.getPixelColor(t))},Nt.prototype.mouseMove=Nt.prototype.mouseDownLeft,jt.prototype=new o._V,jt.prototype.constructor=jt,jt.uber=o._V.prototype,jt.prototype.init=function(t){this.rotationCenter=new o.E9(240,180),this.dragRect=null,this.previousDragPoint=null,this.currentTool="brush",this.dragRect=new o.Ae,this.mask=null,this.paper=null,this.erasermask=null,this.background=null,this.settings={primarycolor:new o.Il(0,0,0,255),secondarycolor:new o.Il(0,0,0,255),linewidth:3},this.brushBuffer=[],this.undoBuffer=[],this.isShiftPressed=t||function(){return 16===this.world().currentKey},this.automaticCrosshairs=!0,this.isCachingImage=!0,this.buildContents(),this.drawNew()},jt.prototype.calculateCanvasCenter=function(t){var e=C.prototype.canvasBoundingBox(t);return null===e?null:new o.E9((e.origin.x+e.corner.x)/2,(e.origin.y+e.corner.y)/2)},jt.prototype.updateAutomaticCenter=function(){if(this.automaticCrosshairs){var t=this.calculateCanvasCenter(this.paper);null!==t&&(this.rotationCenter=t)}},jt.prototype.scale=function(t,e){this.updateAutomaticCenter(),this.mask=(0,o.oM)(this.extent(),!0);var i=(0,o.oM)(this.extent(),!0);i.getContext("2d").save(),i.getContext("2d").translate(this.rotationCenter.x,this.rotationCenter.y),i.getContext("2d").scale(1+t,1+e),i.getContext("2d").drawImage(this.paper,-this.rotationCenter.x,-this.rotationCenter.y),i.getContext("2d").restore(),this.paper=i,this.drawNew(),this.changed()},jt.prototype.cacheUndo=function(){var t=(0,o.oM)(this.extent(),!0);this.merge(this.paper,t),this.undoBuffer.push(t)},jt.prototype.undo=function(){this.undoBuffer.length>0&&(this.paper=(0,o.oM)(this.extent(),!0),this.mask.width=this.mask.width+1-1,this.merge(this.undoBuffer.pop(),this.paper),this.drawNew(),this.changed())},jt.prototype.merge=function(t,e){e.getContext("2d").drawImage(t,0,0)},jt.prototype.centermerge=function(t,e){e.getContext("2d").drawImage(t,(e.width-t.width)/2,(e.height-t.height)/2)},jt.prototype.clearCanvas=function(){this.buildContents(),this.drawNew(),this.changed()},jt.prototype.toolChanged=function(t){this.mask=(0,o.oM)(this.extent(),!0,this.mask),"crosshairs"===t&&(this.updateAutomaticCenter(),this.drawcrosshair()),this.drawNew(),this.changed()},jt.prototype.drawcrosshair=function(t){var e=t||this.mask.getContext("2d"),i=this.rotationCenter;e.save(),e.lineWidth=1,e.strokeStyle="black",e.clearRect(0,0,this.mask.width,this.mask.height),e.globalAlpha=.5,e.fillStyle="white",e.beginPath(),e.arc(i.x,i.y,20,(0,o.uR)(0),(0,o.uR)(360),!1),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.arc(i.x,i.y,10,(0,o.uR)(0),(0,o.uR)(360),!1),e.stroke(),e.beginPath(),e.moveTo(0,i.y),e.lineTo(this.mask.width,i.y),e.stroke(),e.beginPath(),e.moveTo(i.x,0),e.lineTo(i.x,this.mask.height),e.stroke(),e.restore(),this.drawNew()},jt.prototype.floodfill=function(t){var e,o,i,s,r=this.paper.width,n=this.paper.height,a=this.paper.getContext("2d"),h=a.getImageData(0,0,r,n),l=h.data,p=[Math.round(Math.round(t.y)*r+t.x)];if(s=function(t){return t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]&&t[3]===i[3]},(0!==(i=(o=function(t){var e=4*t;return[l[e],l[e+1],l[e+2],l[e+3]]})(p[0]))[3]||"transparent"!==this.settings.primarycolor)&&!(i[0]===this.settings.primarycolor.r&&i[1]===this.settings.primarycolor.g&&i[2]===this.settings.primarycolor.b&&i[3]===255*this.settings.primarycolor.a||0===i[3]&&0===this.settings.primarycolor.a)){for(;p.length>0;)s(o(e=p.pop()))&&(e%r>1&&(p.push(e+1),p.push(e-1)),e>0&&e<n*r&&(p.push(e+r),p.push(e-r))),"transparent"===this.settings.primarycolor?l[4*e+3]=0:(l[4*e]=this.settings.primarycolor.r,l[4*e+1]=this.settings.primarycolor.g,l[4*e+2]=this.settings.primarycolor.b,l[4*e+3]=255*this.settings.primarycolor.a);a.putImageData(h,0,0),this.drawNew(),this.changed()}},jt.prototype.mouseDownLeft=function(t){return this.cacheUndo(),this.dragRect.origin=t.subtract(this.bounds.origin),this.dragRect.corner=t.subtract(this.bounds.origin),this.previousDragPoint=this.dragRect.corner.copy(),"crosshairs"===this.currentTool?(this.rotationCenter=t.subtract(this.bounds.origin),void this.drawcrosshair()):"paintbucket"===this.currentTool?this.floodfill(t.subtract(this.bounds.origin)):void("transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool&&(this.erasermask=(0,o.oM)(this.extent(),!0,this.erasermask),this.merge(this.paper,this.erasermask)))},jt.prototype.mouseMove=function(t){if("paintbucket"!==this.currentTool){var e,i=t.subtract(this.bounds.origin),s=this.mask.getContext("2d"),r=this.paper.getContext("2d"),n=this.dragRect.origin.x,a=this.dragRect.origin.y,h=i.x,l=i.y,p=(h-n)/2,c=(l-a)/2,d=this.paper.width;switch(s.save(),this.brushBuffer.push([h,l]),s.lineWidth=this.settings.linewidth,s.clearRect(0,0,this.bounds.width(),this.bounds.height()),this.dragRect.corner=i.subtract(this.dragRect.origin),"transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool?(this.merge(this.erasermask,this.mask),r.clearRect(0,0,this.bounds.width(),this.bounds.height()),s.globalCompositeOperation="destination-out"):(s.fillStyle=this.settings.primarycolor.toString(),s.strokeStyle=this.settings.primarycolor.toString()),this.currentTool){case"rectangle":this.isShiftPressed()?s.strokeRect(n,a,2*u(),2*f()):s.strokeRect(n,a,2*p,2*c);break;case"rectangleSolid":this.isShiftPressed()?s.fillRect(n,a,2*u(),2*f()):s.fillRect(n,a,2*p,2*c);break;case"brush":for(s.lineCap="round",s.lineJoin="round",s.beginPath(),s.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]),e=0;e<this.brushBuffer.length;e+=1)s.lineTo(this.brushBuffer[e][0],this.brushBuffer[e][1]);s.stroke();break;case"line":s.beginPath(),s.moveTo(n,a),this.isShiftPressed()?Math.abs(c)>Math.abs(p)?s.lineTo(n,l):s.lineTo(h,a):s.lineTo(h,l),s.stroke();break;case"circle":case"circleSolid":if(s.beginPath(),this.isShiftPressed())s.arc(n,a,new o.E9(n,a).distanceTo(new o.E9(h,l)),0,2*Math.PI,!1);else{for(e=0;e<d;e+=1)s.lineTo(e,2*c*Math.sqrt(2-Math.pow((e-n)/(2*p),2))+a);for(e=d;e>0;e-=1)s.lineTo(e,2*c*-1*Math.sqrt(2-Math.pow((e-n)/(2*p),2))+a)}s.closePath(),"circleSolid"===this.currentTool?s.fill():"circle"===this.currentTool&&s.stroke();break;case"crosshairs":this.automaticCrosshairs=!1,this.rotationCenter=i.copy(),this.drawcrosshair(s);break;case"eraser":for(this.merge(this.paper,this.mask),s.save(),s.globalCompositeOperation="destination-out",s.beginPath(),s.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]),e=0;e<this.brushBuffer.length;e+=1)s.lineTo(this.brushBuffer[e][0],this.brushBuffer[e][1]);s.stroke(),s.restore(),this.paper=(0,o.oM)(this.extent(),!0),this.merge(this.mask,this.paper);break;default:(0,o.WY)()}this.previousDragPoint=i,this.drawNew(),s.restore(),this.changed()}function u(){return Math.max(Math.abs(p),Math.abs(c))*(p/Math.abs(p))}function f(){return Math.max(Math.abs(p),Math.abs(c))*(c/Math.abs(c))}},jt.prototype.mouseClickLeft=function(){"crosshairs"!==this.currentTool&&this.merge(this.mask,this.paper),this.brushBuffer=[]},jt.prototype.mouseLeaveDragging=jt.prototype.mouseClickLeft,jt.prototype.buildContents=function(){this.background=(0,o.oM)(this.extent(),!1,this.background),this.paper=(0,o.oM)(this.extent(),!0,this.paper),this.mask=(0,o.oM)(this.extent(),!0,this.mask),this.erasermask=(0,o.oM)(this.extent(),!0,this.erasermask);var t,e,i=this.background.getContext("2d");for(t=0;t<this.background.width;t+=5)for(e=0;e<this.background.height;e+=5)i.fillStyle=(t+e)/5%2==1?"rgba(255, 255, 255, 1)":"rgba(255, 255, 255, 0.3)",i.fillRect(t,e,5,5)},jt.prototype.drawNew=function(){var t=(0,o.oM)(this.extent(),!0,this.cachedImage);this.merge(this.background,t),this.merge(this.paper,t),this.merge(this.mask,t),this.cachedImage=t,this.drawFrame()},jt.prototype.rerender=jt.prototype.drawNew,jt.prototype.drawFrame=function(){var t,e;t=this.cachedImage.getContext("2d"),this.parent?(this.color=this.parent.color.lighter(.75*this.contrast),e=this.parent.color):e=new o.Il(120,120,120),t.fillStyle=this.color.toString(),this.cachedClr=e.toString(),this.cachedClrBright=e.lighter(this.contrast).toString(),this.cachedClrDark=e.darker(this.contrast).toString(),this.drawRectBorder(t)},jt.prototype.drawRectBorder=ct.prototype.drawRectBorder,jt.prototype.edge=ct.prototype.edge,jt.prototype.fontSize=ct.prototype.fontSize,jt.prototype.typeInPadding=ct.prototype.typeInPadding,jt.prototype.contrast=ct.prototype.contrast,C.prototype.edit=function(t,e,i,s,r){var n=new Ot;n.oncancel=s||o.WY,n.openIn(t,i?(0,o.oM)(b.prototype.dimensions,!0):this.contents,i?null:this.rotationCenter,((i,s)=>{this.contents=i,this.rotationCenter=s,this.version=Date.now(),t.changed(),e&&(e.currentSprite instanceof y&&this.shrinkWrap(),e.currentSprite.wearCostume(this,!0),e.hasChangedMedia=!0),(r||o.WY)()}),e)},y.prototype.blockTemplates=function(t){var e,i,s,r=[],n=this,h=t||"motion",l=this.inheritedVariableNames();function p(t,e){if(b.prototype.hiddenPrimitives[t])return null;var o=y.prototype.blockForSelector(t,!0);return o.isTemplate=!0,e&&o.ghost(),o}function c(t,e){var i=y.prototype.variableBlock(t,e);return i.isDraggable=!1,i.isTemplate=!0,(0,o.r3)(l,t)&&i.ghost(),i}function d(t){if(b.prototype.hiddenPrimitives[t])return null;var e=y.prototype.blocks[t];return new at("checkbox",this,(function(){n.toggleWatcher(t,(0,o.NC)(e.spec),n.blockColor[e.category])}),null,(function(){return n.showingWatcher(t)}),null)}function u(t){return new at("checkbox",this,(function(){n.toggleVariableWatcher(t)}),null,(function(){return n.showingVariableWatcher(t)}),null)}function f(){var t=new o.wR(this);return t.addItem("help...","showHelp"),t}function g(t){var e;t&&(n.isVariableNameInUse(t[0],t[1])?n.inform("that name is already in use"):(e=n.parentThatIsA(Kt),n.addVariable(t[0],t[1]),n.toggleVariableWatcher(t[0],t[1]),e.flushBlocksCache("variables"),e.refreshPalette()))}return"motion"===h?(r.push(p("forward")),r.push(p("turn")),r.push(p("turnLeft")),r.push("-"),r.push(p("setHeading")),r.push(p("doFaceTowards")),r.push("-"),r.push(p("gotoXY")),r.push(p("doGotoObject")),r.push(p("doGlide")),r.push("-"),r.push(p("changeXPosition")),r.push(p("setXPosition")),r.push(p("changeYPosition")),r.push(p("setYPosition")),r.push("-"),r.push(p("bounceOffEdge")),r.push("-"),r.push(d("xPosition")),r.push(p("xPosition",this.inheritsAttribute("x position"))),r.push(d("yPosition")),r.push(p("yPosition",this.inheritsAttribute("y position"))),r.push(d("direction")),r.push(p("direction",this.inheritsAttribute("direction"))),r.push("="),r.push(this.makeBlockButton(h))):"looks"===h?(r.push(p("doSwitchToCostume")),r.push(p("doWearNextCostume")),r.push(d("getCostumeIdx")),r.push(p("getCostumeIdx",this.inheritsAttribute("costume #"))),r.push("-"),r.push(p("doSayFor")),r.push(p("bubble")),r.push(p("doThinkFor")),r.push(p("doThink")),r.push("-"),r.push(p("reportGetImageAttribute")),r.push(p("reportNewCostumeStretched")),r.push(p("reportNewCostume")),r.push("-"),r.push(p("changeEffect")),r.push(p("setEffect")),r.push(p("clearEffects")),r.push(p("getEffect")),r.push("-"),r.push(p("changeScale")),r.push(p("setScale")),r.push(d("getScale")),r.push(p("getScale",this.inheritsAttribute("size"))),r.push("-"),r.push(p("show")),r.push(p("hide")),r.push(d("reportShown")),r.push(p("reportShown",this.inheritsAttribute("shown?"))),r.push("-"),r.push(p("goToLayer")),r.push(p("goBack")),this.world().isDevMode&&(r.push("-"),(s=new o.$1((0,o.NC)("development mode \ndebugging primitives:"))).fontSize=9,s.setColor(this.paletteTextColor),r.push(s),r.push("-"),r.push(p("log")),r.push(p("alert")),r.push("-"),r.push(p("doScreenshot"))),r.push("="),r.push(this.makeBlockButton(h))):"sound"===h?(r.push(p("playSound")),r.push(p("doPlaySoundUntilDone")),r.push(p("doStopAllSounds")),r.push("-"),r.push(p("doPlaySoundAtRate")),r.push(p("reportGetSoundAttribute")),r.push(p("reportNewSoundFromSamples")),r.push("-"),r.push(p("doRest")),r.push(p("doPlayNote")),r.push(p("doSetInstrument")),r.push("-"),r.push(p("doChangeTempo")),r.push(p("doSetTempo")),r.push(d("getTempo")),r.push(p("getTempo")),r.push("-"),r.push(p("changeVolume")),r.push(p("setVolume")),r.push(d("getVolume")),r.push(p("getVolume",this.inheritsAttribute("volume"))),r.push("-"),r.push(p("changePan")),r.push(p("setPan")),r.push(d("getPan")),r.push(p("getPan",this.inheritsAttribute("balance"))),r.push("-"),r.push(p("playFreq")),r.push(p("stopFreq")),this.world().isDevMode&&(r.push("-"),(s=new o.$1((0,o.NC)("development mode \ndebugging primitives:"))).fontSize=9,s.setColor(this.paletteTextColor),r.push(s),r.push("-"),r.push(p("doPlayFrequency"))),r.push("="),r.push(this.makeBlockButton(h))):"pen"===h?(r.push(p("clear")),r.push("-"),r.push(p("down")),r.push(p("up")),r.push(d("getPenDown")),r.push(p("getPenDown",this.inheritsAttribute("pen down?"))),r.push("-"),r.push(p("setColor")),r.push(p("changePenHSVA")),r.push(p("setPenHSVA")),r.push(p("getPenAttribute")),r.push("-"),r.push(p("changeSize")),r.push(p("setSize")),r.push("-"),r.push(p("doStamp")),r.push(p("floodFill")),r.push(p("write")),r.push("-"),r.push(p("reportPenTrailsAsCostume")),r.push("-"),r.push(p("doPasteOn")),r.push(p("doCutFrom")),r.push("="),r.push(this.makeBlockButton(h))):"control"===h?(r.push(p("receiveGo")),r.push(p("receiveKey")),r.push(p("receiveInteraction")),r.push(p("receiveCondition")),r.push(p("receiveMessage")),r.push("-"),r.push(p("doBroadcast")),r.push(p("doBroadcastAndWait")),r.push(p("doSend")),r.push(d("getLastMessage")),r.push(p("getLastMessage")),r.push("-"),r.push(p("doWarp")),r.push("-"),r.push(p("doWait")),r.push(p("doWaitUntil")),r.push("-"),r.push(p("doForever")),r.push(p("doRepeat")),r.push(p("doUntil")),r.push(p("doFor")),r.push("-"),r.push(p("doIf")),r.push(p("doIfElse")),r.push(p("reportIfElse")),r.push("-"),r.push(p("doReport")),r.push(p("doStopThis")),r.push("-"),r.push(p("doRun")),r.push(p("fork")),r.push(p("evaluate")),r.push("-"),r.push(p("doTellTo")),r.push(p("reportAskFor")),r.push("-"),r.push(p("doCallCC")),r.push(p("reportCallCC")),r.push("-"),r.push(p("receiveOnClone")),r.push(p("createClone")),r.push(p("newClone")),r.push(p("removeClone")),r.push("-"),r.push(p("doPauseAll")),r.push("="),r.push(this.makeBlockButton(h))):"sensing"===h?(r.push(p("reportTouchingObject")),r.push(p("reportTouchingColor")),r.push(p("reportColorIsTouchingColor")),r.push("-"),r.push(p("doAsk")),r.push(d("getLastAnswer")),r.push(p("getLastAnswer")),r.push("-"),r.push(d("reportMouseX")),r.push(p("reportMouseX")),r.push(d("reportMouseY")),r.push(p("reportMouseY")),r.push(p("reportMouseDown")),r.push("-"),r.push(p("reportKeyPressed")),r.push("-"),r.push(p("reportRelationTo")),r.push(p("reportAspect")),r.push("-"),r.push(p("doResetTimer")),r.push(d("getTimer")),r.push(p("getTimer")),r.push("-"),r.push(p("reportAttributeOf")),y.prototype.enableFirstClass&&r.push(p("reportGet")),r.push(p("reportObject")),r.push("-"),r.push(p("reportURL")),r.push(p("reportAudio")),r.push(p("reportVideo")),r.push(p("doSetVideoTransparency")),r.push("-"),r.push(p("reportGlobalFlag")),r.push(p("doSetGlobalFlag")),r.push("-"),r.push(p("reportDate")),this.world().isDevMode&&(r.push("-"),(s=new o.$1((0,o.NC)("development mode \ndebugging primitives:"))).fontSize=9,s.setColor(this.paletteTextColor),r.push(s),r.push("-"),r.push(d("reportThreadCount")),r.push(p("reportThreadCount")),r.push(p("reportStackSize")),r.push(p("reportFrameCount"))),r.push("="),r.push(this.makeBlockButton(h))):"operators"===h?(r.push(p("reifyScript")),r.push(p("reifyReporter")),r.push(p("reifyPredicate")),r.push("#"),r.push("-"),r.push(p("reportSum")),r.push(p("reportDifference")),r.push(p("reportProduct")),r.push(p("reportQuotient")),r.push(p("reportPower")),r.push("-"),r.push(p("reportModulus")),r.push(p("reportRound")),r.push(p("reportMonadic")),r.push(p("reportRandom")),r.push("-"),r.push(p("reportLessThan")),r.push(p("reportEquals")),r.push(p("reportGreaterThan")),r.push("-"),r.push(p("reportAnd")),r.push(p("reportOr")),r.push(p("reportNot")),r.push(p("reportBoolean")),r.push("-"),r.push(p("reportJoinWords")),r.push(p("reportTextSplit")),r.push(p("reportLetter")),r.push(p("reportStringSize")),r.push("-"),r.push(p("reportUnicode")),r.push(p("reportUnicodeAsLetter")),r.push("-"),r.push(p("reportIsA")),r.push(p("reportIsIdentical")),r.push("-"),r.push(p("reportJSFunction")),a.prototype.enableCompiling&&r.push(p("reportCompiled")),this.world().isDevMode&&(r.push("-"),(s=new o.$1((0,o.NC)("development mode \ndebugging primitives:"))).fontSize=9,s.setColor(this.paletteTextColor),r.push(s),r.push("-"),r.push(p("reportTypeOf")),r.push(p("reportTextFunction"))),r.push("="),r.push(this.makeBlockButton(h))):"variables"===h&&((i=new st(null,(function(){new Mt(null,g,n).prompt("Variable name",null,n.world())}),"Make a variable")).userMenu=f,i.selector="addVariable",i.showHelp=A.prototype.showHelp,r.push(i),this.deletableVariableNames().length>0&&((i=new st(null,(function(){var t=new o.wR(n.deleteVariable,null,n);n.deletableVariableNames().forEach((e=>t.addItem(e,e,null,null,null,null,null,null,!0))),t.popUpAtHand(n.world())}),"Delete a variable")).userMenu=f,i.selector="deleteVariable",i.showHelp=A.prototype.showHelp,r.push(i)),r.push("-"),(e=this.reachableGlobalVariableNames(!0)).length>0&&(e.forEach((t=>{r.push(u(t)),r.push(c(t))})),r.push("-")),(e=this.allLocalVariableNames(!0)).length>0&&(e.forEach((t=>{r.push(u(t)),r.push(c(t,!0))})),r.push("-")),r.push(p("doSetVar")),r.push(p("doChangeVar")),r.push(p("doShowVar")),r.push(p("doHideVar")),r.push(p("doDeclareVariables")),b.prototype.enableInheritance&&(r.push("-"),r.push(p("doDeleteAttr"))),r.push("="),r.push(p("reportNewList")),r.push(p("reportNumbers")),r.push("-"),r.push(p("reportCONS")),r.push(p("reportListItem")),r.push(p("reportCDR")),r.push("-"),r.push(p("reportListLength")),r.push(p("reportListIndex")),r.push(p("reportListContainsItem")),r.push(p("reportListIsEmpty")),r.push("-"),r.push(p("reportMap")),r.push(p("reportKeep")),r.push(p("reportFindFirst")),r.push(p("reportCombine")),r.push("-"),r.push(p("doForEach")),r.push("-"),r.push(p("reportConcatenatedLists")),r.push("-"),r.push(p("doAddToList")),r.push(p("doDeleteFromList")),r.push(p("doInsertInList")),r.push(p("doReplaceInList")),this.world().isDevMode&&(r.push("-"),(s=new o.$1((0,o.NC)("development mode \ndebugging primitives:"))).fontSize=9,s.setColor(this.paletteTextColor),r.push(s),r.push("-"),r.push(p("doShowTable"))),r.push("="),b.prototype.enableCodeMapping&&(r.push(p("doMapCodeOrHeader")),r.push(p("doMapValueCode")),r.push(p("doMapListCode")),r.push("-"),r.push(p("reportMappedCode")),r.push("=")),r.push(this.makeBlockButton())),r},w.prototype.dataAsMorph=function(t){var e,i,r,n,a,l=y.prototype;return t instanceof o._V?g(t)?(r=t.thumbnail(new o.E9(40,40)),(e=new o._V).isCachingImage=!0,e.bounds.setWidth(r.width),e.bounds.setHeight(r.height),e.cachedImage=r,e.version=t.version,e.step=function(){this.version!==t.version&&(r=t.thumbnail(new o.E9(40,40),this.cachedImage),this.cachedImage=r,this.version=t.version,this.changed())}):e=t:(0,o.HD)(t)?(i=!0,e=new o.$1(t,l.bubbleFontSize*this.scale,null,l.bubbleFontIsBold,!1,"center")):"boolean"==typeof t?(r=l.booleanMorph(t).fullImage(),(e=new o._V).isCachingImage=!0,e.bounds.setWidth(r.width),e.bounds.setHeight(r.height),e.cachedImage=r):t instanceof C?(r=t.thumbnail(new o.E9(40,40)),(e=new o._V).isCachingImage=!0,e.bounds.setWidth(r.width),e.bounds.setHeight(r.height),e.cachedImage=r):t instanceof x?e=new s("notes",30):t instanceof HTMLCanvasElement?(r=t,(e=new o._V).isCachingImage=!0,e.bounds.setWidth(r.width),e.bounds.setHeight(r.height),e.cachedImage=r):t instanceof d?(t.isTable()?(e=new At(new TableMorph(t,10)),this.stage&&e.expand(this.stage.extent().translateBy(-2*(this.edge+this.border+this.padding)))):((e=new u(t)).update(!0),e.step=e.update,this.stage&&e.expand(this.stage.extent().translateBy(-2*(this.edge+this.border+this.padding)))),e.isDraggable=!1):t instanceof h?(r=t.image(),(e=new o._V).isCachingImage=!0,e.bounds.setWidth(r.width),e.bounds.setHeight(r.height),e.cachedImage=r):e=new o.$1(t.toString(),l.bubbleFontSize*this.scale,null,l.bubbleFontIsBold,!1,"center"),e instanceof o.$1?(a=Math.max(e.width(),2*l.bubbleCorner*this.scale),i&&(a=Math.min(a,l.bubbleMaxTextWidth*this.scale)),e.setWidth(a)):t instanceof d||((n=(0,o.oM)(e.extent().multiplyBy(this.scale))).getContext("2d").drawImage(e.getImage(),0,0,n.width,n.height),e.cachedImage=n,e.bounds=e.bounds.scaleBy(this.scale)),e},w.prototype.setScale=function(t){this.scale=t,this.changed(),this.fixLayout(),this.rerender()},w.prototype.fixLayout=function(){var t=y.prototype;this.contentsMorph instanceof u||this.contentsMorph instanceof At||(this.contentsMorph.destroy(),this.contentsMorph=this.dataAsMorph(this.data)),this.add(this.contentsMorph),this.edge=t.bubbleCorner*this.scale,this.border=t.bubbleBorder*this.scale,this.padding=t.bubbleCorner/2*this.scale,this.bounds.setWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge)),this.bounds.setHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2),this.contentsMorph.setPosition(this.position().add(new o.E9(this.padding||this.edge,this.border+this.padding+1)))},T.prototype.big=function(){this.isBig=!0,this.changed(),this.contentsMorph instanceof o.$1&&this.contentsMorph.setFontSize(1.5*I.prototype.fontSize),this.fixLayout(!0),this.rerender()},T.prototype.normal=function(){this.isBig=!1,this.changed(),this.contentsMorph instanceof o.$1&&this.contentsMorph.setFontSize(I.prototype.fontSize),this.fixLayout(!0),this.rerender()},T.prototype.isCircular=function(t){return!!this.parentCell&&(t instanceof d?this.contents===t||this.parentCell.isCircular(t):this.parentCell.isCircular(this.contents))},T.prototype.fixLayout=function(t){var e,o=this.contentsMorph instanceof u&&this.contentsMorph.list===this.contents,i=this.contentsMorph instanceof At&&this.contentsMorph.tableMorph.table===this.contents;t||(this.createContents(),this.bounds.setHeight(this.contentsMorph.height()+this.edge+2*this.border),this.bounds.setWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof h||this.contents instanceof d?0:3.5*I.prototype.fontSize)),o||i||this.contentsMorph.setCenter(this.center()),this.parent&&(this.parent.changed(),this.parent.fixLayout(),this.parent.rerender(),(e=this.parentThatIsA(u))&&(e.changed(),e.fixLayout(),e.rerender())))},T.prototype.createContents=function(){var t,e,i=I.prototype.fontSize,r=this.contentsMorph instanceof u&&this.contentsMorph.list===this.contents,n=this.contentsMorph instanceof At&&this.contentsMorph.tableMorph.table===this.contents;this.isBig&&(i*=1.5),!this.contentsMorph||r||n||(this.contentsMorph.destroy(),this.version=null),r||n||(this.contents instanceof o._V?g(this.contents)?(e=this.contents.thumbnail(new o.E9(40,40)),this.contentsMorph=new o._V,this.contentsMorph.isCachingImage=!0,this.contentsMorph.bounds.setWidth(e.width),this.contentsMorph.bounds.setHeight(e.height),this.contentsMorph.cachedImage=e,this.version=this.contents.version):this.contentsMorph=this.contents:(0,o.HD)(this.contents)?(t=this.contents.length>500?this.contents.slice(0,500)+"...":this.contents,this.contentsMorph=new o.$1(t,i,null,!0,!1,"left"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(o.Cj)):"boolean"==typeof this.contents?(e=y.prototype.booleanMorph.call(null,this.contents).fullImage(),this.contentsMorph=new o._V,this.contentsMorph.isCachingImage=!0,this.contentsMorph.bounds.setWidth(e.width),this.contentsMorph.bounds.setHeight(e.height),this.contentsMorph.cachedImage=e):this.contents instanceof HTMLCanvasElement?(e=this.contents,this.contentsMorph=new o._V,this.contentsMorph.isCachingImage=!0,this.contentsMorph.bounds.setWidth(e.width),this.contentsMorph.bounds.setHeight(e.height),this.contentsMorph.cachedImage=e):this.contents instanceof h?(e=this.contents.image(),this.contentsMorph=new o._V,this.contentsMorph.isCachingImage=!0,this.contentsMorph.bounds.setWidth(e.width),this.contentsMorph.bounds.setHeight(e.height),this.contentsMorph.cachedImage=e):this.contents instanceof C?(e=this.contents.thumbnail(new o.E9(40,40)),this.contentsMorph=new o._V,this.contentsMorph.isCachingImage=!0,this.contentsMorph.bounds.setWidth(e.width),this.contentsMorph.bounds.setHeight(e.height),this.contentsMorph.cachedImage=e):this.contents instanceof x?this.contentsMorph=new s("notes",30):this.contents instanceof d?(this.contents.isTable()?(this.contentsMorph=new At(new TableMorph(this.contents,10)),this.contentsMorph.expand(new o.E9(200,150))):this.isCircular()?(this.contentsMorph=new o.$1("(...)",i,null,!1,!0,"center"),this.contentsMorph.setColor(o.Cj)):this.contentsMorph=new u(this.contents,this),this.contentsMorph.isDraggable=!1):(this.contentsMorph=new o.$1((0,o.kK)(this.contents)?"":this.contents.toString(),i,null,!0,!1,"center"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(o.Cj)),this.add(this.contentsMorph))},T.prototype.update=function(){(g(this.contents)||this.contents instanceof C)&&this.version!==this.contents.version&&(this.fixLayout(),this.rerender(),this.version=this.contents.version)},T.prototype.render=function(t){if(0===this.edge&&0===this.border)return o.RC.uber.render.call(this,t),null;t.fillStyle=this.color.toString(),t.beginPath(),this.outlinePath(t,Math.max(this.edge-this.border,0),this.border),t.closePath(),t.fill(),this.border>0&&!o.tU.isFlat&&(t.lineWidth=this.border,t.strokeStyle=this.borderColor.toString(),t.beginPath(),this.outlinePath(t,this.edge,this.border/2),t.closePath(),t.stroke(),o.A3&&(t.shadowOffsetX=this.border,t.shadowOffsetY=this.border,t.shadowBlur=this.border,t.shadowColor=this.color.darker(80).toString(),this.drawShadow(t,this.edge,this.border/2)))},T.prototype.drawShadow=function(t,e,i){var s=e+i,r=this.width(),n=this.height();t.beginPath(),t.moveTo(0,n-s),t.lineTo(0,s),t.stroke(),t.beginPath(),t.arc(s,s,e,(0,o.uR)(-180),(0,o.uR)(-90),!1),t.stroke(),t.beginPath(),t.moveTo(s,0),t.lineTo(r-s,0),t.stroke()},T.prototype.layoutChanged=function(){var t=this.parentThatIsA(u);this.bounds.setHeight(this.contentsMorph.height()+this.edge+2*this.border),this.bounds.setWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof h||this.contents instanceof d?0:2*this.height())),this.contentsMorph.setCenter(this.center()),this.rerender(),t&&t.fixLayout()},T.prototype.reactToEdit=function(t){var e;(0,o.kK)(this.idx)||(e=this.parentThatIsA(u))&&e.list.put(t.text,this.idx+e.start-1)},T.prototype.mouseClickLeft=function(t){this.isEditable&&this.contentsMorph instanceof o.$1?this.contentsMorph.selectAllAndEdit():this.escalateEvent("mouseClickLeft",t)},T.prototype.mouseDoubleClick=function(t){d.prototype.enableTables&&this.currentValue instanceof d?new TableDialogMorph(this.contents).popUp(this.world()):this.escalateEvent("mouseDoubleClick",t)},B.prototype.update=function(){var t,e,i,s=!1;if(this.target&&this.getter){if(this.updateLabel(),this.target instanceof p)if(void 0===(t=this.target.vars[this.getter]?this.target.vars[this.getter].value:void 0)&&this.target.owner){if(e=this.target.owner,!(0,o.r3)(e.inheritedVariableNames(),this.getter))return void this.destroy();t=this.target.getVar(this.getter),this.cellMorph.setColor(y.prototype.blockColor.variables.lighter(35))}else this.cellMorph.setColor(y.prototype.blockColor.variables);else t=this.target[this.getter](),s=!!(i={xPosition:"x position",yPosition:"y position",direction:"direction",getCostumeIdx:"costume #",getScale:"size",getVolume:"volume",getPan:"balance",reportShown:"shown?",getPenDown:"pen down?"}[this.getter])&&this.target.inheritsAttribute(i);if(""===t||(0,o.kK)(t)||"boolean"==typeof t||isNaN(+t)||(t=Math.round(1e9*t)/1e9),void 0===t)return void this.destroy();(t!==this.currentValue||s!==this.isGhosted||!(0,o.kK)(t)&&t.version&&t.version!==this.version)&&(this.changed(),this.cellMorph.contents=t,this.isGhosted=s,g(this.target)&&(s?this.cellMorph.setColor(this.readoutColor.lighter(35)):this.cellMorph.setColor(this.readoutColor)),this.cellMorph.fixLayout(),isNaN(t)||(this.sliderMorph.value=t,this.sliderMorph.fixLayout()),this.fixLayout(),this.currentValue&&this.currentValue.version?this.version=this.currentValue.version:this.version=Date.now(),this.currentValue=t)}this.cellMorph.contentsMorph instanceof u?this.cellMorph.contentsMorph.update():g(this.cellMorph.contents)&&this.cellMorph.update()},n.prototype.pauseCustomHatBlocks=!1,n.prototype.toggleProcess=function(t,e){var o=this.findProcess(t,e);if(!o)return this.startProcess(t,e,null,null,null,!0);o.stop()},n.prototype.startProcess=function(t,e,o,i,s,r,n,h,l){var c,d,u=t.topBlock(),f=this.findProcess(u,e);if(f){if(o)return f;f.stop(),f.canBroadcast=!0,this.removeTerminatedProcesses()}return(d=new a(u,e,s,r)).exportResult=i,d.isClicked=r||!1,d.isAtomic=h||!1,l instanceof p&&Object.keys(l.vars).forEach((t=>d.context.outerContext.variables.vars[t]=l.vars[t])),(c=u.getHighlight())?(c.threadCount=this.processesForBlock(u).length+1,c.updateReadout()):u.addHighlight(),this.processes.push(d),n&&d.runStep(),d},n.prototype.stopAll=function(t){this.processes.forEach((e=>{e!==t&&e.stop()}))},n.prototype.stopAllForReceiver=function(t,e){this.processes.forEach((o=>{o.homeContext.receiver===t&&o!==e&&(o.stop(),t.isTemporary&&(o.isDead=!0))}))},n.prototype.stopAllForBlock=function(t){this.processesForBlock(t,!0).forEach((t=>t.stop()))},n.prototype.stopProcess=function(t,e){var o=this.findProcess(t,e);o&&o.stop()},n.prototype.pauseAll=function(t){this.processes.forEach((t=>t.pause())),t&&t.pauseAllActiveSounds()},n.prototype.isPaused=function(){return null!==(0,o.qY)(this.processes,(t=>t.isPaused))},n.prototype.resumeAll=function(t){this.processes.forEach((t=>t.resume())),t&&t.resumeAllActiveSounds()},n.prototype.step=function(){var t;a.prototype.enableSingleStepping&&(this.processes.forEach((e=>{e.isInterrupted?(e.runStep(),t=!0):e.lastYield=Date.now()})),this.wantsToPause=a.prototype.flashTime>.5,t)?this.wantsToPause&&this.pauseAll():(this.processes.forEach((t=>{t.homeContext.receiver.isPickedUp()||t.isDead||t.runStep()})),this.removeTerminatedProcesses())},n.prototype.removeTerminatedProcesses=function(){var t,e=[];this.processes.forEach((o=>{var i,s;!o.isRunning()&&!o.errorFlag||o.isDead?(o.topBlock instanceof A&&(o.unflash(),(t=this.processesForBlock(o.topBlock).length)?((s=o.topBlock.getHighlight()||o.topBlock.addHighlight()).threadCount=t,s.updateReadout()):o.topBlock.removeHighlight()),o.prompter&&(o.prompter.destroy(),o.homeContext.receiver.stopTalking&&o.homeContext.receiver.stopTalking()),o.topBlock instanceof D||o.isShowingResult||o.exportResult?(i=o.homeContext.inputs[0],o.onComplete instanceof Function?o.onComplete(i):i instanceof d?o.topBlock.showBubble(i.isTable()?new At(new Lt(i,10)):new u(i),o.exportResult,o.receiver):o.topBlock.showBubble(i,o.exportResult,o.receiver)):o.onComplete instanceof Function&&o.onComplete()):e.push(o)})),this.processes=e},n.prototype.findProcess=function(t,e){var i=t.topBlock();return(0,o.qY)(this.processes,(t=>t.topBlock===i&&t.receiver===e))},n.prototype.processesForBlock=function(t,e){var o=e?t:t.topBlock();return this.processes.filter((t=>t.topBlock===o&&t.isRunning()&&!t.isDead))},n.prototype.doWhen=function(t,e,o){if(!this.pauseCustomHatBlocks&&t&&!this.findProcess(t,e)){var i,s,r=t.inputs()[0];if(t.removeHighlight()&&(i=t.world())&&i.hand.destroyTemporaries(),!o){try{s=Wt(r,null,e,50,"the predicate takes\ntoo long for a\ncustom hat block",!0,null,!0)}catch(e){t.addErrorHighlight(),t.showBubble(e.name+"\n"+e.message)}(!0===s||s&&s.inputs&&!0===s.inputs[0])&&this.startProcess(t,e,null,null,null,null,!0,null,s.variables)}}},n.prototype.toggleSingleStepping=function(){a.prototype.enableSingleStepping=!a.prototype.enableSingleStepping,a.prototype.enableSingleStepping||this.processes.forEach((t=>{t.isPaused||t.unflash()}))},a.prototype.isRunning=function(){return!this.readyToTerminate&&(this.context||this.isPaused)},a.prototype.runStep=function(t){if(this.isPaused)return this.pauseStep();for(this.readyToYield=!1,this.isInterrupted=!1;!this.readyToYield&&!this.isInterrupted&&this.context&&Date.now()-this.lastYield<this.timeout;){if(this.isPaused)return this.pauseStep();if(t&&Date.now()>t)return void(this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp());this.evaluateContext()}if(this.lastYield=Date.now(),this.isFirstStep=!1,this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp&&(this.homeContext.receiver.endWarp(),this.homeContext.receiver.startWarp()),this.readyToTerminate){for(;this.context;)this.popContext();this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp()}},a.prototype.stop=function(){this.readyToYield=!0,this.readyToTerminate=!0,this.errorFlag=!1,this.context&&this.context.stopMusic(),this.canBroadcast=!1},a.prototype.pause=function(){this.readyToTerminate||(this.isPaused=!0,this.flashPausedContext(),this.context&&this.context.startTime&&(this.pauseOffset=Date.now()-this.context.startTime))},a.prototype.resume=function(){this.enableSingleStepping||this.unflash(),this.isPaused=!1,this.pauseOffset=null},a.prototype.pauseStep=function(){this.lastYield=Date.now(),this.context&&this.context.startTime&&(this.context.startTime=this.lastYield-this.pauseOffset)},a.prototype.evaluateContext=function(){var t=this.context.expression;return this.frameCount+=1,"exit"===this.context.tag&&this.expectReport(),t instanceof Array?this.evaluateSequence(t):t instanceof Z?this.evaluateMultiSlot(t,t.inputs().length):t instanceof $?this.evaluateArgLabel(t):t instanceof j||t.bindingID?this.evaluateInput(t):t instanceof A?this.evaluateBlock(t,t.inputs().length):(0,o.HD)(t)?this[t].apply(this,this.context.inputs):(t instanceof l&&this.returnValueToParentContext(t.value),void this.popContext())},a.prototype.evaluateBlock=function(t,e){var o,i,s=t.selector;if("reportOr"===s||"reportAnd"===s||"reportIfElse"===s||"doReport"===s){if(!this.isCatchingErrors)return this[s](t);try{return this[s](t)}catch(e){this.handleError(e,t)}}if(o=this.context.receiver||this.receiver,e>(i=this.context.inputs).length)this.evaluateNextInput(t);else{if(this.flashContext())return;if(this[s]&&(o=this),this.isCatchingErrors)try{this.returnValueToParentContext(o[s].apply(o,i)),this.popContext()}catch(e){this.handleError(e,t)}else this.returnValueToParentContext(o[s].apply(o,i)),this.popContext()}},a.prototype.reportOr=function(t){var e=this.context.inputs;if(e.length<1)this.evaluateNextInput(t);else if(1===e.length)if(e[0]){if(this.flashContext())return;this.returnValueToParentContext(!0),this.popContext()}else this.evaluateNextInput(t);else{if(this.flashContext())return;this.returnValueToParentContext(!0===e[1]),this.popContext()}},a.prototype.reportAnd=function(t){var e=this.context.inputs;if(e.length<1)this.evaluateNextInput(t);else if(1===e.length)if(e[0])this.evaluateNextInput(t);else{if(this.flashContext())return;this.returnValueToParentContext(!1),this.popContext()}else{if(this.flashContext())return;this.returnValueToParentContext(!0===e[1]),this.popContext()}},a.prototype.doReport=function(t){var e=this.context.outerContext;if(!this.flashContext()){if(this.isClicked&&t.topBlock()===this.topBlock&&(this.isShowingResult=!0),t.partOfCustomCommand)this.doStopCustomBlock(),this.popContext();else{for(;this.context&&"exit"!==this.context.tag;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.context&&("expectReport"===this.context.expression?this.popContext():this.context.tag=null)}this.pushContext(t.inputs()[0],e),this.context.isCustomCommand=t.partOfCustomCommand}},a.prototype.evaluateMultiSlot=function(t,e){var o,i=this.context.inputs;if(t.bindingID){if(this.isCatchingErrors)try{o=this.context.variables.getVar(t.bindingID)}catch(e){this.handleError(e,t)}else o=this.context.variables.getVar(t.bindingID);this.returnValueToParentContext(o),this.popContext()}else e>i.length?this.evaluateNextInput(t):(this.returnValueToParentContext(new d(i)),this.popContext())},a.prototype.evaluateArgLabel=function(t){var e=this.context.inputs;e.length<1?this.evaluateNextInput(t):(this.returnValueToParentContext(e[0]),this.popContext())},a.prototype.evaluateInput=function(t){var e;if(!this.flashContext()){if(t.bindingID)if(this.isCatchingErrors)try{e=this.context.variables.getVar(t.bindingID)}catch(e){this.handleError(e,t)}else e=this.context.variables.getVar(t.bindingID);else(e=t.evaluate())&&(t.constructor===V||t.constructor===tt||t instanceof z&&(!t.isStatic||t.isLambda))&&(e=this.reify(e,new d));this.returnValueToParentContext(e),this.popContext()}},a.prototype.evaluateSequence=function(t){var e=this.context.pc,o=this.context.outerContext,i=this.context.isCustomBlock;e===t.length-1?(this.context=new h(this.context.parentContext,t[e],this.context.outerContext,this.context.receiver),this.context.isCustomBlock=i):e>=t.length?this.popContext():(this.context.pc+=1,this.pushContext(t[e],o))},a.prototype.evaluateNextInput=function(t){var e=this.context.inputs.length,o=t.inputs()[e],i=this.context.expression.selector,s=this.context.outerContext;o.isUnevaluated&&(!0===o.isUnevaluated||o.isUnevaluated())?"reify"===i||"reportScript"===i?this.context.addInput(o):this.context.addInput(this.reify(o,new d)):this.pushContext(o,s)},a.prototype.doYield=function(){this.popContext(),this.isAtomic||(this.readyToYield=!0)},a.prototype.expectReport=function(){this.handleError(new Error("reporter didn't report"))},a.prototype.handleError=function(t,e){var i=e;this.stop(),this.errorFlag=!0,this.topBlock.addErrorHighlight(),((0,o.kK)(i)||(0,o.kK)(i.world()))&&(i=this.topBlock),i.showBubble((i===e?"":"Inside: ")+t.name+"\n"+t.message,this.exportResult,this.receiver)},a.prototype.errorObsolete=function(){throw new Error("a custom block definition is missing")},a.prototype.reify=function(t,e,o){var i=new h(null,null,this.context?this.context.outerContext:null),s=0;return t?(i.expression=this.enableLiveCoding||this.enableSingleStepping?t:t.fullCopy(),i.expression.show(),o||e.length()||(i.expression.allEmptySlots().forEach((t=>{s+=1,t.bindingID=t instanceof Z?Symbol.for("arguments"):s})),i.emptySlots=s)):i.expression=this.enableLiveCoding||this.enableSingleStepping?[this.context.expression]:[this.context.expression.fullCopy()],i.inputs=e.asArray(),i.receiver=this.context?this.context.receiver:this.receiver,i.origin=i.receiver,i},a.prototype.reportScript=function(t,e){return this.reify(e,t)},a.prototype.reifyScript=function(t,e){return this.reify(t,e)},a.prototype.reifyReporter=function(t,e){return this.reify(t,e)},a.prototype.reifyPredicate=function(t,e){return this.reify(t,e)},a.prototype.reportJSFunction=function(t,e){return Function.apply(null,t.asArray().concat([e]))},a.prototype.doRun=function(t,e){return this.evaluate(t,e,!0)},a.prototype.evaluate=function(t,e,i){if(!t)return this.returnValueToParentContext(null);if(t instanceof Function)return t.apply(this.blockReceiver(),e.asArray().concat([this]));if(t.isContinuation)return this.runContinuation(t,e);if(!(t instanceof h))throw new Error("expecting a ring but getting "+t);var s,r,n,a,p,c=new h(null,null,t.outerContext),d=this.context.parentContext,u=e.asArray();if(c.receiver||(c.receiver=t.receiver),(r=new h(this.context.parentContext,t.expression,c,t.receiver)).isCustomCommand=i,this.context.parentContext=r,t.expression instanceof D&&(this.readyToYield=Date.now()-this.lastYield>this.timeout),c.variables.addVar(Symbol.for("arguments"),e),u.length>0){for(a=0;a<t.inputs.length;a+=1)p=0,(0,o.kK)(u[a])||(p=u[a]),c.variables.addVar(t.inputs[a],p);if(0===t.inputs.length)if(1===u.length)if(t.emptySlots)for(a=1;a<=t.emptySlots;a+=1)c.variables.addVar(a,u[0]);else(n=t.expression)instanceof Array&&1===n.length&&n[0].selector&&"reifyReporter"===n[0].selector&&!n[0].contents()&&(r.expression=new l(u[0]));else if(u.length===t.emptySlots)for(a=1;a<=u.length;a+=1)c.variables.addVar(a,u[a-1]);else if(1!==t.emptySlots)throw new Error((0,o.NC)("expecting")+" "+t.emptySlots+" "+(0,o.NC)("input(s), but getting")+" "+u.length)}r.expression instanceof R&&(r.expression=r.expression.blockSequence(),i||(d?d.tag="exit":((s=new h(r.parentContext,"expectReport",c,c.receiver)).tag="exit",r.parentContext=s)))},a.prototype.fork=function(t,e){if(!this.readyToTerminate){var o=new a,i=this.homeContext.receiver.parentThatIsA(b);o.instrument=this.instrument,o.receiver=this.receiver,o.initializeFor(t,e),i.threads.processes.push(o)}},a.prototype.initializeFor=function(t,e){if(t.isContinuation)throw new Error("continuations cannot be forked");if(!(t instanceof h))throw new Error("expecting a ring but getting "+t);var i,s,r=new h(null,null,t.outerContext),n=new h(null,t.expression,r),a=e.asArray();if(this.context=t.receiver,r.variables.addVar(Symbol.for("arguments"),e),a.length>0){for(i=0;i<t.inputs.length;i+=1)s=0,(0,o.kK)(a[i])||(s=a[i]),r.variables.addVar(t.inputs[i],s);if(0===t.inputs.length)if(1===a.length)for(i=1;i<=t.emptySlots;i+=1)r.variables.addVar(i,a[0]);else if(a.length===t.emptySlots)for(i=1;i<=a.length;i+=1)r.variables.addVar(i,a[i-1]);else if(1!==t.emptySlots)throw new Error((0,o.NC)("expecting")+" "+t.emptySlots+" "+(0,o.NC)("input(s), but getting")+" "+a.length)}n.expression instanceof R&&(n.expression=n.expression.blockSequence()),this.homeContext=new h,this.homeContext.receiver=t.outerContext.receiver,this.topBlock=t.expression,this.context=n},a.prototype.doStopBlock=function(){var t=this.context.expression.exitTag;if((0,o.kK)(t))return this.doStopCustomBlock();for(;this.context&&((0,o.kK)(this.context.tag)||this.context.tag>t);)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.pushContext()},a.prototype.doStopCustomBlock=function(){for(;this.context&&!this.context.isCustomBlock;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext()},a.prototype.doCallCC=function(t,e){this.evaluate(t,new d([this.context.continuation(e)]),!e)},a.prototype.reportCallCC=function(t){this.doCallCC(t,!0)},a.prototype.runContinuation=function(t,e){var o=e.asArray();if("expectReport"===t.expression&&o.length)return this.stop(),void(this.homeContext.inputs[0]=o[0]);this.context.parentContext=t.copyForContinuationCall(),1===o.length&&this.context.parentContext.outerContext.variables.addVar(1,o[0])},a.prototype.evaluateCustomBlock=function(){var t,e,i,s,r,n=this.context.parentContext,a=this.context.expression,l=a.isGlobal?a.definition:this.blockReceiver().getMethod(a.semanticSpec),p=l.body,c=l.declarations,u=new d(this.context.inputs).asArray();if(!p)return null;if(this.procedureCount+=1,(r=new h).receiver=this.context.receiver,r.variables.parentFrame=a.variables,l.variableNames.length?a.variables.parentFrame=r.receiver?r.receiver.variables:null:r.variables.parentFrame=r.receiver?r.receiver.variables:null,(t=new h(this.context.parentContext,p.expression,r,r.receiver)).isCustomBlock=!0,this.context.parentContext=t,u.length>0)for(i=0;i<p.inputs.length;i+=1)s=0,(0,o.kK)(u[i])||(s=u[i]),r.variables.addVar(p.inputs[i],s),"%upvar"===c.get(p.inputs[i])[0]&&(this.context.outerContext.variables.vars[s]=r.variables.vars[p.inputs[i]]);"command"!==l.type?(n?n.tag="exit":((e=new h(t.parentContext,"expectReport",r,r.receiver)).tag="exit",t.parentContext=e),this.readyToYield=Date.now()-this.lastYield>this.timeout):(t.expression.tagExitBlocks(this.procedureCount,!0),n&&!n.tag&&(n.tag=this.procedureCount),!this.isAtomic&&l.isDirectlyRecursive()&&(this.readyToYield=!0)),t.expression=t.expression.blockSequence()},a.prototype.doDeclareVariables=function(t){var e=this.context.outerContext.variables;t.asArray().forEach((t=>e.addVar(t)))},a.prototype.doSetVar=function(t,e){var o=this.context.variables,i=t;if(i instanceof h)return"reportGetVar"===i.expression.selector?void i.variables.setVar(i.expression.blockSpec,e,this.blockReceiver()):void this.doSet(i,e);i instanceof Array?this.doSet(i,e):o.setVar(i,e,this.blockReceiver())},a.prototype.doChangeVar=function(t,e){var o=this.context.variables,i=t;this.assertType(e,"number"),i instanceof h&&"reportGetVar"===i.expression.selector?i.variables.changeVar(i.expression.blockSpec,e,this.blockReceiver()):o.changeVar(i,e,this.blockReceiver())},a.prototype.reportGetVar=function(){return this.context.variables.getVar(this.context.expression.blockSpec)},a.prototype.doShowVar=function(t){var e,i,s,r,n=(this.context||this.homeContext).variables,a=t;if(a instanceof h){if("reportGetVar"!==a.expression.selector)return void this.doChangePrimitiveVisibility(a.expression,!1);a=a.expression.blockSpec}if(this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(b))){if(!(s=n.silentFind(a)))return;if(null!==(i=(0,o.qY)(e.children,(t=>t instanceof B&&t.target===s&&t.getter===a))))return i.show(),void i.fixLayout();(i=new B((0,o.r3)(this.homeContext.receiver.globalVariables().names(),t)||s.owner?a:a+" "+(0,o.NC)("(temporary)"),y.prototype.blockColor.variables,s,a)).setPosition(e.position().add(10)),(r=e.watchers(i.left())).length>0&&i.setTop(r[r.length-1].bottom()),e.add(i),i.fixLayout(),i.rerender()}},a.prototype.doHideVar=function(t){var e,i,s,r=this.context.variables,n=t;if(n instanceof h){if("reportGetVar"!==n.expression.selector)return void this.doChangePrimitiveVisibility(n.expression,!0);n=n.expression.blockSpec}n?this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(b))&&(s=r.find(n),null!==(i=(0,o.qY)(e.children,(t=>t instanceof B&&t.target===s&&t.getter===n)))&&(i.isTemporary()?i.destroy():i.hide())):this.doRemoveTemporaries()},a.prototype.doRemoveTemporaries=function(){var t;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(b))&&t.watchers().forEach((t=>{t.isTemporary()&&t.destroy()}))},a.prototype.doChangePrimitiveVisibility=function(t,e){var o,i=this.homeContext.receiver.parentThatIsA(IDE_Morph);i&&"evaluateCustomBlock"!==t.selector&&(e?b.prototype.hiddenPrimitives[t.selector]=!0:delete b.prototype.hiddenPrimitives[t.selector],"lists"===(o={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"}[this.selector]||this.category)&&(o="variables"),i.flushBlocksCache(o),i.refreshPalette())},a.prototype.doDeleteAttr=function(t){var e=t,i=this.blockReceiver();if(e instanceof h){if("reportGetVar"!==e.expression.selector)return e={xPosition:"x position",yPosition:"y position",direction:"direction",getCostumeIdx:"costume #",size:"size"}[e.expression.selector],void((0,o.kK)(e)||i.inheritAttribute(e));e=e.expression.blockSpec}if(e instanceof Array)return i.inheritAttribute(this.inputOption(e));(0,o.r3)(i.inheritedVariableNames(!0),e)&&i.deleteVariable(e)},a.prototype.doTellTo=function(t,e,o){this.doRun(this.reportAttributeOf(e,t),o)},a.prototype.reportAskFor=function(t,e,o){this.evaluate(this.reportAttributeOf(e,t),o)},a.prototype.reportNewList=function(t){return t},a.prototype.reportCONS=function(t,e){return this.assertType(e,"list"),(new d).cons(t,e)},a.prototype.reportCDR=function(t){return this.assertType(t,"list"),t.cdr()},a.prototype.doAddToList=function(t,e){this.assertType(e,"list"),e.type&&(this.assertType(t,e.type),e=this.shadowListAttribute(e)),e.add(t)},a.prototype.doDeleteFromList=function(t,e){var o=t;if(this.assertType(e,"list"),e.type&&(e=this.shadowListAttribute(e)),"all"===this.inputOption(t))return e.clear();if(""===t)return null;if("last"===this.inputOption(t))o=e.length();else if(isNaN(+this.inputOption(t)))return null;e.remove(o)},a.prototype.doInsertInList=function(t,e,o){var i=e;if(this.assertType(o,"list"),o.type&&(this.assertType(t,o.type),o=this.shadowListAttribute(o)),""===e)return null;"any"===this.inputOption(e)&&(i=this.reportBasicRandom(1,o.length()+1)),"last"===this.inputOption(e)&&(i=o.length()+1),o.add(t,i)},a.prototype.doReplaceInList=function(t,e,o){var i=t;if(this.assertType(e,"list"),e.type&&(this.assertType(o,e.type),e=this.shadowListAttribute(e)),""===t)return null;"any"===this.inputOption(t)&&(i=this.reportBasicRandom(1,e.length())),"last"===this.inputOption(t)&&(i=e.length()),e.put(o,i)},a.prototype.shadowListAttribute=function(t){var e;return"costume"!==t.type&&"sound"!==t.type||(t===(e=this.blockReceiver()).costumes?(e.shadowAttribute("costumes"),t=e.costumes):t===e.sounds&&(e.shadowAttribute("sounds"),t=e.sounds)),t},a.prototype.reportListItem=function(t,e){var o;return this.assertType(e,"list"),""===t?"":"any"===this.inputOption(t)?e.at(this.reportBasicRandom(1,e.length())):"last"===this.inputOption(t)?e.at(e.length()):(o=this.rank(t))>0&&this.enableHyperOps?1===o?t.isEmpty()?e.map((t=>t)):t.map((t=>e.at(t))):this.reportItems(t,e):e.at(t)},a.prototype.reportItems=function(t,e){return function t(e,o,i){return 1===e?i:t(e-1,o.cdr(),function(t,e){return function(o){return t.isEmpty()?o.map((t=>e(t))):t.map((t=>e(o.at(t))))}}(o.at(1)||new d,i))}(this.rank(e),t.cdr(),function(t){return function(e){return t.isEmpty()?e.map((t=>t)):t.map((t=>e.at(t)))}}(t.at(1)))(e)},a.prototype.reportListLength=function(t){return this.assertType(t,"list"),t.length()},a.prototype.reportListIndex=function(t,e){return this.assertType(e,"list"),e.indexOf(t)},a.prototype.reportListContainsItem=function(t,e){return this.assertType(t,"list"),t.contains(e)},a.prototype.reportListIsEmpty=function(t){return this.assertType(t,"list"),t.isEmpty()},a.prototype.doShowTable=function(t){this.assertType(t,"list"),new TableDialogMorph(t).popUp(this.blockReceiver().world())},a.prototype.reportNumbers=function(t,e){return this.enableHyperOps?this.hyperDyadic(((t,e)=>this.reportBasicNumbers(t,e)),t,e):this.reportLinkedNumbers(t,e)},a.prototype.reportBasicNumbers=function(t,e){var o,i,s,r=+t,n=+e,a=r;if(this.assertType(r,"number"),this.assertType(n,"number"),n>r)for(i=Math.floor(n-r),o=new Array(i),s=0;s<=i;s+=1)o[s]=a,a+=1;else for(i=Math.floor(r-n),o=new Array(i),s=0;s<=i;s+=1)o[s]=a,a-=1;return new d(o)},a.prototype.reportConcatenatedLists=function(t){var e,o,i,s,r,n,a;if(this.assertType(t,"list"),t.isEmpty())return t;if(e=t.at(1),this.assertType(e,"list"),e.isLinked)return this.concatenateLinkedLists(t);for(o=[],i=t.length(),r=1;r<=i;r+=1)for(s=t.at(r),this.assertType(s,"list"),n=s.length(),a=1;a<=n;a+=1)o.push(s.at(a));return new d(o)},a.prototype.concatenateLinkedLists=function(t){var e;return t.isEmpty()?t:(e=t.at(1),this.assertType(e,"list"),1===t.length()?e:e.isEmpty()?this.concatenateLinkedLists(t.cdr()):t.cons(e.at(1),this.concatenateLinkedLists(t.cons(e.cdr(),t.cdr()))))},a.prototype.reportLinkedNumbers=function(t,e){var o;if(null===this.context.accumulator&&(this.assertType(t,"number"),this.assertType(e,"number"),this.context.accumulator={target:new d,end:null,idx:+t,step:+e>+t?1:-1},this.context.accumulator.target.isLinked=!0,this.context.accumulator.end=this.context.accumulator.target),1===(o=this.context.accumulator).step?o.idx>+e:o.idx<+e)return o.end.rest=new d,void this.returnValueToParentContext(o.target.cdr());o.end.rest=o.target.cons(o.idx),o.end=o.end.rest,o.idx+=o.step,this.pushContext()},a.prototype.doIf=function(){var t=this.context.inputs,e=this.context.outerContext,o=this.context.isCustomBlock;this.popContext(),t[0]&&t[1]&&(this.pushContext(t[1].blockSequence(),e),this.context.isCustomBlock=o),this.pushContext()},a.prototype.doIfElse=function(){var t=this.context.inputs,e=this.context.outerContext,o=this.context.isCustomBlock;this.popContext(),t[0]?t[1]&&this.pushContext(t[1].blockSequence(),e):t[2]?this.pushContext(t[2].blockSequence(),e):this.pushContext("doYield"),this.context&&(this.context.isCustomBlock=o),this.pushContext()},a.prototype.reportIfElse=function(t){var e=this.context.inputs;if(e.length<1)this.evaluateNextInput(t);else if(e.length>1){if(this.flashContext())return;this.returnValueToParentContext(e.pop()),this.popContext()}else e[0]||e.push(null),this.evaluateNextInput(t)},a.prototype.doStop=function(){this.stop()},a.prototype.doStopAll=function(){var t,e;this.homeContext.receiver&&((t=this.homeContext.receiver.parentThatIsA(b))&&(t.enableCustomHatBlocks?t.threads.pauseCustomHatBlocks=!t.threads.pauseCustomHatBlocks:t.threads.pauseCustomHatBlocks=!1,t.stopAllActiveSounds(),t.threads.resumeAll(t),t.keysPressed={},t.runStopScripts(),t.threads.stopAll(),t.projectionSource&&t.stopProjection(),t.children.forEach((t=>{t.stopTalking&&t.stopTalking()})),t.removeAllClones()),(e=t.parentThatIsA(IDE_Morph))&&(e.controlBar.pauseButton.refresh(),e.controlBar.stopButton.refresh()))},a.prototype.doStopThis=function(t){switch(this.inputOption(t)){case"all":this.doStopAll();break;case"this script":this.doStop();break;case"this block":this.doStopBlock();break;default:this.doStopOthers(t)}},a.prototype.doStopOthers=function(t){var e;if(this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(b)))switch(this.inputOption(t)){case"all but this script":e.threads.stopAll(this);break;case"other scripts in sprite":e.threads.stopAllForReceiver(this.homeContext.receiver,this);break;default:(0,o.WY)()}},a.prototype.doWarp=function(t){var e,o=this.context.outerContext,i=this.context.isCustomBlock;this.popContext(),t&&(this.homeContext.receiver&&(this.homeContext.receiver.startWarp&&this.homeContext.receiver.startWarp(),(e=this.homeContext.receiver.parentThatIsA(b))&&(e.fps=0)),this.pushContext("popContext"),this.context&&(this.context.isCustomBlock=i),this.isAtomic||this.pushContext("doStopWarping"),this.pushContext(t.blockSequence(),o),this.isAtomic=!0),this.pushContext()},a.prototype.doStopWarping=function(){var t;this.popContext(),this.isAtomic=!1,this.homeContext.receiver&&(this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp(),(t=this.homeContext.receiver.parentThatIsA(b))&&(t.fps=t.frameRate))},a.prototype.reportIsFastTracking=function(){var t;return!(!this.homeContext.receiver||!(t=this.homeContext.receiver.parentThatIsA(IDE_Morph)))&&t.stage.isFastTracked},a.prototype.doSetGlobalFlag=function(t,e){var o=this.homeContext.receiver.parentThatIsA(b);switch(t=this.inputOption(t),this.assertType(e,"Boolean"),t){case"turbo mode":this.doSetFastTracking(e);break;case"flat line ends":y.prototype.useFlatLineEnds=e;break;case"log pen vectors":b.prototype.enablePenLogging=e;break;case"video capture":e?this.startVideo(o):o.stopProjection();break;case"mirror video":o.mirrorVideo=e}},a.prototype.reportGlobalFlag=function(t){var e=this.homeContext.receiver.parentThatIsA(b);switch(t=this.inputOption(t)){case"turbo mode":return this.reportIsFastTracking();case"flat line ends":return y.prototype.useFlatLineEnds;case"log pen vectors":return b.prototype.enablePenLogging;case"video capture":return!(0,o.kK)(e.projectionSource)&&e.projectionLayer().getContext("2d").getImageData(0,0,1,1).data[3]>0;case"mirror video":return e.mirrorVideo;default:return""}},a.prototype.doSetFastTracking=function(t){var e;this.reportIsA(t,"Boolean")&&this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(IDE_Morph))&&(t?e.startFastTracking():e.stopFastTracking())},a.prototype.doPauseAll=function(){var t,e;this.homeContext.receiver&&((t=this.homeContext.receiver.parentThatIsA(b))&&t.threads.pauseAll(t),(e=t.parentThatIsA(IDE_Morph))&&e.controlBar.pauseButton.refresh())},a.prototype.doForever=function(t){this.context.inputs=[],this.pushContext("doYield"),t&&this.pushContext(t.blockSequence()),this.pushContext()},a.prototype.doRepeat=function(t,e){var o=this.context.expression,i=this.context.outerContext,s=this.context.isCustomBlock;if(t<1)return null;this.popContext(),this.pushContext(o,i),this.context.isCustomBlock=s,this.context.addInput(t-1),this.pushContext("doYield"),e&&this.pushContext(e.blockSequence()),this.pushContext()},a.prototype.doUntil=function(t,e){if(t)return this.popContext(),this.pushContext("doYield"),null;this.context.inputs=[],this.pushContext("doYield"),e&&this.pushContext(e.blockSequence()),this.pushContext()},a.prototype.doWaitUntil=function(t){if(t)return this.popContext(),this.pushContext("doYield"),null;this.context.inputs=[],this.pushContext("doYield"),this.pushContext()},a.prototype.doForEach=function(t,e,o){var i;null===this.context.accumulator&&(this.assertType(e,"list"),this.context.accumulator={source:e,remaining:e.length(),idx:0}),0!==this.context.accumulator.remaining&&(this.context.accumulator.remaining-=1,this.context.accumulator.source.isLinked?(i=this.context.accumulator.source.at(1),this.context.accumulator.source=this.context.accumulator.source.cdr()):(this.context.accumulator.idx+=1,i=this.context.accumulator.source.at(this.context.accumulator.idx)),this.pushContext("doYield"),this.pushContext(),this.context.outerContext.variables.addVar(t),this.context.outerContext.variables.setVar(t,i),this.evaluate(o,new d([i]),!0))},a.prototype.doFor=function(t,e,o,i){var s=this.context.outerContext.variables,r=this.context.accumulator;null===r?(this.assertType(e,"number"),this.assertType(o,"number"),r=this.context.accumulator={test:+e<+o?()=>s.getVar(t)>+o:()=>s.getVar(t)<+o,step:+e<+o?1:-1,parms:new d},s.addVar(t),s.setVar(t,Math.floor(+e))):s.changeVar(t,r.step),r.test()||(this.pushContext("doYield"),this.pushContext(),this.evaluate(i,r.parms,!0))},a.prototype.reportMap=function(t,e){var o,i,s;if(e.isLinked){if(null===this.context.accumulator?(this.assertType(e,"list"),this.context.accumulator={source:e,idx:1,target:new d,end:null,remaining:e.length()},this.context.accumulator.target.isLinked=!0,this.context.accumulator.end=this.context.accumulator.target):this.context.inputs.length>2&&(this.context.accumulator.end.rest=e.cons(this.context.inputs.pop()),this.context.accumulator.end=this.context.accumulator.end.rest,this.context.accumulator.idx+=1,this.context.accumulator.remaining-=1),0===this.context.accumulator.remaining)return this.context.accumulator.end.rest=e.cons(this.context.inputs[2]).cdr(),void this.returnValueToParentContext(this.context.accumulator.target.cdr());i=this.context.accumulator.idx,o=this.context.accumulator.source.at(1),this.context.accumulator.source=this.context.accumulator.source.cdr()}else{if(null===this.context.accumulator?(this.assertType(e,"list"),this.context.accumulator=[]):this.context.inputs.length>2&&this.context.accumulator.push(this.context.inputs.pop()),this.context.accumulator.length===e.length())return void this.returnValueToParentContext(new d(this.context.accumulator));i=this.context.accumulator.length+1,o=e.at(i)}this.pushContext(),s=[o],t.inputs.length>1&&s.push(i),t.inputs.length>2&&s.push(e),this.evaluate(t,new d(s))},a.prototype.reportKeep=function(t,e){var o,i,s;if(e.isLinked){if(null===this.context.accumulator?(this.assertType(e,"list"),this.context.accumulator={source:e,idx:1,target:new d,end:null,remaining:e.length()},this.context.accumulator.target.isLinked=!0,this.context.accumulator.end=this.context.accumulator.target):this.context.inputs.length>2&&(!0===this.context.inputs.pop()&&(this.context.accumulator.end.rest=e.cons(this.context.accumulator.source.at(1)),this.context.accumulator.end=this.context.accumulator.end.rest),this.context.accumulator.remaining-=1,this.context.accumulator.idx+=1,this.context.accumulator.source=this.context.accumulator.source.cdr()),0===this.context.accumulator.remaining)return this.context.accumulator.end.rest=new d,void this.returnValueToParentContext(this.context.accumulator.target.cdr());i=this.context.accumulator.idx,o=this.context.accumulator.source.at(1)}else{if(null===this.context.accumulator?(this.assertType(e,"list"),this.context.accumulator={idx:0,target:[]}):this.context.inputs.length>2&&!0===this.context.inputs.pop()&&this.context.accumulator.target.push(e.at(this.context.accumulator.idx)),this.context.accumulator.idx===e.length())return void this.returnValueToParentContext(new d(this.context.accumulator.target));this.context.accumulator.idx+=1,i=this.context.accumulator.idx,o=e.at(i)}this.pushContext(),s=[o],t.inputs.length>1&&s.push(i),t.inputs.length>2&&s.push(e),this.evaluate(t,new d(s))},a.prototype.reportFindFirst=function(t,e){var o,i,s;if(e.isLinked){if(null===this.context.accumulator)this.assertType(e,"list"),this.context.accumulator={source:e,idx:1,remaining:e.length()};else if(this.context.inputs.length>2){if(!0===this.context.inputs.pop())return void this.returnValueToParentContext(this.context.accumulator.source.at(1));this.context.accumulator.remaining-=1,this.context.accumulator.idx+=1,this.context.accumulator.source=this.context.accumulator.source.cdr()}if(0===this.context.accumulator.remaining)return void this.returnValueToParentContext("");i=this.context.accumulator.idx,o=this.context.accumulator.source.at(1)}else{if(null===this.context.accumulator)this.assertType(e,"list"),this.context.accumulator={idx:0,current:null};else if(this.context.inputs.length>2&&!0===this.context.inputs.pop())return void this.returnValueToParentContext(this.context.accumulator.current);if(this.context.accumulator.idx===e.length())return void this.returnValueToParentContext("");this.context.accumulator.idx+=1,i=this.context.accumulator.idx,o=e.at(i),this.context.accumulator.current=o}this.pushContext(),s=[o],t.inputs.length>1&&s.push(i),t.inputs.length>2&&s.push(e),this.evaluate(t,new d(s))},a.prototype.reportCombine=function(t,e){var o,i,s,r;if(this.assertType(t,"list"),t.length()<2)this.returnValueToParentContext(t.length()?t.at(1):0);else{if(t.isLinked){if(null===this.context.accumulator?this.context.accumulator={source:t.cdr(),idx:1,target:t.at(1),remaining:t.length()-1}:this.context.inputs.length>2&&(this.context.accumulator.target=this.context.inputs.pop(),this.context.accumulator.remaining-=1,this.context.accumulator.idx+=1,this.context.accumulator.source=this.context.accumulator.source.cdr()),0===this.context.accumulator.remaining)return void this.returnValueToParentContext(this.context.accumulator.target);o=this.context.accumulator.source.at(1)}else{if(null===this.context.accumulator?this.context.accumulator={idx:1,target:t.at(1)}:this.context.inputs.length>2&&(this.context.accumulator.target=this.context.inputs.pop()),this.context.accumulator.idx===t.length())return void this.returnValueToParentContext(this.context.accumulator.target);this.context.accumulator.idx+=1,o=t.at(this.context.accumulator.idx)}s=this.context.accumulator.idx,i=this.context.accumulator.target,this.pushContext(),r=[i,o],e.inputs.length>2&&r.push(s),e.inputs.length>3&&r.push(t),this.evaluate(e,new d(r))}},a.prototype.doWait=function(t){if(this.context.startTime||(this.context.startTime=Date.now()),Date.now()-this.context.startTime>=1e3*t)return this.isAtomic||0!==t||(this.readyToYield=!0),null;this.pushContext("doYield"),this.pushContext()},a.prototype.doGlide=function(t,e,i){if(this.context.startTime||(this.context.startTime=Date.now(),this.context.startValue=new o.E9(this.blockReceiver().xPosition(),this.blockReceiver().yPosition())),Date.now()-this.context.startTime>=1e3*t)return this.blockReceiver().gotoXY(e,i),null;this.blockReceiver().glide(1e3*t,e,i,Date.now()-this.context.startTime,this.context.startValue),this.pushContext("doYield"),this.pushContext()},a.prototype.doSayFor=function(t,e){if(this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().bubble(t)),Date.now()-this.context.startTime>=1e3*e)return this.blockReceiver().stopTalking(),null;this.pushContext("doYield"),this.pushContext()},a.prototype.doThinkFor=function(t,e){if(this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().doThink(t)),Date.now()-this.context.startTime>=1e3*e)return this.blockReceiver().stopTalking(),null;this.pushContext("doYield"),this.pushContext()},a.prototype.blockReceiver=function(){return this.context?this.context.receiver||this.homeContext.receiver:this.homeContext.receiver||this.receiver},a.prototype.playSound=function(t){return t instanceof d?this.doPlaySoundAtRate(t,44100):this.blockReceiver().doPlaySound(t)},a.prototype.doPlaySoundUntilDone=function(t){if(null===this.context.activeAudio&&(this.context.activeAudio=this.playSound(t)),null===t||this.context.activeAudio.ended||this.context.activeAudio.terminated)return null;this.pushContext("doYield"),this.pushContext()},a.prototype.doStopAllSounds=function(){var t=this.homeContext.receiver.parentThatIsA(b);t&&(t.threads.processes.forEach((t=>{t.context&&(t.context.stopMusic(),t.context.activeAudio&&t.popContext())})),t.stopAllActiveSounds())},a.prototype.doPlaySoundAtRate=function(t,e){var i,s,r,n,a,h,l;if(t instanceof d)s=t;else{if(!(i=t instanceof Sound?t:"number"==typeof t?this.blockReceiver().sounds.at(t):(0,o.qY)(this.blockReceiver().sounds.asArray(),(e=>e.name===t.toString()))).audioBuffer)return void this.decodeSound(i);s=this.reportGetSoundAttribute("samples",i)}return r=(l=this.blockReceiver()).audioContext(),n=l.getGainNode(),a=l.getPannerNode(),h=this.encodeSound(s,e),l.setVolume(l.volume),h.connect(n),a?(n.connect(a),a.connect(r.destination),l.setPan(l.pan)):n.connect(r.destination),h.pause=h.stop,h.ended=!1,h.onended=()=>h.ended=!0,h.start(),l.parentThatIsA(b).activeSounds.push(h),h},a.prototype.reportGetSoundAttribute=function(t,e){var i=e instanceof Sound?e:"number"==typeof e?this.blockReceiver().sounds.at(e):e instanceof d?this.encodeSound(e):(0,o.qY)(this.blockReceiver().sounds.asArray(),(t=>t.name===e.toString())),s=this.inputOption(t);if("name"===s)return i.name;if(i.audioBuffer)switch(s){case"samples":return i.cachedSamples||(i.cachedSamples=function(t,e){var o,i,s=t.audioBuffer;if(s.numberOfChannels>1){for(o=new d,i=0;i<s.numberOfChannels;i+=1)o.add(new d(e(s.getChannelData(i))));return o}return new d(e(s.getChannelData(0)))}(i,this.untype)),i.cachedSamples;case"sample rate":return i.audioBuffer.sampleRate;case"duration":return i.audioBuffer.duration;case"length":return i.audioBuffer.length;case"number of channels":return i.audioBuffer.numberOfChannels;default:return 0}else this.decodeSound(i)},a.prototype.decodeSound=function(t,e){var i,s,r,n,a,h,l;if(t.audioBuffer)return(e||o.WY)(t);if(!t.isDecoding){for(i=t.audio.src.split(",")[1],r=(s=window.atob(i)).length,n=new Uint8Array(r),a=0;a<r;a+=1)n[a]=s.charCodeAt(a);h=n.buffer,l=Note.prototype.getAudioContext(),t.isDecoding=!0,l.decodeAudioData(h,(e=>{t.audioBuffer=e,t.isDecoding=!1}),(e=>{t.isDecoding=!1,this.handleError(e)}))}this.pushContext("doYield"),this.pushContext()},a.prototype.encodeSound=function(t,e){var o,i,s=this.blockReceiver().audioContext(),r=t.at(1)instanceof d?t.length():1,n=1===r?t.length():t.at(1).length(),a=s.createBuffer(r,n,+e||44100);if(a.copyToChannel||(a.copyToChannel=function(t,e){var i=this.getChannelData(e);for(o=0;o<t.length;o+=1)i[o]=t[o]}),1===r)a.copyToChannel(Float32Array.from(t.asArray()),0,0);else for(o=0;o<r;o+=1)a.copyToChannel(Float32Array.from(t.at(o+1).asArray()),o,0);return(i=s.createBufferSource()).buffer=a,i.audioBuffer=i.buffer,i},a.prototype.reportNewSoundFromSamples=function(t,e){var i,s,r;if((0,o.kK)(this.context.accumulator)&&(this.assertType(t,"list"),this.context.accumulator={audio:null},i=new Audio,s=new Blob([this.audioBufferToWav(this.encodeSound(t,e||44100).audioBuffer)],{type:"audio/wav"}),(r=new FileReader).onload=()=>{i.src=r.result,this.context.accumulator.audio=i},r.readAsDataURL(s)),this.context.accumulator.audio)return new Sound(this.context.accumulator.audio,this.blockReceiver().newSoundName((0,o.NC)("sound")));this.pushContext("doYield"),this.pushContext()},a.prototype.audioBufferToWav=function(t,e){var o,i=t.numberOfChannels,s=t.sampleRate,r=(e||{}).float32?3:1,n=3===r?32:16;return o=2===i?function(t,e){for(var o=t.length+e.length,i=new Float32Array(o),s=0,r=0;s<o;)i[s++]=t[r],i[s++]=e[r],r+=1;return i}(t.getChannelData(0),t.getChannelData(1)):t.getChannelData(0),this.encodeWAV(o,r,s,i,n)},a.prototype.encodeWAV=function(t,e,o,i,s){var r=s/8,n=i*r,a=new ArrayBuffer(44+t.length*r),h=new DataView(a);function l(t,e,o){for(var i=0;i<o.length;i+=1)t.setUint8(e+i,o.charCodeAt(i))}return l(h,0,"RIFF"),h.setUint32(4,36+t.length*r,!0),l(h,8,"WAVE"),l(h,12,"fmt "),h.setUint32(16,16,!0),h.setUint16(20,e,!0),h.setUint16(22,i,!0),h.setUint32(24,o,!0),h.setUint32(28,o*n,!0),h.setUint16(32,n,!0),h.setUint16(34,s,!0),l(h,36,"data"),h.setUint32(40,t.length*r,!0),1===e?function(t,e,o){var i,s;for(i=0;i<o.length;i+=1,e+=2)s=Math.max(-1,Math.min(1,o[i])),t.setInt16(e,s<0?32768*s:32767*s,!0)}(h,44,t):function(t,e,o){for(var i=0;i<o.length;i+=1,e+=4)t.setFloat32(e,o[i],!0)}(h,44,t),a},a.prototype.reportAudio=function(t){var e=this.blockReceiver().parentThatIsA(b),o=this.inputOption(t);if("resolution"===o)return e.microphone.binSize();if("modifier"===o)return e.microphone.modifier;if(e.microphone.isOn())switch(o){case"volume":return 100*e.microphone.volume;case"frequency":return e.microphone.pitch;case"note":return e.microphone.note;case"samples":return new d(this.untype(e.microphone.signals));case"sample rate":return e.microphone.audioContext.sampleRate;case"output":return new d(this.untype(e.microphone.output));case"spectrum":return new d(this.untype(e.microphone.frequencies));default:return null}this.pushContext("doYield"),this.pushContext()},a.prototype.untype=function(t){var e,o=t.length,i=new Array(o);for(e=0;e<o;e+=1)i[e]=t[e];return i},a.prototype.setMicrophoneModifier=function(t){var e=this.blockReceiver().parentThatIsA(b);if(!t||(0,o.r3)(["sprite","stage","list","costume","sound","number","text","Boolean"],this.reportTypeOf(t)))return e.microphone.modifier=null,void e.microphone.stop();e.microphone.modifier=t,e.microphone.compiledModifier=this.reportCompiled(t,1),e.microphone.compilerProcess=this},a.prototype.doAsk=function(t){var e=this.homeContext.receiver.parentThatIsA(b),i=this.blockReceiver(),s=i instanceof b,r=i instanceof y&&!i.isVisible;if(e.keysPressed={},this.prompter){if(this.prompter.isDone)return e.lastAnswer=this.prompter.inputField.getValue(),this.prompter.destroy(),this.prompter=null,s||i.stopTalking(),null}else(0,o.qY)(e.children,(t=>t instanceof P))||(s||r||i.bubble(t,!1,!0),this.prompter=new P(s||r?t:null),e.scale<1?this.prompter.setWidth(e.width()-10):this.prompter.setWidth(e.dimensions.x-20),this.prompter.fixLayout(),this.prompter.setCenter(e.center()),this.prompter.setBottom(e.bottom()-this.prompter.border),e.add(this.prompter),this.prompter.inputField.edit(),e.changed());this.pushContext("doYield"),this.pushContext()},a.prototype.reportLastAnswer=function(){return this.homeContext.receiver.parentThatIsA(b).lastAnswer},a.prototype.reportURL=function(t){var e;if(this.httpRequest){if(4===this.httpRequest.readyState)return e=this.httpRequest.responseText,this.httpRequest=null,e}else if((t.indexOf("//")<0||t.indexOf("//")>8)&&(t="file:"===location.protocol?"https://"+t:location.protocol+"//"+t),this.httpRequest=new XMLHttpRequest,this.httpRequest.open("GET",t,!0),this.httpRequest.send(null),this.context.isCustomCommand)return this.httpRequest=null,null;this.pushContext("doYield"),this.pushContext()},a.prototype.doBroadcast=function(t){var e,i,s,r=this.homeContext.receiver.parentThatIsA(b),n=this.inputOption(t),a=[];if(!this.canBroadcast)return[];if(t instanceof d&&2===t.length())if(e=this.blockReceiver(),n=t.at(1),i=t.at(2),isSnapObject(i))s=[i];else if((0,o.HD)(i))s=i===r.name?[r]:[this.getOtherObject(i,e,r)];else{if(!(i instanceof d))return;s=i.itemsArray().map((t=>this.getOtherObject(t,e,r)))}else s=r.children.concat(r);return""!==n&&(r.lastMessage=t,s.forEach((t=>{isSnapObject(t)&&t.allHatBlocksFor(n).forEach((e=>{a.push(r.threads.startProcess(e,t,r.isThreadSafe))}))})),(r.messageCallbacks[""]||[]).forEach((t=>t(n))),(r.messageCallbacks[n]||[]).forEach((t=>t()))),a},a.prototype.doBroadcastAndWait=function(t){if(this.context.activeSends||(this.context.activeSends=this.doBroadcast(t),this.isRunning()&&this.context.activeSends.forEach((t=>t.runStep()))),this.context.activeSends=this.context.activeSends.filter((t=>t.isRunning())),0===this.context.activeSends.length)return null;this.pushContext("doYield"),this.pushContext()},a.prototype.getLastMessage=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(b))?t.getLastMessage():""},a.prototype.doSend=function(t,e){var o=this.homeContext.receiver.parentThatIsA(b);this.doBroadcast(new d([t,e instanceof d?e:e===o.name?new d([o]):new d([e])]))},a.prototype.reportIsA=function(t,e){return this.reportTypeOf(t)===this.inputOption(e)},a.prototype.assertType=function(t,e){var i=this.reportTypeOf(t);if(i===e)return!0;if(e instanceof Array&&(0,o.r3)(e,i))return!0;throw new Error("expecting "+e+" but getting "+i)},a.prototype.assertAlive=function(t){if(t&&t.isCorpse)throw new Error("cannot operate on a deleted sprite")},a.prototype.reportTypeOf=function(t){var e;return null==t?"nothing":!0===t||!1===t?"Boolean":t instanceof d?"list":parseFloat(t)===+t?"number":(0,o.HD)(t)?"text":t instanceof y?"sprite":t instanceof b?"stage":t instanceof Costume?"costume":t instanceof Sound?"sound":t instanceof h?t.expression instanceof O?t.expression.dataType():t.expression instanceof D?t.expression.isPredicate?"predicate":"reporter":t.expression instanceof Array?(e=t.expression[t.pc||0]).isPredicate?"predicate":e instanceof O?e.dataType():e instanceof D?"reporter":e instanceof R?"command":"reporter":t.expression instanceof R?"command":"reporter":"undefined"},a.prototype.hyperDyadic=function(t,e,o){var i,s,r;if(this.enableHyperOps){if(this.isMatrix(e)){if(this.isMatrix(o)){for(e=e.asArray(),o=o.asArray(),i=Math.min(e.length,o.length),r=new Array(i),s=0;s<i;s+=1)r[s]=this.hyperDyadic(t,e[s],o[s]);return new d(r)}return e.map((e=>this.hyperDyadic(t,e,o)))}return this.isMatrix(o)?o.map((o=>this.hyperDyadic(t,e,o))):this.hyperZip(t,e,o)}return t(e,o)},a.prototype.hyperZip=function(t,e,o){var i,s,r;if(e instanceof d){if(o instanceof d){for(e=e.asArray(),o=o.asArray(),i=Math.min(e.length,o.length),r=new Array(i),s=0;s<i;s+=1)r[s]=this.hyperZip(t,e[s],o[s]);return new d(r)}return e.map((e=>this.hyperZip(t,e,o)))}return o instanceof d?o.map((o=>this.hyperZip(t,e,o))):t(e,o)},a.prototype.isMatrix=function(t){return t instanceof d&&t.at(1)instanceof d},a.prototype.rank=function(t){for(var e=0,o=t;o instanceof d;)e+=1,o=o.at(1);return e},a.prototype.reportSum=function(t,e){return this.hyperDyadic(this.reportBasicSum,t,e)},a.prototype.reportBasicSum=function(t,e){return+t+ +e},a.prototype.reportDifference=function(t,e){return this.hyperDyadic(this.reportBasicDifference,t,e)},a.prototype.reportBasicDifference=function(t,e){return+t-+e},a.prototype.reportProduct=function(t,e){return this.hyperDyadic(this.reportBasicProduct,t,e)},a.prototype.reportBasicProduct=function(t,e){return+t*+e},a.prototype.reportQuotient=function(t,e){return this.hyperDyadic(this.reportBasicQuotient,t,e)},a.prototype.reportBasicQuotient=function(t,e){return+t/+e},a.prototype.reportPower=function(t,e){return this.hyperDyadic(this.reportBasicPower,t,e)},a.prototype.reportBasicPower=function(t,e){return Math.pow(+t,+e)},a.prototype.reportModulus=function(t,e){return this.hyperDyadic(this.reportBasicModulus,t,e)},a.prototype.reportBasicModulus=function(t,e){var o=+e;return(+t%o+o)%o},a.prototype.reportRandom=function(t,e){return this.hyperDyadic(this.reportBasicRandom,t,e)},a.prototype.reportBasicRandom=function(t,e){var o=+t,i=+e;return o%1!=0||i%1!=0?Math.random()*(i-o)+o:Math.floor(Math.random()*(i-o+1))+o},a.prototype.reportLessThan=function(t,e){return this.hyperDyadic(this.reportBasicLessThan,t,e)},a.prototype.reportBasicLessThan=function(t,e){var o=+t,i=+e;return(isNaN(o)||isNaN(i))&&(o=t,i=e),o<i},a.prototype.reportNot=function(t){return this.enableHyperOps&&t instanceof d?t.map((t=>this.reportNot(t))):!t},a.prototype.reportGreaterThan=function(t,e){return this.hyperDyadic(this.reportBasicGreaterThan,t,e)},a.prototype.reportBasicGreaterThan=function(t,e){var o=+t,i=+e;return(isNaN(o)||isNaN(i))&&(o=t,i=e),o>i},a.prototype.reportEquals=function(t,e){return Vt(t,e)},a.prototype.reportIsIdentical=function(t,e){var o="idTag";if(this.isImmutable(t)||this.isImmutable(e))return Vt(t,e);function i(){Object.prototype.hasOwnProperty.call(t,o)&&delete t[o],Object.prototype.hasOwnProperty.call(e,o)&&delete e[o]}return i(),t[o]=Date.now(),e[o]===t[o]?(i(),!0):(i(),!1)},a.prototype.isImmutable=function(t){var e=this.reportTypeOf(t);return"nothing"===e||"Boolean"===e||"text"===e||"number"===e||"undefined"===e},a.prototype.reportBoolean=function(t){return t},a.prototype.reportRound=function(t){return this.enableHyperOps&&t instanceof d?t.map((t=>this.reportRound(t))):Math.round(+t)},a.prototype.reportMonadic=function(t,e){if(this.enableHyperOps&&e instanceof d)return e.map((e=>this.reportMonadic(t,e)));var i=+e,s=0;switch(this.inputOption(t)){case"abs":s=Math.abs(i);break;case"neg":s=-1*e;break;case"ceiling":s=Math.ceil(i);break;case"floor":s=Math.floor(i);break;case"sqrt":s=Math.sqrt(i);break;case"sin":s=Math.sin((0,o.uR)(i));break;case"cos":s=Math.cos((0,o.uR)(i));break;case"tan":s=Math.tan((0,o.uR)(i));break;case"asin":s=(0,o.RW)(Math.asin(i));break;case"acos":s=(0,o.RW)(Math.acos(i));break;case"atan":s=(0,o.RW)(Math.atan(i));break;case"ln":s=Math.log(i);break;case"log":s=Math.log10(i);break;case"lg":s=Math.log2(i);break;case"e^":s=Math.exp(i);break;case"10^":s=Math.pow(10,i);break;case"2^":s=Math.pow(2,i);break;case"id":return e;default:(0,o.WY)()}return s},a.prototype.reportTextFunction=function(t,e){var i=((0,o.kK)(e)?"":e).toString(),s="";switch(this.inputOption(t)){case"encode URI":s=encodeURI(i);break;case"decode URI":s=decodeURI(i);break;case"encode URI component":s=encodeURIComponent(i);break;case"decode URI component":s=decodeURIComponent(i);break;case"XML escape":s=(new XML_Element).escape(i);break;case"XML unescape":s=(new XML_Element).unescape(i);break;case"hex sha512 hash":s=hex_sha512(i);break;default:(0,o.WY)()}return s},a.prototype.reportJoin=function(t,e){var i=((0,o.kK)(t)?"":t).toString(),s=((0,o.kK)(e)?"":e).toString();return i.concat(s)},a.prototype.reportJoinWords=function(t){return t instanceof d?t.asText():(t||"").toString()},a.prototype.reportLetter=function(t,e){return this.hyperDyadic(((t,e)=>this.reportBasicLetter(t,e)),t,e)},a.prototype.reportBasicLetter=function(t,e){var i;return i=(0,o.kK)(e)?"":e.toString(),"any"===this.inputOption(t)&&(t=this.reportBasicRandom(1,i.length)),"last"===this.inputOption(t)&&(t=i.length),i[+(t||0)-1]||""},a.prototype.reportStringSize=function(t){return this.enableHyperOps&&t instanceof d?t.map((t=>this.reportStringSize(t))):t instanceof d?t.length():(0,o.kK)(t)?0:t.toString().length},a.prototype.reportUnicode=function(t){var e;if(this.enableHyperOps){if(t instanceof d)return t.map((t=>this.reportUnicode(t)));if((e=(0,o.kK)(t)?"\0":t.toString()).length>1)return this.reportUnicode(new d(e.split("")))}else e=(0,o.kK)(t)?"\0":t.toString();return e.codePointAt?e.codePointAt(0)||0:e.charCodeAt(0)||0},a.prototype.reportUnicodeAsLetter=function(t){if(this.enableHyperOps&&t instanceof d)return t.map((t=>this.reportUnicodeAsLetter(t)));var e=+(t||0);return String.fromCodePoint?String.fromCodePoint(e):String.fromCharCode(e)},a.prototype.reportTextSplit=function(t,e){return this.hyperDyadic(((t,e)=>this.reportBasicTextSplit(t,e)),t,e)},a.prototype.reportBasicTextSplit=function(t,e){var i,s,r=["text","number"],n=this.reportTypeOf(t),a=this.reportTypeOf(this.inputOption(e));if(!(0,o.r3)(r,n))throw new Error("expecting text instead of a "+n);if(!(0,o.r3)(r,a))throw new Error("expecting a text delimiter instead of a "+a);switch(i=(0,o.kK)(t)?"":t.toString(),this.inputOption(e)){case"line":s=/\r\n|[\n\v\f\r\x85\u2028\u2029]/;break;case"tab":s="\t";break;case"cr":s="\r";break;case"word":case"whitespace":i=i.trim(),s=/\s+/;break;case"letter":s="";break;case"csv":return this.parseCSV(t);case"json":return this.parseJSON(t);default:s=(0,o.kK)(e)?"":e.toString()}return new d(i.split(s))},a.prototype.parseCSV=function(t){return this.rawParseCSV(t,this.guessDelimiterCSV(t))},a.prototype.guessDelimiterCSV=function(t){var e,o=[",",";","|","\t"],i=o.length,s=t.split("\n")[0];for(e=0;e<i;e+=1)if(this.rawParseCSV(s,o[e]).length()>1)return o[e];return o[0]},a.prototype.rawParseCSV=function(t,e){var o,i,s="",r=[""],n=[r],a=0,h=0,l=!0,p=t.length;for(e=e||",",o=0;o<p;o+=1)'"'===(i=t[o])?(l&&i===s&&(r[a]+=i),l=!l):i===e&&l?(i="",r[a+=1]=i):"\r"===i&&l?(n[h+=1]=[""],r=n[h],a=0):"\n"===i&&l?"\r"!==s&&(n[h+=1]=[""],r=n[h],a=0):r[a]+=i,s=i;return 1===n[n.length-1].length&&""===n[n.length-1][0]&&n.pop(),1===(n=new d(n.map((t=>new d(t))))).length()?n.at(1):n},a.prototype.parseJSON=function(t){return function t(e){return e instanceof Array?new d(e.map((function(e){return t(e)}))):e instanceof Object?new d(Object.keys(e).map((function(o){return new d([o,t(e[o])])}))):e}(JSON.parse(t))},a.prototype.alert=function(t){this.homeContext.receiver&&this.homeContext.receiver.world().isDevMode&&alert("Snap! "+t.asArray())},a.prototype.log=function(t){this.homeContext.receiver&&this.homeContext.receiver.world().isDevMode&&console.log("Snap! "+t.asArray())},a.prototype.getOtherObject=function(t,e,i){if(isSnapObject(t))return t;if("myself"===this.inputOption(t))return e;var s=(0,o.kK)(i)?e.parentThatIsA(b):i,r=null;return s&&((r=(0,o.qY)(s.children,(e=>e.name===t)))||(r=(0,o.qY)(s.world().hand.children,(e=>e instanceof y&&e.name===t)))),r},a.prototype.getObjectsNamed=function(t,e,i){var s=(0,o.kK)(i)?e.parentThatIsA(b):i,r=[];function n(e){return e instanceof y&&e.isTemporary?e.cloneOriginName===t:e.name===t}return s&&((r=s.children.filter(n)).length||(r=s.world().hand.children.filter(n))),r},a.prototype.setHeading=function(t){var e=this.blockReceiver();e&&("random"===this.inputOption(t)&&(t=this.reportBasicRandom(1,36e3)/100),e.setHeading(t))},a.prototype.setHeading=function(t){var e=this.blockReceiver();e&&("random"===this.inputOption(t)&&(t=this.reportRandom(1,36e3)/100),e.setHeading(t))},a.prototype.doFaceTowards=function(t){var e,o=this.blockReceiver();if(o)if("center"===this.inputOption(t))o.faceToXY(0,0);else if("mouse-pointer"===this.inputOption(t))o.faceToXY(this.reportMouseX(),this.reportMouseY());else if("random position"===this.inputOption(t))o.setHeading(this.reportBasicRandom(1,36e3)/100);else{if(t instanceof d)return void o.faceToXY(t.at(1),t.at(2));(e=this.getOtherObject(t,this.homeContext.receiver))&&o.faceToXY(e.xPosition(),e.yPosition())}},a.prototype.doGotoObject=function(t){var e,i,s=this.blockReceiver();if(s)if("center"===this.inputOption(t))s.gotoXY(0,0);else if("mouse-pointer"===this.inputOption(t))s.gotoXY(this.reportMouseX(),this.reportMouseY());else if("random position"===this.inputOption(t))(i=s.parentThatIsA(b))&&s.setCenter(new o.E9(this.reportBasicRandom(i.left(),i.right()),this.reportBasicRandom(i.top(),i.bottom())));else{if(t instanceof d)return void s.gotoXY(t.at(1),t.at(2));(e=this.getOtherObject(t,this.homeContext.receiver))&&s.gotoXY(e.xPosition(),e.yPosition())}},a.prototype.goToLayer=function(t){var e=this.inputOption(t),o=this.blockReceiver();o instanceof y&&("front"===e?o.comeToFront():"back"===e&&o.goToBack())},a.prototype.setHSVA=function(t,e){this.blockReceiver().setColorComponentHSVA(["hue","saturation","brightness","transparency"].indexOf(this.inputOption(t)),+e)},a.prototype.changeHSVA=function(t,e){this.blockReceiver().changeColorComponentHSVA(["hue","saturation","brightness","transparency"].indexOf(this.inputOption(t)),+e)},a.prototype.setPenHSVA=a.prototype.setHSVA,a.prototype.changePenHSVA=a.prototype.changeHSVA,a.prototype.setBackgroundHSVA=a.prototype.setHSVA,a.prototype.changeBackgroundHSVA=a.prototype.changeHSVA,a.prototype.doPasteOn=function(t){this.blitOn(t,"source-atop")},a.prototype.doCutFrom=function(t){this.blitOn(t,"destination-out")},a.prototype.blitOn=function(t,e,o,i){if(o=o||this.blockReceiver(),(i=i||o.parentThatIsA(b)).name===t&&(t=i),isSnapObject(t))return o.blitOn(t,e);(t instanceof d?t.itemsArray():this.getObjectsNamed(t,o,i)).forEach((t=>{t.inheritsAttribute("costume #")||this.blitOn(t,e,o,i)}))},a.prototype.createClone=function(t){var e,o=this.blockReceiver();t&&!this.readyToTerminate&&o&&("myself"===this.inputOption(t)?o.createClone(!this.isFirstStep):(e=this.getOtherObject(t,o))&&e.createClone(!this.isFirstStep))},a.prototype.newClone=function(t){var e,o=this.blockReceiver();if(t&&o){if("myself"===this.inputOption(t))return o.newClone(!this.isFirstStep);if(e=this.getOtherObject(t,o))return e.newClone(!this.isFirstStep)}},a.prototype.reportTouchingObject=function(t){var e=this.blockReceiver();return!!e&&this.objectTouchingObject(e,t)},a.prototype.objectTouchingObject=function(t,e){var o,i,s;if("mouse-pointer"===this.inputOption(e)){if(s=t.world().hand.position(),t.bounds.containsPoint(s)&&!t.isTransparentAt(s))return!0}else if(o=t.parentThatIsA(b)){if("edge"===this.inputOption(e)&&(i=t.bounds,!t.costume&&t.penBounds&&(i=t.penBounds.translateBy(t.position())),!o.bounds.containsRectangle(i)))return!0;if("pen trails"===this.inputOption(e)&&t.isTouching(o.penTrailsMorph()))return!0;if(isSnapObject(e))return e.isVisible&&t.isTouching(e);if((e instanceof d?e.itemsArray():this.getObjectsNamed(e,t,o)).some((e=>e.isVisible&&t.isTouching(e))))return!0}return t.parts.some((t=>this.objectTouchingObject(t,e)))},a.prototype.reportAspect=function(t,e){var i,s,r,n=this.inputOption(t),a=this.inputOption(e),h=["hue","saturation","brightness","transparency"].indexOf(n),l=this.blockReceiver(),p=l.parentThatIsA(b),c=l.world();if("myself"===a){if("sprites"===n)return s=l instanceof b?l.center():l.rotationCenter(),this.spritesAtPoint(s,p);r=this.colorAtSprite(l)}else if("mouse-pointer"===a){if("sprites"===n)return this.spritesAtPoint(c.hand.position(),p);r=c.getGlobalPixelColor(c.hand.position())}else if(a instanceof d){if(s=new o.E9(a.at(1)*p.scale+p.center().x,p.center().y-a.at(2)*p.scale),"sprites"===n)return this.spritesAtPoint(s,p);r=c.getGlobalPixelColor(s)}else{if(!a)return;if(!(i=this.getOtherObject(a,l,p)))return;if("sprites"===n)return s=i instanceof y?i.rotationCenter():i.center(),this.spritesAtPoint(s,p);r=this.colorAtSprite(i)}return"r-g-b-a"===n?new d([r.r,r.g,r.b,Math.round(255*r.a)]):h<0||h>3?void 0:3===h?100*(1-r.a):100*r.hsv()[h]},a.prototype.colorAtSprite=function(t){var e,i,s=t instanceof y?t.rotationCenter():t.center(),r=t.parentThatIsA(b);if(!r)return o.E5;for(i=r.children.length;i>0;i-=1)if((e=r.children[i-1])!==t&&e.isVisible&&e.bounds.containsPoint(s)&&!e.isTransparentAt(s))return e.getPixelColor(s);return r.bounds.containsPoint(s)?r.getPixelColor(s):o.E5},a.prototype.colorBelowSprite=function(t){var e,i,s=t instanceof y?t.rotationCenter():t.center(),r=t.parentThatIsA(b),n=r,a=!1;if(!r)return o.E5;for(i=0;i<r.children.length;i+=1)a||((e=r.children[i])===t?a=!0:e.isVisible&&e.bounds.containsPoint(s)&&!e.isTransparentAt(s)&&(n=e));return n.bounds.containsPoint(s)?n.getPixelColor(s):o.E5},a.prototype.spritesAtPoint=function(t,e){return new d(e.children.filter((e=>e instanceof y&&e.isVisible&&e.bounds.containsPoint(t)&&!e.isTransparentAt(t))))},a.prototype.reportAspect=function(t,e){var i,s,r,n=this.inputOption(t),a=this.inputOption(e),h=["hue","saturation","brightness","transparency"].indexOf(n),l=this.blockReceiver(),p=l.parentThatIsA(b),c=l.world();if("myself"===a){if("sprites"===n)return s=l instanceof b?l.center():l.rotationCenter(),this.spritesAtPoint(s,p);r=this.colorAtSprite(l)}else if("mouse-pointer"===a){if("sprites"===n)return this.spritesAtPoint(c.hand.position(),p);r=c.getGlobalPixelColor(c.hand.position())}else if(a instanceof d){if(s=new o.E9(a.at(1)*p.scale+p.center().x,p.center().y-a.at(2)*p.scale),"sprites"===n)return this.spritesAtPoint(s,p);r=c.getGlobalPixelColor(s)}else{if(!a)return;if(!(i=this.getOtherObject(a,l,p)))return;if("sprites"===n)return s=i instanceof y?i.rotationCenter():i.center(),this.spritesAtPoint(s,p);r=this.colorAtSprite(i)}if(!(h<0||h>3))return 3===h?100*(1-r.a):100*r.hsv()[h]},a.prototype.colorAtSprite=function(t){var e,o,i=t instanceof y?t.rotationCenter():t.center(),s=t.parentThatIsA(b),r=s,n=!1;if(!s)return new Color;for(o=0;o<s.children.length;o+=1)n||((e=s.children[o])===t?n=!0:e.isVisible&&e.bounds.containsPoint(i)&&!e.isTransparentAt(i)&&(r=e));return r.bounds.containsPoint(i)?r.getPixelColor(i):new Color},a.prototype.spritesAtPoint=function(t,e){return new d(e.children.filter((function(e){return e instanceof y&&e.isVisible&&e.bounds.containsPoint(t)&&!e.isTransparentAt(t)})))},a.prototype.reportRelationTo=function(t,e){if(this.enableHyperOps&&e instanceof d&&!this.isCoordinate(e))return e.map((e=>this.reportRelationTo(t,e)));var o=this.inputOption(t);return"distance"===o?this.reportDistanceTo(e):"direction"===o?this.reportDirectionTo(e):0},a.prototype.isCoordinate=function(t){return t instanceof d&&2===t.length()&&"number"===this.reportTypeOf(t.at(1))&&"number"===this.reportTypeOf(t.at(2))},a.prototype.reportDistanceTo=function(t){var e,i,s,r,n=this.blockReceiver();if(n){if(r=s=n.rotationCenter(),"mouse-pointer"===this.inputOption(t))r=n.world().hand.position();else{if("center"===this.inputOption(t))return new o.E9(n.xPosition(),n.yPosition()).distanceTo(o.xE);if(t instanceof d)return new o.E9(n.xPosition(),n.yPosition()).distanceTo(new o.E9(t.at(1),t.at(2)))}return i=n.parentThatIsA(b),(e=this.getOtherObject(t,n,i))&&(r=e.rotationCenter()),s.distanceTo(r)/i.scale}return 0},a.prototype.reportDirectionTo=function(t){var e,o=this.blockReceiver();return o?"mouse-pointer"===this.inputOption(t)?o.angleToXY(this.reportMouseX(),this.reportMouseY()):"center"===this.inputOption(t)?o.angleToXY(0,0):t instanceof d?o.angleToXY(t.at(1),t.at(2)):(e=this.getOtherObject(t,this.homeContext.receiver))?o.angleToXY(e.xPosition(),e.yPosition()):o.direction():0},a.prototype.reportAttributeOf=function(t,e){var i,s,r=this.blockReceiver();if(r&&(this.assertAlive(r),i=(s=r.parentThatIsA(b)).name===e?s:this.getOtherObject(e,r,s))){if(this.assertAlive(i),t instanceof A)return this.reportContextFor(this.reify(i.getMethod(t.semanticSpec).blockInstance(),new d),i);if(t instanceof h)return this.reportContextFor(t,i);if((0,o.HD)(t))return i.variables.getVar(t);switch(this.inputOption(t)){case"x position":return i.xPosition?i.xPosition():"";case"y position":return i.yPosition?i.yPosition():"";case"direction":return i.direction?i.direction():"";case"costume #":return i.getCostumeIdx();case"costume name":return i.costume?i.costume.name:i instanceof y?(0,o.NC)("Turtle"):(0,o.NC)("Empty");case"size":return i.getScale?i.getScale():"";case"volume":return i.getVolume();case"balance":return i.getPan();case"width":return i instanceof b?i.dimensions.x:(this.assertType(i,"sprite"),i.width()/s.scale);case"height":return i instanceof b?i.dimensions.y:(this.assertType(i,"sprite"),i.height()/s.scale);case"left":return i.xLeft();case"right":return i.xRight();case"top":return i.yTop();case"bottom":return i.yBottom()}}return""},a.prototype.reportGet=function(t){var e,o,i=this.blockReceiver();if(i)switch(this.inputOption(t)){case"self":return i;case"other sprites":return new d((e=i.parentThatIsA(b)).children.filter((t=>t instanceof y&&t!==i)));case"parts":return new d((i.parts||[]).map((t=>t)));case"anchor":return i.anchor||"";case"parent":return i.exemplar||"";case"children":return new d(i.specimens?i.specimens():[]);case"temporary?":return i.isTemporary||!1;case"clones":return e=i.parentThatIsA(b),o=i.name||i.cloneOriginName,new d(e.children.filter((t=>t.isTemporary&&t!==i&&t.cloneOriginName===o)));case"other clones":return i.isTemporary?this.reportGet(["clones"]):new d;case"neighbors":return i.neighbors();case"dangling?":return!i.rotatesWithAnchor;case"draggable?":return i.isDraggable;case"rotation style":return i.rotationStyle||0;case"rotation x":return i.xPosition();case"rotation y":return i.yPosition();case"center x":return i.xCenter();case"center y":return i.yCenter();case"left":return i.xLeft();case"right":return i.xRight();case"top":return i.yTop();case"bottom":return i.yBottom();case"name":return i.name;case"stage":return i.parentThatIsA(b);case"costume":return i.costume;case"costumes":return i.reportCostumes();case"sounds":return i.sounds;case"width":return i instanceof b?i.dimensions.x:(e=i.parentThatIsA(b))?i.width()/e.scale:0;case"height":return i instanceof b?i.dimensions.y:(e=i.parentThatIsA(b))?i.height()/e.scale:0}return""},a.prototype.reportObject=function(t){var e,o,i=this.blockReceiver();if(i)return this.assertAlive(i),(e=(o=i.parentThatIsA(b)).name===t?o:this.getOtherObject(t,i,o))&&this.assertAlive(e),e},a.prototype.doSet=function(t,e){var i,s,r;if(s=this.blockReceiver(),this.assertAlive(s),!(t instanceof h||t instanceof Array)||t instanceof h&&"reportGet"!==t.expression.selector)throw new Error((0,o.NC)("unsupported attribute"));switch((i=t instanceof h?t.expression.inputs()[0].evaluate():t)instanceof Array&&(i=i[0]),i){case"anchor":case"my anchor":if(this.assertType(s,"sprite"),e instanceof y){if(!s.enableNesting||(0,o.r3)(s.allParts(),e))throw new Error((0,o.NC)("unable to nest\n(disabled or circular?)"));e.attachPart(s)}else s.detachFromAnchor();break;case"parent":case"my parent":this.assertType(s,"sprite"),e=e instanceof y?e:null,s.setExemplar(e,!0);break;case"temporary?":case"my temporary?":this.assertType(s,"sprite"),this.assertType(e,"Boolean"),e?s.release():s.perpetuate();break;case"name":case"my name":this.assertType(s,["sprite","stage"]),this.assertType(e,["text","number"]),(r=s.parentThatIsA(IDE_Morph))&&(s.setName(r.newSpriteName(e.toString(),s)),r.spriteBar.nameField.setContents(r.currentSprite.name.toString()));break;case"dangling?":case"my dangling?":this.assertType(s,"sprite"),this.assertType(e,"Boolean"),s.rotatesWithAnchor=!e,s.version=Date.now();break;case"draggable?":case"my draggable?":this.assertType(s,"sprite"),this.assertType(e,"Boolean"),s.isDraggable=e,(r=s.parentThatIsA(IDE_Morph))&&r.spriteBar.children.forEach((t=>{t.refresh&&t.refresh()})),s.version=Date.now();break;case"rotation style":case"my rotation style":if(this.assertType(s,"sprite"),this.assertType(+e,"number"),!(0,o.r3)([0,1,2],+e))return;s.changed(),s.rotationStyle=+e,s.fixLayout(),s.rerender(),(r=s.parentThatIsA(IDE_Morph))&&r.spriteBar.children.forEach((t=>{t.refresh&&t.refresh()})),s.version=Date.now();break;case"rotation x":case"my rotation x":this.assertType(s,"sprite"),this.assertType(e,"number"),s.setRotationX(e);break;case"rotation y":case"my rotation y":this.assertType(s,"sprite"),this.assertType(e,"number"),s.setRotationY(e);break;case"microphone modifier":this.setMicrophoneModifier(e);break;default:throw new Error('"'+(0,o.NC)(i)+'" '+(0,o.NC)("is read-only"))}},a.prototype.reportContextFor=function(t,e){var o,i,s=copy(t);return s.receiver=e,s.outerContext&&(s.outerContext=copy(s.outerContext),s.outerContext.variables=copy(s.outerContext.variables),s.outerContext.receiver=e,s.outerContext.variables.parentFrame?(i=s.outerContext.variables.parentFrame,(o=copy(e.variables)).parentFrame=i,s.outerContext.variables.parentFrame=o):s.outerContext.variables.parentFrame=e.variables),s},a.prototype.reportMouseX=function(){var t,e;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(b))&&(e=t.world())?(e.hand.position().x-t.center().x)/t.scale:0},a.prototype.reportMouseY=function(){var t,e;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(b))&&(e=t.world())?(t.center().y-e.hand.position().y)/t.scale:0},a.prototype.reportMouseDown=function(){var t;return!(!this.homeContext.receiver||!(t=this.homeContext.receiver.world()))&&"left"===t.hand.mouseButton},a.prototype.reportKeyPressed=function(t){var e;return!(!this.homeContext.receiver||!(e=this.homeContext.receiver.parentThatIsA(b)))&&("any key"===this.inputOption(t)?Object.keys(e.keysPressed).length>0:void 0!==e.keysPressed[t])},a.prototype.doResetTimer=function(){var t;this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(b))&&t.resetTimer()},a.prototype.reportTimer=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(b))?t.getTimer():0},a.prototype.reportDate=function(t){var e,o=this.inputOption(t),i={year:"getFullYear",month:"getMonth",date:"getDate","day of week":"getDay",hour:"getHours",minute:"getMinutes",second:"getSeconds","time in milliseconds":"getTime"};return i[o]?(e=(new Date)[i[o]](),"month"!==o&&"day of week"!==o||(e+=1),e):""},a.prototype.doSetVideoTransparency=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(b))&&(e.projectionTransparency=Math.max(0,Math.min(100,t)))},a.prototype.reportVideo=function(t,e){var o=this.blockReceiver(),i=o.parentThatIsA(b),s=this.getOtherObject(e,o,i);if(!i.projectionSource||!i.projectionSource.stream)return this.context.accumulator||(this.context.accumulator=!0,i.startVideo()),this.pushContext("doYield"),void this.pushContext();switch(this.inputOption(t)){case"motion":return s instanceof y?(i.videoMotion.getLocalMotion(s),s.motionAmount):(i.videoMotion.getStageMotion(),i.videoMotion.motionAmount);case"direction":return s instanceof y?(i.videoMotion.getLocalMotion(s),s.motionDirection):(i.videoMotion.getStageMotion(),i.videoMotion.motionDirection);case"snap":return s instanceof y?s.projectionSnap():i.projectionSnap()}return-1},a.prototype.startVideo=function(t){this.reportGlobalFlag("video capture")||(t.projectionSource&&t.projectionSource.stream||this.context.accumulator||(this.context.accumulator=!0,t.startVideo()),this.pushContext("doYield"),this.pushContext())},a.prototype.doMapCodeOrHeader=function(t,e,o){if("code"===this.inputOption(e))return this.doMapCode(t,o);if("header"===this.inputOption(e))return this.doMapHeader(t,o);throw new Error(" '"+e+"'\nis not a valid option")},a.prototype.doMapHeader=function(t,e){if(t instanceof h&&t.expression instanceof I)return t.expression.mapHeader(e||"")},a.prototype.doMapCode=function(t,e){if(t instanceof h&&t.expression instanceof I)return t.expression.mapCode(e||"")},a.prototype.doMapValueCode=function(t,e){var i=this.inputOption(t);switch(i){case"String":b.prototype.codeMappings.string=e||"<#1>";break;case"Number":b.prototype.codeMappings.number=e||"<#1>";break;case"true":b.prototype.codeMappings.boolTrue=e||"true";break;case"false":b.prototype.codeMappings.boolFalse=e||"true";break;default:throw new Error((0,o.NC)("unsupported data type")+" "+i)}},a.prototype.doMapListCode=function(t,e,o){var i="",s="delim";"parameters"===this.inputOption(e)?i="parms_":"variables"===this.inputOption(e)&&(i="tempvars_"),"list"===this.inputOption(t)?s="list":"item"===this.inputOption(t)&&(s="item"),b.prototype.codeMappings[i+s]=o||""},a.prototype.reportMappedCode=function(t){return t instanceof h&&t.expression instanceof I?t.expression.mappedCode():""},a.prototype.doRest=function(t){var e=this.reportTempo();this.doWait(60/e*t)},a.prototype.reportTempo=function(){var t;return this.homeContext.receiver&&(t=this.homeContext.receiver.parentThatIsA(b))?t.getTempo():0},a.prototype.doChangeTempo=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(b))&&e.changeTempo(t)},a.prototype.doSetTempo=function(t){var e;this.homeContext.receiver&&(e=this.homeContext.receiver.parentThatIsA(b))&&e.setTempo(t)},a.prototype.doPlayNote=function(t,e){var o=this.reportTempo();this.doPlayNoteForSecs(parseFloat(t||"0"),60/o*parseFloat(e||"0"))},a.prototype.doPlayNoteForSecs=function(t,e){var o=this.blockReceiver();if(this.context.startTime||(o.setVolume(o.getVolume()),o.setPan(o.getPan()),this.context.startTime=Date.now(),this.context.activeNote=new Note(t),this.context.activeNote.play(this.instrument,o.getGainNode(),o.getPannerNode())),Date.now()-this.context.startTime>=1e3*e)return this.context.activeNote&&(this.context.activeNote.stop(),this.context.activeNote=null),null;this.pushContext("doYield"),this.pushContext()},a.prototype.doPlayFrequency=function(t,e){this.doPlayFrequencyForSecs(parseFloat(t||"0"),parseFloat(e||"0"))},a.prototype.doPlayFrequencyForSecs=function(t,e){if(this.context.startTime||(this.context.startTime=Date.now(),this.context.activeNote=new Note,this.context.activeNote.frequency=t,this.context.activeNote.play(this.instrument)),Date.now()-this.context.startTime>=1e3*e)return this.context.activeNote&&(this.context.activeNote.stop(),this.context.activeNote=null),null;this.pushContext("doYield"),this.pushContext()},a.prototype.doSetInstrument=function(t){this.instrument=+t,this.receiver.instrument=+t,this.receiver.freqPlayer&&this.receiver.freqPlayer.setInstrument(+t)},a.prototype.reportGetImageAttribute=function(t,e){var o=this.costumeNamed(e)||new Costume;switch(this.inputOption(t)){case"name":return o.name;case"width":return o.width();case"height":return o.height();case"pixels":return o.rasterized().pixels();default:return o}},a.prototype.reportNewCostumeStretched=function(t,e,o){var i;if(t instanceof d)return this.reportNewCostume(t,e,o);if(!(i=this.costumeNamed(t)))return new Costume;if(!isFinite(+e*+o)||isNaN(+e*+o))throw new Error("expecting a finite number\nbut getting Infinity or NaN");return i.stretched(Math.round(i.width()*+e/100),Math.round(i.height()*+o/100))},a.prototype.costumeNamed=function(t){return t instanceof Costume?t:"number"==typeof t?this.blockReceiver().costumes.at(t):"current"===this.inputOption(t)?this.blockReceiver().costume:(0,o.qY)(this.blockReceiver().costumes.asArray(),(e=>e.name===t.toString()))},a.prototype.reportNewCostume=function(t,e,i,s){var r,n,a,h,l,p,c,d,u;if(this.assertType(t,"list"),"current"===this.inputOption(e)&&(n=(r=this.blockReceiver()).parentThatIsA(b),e=r.costume?r.costume.width():n.dimensions.x),"current"===this.inputOption(i)&&(r=r||this.blockReceiver(),n=n||r.parentThatIsA(b),i=r.costume?r.costume.height():n.dimensions.y),e=Math.abs(Math.floor(+e)),i=Math.abs(Math.floor(+i)),e<=0||i<=0)return new Costume;if(!isFinite(e*i)||isNaN(e*i))throw new Error("expecting a finite number\nbut getting Infinity or NaN");for(h=(a=(0,o.oM)(new o.E9(e,i),!0)).getContext("2d"),l=t.asArray(),p=h.createImageData(e,i),c=0;c<l.length;c+=1){for(u=l[c].asArray(),d=0;d<3;d+=1)p.data[4*c+d]=u[d];p.data[4*c+3]=void 0===u[3]?255:u[3]}return h.putImageData(p,0,0),new Costume(a,s||(r||this.blockReceiver()).newCostumeName((0,o.NC)("costume")))},a.prototype.reportPentrailsAsSVG=function(){var t,e,i,s,r;if(this.context.accumulator){if(this.context.accumulator.ready)return r=o.xE,(t=this.blockReceiver())instanceof y&&(r=new o.E9(t.xPosition(),-t.yPosition())),void this.returnValueToParentContext(new SVG_Costume(this.context.accumulator.img,this.blockReceiver().newCostumeName((0,o.NC)("Costume")),this.context.accumulator.rot.translateBy(r)))}else{if(!(e=this.homeContext.receiver.parentThatIsA(b)).trailsLog.length)throw new Error((0,o.NC)("there are currently no\nvectorizable pen trail segments"));i=e.trailsLogAsSVG(),this.context.accumulator={img:new Image,rot:i.rot,ready:!1},(s=this.context.accumulator).img.onload=()=>s.ready=!0,s.img.src="data:image/svg+xml,"+i.src,s.img.rot=i.rotationShift}this.pushContext()},a.prototype.inputOption=function(t){return t instanceof Array?t[0]:t},a.prototype.pushContext=function(t,e){this.context=new h(this.context,t,e||(this.context?this.context.outerContext:null),this.context?this.context.receiver:this.homeContext.receiver)},a.prototype.popContext=function(){this.context&&this.context.stopMusic(),this.context=this.context?this.context.parentContext:null},a.prototype.returnValueToParentContext=function(t){void 0!==t&&(this.context&&this.context.parentContext||this.homeContext).addInput(t)},a.prototype.reportStackSize=function(){return this.context?this.context.stackSize():0},a.prototype.reportFrameCount=function(){return this.frameCount},a.prototype.flashContext=function(){var t=this.context.expression;return!(!(this.enableSingleStepping&&!this.isAtomic&&t instanceof I)||t instanceof V||this.context.isFlashing||!t.world()||t instanceof X||(this.unflash(),t.flash(),this.context.isFlashing=!0,this.flashingContext=this.context,this.flashTime>0&&this.flashTime<=.5?(this.pushContext("doIdle"),this.context.addInput(this.flashTime)):this.pushContext("doInterrupt"),0))},a.prototype.flashPausedContext=function(){var t=this.context?this.context.lastFlashable():null;t&&(this.unflash(),t.expression.flash(),t.isFlashing=!0,this.flashingContext=t)},a.prototype.doInterrupt=function(){this.popContext(),this.isAtomic||(this.isInterrupted=!0)},a.prototype.doIdle=function(t){this.context.startTime||(this.context.startTime=Date.now()),Date.now()-this.context.startTime<1e3*t?this.pushContext("doInterrupt"):this.popContext()},a.prototype.unflash=function(){this.flashingContext&&(this.flashingContext.expression.unflash(),this.flashingContext.isFlashing=!1,this.flashingContext=null)},a.prototype.reportCompiled=function(t,e){return new c(this).compileFunction(t,e)},a.prototype.capture=function(t){var e=new a(this.topBlock,this.receiver),o=new h(t.parentContext,t.expression,t.outerContext,t.receiver);return o.variables=t.variables.fullCopy(),o.variables.root().parentFrame=e.variables,e.context=o,e},a.prototype.getVarNamed=function(t){var e,i=this.homeContext.variables.silentFind(t)||this.context.variables.silentFind(t);if(i)return 0===(e=i.vars[t].value)?0:!1!==e&&(""===e?"":e||0);throw new Error((0,o.NC)("a variable of name '")+t+(0,o.NC)("'\ndoes not exist in this context"))},a.prototype.setVarNamed=function(t,e){var i=this.homeContext.variables.silentFind(t)||this.context.variables.silentFind(t);if((0,o.kK)(i))throw new Error((0,o.NC)("a variable of name '")+t+(0,o.NC)("'\ndoes not exist in this context"));i.vars[t].value=e},a.prototype.incrementVarNamed=function(t,e){this.setVarNamed(t,this.getVarNamed(t)+ +e)},a.prototype.reportAtomicMap=function(t,e){this.assertType(e,"list");var o,i,s,r=[],n=e.asArray(),a=n.length,h=t.inputs.length;try{i=this.reportCompiled(t,1)}catch(e){console.log(e.message),i=t}for(s=0;s<a;s+=1)o=[n[s]],h>1&&o.push(s+1),h>2&&o.push(e),r.push(Wt(i,new d(o),null,null,null,null,this.capture(t)));return new d(r)},a.prototype.reportAtomicKeep=function(t,e){this.assertType(e,"list");var o,i,s,r=[],n=e.asArray(),a=n.length,h=t.inputs.length;try{i=this.reportCompiled(t,1)}catch(e){console.log(e.message),i=t}for(s=0;s<a;s+=1)o=[n[s]],h>1&&o.push(s+1),h>2&&o.push(e),Wt(i,new d(o),null,null,null,null,this.capture(t))&&r.push(n[s]);return new d(r)},a.prototype.reportAtomicFindFirst=function(t,e){this.assertType(e,"list");var o,i,s,r=e.asArray(),n=r.length,a=t.inputs.length;try{i=this.reportCompiled(t,1)}catch(e){console.log(e.message),i=t}for(s=0;s<n;s+=1)if(o=[r[s]],a>1&&o.push(s+1),a>2&&o.push(e),Wt(i,new d(o),null,null,null,null,this.capture(t)))return r[s];return!1},a.prototype.reportAtomicCombine=function(t,e){this.assertType(t,"list");var o,i,s,r="",n=t.asArray(),a=n.length,h=e.inputs.length;if(0===a)return r;r=n[0];try{i=this.reportCompiled(e,2)}catch(t){console.log(t.message),i=e}for(s=1;s<a;s+=1)o=[r,n[s]],h>2&&o.push(s+1),h>3&&o.push(t),r=Wt(i,new d(o),null,null,null,null,this.capture(e));return r},a.prototype.reportAtomicSort=function(t,e){var o;this.assertType(t,"list");try{o=this.reportCompiled(e,2)}catch(t){console.log(t.message),o=e}return new d(t.asArray().slice().sort(((t,i)=>Wt(o,new d([t,i]),null,null,null,null,this.capture(e))?-1:1)))},a.prototype.reportAtomicGroup=function(t,e){this.assertType(t,"list");var o,i,s,r=[],n=new Map,a=t.asArray(),h=a.length;try{i=this.reportCompiled(e,1)}catch(t){console.log(t.message),i=e}for(s=0;s<h;s+=1)o=Wt(i,new d([a[s]]),null,null,null,null,this.capture(e)),n.has(o)?n.get(o).push(a[s]):n.set(o,[a[s]]);return n.forEach(((t,e)=>r.push(new d([e,t.length,new d(t)])))),new d(r)},h.prototype.toString=function(){var t=this.expression;return t instanceof Array&&t.length>0&&(t="["+t[0]+"]"),"Context >> "+t+" "+this.variables},h.prototype.image=function(){var t,e,i=new O;return this.expression instanceof o._V?(t=this.expression.fullCopy(),this.isContinuation&&(e=(0,o.qY)(t.allInputs(),(t=>1===t.bindingID)))&&t.revertToDefaultInput(e,!0),i.embed(t,this.inputs),i.doWithAlpha(1,(()=>(i.clearAlpha(),i.fullImage())))):this.expression instanceof Array?(t=this.expression[this.pc].fullCopy())instanceof O&&!t.contents()?t.doWithAlpha(1,(()=>t.fullImage())):(i.embed(t,this.isContinuation?[]:this.inputs),i.doWithAlpha(1,(()=>i.fullImage()))):(i.color=y.prototype.blockColor.other,i.setSpec("%rc %ringparms"),this.isContinuation||this.inputs.forEach((t=>i.parts()[1].addInput(t))),i.doWithAlpha(1,(()=>i.fullImage())))},h.prototype.continuation=function(t){var e;if(this.expression instanceof Array)e=this;else{if(!this.parentContext)return(e=new h(null,t?"expectReport":"popContext")).isContinuation=!0,e;e=this.parentContext}return(e=e.copyForContinuation()).tag=null,e.isContinuation=!0,e},h.prototype.copyForContinuation=function(){var t=copy(this),e=t;if(!(this.expression instanceof Array||(0,o.HD)(this.expression)))for(e.prepareContinuationForBinding();e.parentContext;)e.parentContext=copy(e.parentContext),(e=e.parentContext).inputs=[];return t},h.prototype.copyForContinuationCall=function(){var t=copy(this),e=t;if(!(this.expression instanceof Array||(0,o.HD)(this.expression)))for(this.expression=this.expression.fullCopy(),this.inputs=[];e.parentContext;)e.parentContext=copy(e.parentContext),(e=e.parentContext).inputs=[];return t},h.prototype.prepareContinuationForBinding=function(){var t,e=this.inputs.length;this.expression=this.expression.fullCopy(),(t=this.expression.inputs()[e])&&(this.inputs=[],t.bindingID=1,this.emptySlots=1)},h.prototype.addInput=function(t){this.inputs.push(t)},h.prototype.stopMusic=function(){this.activeNote&&(this.activeNote.stop(),this.activeNote=null)},h.prototype.lastFlashable=function(){return this.expression instanceof I&&!(this.expression instanceof V)?this:this.parentContext?this.parentContext.lastFlashable():null},h.prototype.stackSize=function(){return this.parentContext?1+this.parentContext.stackSize():1},p.prototype.toString=function(){return"a VariableFrame {"+this.names()+"}"},p.prototype.copy=function(){var t=new p(this.parentFrame);return this.names().forEach((e=>t.addVar(e,this.getVar(e)))),t},p.prototype.fullCopy=function(){var t;return(t=this.parentFrame?new p(this.parentFrame.fullCopy()):new p).vars=copy(this.vars),t},p.prototype.root=function(){return this.parentFrame?this.parentFrame.root():this},p.prototype.find=function(t){var e=this.silentFind(t);if(e)return e;throw new Error((0,o.NC)("a variable of name '")+t+(0,o.NC)("'\ndoes not exist in this context"))},p.prototype.silentFind=function(t){return this.vars[t]instanceof l?this:this.parentFrame?this.parentFrame.silentFind(t):null},p.prototype.setVar=function(t,e,o){var i=this.find(t);i&&(o instanceof y&&i.owner instanceof y&&o!==i.owner?o.shadowVar(t,e):i.vars[t].value=e)},p.prototype.changeVar=function(t,e,o){var i,s,r=this.find(t);r&&(i=parseFloat(r.vars[t].value),s=isNaN(i)?e:i+parseFloat(e),o instanceof y&&r.owner instanceof y&&o!==r.owner?o.shadowVar(t,s):r.vars[t].value=s)},p.prototype.getVar=function(t){var e,i=this.silentFind(t);if(i)return 0===(e=i.vars[t].value)?0:!1!==e&&(""===e?"":e||0);if("number"==typeof t)return"";throw new Error((0,o.NC)("a variable of name '")+t+(0,o.NC)("'\ndoes not exist in this context"))},p.prototype.addVar=function(t,e){this.vars[t]=new l(0===e?0:!1!==e&&(""===e?"":e||0))},p.prototype.deleteVar=function(t){var e=this.find(t);e&&delete e.vars[t]},p.prototype.names=function(){var t,e=[];for(t in this.vars)Object.prototype.hasOwnProperty.call(this.vars,t)&&e.push(t);return e},p.prototype.allNamesDict=function(t){var e={},o=this;function i(t,e){var o;for(o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=o)}for(;o&&o!==t;)i(o.vars,e),o=o.parentFrame;return e},p.prototype.allNames=function(t){var e,o=[],i=this.allNamesDict(t);for(e in i)Object.prototype.hasOwnProperty.call(i,e)&&o.push(e);return o},o.qz.xml="2020-April-27",zt.prototype.nonSpace=/\S|$/g,zt.prototype.nonWord=/[\s\>\/\=]|$/g,zt.prototype.next=function(t){var e,o;return void 0===t?(e=this.contents[this.index],this.index+=1,e):(o=this.index,this.index+=t,this.contents.slice(o,this.index))},zt.prototype.peek=function(){return this.contents[this.index]},zt.prototype.skip=function(t){this.index+=t||1},zt.prototype.atEnd=function(){return this.index>this.contents.length-1},zt.prototype.upTo=function(t){var e=this.contents.indexOf(t,this.index);return-1===e?"":this.contents.slice(this.index,this.index=e)},zt.prototype.peekUpTo=function(t){var e=this.contents.indexOf(t,this.index);return-1===e?"":this.contents.slice(this.index,e)},zt.prototype.skipSpace=function(){this.nonSpace.lastIndex=this.index;var t=this.nonSpace.exec(this.contents);t&&(this.index=t.index)},zt.prototype.word=function(){this.nonWord.lastIndex=this.index;var t=this.nonWord.exec(this.contents);return t?this.contents.slice(this.index,this.index=t.index):""},Ht.prototype=Object.create(Node.prototype),Ht.prototype.constructor=Ht,Ht.uber=Node.prototype,Ht.prototype.indentation="  ",Ht.prototype.init=function(t,e,o){this.tag=t||"unnamed",this.attributes={},this.contents=e||"",Ht.uber.init.call(this),o&&o.addChild(this)},Ht.prototype.require=function(t,e){var i=this.childNamed(t);if(!i){if(e instanceof Function)return e();if(!(0,o.kK)(e))return e;throw new Error("Missing required element <"+t+">!")}return i},Ht.prototype.childNamed=function(t){return(0,o.qY)(this.children,(e=>e.tag===t))},Ht.prototype.childrenNamed=function(t){return this.children.filter((e=>e.tag===t))},Ht.prototype.parentNamed=function(t){return this.tag===t?this:this.parent?this.parent.parentNamed(t):null},Ht.prototype.toString=function(t,e){var o,i,s="",r="",n=e||0;if(t){for(i=0;i<n;i+=1)r+=this.indentation;s+=r}for(o in s+="<"+this.tag,this.attributes)Object.prototype.hasOwnProperty.call(this.attributes,o)&&this.attributes[o]&&(s+=" "+o+'="'+this.escape(this.attributes[o])+'"');return this.contents.length||this.children.length?(s+=">",s+=this.escape(this.contents),this.children.forEach((e=>{t&&(s+="\n"),s+=e.toString(t,n+1)})),t&&this.children.length&&(s+="\n"+r),s+="</"+this.tag+">"):s+="/>",s},Ht.prototype.escape=function(t,e){var i,s,r=(0,o.kK)(t)?"":t.toString(),n="";for(i=0;i<r.length;i+=1)switch(s=r[i]){case"'":n+="&apos;";break;case'"':n+=e?s:"&quot;";break;case"<":n+="&lt;";break;case">":n+="&gt;";break;case"&":n+="&amp;";break;case"\n":n+="&#xD;";break;case"~":n+="&#126;";break;default:n+=s}return n},Ht.prototype.unescape=function(t){return t.replace(/&(amp|apos|quot|lt|gt|#xD|#126);/g,((t,e)=>{switch(e){case"amp":return"&";case"apos":return"'";case"quot":return'"';case"lt":return"<";case"gt":return">";case"#xD":return"\n";case"#126":return"~";default:console.warn("unreachable")}}))},Ht.prototype.parseString=function(t){var e=new zt(t);e.upTo("<"),e.skip(),this.parseStream(e)},Ht.prototype.parseStream=function(t){var e,o,i;for(this.tag=t.word(),t.skipSpace(),i=t.peek();">"!==i&&"/"!==i;){if(e=t.word(),t.skipSpace(),"="!==t.next())throw new Error('Expected "=" after attribute name');if(t.skipSpace(),'"'!==(i=t.next())&&"'"!==i)throw new Error("Expected single- or double-quoted attribute value");o=t.upTo(i),t.skip(1),t.skipSpace(),this.attributes[e]=this.unescape(o),i=t.peek()}if("/"!==i){if(">"!==t.next())throw new Error('Expected ">" after tag name and attributes');for(;!t.atEnd();)if("<"===(i=t.next())){if("/"===t.peek()){if(t.skip(),t.word()!==this.tag)throw new Error("Expected to close "+this.tag);return t.upTo(">"),t.skip(),void(this.contents=this.unescape(this.contents))}new Ht(null,null,this).parseStream(t)}else this.contents+=i}else if(t.skip(),">"!==t.next())throw new Error('Expected ">" after "/" in empty tag')},o.qz.store="2020-October-27",Ut.prototype.idProperty="serializationID",Ut.prototype.mediaIdProperty="serializationMediaID",Ut.prototype.mediaDetectionProperty="isMedia",Ut.prototype.version=1,Ut.prototype.serialize=function(t,e){var o;return this.flush(),this.flushMedia(),this.isExportingBlocksLibrary=e,o=this.store(t),this.flush(),o},Ut.prototype.store=function(t,e){return(0,o.kK)(t)||!t.toXML?"":this.isCollectingMedia&&t[this.mediaDetectionProperty]?(this.addMedia(t,e),this.format('<ref mediaID="@"></ref>',t[this.mediaIdProperty])):t[this.idProperty]?this.format('<ref id="@"></ref>',t[this.idProperty]):(this.add(t),t.toXML(this,e).replace("~",this.format('id="@"',t[this.idProperty])))},Ut.prototype.mediaXML=function(){var t="<media>";return this.media.forEach((e=>{var o=e.toXML(this).replace("~",this.format('mediaID="@"',e[this.mediaIdProperty]));t+=o})),t+"</media>"},Ut.prototype.add=function(t){return t[this.idProperty]?-1:(this.contents.push(t),t[this.idProperty]=this.contents.length,this.contents.length)},Ut.prototype.addMedia=function(t,e){return t[this.mediaIdProperty]?-1:(this.media.push(t),t[this.mediaIdProperty]=e?e+"_"+t.name:this.media.length,this.media.length)},Ut.prototype.at=function(t){return this.contents[t-1]},Ut.prototype.flush=function(){this.contents.forEach((t=>delete t[this.idProperty])),this.contents=[]},Ut.prototype.flushMedia=function(){this.media instanceof Array&&this.media.forEach((t=>delete t[this.mediaIdProperty])),this.media=[],this.isExportingBlocksLibrary=!1},Ut.prototype.escape=Ht.prototype.escape,Ut.prototype.unescape=Ht.prototype.unescape,Ut.prototype.format=function(t){var e,o=-1,i=arguments;return t.replace(/[@$%]([\d]+)?/g,((t,s)=>(s=parseInt(s,10),e=isNaN(s)?i[(o+=1)+1]:i[s+1],"@"===t?this.escape(e):"$"===t?this.escape(e,!0):e)))},Ut.prototype.load=function(t){throw(0,o.WY)(t),new Error("loading should be implemented in heir of XML_Serializer")},Ut.prototype.parse=function(t){var e=new Ht;try{e.parseString(t)}catch(t){throw t}return e},_t.prototype=new Ut,_t.prototype.constructor=_t,_t.uber=Ut.prototype,_t.prototype.app="iSnap 3.0, http://go.ncsu.edu/isnap",_t.prototype.appParent="Snap! 6, https://snap.berkeley.edu",_t.prototype.thumbnailSize=new o.E9(160,120),_t.prototype.watcherLabels={xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",reportShown:"shown?",getTempo:"tempo",getVolume:"volume",getPan:"balance",getPenDown:"pen down?",getLastAnswer:"answer",getLastMessage:"message",getTimer:"timer",getCostumeIdx:"costume #",reportMouseX:"mouse x",reportMouseY:"mouse y",reportThreadCount:"processes"},_t.prototype.init=function(){this.project={},this.objects={},this.mediaDict={}},Ut.prototype.mediaXML=function(t){var e='<media name="'+(t||"untitled")+'" app="'+this.app+'" version="'+this.version+'">';return this.media.forEach((t=>{var o=t.toXML(this).replace("~",this.format('mediaID="@"',t[this.mediaIdProperty]));e+=o})),e+"</media>"},_t.prototype.load=function(t,e){return this.loadProjectModel(this.parse(t),e)},_t.prototype.loadProjectModel=function(t,e,o){var i=t.attributes.app,s=i?i.split(" ")[0]:null,r=this.app.split(" ")[0],n=this.appParent.split(" ")[0];return e&&s&&s!==r&&s!==n&&e.inform(s+" Project","This project has been created by a different app:\n\n"+s+"\n\nand may be incompatible or fail to load here."),this.rawLoadProjectModel(t,o)},_t.prototype.rawLoadProjectModel=function(t,i){var s,r,n={sprites:{}};if(this.project=n,s={project:t},+t.attributes.version>this.version)throw"Project uses newer version of Serializer";if(this.objects={},n.name=s.project.attributes.name,!n.name){for(r=1;Object.prototype.hasOwnProperty.call(localStorage,"-snap-project-Untitled "+r);)r+=1;n.name="Untitled "+r}if(s.notes=s.project.childNamed("notes"),s.notes&&(n.notes=s.notes.contents),s.data=s.project.childNamed("data"),s.data&&(n.data=s.data.contents),s.globalVariables=s.project.childNamed("variables"),n.globalVariables=new p,s.stage=s.project.require("stage"),b.prototype.frameRate=0,n.stage=new b(n.globalVariables),n.stage.remixID=i,Object.prototype.hasOwnProperty.call(s.stage.attributes,"id")&&(this.objects[s.stage.attributes.id]=n.stage),s.stage.attributes.name&&(n.stage.name=s.stage.attributes.name),s.stage.attributes.color&&(n.stage.color=this.loadColor(s.stage.attributes.color),n.stage.cachedHSV=n.stage.color.hsv()),"true"===s.stage.attributes.scheduled&&(n.stage.fps=30,b.prototype.frameRate=30),s.stage.attributes.volume&&(n.stage.volume=+s.stage.attributes.volume),s.stage.attributes.pan&&(n.stage.pan=+s.stage.attributes.pan),s.stage.attributes.penlog&&(b.prototype.enablePenLogging="true"===s.stage.attributes.penlog),s.pentrails=s.stage.childNamed("pentrails"),s.pentrails&&(n.pentrails=new Image,n.pentrails.onload=function(){n.stage.trailsCanvas&&((0,o.bl)(n.stage.trailsCanvas),n.stage.trailsCanvas.getContext("2d").drawImage(n.pentrails,0,0),n.stage.changed())},n.pentrails.src=s.pentrails.contents),n.stage.setTempo(s.stage.attributes.tempo),b.prototype.dimensions=new o.E9(480,360),s.stage.attributes.width&&(b.prototype.dimensions.x=Math.max(+s.stage.attributes.width,240)),s.stage.attributes.height&&(b.prototype.dimensions.y=Math.max(+s.stage.attributes.height,180)),n.stage.setExtent(b.prototype.dimensions),y.prototype.useFlatLineEnds="flat"===s.stage.attributes.lines,q.prototype.isTernary="false"!==s.stage.attributes.ternary,a.prototype.enableHyperOps="false"!==s.stage.attributes.hyperops,n.stage.isThreadSafe="true"===s.stage.attributes.threadsafe,b.prototype.enableCodeMapping="true"===s.stage.attributes.codify,b.prototype.enableInheritance="false"!==s.stage.attributes.inheritance,b.prototype.enableSublistIDs="true"===s.stage.attributes.sublistIDs,s.hiddenPrimitives=s.project.childNamed("hidden"),s.hiddenPrimitives&&s.hiddenPrimitives.contents.split(" ").forEach((t=>{t&&(b.prototype.hiddenPrimitives[t]=!0)})),s.codeHeaders=s.project.childNamed("headers"),s.codeHeaders&&s.codeHeaders.children.forEach((t=>b.prototype.codeHeaders[t.tag]=t.contents)),s.codeMappings=s.project.childNamed("code"),s.codeMappings&&s.codeMappings.children.forEach((t=>b.prototype.codeMappings[t.tag]=t.contents)),s.globalBlocks=s.project.childNamed("blocks"),s.globalBlocks&&(this.loadCustomBlocks(n.stage,s.globalBlocks,!0),this.populateCustomBlocks(n.stage,s.globalBlocks,!0)),this.loadObject(n.stage,s.stage),s.sprites=s.stage.require("sprites"),n.sprites[n.stage.name]=n.stage,s.sprites.childrenNamed("sprite").forEach((t=>this.loadValue(t))),this.project.stage.children.forEach((t=>{var e,o;t.inheritanceInfo&&((e=this.project.sprites[t.inheritanceInfo.exemplar])&&t.setExemplar(e),t.inheritedAttributes=t.inheritanceInfo.delegated||[],t.updatePropagationCache()),t.nestingInfo&&((o=this.project.sprites[t.nestingInfo.anchor])&&o.attachPart(t),t.rotatesWithAnchor="true"===t.nestingInfo.synch)})),this.project.stage.children.forEach((t=>{var e;t.nestingInfo&&(t.nestingScale=+(t.nestingInfo.scale||t.scale),delete t.nestingInfo),["scripts","costumes","sounds"].forEach((e=>{t.inheritsAttribute(e)&&t.refreshInheritedAttribute(e)})),t.inheritsAttribute("costumes")&&(e=t.inheritsAttribute("costume #")?t.exemplar.costume:t.costumes.asArray()[t.inheritanceInfo.costumeNumber-1])&&(e.loaded?t.wearCostume(e,!0):e.loaded=function(){this.loaded=!0,t.wearCostume(e,!0)}),delete t.inheritanceInfo})),e.BlockEditorMorph.showing.slice().forEach((function(t){t.close()})),s.editing=s.project.childNamed("editing"),s.editing){var h=s.editing.attributes.guid;s.editing.children.forEach(((t,e)=>{this.loadEditing(n,t,h,e)}),this)}return s.globalVariables&&this.loadVariables(n.globalVariables,s.globalVariables),this.objects={},s.sprites.childrenNamed("watcher").forEach((t=>{var e,i,s,r,a,h;i=this.loadColor(t.attributes.color),s=Object.prototype.hasOwnProperty.call(t.attributes,"scope")?n.sprites[t.attributes.scope]:null,r=Object.prototype.hasOwnProperty.call(t.attributes,"hidden")&&"false"!==t.attributes.hidden,(e=Object.prototype.hasOwnProperty.call(t.attributes,"var")?new B(t.attributes.var,i,(0,o.kK)(s)?n.globalVariables:s.variables,t.attributes.var,r):new B((0,o.NC)(this.watcherLabels[t.attributes.s]),i,s,t.attributes.s,r)).setStyle(t.attributes.style||"normal"),"slider"===e.style&&(e.setSliderMin(t.attributes.min||"1",!0),e.setSliderMax(t.attributes.max||"100",!0)),e.setPosition(n.stage.topLeft().add(new o.E9(+t.attributes.x||0,+t.attributes.y||0))),n.stage.add(e),e.onNextStep=function(){this.currentValue=null},e.currentValue instanceof d&&e.cellMorph.contentsMorph&&((a=t.attributes.extX)&&e.cellMorph.contentsMorph.setWidth(+a),(h=t.attributes.extY)&&e.cellMorph.contentsMorph.setHeight(+h),e.cellMorph.contentsMorph.handle.fixLayout())})),this.project.stage.children.forEach((t=>t.inheritedMethodsCache=[])),this.objects={},n},_t.prototype.loadBlocks=function(t,e){var o,i=new b;if(this.project={stage:i,sprites:{},targetStage:e},+(o=this.parse(t)).attributes.version>this.version)throw"Module uses newer version of Serializer";return this.loadCustomBlocks(i,o,!0),this.populateCustomBlocks(i,o,!0),this.objects={},i.globalBlocks.forEach((t=>t.receiver=null)),this.objects={},this.project={},this.mediaDict={},i.globalBlocks},_t.prototype.loadSprites=function(t,e){var o,i;if((i=this.project={globalVariables:e.globalVariables,stage:e.stage,sprites:{}}).sprites[i.stage.name]=i.stage,+(o=this.parse(t)).attributes.version>this.version)throw"Module uses newer version of Serializer";o.childrenNamed("sprite").forEach((t=>{var o=new y(i.globalVariables);t.attributes.id&&(this.objects[t.attributes.id]=o),t.attributes.name&&(o.name=e.newSpriteName(t.attributes.name),i.sprites[o.name]=o),t.attributes.color&&(o.color=this.loadColor(t.attributes.color),o.cachedHSV=o.color.hsv()),t.attributes.pen&&(o.penPoint=t.attributes.pen),t.attributes.volume&&(o.volume=+t.attributes.volume),t.attributes.pan&&(o.pan=+t.attributes.pan),i.stage.add(o),e.sprites.add(o),o.scale=parseFloat(t.attributes.scale||"1"),o.rotationStyle=parseFloat(t.attributes.rotation||"1"),o.isDraggable="false"!==t.attributes.draggable,o.isVisible="true"!==t.attributes.hidden,o.heading=parseFloat(t.attributes.heading)||0,o.gotoXY(+t.attributes.x||0,+t.attributes.y||0),this.loadObject(o,t),o.fixLayout(),o.pauseGenericHatBlocks()})),i.stage.children.forEach((t=>{var e,o;t.inheritanceInfo&&(e=i.sprites[t.inheritanceInfo.exemplar])&&t.setExemplar(e),t.nestingInfo&&((o=i.sprites[t.nestingInfo.anchor])&&o.attachPart(t),t.rotatesWithAnchor="true"===t.nestingInfo.synch)})),i.stage.children.forEach((t=>{delete t.inheritanceInfo,t.nestingInfo&&(t.nestingScale=+(t.nestingInfo.scale||t.scale),delete t.nestingInfo)})),this.objects={},this.project={},this.mediaDict={},e.stage.fixLayout(),e.stage.rerender(),e.createCorral(),e.fixLayout()},_t.prototype.loadMedia=function(t){return this.loadMediaModel(this.parse(t))},_t.prototype.loadMediaModel=function(t){var e=t;if(this.mediaDict={},+e.attributes.version>this.version)throw"Module uses newer version of Serializer";return e.children.forEach((t=>this.loadValue(t))),this.mediaDict},_t.prototype.loadObject=function(t,e){var i,s,r=e.require("blocks"),n=e.childNamed("dispatches");e.attributes.instrument&&(t.instrument=+e.attributes.instrument),this.loadInheritanceInfo(t,e),this.loadNestingInfo(t,e),(i=e.childNamed("wear"))&&((i=i.childNamed("costume")||i.childNamed("ref"))?(s=this.loadValue(i,t)).loaded?t.wearCostume(s,!0):s.loaded=function(){this.loaded=!0,t.wearCostume(s,!0)}:console.log(t.name+": missing costume to wear")),t.inheritanceInfo&&t.inheritanceInfo.delegated instanceof Array&&(0,o.r3)(t.inheritanceInfo.delegated,"costumes")||this.loadCostumes(t,e),t.inheritanceInfo&&t.inheritanceInfo.delegated instanceof Array&&(0,o.r3)(t.inheritanceInfo.delegated,"sounds")||this.loadSounds(t,e),this.loadCustomBlocks(t,r),n&&this.loadCustomBlocks(t,n,!1,!0),this.populateCustomBlocks(t,r),this.loadVariables(t.variables,e.require("variables"),t),t.inheritanceInfo&&t.inheritanceInfo.delegated instanceof Array&&(0,o.r3)(t.inheritanceInfo.delegated,"scripts")||this.loadScripts(t,t.scripts,e.require("scripts"))},_t.prototype.loadInheritanceInfo=function(t,e){var o,i=e.childNamed("inherit");i&&(t.inheritanceInfo=i.attributes,(o=i.childNamed("list"))&&(t.inheritanceInfo.delegated=this.loadValue(o).asArray()),t.inheritanceInfo.costumeNumber=e.attributes.costume)},_t.prototype.loadNestingInfo=function(t,e){var o=e.childNamed("nest");o&&(t.nestingInfo=o.attributes)},_t.prototype.loadCostumes=function(t,e){var o,i=e.childNamed("costumes");i&&(t.costumes=this.loadValue(i.require("list",(function(){return console.log(t.name+": missing required costumes list, improvising..."),new Ht("list")}))),t.costumes.type="costume"),Object.prototype.hasOwnProperty.call(e.attributes,"costume")&&(o=t.costumes.asArray()[e.attributes.costume-1])&&(o.loaded?t.wearCostume(o,!0):o.loaded=function(){this.loaded=!0,t.wearCostume(o,!0)})},_t.prototype.loadSounds=function(t,e){var o=e.childNamed("sounds");o&&(t.sounds=this.loadValue(o.require("list",(function(){return console.log(t.name+": missing required sounds list, improvising..."),new Ht("list")}))),t.sounds.type="sound")},_t.prototype.loadVariables=function(t,e,o){e.children.forEach((e=>{var i,s;"variable"===e.tag&&(s=e.children[0],(i=new l).isTransient="true"===e.attributes.transient,i.value=i.isTransient||!s?0:this.loadValue(s,o),t.vars[e.attributes.name]=i)}))},_t.prototype.loadCustomBlocks=function(t,e,o,i){e.children.forEach((function(e){this.loadCustomBlock(t,e,o,i)}),this)},_t.prototype.loadCustomBlock=function(t,e,i,s){var r,n,a,h,l,p,c,d,u;return"block-definition"!==e.tag?null:((r=new ft(e.attributes.s||"",t)).category=e.attributes.category||"other",r.type=e.attributes.type||"command",e.attributes.guid&&(r.guid=e.attributes.guid),e.attributes.isImported&&(r.isImported="true"===e.attributes.isImported),r.isGlobal=!0===i,t&&(s?t.inheritedMethodsCache.push(r):r.isGlobal?t.globalBlocks.push(r):t.customBlocks.push(r)),n=r.parseSpec(r.spec).filter((function(t){return"%"===t.charAt(0)&&t.length>1})).map((function(t){return t.substr(1)})),r.names=n,(a=e.childNamed("inputs"))&&(u=-1,a.children.forEach((t=>{var e=t.childNamed("options");"input"===t.tag&&(u+=1,r.declarations.set(n[u],[t.attributes.type,(0,o.r3)(["%b","%boolUE"],t.attributes.type)?t.contents?"true"===t.contents:null:t.contents,e?e.contents:void 0,"true"===t.attributes.readonly]))}))),(h=e.childNamed("variables"))&&(r.variableNames=this.loadValue(h.require("list")).asArray()),(l=e.childNamed("header"))&&(r.codeHeader=l.contents),(p=e.childNamed("code"))&&(r.codeMapping=p.contents),(c=e.childNamed("translations"))&&r.updateTranslations(c.contents),(d=e.childNamed("comment"))&&(r.comment=this.loadComment(d)),r)},_t.prototype.populateCustomBlocks=function(t,e,o){e.children.forEach((function(e,i){var s=o?t.globalBlocks[i]:t.customBlocks[i];this.populateCustomBlock(t,e,s)}),this)},_t.prototype.populateCustomBlock=function(t,e,o){var i,s;"block-definition"===e.tag&&((i=e.childNamed("script"))&&(o.body=new h(null,i?this.loadScript(i):null,null,t),o.body.inputs=o.names.slice(0)),(s=e.childNamed("scripts"))&&(o.scripts=this.loadScriptsArray(s,t)),delete o.names)},_t.prototype.loadEditing=function(t,i,s,r){var n=t.stage,a=[],h=[n].concat(n.children);a[0]=n.customBlocks.concat(n.globalBlocks),n.children.forEach((function(t,e){a[e+1]=t.customBlocks}));var l,p=i.attributes.guid||s,c=null,d=null;Object.keys(a).forEach((function(t,e){a[t].forEach((function(t){t.guid===p&&(c=t,d=h[e])}))})),c&&("scripts"!==i.tag?"block-definition"===i.tag?(l=this.loadCustomBlock(null,i,c.isGlobal),this.populateCustomBlock(null,i,l),l.receiver=c.receiver,setTimeout((function(){o._V.prototype.trackChanges=!1;var t=new e.BlockEditorMorph(l,d);t.popUp(),t.setCenter(t.center().add(15*r)),o._V.prototype.trackChanges=!0,t.changed();var i=t.updateDefinition;t.updateDefinition=function(){t.definition=c,i.call(t)}}))):Trace.logErrorMessage("Unknown editing tag: "+i.tag):Trace.logErrorMessage("Skipping legacy version of editing code using script tags. No longer supported. To load, use an older version of iSnap."))},_t.prototype.loadScripts=function(t,e,i){var s=I.prototype.scale;e.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture,i.children.forEach((i=>{var r;if("script"===i.tag){if(!(r=this.loadScript(i,t)))return;r.setPosition(new o.E9((+i.attributes.x||0)*s,(+i.attributes.y||0)*s).add(e.topLeft())),e.add(r),r.fixBlockColor(null,!0),r.allComments().forEach((t=>t.align(r)))}else if("comment"===i.tag){if(!(r=this.loadComment(i)))return;r.setPosition(new o.E9((+i.attributes.x||0)*s,(+i.attributes.y||0)*s).add(e.topLeft())),e.add(r)}}))},_t.prototype.loadScriptsArray=function(t,e){var i=I.prototype.scale,s=[];return t.children.forEach((t=>{var r;if("script"===t.tag){if(!(r=this.loadScript(t,e)))return;r.setPosition(new o.E9((+t.attributes.x||0)*i,(+t.attributes.y||0)*i)),s.push(r),r.fixBlockColor(null,!0)}else if("comment"===t.tag){if(!(r=this.loadComment(t)))return;r.setPosition(new o.E9((+t.attributes.x||0)*i,(+t.attributes.y||0)*i)),s.push(r)}})),s},_t.prototype.loadScript=function(t,e){var o,i,s;return this.project.stage||(this.project.stage=e.parentThatIsA(b),this.project.targetStage=this.project.stage),t.children.forEach((t=>{if(s=this.loadBlock(t,!1,e)){if(i){if(!(i.nextBlock&&s instanceof R))return console.log("SNAP: expecting a command but getting a reporter:\n  "+i.blockSpec+"\n  "+s.blockSpec),o;i.nextBlock(s)}else o=s;i=s}})),o},_t.prototype.loadComment=function(t){var e=new ot(t.contents),o=I.prototype.scale;return e.isCollapsed="true"===t.attributes.collapsed,e.setTextWidth(+t.attributes.w*o),e},_t.prototype.setBlockId=function(t,e){var o=parseInt(t.attributes.blockID);isNaN(o)||(e.id=o,A.nextId=Math.max(A.nextId,o+1))},_t.prototype.loadBlock=function(t,e,i){var s,r,n,a,h,l,p=0;if("block"===t.tag)Object.prototype.hasOwnProperty.call(t.attributes,"var")?s=y.prototype.variableBlock(t.attributes.var):(s=y.prototype.blockForSelector(t.attributes.s),(l=y.prototype.blockMigrations[t.attributes.s])&&(p=l.offset));else if("custom-block"===t.tag){if(h=(a=!t.attributes.scope)?this.project.stage:i,a?!(r=(0,o.qY)(h.globalBlocks,(e=>e.blockSpec()===t.attributes.s)))&&this.project.targetStage&&(r=(0,o.qY)(this.project.targetStage.globalBlocks,(e=>e.blockSpec()===t.attributes.s))):r=(0,o.qY)(h.customBlocks,(e=>e.blockSpec()===t.attributes.s))||(h.inheritedMethodsCache?(0,o.qY)(h.inheritedMethodsCache,(e=>e.blockSpec()===t.attributes.s)):null),!r||!(0,o.r3)(y.prototype.categories,r.category))return this.obsoleteBlock(e);s="command"===r.type?new gt(r,!1):new yt(r,"predicate"===r.type,!1)}return null===s&&(s=this.obsoleteBlock(e)),_t.prototype.setBlockId(t,s),s.isDraggable=!0,n=s.inputs(),t.children.forEach(((t,e)=>{"variables"===t.tag?this.loadVariables(s.variables,t,i):"comment"===t.tag?(s.comment=this.loadComment(t),s.comment.block=s):"receiver"===t.tag?(0,o.WY)():this.loadInput(t,n[e+p],s,i)})),s.cachedInputs=null,s},_t.prototype.obsoleteBlock=function(t){var e=t?new D:new R;return e.selector="errorObsolete",e.color=new o.Il(200,0,20),e.setSpec("Obsolete!"),e.isDraggable=!0,e},_t.prototype.loadInput=function(t,e,i,s){var r,n;if(!(0,o.kK)(e))if("script"===t.tag)(r=this.loadScript(t,s))&&("reifyReporter"===i.selector||"reifyPredicate"===i.selector?(e.replaceInput(e.children[0],r),e.fixLayout()):(e.add(r),e.fixLayout()));else if("autolambda"===t.tag&&t.children[0])(r=this.loadBlock(t.children[0],!0,s))&&(e.replaceInput(e.children[0],r),e.fixLayout());else if("list"===t.tag){for(;e.inputs().length>0;)e.removeInput();t.children.forEach((t=>{e.addInput(),this.loadInput(t,e.children[e.children.length-2],e,s)})),e.fixLayout()}else"block"===t.tag||"custom-block"===t.tag?i.replaceInput(e,this.loadBlock(t,!0,s)):"color"===t.tag?e.setColor(this.loadColor(t.contents)):(n=this.loadValue(t),(0,o.kK)(n)||(0,o.kK)(e)||!e.setContents||e.setContents(this.loadValue(t)))},_t.prototype.loadValue=function(t,e){var i,s,r,n,l,p,c,u,f,g,m,b,w,v,k=this;function M(){Object.prototype.hasOwnProperty.call(t.attributes,"id")&&(k.objects[t.attributes.id]=i),Object.prototype.hasOwnProperty.call(t.attributes,"mediaID")&&(k.mediaDict[t.attributes.mediaID]=i)}switch(t.tag){case"ref":if(Object.prototype.hasOwnProperty.call(t.attributes,"id"))return this.objects[t.attributes.id];if(Object.prototype.hasOwnProperty.call(t.attributes,"mediaID"))return this.mediaDict[t.attributes.mediaID];throw new Error("expecting a reference id");case"l":return(g=t.childNamed("option"))?[g.contents]:(m=t.childNamed("bool"))?this.loadValue(m):(w=t.childNamed("wish"))?this.loadValue(w):t.contents;case"bool":return"true"===t.contents;case"list":return t.attributes.hasOwnProperty("linked")?"atomic"===t.attributes.struct?((i=a.prototype.parseCSV(t.contents)).becomeLinked(),M(),i):((i=new d).isLinked=!0,M(),r=i,(n=t.childrenNamed("item")).forEach(((o,s)=>{var r=o.children[0];i.first=r?this.loadValue(r,e):0;var a=t.childNamed("list")||t.childNamed("ref");a?i.rest=this.loadValue(a,e):s<n.length-1&&(i.rest=new d,(i=i.rest).isLinked=!0)})),r):"atomic"===t.attributes.struct?(i=a.prototype.parseCSV(t.contents),M(),i):(i=new d,M(),i.contents=t.childrenNamed("item").map((t=>{var o=t.children[0];return o?this.loadValue(o,e):0})),i);case"sprite":return i=new y(this.project.globalVariables),t.attributes.id&&(this.objects[t.attributes.id]=i),t.attributes.name&&(i.name=t.attributes.name,this.project.sprites[t.attributes.name]=i),t.attributes.idx&&(i.idx=+t.attributes.idx),t.attributes.color&&(i.color=this.loadColor(t.attributes.color),i.cachedHSV=i.color.hsv()),t.attributes.pen&&(i.penPoint=t.attributes.pen),t.attributes.volume&&(i.volume=+t.attributes.volume),t.attributes.pan&&(i.pan=+t.attributes.pan),this.project.stage.add(i),i.scale=parseFloat(t.attributes.scale||"1"),i.rotationStyle=parseFloat(t.attributes.rotation||"1"),i.isDraggable="false"!==t.attributes.draggable,i.isVisible="true"!==t.attributes.hidden,i.heading=parseFloat(t.attributes.heading)||0,i.gotoXY(+t.attributes.x||0,+t.attributes.y||0),this.loadObject(i,t),i.fixLayout(),i;case"context":return i=new h(null),M(),(l=t.childNamed("origin"))&&(l=l.childNamed("ref")||l.childNamed("sprite"))&&(i.origin=this.loadValue(l)),(l=t.childNamed("receiver"))&&(l=l.childNamed("ref")||l.childNamed("sprite"))&&(i.receiver=this.loadValue(l)),b=i.origin||i.receiver||e,(l=t.childNamed("script"))?i.expression=this.loadScript(l,b):(l=t.childNamed("block")||t.childNamed("custom-block"))?i.expression=this.loadBlock(l,null,b):(l=t.childNamed("l"))&&(m=l.childNamed("bool"),i.expression=m?new q(this.loadValue(m)):new H(l.contents)),i.expression instanceof A&&(s=0,i.expression.allEmptySlots().forEach((t=>{s+=1,t.bindingID=t instanceof Z?["arguments"]:s})),i.emptySlots=s),(l=t.childNamed("inputs"))&&l.children.forEach((t=>{"input"===t.tag&&i.inputs.push(t.contents)})),(l=t.childNamed("variables"))&&this.loadVariables(i.variables,l,b),(l=t.childNamed("context"))&&(i.outerContext=this.loadValue(l,b)),i.outerContext&&i.receiver&&!i.outerContext.variables.parentFrame&&(i.outerContext.variables.parentFrame=i.receiver.variables),i;case"costume":return p=new o.E9,Object.prototype.hasOwnProperty.call(t.attributes,"center-x")&&(p.x=parseFloat(t.attributes["center-x"])),Object.prototype.hasOwnProperty.call(t.attributes,"center-y")&&(p.y=parseFloat(t.attributes["center-y"])),Object.prototype.hasOwnProperty.call(t.attributes,"name")&&(u=t.attributes.name),Object.prototype.hasOwnProperty.call(t.attributes,"image")&&(c=new Image,0!==t.attributes.image.indexOf("data:image/svg+xml")||o.tU.rasterizeSVGs?(i=new C(null,u,p),c.onload=function(){var t=(0,o.oM)(new o.E9(c.width,c.height),!0);t.getContext("2d").drawImage(c,0,0),i.contents=t,i.version=+new Date,"function"==typeof i.loaded?i.loaded():i.loaded=!0}):(i=new S(null,u,p),c.onload=function(){i.contents=c,i.version=+new Date,"function"==typeof i.loaded?i.loaded():i.loaded=!0}),c.src=t.attributes.image),M(),i;case"sound":return f=new Audio,i=new x(f,t.attributes.name),f.oncanplaythrough=()=>i.loaded=!0,f.src=t.attributes.sound,Object.prototype.hasOwnProperty.call(t.attributes,"mediaID")&&(this.mediaDict[t.attributes.mediaID]=i),M(),i;case"wish":return(v=new ft(t.attributes.s)).type=t.attributes.type,v.category=t.attributes.category,v.storedSemanticSpec=t.attributes.s,v.updateTranslations(t.contents),v.blockInstance(!0)}},_t.prototype.loadColor=function(t){var e=(t||"").split(",");return new o.Il(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]))},_t.prototype.openProject=function(t,e){var i,s=e.stage,r=[];t&&t.stage&&(e.siblings().forEach((t=>t.destroy())),e.projectName=t.name,e.projectNotes=t.notes||"",e.setProjectData(t.data||""),e.globalVariables&&(e.globalVariables=t.globalVariables),s&&s.destroy(),e.add(t.stage),e.stage=t.stage,(r=e.stage.children.filter((t=>t instanceof y))).sort(((t,e)=>t.idx-e.idx)),e.sprites=new d(r),i=r[0]||t.stage,(0,o.Qm)(this.mediaDict)>0?(e.hasChangedMedia=!1,this.mediaDict={}):e.hasChangedMedia=!0,t.stage.fixLayout(),t.stage.pauseGenericHatBlocks(),e.createCorral(),e.selectSprite(i),e.fixLayout(),e.world().keyboardFocus=t.stage)},Array.prototype.toXML=function(t){return this.reduce(((e,o)=>e+t.store(o)),"")},b.prototype.toXML=function(t){var i,s=t.excludeMedia?"":(0,o.bl)(this.thumbnail(_t.prototype.thumbnailSize),!0),r=this.getCostumeIdx(),n=this.parentThatIsA(IDE_Morph);try{i=t.excludeMedia?null:s.toDataURL("image/png")}catch(t){i=null}function h(t){var e="";return Object.keys(b.prototype[t]).forEach((o=>{e+="<"+o+">"+Ht.prototype.escape(b.prototype[t][o])+"</"+o+">"})),e}this.removeAllClones();var l,p=n?JSON.stringify(n.getProjectData()):"";return t.format('<project name="@" app="@" version="@" guid="@" assignment="@"><data>$</data><notes>$</notes><thumbnail>$</thumbnail><stage name="@" width="@" height="@" costume="@" color="@,@,@,@" tempo="@" threadsafe="@" penlog="@" %volume="@" pan="@" lines="@" ternary="@" hyperops="@" codify="@" inheritance="@" sublistIDs="@" scheduled="@" ~><pentrails>$</pentrails>%<costumes>%</costumes><sounds>%</sounds><variables>%</variables><blocks>%</blocks><scripts>%</scripts><sprites>%</sprites></stage><hidden>$</hidden><headers>%</headers><code>%</code><blocks>%</blocks><variables>%</variables>%</project>',n&&n.projectName?n.projectName:(0,o.NC)("Untitled"),t.app,t.version,this.guid,this.assignment,p,n&&n.projectNotes?n.projectNotes:"",i,this.name,b.prototype.dimensions.x,b.prototype.dimensions.y,r,this.color.r,this.color.g,this.color.b,this.color.a,this.getTempo(),this.isThreadSafe,this.enablePenLogging,this.instrument?' instrument="'+parseInt(this.instrument)+'" ':"",this.volume,this.pan,y.prototype.useFlatLineEnds?"flat":"round",q.prototype.isTernary,!0===a.prototype.enableHyperOps,this.enableCodeMapping,this.enableInheritance,this.enableSublistIDs,0!==b.prototype.frameRate,t.excludeMedia?"":(0,o.bl)(this.trailsCanvas,!0).toDataURL("image/png"),r||!this.costume||t.excludeMedia?"":"<wear>"+t.store(this.costume)+"</wear>",t.store(this.costumes,this.name+"_cst"),t.store(this.sounds,this.name+"_snd"),t.store(this.variables),t.store(this.customBlocks),t.store(this.scripts),t.store(this.children),Object.keys(b.prototype.hiddenPrimitives).reduce(((t,e)=>t+" "+e),""),h("codeHeaders"),h("codeMappings"),t.store(this.globalBlocks),n&&n.globalVariables?t.store(n.globalVariables):"",(l=e.BlockEditorMorph.showing.map((function(e){if(!e.definition)return"";var o=e.definition.copyAndBindTo();return e.applyToDefinition(o),o.toXML(t)})),t.format("<editing>%</editing>",l.join())))},y.prototype.toXML=function(t){var e=this.parentThatIsA(b),o=e?e.parentThatIsA(IDE_Morph):null,i=o?o.sprites.asArray().indexOf(this)+1:0,s=this.getCostumeIdx(),r=this.inheritsAttribute("costumes"),n=this.inheritsAttribute("sounds"),a=this.inheritsAttribute("scripts");return t.format('<sprite name="@" idx="@" x="@" y="@" heading="@" scale="@" volume="@" pan="@" rotation="@"% draggable="@"% costume="@" color="@,@,@,@" pen="@" ~>%%%'+(r?"%":"<costumes>%</costumes>")+(n?"%":"<sounds>%</sounds>")+"<blocks>%</blocks><variables>%</variables>"+(this.exemplar?"<dispatches>%</dispatches>":"%")+(a?"%":"<scripts>%</scripts>")+"</sprite>",this.name,i,this.xPosition(),this.yPosition(),this.heading,this.scale,this.volume,this.pan,this.rotationStyle,this.instrument?' instrument="'+parseInt(this.instrument)+'" ':"",this.isDraggable,this.isVisible?"":' hidden="true"',s,this.color.r,this.color.g,this.color.b,this.color.a,this.penPoint,this.exemplar?'<inherit exemplar="'+this.exemplar.name+'">'+(this.inheritedAttributes.length?t.store(new d(this.inheritedAttributes)):"")+"</inherit>":"",this.anchor?'<nest anchor="'+this.anchor.name+'" synch="'+this.rotatesWithAnchor+(this.scale===this.nestingScale?"":'" scale="'+this.nestingScale)+'"/>':"",!s&&this.costume?"<wear>"+t.store(this.costume)+"</wear>":"",r?"":t.store(this.costumes,this.name+"_cst"),n?"":t.store(this.sounds,this.name+"_snd"),this.customBlocks?t.store(this.customBlocks):"",t.store(this.variables),this.exemplar?t.store(this.inheritedMethods()):"",a?"":t.store(this.scripts))},C.prototype[Ut.prototype.mediaDetectionProperty]=!0,C.prototype.toXML=function(t){return t.format('<costume name="@" center-x="@" center-y="@" image="@" ~/>',this.name,this.rotationCenter.x,this.rotationCenter.y,t.excludeMedia?"":this instanceof S?this.contents?this.contents.src:"":(0,o.bl)(this.contents).toDataURL("image/png"))},x.prototype[Ut.prototype.mediaDetectionProperty]=!0,x.prototype.toXML=function(t){return t.format('<sound name="@" sound="@" ~/>',this.name,t.excludeMedia?"":this.toDataURL())},p.prototype.toXML=function(t){return Object.keys(this.vars).reduce(((e,o)=>{var i=this.vars[o].value;return e+(this.vars[o].isTransient?t.format('<variable name="@" transient="true"/>',o):null==i?t.format('<variable name="@"/>',o):t.format('<variable name="@">%</variable>',o,"object"==typeof i?g(i)?"":t.store(i):"boolean"==typeof i?t.format("<bool>$</bool>",i):t.format("<l>$</l>",i)))}),"")},B.prototype.toXML=function(t){var e=this.target instanceof p,o=this.currentValue instanceof d,i=this.readoutColor,s=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();return this.isTemporary()?"":t.format('<watcher% % style="@"% x="@" y="@" color="@,@,@"%%/>',e&&this.target.owner||!e&&this.target?t.format(' scope="@"',e?this.target.owner.name:this.target.name):"",t.format(e?'var="@"':'s="@"',this.getter),this.style,e&&"slider"===this.style?t.format(' min="@" max="@"',this.sliderMorph.start,this.sliderMorph.stop):"",s.x,s.y,i.r,i.g,i.b,o?t.format(' extX="@" extY="@"',this.cellMorph.contentsMorph.width(),this.cellMorph.contentsMorph.height()):"",this.isVisible?"":' hidden="true"')},N.prototype.toXML=function(t){return this.children.reduce(((e,o)=>o instanceof A?e+o.toScriptXML(t,!0):o instanceof ot&&!o.block?e+o.toXML(t):e),"")},A.prototype.toXML=A.prototype.toScriptXML=function(t,e){var o,i,s=I.prototype.scale,r=this;o=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),i=e?t.format('<script x="@" y="@">',o.x/s,o.y/s):"<script>";do{i+=r.toBlockXML(t),r=r.nextBlock()}while(r);return i+"<\/script>"},A.prototype.toBlockXML=function(t){return t.format('<block blockID="@" s="@">%%</block>',this.id,this.selector,t.store(this.inputs()),this.comment?this.comment.toXML(t):"")},D.prototype.toXML=function(t){return"reportGetVar"===this.selector?this.comment?t.format('<block id="@" var="@">%</block>',this.id,this.blockSpec,this.comment.toXML(t)):t.format('<block id="@" var="@"/>',this.id,this.blockSpec):this.toBlockXML(t)},D.prototype.toScriptXML=function(t,e){var o,i=I.prototype.scale;return o=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),e?t.format('<script x="@" y="@">%<\/script>',o.x/i,o.y/i,this.toXML(t)):t.format("<script>%<\/script>",this.toXML(t))},gt.prototype.toBlockXML=function(t){var e=this.isGlobal?void 0:"local";return t.format('<custom-block id="@" s="@"%>%%%%</custom-block>',this.id,this.semanticSpec,this.isGlobal?"":t.format(' scope="@"',e),t.store(this.inputs()),this.isGlobal&&this.definition.variableNames.length&&!t.isExportingBlocksLibrary?"<variables>"+this.variables.toXML(t)+"</variables>":"",this.comment?this.comment.toXML(t):"")},yt.prototype.toBlockXML=gt.prototype.toBlockXML,ft.prototype.toXML=function(t){return t.format('<block-definition s="@" type="@" category="@" guid="@" isImported="@">%'+(this.variableNames.length?"<variables>%</variables>":"@")+"<header>@</header><code>@</code><translations>@</translations><inputs>%</inputs>%%</block-definition>",this.spec,this.type,this.category||"other",this.guid,this.isImported,this.comment?this.comment.toXML(t):"",this.variableNames.length?t.store(new d(this.variableNames)):"",this.codeHeader||"",this.codeMapping||"",this.translationsAsText(),Array.from(this.declarations.keys()).reduce(((e,o)=>e+t.format('<input type="@"$>$%</input>',this.declarations.get(o)[0],this.declarations.get(o)[3]?' readonly="true"':"",this.declarations.get(o)[1],this.declarations.get(o)[2]?t.format("<options>@</options>",this.declarations.get(o)[2]):"")),""),this.body?t.store(this.body.expression):"",this.scripts.length>0?"<scripts>"+this.scripts.reduce(((e,o)=>o instanceof A?e+o.toScriptXML(t,!0):o instanceof ot&&!o.block?e+o.toXML(t):e),"")+"</scripts>":"")},j.prototype.toXML=function(){return"<l/>"},q.prototype.toXML=function(){return"boolean"==typeof this.value?"<l><bool>"+this.value+"</bool></l>":"<l/>"},H.prototype.toXML=function(t){return this.selectedBlock?t.format('<l><wish s="@" type="@" category="@">@</wish></l>',this.selectedBlock.semanticSpec,this.selectedBlock instanceof R?"command":this.selectedBlock.isPredicate?"predicate":"reporter",this.selectedBlock.category,this.selectedBlock.storedTranslations):this.constant?t.format("<l><option>$</option></l>",this.constant):t.format("<l>$</l>",this.contents().text)},G.prototype.toXML=function(t){return t.format("<l>$</l>",this.contents())},V.prototype.toXML=function(t){var e=this.nestedBlock();return e instanceof A?e instanceof D?t.format("<autolambda>%</autolambda>",t.store(e)):t.store(e):"<script><\/script>"},Q.prototype.toXML=V.prototype.toXML,Z.prototype.toXML=function(t){return t.format("<list>%</list>",t.store(this.inputs()))},$.prototype.toXML=function(t){return t.format("%",t.store(this.inputs()[0]))},X.prototype.toXML=function(t){return t.format("<color>$,$,$,$</color>",this.color.r,this.color.g,this.color.b,this.color.a)},d.prototype.toXML=function(t,e){var i,s,r;if(this.hasOnlyAtomicData()&&(!this.isLinked||!b.prototype.enableSublistIDs))return t.format('<list struct="atomic" '+(this.isLinked?'linked="linked" ':"")+"~>@</list>",this.asCSV());if(this.isLinked){if(i='<list linked="linked" ~>',b.prototype.enableSublistIDs)return s=this.first,(0,o.kK)(s)||(i+=t.format("<item>%</item>","object"==typeof s?g(s)?"":t.store(s,e):"boolean"==typeof s?t.format("<bool>$</bool>",s):t.format("<l>$</l>",s))),(0,o.kK)(this.rest)||(i+=t.store(this.rest,e)),i+"</list>";r=this;do{s=r.first,(0,o.kK)(s)||(i+=t.format("<item>%</item>","object"==typeof s?g(s)?"":t.store(s,e):"boolean"==typeof s?t.format("<bool>$</bool>",s):t.format("<l>$</l>",s))),r=r.rest}while(!(0,o.kK)(r));return i+"</list>"}return t.format("<list ~>%</list>",this.contents.reduce(((o,i)=>o+t.format("<item>%</item>","object"==typeof i?g(i)?"":t.store(i,e):"boolean"==typeof i?t.format("<bool>$</bool>",i):t.format("<l>$</l>",i))),""))},h.prototype.toXML=function(t){return this.isContinuation?"":t.format("<context ~><inputs>%</inputs><variables>%</variables>%<receiver>%</receiver><origin>%</origin>%</context>",this.inputs.reduce(((e,o)=>e+t.format("<input>$</input>",o)),""),this.variables?t.store(this.variables):"",this.expression?t.store(this.expression):"",this.receiver?t.store(this.receiver):"",this.receiver?t.store(this.origin):"",this.outerContext?t.store(this.outerContext):"")},ot.prototype.toXML=function(t){var e,o=I.prototype.scale;return this.block?t.format('<comment w="@" collapsed="@">%</comment>',this.textWidth()/o,this.isCollapsed,t.escape(this.text())):(e=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft(),t.format('<comment x="@" y="@" w="@" collapsed="@">%</comment>',e.x/o,e.y/o,this.textWidth()/o,this.isCollapsed,t.escape(this.text())))},o.qz.cloud="2020-October-21",Gt.prototype.init=function(){this.apiBasePath="/api/v1",this.url=this.determineCloudDomain()+this.apiBasePath,this.username=null,this.disabled=!1},Gt.prototype.disable=function(){this.disabled=!0,this.username=null},Gt.MAX_FILE_SIZE=10485760,Gt.prototype.knownDomains={"Snap!Cloud":"https://snap.berkeley.edu","Snap!Cloud (cs10)":"https://snap-cloud.cs10.org","Snap!Cloud (staging)":"https://snap-staging.cs10.org",localhost:"http://localhost:8080","localhost (secure)":"https://localhost:4431"},Gt.prototype.defaultDomain=Gt.prototype.knownDomains["Snap!Cloud"],Gt.prototype.determineCloudDomain=function(){var t=window.location.host,e=document.head.querySelector("[name='snap-cloud-domain']"),o=this.defaultDomain,i=this.knownDomains;return e?e.getAttribute("location"):(Object.keys(i).some((function(e){var s=i[e];return!!Gt.isMatchingDomain(t,s)&&(o=s,!0)})),o)},Gt.isMatchingDomain=function(t,e){var o=e.indexOf(t);switch(o){case-1:return!1;case 0:return t===e;default:return/[\.\/]/.test(e[o-1])&&e.length===o+t.length}},Gt.prototype.parseDict=function(t){var e={};return t?(t.split("&").forEach((function(t){var o=t.split("="),i=decodeURIComponent(o[0]),s=decodeURIComponent(o[1]);e[i]=s})),e):e},Gt.prototype.encodeDict=function(t){var e,o,i="";if(!t)return null;for(o in t)t.hasOwnProperty(o)&&(e=encodeURIComponent(o)+"="+encodeURIComponent(t[o]),i.length>0&&(i+="&"),i+=e);return i},Gt.genericErrorMessage="There was an error while trying to access\na Snap!Cloud service. Please try again later.",Gt.prototype.genericError=function(){throw new Error(Gt.genericErrorMessage)},Gt.prototype.request=function(t,e,o,i,s,r,n){if(!this.disabled){var a=new XMLHttpRequest,h=this,l=this.url+(e.indexOf("%username")>-1?e.replace("%username",encodeURIComponent(this.username)):e);try{a.open(t,l,!0),a.setRequestHeader("Content-Type","application/json; charset=utf-8"),a.withCredentials=!0,a.onreadystatechange=function(){if(4===a.readyState)if(a.responseText){var t=r&&0!==a.responseText.indexOf('{"errors"')?a.responseText:JSON.parse(a.responseText);t.errors?i.call(null,t.errors[0],s):o&&o.call(null,t.message||t)}else i?i.call(null,s||Gt.genericErrorMessage,h.url):h.genericError()},a.send(n)}catch(t){i.call(this,t.toString(),"Cloud Error")}}},Gt.prototype.withCredentialsRequest=function(t,e,o,i,s,r,n){var a=this;this.checkCredentials((function(h){h?a.request(t,e,o,i,s,r,n):i.call(this,"You are not logged in","Snap!Cloud")}))},Gt.prototype.initSession=function(t){var e=this;"file:"!==location.protocol&&this.request("POST","/init",(function(){e.checkCredentials(t)}),(function(){}),null,!0)},Gt.prototype.checkCredentials=function(t,e,o){var i=this;this.getCurrentUser((function(e){e.username&&(i.username=e.username,i.verified=e.verified),t&&t.call(null,e.username,e.role,o?JSON.parse(o):null)}),e)},Gt.prototype.getCurrentUser=function(t,e){this.request("GET","/users/c",t,e,"Could not retrieve current user")},Gt.prototype.getUser=function(t,e,o){this.request("GET","/users/"+encodeURIComponent(t),e,o,"Could not retrieve user")},Gt.prototype.logout=function(t,e){this.username=null,this.request("POST","/logout",t,e,"logout failed")},Gt.prototype.login=function(t,e,o,i,s){var r=this;this.request("POST","/users/"+encodeURIComponent(t)+"/login?"+this.encodeDict({persist:o}),(function(t){r.checkCredentials(i,s,t)}),s,"login failed","false",hex_sha512(e))},Gt.prototype.signup=function(t,e,o,i,s,r){this.request("POST","/users/"+encodeURIComponent(t)+"?"+this.encodeDict({email:i,password:hex_sha512(e),password_repeat:hex_sha512(o)}),s,r,"signup failed")},Gt.prototype.changePassword=function(t,e,o,i,s){this.withCredentialsRequest("POST","/users/%username/newpassword?"+this.encodeDict({oldpassword:hex_sha512(t),password_repeat:hex_sha512(o),newpassword:hex_sha512(e)}),i,s,"Could not change password")},Gt.prototype.resetPassword=function(t,e,o){this.request("POST","/users/"+encodeURIComponent(t)+"/password_reset",e,o,"Password reset request failed")},Gt.prototype.resendVerification=function(t,e,o){this.request("POST","/users/"+encodeURIComponent(t)+"/resendverification",e,o,"Could not send verification email")},Gt.prototype.saveProject=function(t,e,o,i){var s=this;this.checkCredentials((function(r){r?s.request("POST","/projects/"+encodeURIComponent(r)+"/"+encodeURIComponent(t),o,i,"Project could not be saved",!1,JSON.stringify(e)):i.call(this,"You are not logged in","Snap!Cloud")}))},Gt.prototype.getProjectList=function(t,e,o){var i="/projects/%username?updatingnotes=true";o&&(i+="&withthumbnail=true"),this.withCredentialsRequest("GET",i,t,e,"Could not fetch projects")},Gt.prototype.getPublishedProjectList=function(t,e,o,i,s,r,n){var a="/projects"+(t?"/"+encodeURIComponent(t):"")+"?ispublished=true";t||(a+="&filtered=true"),n&&(a+="&withthumbnail=true"),e&&(a+="&page="+e+"&pagesize="+(o||16)),i&&(a+="&matchtext="+encodeURIComponent(i)),this.request("GET",a,s,r,"Could not fetch projects")},Gt.prototype.getThumbnail=function(t,e,o,i){this[t?"request":"withCredentialsRequest"]("GET","/projects/"+(t?encodeURIComponent(t):"%username")+"/"+encodeURIComponent(e)+"/thumbnail",o,i,"Could not fetch thumbnail",!0)},Gt.prototype.getProject=function(t,e,o,i){this.withCredentialsRequest("GET","/projects/%username/"+encodeURIComponent(t)+(e?"?delta="+e:""),o,i,"Could not fetch project "+t,!0)},Gt.prototype.getPublicProject=function(t,e,o,i){this.request("GET","/projects/"+encodeURIComponent(e)+"/"+encodeURIComponent(t),o,i,"Could not fetch project "+t,!0)},Gt.prototype.getProjectMetadata=function(t,e,o,i){this.request("GET","/projects/"+encodeURIComponent(e)+"/"+encodeURIComponent(t)+"/metadata",o,i,"Could not fetch metadata for "+t)},Gt.prototype.getProjectVersionMetadata=function(t,e,o){this.withCredentialsRequest("GET","/projects/%username/"+encodeURIComponent(t)+"/versions",e,o,"Could not fetch versions for project "+t)},Gt.prototype.getRemixes=function(t,e,o,i,s,r){var n="/projects/"+encodeURIComponent(t)+"/"+encodeURIComponent(e)+"/remixes";o&&(n+="?page="+o+"&pagesize="+(i||16)),this.request("GET",n,s,r,"Could not fetch remixes for project "+e)},Gt.prototype.deleteProject=function(t,e,o,i){this[e?"request":"withCredentialsRequest"]("DELETE","/projects/"+(e?encodeURIComponent(e):"%username")+"/"+encodeURIComponent(t),o,i,"Could not delete project")},Gt.prototype.shareProject=function(t,e,o,i){this[e?"request":"withCredentialsRequest"]("POST","/projects/"+(e?encodeURIComponent(e):"%username")+"/"+encodeURIComponent(t)+"/metadata?ispublic=true",o,i,"Could not share project")},Gt.prototype.unshareProject=function(t,e,o,i){this[e?"request":"withCredentialsRequest"]("POST","/projects/"+(e?encodeURIComponent(e):"%username")+"/"+encodeURIComponent(t)+"/metadata?ispublic=false&ispublished=false",o,i,"Could not unshare project")},Gt.prototype.publishProject=function(t,e,o,i){this[e?"request":"withCredentialsRequest"]("POST","/projects/"+(e?encodeURIComponent(e):"%username")+"/"+encodeURIComponent(t)+"/metadata?ispublished=true",o,i,"Could not publish project")},Gt.prototype.unpublishProject=function(t,e,o,i){this[e?"request":"withCredentialsRequest"]("POST","/projects/"+(e?encodeURIComponent(e):"%username")+"/"+encodeURIComponent(t)+"/metadata?ispublished=false",o,i,"Could not unpublish project")},Gt.prototype.updateNotes=function(t,e,o,i){this.withCredentialsRequest("POST","/projects/%username/"+encodeURIComponent(t)+"/metadata",o,i,"Could not update project notes",!1,JSON.stringify({notes:e}))},Gt.prototype.updateProjectName=function(t,e,o,i){this.withCredentialsRequest("POST","/projects/%username/"+encodeURIComponent(t)+"/metadata",o,i,"Could not update project name",!1,JSON.stringify({projectname:e}))},Gt.prototype.newCollection=function(t,e,o){this.withCredentialsRequest("POST","/users/%username/collections/"+encodeURIComponent(t),e,o,"Could not create collection")},Gt.prototype.getCollectionMetadata=function(t,e,o,i){this.request("GET","/users/"+(t?encodeURIComponent(t):"%username")+"/collections/"+encodeURIComponent(e)+"/metadata",o,i,"Could not fetch metadata for "+e)},Gt.prototype.getCollectionProjects=function(t,e,o,i,s,r,n){var a="/users/"+(t?encodeURIComponent(t):"%username")+"/collections/"+encodeURIComponent(i)+"/projects";e&&(a+="?page="+e+"&pagesize="+(o||16)),n&&(a+=(e?"&":"?")+"withthumbnail=true"),this.request("GET",a,s,r,"Could not fetch projects")},Gt.prototype.setCollectionThumbnail=function(t,e,o,i,s){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(t)+"/collections/"+encodeURIComponent(e)+"/thumbnail?id="+encodeURIComponent(o),i,s,"Could not set project thumbnail")},Gt.prototype.updateCollectionDescription=function(t,e,o,i,s){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(t)+"/collections/"+encodeURIComponent(e)+"/metadata",i,s,"Could not update collection description",!1,JSON.stringify({description:o}))},Gt.prototype.updateCollectionName=function(t,e,o,i,s){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(t)+"/collections/"+encodeURIComponent(e)+"/metadata",i,s,"Could not update collection name",!1,JSON.stringify({name:o}))},Gt.prototype.shareCollection=function(t,e,o,i){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(t)+"/collections/"+encodeURIComponent(e)+"/metadata?shared=true",o,i,"Could not share collection")},Gt.prototype.unshareCollection=function(t,e,o,i){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(t)+"/collections/"+encodeURIComponent(e)+"/metadata?shared=false&published=false",o,i,"Could not unshare collection")},Gt.prototype.publishCollection=function(t,e,o,i){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(t)+"/collections/"+encodeURIComponent(e)+"/metadata?published=true",o,i,"Could not publish collection")},Gt.prototype.unpublishCollection=function(t,e,o,i){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(t)+"/collections/"+encodeURIComponent(e)+"/metadata?published=false",o,i,"Could not unpublish collection")},Gt.prototype.addProjectToCollection=function(t,e,o,i,s,r){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(t)+"/collections/"+encodeURIComponent(e)+"/projects",s,r,"Could not add project to collection",!1,JSON.stringify({username:o,projectname:i}))},Gt.prototype.removeProjectFromCollection=function(t,e,o,i,s){this.withCredentialsRequest("DELETE","/users/"+encodeURIComponent(t)+"/collections/"+encodeURIComponent(e)+"/projects/"+encodeURIComponent(o),i,s,"Could not remove project from collection")},Gt.prototype.getUserCollections=function(t,e,o,i,s,r){this[t!==this.username?"request":"withCredentialsRequest"]("GET","/users/"+(t?encodeURIComponent(t):"%username")+"/collections?"+this.encodeDict(e>0?{page:e,pagesize:o||16,matchtext:i?encodeURIComponent(i):""}:{}),s,r,"Could not fetch collections")},Gt.prototype.getCollectionsContainingProject=function(t,e,o,i,s,r){var n="/projects/"+encodeURIComponent(t)+"/"+encodeURIComponent(e)+"/collections";o&&(n+="?page="+o+"&pagesize="+(i||16)),this.request("GET",n,s,r,"Could not fetch collections for project "+e)},Gt.prototype.getCollections=function(t,e,o,i,s){var r={page:t,pagesize:t?e||16:""};o&&(r.matchtext=encodeURIComponent(o)),this.request("GET","/collections?"+this.encodeDict(r),i,s,"Could not fetch collections")},Gt.prototype.deleteCollection=function(t,e,o,i){this.withCredentialsRequest("DELETE","/users/"+encodeURIComponent(t)+"/collections/"+encodeURIComponent(e),o,i,"Could not remove collection")},Gt.prototype.addEditorToCollection=function(t,e,o,i,s){this.withCredentialsRequest("POST","/users/"+encodeURIComponent(t)+"/collections/"+encodeURIComponent(e)+"/editors",i,s,"Could not add editor to collection",!1,JSON.stringify({editor_username:o}))},Gt.prototype.removeEditorFromCollection=function(t,e,o,i,s){this.withCredentialsRequest("DELETE","/users/"+encodeURIComponent(t)+"/collections/"+encodeURIComponent(e)+"/editors/"+encodeURIComponent(o),i,s,"Could not remove editor from collection")},Gt.prototype.showProjectPath=function(t,e){return"/project?"+this.encodeDict({user:t,project:e})};var qt,Yt=__webpack_require__(593);function Kt(t){this.init(t)}function Xt(t,e){this.init(t,e)}function Jt(t,e,o){this.init(t,e,o)}function Zt(t,e){this.init(t,e)}function $t(t,e){this.init(t,e)}function Qt(t){this.init(t)}function te(t){this.init(t)}function ee(t){this.init(t)}function oe(t,e){this.init(t,e)}function ie(t){this.init(t)}function se(t,e){this.init(t,e)}function re(t){this.init(t)}function ne(t){this.init(t)}function ae(t,e,o,i){this.init(t,e,o,i)}function he(t){this.init(t)}function le(){requestAnimationFrame(le),qt.doOneCycle()}o.qz.gui="2020-November-19",Kt.prototype=new o._V,Kt.prototype.constructor=Kt,Kt.uber=o._V.prototype,Kt.prototype.setDefaultDesign=function(){o.tU.isFlat=!1,y.prototype.paletteColor=new o.Il(30,30,30),y.prototype.paletteTextColor=new o.Il(230,230,230),b.prototype.paletteTextColor=y.prototype.paletteTextColor,b.prototype.paletteColor=y.prototype.paletteColor,y.prototype.sliderColor=y.prototype.paletteColor.lighter(30),Kt.prototype.buttonContrast=30,Kt.prototype.backgroundColor=new o.Il(10,10,10),Kt.prototype.frameColor=y.prototype.paletteColor,Kt.prototype.groupColor=y.prototype.paletteColor.lighter(5),Kt.prototype.sliderColor=y.prototype.sliderColor,Kt.prototype.buttonLabelColor=o.Cj,Kt.prototype.tabColors=[Kt.prototype.groupColor.darker(50),Kt.prototype.groupColor.darker(25),Kt.prototype.groupColor],Kt.prototype.rotationStyleColors=Kt.prototype.tabColors,Kt.prototype.appModeColor=o.E5,Kt.prototype.scriptsPaneTexture=this.scriptsTexture(),Kt.prototype.padding=1,Qt.prototype.labelColor=Kt.prototype.buttonLabelColor,te.prototype.labelColor=Kt.prototype.buttonLabelColor,ie.prototype.labelColor=Kt.prototype.buttonLabelColor,ee.prototype.labelColor=Kt.prototype.buttonLabelColor,I.prototype.contrast=65,N.prototype.feedbackColor=o.Cj},Kt.prototype.setFlatDesign=function(){o.tU.isFlat=!0,y.prototype.paletteColor=o.Cj,y.prototype.paletteTextColor=new o.Il(70,70,70),b.prototype.paletteTextColor=y.prototype.paletteTextColor,b.prototype.paletteColor=y.prototype.paletteColor,y.prototype.sliderColor=y.prototype.paletteColor,Kt.prototype.buttonContrast=30,Kt.prototype.backgroundColor=new o.Il(220,220,230),Kt.prototype.frameColor=new o.Il(240,240,245),Kt.prototype.groupColor=o.Cj,Kt.prototype.sliderColor=y.prototype.sliderColor,Kt.prototype.buttonLabelColor=new o.Il(70,70,70),Kt.prototype.tabColors=[Kt.prototype.frameColor,Kt.prototype.frameColor.lighter(50),Kt.prototype.groupColor],Kt.prototype.rotationStyleColors=Kt.prototype.tabColors,Kt.prototype.appModeColor=Kt.prototype.frameColor,Kt.prototype.scriptsPaneTexture=null,Kt.prototype.padding=1,Qt.prototype.labelColor=Kt.prototype.buttonLabelColor,te.prototype.labelColor=Kt.prototype.buttonLabelColor,ie.prototype.labelColor=Kt.prototype.buttonLabelColor,ee.prototype.labelColor=Kt.prototype.buttonLabelColor,I.prototype.contrast=25,N.prototype.feedbackColor=new o.Il(153,255,213)},Kt.prototype.scriptsTexture=function(){var t,e=(0,o.oM)(new o.E9(100,100)),i=e.getContext("2d");for(t=0;t<100;t+=4)i.fillStyle=this.frameColor.toString(),i.fillRect(t,0,1,100),i.fillStyle=this.groupColor.lighter(2).toString(),i.fillRect(t+1,0,1,100),i.fillRect(t+3,0,1,100),i.fillStyle=this.groupColor.darker(2).toString(),i.fillRect(t+2,0,1,100);return e},Kt.prototype.setDefaultDesign(),Kt.prototype.init=function(t){o.tU.globalFontFamily="Helvetica, Arial",this.userLanguage=null,this.projectsInURLs=!1,this.applySavedSettings(),this.cloud=new Gt,this.cloudMsg=null,this.source=null,this.serializer=new _t,this.globalVariables=new p,this.currentSprite=new y(this.globalVariables),this.sprites=new d([this.currentSprite]),this.currentCategory="motion",this.currentTab="scripts",this.projectName="",this.projectNotes="",this.logo=null,this.controlBar=null,this.categories=null,this.palette=null,this.paletteHandle=null,this.spriteBar=null,this.spriteEditor=null,this.stage=null,this.stageHandle=null,this.corralBar=null,this.corral=null,this.embedPlayButton=null,this.embedOverlay=null,this.isEmbedMode=!1,this.isAutoFill=void 0===t||t,this.isAppMode=!1,this.isSmallStage=!1,this.filePicker=null,this.hasChangedMedia=!1,this.isAnimating=!0,this.paletteWidth=200,this.stageRatio=1,this.wasSingleStepping=!1,this.loadNewProject=!1,this.shield=null,this.savingPreferences=!0,Kt.uber.init.call(this),this.color=this.backgroundColor},Kt.prototype.openIn=function(t){var e,i=this,s=null;function r(e){sessionStorage.username=e,i.controlBar.cloudButton.refresh(),e&&(i.source="cloud",i.cloud.verified||(new lt).inform("Unverified account",'Your account is still unverified.\nPlease use the verification link that\nwas sent to your email address when you\nsigned up.\n\nIf you cannot find that email, please\ncheck your spam folder. If you still\ncannot find it, please use the "Resend\nVerification Email..." option in the cloud\nmenu.',t,i.cloudIcon(null,new o.Il(0,180,0))))}function n(e){e.noCloud&&i.cloud.disable(),e.embedMode&&i.setEmbedMode(),e.editMode?i.toggleAppMode(!1):i.toggleAppMode(!0),e.noRun||a(),e.hideControls&&(i.controlBar.hide(),window.onbeforeunload=o.WY),e.noExitWarning&&(window.onbeforeunload=o.WY),e.lang&&i.setLanguage(e.lang,null,!0),i.isEmbedMode||t.worldCanvas.focus()}function a(){i.sprites.asArray().concat([i.stage]).some((t=>!!t.costume&&!0!==t.costume.loaded||t.costumes.asArray().some((t=>!0!==t.loaded))||t.sounds.asArray().some((t=>!0!==t.loaded))))?i.world().animations.push(new o.fw(o.WY,o.WY,0,200,o.WY,a)):i.runScripts()}function h(){var t,r;"#open:"===location.hash.substr(0,6)?(("%"===(e=location.hash.substr(6)).charAt(0)||e.search(/\%(?:[0-9a-f]{2})/i)>-1)&&(e=decodeURIComponent(e)),(0,o.r3)(["project","blocks","sprites","snapdata"].map((t=>e.substr(0,8).indexOf(t))),1)?this.droppedText(e):((r=e.indexOf("&"))>0&&((t=i.cloud.parseDict(e.substr(r))).editMode=!0,e=e.slice(0,r),n(t)),this.shield=new o._V,this.shield.alpha=0,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),this.showMessage("Fetching project..."),this.getURL(e,(t=>{var e;this.nextSteps([()=>e=this.showMessage("Opening project..."),()=>{0===t.indexOf("<snapdata")?this.rawOpenCloudDataString(t):0===t.indexOf("<project")&&this.rawOpenProjectString(t),this.hasChangedMedia=!0},()=>{this.shield.destroy(),this.shield=null,e.destroy(),this.toggleAppMode(!1)}])})))):"#run:"===location.hash.substr(0,5)?((r=(e=location.hash.substr(5)).indexOf("&"))>0&&(e=e.slice(0,r)),("%"===e.charAt(0)||e.search(/\%(?:[0-9a-f]{2})/i)>-1)&&(e=decodeURIComponent(e)),"<project>"===e.substr(0,8)?(this.rawOpenProjectString(e),n(i.cloud.parseDict(location.hash.substr(5)))):(this.shield=new o._V,this.shield.alpha=0,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),this.showMessage("Fetching project..."),this.getURL(e,(t=>{var e;this.nextSteps([()=>e=this.showMessage("Opening project..."),()=>{0===t.indexOf("<snapdata")?this.rawOpenCloudDataString(t):0===t.indexOf("<project")&&this.rawOpenProjectString(t),this.hasChangedMedia=!0},()=>{this.shield.destroy(),this.shield=null,e.destroy(),n(this.cloud.parseDict(location.hash.substr(5)))}])})))):"#present:"===location.hash.substr(0,9)?(this.shield=new o._V,this.shield.color=this.color,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),i.showMessage("Fetching project\nfrom the cloud..."),(t=i.cloud.parseDict(location.hash.substr(9))).Username=t.Username.toLowerCase(),i.cloud.getPublicProject(t.ProjectName,t.Username,(e=>{var o;i.nextSteps([()=>o=i.showMessage("Opening project..."),()=>{0===e.indexOf("<snapdata")?i.rawOpenCloudDataString(e):0===e.indexOf("<project")&&i.rawOpenProjectString(e),i.hasChangedMedia=!0},()=>{i.shield.destroy(),i.shield=null,o.destroy(),n(t)}])}),this.cloudError())):"#cloud:"===location.hash.substr(0,7)?(this.shield=new o._V,this.shield.alpha=0,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),i.showMessage("Fetching project\nfrom the cloud..."),t=i.cloud.parseDict(location.hash.substr(7)),i.cloud.getPublicProject(t.ProjectName,t.Username,(t=>{var e;i.nextSteps([()=>e=i.showMessage("Opening project..."),()=>{0===t.indexOf("<snapdata")?i.rawOpenCloudDataString(t):0===t.indexOf("<project")&&i.rawOpenProjectString(t),i.hasChangedMedia=!0},()=>{i.shield.destroy(),i.shield=null,e.destroy(),i.toggleAppMode(!1)}])}),this.cloudError())):"#dl:"===location.hash.substr(0,4)?(i.showMessage("Fetching project\nfrom the cloud..."),(t=i.cloud.parseDict(location.hash.substr(4))).Username=t.Username.toLowerCase(),i.cloud.getPublicProject(t.ProjectName,t.Username,(e=>{i.saveXMLAs(e,t.ProjectName),i.showMessage("Saved project\n"+t.ProjectName,2)}),this.cloudError())):"#lang:"===location.hash.substr(0,6)?(s=location.hash.substr(6),this.setLanguage(s,null,!0),this.loadNewProject=!0):"#signup"===location.hash.substr(0,7)&&this.createCloudAccount(),this.loadNewProject=!1}this.buildPanes(),t.add(this),t.userMenu=this.userMenu,this.cloud.message=e=>{var i,s=new o.wR(null,e);s.popUpCenteredInWorld(t),i=setInterval((()=>{s.destroy(),clearInterval(i)}),2e3)},t.reactToDropOf=e=>{e instanceof lt||e instanceof o.wR||(t.hand.grabOrigin?e.slideBackTo(t.hand.grabOrigin):t.hand.grab(e))},this.reactToWorldResize(t.bounds),this.userLanguage?(this.loadNewProject=!0,this.setLanguage(this.userLanguage,h)):h.call(this),"file:"!==location.protocol&&(sessionStorage.username?this.cloud.checkCredentials(r):this.cloud.initSession(r)),t.keyboardFocus=this.stage,this.warnAboutIE()},Kt.prototype.buildPanes=function(){this.createLogo(),this.createControlBar(),this.createCategories(),this.createPalette(),this.createStage(),this.createSpriteBar(),this.createSpriteEditor(),this.createCorralBar(),this.createCorral()},Kt.prototype.createLogo=function(){var t=this;this.logo&&this.logo.destroy(),this.logo=new o._V,this.logo.texture="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAYCAYAAACBbx+6AAAKiklEQVRYR5VXe3BU5RX/ne+7924SwiOEJJvwUCAgCZFBEtRatIlVlATLIwlFsCgdeYWICu1MfbKUabVVtBoDQlUcFCubEIpAAEUTrGhFGIXAAjZCFdhNQiTkQbK7997vdO7SREAo9P5zZ77HOb9zzu87D8JVfOyBwGIwEdg5XrcmKRExcoSCNQKgWwXRTYKQDAKUQi1DbASrjzgsdqdM8zc6d6o80LIBRR6oq1B52SN0pcteL+SUKbCdcw3lCUMsof2amAs0iVRNEoIhZYKoCcTtYBARxUUZ1IMZCIZxWDG9oVSv1/tP8Z12ZHAVNMqBdSW9l9uPAGYGoQwicqjQUQsmZ9kLSf8FGyhzzyCBP8X1kO7TLaoREJuIxCeSzKNhWzRbKhgyRCwJZfcA2UOY+E4QTewZK2Ob2tQhIl6cPLmuLKLPC+n8O2X/P+CJAXLAXXzpfLD+sqRHesaKF5vbHZtil4bCA98YeO+2f19J0Yl3+wzVDH0GMz8cE0WxHSH8DZrxhPsX3x7rBO5YUFgI1Um3y8r0sCg8WOZgBQ54YPTJGNCPgehwqNl/zfTmJoe3Dt9OeN15LgObTUs/JNB9prvA9/mljNvblCkyh+7l6p3AxVxt2JiQaltyIYB5AL5n5qWh1vqVA2cieCWjz+07AXd8C+eZAP71SY8Q6JlzfuajDPFMSkHg7brtSd1wVr2hVIymxX97f2IO2nCPP2be0EDaWZuMVttoP2tGBd5/dfCpToHnKMZUvWSJzP5ZNSinuouv9RXX/MRW9lMgHkekaqCsVZDmZnfD4JMI7LXPPUgHXATaBVEvLDrg7tBgRDbrK9wzGHwnM0Xrmsg3bT4eC5XV2FzfYnS/fkzK9zU7aQ7MXxbvnxkk8UhYUTcGTGJyMsM/Okw5s3rVdY2Zs/foe1MyIw8UHjA8oCosEUA1cjw/AA94M/KUMOcQBW8gsptYuXYpa8Cr/aZW7Sss9Mrhw33swWJkV1eL6uoc6wFPVVRDo3stmDN/xOFAed95EHYps7o/Jb/hrc6QTXt0/4QzYa1Egd7TyCq3WEgBGkggMyGhbt2bnpyrDO8PJDizAYPbbS21Tw+rXk+BjzIQvhRF8ub6MlhiF4h6dKU1J1M4xD+xvnc/CaMKpN5LntywqHM9d77vrwCNrCxNG32x0Oxs1lzpvmtdQVnfe0DArGvsczNskUAaareWDP/SOT+2qKa/DkrtLu14k8HrW+JrsKbf1xFZN3ESkhrbJ7tPxYYMMRpsxQi4ajaVDjnobI8vrslWLLc6186lNYBqX041hiyoDR339ovWNGs7GA3J+XUFneDGFft+T4zfCsYDm5enrzsfdF7R12lM1jsAfcPgNmJkMqE3AfEMWqYTlVpKvcDAbSCcEUCcIO6jSyzWSW04a8rXmGAw4yQYg5nQkxi9GHhu6/L0pbnzfbcxoZIUFXd52KlEOR5Yfm/cACFduxnCl5zvv70TWN68/YNYauVSi77BNjs2CmDVQKF/WFIyJPTzh48mGVbwCwK6E+MJJtpBLKUi+1kC3wNShbaF40KDrkM7FrQ0S5PmsyCMd5xAzHMVYRgzzbCV/jkb4Z66En/WpGuisjryFIkGsFqrWN0XAXx+NQuUpyyJ70VPnz5jfapc7RNS7mltXLlytj5nzipzbPG+gTrrTzIwQ2guTZmhHUoXxdteGnYkd/6hfUR8cMsr6dM6jcwt+nokkbkLJBdseWXY6+dH5a6iw3dLUiuYsQJEPwXQurU07b7OM3c9ery3DLceAdHHgvl1xVQYIvzGAUzshXCqTsP65NtsxioQWgAVw2w/kFLQuGfPykw9a84eqzPV3D2vZgQJ7UEp9YfYDtXamhwvLHs5QTRvKU2b3AW4+ND1YOwQQi3cXDJ8be78QwsZGCXAUgFDCdRPET8uGGMBiqlMWDcBHo9yMkVZ2RQ7d75vEzMGMMmFUqqO0b2H/dMBGym/zBB1Fe6PwBAgvAxgBYMWpuQH3nLq/5KdrA42f+Y69WXIdFKNA2pcsW+iYLzDjBIQZwHUWlmaNqnTsNzimiywtoFhL2PIYQTOZfDbAH1B4CwCTSfiJxXTHQTun5gQk/emZ2Aw3XPA8HkywuOKfZXElFJZmjYykik9LLrSWl1F0iyXIVaFgmqa5rI+NsO680LXJufXzedIo3ZhIv/Bi75qAvwMpEChrnJ52r1dkSg6MlqStYZBxwFKZ4XpW1ek7XTuTiiq6W+SfA/Ez4FxB0EkbylNG3fem4ljoR1hoFLYeJ50Kdtq/AcjHG7cFN/XDOu7AWpOzg+kH/DCiJdJXzFLocX7s5wK9+CivZnfne3WM0rD4ZYwhWO7dbjskD6VSPwOij1MmE2E+srS9LFdmWXu4dtJU2VgOgxgqFDqKc0V827YDCaCuIgYs1hxMQTdAubbFctJ21YM2z95ti85aGA5gFGsuISIHgNwshurWyKAAxXJy7q5sLA1qGb1za9/zVnzlyeu6h7TbdbZjmNT3flYN3XBvj+22noRA8cY6CBCFJgSFdQaM6ReMlyinEDHKkvTZ3R5f77vTmIuZYlXSNEoEPKZcRiMehAsJ4URsEIJSiPmOQT+EKAWJhoEcIKmxFxbKottVICwrrI0fTY5Pa5N8iunh2i3w2MGT2lqdhTWlSWNj4kxNp0Nth8Qoe/vSCphc2rWgYk2EE8gYZNqs1l88feSjN0RPj908AZlo3X78uG1nYBnPHYoHh0dQweh+ZCzdgjxeU5B0Q0+2MduOtAsY+Paw3qo1daeAXFSFJnLJIm+LIi6a+Hq1ctG+bwvfBq97pueg4TR42jZi/07KFDh9ib20gpPnbH/4J4ceHLPSuhZc2AeW31tVFT34Fp3ojE50Gi9n5zqn0oj0HSp0nmpNY/HIzwez1VNF+OLD35gM4W3lqbn/W/5TBRYn7iISPaxFXn7Fvi/9Hgg0tNBzpRR571mIMtgSbcokXe2PcavKLaCYR4DFBT1qvWfnFZ984IFLU4rugRVoroaqKrKsZ0e0OmxT3qzrlOC7pZojmbWmcggWylACNh2nBYb9VG4LTy9ZuqOJY/31my9dMziF3vGvDugpSPb0GWzBdkEwWSdbs/aOPxXZZHIXTAidTbzzj9Srwns35QSgzDfJdjKBon+DM1m5gwidAjhL0yahG/+VZnqSt1dazoC9yZDZs6G5dwNbEhcBIXHAdpFZCu2NQ0kmahdWZyoubQjaLMmbc/Z9pdR6a4Qv5bzYK2ufTwmZGUoTXxnsooxGByWetPTSRPC+yN9zeVC4OBd4gF5zhsanUY/w4PwiQ19R0plvQWmpckFdd7Lyagrd29i4Nvkgrpix/DTHaboHa1HaCKMDFLh9/lIo0c9/dmUOKkpXj36+TOuPm+KU8ZYSggfYGHYpMKSP+nwhzrnSnLCWZYOutyYEpm/fOCLp9268uQXQOpGZnKKTBtLinaYAgJJojZWfCsDBSTlFPfEEzVXy/3/5UCHZlecmh0BjrfLvBAJPlC/G1PlkNza0OkP4noGW4zVhkaTTAsWsTNnkDP02XSu82oTTPOSCgJvOw850xE09MezY9mpQp7i87IHwOJ0IiRcSNOIAdkRmZEJ5D9/VBCtnsd7nAAAAABJRU5ErkJggg==",this.logo.render=function(e){var i=e.createLinearGradient(0,0,this.width(),0);i.addColorStop(0,"black"),i.addColorStop(.5,t.frameColor.toString()),e.fillStyle=o.tU.isFlat?t.frameColor.toString():i,e.fillRect(0,0,this.width(),this.height()),this.cachedTexture?this.renderCachedTexture(e):this.texture&&this.renderTexture(this.texture,e)},this.logo.renderCachedTexture=function(t){t.drawImage(this.cachedTexture,5,Math.round((this.height()-this.cachedTexture.height)/2)),this.changed()},this.logo.mouseClickLeft=function(){t.snapMenu()},this.logo.color=o.E5,this.logo.setExtent(new o.E9(200,28)),this.add(this.logo)},Kt.prototype.createControlBar=function(){var t,e,i,r,n,h,l,p,c,d,u,f,g=o.tU.isFlat?this.tabColors:[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)],y=this;this.controlBar&&this.controlBar.destroy(),this.controlBar=new o._V,this.controlBar.color=this.frameColor,this.controlBar.setHeight(this.logo.height()),this.controlBar.mouseClickLeft=function(){this.world().fillPage()},this.add(this.controlBar),(t=new rt(null,this,"toggleStageSize",[new s("smallStage",14),new s("normalStage",14)],(()=>this.isSmallStage))).hasNeutralBackground=!0,t.corner=12,t.color=g[0],t.highlightColor=g[1],t.pressColor=g[0],t.labelMinExtent=new o.E9(36,18),t.padding=0,t.labelShadowOffset=new o.E9(-1,-1),t.labelShadowColor=g[1],t.labelColor=o.tU.isFlat?o.Cj:this.buttonLabelColor,t.contrast=this.buttonContrast,t.fixLayout(),t.refresh(),p=t,this.controlBar.add(p),this.controlBar.stageSizeButton=t,(t=new rt(null,this,"toggleAppMode",[new s("fullScreen",14),new s("normalScreen",14)],(()=>this.isAppMode))).hasNeutralBackground=!0,t.corner=12,t.color=g[0],t.highlightColor=g[1],t.pressColor=g[0],t.labelMinExtent=new o.E9(36,18),t.padding=0,t.labelShadowOffset=new o.E9(-1,-1),t.labelShadowColor=g[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.fixLayout(),t.refresh(),c=t,this.controlBar.add(c),this.controlBar.appModeButton=c,(t=new rt(null,this,"toggleSingleStepping",[new s("footprints",16),new s("footprints",16)],(()=>a.prototype.enableSingleStepping))).corner=12,t.color=g[0],t.highlightColor=g[1],t.pressColor=new o.Il(153,255,213),t.labelMinExtent=new o.E9(36,18),t.padding=0,t.labelShadowOffset=new o.E9(-1,-1),t.labelShadowColor=g[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.hint="Visible stepping",t.fixLayout(),t.refresh(),d=t,this.controlBar.add(d),this.controlBar.steppingButton=d,(t=new rt(null,this,"stopAllScripts",[new s("octagon",14),new s("square",14)],(()=>!this.stage||y.stage.enableCustomHatBlocks&&y.stage.threads.pauseCustomHatBlocks))).corner=12,t.color=g[0],t.highlightColor=g[1],t.pressColor=g[2],t.labelMinExtent=new o.E9(36,18),t.padding=0,t.labelShadowOffset=new o.E9(-1,-1),t.labelShadowColor=g[1],t.labelColor=new o.Il(o.tU.isFlat?128:200,0,0),t.contrast=this.buttonContrast,t.fixLayout(),t.refresh(),i=t,this.controlBar.add(i),this.controlBar.stopButton=i,(t=new rt(null,this,"togglePauseResume",[new s("pause",12),new s("pointRight",14)],(()=>this.isPaused()))).hasNeutralBackground=!0,t.corner=12,t.color=g[0],t.highlightColor=g[1],t.pressColor=g[0],t.labelMinExtent=new o.E9(36,18),t.padding=0,t.labelShadowOffset=new o.E9(-1,-1),t.labelShadowColor=g[1],t.labelColor=o.tU.isFlat?new o.Il(220,185,0):new o.Il(255,220,0),t.contrast=this.buttonContrast,t.fixLayout(),t.refresh(),r=t,this.controlBar.add(r),this.controlBar.pauseButton=r,(t=new st(this,"pressStart",new s("flag",14))).corner=12,t.color=g[0],t.highlightColor=g[1],t.pressColor=g[2],t.labelMinExtent=new o.E9(36,18),t.padding=0,t.labelShadowOffset=new o.E9(-1,-1),t.labelShadowColor=g[1],t.labelColor=new o.Il(0,o.tU.isFlat?100:200,0),t.contrast=this.buttonContrast,t.fixLayout(),n=t,this.controlBar.add(n),this.controlBar.startButton=n,(e=new o.Vl(61,1,100*a.prototype.flashTime+1,6,"horizontal")).action=t=>{a.prototype.flashTime=(t-1)/100,this.controlBar.refreshResumeSymbol()},e.color=new o.Il(153,255,213),e.alpha=.3,e.setExtent(new o.E9(50,14)),this.controlBar.add(e),this.controlBar.steppingSlider=e,(t=new st(this,"projectMenu",new s("file",14))).corner=12,t.color=g[0],t.highlightColor=g[1],t.pressColor=g[2],t.labelMinExtent=new o.E9(36,18),t.padding=0,t.labelShadowOffset=new o.E9(-1,-1),t.labelShadowColor=g[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.fixLayout(),h=t,this.controlBar.add(h),this.controlBar.projectButton=h,(t=new st(this,"settingsMenu",new s("gears",14))).corner=12,t.color=g[0],t.highlightColor=g[1],t.pressColor=g[2],t.labelMinExtent=new o.E9(36,18),t.padding=0,t.labelShadowOffset=new o.E9(-1,-1),t.labelShadowColor=g[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.fixLayout(),l=t,this.controlBar.add(l),this.controlBar.settingsButton=l,(t=new rt(null,this,"cloudMenu",[new s("cloudOutline",11),new s("cloud",11)],(()=>!(0,o.kK)(this.cloud.username)))).hasNeutralBackground=!0,t.corner=12,t.color=g[0],t.highlightColor=g[1],t.pressColor=g[0],t.labelMinExtent=new o.E9(36,18),t.padding=0,t.labelShadowOffset=new o.E9(-1,-1),t.labelShadowColor=g[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.fixLayout(),t.refresh(),u=t,this.controlBar.add(u),this.controlBar.cloudButton=u,this.controlBar.fixLayout=function(){f=this.right()-5,[i,r,n].forEach((t=>{t.setCenter(y.controlBar.center()),t.setRight(f),f-=t.width(),f-=5})),f=Math.min(n.left()-(15+2*p.width()),y.right()-b.prototype.dimensions.x*(y.isSmallStage?y.stageRatio:1)),[p,c].forEach((t=>{f+=5,t.setCenter(y.controlBar.center()),t.setLeft(f),f+=t.width()})),e.setCenter(y.controlBar.center()),e.setRight(p.left()-5),d.setCenter(y.controlBar.center()),d.setRight(e.left()-5),l.setCenter(y.controlBar.center()),l.setLeft(this.left()),h.setCenter(y.controlBar.center()),y.cloud.disabled?(u.hide(),h.setRight(l.left()-5)):(u.setCenter(y.controlBar.center()),u.setRight(l.left()-5),h.setRight(u.left()-5)),this.refreshSlider(),this.updateLabel()},this.controlBar.refreshSlider=function(){a.prototype.enableSingleStepping&&!y.isAppMode?(e.fixLayout(),e.rerender(),e.show()):e.hide(),this.refreshResumeSymbol()},this.controlBar.refreshResumeSymbol=function(){var t;a.prototype.enableSingleStepping&&a.prototype.flashTime>.5?(y.stage.threads.pauseAll(y.stage),t=[new s("pause",12),new s("stepForward",14)]):t=[new s("pause",12),new s("pointRight",14)],r.labelString=t,r.createLabel(),r.fixLayout(),r.refresh()},this.controlBar.updateLabel=function(){var t,e=y.world().isDevMode?" - "+(0,o.NC)("development mode"):"";this.label&&this.label.destroy(),y.isAppMode||((t=new o.XC((y.projectName||(0,o.NC)("untitled"))+e,14,"sans-serif",!0,!1,!1,o.tU.isFlat?null:new o.E9(2,1),y.frameColor.darker(y.buttonContrast))).color=y.buttonLabelColor,this.label=new o.xZ,this.label.acceptsDrops=!1,this.label.alpha=0,t.setPosition(this.label.position()),this.label.add(t),this.label.setExtent(new o.E9(d.left()-l.right()-10,t.height())),this.label.setCenter(this.center()),this.label.setLeft(this.settingsButton.right()+5),this.add(this.label))}},Kt.prototype.changeCategory=function(t){this.currentCategory=t,this.categories.children.forEach((function(t){t.refresh()})),this.refreshPalette(!0)},Kt.prototype.createCategories=function(){var t,e,i,s,r,n,a,h,l,p=this;this.categories&&this.categories.destroy(),this.categories=new o._V,this.categories.color=this.groupColor,this.categories.bounds.setWidth(this.paletteWidth),y.prototype.categories.forEach((t=>{var e,i,s;(0,o.r3)(["lists","other"],t)||(e=t,(i=new rt(s=[p.frameColor,p.frameColor.darker(o.tU.isFlat?5:50),y.prototype.blockColor[e]],p,(()=>{p.currentCategory=e,p.categories.children.forEach((t=>t.refresh())),p.refreshPalette(!0)}),e[0].toUpperCase().concat(e.slice(1)),(()=>p.currentCategory===e),null,null,75,!0)).corner=8,i.padding=0,i.labelShadowOffset=new o.E9(-1,-1),i.labelShadowColor=s[1],i.labelColor=p.buttonLabelColor,o.tU.isFlat&&(i.labelPressColor=o.Cj),i.fixLayout(),i.refresh(),p.categories.add(i))})),i=p.categories.children[0].width(),s=p.categories.children[0].height(),r=Math.ceil(p.categories.children.length/2),n=(197-2*i)/3,a=p.categories.left(),h=p.categories.top(),l=0,p.categories.children.forEach((r=>{l+=1,t=Math.ceil(l/2),e=2-l%2,r.setPosition(new o.E9(a+(e*n+(e-1)*i),h+(2*t+(t-1)*s+3)))})),p.categories.setHeight(2*(r+1)+r*s+6),this.add(this.categories)},Kt.prototype.createPalette=function(t){return this.palette&&this.palette.destroy(),this.palette=t?new o.yR(null,null,this.currentSprite.sliderColor):this.currentSprite.palette(this.currentCategory),this.palette.isDraggable=!1,this.palette.acceptsDrops=!0,this.palette.enableAutoScrolling=!1,this.palette.contents.acceptsDrops=!1,this.palette.reactToDropOf=(t,e)=>{t instanceof lt?this.world().add(t):t instanceof y?this.removeSprite(t):t instanceof Qt?(t.destroy(),this.removeSprite(t.object)):t instanceof te?(this.currentSprite.wearCostume(null),t.perish()):t instanceof A?(this.stage.threads.stopAllForBlock(t),e&&e.grabOrigin.origin instanceof N&&(e.grabOrigin.origin.clearDropInfo(),e.grabOrigin.origin.lastDroppedBlock=t,e.grabOrigin.origin.recordDrop(e.grabOrigin)),t.perish()):t.perish()},this.palette.contents.reactToDropOf=t=>{t instanceof A&&t.destroy()},this.palette.setWidth(this.logo.width()),this.add(this.palette),this.palette},Kt.prototype.createPaletteHandle=function(){this.paletteHandle&&this.paletteHandle.destroy(),this.paletteHandle=new ne(this.categories),this.add(this.paletteHandle)},Kt.prototype.createStage=function(){this.stage&&this.stage.destroy(),b.prototype.frameRate=0,this.stage=new b(this.globalVariables),this.stage.setExtent(this.stage.dimensions),this.currentSprite instanceof y&&(this.currentSprite.setPosition(this.stage.center().subtract(this.currentSprite.extent().divideBy(2))),this.stage.add(this.currentSprite)),this.add(this.stage)},Kt.prototype.createStageHandle=function(){this.stageHandle&&this.stageHandle.destroy(),this.stageHandle=new re(this.stage),this.add(this.stageHandle)},Kt.prototype.createSpriteBar=function(){var t,e,i,r,n=[],a=new o.E9(45,45),h=this.tabColors,l=new pt("row",-30),p=[new s("arrowRightThin",10),new s("turnAround",10),new s("arrowLeftRightThin",10)],c=["don't rotate","can rotate","only face left/right"],d=this;function u(t){var e,i=d.rotationStyleColors;return(e=new rt(i,d,(()=>{d.currentSprite instanceof y&&(d.currentSprite.rotationStyle=t,d.currentSprite.changed(),d.currentSprite.fixLayout(),d.currentSprite.rerender()),n.forEach((t=>t.refresh()))}),p[t],(()=>d.currentSprite instanceof y&&d.currentSprite.rotationStyle===t),null,(0,o.NC)(c[t]))).corner=8,e.labelMinExtent=new o.E9(11,11),e.padding=0,e.labelShadowOffset=new o.E9(-1,-1),e.labelShadowColor=i[1],e.labelColor=d.buttonLabelColor,e.fixLayout(),e.refresh(),n.push(e),e.setPosition(d.spriteBar.position().add(new o.E9(2,4))),e.setTop(e.top()+(n.length-1)*(e.height()+2)),d.spriteBar.add(e),d.currentSprite instanceof b&&e.hide(),e}this.spriteBar&&this.spriteBar.destroy(),this.spriteBar=new o._V,this.spriteBar.color=this.frameColor,this.add(this.spriteBar),u(1),u(2),u(0),this.rotationStyleButtons=n,(i=new o._V).isCachingImage=!0,i.bounds.setExtent(a),i.cachedImage=this.currentSprite.thumbnail(a),i.setPosition(n[0].topRight().add(new o.E9(5,3))),this.spriteBar.add(i),i.fps=3,i.step=function(){i.version!==d.currentSprite.version&&(i.cachedImage=d.currentSprite.thumbnail(a,i.cachedImage),i.changed(),i.version=d.currentSprite.version)},(t=new ct(this.currentSprite.name)).setWidth(100),t.contrast=90,t.setPosition(i.topRight().add(new o.E9(10,3))),this.spriteBar.add(t),this.spriteBar.nameField=t,t.fixLayout(),t.accept=function(){var e=t.getValue();d.currentSprite.setName(d.newSpriteName(e,d.currentSprite)),t.setContents(d.currentSprite.name)},this.spriteBar.reactToEdit=t.accept,(e=new at("checkbox",null,(()=>{this.currentSprite.isDraggable=!this.currentSprite.isDraggable}),(0,o.NC)("draggable"),(()=>this.currentSprite.isDraggable))).label.isBold=!1,e.label.setColor(this.buttonLabelColor),e.color=h[2],e.highlightColor=h[0],e.pressColor=h[1],e.tick.shadowOffset=o.tU.isFlat?o.xE:new o.E9(-1,-1),e.tick.shadowColor=o.E5,e.tick.color=this.buttonLabelColor,e.tick.isBold=!1,e.tick.fixLayout(),e.setPosition(t.bottomLeft().add(2)),e.fixLayout(),this.spriteBar.add(e),this.currentSprite instanceof b&&e.hide(),l.tabTo=function(t){var e;d.currentTab=t,this.children.forEach((t=>{t.refresh(),t.state&&(e=t)})),e.refresh(),d.createSpriteEditor(),d.fixLayout("tabEditor")},(r=new nt(h,null,(()=>l.tabTo("scripts")),(0,o.NC)("Scripts"),(()=>"scripts"===this.currentTab))).padding=3,r.corner=15,r.edge=1,r.labelShadowOffset=new o.E9(-1,-1),r.labelShadowColor=h[1],r.labelColor=this.buttonLabelColor,r.getPressRenderColor=function(){return o.tU.isFlat||I.prototype.alpha>.85?this.pressColor:this.pressColor.mixed(Math.max(I.prototype.alpha-.15,0),y.prototype.paletteColor)},r.fixLayout(),l.add(r),(r=new nt(h,null,(()=>l.tabTo("costumes")),(0,o.NC)(this.currentSprite instanceof y?"Costumes":"Backgrounds"),(()=>"costumes"===this.currentTab))).padding=3,r.corner=15,r.edge=1,r.labelShadowOffset=new o.E9(-1,-1),r.labelShadowColor=h[1],r.labelColor=this.buttonLabelColor,r.fixLayout(),l.add(r),(r=new nt(h,null,(()=>l.tabTo("sounds")),(0,o.NC)("Sounds"),(()=>"sounds"===this.currentTab))).padding=3,r.corner=15,r.edge=1,r.labelShadowOffset=new o.E9(-1,-1),r.labelShadowColor=h[1],r.labelColor=this.buttonLabelColor,r.fixLayout(),l.add(r),l.fixLayout(),l.children.forEach((t=>t.refresh())),this.spriteBar.tabBar=l,this.spriteBar.add(this.spriteBar.tabBar),this.spriteBar.fixLayout=function(){this.tabBar.setLeft(this.left()),this.tabBar.setBottom(this.bottom()+d.padding)}},Kt.prototype.createSpriteEditor=function(){var t=this.currentSprite.scripts;this.spriteEditor&&this.spriteEditor.destroy(),"scripts"===this.currentTab?(t.isDraggable=!1,t.color=this.groupColor,t.cachedTexture=this.scriptsPaneTexture,this.spriteEditor=new o.yR(t,null,this.sliderColor),this.spriteEditor.color=this.groupColor,this.spriteEditor.padding=10,this.spriteEditor.growth=50,this.spriteEditor.isDraggable=!1,this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!0,t.scrollFrame=this.spriteEditor,t.updateToolbar(),this.add(this.spriteEditor),this.spriteEditor.scrollX(this.spriteEditor.padding),this.spriteEditor.scrollY(this.spriteEditor.padding)):"costumes"===this.currentTab?(this.spriteEditor=new oe(this.currentSprite,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!1,this.spriteEditor.contents.mouseEnterDragging=t=>{t instanceof A&&this.spriteBar.tabBar.tabTo("scripts")}):"sounds"===this.currentTab?(this.spriteEditor=new se(this.currentSprite,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptDrops=!1,this.spriteEditor.contents.acceptsDrops=!1,this.spriteEditor.contents.mouseEnterDragging=t=>{t instanceof A&&this.spriteBar.tabBar.tabTo("scripts")}):(this.spriteEditor=new o._V,this.spriteEditor.color=this.groupColor,this.spriteEditor.acceptsDrops=!0,this.spriteEditor.reactToDropOf=t=>{t instanceof lt?this.world().add(t):t instanceof y?this.removeSprite(t):t.destroy()},this.add(this.spriteEditor))},Kt.prototype.createCorralBar=function(){var t,e,i,r=o.tU.isFlat?this.tabColors:[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)];this.corralBar&&this.corralBar.destroy(),this.corralBar=new o._V,this.corralBar.color=this.frameColor,this.corralBar.setHeight(this.logo.height()),this.add(this.corralBar),(t=new st(this,"addNewSprite",new s("turtle",14))).corner=12,t.color=r[0],t.highlightColor=r[1],t.pressColor=r[2],t.labelMinExtent=new o.E9(36,18),t.padding=0,t.labelShadowOffset=new o.E9(-1,-1),t.labelShadowColor=r[1],t.labelColor=this.buttonLabelColor,t.contrast=this.buttonContrast,t.hint="add a new Turtle sprite",t.fixLayout(),t.setCenter(this.corralBar.center()),t.setLeft(this.corralBar.left()+5),this.corralBar.add(t),(e=new st(this,"paintNewSprite",new s("brush",15))).corner=12,e.color=r[0],e.highlightColor=r[1],e.pressColor=r[2],e.labelMinExtent=new o.E9(36,18),e.padding=0,e.labelShadowOffset=new o.E9(-1,-1),e.labelShadowColor=r[1],e.labelColor=this.buttonLabelColor,e.contrast=this.buttonContrast,e.hint="paint a new sprite",e.fixLayout(),e.setCenter(this.corralBar.center()),e.setLeft(this.corralBar.left()+5+t.width()+5),this.corralBar.add(e),ae.prototype.enableCamera&&((i=new st(this,"newCamSprite",new s("camera",15))).corner=12,i.color=r[0],i.highlightColor=r[1],i.pressColor=r[2],i.labelMinExtent=new o.E9(36,18),i.padding=0,i.labelShadowOffset=new o.E9(-1,-1),i.labelShadowColor=r[1],i.labelColor=this.buttonLabelColor,i.contrast=this.buttonContrast,i.hint="take a camera snapshot and\nimport it as a new sprite",i.fixLayout(),i.setCenter(this.corralBar.center()),i.setLeft(this.corralBar.left()+5+t.width()+5+e.width()+5),this.corralBar.add(i),document.addEventListener("cameraDisabled",(t=>{i.disable(),i.hint=ae.prototype.notSupportedMessage})))},Kt.prototype.createCorral=function(){var t,e=this;this.createStageHandle(),this.createPaletteHandle(),this.corral&&this.corral.destroy(),this.corral=new o._V,this.corral.color=this.groupColor,this.corral.getRenderColor=N.prototype.getRenderColor,this.add(this.corral),this.corral.stageIcon=new Qt(this.stage),this.corral.stageIcon.isDraggable=!1,this.corral.add(this.corral.stageIcon),(t=new o.yR(null,null,this.sliderColor)).acceptsDrops=!1,t.contents.acceptsDrops=!1,t.contents.wantsDropOf=t=>t instanceof Qt,t.contents.reactToDropOf=t=>this.corral.reactToDropOf(t),t.alpha=0,this.sprites.asArray().forEach((e=>{e.isTemporary||t.contents.add(new Qt(e))})),this.corral.frame=t,this.corral.add(t),this.corral.fixLayout=function(){this.stageIcon.setCenter(this.center()),this.stageIcon.setLeft(this.left()+5),this.frame.setLeft(this.stageIcon.right()+5),this.frame.setExtent(new o.E9(this.right()-this.frame.left(),this.height())),this.arrangeIcons(),this.refresh()},this.corral.arrangeIcons=function(){var t=this.frame.left(),e=this.frame.top(),i=this.frame.right(),s=this.frame.left();this.frame.contents.children.forEach((r=>{var n=r.width();t+n>i&&(t=s,e+=r.height()),r.setPosition(new o.E9(t,e)),t+=n})),this.frame.contents.adjustBounds()},this.corral.addSprite=function(t){this.frame.contents.add(new Qt(t)),this.fixLayout()},this.corral.refresh=function(){this.stageIcon.refresh(),this.frame.contents.children.forEach((t=>t.refresh()))},this.corral.wantsDropOf=t=>t instanceof Qt,this.corral.reactToDropOf=function(t){var o=1,i=t.position();t.destroy(),this.frame.contents.children.forEach((t=>{(i.gt(t.position())||i.y>t.bottom())&&(o+=1)})),e.sprites.add(t.object,o),e.createCorral(),e.fixLayout()}},Kt.prototype.fixLayout=function(t){var e,i,s=this.padding;"refreshPalette"!==t&&(this.controlBar.setPosition(this.logo.topRight()),this.controlBar.setWidth(this.right()-this.controlBar.left()),this.controlBar.fixLayout(),this.categories.setLeft(this.logo.left()),this.categories.setTop(this.logo.bottom()),this.categories.setWidth(this.paletteWidth)),this.palette.setLeft(this.logo.left()),this.palette.setTop(this.categories.bottom()),this.palette.setHeight(this.bottom()-this.palette.top()),this.palette.setWidth(this.paletteWidth),"refreshPalette"!==t&&(this.isEmbedMode?(this.stage.setScale(Math.floor(100*Math.min(this.width()/this.stage.dimensions.x,this.height()/this.stage.dimensions.y))/100),(e=this.embedPlayButton.flag).size=Math.floor(Math.min(this.width(),this.height()))/5,e.fixLayout(),this.embedPlayButton.size=1.6*e.size,this.embedPlayButton.fixLayout(),this.embedOverlay&&this.embedOverlay.setExtent(this.extent()),this.stage.setCenter(this.center()),this.embedPlayButton.setCenter(this.stage.center()),e.setCenter(this.embedPlayButton.center()),e.setLeft(e.left()+.1*e.size)):this.isAppMode?(this.stage.setScale(Math.floor(10*Math.min((this.width()-2*s)/this.stage.dimensions.x,(this.height()-2*this.controlBar.height()-2*s)/this.stage.dimensions.y))/10),this.stage.setCenter(this.center())):(this.stage.setScale(this.isSmallStage?this.stageRatio:1),this.stage.setTop(this.logo.bottom()+s),this.stage.setRight(this.right()),i=Math.max(200,this.width()-this.stage.width()-this.spriteBar.tabBar.width()-2*this.padding),this.paletteWidth>i&&(this.paletteWidth=i,this.fixLayout()),this.stageHandle.fixLayout(),this.paletteHandle.fixLayout()),this.spriteBar.setLeft(this.paletteWidth+s),this.spriteBar.setTop(this.logo.bottom()+s),this.spriteBar.setExtent(new o.E9(Math.max(0,this.stage.left()-s-this.spriteBar.left()),this.categories.bottom()-this.spriteBar.top()-s-8)),this.spriteBar.fixLayout(),this.spriteEditor.isVisible&&(this.spriteEditor.setPosition(new o.E9(this.spriteBar.left(),this.spriteBar.bottom()+s)),this.spriteEditor.setExtent(new o.E9(this.spriteBar.width(),this.bottom()-this.spriteEditor.top()))),this.corralBar.setLeft(this.stage.left()),this.corralBar.setTop(this.stage.bottom()+s),this.corralBar.setWidth(this.stage.width()),(0,o.r3)(["selectSprite","tabEditor"],t)||(this.corral.setPosition(this.corralBar.bottomLeft()),this.corral.setWidth(this.stage.width()),this.corral.setHeight(this.bottom()-this.corral.top()),this.corral.fixLayout()))},Kt.prototype.setProjectName=function(t){this.projectName=t.replace(/['"]/g,""),this.hasChangedMedia=!0,this.controlBar.updateLabel()},Kt.prototype.getProjectData=function(){return this.projectData},Kt.prototype.setProjectData=function(t){if(t&&t.length)try{var e=JSON.parse(t);e&&(this.projectData=e)}catch(e){console.log("Error parsing project data: "+t),console.error(e)}else this.projectData={}},Kt.prototype.setExtent=function(t){var e,i,s,r,n,a,h,l=new o.E9(430,110);e=this.isAppMode?this.isEmbedMode?new o.E9(100,100):b.prototype.dimensions.add(this.controlBar.height()+10):this.stageRatio>1?l.add(b.prototype.dimensions):l.add(b.prototype.dimensions.multiplyBy(this.stageRatio)),s=(i=t.max(e)).x-(200+this.spriteBar.tabBar.width()+2*this.padding),r=3*Qt.prototype.thumbSize.x,n=i.y-3.5*Qt.prototype.thumbSize.y,a=r/this.stage.dimensions.x,h=Math.min(s/this.stage.dimensions.x,n/this.stage.dimensions.y),this.stageRatio=Math.min(h,Math.max(a,this.stageRatio)),Kt.uber.setExtent.call(this,i),this.fixLayout()},Kt.prototype.render=function(t){var e;Kt.uber.render.call(this,t),this.isAppMode&&this.stage&&(e=this.stage.bounds.translateBy(this.position().neg()).expandBy(2),t.strokeStyle=(o.tU.isFlat?this.backgroundColor:this.groupColor).toString(),t.lineWidth=1,t.beginPath(),t.moveTo(e.origin.x,e.origin.y),t.lineTo(e.corner.x,e.origin.y),t.lineTo(e.corner.x,e.corner.y),t.lineTo(e.origin.x,e.corner.y),t.closePath(),t.stroke())},Kt.prototype.reactToWorldResize=function(t){this.isAutoFill&&(this.setPosition(t.origin),this.setExtent(t.extent())),this.filePicker&&(document.body.removeChild(this.filePicker),this.filePicker=null)},Kt.prototype.droppedImage=function(t,e){var o=new C(t,this.currentSprite.newCostumeName(e?e.split(".")[0]:""));o.isTainted()?this.inform("Unable to import this image","The picture you wish to import has been\ntainted by a restrictive cross-origin policy\nmaking it unusable for costumes in Snap!. \n\nTry downloading this picture first to your\ncomputer, and import it from there."):(this.currentSprite.addCostume(o),this.currentSprite.wearCostume(o),this.spriteBar.tabBar.tabTo("costumes"),this.hasChangedMedia=!0)},Kt.prototype.droppedSVG=function(t,e){var o=new S(t,e.split(".")[0]);this.currentSprite.addCostume(o),this.currentSprite.wearCostume(o),this.spriteBar.tabBar.tabTo("costumes"),this.hasChangedMedia=!0},Kt.prototype.droppedAudio=function(t,e){0!==t.src.indexOf("data:audio")?this.getURL(t.src,(o=>{var i=new window.FileReader;i.readAsDataURL(o),i.onloadend=()=>{var o=i.result;o="data:audio/ogg;base64,"+o.split(",")[1],t.src=o,this.droppedAudio(t,e)}}),"blob"):(this.currentSprite.addSound(t,e.split(".")[0]),this.spriteBar.tabBar.tabTo("sounds"),this.hasChangedMedia=!0)},Kt.prototype.droppedText=function(t,e,o){var i=e?e.split(".")[0]:"",s=e?e.slice(e.lastIndexOf(".")+1).toLowerCase():"";return 0===t.indexOf("<project")?(location.hash="",this.openProjectString(t)):0===t.indexOf("<snapdata")?(location.hash="",this.openCloudDataString(t)):0===t.indexOf("<blocks")?this.openBlocksString(t,i,!0):0===t.indexOf("<sprites")?this.openSpritesString(t):0===t.indexOf("<media")?this.openMediaString(t):0===t.indexOf("<script")?this.openScriptString(t):-1!==o.indexOf("csv")||"csv"===s?this.openDataString(t,i,"csv"):-1!==o.indexOf("json")||"json"===s?this.openDataString(t,i,"json"):void this.openDataString(t,i,"text")},Kt.prototype.droppedBinary=function(t,e){var o=document.getElementById("ypr"),s=this;function r(t,e){var o=new i.Reader,r=e.split(".")[0];o.onload=function(t){s.droppedText((new i.XMLWriter).write(r,t))},o.readYPR(new Uint8Array(t))}"ypr"===e.substring(e.length-3).toLowerCase()&&(o?r(t,e):((o=document.createElement("script")).id="ypr",o.onload=function(){r(t,e)},document.head.appendChild(o),o.src=this.resourceURL("src","ypr.js")))},Kt.prototype.refreshPalette=function(t){var e=this.palette.contents.top();this.createPalette(),this.isAppMode?this.palette.hide():(this.fixLayout("refreshPalette"),t||this.palette.contents.setTop(e))},Kt.prototype.pressStart=function(){16===this.world().currentKey?this.toggleFastTracking():(this.stage.threads.pauseCustomHatBlocks=!1,this.controlBar.stopButton.refresh(),this.runScripts())},Kt.prototype.toggleFastTracking=function(){this.stage.isFastTracked?this.stopFastTracking():this.startFastTracking()},Kt.prototype.toggleVariableFrameRate=function(){b.prototype.frameRate?(b.prototype.frameRate=0,this.stage.fps=0):(b.prototype.frameRate=30,this.stage.fps=30)},Kt.prototype.toggleSingleStepping=function(){this.stage.threads.toggleSingleStepping(),this.controlBar.steppingButton.refresh(),this.controlBar.refreshSlider()},Kt.prototype.toggleCameraSupport=function(){ae.prototype.enableCamera=!ae.prototype.enableCamera,this.spriteBar.tabBar.tabTo(this.currentTab),this.createCorralBar(),this.fixLayout()},Kt.prototype.startFastTracking=function(){this.stage.isFastTracked=!0,this.stage.fps=0,this.controlBar.startButton.labelString=new s("flash",14),this.controlBar.startButton.createLabel(),this.controlBar.startButton.fixLayout(),this.controlBar.startButton.rerender()},Kt.prototype.stopFastTracking=function(){this.stage.isFastTracked=!1,this.stage.fps=this.stage.frameRate,this.controlBar.startButton.labelString=new s("flag",14),this.controlBar.startButton.createLabel(),this.controlBar.startButton.fixLayout(),this.controlBar.startButton.rerender()},Kt.prototype.runScripts=function(){this.stage.threads.pauseCustomHatBlocks&&(this.stage.threads.pauseCustomHatBlocks=!1,this.controlBar.stopButton.refresh()),this.stage.fireGreenFlagEvent()},Kt.prototype.togglePauseResume=function(){this.stage.threads.isPaused()?this.stage.threads.resumeAll(this.stage):this.stage.threads.pauseAll(this.stage),this.controlBar.pauseButton.refresh()},Kt.prototype.isPaused=function(){return!!this.stage&&this.stage.threads.isPaused()},Kt.prototype.stopAllScripts=function(){this.stage.enableCustomHatBlocks?this.stage.threads.pauseCustomHatBlocks=!this.stage.threads.pauseCustomHatBlocks:this.stage.threads.pauseCustomHatBlocks=!1,this.controlBar.stopButton.refresh(),this.stage.fireStopAllEvent()},Kt.prototype.selectSprite=function(t){(0,o.qY)(this.world().children,(t=>t instanceof $t||t instanceof bt))||(this.currentSprite&&this.currentSprite.scripts.focus&&this.currentSprite.scripts.focus.stopEditing(),this.currentSprite=t,this.createPalette(),this.createSpriteBar(),this.createSpriteEditor(),this.corral.refresh(),this.fixLayout("selectSprite"),this.currentSprite.scripts.fixMultiArgs())},Kt.prototype.toggleRetina=function(){(0,o.Sg)()?(0,o.bw)():(0,o.Ck)(),this.world().fillPage(),o.tU.isFlat||(Kt.prototype.scriptsPaneTexture=this.scriptsTexture()),this.stage.clearPenTrails(),this.refreshIDE()},Kt.prototype.defaultDesign=function(){this.setDefaultDesign(),this.refreshIDE(),this.removeSetting("design")},Kt.prototype.flatDesign=function(){this.setFlatDesign(),this.refreshIDE(),this.saveSetting("design","flat")},Kt.prototype.refreshIDE=function(){var t;if(a.prototype.isCatchingErrors)try{t=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else t=this.serializer.serialize(this.stage);y.prototype.initBlocks(),this.buildPanes(),this.fixLayout(),this.loadNewProject?this.newProject():this.openProjectString(t)},Kt.prototype.applySavedSettings=function(){var t=this.getSetting("design"),e=this.getSetting("zoom"),i=this.getSetting("fade"),s=this.getSetting("language"),r=this.getSetting("click"),n=this.getSetting("longform"),a=this.getSetting("longurls"),h=this.getSetting("plainprototype"),l=this.getSetting("keyboard"),p=this.getSetting("tables"),c=this.getSetting("tableLines"),u=this.getSetting("autowrapping"),f=this.getSetting("solidshadow");"flat"===t?this.setFlatDesign():this.setDefaultDesign(),e&&(I.prototype.setScale(Math.min(e,12)),ot.prototype.refreshScale(),y.prototype.initBlocks()),(0,o.kK)(i)||this.setBlockTransparency(+i),this.userLanguage=s&&"en"!==s?s:null,r&&!A.prototype.snapSound&&A.prototype.toggleSnapSound(),n&&(kt.prototype.isLaunchingExpanded=!0),this.projectsInURLs=!!a,N.prototype.enableKeyboard="false"!==l,d.prototype.enableTables="false"!==p,Lt.prototype.highContrast=!!c,N.prototype.enableNestedAutoWrapping="false"!==u,h&&(vt.prototype.plainLabel=!0),f&&(window.useBlurredShadows=!1,this.rerender())},Kt.prototype.saveSetting=function(t,e){this.savingPreferences&&this.hasLocalStorage()&&(localStorage["-snap-setting-"+t]=e)},Kt.prototype.getSetting=function(t){return this.hasLocalStorage()?localStorage["-snap-setting-"+t]:null},Kt.prototype.removeSetting=function(t){this.hasLocalStorage()&&delete localStorage["-snap-setting-"+t]},Kt.prototype.hasLocalStorage=function(){try{return!(0,o.kK)(localStorage)}catch(t){return!1}},Kt.prototype.addNewSprite=function(){var t=new y(this.globalVariables),e=a.prototype.reportBasicRandom;t.name=this.newSpriteName(t.name),t.setCenter(this.stage.center()),this.stage.add(t),t.fixLayout(),t.rerender(),t.setColorComponentHSVA(0,e.call(this,0,100)),t.setColorComponentHSVA(1,100),t.setColorComponentHSVA(2,e.call(this,50,100)),t.setXPosition(e.call(this,-220,220)),t.setYPosition(e.call(this,-160,160)),16===this.world().currentKey&&t.turn(e.call(this,1,360)),this.sprites.add(t),this.corral.addSprite(t),this.selectSprite(t)},Kt.prototype.paintNewSprite=function(){var t=new y(this.globalVariables),e=new C;t.name=this.newSpriteName(t.name),t.setCenter(this.stage.center()),this.stage.add(t),this.sprites.add(t),this.corral.addSprite(t),this.selectSprite(t),e.edit(this.world(),this,!0,(()=>this.removeSprite(t)),(()=>{t.addCostume(e),t.wearCostume(e)}))},Kt.prototype.newCamSprite=function(){var t=new y(this.globalVariables);t.name=this.newSpriteName(t.name),t.setCenter(this.stage.center()),this.stage.add(t),this.sprites.add(t),this.corral.addSprite(t),this.selectSprite(t),new ae(this,t,(()=>this.removeSprite(t)),(function(e){t.addCostume(e),t.wearCostume(e),this.close()})).popUp(this.world())},Kt.prototype.recordNewSound=function(){var t;(t=new he((t=>{var e;t&&(e=this.currentSprite.addSound(t,this.newSoundName("recording")),this.makeSureRecordingIsMono(e),this.spriteBar.tabBar.tabTo("sounds"),this.hasChangedMedia=!0)}))).key="microphone",t.popUp(this.world())},Kt.prototype.makeSureRecordingIsMono=function(t){function e(t,e){var o,i,s=k.prototype.getAudioContext(),r=t.length,n=s.createBuffer(1,r,+e||44100);return n.copyToChannel||(n.copyToChannel=function(t,e){var i=this.getChannelData(e);for(o=0;o<t.length;o+=1)i[o]=t[o]}),n.copyToChannel(Float32Array.from(t),0,0),(i=s.createBufferSource()).buffer=n,i.audioBuffer=i.buffer,i}!function(t,e){var o,i,s,r,n,a,h;if(t.audioBuffer)return e(t);for(o=t.audio.src.split(",")[1],s=(i=window.atob(o)).length,r=new Uint8Array(s),n=0;n<s;n+=1)r[n]=i.charCodeAt(n);a=r.buffer,h=k.prototype.getAudioContext(),t.isDecoding=!0,h.decodeAudioData(a,(o=>(t.audioBuffer=o,e(t))),(t=>{throw t}))}(t,(function(t){var o,i,s,r,n,a,h,l,p;1!==t.audioBuffer.numberOfChannels&&(o=t.audioBuffer.getChannelData(0),i=new Audio,s=new Blob([(n=e(o,44100).audioBuffer,h=n.sampleRate,l=(a||{}).float32?3:1,p=3===l?32:16,function(t,e,o,i,s){var r=s/8,n=1*r,a=new ArrayBuffer(44+t.length*r),h=new DataView(a);function l(t,e,o){for(var i=0;i<o.length;i+=1)t.setUint8(e+i,o.charCodeAt(i))}return l(h,0,"RIFF"),h.setUint32(4,36+t.length*r,!0),l(h,8,"WAVE"),l(h,12,"fmt "),h.setUint32(16,16,!0),h.setUint16(20,e,!0),h.setUint16(22,1,!0),h.setUint32(24,o,!0),h.setUint32(28,o*n,!0),h.setUint16(32,n,!0),h.setUint16(34,s,!0),l(h,36,"data"),h.setUint32(40,t.length*r,!0),1===e?function(t,e,o){var i,s;for(i=0;i<o.length;i+=1,e+=2)s=Math.max(-1,Math.min(1,o[i])),t.setInt16(e,s<0?32768*s:32767*s,!0)}(h,44,t):function(t,e,o){for(var i=0;i<o.length;i+=1,e+=4)t.setFloat32(e,o[i],!0)}(h,44,t),a}(n.getChannelData(0),l,h,0,p))],{type:"audio/wav"}),(r=new FileReader).onload=()=>{i.src=r.result,t.audio=i,t.audioBuffer=null,t.cachedSamples=null,t.isDecoding=!1},r.readAsDataURL(s))}))},Kt.prototype.duplicateSprite=function(t){var e=t.fullCopy();e.isDown=!1,e.setPosition(this.world().hand.position()),e.appearIn(this),e.keepWithin(this.stage),e.isDown=t.isDown,this.selectSprite(e)},Kt.prototype.instantiateSprite=function(t){var e=t.fullCopy(!0),o=e.allHatBlocksFor("__clone__init__");e.isDown=!1,e.appearIn(this),o.length?e.initClone(o):(e.setPosition(this.world().hand.position()),e.keepWithin(this.stage)),e.isDown=t.isDown,this.selectSprite(e)},Kt.prototype.removeSprite=function(t){var e;t.parts.slice().forEach((t=>this.removeSprite(t))),e=this.sprites.asArray().indexOf(t)+1,this.stage.threads.stopAllForReceiver(t),t.corpsify(),t.destroy(),this.stage.watchers().forEach((e=>{e.object()===t&&e.destroy()})),e>0&&this.sprites.remove(e),this.createCorral(),this.fixLayout(),this.currentSprite=(0,o.qY)(this.stage.children,(t=>t instanceof y&&!t.isTemporary))||this.stage,this.selectSprite(this.currentSprite)},Kt.prototype.newSoundName=function(t){var e=this.currentSprite.sounds.at(this.currentSprite.sounds.length());return this.newName(t||e.name,this.currentSprite.sounds.asArray().map((t=>t.name)))},Kt.prototype.newSpriteName=function(t,e){var o=this.sprites.asArray().concat(this.stage).filter((t=>t!==e)).map((t=>t.name));return this.newName(t,o)},Kt.prototype.newName=function(t,e){for(var i=t.indexOf("("),s=i<0?t:t.substring(0,i),r=1,n=s;(0,o.r3)(e,n);)n=s+"("+(r+=1)+")";return n},Kt.prototype.removeBlock=function(t,e){this.stage.threads.stopAllForBlock(t),t.destroy(e)},Kt.prototype.userMenu=function(){return new o.wR(this)},Kt.prototype.snapMenu=function(){var t,e=this.world();(t=new o.wR(this)).addItem("About...","aboutSnap"),t.addLine(),t.addItem("Reference manual",(()=>{var t=this.resourceURL("help","SnapManual.pdf");window.open(t,"SnapReferenceManual")})),t.addItem("Snap! website",(()=>window.open("https://snap.berkeley.edu/","SnapWebsite"))),t.addItem("Download source",(()=>window.open("https://github.com/jmoenig/Snap/releases/latest","SnapSource"))),e.isDevMode?(t.addLine(),t.addItem("Switch back to user mode","switchToUserMode","disable deep-Morphic\ncontext menus\nand show user-friendly ones",new o.Il(0,100,0))):16===e.currentKey&&(t.addLine(),t.addItem("Switch to dev mode","switchToDevMode","enable Morphic\ncontext menus\nand inspectors,\nnot user-friendly!",new o.Il(100,0,0))),t.popup(e,this.logo.bottomLeft())},Kt.prototype.cloudMenu=function(){var t,e=this.world(),i=this.controlBar.cloudButton.bottomLeft(),s=16===e.currentKey;"file:"!==location.protocol||s?(t=new o.wR(this),s&&(t.addItem("url...","setCloudURL",null,new o.Il(100,0,0)),t.addLine()),this.cloud.username?(t.addItem((0,o.NC)("Logout")+" "+this.cloud.username,"logout"),t.addItem("Change Password...","changeCloudPassword")):(t.addItem("Login...","initializeCloud"),t.addItem("Signup...","createCloudAccount"),t.addItem("Reset Password...","resetCloudPassword"),t.addItem("Resend Verification Email...","resendVerification")),this.hasCloudProject()&&(t.addLine(),t.addItem("Open in Community Site",(()=>{var t=this.urlParameters();window.open(this.cloud.showProjectPath(t.Username,t.ProjectName),"_blank")}))),s&&(t.addLine(),t.addItem("export project media only...",(()=>{this.projectName?this.exportProjectMedia(this.projectName):this.prompt("Export Project As...",(t=>this.exportProjectMedia(t)),null,"exportProject")}),null,this.hasChangedMedia?new o.Il(100,0,0):new o.Il(0,100,0)),t.addItem("export project without media...",(()=>{this.projectName?this.exportProjectNoMedia(this.projectName):this.prompt("Export Project As...",(t=>this.exportProjectNoMedia(t)),null,"exportProject")}),null,new o.Il(100,0,0)),t.addItem("export project as cloud data...",(()=>{this.projectName?this.exportProjectAsCloudData(this.projectName):this.prompt("Export Project As...",(t=>this.exportProjectAsCloudData(t)),null,"exportProject")}),null,new o.Il(100,0,0)),t.addLine(),t.addItem("open shared project from cloud...",(()=>{this.prompt("Author name…",(t=>{this.prompt("Project name...",(e=>{this.showMessage("Fetching project\nfrom the cloud..."),this.cloud.getPublicProject(e,t.toLowerCase(),(t=>{var e;a.prototype.isCatchingErrors||window.open("data:text/xml,"+t),this.nextSteps([()=>{e=this.showMessage("Opening project...")},()=>{this.rawOpenCloudDataString(t),e.destroy()}])}),this.cloudError())}),null,"project")}),null,"project")}),null,new o.Il(100,0,0))),t.popup(e,i)):this.showMessage("cloud unavailable without a web server.")},Kt.prototype.settingsMenu=function(){var t,e=this.stage,i=this.world(),r=this.controlBar.settingsButton.bottomLeft(),n=16===i.currentKey,h=new s("checkedBox",.75*o.tU.menuFontSize),l=new s("rectangle",.75*o.tU.menuFontSize);function p(e,i,s,r,a,p){p&&!n||t.addItem([s?h:l,(0,o.NC)(e)],i,s?r:a,p?new o.Il(100,0,0):null)}(t=new o.wR(this)).addPair([new s("globe",o.tU.menuFontSize),(0,o.NC)("Language...")],"languageMenu"),t.addItem("Zoom blocks...","userSetBlocksScale"),t.addItem("Fade blocks...","userFadeBlocks"),t.addItem("Stage size...","userSetStageSize"),n&&t.addItem("Dragging threshold...","userSetDragThreshold","specify the distance the hand has to move\nbefore it picks up an object",new o.Il(100,0,0)),t.addItem("Microphone resolution...","microphoneMenu"),t.addLine(),(0,o.D8)()&&p("Retina display support","toggleRetina",(0,o.Sg)(),"uncheck for lower resolution,\nsaves computing resources","check for higher resolution,\nuses more computing resources",!0),p("Input sliders","toggleInputSliders",o.tU.useSliderForInput,"uncheck to disable\ninput sliders for\nentry fields","check to enable\ninput sliders for\nentry fields"),o.tU.useSliderForInput&&p("Execute on slider change","toggleSliderExecute",j.prototype.executeOnSliderEdit,"uncheck to suppress\nrunning scripts\nwhen moving the slider","check to run\nthe edited script\nwhen moving the slider"),p("Turbo mode","toggleFastTracking",this.stage.isFastTracked,"uncheck to run scripts\nat normal speed","check to prioritize\nscript execution"),p("Visible stepping","toggleSingleStepping",a.prototype.enableSingleStepping,"uncheck to turn off\nvisible stepping","check to turn on\n visible stepping (slow)",!1),p("Log pen vectors",(()=>b.prototype.enablePenLogging=!b.prototype.enablePenLogging),b.prototype.enablePenLogging,"uncheck to turn off\nlogging pen vectors","check to turn on\nlogging pen vectors",!1),p("Ternary Boolean slots",(()=>q.prototype.isTernary=!q.prototype.isTernary),q.prototype.isTernary,"uncheck to limit\nBoolean slots to true / false","check to allow\nempty Boolean slots",!0),p("Camera support","toggleCameraSupport",ae.prototype.enableCamera,"uncheck to disable\ncamera support","check to enable\ncamera support",!0),t.addLine(),p("Blurred shadows","toggleBlurredShadows",o.A3,"uncheck to use solid drop\nshadows and highlights","check to use blurred drop\nshadows and highlights",!0),p("Zebra coloring","toggleZebraColoring",A.prototype.zebraContrast,"uncheck to disable alternating\ncolors for nested block","check to enable alternating\ncolors for nested blocks",!0),p("Dynamic input labels","toggleDynamicInputLabels",I.prototype.dynamicInputLabels,"uncheck to disable dynamic\nlabels for variadic inputs","check to enable dynamic\nlabels for variadic inputs",!0),p("Prefer empty slot drops","togglePreferEmptySlotDrops",N.prototype.isPreferringEmptySlots,"uncheck to allow dropped\nreporters to kick out others","settings menu prefer empty slots hint",!0),p("Long form input dialog","toggleLongFormInputDialog",kt.prototype.isLaunchingExpanded,"uncheck to use the input\ndialog in short form","check to always show slot\ntypes in the input dialog"),p("Plain prototype labels","togglePlainPrototypeLabels",vt.prototype.plainLabel,"uncheck to always show (+) symbols\nin block prototype labels","check to hide (+) symbols\nin block prototype labels"),p("Virtual keyboard","toggleVirtualKeyboard",o.tU.useVirtualKeyboard,"uncheck to disable\nvirtual keyboard support\nfor mobile devices","check to enable\nvirtual keyboard support\nfor mobile devices",!0),p("Clicking sound",(()=>{A.prototype.toggleSnapSound(),A.prototype.snapSound?this.saveSetting("click",!0):this.removeSetting("click")}),A.prototype.snapSound,"uncheck to turn\nblock clicking\nsound off","check to turn\nblock clicking\nsound on"),p("Animations",(()=>this.isAnimating=!this.isAnimating),this.isAnimating,"uncheck to disable\nIDE animations","check to enable\nIDE animations",!0),p("Cache Inputs",(()=>{A.prototype.isCachingInputs=!A.prototype.isCachingInputs}),A.prototype.isCachingInputs,"uncheck to stop caching\ninputs (for debugging the evaluator)","check to cache inputs\nboosts recursion",!0),p("Rasterize SVGs",(()=>o.tU.rasterizeSVGs=!o.tU.rasterizeSVGs),o.tU.rasterizeSVGs,"uncheck for smooth\nscaling of vector costumes","check to rasterize\nSVGs on import",!0),p("Flat design",(()=>{if(o.tU.isFlat)return this.defaultDesign();this.flatDesign()}),o.tU.isFlat,"uncheck for default\nGUI design","check for alternative\nGUI design",!1),p("Nested auto-wrapping",(()=>{N.prototype.enableNestedAutoWrapping=!N.prototype.enableNestedAutoWrapping,N.prototype.enableNestedAutoWrapping?this.removeSetting("autowrapping"):this.saveSetting("autowrapping",!1)}),N.prototype.enableNestedAutoWrapping,"uncheck to confine auto-wrapping\nto top-level block stacks","check to enable auto-wrapping\ninside nested block stacks",!0),p("Project URLs",(()=>{this.projectsInURLs=!this.projectsInURLs,this.projectsInURLs?this.saveSetting("longurls",!0):this.removeSetting("longurls")}),this.projectsInURLs,"uncheck to disable\nproject data in URLs","check to enable\nproject data in URLs",!0),p("Sprite Nesting",(()=>y.prototype.enableNesting=!y.prototype.enableNesting),y.prototype.enableNesting,"uncheck to disable\nsprite composition","check to enable\nsprite composition",!0),p("First-Class Sprites",(()=>{y.prototype.enableFirstClass=!y.prototype.enableFirstClass,this.currentSprite.blocksCache.sensing=null,this.currentSprite.paletteCache.sensing=null,this.refreshPalette()}),y.prototype.enableFirstClass,"uncheck to disable support\nfor first-class sprites","check to enable support\n for first-class sprite",!0),p("Keyboard Editing",(()=>{N.prototype.enableKeyboard=!N.prototype.enableKeyboard,this.currentSprite.scripts.updateToolbar(),N.prototype.enableKeyboard?this.removeSetting("keyboard"):this.saveSetting("keyboard",!1)}),N.prototype.enableKeyboard,"uncheck to disable\nkeyboard editing support","check to enable\nkeyboard editing support",!0),p("Table support",(()=>{d.prototype.enableTables=!d.prototype.enableTables,d.prototype.enableTables?this.removeSetting("tables"):this.saveSetting("tables",!1)}),d.prototype.enableTables,"uncheck to disable\nmulti-column list views","check for multi-column\nlist view support",!0),d.prototype.enableTables&&p("Table lines",(()=>{Lt.prototype.highContrast=!Lt.prototype.highContrast,Lt.prototype.highContrast?this.saveSetting("tableLines",!0):this.removeSetting("tableLines")}),Lt.prototype.highContrast,"uncheck for less contrast\nmulti-column list views","check for higher contrast\ntable views",!0),p("Live coding support",(()=>a.prototype.enableLiveCoding=!a.prototype.enableLiveCoding),a.prototype.enableLiveCoding,"EXPERIMENTAL! uncheck to disable live\ncustom control structures","EXPERIMENTAL! check to enable\n live custom control structures",!0),p("JIT compiler support",(()=>{a.prototype.enableCompiling=!a.prototype.enableCompiling,this.currentSprite.blocksCache.operators=null,this.currentSprite.paletteCache.operators=null,this.refreshPalette()}),a.prototype.enableCompiling,"EXPERIMENTAL! uncheck to disable live\nsupport for compiling","EXPERIMENTAL! check to enable\nsupport for compiling",!0),t.addLine(),p("Thread safe scripts",(()=>e.isThreadSafe=!e.isThreadSafe),this.stage.isThreadSafe,"uncheck to allow\nscript reentrance","check to disallow\nscript reentrance"),p("Prefer smooth animations","toggleVariableFrameRate",b.prototype.frameRate,"uncheck for greater speed\nat variable frame rates","check for smooth, predictable\nanimations across computers",!0),p("Flat line ends",(()=>y.prototype.useFlatLineEnds=!y.prototype.useFlatLineEnds),y.prototype.useFlatLineEnds,"uncheck for round ends of lines","check for flat ends of lines"),p("Codification support",(()=>{b.prototype.enableCodeMapping=!b.prototype.enableCodeMapping,this.currentSprite.blocksCache.variables=null,this.currentSprite.paletteCache.variables=null,this.refreshPalette()}),b.prototype.enableCodeMapping,"uncheck to disable\nblock to text mapping features","check for block\nto text mapping features",!1),p("Inheritance support",(()=>{b.prototype.enableInheritance=!b.prototype.enableInheritance,this.currentSprite.blocksCache.variables=null,this.currentSprite.paletteCache.variables=null,this.refreshPalette()}),b.prototype.enableInheritance,"uncheck to disable\nsprite inheritance features","check for sprite\ninheritance features",!0),p("Hyper blocks support",(()=>a.prototype.enableHyperOps=!a.prototype.enableHyperOps),a.prototype.enableHyperOps,"uncheck to disable\nusing operators on lists and tables","check to enable\nusing operators on lists and tables",!1),p("Persist linked sublist IDs",(()=>b.prototype.enableSublistIDs=!b.prototype.enableSublistIDs),b.prototype.enableSublistIDs,"uncheck to disable\nsaving linked sublist identities","check to enable\nsaving linked sublist identities",!0),p("Enable command drops in all rings",(()=>et.prototype.enableCommandDrops=!et.prototype.enableCommandDrops),et.prototype.enableCommandDrops,"uncheck to disable\ndropping commands in reporter rings","check to enable\ndropping commands in all rings",!0),t.popup(i,r)},Kt.prototype.projectMenu=function(){var t,e=this.world(),i=this.controlBar.projectButton.bottomLeft(),s=this.currentSprite instanceof y?"Costumes":"Backgrounds",r=16===e.currentKey;(t=new o.wR(this)).addItem("Project notes...","editProjectNotes"),t.addLine(),t.addPair("New","createNewProject","^N"),t.addPair("Open...","openProjectsBrowser","^O"),t.addPair("Save","save","^S"),t.addItem("Save As...","saveProjectsBrowser"),t.addLine(),t.addItem("Import...","importLocalFile","file menu import hint"),r&&t.addItem((0,o.NC)("Export project...")+" "+(0,o.NC)("(in a new window)"),(()=>{this.projectName?this.exportProject(this.projectName,r):this.prompt("Export Project As...",(t=>this.exportProject(t,!1)),null,"exportProject")}),"show project data as XML\nin a new browser window",new o.Il(100,0,0)),t.addItem(r?"Export project as plain text...":"Export project...",(()=>{this.projectName?this.exportProject(this.projectName,r):this.prompt("Export Project As...",(t=>this.exportProject(t,r)),null,"exportProject")}),"save project data as XML\nto your downloads folder",r?new o.Il(100,0,0):null),this.stage.globalBlocks.length&&(t.addItem("Export blocks...",(()=>this.exportGlobalBlocks()),"save global custom block\ndefinitions as XML"),t.addItem("Unused blocks...",(()=>this.removeUnusedBlocks()),"find unused global custom blocks\nand remove their definitions")),t.addItem("Export summary...",(()=>this.exportProjectSummary()),"save a summary\nof this project"),r&&(t.addItem("Export summary with drop-shadows...",(()=>this.exportProjectSummary(!0)),"download and save\nwith a summary of this project\nwith drop-shadows on all pictures.\nnot supported by all browsers",new o.Il(100,0,0)),t.addItem("Export all scripts as pic...",(()=>this.exportScriptsPicture()),"show a picture of all scripts\nand block definitions",new o.Il(100,0,0))),t.addLine(),t.addItem("Libraries...",(()=>{"file:"!==location.protocol?this.getURL(this.resourceURL("libraries","LIBRARIES"),(t=>{new Zt(this,this.parseResourceFile(t)).popUp()})):this.importLocalFile()}),"Select categories of additional blocks to add to this project."),t.addItem((0,o.NC)(s)+"...",(()=>{"file:"!==location.protocol?this.importMedia(s):this.importLocalFile()}),"Select a costume from the media library"),t.addItem((0,o.NC)("Sounds")+"...",(()=>{"file:"!==location.protocol?this.importMedia("Sounds"):this.importLocalFile()}),"Select a sound from the media library"),t.popup(e,i)},Kt.prototype.resourceURL=function(){var t=Array.prototype.slice.call(arguments,0);return t.join("/")},Kt.prototype.getMediaList=function(t,e){var o,i=this.resourceURL(t,t.toUpperCase());function s(t,e){return t.name.toLowerCase()<e.name.toLowerCase()?-1:1}if(!(e instanceof Function))return(o=this.parseResourceFile(this.getURL(i))).sort(s),o;this.getURL(i,(t=>{var o=this.parseResourceFile(t);o.sort(s),e.call(this,o)}))},Kt.prototype.parseResourceFile=function(t){var e,o=[];return t.split("\n").map((t=>t.trim())).filter((t=>t.length>0)).forEach((t=>{(e=t.split("\t").map((t=>t.trim()))).length<2||o.push({fileName:e[0],name:e[1],description:e.length>2?e[2]:""})})),o},Kt.prototype.importLocalFile=function(){var t=document.createElement("input"),e=this.world();this.filePicker&&(document.body.removeChild(this.filePicker),this.filePicker=null),t.type="file",t.style.color="transparent",t.style.backgroundColor="transparent",t.style.border="none",t.style.outline="none",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="0px",t.style.height="0px",t.style.display="none",t.addEventListener("change",(()=>{document.body.removeChild(t),this.filePicker=null,e.hand.processDrop(t.files)}),!1),document.body.appendChild(t),this.filePicker=t,t.click()},Kt.prototype.importMedia=function(t){var e=this.showMessage("Opening "+t+"...");this.getMediaList(t,(o=>{e.destroy(),this.popupMediaImportDialog(t,o)}))},Kt.prototype.popupMediaImportDialog=function(t,e){var i=(new lt).withKey("import"+t),r=new o.yR,n=null,a=new s("turtle",60),h=this,l=this.world();r.acceptsDrops=!1,r.contents.acceptsDrops=!1,r.color=h.groupColor,r.fixLayout=o.WY,i.labelString=t,i.createLabel(),i.addBody(r),i.addButton("ok","Import"),i.addButton("cancel","Cancel"),i.ok=function(){n&&(n.object instanceof x?h.droppedAudio(n.object.copy().audio,n.labelString):n.object instanceof S?h.droppedSVG(n.object.contents,n.labelString):h.droppedImage(n.object.contents,n.labelString))},i.fixLayout=function(){var t,e,i=(0,o.SW)(this.titleFontSize)+2*this.titlePadding,s=0,n=0;this.buttons.fixLayout(),this.body.setPosition(this.position().add(new o.E9(this.padding,i+this.padding))),this.body.setExtent(new o.E9(this.width()-2*this.padding,this.height()-3*this.padding-i-this.buttons.height())),t=this.body.position(),e=this.body.width(),r.contents.children.forEach((function(i){i.setPosition(t.add(new o.E9(s,n))),(s+=i.width())+i.width()>e&&(s=0,n+=i.height())})),r.contents.adjustBounds(),this.label.setCenter(this.center()),this.label.setTop(this.top()+(i-this.label.height())/2),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding),this.removeShadow(),this.addShadow()},e.forEach((e=>{var s,h=this.resourceURL(t,e.fileName),l=new Image,p=h.slice(h.lastIndexOf(".")+1).toLowerCase(),c="svg"===p&&!o.tU.rasterizeSVGs,d=(0,o.r3)(["wav","mp3"],p);(s=d?new ie(new x(new Audio,e.name)):new te(new C(a.getImage(),e.name))).isDraggable=!1,s.userMenu=o.WY,s.action=function(){if(n!==s){var t=n;n=s,t&&t.refresh()}},s.doubleClickAction=i.ok,s.query=function(){return s===n},r.addContents(s),d?(s.object.audio.onloadeddata=function(){s.createThumbnail(),s.fixLayout(),s.refresh()},s.object.audio.src=h,s.object.audio.load()):c?(l.onload=function(){s.object=new S(l,e.name),s.refresh()},this.getURL(h,(t=>l.src="data:image/svg+xml;base64,"+window.btoa(t)))):(l.onload=function(){var t=(0,o.oM)(new o.E9(l.width,l.height),!0);t.getContext("2d").drawImage(l,0,0),s.object=new C(t,e.name),s.refresh()},l.src=h)})),i.popUp(l),i.setExtent(new o.E9(400,300)),i.setCenter(l.center()),new o.LG(i,300,280,i.corner,i.corner)},Kt.prototype.aboutSnap=function(){var t,e,i,s,r,n,a,h,l,p,c,d,u="",f=this.world();for(n in e="Snap! 6.3.6 \nBuild Your Own Blocks\n\nCopyright Ⓒ 2008-2020 Jens Mönig and Brian Harvey\njens@moenig.org, bh@cs.berkeley.edu\n\n        Snap! is developed by the University of California, Berkeley and SAP        \nwith support from the National Science Foundation (NSF),\nMIOsoft and YC Research.\nThe design of Snap! is influenced and inspired by Scratch,\nfrom the Lifelong Kindergarten group at the MIT Media Lab\n\nfor more information see https://snap.berkeley.edu",i=(0,o.NC)("License")+"\n\nSnap! is free software: you can redistribute it and/or modify\nit under the terms of the GNU Affero General Public License as\npublished by the Free Software Foundation, either version 3 of\nthe License, or (at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\nGNU Affero General Public License for more details.\n\nYou should have received a copy of the\nGNU Affero General Public License along with this program.\nIf not, see http://www.gnu.org/licenses/\n\nWant to use Snap! but scared by the open-source license?\nGet in touch with us, we'll make it work.",s=(0,o.NC)("Contributors")+'\n\nNathan Dinsmore: Saving/Loading, Snap-Logo Design, \ncountless bugfixes and optimizations\nMichael Ball: Time/Date UI, Library Import Dialog,\ncountless bugfixes and optimizations\nBernat Romagosa: Countless contributions\nBartosz Leper: Retina Display Support\nZhenlei Jia and Dariusz Dorożalski: IME text editing\nKen Kahn: IME support and countless other contributions\nJosep Ferràndiz: Video Motion Detection\nJoan Guillén: Countless contributions\nKartik Chandra: Paint Editor\nCarles Paredes: Initial Vector Paint Editor\n"Ava" Yuan Yuan, Dylan Servilla: Graphic Effects\nKyle Hotchkiss: Block search design\nBrian Broll: Many bugfixes and optimizations\nIan Reynolds: UI Design, Event Bindings, Sound primitives\nJadga Hügle: Icons and countless other contributions\nIvan Motyashov: Initial Squeak Porting\nLucas Karahadian: Piano Keyboard Design\nDavide Della Casa: Morphic Optimizations\nAchal Dave: Web Audio\nJoe Otto: Morphic Testing and Debugging',o.qz)Object.prototype.hasOwnProperty.call(o.qz,n)&&(u+="\n"+n+" ("+o.qz[n]+")");function g(e){var i,s=new o.$1(e,t.fontSize,t.fontStyle,!0,!1,"center",null,null,o.tU.isFlat?null:new o.E9(1,1),o.Cj),r=f.height()-10*t.titleFontSize;return s.height()>r?((i=new o.yR).acceptsDrops=!1,i.contents.acceptsDrops=!1,i.bounds.setWidth(s.width()),i.bounds.setHeight(r),i.addContents(s),i.color=new o.Il(0,0,0,0),i):s}""!==u&&(u=(0,o.NC)("current module versions:")+" \n\nmorphic ("+o.r9+")"+u),r=(0,o.NC)("Translations")+"\n"+SnapTranslator.credits(),(t=new lt).inform("About Snap",e,f,this.logo.cachedTexture),a=t.buttons.children[0],d=t.addButton((()=>{t.addBody(g(r)),t.body.fixLayout(),a.show(),h.show(),l.hide(),p.hide(),c.hide(),d.hide(),t.fixLayout(),t.setCenter(f.center())}),"Translators..."),(h=t.addButton((()=>{t.addBody(g(e)),t.body.fixLayout(),a.show(),h.hide(),l.show(),p.show(),c.show(),d.hide(),t.fixLayout(),t.setCenter(f.center())}),"Back...")).hide(),c=t.addButton((()=>{t.addBody(g(i)),t.body.fixLayout(),a.show(),h.show(),l.hide(),p.hide(),c.hide(),d.hide(),t.fixLayout(),t.setCenter(f.center())}),"License..."),l=t.addButton((()=>{t.addBody(g(u)),t.body.fixLayout(),a.show(),h.show(),l.hide(),p.hide(),c.hide(),d.hide(),t.fixLayout(),t.setCenter(f.center())}),"Modules..."),p=t.addButton((()=>{t.addBody(g(s)),t.body.fixLayout(),a.show(),h.show(),d.show(),l.hide(),p.hide(),c.hide(),t.fixLayout(),t.setCenter(f.center())}),"Credits..."),d.hide(),t.fixLayout()},Kt.prototype.editProjectNotes=function(){var t=(new lt).withKey("projectNotes"),e=new o.yR,i=new o.$1(this.projectNotes||""),s=this.world();e.padding=6,e.setWidth(250),e.acceptsDrops=!1,e.contents.acceptsDrops=!1,i.setWidth(250-2*e.padding),i.setPosition(e.topLeft().add(e.padding)),i.enableSelecting(),i.isEditable=!0,e.setHeight(250),e.fixLayout=o.WY,e.edge=ct.prototype.edge,e.fontSize=ct.prototype.fontSize,e.typeInPadding=ct.prototype.typeInPadding,e.contrast=ct.prototype.contrast,e.render=ct.prototype.render,e.drawRectBorder=ct.prototype.drawRectBorder,e.addContents(i),t.getInput=()=>i.text,t.target=this,t.action=t=>this.projectNotes=t,t.justDropped=()=>i.edit(),t.labelString="Project Notes",t.createLabel(),t.addBody(e),t.addButton("ok","OK"),t.addButton("cancel","Cancel"),t.fixLayout(),t.popUp(s),t.setCenter(s.center()),i.edit()},Kt.prototype.newProject=function(){this.source=this.cloud.username?"cloud":null,this.stage&&this.stage.destroy(),"#lang:"!==location.hash.substr(0,6)&&(location.hash=""),this.globalVariables=new p,this.currentSprite=new y(this.globalVariables),this.sprites=new d([this.currentSprite]),b.prototype.dimensions=new o.E9(480,360),b.prototype.hiddenPrimitives={},b.prototype.codeMappings={},b.prototype.codeHeaders={},b.prototype.enableCodeMapping=!1,b.prototype.enableInheritance=!0,b.prototype.enableSublistIDs=!1,b.prototype.enablePenLogging=!1,y.prototype.useFlatLineEnds=!1,a.prototype.enableLiveCoding=!1,a.prototype.enableHyperOps=!0,this.setProjectName(""),this.projectNotes="",this.createStage(),this.add(this.stage),this.createCorral(),this.selectSprite(this.stage.children[0]),this.fixLayout()},Kt.prototype.save=function(){"file:"!==location.protocol?("examples"!==this.source&&"local"!==this.source||(this.source=null),this.cloud.disabled&&(this.source="disk"),this.projectName?"disk"===this.source?this.exportProject(this.projectName):"cloud"===this.source?this.saveProjectToCloud(this.projectName):this.saveProjectsBrowser():this.saveProjectsBrowser()):this.projectName?this.exportProject(this.projectName,!1):this.prompt("Export Project As...",(t=>this.exportProject(t,!1)),null,"exportProject")},Kt.prototype.exportProject=function(t,e){var o,i;if(t){this.setProjectName(t);try{o=this.showMessage("Exporting"),i=this.serializer.serialize(this.stage),this.setURL("#open:plain,"+encodeURIComponent(i)),this.saveXMLAs(i,t),o.destroy(),this.showMessage("Exported!",1)}catch(t){if(!a.prototype.isCatchingErrors)throw t;this.showMessage("Export failed: "+t)}}},Kt.prototype.exportGlobalBlocks=function(){this.stage.globalBlocks.length>0?new Tt(this.serializer,this.stage.globalBlocks).popUp(this.world()):this.inform("Export blocks","this project doesn't have any\ncustom global blocks yet")},Kt.prototype.removeUnusedBlocks=function(){for(var t,e=this.sprites.asArray().concat([this.stage]),i=this.stage.globalBlocks,s=[],r=!1;!r;)(t=i.filter((t=>!(0,o.r3)(s,t)&&e.every(((e,o)=>!e.usesBlockInstance(t,!0,o,s)))))).length?s=s.concat(t):r=!0;s.length>0?new Pt(s,this.stage).popUp(this.world()):this.inform("Remove unused blocks","there are currently no unused\nglobal custom blocks in this project")},Kt.prototype.exportSprite=function(t){var e=this.serializer.serialize(t.allParts());e='<sprites app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+e+"</sprites>",this.saveXMLAs(e,t.name)},Kt.prototype.exportScriptsPicture=function(){var t,e,i=[],s=0,r=0,n=0;this.sprites.asArray().forEach((t=>{i.push(t.getImage()),i.push(t.scripts.scriptsPicture()),t.customBlocks.forEach((t=>i.push(t.scriptsPicture())))})),i.push(this.stage.getImage()),i.push(this.stage.scripts.scriptsPicture()),this.stage.customBlocks.forEach((t=>i.push(t.scriptsPicture()))),this.stage.globalBlocks.forEach((t=>i.push(t.scriptsPicture()))),(i=i.filter((t=>!(0,o.kK)(t)))).forEach((t=>{s=Math.max(s,t.width),r+=t.height,r+=20})),r-=20,t=(0,o.oM)(new o.E9(s,r)),e=t.getContext("2d"),i.forEach((t=>{e.drawImage(t,0,n),n+=20,n+=t.height})),this.saveCanvasAs(t,this.projectName||(0,o.NC)("Untitled"))},Kt.prototype.exportProjectSummary=function(t){var e,i,s,r,n,h,l=this.stage;function p(t,e,o){return e||(e=s),new Ht(t,o,e)}function c(t,e,o){return e||(e="p"),o||(o=s),new Ht(e,t,o)}function d(t,e,o){e||(e=s);var i=o?null:p("p",e),r=p("img",i||e);return r.attributes.src=t.toDataURL(),r}function f(t){var e,i=t.names().sort(),s=!0;i.length&&(c((0,o.NC)("Variables"),"h3"),i.forEach((o=>{var i,r,n;s&&(e=p("ul"),s=!1),n=p("li",e),(r=(i=new B(o,y.prototype.blockColor.variables,t,o)).cellMorph.contentsMorph)instanceof u&&r.expand(),d(i.fullImage(),n).attributes.class="script"})))}function g(t){t.length&&(c((0,o.NC)("Blocks"),"h3"),y.prototype.categories.forEach((e=>{var i,s=!0;t.forEach((t=>{var r;t.category===e&&(s&&(c((0,o.NC)(e[0].toUpperCase().concat(e.slice(1))),"h4"),i=p("ul"),s=!1),r=p("li",i),d(t.templateInstance().scriptPic(),r).attributes.class="script",t.sortedElements().forEach((t=>{d(t instanceof A?t.scriptPic():t.fullImage(),r).attributes.class="script"})))}))})))}r=this.projectName||(0,o.NC)("untitled"),(e=new Ht("html")).attributes.lang=SnapTranslator.language,i=p("head",e),p("meta",i).attributes.charset="UTF-8",p("style",i,t?"img {vertical-align: top;filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-webkit-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-ms-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}":"img {vertical-align: top;}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}.sprite {border: 1px solid lightgray;}"),c(r,"title",i),s=p("body",e),c(r,"h1"),0===location.hash.indexOf("#present:")?(c(location.toString(),"a",s).attributes.href=location.toString(),d(l.thumbnail(l.dimensions)).attributes.class="sprite",c(this.serializer.app,"h4")):(c(this.serializer.app,"h4"),d(l.thumbnail(l.dimensions)).attributes.class="sprite"),a.prototype.reportTextSplit(this.projectNotes,"line").asArray().forEach((t=>c(t))),c((0,o.NC)("Contents"),"h4"),n=p("ul"),this.sprites.asArray().concat([l]).forEach((t=>{var e,i=p("li",n),s=t.scripts.sortedElements(),r=t.costumes.length();p("hr"),d(t.thumbnail(new o.E9(40,40)),i,!0).attributes.class="toc",c(t.name,"a",i).attributes.href="#"+t.name,c(t.name,"h2").attributes.id=t.name,d(t.thumbnail(t.extent().divideBy(l.scale))).attributes.class="sprite",t instanceof y&&(t.exemplar&&(d(t.exemplar.thumbnail(new o.E9(40,40)),c((0,o.NC)("Kind of")+" "+t.exemplar.name),!0).attributes.class="toc"),t.anchor&&(d(t.anchor.thumbnail(new o.E9(40,40)),c((0,o.NC)("Part of")+" "+t.anchor.name),!0).attributes.class="toc"),t.parts.length&&(c((0,o.NC)("Parts"),"h3"),e=p("ul"),t.parts.forEach((t=>{var i=p("li",e,t.name);d(t.thumbnail(new o.E9(40,40)),i,!0).attributes.class="toc"})))),(r>1||t.getCostumeIdx()!==r)&&(c((0,o.NC)("Costumes"),"h3"),e=p("ol"),t.costumes.asArray().forEach((t=>{var i=p("li",e,t.name);d(t.thumbnail(new o.E9(40,40)),i,!0).attributes.class="toc"}))),t.sounds.length()&&(c((0,o.NC)("Sounds"),"h3"),e=p("ol"),t.sounds.asArray().forEach((t=>c(t.name,"li",e)))),f(t.variables),s.length&&(c((0,o.NC)("Scripts"),"h3"),s.forEach((t=>{d(t instanceof A?t.scriptPic():t.fullImage()).attributes.class="script"}))),g(t.customBlocks)})),h=l.globalVariables(),(Object.keys(h.vars).length||l.globalBlocks.length)&&(p("hr"),c((0,o.NC)("For all Sprites"),"a",p("li",n)).attributes.href="#global",c((0,o.NC)("For all Sprites"),"h2").attributes.id="global",f(h),g(l.globalBlocks)),this.saveFileAs("<!DOCTYPE html>"+e.toString(),"text/html;charset=utf-8",r)},Kt.prototype.openProjectString=function(t){var e;this.nextSteps([()=>e=this.showMessage("Opening project..."),()=>{this.rawOpenProjectString(t),e.destroy()}])},Kt.prototype.rawOpenProjectString=function(t){if(this.toggleAppMode(!1),this.spriteBar.tabBar.tabTo("scripts"),b.prototype.hiddenPrimitives={},b.prototype.codeMappings={},b.prototype.codeHeaders={},b.prototype.enableCodeMapping=!1,b.prototype.enableInheritance=!0,b.prototype.enableSublistIDs=!1,b.prototype.enablePenLogging=!1,a.prototype.enableLiveCoding=!1,a.prototype.isCatchingErrors)try{this.serializer.openProject(this.serializer.load(t,this),this)}catch(t){this.showMessage("Load failed: "+t),Trace.logError(t)}else this.serializer.openProject(this.serializer.load(t,this),this);this.stopFastTracking()},Kt.prototype.openCloudDataString=function(t){var e,o=Math.round(t.length/1024);this.nextSteps([()=>e=this.showMessage("Opening project\n"+o+" KB..."),()=>{this.rawOpenCloudDataString(t),e.destroy()}])},Kt.prototype.rawOpenCloudDataString=function(t){var e;if(b.prototype.hiddenPrimitives={},b.prototype.codeMappings={},b.prototype.codeHeaders={},b.prototype.enableCodeMapping=!1,b.prototype.enableInheritance=!0,b.prototype.enableSublistIDs=!1,b.prototype.enablePenLogging=!1,a.prototype.enableLiveCoding=!1,a.prototype.isCatchingErrors)try{e=this.serializer.parse(t),this.serializer.loadMediaModel(e.childNamed("media")),this.serializer.openProject(this.serializer.loadProjectModel(e.childNamed("project"),this,e.attributes.remixID),this)}catch(t){this.showMessage("Load failed: "+t),Trace.logError(t)}else e=this.serializer.parse(t),this.serializer.loadMediaModel(e.childNamed("media")),this.serializer.openProject(this.serializer.loadProjectModel(e.childNamed("project"),this,e.attributes.remixID),this);this.stopFastTracking()},Kt.prototype.openBlocksString=function(t,e,o){var i;this.nextSteps([()=>i=this.showMessage("Opening blocks..."),()=>{this.rawOpenBlocksString(t,e,o),i.destroy()}])},Kt.prototype.rawOpenBlocksString=function(t,e,o){var i;if(a.prototype.isCatchingErrors)try{i=this.serializer.loadBlocks(t,this.stage)}catch(t){this.showMessage("Load failed: "+t),Trace.logError(t)}else i=this.serializer.loadBlocks(t,this.stage);o?(i.forEach((t=>{t.receiver=this.stage,this.stage.globalBlocks.push(t),this.stage.replaceDoubleDefinitionsFor(t)})),this.flushPaletteCache(),this.refreshPalette(),this.showMessage("Imported Blocks Module"+(e?": "+e:"")+".",2)):new Bt(i,this.stage,e).popUp()},Kt.prototype.openSpritesString=function(t){var e;this.nextSteps([()=>e=this.showMessage("Opening sprite..."),()=>{this.rawOpenSpritesString(t),e.destroy()}])},Kt.prototype.rawOpenSpritesString=function(t){if(a.prototype.isCatchingErrors)try{this.serializer.loadSprites(t,this)}catch(t){this.showMessage("Load failed: "+t),Trace.logError(t)}else this.serializer.loadSprites(t,this)},Kt.prototype.openMediaString=function(t){if(a.prototype.isCatchingErrors)try{this.serializer.loadMedia(t)}catch(t){this.showMessage("Load failed: "+t),Trace.logError(t)}else this.serializer.loadMedia(t);this.showMessage("Imported Media Module.",2)},Kt.prototype.openScriptString=function(t){var e;this.nextSteps([()=>e=this.showMessage("Opening script..."),()=>{this.rawOpenScriptString(t),e.destroy()}])},Kt.prototype.rawOpenScriptString=function(t){var e,o,i=this.currentSprite.scripts;if(a.prototype.isCatchingErrors)try{e=this.serializer.parse(t,this.currentSprite),o=this.serializer.loadScript(e,this.currentSprite)}catch(t){this.showMessage("Load failed: "+t)}else e=this.serializer.loadScript(t,this.currentSprite),o=this.serializer.loadScript(e,this.currentSprite);o.setPosition(this.world().hand.position()),i.add(o),i.adjustBounds(),i.lastDroppedBlock=o,i.recordDrop({origin:this.palette,position:this.palette.center()}),this.showMessage("Imported Script.",2)},Kt.prototype.openDataString=function(t,e,o){var i;this.nextSteps([()=>i=this.showMessage("Opening data..."),()=>{this.rawOpenDataString(t,e,o),i.destroy()}])},Kt.prototype.rawOpenDataString=function(t,e,i){var s,r,n,h=this.currentSprite.globalVariables();switch(i){case"csv":s=a.prototype.parseCSV(t);break;case"json":s=a.prototype.parseJSON(t);break;default:s=t}r=function(t){for(var e=h.names(),i=t.indexOf("("),s=i<0?t:t.substring(0,i),r=1,n=s;(0,o.r3)(e,n);)n=s+"("+(r+=1)+")";return n}(e||"data"),h.addVar(r),h.setVar(r,s),this.currentSprite.toggleVariableWatcher(r,!0),this.flushBlocksCache("variables"),this.currentCategory="variables",this.categories.children.forEach((t=>t.refresh())),this.refreshPalette(!0),s instanceof d&&((n=new Rt(s)).labelString=(0,o.NC)(n.labelString)+": "+r,n.createLabel(),n.popUp(this.world()))},Kt.prototype.openProject=function(t){var e;t&&(this.showMessage("opening project\n"+t),this.setProjectName(t),e=localStorage["-snap-project-"+t],this.openProjectString(e),this.setURL("#open:"+e))},Kt.prototype.setURL=function(t){location.hash=this.projectsInURLs?t:""},Kt.prototype.saveFileAs=function(t,e,i){var s,r,n=!1,a=this.world();s="."+("plain"===(s=e.split("/")[1].split(";")[0])?"txt":s);try{n=!!new Blob}catch(t){}n?(t instanceof Blob||(t=function(t,e){var o,i=t,s=t.split(","),r=0===t.indexOf("data:");if(r&&s[0].indexOf("base64")>-1)for(t=atob(s[1]),i=new Uint8Array(t.length),o=t.length;o--;)i[o]=t.charCodeAt(o);else if(r)for(t=t.replace(/^data:image\/.*?, */,""),i=new Uint8Array(t.length),o=t.length;o--;)i[o]=t.charCodeAt(o);return new Blob([i],{type:e})}(t,e)),(0,Yt.p)(t,i+s,!1)):((r=new lt).inform((0,o.NC)("Could not export")+" "+i,"unable to export text",a),r.fixLayout())},Kt.prototype.saveCanvasAs=function(t,e){this.saveFileAs(t.toDataURL(),"image/png",e)},Kt.prototype.saveAudioAs=function(t,e){this.saveFileAs(t.src,"audio/wav",e)},Kt.prototype.saveXMLAs=function(t,e){this.saveFileAs(t,"text/xml;chartset=utf-8",e)},Kt.prototype.switchToUserMode=function(){var t=this.world();t.isDevMode=!1,a.prototype.isCatchingErrors=!0,this.controlBar.updateLabel(),this.isAutoFill=!0,this.isDraggable=!1,this.reactToWorldResize(t.bounds.copy()),this.siblings().forEach((e=>{e instanceof lt?t.add(e):e.destroy()})),this.flushBlocksCache(),this.refreshPalette(),t.reactToDropOf=e=>{e instanceof lt||e instanceof o.wR||(t.hand.grabOrigin?e.slideBackTo(t.hand.grabOrigin):t.hand.grab(e))},this.showMessage("entering user mode",1)},Kt.prototype.getSpriteByName=function(t){const e=this.sprites.contents.filter((function(e){return e.name===t}));return e&&0!==e.length?e[0]:null},Kt.prototype.switchToDevMode=function(){var t=this.world();t.isDevMode=!0,a.prototype.isCatchingErrors=!1,this.controlBar.updateLabel(),this.isAutoFill=!1,this.isDraggable=!0,this.setExtent(t.extent().subtract(100)),this.setPosition(t.position().add(20)),this.flushBlocksCache(),this.refreshPalette(),delete t.reactToDropOf,this.showMessage("entering development mode.\n\nerror catching is turned off,\nuse the browser's web console\nto see error messages.")},Kt.prototype.flushBlocksCache=function(t){t?(this.stage.blocksCache[t]=null,this.stage.children.forEach((e=>{e instanceof y&&(e.blocksCache[t]=null)}))):(this.stage.blocksCache={},this.stage.children.forEach((t=>{t instanceof y&&(t.blocksCache={})}))),this.flushPaletteCache(t)},Kt.prototype.flushPaletteCache=function(t){t?(this.stage.paletteCache[t]=null,this.stage.children.forEach((e=>{e instanceof y&&(e.paletteCache[t]=null)}))):(this.stage.paletteCache={},this.stage.children.forEach((t=>{t instanceof y&&(t.paletteCache={})})))},Kt.prototype.toggleZebraColoring=function(){var t=[];A.prototype.zebraContrast?A.prototype.zebraContrast=0:A.prototype.zebraContrast=40,this.stage.children.concat(this.stage).forEach((e=>{g(e)&&(t=t.concat(e.scripts.children.filter((t=>t instanceof A))))})),t.forEach((t=>t.fixBlockColor(null,!0)))},Kt.prototype.toggleDynamicInputLabels=function(){var t;if(I.prototype.dynamicInputLabels=!I.prototype.dynamicInputLabels,a.prototype.isCatchingErrors)try{t=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else t=this.serializer.serialize(this.stage);y.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.openProjectString(t)},Kt.prototype.toggleBlurredShadows=function(){window.useBlurredShadows=!o.A3,this.rerender(),window.useBlurredShadows?this.removeSetting("solidshadow"):this.saveSetting("solidshadow",!1)},Kt.prototype.toggleLongFormInputDialog=function(){kt.prototype.isLaunchingExpanded=!kt.prototype.isLaunchingExpanded,kt.prototype.isLaunchingExpanded?this.saveSetting("longform",!0):this.removeSetting("longform")},Kt.prototype.togglePlainPrototypeLabels=function(){vt.prototype.plainLabel=!vt.prototype.plainLabel,vt.prototype.plainLabel?this.saveSetting("plainprototype",!0):this.removeSetting("plainprototype")},Kt.prototype.togglePreferEmptySlotDrops=function(){N.prototype.isPreferringEmptySlots=!N.prototype.isPreferringEmptySlots},Kt.prototype.toggleVirtualKeyboard=function(){o.tU.useVirtualKeyboard=!o.tU.useVirtualKeyboard},Kt.prototype.toggleInputSliders=function(){o.tU.useSliderForInput=!o.tU.useSliderForInput},Kt.prototype.toggleSliderExecute=function(){j.prototype.executeOnSliderEdit=!j.prototype.executeOnSliderEdit},Kt.prototype.setEmbedMode=function(){var t=this;this.isEmbedMode=!0,this.appModeColor=new o.Il(243,238,235),this.embedOverlay=new o._V,this.embedOverlay.color=new o.Il(128,128,128),this.embedOverlay.alpha=.5,this.embedPlayButton=new s("circleSolid"),this.embedPlayButton.color=new o.Il(64,128,64),this.embedPlayButton.alpha=.75,this.embedPlayButton.flag=new s("flag"),this.embedPlayButton.flag.color=new o.Il(128,255,128),this.embedPlayButton.flag.alpha=.75,this.embedPlayButton.add(this.embedPlayButton.flag),this.embedPlayButton.mouseClickLeft=function(){t.runScripts(),t.embedOverlay.destroy(),this.destroy()},this.controlBar.hide(),this.add(this.embedOverlay),this.add(this.embedPlayButton),this.fixLayout()},Kt.prototype.toggleAppMode=function(t){var e=this.world(),i=[this.logo,this.controlBar.cloudButton,this.controlBar.projectButton,this.controlBar.settingsButton,this.controlBar.steppingButton,this.controlBar.stageSizeButton,this.paletteHandle,this.stageHandle,this.corral,this.corralBar,this.spriteEditor,this.spriteBar,this.palette,this.categories];this.isAppMode=(0,o.kK)(t)?!this.isAppMode:t,this.isAppMode?(this.wasSingleStepping=a.prototype.enableSingleStepping,this.wasSingleStepping&&this.toggleSingleStepping(),this.setColor(this.appModeColor),this.controlBar.setColor(this.color),this.controlBar.appModeButton.refresh(),i.forEach((t=>t.hide())),e.children.forEach((t=>{t instanceof lt&&t.hide()})),e.keyboardFocus instanceof it&&e.keyboardFocus.stopEditing()):(this.wasSingleStepping&&!a.prototype.enableSingleStepping&&this.toggleSingleStepping(),this.setColor(this.backgroundColor),this.controlBar.setColor(this.frameColor),i.forEach((t=>t.show())),this.stage.setScale(1),e.children.forEach((t=>{t instanceof lt&&t.show()})),e.allChildren().filter((t=>t instanceof o.yR)).forEach((t=>t.adjustScrollBars())),this.currentSprite===this.stage&&this.spriteBar.children.forEach((t=>{t instanceof st&&t.hide()})),this.currentSprite.scripts.updateToolbar()),this.setExtent(this.world().extent())},Kt.prototype.toggleStageSize=function(t,e){var i=this,s=e||.5,r=this.isAnimating?100:0,n=this.world(),a=16===n.currentKey,h=18===n.currentKey;function l(){i.isSmallStage=(0,o.kK)(t)?!i.isSmallStage:t}function p(t){i.isSmallStage=!0,n.animations.push(new o.fw((t=>{i.stageRatio=t,i.setExtent(n.extent())}),(()=>i.stageRatio),t-i.stageRatio,r,null,(()=>{i.isSmallStage=1!==t,i.controlBar.stageSizeButton.refresh()})))}a?(s=3*Qt.prototype.thumbSize.x/this.stage.dimensions.x,this.isSmallStage&&s!==this.stageRatio||l()):h?(s=this.width()/2/this.stage.dimensions.x,this.isSmallStage&&s!==this.stageRatio||l()):l(),this.isSmallStage?p(s):p(1)},Kt.prototype.setPaletteWidth=function(t){var e=this.isAnimating?100:0,i=this.world();i.animations.push(new o.fw((t=>{this.paletteWidth=t,this.setExtent(i.extent())}),(()=>this.paletteWidth),t-this.paletteWidth,e))},Kt.prototype.createNewProject=function(){this.confirm("Replace the current project with a new one?","New Project",(()=>this.newProject()))},Kt.prototype.openProjectsBrowser=function(){"file:"!==location.protocol?new Xt(this,"open").popUp():this.importLocalFile()},Kt.prototype.saveProjectsBrowser=function(){"file:"!==location.protocol?("examples"===this.source&&(this.source=null),new Xt(this,"save").popUp()):this.prompt("Export Project As...",(t=>this.exportProject(t,!1)),null,"exportProject")},Kt.prototype.microphoneMenu=function(){var t=new o.wR(this),e=this.world(),i=this.controlBar.settingsButton.bottomLeft(),r=this.stage.microphone,n=new s("tick",.75*o.tU.menuFontSize),a=new s("checkedBox",.75*o.tU.menuFontSize),h=n.fullCopy();h.render=o.WY,r.isReady&&(t.addItem([a,(0,o.NC)("Microphone")],(()=>r.stop())),t.addLine()),["low","normal","high","max"].forEach(((e,i)=>{t.addItem([r.resolution===i+1?n:h,(0,o.NC)(e)],(()=>r.setResolution(i+1)))})),t.popup(e,i)},Kt.prototype.languageMenu=function(){var t=new o.wR(this),e=this.world(),i=this.controlBar.settingsButton.bottomLeft(),r=new s("tick",.75*o.tU.menuFontSize),n=r.fullCopy();n.render=o.WY,SnapTranslator.languages().forEach((e=>t.addItem([SnapTranslator.language===e?r:n,SnapTranslator.languageName(e)],(()=>{this.loadNewProject=!1,this.setLanguage(e)})))),t.popup(e,i)},Kt.prototype.setLanguage=function(t,e,o){var i=document.getElementById("language"),s=this.resourceURL("locale","lang-"+t+".js");if(SnapTranslator.unload(),i&&document.head.removeChild(i),"en"===t)return this.reflectLanguage("en",e,o);(i=document.createElement("script")).id="language",i.onload=()=>this.reflectLanguage(t,e,o),document.head.appendChild(i),i.src=s},Kt.prototype.reflectLanguage=function(t,e,o){var i,s=location.hash;if(SnapTranslator.language=t,!this.loadNewProject)if(a.prototype.isCatchingErrors)try{i=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else i=this.serializer.serialize(this.stage);y.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.fixLayout(),this.loadNewProject?(this.newProject(),location.hash=s):this.openProjectString(i),o||this.saveSetting("language",t),e&&e.call(this)},Kt.prototype.userSetBlocksScale=function(){var t,e,i,s,r,n;(t=new R).color=y.prototype.blockColor.motion,t.setSpec((0,o.NC)("build")),(e=new R).color=y.prototype.blockColor.sound,e.setSpec((0,o.NC)("your own")),t.nextBlock(e),(e=new R).color=y.prototype.blockColor.operators,e.setSpec((0,o.NC)("blocks")),t.bottomBlock().nextBlock(e),(s=new o.xZ).acceptsDrops=!1,s.color=Kt.prototype.groupColor,I.prototype.alpha>.8&&(s.cachedTexture=this.scriptsPaneTexture),s.setExtent(new o.E9(250,180)),t.setPosition(s.position().add(10)),s.add(t),(i=new o._V).alpha=0,i.setExtent(s.extent()),i.setPosition(s.position()),s.add(i),r=e=>{t.blockSequence().forEach((t=>{t.setScale(e),t.setSpec(t.blockSpec)})),t.fullChanged()},n=new lt(null,(t=>this.setBlocksScale(Math.min(t,12)))).withKey("zoomBlocks"),o.tU.isTouchDevice&&(n.isDraggable=!1),n.prompt("Zoom blocks",I.prototype.scale.toString(),this.world(),s,{"normal (1x)":1,"demo (1.2x)":1.2,"presentation (1.4x)":1.4,"big (2x)":2,"huge (4x)":4,"giant (8x)":8,"monstrous (10x)":10},!1,!0,1,5,r)},Kt.prototype.setBlocksScale=function(t){var e;if(a.prototype.isCatchingErrors)try{e=this.serializer.serialize(this.stage)}catch(t){this.showMessage("Serialization failed: "+t)}else e=this.serializer.serialize(this.stage);I.prototype.setScale(t),ot.prototype.refreshScale(),y.prototype.initBlocks(),this.spriteBar.tabBar.tabTo("scripts"),this.createCategories(),this.createCorralBar(),this.fixLayout(),this.openProjectString(e),this.saveSetting("zoom",t)},Kt.prototype.userFadeBlocks=function(){var t,e=100-100*I.prototype.alpha;t=new lt(null,(t=>this.setBlockTransparency(t,!0))).withKey("fadeBlocks"),o.tU.isTouchDevice&&(t.isDraggable=!1),t.cancel=()=>{this.setBlockTransparency(e),t.destroy()},t.prompt("Fade blocks",e.toString(),this.world(),null,{"block-solid (0)":0,"medium (50)":50,"light (70)":70,"shimmering (80)":80,"elegant (90)":90,"subtle (95)":95,"text-only (100)":100},!1,!0,0,100,(t=>this.setBlockTransparency(t)),0)},Kt.prototype.setBlockTransparency=function(t,e){I.prototype.setAlphaScaled(100-t),this.changed(),e&&(0===t?this.removeSetting("fade"):this.saveSetting("fade",t))},Kt.prototype.userSetStageSize=function(){new lt(this,this.setStageExtent,this).promptVector("Stage size",b.prototype.dimensions,new o.E9(480,360),"Stage width","Stage height",this.world(),null,null)},Kt.prototype.setStageExtent=function(t){var e=this,i=this.world(),s=t.max(new o.E9(240,180));this.stageRatio=1,this.isSmallStage=!1,this.controlBar.stageSizeButton.refresh(),this.stage.stopVideo(),this.setExtent(i.extent()),this.isAnimating?e.step=function(){var t=s.subtract(b.prototype.dimensions).divideBy(2);t.abs().lt(new o.E9(5,5))?(b.prototype.dimensions=s,delete e.step):b.prototype.dimensions=b.prototype.dimensions.add(t),e.stage.setExtent(b.prototype.dimensions),e.stage.clearPenTrails(),e.fixLayout(),this.setExtent(i.extent())}:(b.prototype.dimensions=s,this.stage.setExtent(b.prototype.dimensions),this.stage.clearPenTrails(),this.fixLayout(),this.setExtent(i.extent()))},Kt.prototype.userSetDragThreshold=function(){new lt(this,(t=>o.tU.grabThreshold=Math.min(Math.max(+t,0),200)),this).prompt("Dragging threshold",o.tU.grabThreshold.toString(),this.world(),null,null,null,!0)},Kt.prototype.initializeCloud=function(){var t=this.world();new lt(null,(e=>this.cloud.login(e.username.toLowerCase(),e.password,e.choice,((e,i,s)=>{if(sessionStorage.username=e,this.controlBar.cloudButton.refresh(),this.source="cloud",(0,o.kK)(s.days_left))this.showMessage(s.message,2);else{var r=s.days_left+" day"+(s.days_left>1?"s":"");(new lt).inform("Unverified account: "+r+" leftYou are now logged in, and your account\nis enabled for "+r+'.\nPlease use the verification link that\nwas sent to your email address when you\nsigned up.\n\nIf you cannot find that email, please\ncheck your spam folder. If you still\ncannot find it, please use the "Resend\nVerification Email..." option in the cloud\nmenu.\n\nYou have '+r+" left.",t,this.cloudIcon(null,new o.Il(0,180,0)))}}),this.cloudError()))).withKey("cloudlogin").promptCredentials("Sign in","login",null,null,null,null,"stay signed in on this computer\nuntil logging out",t,this.cloudIcon(),this.cloudMsg)},Kt.prototype.createCloudAccount=function(){var t=this.world();new lt(null,(e=>this.cloud.signup(e.username,e.password,e.passwordRepeat,e.email,((e,i)=>(new lt).inform(i,e+".\n\nYou can now log in.",t,this.cloudIcon(null,new o.Il(0,180,0)))),this.cloudError()))).withKey("cloudsignup").promptCredentials("Sign up","signup","https://snap.berkeley.edu/tos.html","Terms of Service...","https://snap.berkeley.edu/privacy.html","Privacy...","I have read and agree\nto the Terms of Service",t,this.cloudIcon(),this.cloudMsg)},Kt.prototype.resetCloudPassword=function(){var t=this.world();new lt(null,(e=>this.cloud.resetPassword(e.username,((e,i)=>(new lt).inform(i,e+"\n\nAn e-mail with a link to\nreset your password\nhas been sent to the address provided",t,this.cloudIcon(null,new o.Il(0,180,0)))),this.cloudError()))).withKey("cloudresetpassword").promptCredentials("Reset password","resetPassword",null,null,null,null,null,t,this.cloudIcon(),this.cloudMsg)},Kt.prototype.resendVerification=function(){var t=this.world();new lt(null,(e=>this.cloud.resendVerification(e.username,((e,i)=>(new lt).inform(i,e,t,this.cloudIcon(null,new o.Il(0,180,0)))),this.cloudError()))).withKey("cloudresendverification").promptCredentials("Resend verification email","resendVerification",null,null,null,null,null,t,this.cloudIcon(),this.cloudMsg)},Kt.prototype.changeCloudPassword=function(){var t=this.world();new lt(null,(t=>this.cloud.changePassword(t.oldpassword,t.password,t.passwordRepeat,(()=>this.showMessage("password has been changed.",2)),this.cloudError()))).withKey("cloudpassword").promptCredentials("Change Password","changePassword",null,null,null,null,null,t,this.cloudIcon(),this.cloudMsg)},Kt.prototype.logout=function(){this.cloud.logout((()=>{delete sessionStorage.username,this.controlBar.cloudButton.refresh(),this.showMessage("disconnected.",2)}),(()=>{delete sessionStorage.username,this.controlBar.cloudButton.refresh(),this.showMessage("disconnected.",2)}))},Kt.prototype.buildProjectRequest=function(){var t,e=this.serializer.serialize(this.stage),i=(0,o.bl)(this.stage.thumbnail(_t.prototype.thumbnailSize)).toDataURL();return this.serializer.isCollectingMedia=!0,t={notes:this.projectNotes,xml:e,media:this.hasChangedMedia?this.serializer.mediaXML(this.projectName):null,thumbnail:i,remixID:this.stage.remixID},this.serializer.isCollectingMedia=!1,this.serializer.flushMedia(),t},Kt.prototype.verifyProject=function(t){var e=JSON.stringify(t);if(e.length>Gt.MAX_FILE_SIZE)return(new lt).inform("Snap!Cloud - Cannot Save Project","The media inside this project exceeds 10 MB.\nPlease reduce the size of costumes or sounds.\n",this.world(),this.cloudIcon(null,new o.Il(180,0,0))),!1;try{this.serializer.parse(t.xml)}catch(t){return this.showMessage("Serialization of program data failed:\n"+t),!1}if(null!==t.media)try{this.serializer.parse(t.media)}catch(t){return this.showMessage("Serialization of media failed:\n"+t),!1}return this.serializer.isCollectingMedia=!1,this.serializer.flushMedia(),e.length},Kt.prototype.saveProjectToCloud=function(t){var e,o;t&&this.setProjectName(t),this.showMessage("Saving project\nto the cloud..."),e=this.buildProjectRequest(),(o=this.verifyProject(e))&&(this.showMessage("Uploading "+Math.round(o/1024)+" KB..."),this.cloud.saveProject(this.projectName,e,(()=>this.showMessage("saved.",2)),this.cloudError()))},Kt.prototype.exportProjectMedia=function(t){var e,o;if(this.serializer.isCollectingMedia=!0,t){this.setProjectName(t);try{e=this.showMessage("Exporting"),o=this.serializer.mediaXML(t),this.saveXMLAs(o,this.projectName+" media"),e.destroy(),this.showMessage("Exported!",1)}catch(t){if(!a.prototype.isCatchingErrors)throw t;this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+t)}}this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},Kt.prototype.exportProjectNoMedia=function(t){var e,o;if(this.serializer.isCollectingMedia=!0,t)if(this.setProjectName(t),a.prototype.isCatchingErrors)try{e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1)}catch(t){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+t)}else e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},Kt.prototype.exportProjectAsCloudData=function(t){var e,o;if(this.serializer.isCollectingMedia=!0,t)if(this.setProjectName(t),a.prototype.isCatchingErrors)try{e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),this.serializer.mediaXML(t),this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1)}catch(t){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+t)}else e=this.showMessage("Exporting"),o=this.serializer.serialize(this.stage),this.serializer.mediaXML(t),this.saveXMLAs(o,this.projectName),e.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1,this.serializer.flushMedia()},Kt.prototype.cloudAcknowledge=function(){return(t,e)=>{(0,o.WY)(t),(new lt).inform("Cloud Connection","Successfully connected to:\nhttp://"+e,this.world(),this.cloudIcon(null,new o.Il(0,180,0)))}},Kt.prototype.cloudResponse=function(){return(t,e)=>{var i=t;i.length>50&&(i=i.substring(0,50)+"..."),(new lt).inform("Snap!Cloud","http://"+e+":\n\nresponds:\n"+i,this.world(),this.cloudIcon(null,new o.Il(0,180,0)))}},Kt.prototype.cloudError=function(){return(t,e)=>{var i=t;this.shield&&(this.shield.destroy(),this.shield=null),(new lt).inform("Snap!Cloud",(e?e+"\n":"")+i,this.world(),this.cloudIcon(null,new o.Il(180,0,0)))}},Kt.prototype.cloudIcon=function(t,e){var i=e||lt.prototype.titleBarColor,r=o.tU.isFlat,n=new s(r?"cloud":"cloudGradient",t||50,i,r?null:new o.E9(-1,-1),i.darker(50));return r||n.addShadow(new o.E9(1,1),1,i.lighter(95)),n},Kt.prototype.setCloudURL=function(){new lt(null,(t=>{this.cloud.url=t,this.cloud.checkCredentials((()=>this.controlBar.cloudButton.refresh()),(()=>this.controlBar.cloudButton.refresh()))})).withKey("cloudURL").prompt("Cloud URL",this.cloud.url,this.world(),null,this.cloud.knownDomains)},Kt.prototype.urlParameters=function(){var t=location.hash.slice(location.hash.indexOf(":")+1);return this.cloud.parseDict(t)},Kt.prototype.hasCloudProject=function(){var t=this.urlParameters();return t.hasOwnProperty("Username")&&t.hasOwnProperty("ProjectName")},Kt.prototype.getURL=function(t,e,o){var i,s=new XMLHttpRequest,r=e instanceof Function;r&&(s.responseType=o||"text"),i=r&&"text"!==s.responseType?"response":"responseText";try{if(s.open("GET",t,r),r&&(s.onreadystatechange=()=>{if(4===s.readyState){if(!s[i])throw this.showMessage("unable to retrieve "+t),new Error("unable to retrieve "+t);e.call(this,s[i])}}),s.send(),!r){if(200===s.status)return s[i];throw new Error("unable to retrieve "+t)}}catch(t){if(this.showMessage(t.toString()),!r)return s[i];e.call(this)}},Kt.prototype.showMessage=function(t,e){var i,s=new o.wR(null,t);return s.popUpCenteredInWorld(this.world()),e&&(i=setInterval((()=>{s.destroy(),clearInterval(i)}),1e3*e)),s},Kt.prototype.inform=function(t,e){(new lt).inform(t,(0,o.NC)(e),this.world())},Kt.prototype.confirm=function(t,e,i){new lt(null,i).askYesNo(e,(0,o.NC)(t),this.world())},Kt.prototype.prompt=function(t,e,o,i){new lt(null,e).withKey(i).prompt(t,"",this.world(),null,o)},Kt.prototype.warnAboutIE=function(){var t,e;this.isIE()&&(t=new lt,e=new o.$1("Please do not use Internet Explorer.\nSnap! runs best in a web-standards\ncompliant browser",t.fontSize,t.fontStyle,!0,!1,"center",null,null,o.tU.isFlat?null:new o.E9(1,1),o.Cj),t.key="IE-Warning",t.labelString="Internet Explorer",t.createLabel(),t.addBody(e),t.fixLayout(),t.popUp(this.world()))},Kt.prototype.isIE=function(){var t=navigator.userAgent;return t.indexOf("MSIE ")>-1||t.indexOf("Trident/")>-1},Xt.prototype=new lt,Xt.prototype.constructor=Xt,Xt.uber=lt.prototype,Xt.prototype.init=function(t,e){this.ide=t,this.task=e||"open",this.source=t.source,this.projectList=[],this.handle=null,this.srcBar=null,this.nameField=null,this.filterField=null,this.magnifyingGlass=null,this.listField=null,this.preview=null,this.notesText=null,this.notesField=null,this.deleteButton=null,this.shareButton=null,this.unshareButton=null,this.publishButton=null,this.unpublishButton=null,this.recoverButton=null,Xt.uber.init.call(this,this,null,null),this.labelString="save"===this.task?"Save Project":"Open Project",this.createLabel(),this.key="project"+e,"open"===e&&"disk"===this.source?(this.source=null,this.buildContents(),this.projectList=[],this.listField.hide(),this.source="disk"):(this.buildContents(),this.onNextStep=()=>this.setSource(this.source))},Xt.prototype.buildContents=function(){var t,e;this.addBody(new o._V),this.body.color=this.color,this.srcBar=new pt("column",this.padding/2),this.ide.cloudMsg&&((e=new o.$1(this.ide.cloudMsg,10,null,!1,null,null,null,null,new o.E9(1,1),o.Cj)).refresh=o.WY,this.srcBar.add(e)),this.ide.cloud.disabled||this.addSourceButton("cloud",(0,o.NC)("Cloud"),"cloud"),"open"===this.task&&(this.buildFilterField(),this.addSourceButton("examples",(0,o.NC)("Examples"),"poster"),(this.hasLocalProjects()||16===this.ide.world().currentKey)&&this.addSourceButton("local",(0,o.NC)("Browser"),"globe")),this.addSourceButton("disk",(0,o.NC)("Computer"),"storage"),this.srcBar.fixLayout(),this.body.add(this.srcBar),"save"===this.task&&(this.nameField=new ct(this.ide.projectName),this.body.add(this.nameField)),this.listField=new o.NT([]),this.fixListFieldItemColors(),this.listField.fixLayout=o.WY,this.listField.edge=ct.prototype.edge,this.listField.fontSize=ct.prototype.fontSize,this.listField.typeInPadding=ct.prototype.typeInPadding,this.listField.contrast=ct.prototype.contrast,this.listField.render=ct.prototype.render,this.listField.drawRectBorder=ct.prototype.drawRectBorder,this.body.add(this.listField),this.preview=new o._V,this.preview.fixLayout=o.WY,this.preview.edge=ct.prototype.edge,this.preview.fontSize=ct.prototype.fontSize,this.preview.typeInPadding=ct.prototype.typeInPadding,this.preview.contrast=ct.prototype.contrast,this.preview.render=function(t){ct.prototype.render.call(this,t),this.cachedTexture?this.renderCachedTexture(t):this.texture&&this.renderTexture(this.texture,t)},this.preview.renderCachedTexture=function(t){t.drawImage(this.cachedTexture,this.edge,this.edge)},this.preview.drawRectBorder=ct.prototype.drawRectBorder,this.preview.setExtent(this.ide.serializer.thumbnailSize.add(2*this.preview.edge)),this.body.add(this.preview),"save"===this.task&&(t=this.ide.stage.thumbnail(_t.prototype.thumbnailSize),this.preview.texture=null,this.preview.cachedTexture=t,this.preview.rerender()),this.notesField=new o.yR,this.notesField.fixLayout=o.WY,this.notesField.edge=ct.prototype.edge,this.notesField.fontSize=ct.prototype.fontSize,this.notesField.typeInPadding=ct.prototype.typeInPadding,this.notesField.contrast=ct.prototype.contrast,this.notesField.render=ct.prototype.render,this.notesField.drawRectBorder=ct.prototype.drawRectBorder,this.notesField.acceptsDrops=!1,this.notesField.contents.acceptsDrops=!1,"open"===this.task?this.notesText=new o.$1(""):(this.notesText=new o.$1(this.ide.projectNotes),this.notesText.isEditable=!0,this.notesText.enableSelecting()),this.notesField.isTextLineWrapping=!0,this.notesField.padding=3,this.notesField.setContents(this.notesText),this.notesField.setWidth(this.preview.width()),this.body.add(this.notesField),"open"===this.task?(this.addButton("openProject","Open"),this.action="openProject",this.recoverButton=this.addButton("recoveryDialog","Recover",!0),this.recoverButton.hide()):(this.addButton("saveProject","Save"),this.action="saveProject"),this.shareButton=this.addButton("shareProject","Share",!0),this.unshareButton=this.addButton("unshareProject","Unshare",!0),this.shareButton.hide(),this.unshareButton.hide(),this.publishButton=this.addButton("publishProject","Publish",!0),this.unpublishButton=this.addButton("unpublishProject","Unpublish",!0),this.publishButton.hide(),this.unpublishButton.hide(),this.deleteButton=this.addButton("deleteProject","Delete"),this.addButton("cancel","Cancel"),e?this.setExtent(new o.E9(500,360).add(e.extent())):this.setExtent(new o.E9(500,360)),this.fixLayout()},Xt.prototype.popUp=function(t){var e=t||this.ide.world();e&&(Xt.uber.popUp.call(this,e),this.handle=new o.LG(this,350,330,this.corner,this.corner))},Xt.prototype.createButtons=function(){this.buttons&&this.buttons.destroy(),this.buttons=new pt("column",this.padding/3),this.buttons.bottomRow=new pt("row",this.padding),this.buttons.topRow=new pt("row",this.padding),this.buttons.add(this.buttons.topRow),this.buttons.add(this.buttons.bottomRow),this.add(this.buttons),this.buttons.fixLayout=function(){this.topRow.children.some((function(t){return t.isVisible}))?(this.topRow.show(),this.topRow.fixLayout()):this.topRow.hide(),this.bottomRow.fixLayout(),pt.prototype.fixLayout.call(this)}},Xt.prototype.addButton=function(t,e,i){var s=new st(this,t||"ok","  "+(0,o.NC)(e||"OK")+"  ");return s.fontSize=this.buttonFontSize,s.corner=this.buttonCorner,s.edge=this.buttonEdge,s.outline=this.buttonOutline,s.outlineColor=this.buttonOutlineColor,s.outlineGradient=this.buttonOutlineGradient,s.padding=this.buttonPadding,s.contrast=this.buttonContrast,s.fixLayout(),i?this.buttons.topRow.add(s):this.buttons.bottomRow.add(s),s},Xt.prototype.addSourceButton=function(t,e,i){var r,n=new o.XC(e,10,null,!0,null,null,new o.E9(1,1),o.Cj),a=new o.XC(e,10,null,!0,null,null,new o.E9(-1,-1),this.titleBarColor.darker(50),o.Cj),h=new o._V,l=new o._V;n.add(new s(i,24,this.titleBarColor.darker(20),new o.E9(1,1),this.titleBarColor.darker(50))),n.children[0].setCenter(n.center()),n.children[0].setBottom(n.top()-this.padding/2),h.isCachingImage=!0,h.cachedImage=n.fullImage(),h.bounds=n.fullBounds(),a.add(new s(i,24,o.Cj,new o.E9(-1,-1),this.titleBarColor.darker(50))),a.children[0].setCenter(a.center()),a.children[0].setBottom(a.top()-this.padding/2),l.isCachingImage=!0,l.cachedImage=a.fullImage(),l.bounds=a.fullBounds(),(r=new rt(null,this,(()=>this.setSource(t)),[h,l],(()=>this.source===t))).corner=this.buttonCorner,r.edge=this.buttonEdge,r.outline=this.buttonOutline,r.outlineColor=this.buttonOutlineColor,r.outlineGradient=this.buttonOutlineGradient,r.labelMinExtent=new o.E9(60,0),r.padding=this.buttonPadding,r.contrast=this.buttonContrast,r.pressColor=this.titleBarColor.darker(20),r.fixLayout(),r.refresh(),this.srcBar.add(r)},Xt.prototype.fixListFieldItemColors=function(){this.listField.contents.children[0].alpha=0,this.listField.contents.children[0].children.forEach((t=>{t.pressColor=this.titleBarColor.darker(20),t.color=new o.Il(0,0,0,0)}))},Xt.prototype.buildFilterField=function(){var t=this;this.filterField=new ct(""),this.magnifyingGlass=new s("magnifyingGlass",this.filterField.height(),this.titleBarColor.darker(50)),this.body.add(this.magnifyingGlass),this.body.add(this.filterField),this.filterField.reactToInput=function(e){var o=this.getValue();t.listField.elements=t.projectList.filter((t=>{var e=t.projectname||t.name,i=t.notes||"";return e.toLowerCase().indexOf(o.toLowerCase())>-1||i.toLowerCase().indexOf(o.toLowerCase())>-1})),0===t.listField.elements.length&&t.listField.elements.push("(no matches)"),t.clearDetails(),t.listField.buildListContents(),t.fixListFieldItemColors(),t.listField.adjustScrollBars(),t.listField.scrollY(t.listField.top()),t.fixLayout()}},Xt.prototype.setSource=function(t){var e;switch(this.source=t,this.srcBar.children.forEach((t=>t.refresh())),this.source){case"cloud":return e=this.ide.showMessage("Updating\nproject list..."),this.projectList=[],void this.ide.cloud.getProjectList((t=>{"cloud"===this.source&&this.installCloudProjectList(t.projects),e.destroy()}),((t,o)=>{e.destroy(),this.ide.cloudError().call(null,t,o)}));case"examples":this.projectList=this.getExamplesProjectList();break;case"local":this.projectList=this.getLocalProjectList();break;case"disk":if("save"!==this.task)return this.destroy(),void this.ide.importLocalFile();this.projectList=[]}this.listField.destroy(),this.listField=new o.NT(this.projectList,this.projectList.length>0?t=>t.name||t:null,null,(()=>this.ok())),"disk"===this.source&&this.listField.hide(),this.fixListFieldItemColors(),this.listField.fixLayout=o.WY,this.listField.edge=ct.prototype.edge,this.listField.fontSize=ct.prototype.fontSize,this.listField.typeInPadding=ct.prototype.typeInPadding,this.listField.contrast=ct.prototype.contrast,this.listField.render=ct.prototype.render,this.listField.drawRectBorder=ct.prototype.drawRectBorder,"local"===this.source?this.listField.action=t=>{var e,o;void 0!==t&&(this.nameField&&this.nameField.setContents(t.name||""),"open"===this.task&&(e=localStorage["-snap-project-"+t.name])&&(o=this.ide.serializer.parse(e),this.notesText.text=o.childNamed("notes").contents||"",this.notesText.rerender(),this.notesField.contents.adjustBounds(),this.preview.texture=o.childNamed("thumbnail").contents||null,this.preview.cachedTexture=null,this.preview.rerender()),this.edit())}:this.listField.action=t=>{var e,o;void 0!==t&&(this.nameField&&this.nameField.setContents(t.name||""),e=this.ide.getURL(this.ide.resourceURL("Examples",t.fileName)),o=this.ide.serializer.parse(e),this.notesText.text=o.childNamed("notes").contents||"",this.notesText.rerender(),this.notesField.contents.adjustBounds(),this.preview.texture=o.childNamed("thumbnail").contents||null,this.preview.cachedTexture=null,this.preview.rerender(),this.edit())},this.body.add(this.listField),this.shareButton.hide(),this.unshareButton.hide(),"open"===this.task&&this.recoverButton.hide(),this.publishButton.hide(),this.unpublishButton.hide(),"local"===this.source?this.deleteButton.show():this.deleteButton.hide(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails()},Xt.prototype.hasLocalProjects=function(){return Object.keys(localStorage).some((t=>0===t.indexOf("-snap-project-")))},Xt.prototype.getLocalProjectList=function(){var t,e,o=[];for(t in localStorage)Object.prototype.hasOwnProperty.call(localStorage,t)&&"-snap-project-"===t.substr(0,14)&&(e={name:t.substr(14),thumb:null,notes:null},o.push(e));return o.sort(((t,e)=>t.name.toLowerCase()<e.name.toLowerCase()?-1:1)),o},Xt.prototype.getExamplesProjectList=function(){return this.ide.getMediaList("Examples")},Xt.prototype.installCloudProjectList=function(t){this.projectList=t[0]?t:[],this.projectList.sort(((t,e)=>t.projectname.toLowerCase()<e.projectname.toLowerCase()?-1:1)),this.listField.destroy(),this.listField=new o.NT(this.projectList,this.projectList.length>0?t=>t.projectname||t:null,[["bold",t=>t.ispublic],["italic",t=>t.ispublished]],(()=>this.ok())),this.fixListFieldItemColors(),this.listField.fixLayout=o.WY,this.listField.edge=ct.prototype.edge,this.listField.fontSize=ct.prototype.fontSize,this.listField.typeInPadding=ct.prototype.typeInPadding,this.listField.contrast=ct.prototype.contrast,this.listField.render=ct.prototype.render,this.listField.drawRectBorder=ct.prototype.drawRectBorder,this.listField.action=t=>{void 0!==t&&(this.nameField&&this.nameField.setContents(t.projectname||""),"open"===this.task&&(this.notesText.text=t.notes||"",this.notesText.rerender(),this.notesField.contents.adjustBounds(),this.preview.texture="",this.preview.rerender(),this.ide.cloud.getThumbnail(null,t.projectname,(t=>{this.preview.texture=t,this.preview.cachedTexture=null,this.preview.rerender()})),new o.KE(new o.$1((0,o.NC)("last changed")+"\n"+t.lastupdated,null,null,null,null,"center")).popUp(this.world(),this.preview.rightCenter().add(new o.E9(2,0)))),t.ispublic?(this.shareButton.hide(),this.unshareButton.show(),t.ispublished?(this.publishButton.hide(),this.unpublishButton.show()):(this.publishButton.show(),this.unpublishButton.hide())):(this.unshareButton.hide(),this.shareButton.show(),this.publishButton.hide(),this.unpublishButton.hide()),this.buttons.fixLayout(),this.fixLayout(),this.edit())},this.body.add(this.listField),"open"===this.task&&this.recoverButton.show(),this.shareButton.show(),this.unshareButton.hide(),this.deleteButton.show(),this.buttons.fixLayout(),this.fixLayout(),"open"===this.task&&this.clearDetails()},Xt.prototype.clearDetails=function(){this.notesText.text="",this.notesText.rerender(),this.notesField.contents.adjustBounds(),this.preview.texture=null,this.preview.cachedTexture=null,this.preview.rerender()},Xt.prototype.recoveryDialog=function(){var t=this.listField.selected;t&&(this.removeShadow(),this.hide(),new Jt(this.ide,t.projectname,this).popUp())},Xt.prototype.recoveryDialog=function(){var t=this.listField.selected;t&&(new Jt(this.ide,t.projectname,this).popUp(),this.hide())},Xt.prototype.openProject=function(){var t,e=this.listField.selected;e&&(this.ide.source=this.source,"cloud"===this.source?this.openCloudProject(e):"examples"===this.source?(t=this.ide.getURL(this.ide.resourceURL("Examples",e.fileName)),this.ide.openProjectString(t),this.destroy()):(this.ide.source=null,this.ide.openProject(e.name),this.destroy()))},Xt.prototype.openCloudProject=function(t,e){this.ide.nextSteps([()=>this.ide.showMessage("Fetching project\nfrom the cloud..."),()=>this.rawOpenCloudProject(t,e)])},Xt.prototype.rawOpenCloudProject=function(t,e){this.ide.cloud.getProject(t.projectname,e,(e=>{this.ide.source="cloud",this.ide.nextSteps([()=>this.ide.openCloudDataString(e)]),location.hash="",t.ispublic&&(location.hash="#present:Username="+encodeURIComponent(this.ide.cloud.username)+"&ProjectName="+encodeURIComponent(t.projectname))}),this.ide.cloudError()),this.destroy()},Xt.prototype.saveProject=function(){var t=this.nameField.contents().text.text,e=this.notesText.text;this.ide.projectNotes!==e&&(this.ide.projectNotes=e),t&&("cloud"===this.source?(0,o.qY)(this.projectList,(e=>e.projectname===t))?this.ide.confirm((0,o.NC)("Are you sure you want to replace")+'\n"'+t+'"?',"Replace Project",(()=>{this.ide.setProjectName(t),this.saveCloudProject()})):(this.ide.setProjectName(t),this.saveCloudProject()):"disk"===this.source&&(this.ide.exportProject(t,!1),this.ide.source="disk",this.destroy()))},Xt.prototype.saveCloudProject=function(){this.ide.source="cloud",this.ide.saveProjectToCloud(),this.destroy()},Xt.prototype.deleteProject=function(){var t,e,i;"cloud"===this.source?(t=this.listField.selected)&&this.ide.confirm((0,o.NC)("Are you sure you want to delete")+'\n"'+t.projectname+'"?',"Delete Project",(()=>this.ide.cloud.deleteProject(t.projectname,null,(()=>{this.ide.hasChangedMedia=!0,e=this.projectList.indexOf(t),this.projectList.splice(e,1),this.installCloudProjectList(this.projectList)}),this.ide.cloudError()))):this.listField.selected&&(i=this.listField.selected.name,this.ide.confirm((0,o.NC)("Are you sure you want to delete")+'\n"'+i+'"?',"Delete Project",(()=>{delete localStorage["-snap-project-"+i],this.setSource(this.source)})))},Xt.prototype.shareProject=function(){var t=this.ide,e=this.listField.selected,i=this.listField.active;e&&this.ide.confirm((0,o.NC)("Are you sure you want to share")+'\n"'+e.projectname+'"?',"Share Project",(()=>{e.ProjectName,t.projectName,t.showMessage("sharing\nproject..."),t.cloud.shareProject(e.projectname,null,(()=>{if(e.ispublic=!0,this.unshareButton.show(),this.shareButton.hide(),this.publishButton.show(),this.unpublishButton.hide(),i.label.isBold=!0,i.label.rerender(),this.buttons.fixLayout(),this.rerender(),this.ide.showMessage("shared.",2),e.projectname===t.projectName){var o=t.cloud.username,s="Username="+encodeURIComponent(o.toLowerCase())+"&ProjectName="+encodeURIComponent(e.projectname);location.hash="present:"+s}}),this.ide.cloudError())}))},Xt.prototype.unshareProject=function(){var t=this.ide,e=this.listField.selected,i=this.listField.active;e&&this.ide.confirm((0,o.NC)("Are you sure you want to unshare")+'\n"'+e.projectname+'"?',"Unshare Project",(()=>{t.showMessage("unsharing\nproject..."),t.cloud.unshareProject(e.projectname,null,(()=>{e.ispublic=!1,this.shareButton.show(),this.unshareButton.hide(),this.publishButton.hide(),this.unpublishButton.hide(),i.label.isBold=!1,i.label.isItalic=!1,i.label.rerender(),this.buttons.fixLayout(),this.rerender(),this.ide.showMessage("unshared.",2),e.projectname===t.projectName&&(location.hash="")}),this.ide.cloudError())}))},Xt.prototype.publishProject=function(){var t=this.ide,e=this.listField.selected,i=this.listField.active;e&&this.ide.confirm((0,o.NC)("Are you sure you want to publish")+'\n"'+e.projectname+'"?',"Publish Project",(()=>{t.showMessage("publishing\nproject..."),t.cloud.publishProject(e.projectname,null,(()=>{if(e.ispublished=!0,this.unshareButton.show(),this.shareButton.hide(),this.publishButton.hide(),this.unpublishButton.show(),i.label.isItalic=!0,i.label.rerender(),this.buttons.fixLayout(),this.rerender(),this.ide.showMessage("published.",2),e.projectname===t.projectName){var o=t.cloud.username,s="Username="+encodeURIComponent(o.toLowerCase())+"&ProjectName="+encodeURIComponent(e.projectname);location.hash="present:"+s}}),this.ide.cloudError())}))},Xt.prototype.unpublishProject=function(){var t=this.listField.selected,e=this.listField.active;t&&this.ide.confirm((0,o.NC)("Are you sure you want to unpublish")+'\n"'+t.projectname+'"?',"Unpublish Project",(()=>{this.ide.showMessage("unpublishing\nproject..."),this.ide.cloud.unpublishProject(t.projectname,null,(()=>{t.ispublished=!1,this.unshareButton.show(),this.shareButton.hide(),this.publishButton.show(),this.unpublishButton.hide(),e.label.isItalic=!1,e.label.rerender(),this.buttons.fixLayout(),this.rerender(),this.ide.showMessage("unpublished.",2)}),this.ide.cloudError())}))},Xt.prototype.edit=function(){this.nameField?this.nameField.edit():this.filterField&&this.filterField.edit()},Xt.prototype.fixLayout=function(){var t=(0,o.SW)(this.titleFontSize)+2*this.titlePadding,e=this.padding/2,i=this.nameField||this.filterField;this.buttons&&this.buttons.children.length>0&&this.buttons.fixLayout(),this.body&&(this.body.setPosition(this.position().add(new o.E9(this.padding,t+this.padding))),this.body.setExtent(new o.E9(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height())),this.srcBar.setPosition(this.body.position()),i.setWidth(this.body.width()-this.srcBar.width()-6*this.padding),i.setLeft(this.srcBar.right()+3*this.padding),i.setTop(this.srcBar.top()),this.listField.setLeft(this.srcBar.right()+this.padding),this.listField.setWidth(this.body.width()-this.srcBar.width()-this.preview.width()-this.padding-e),this.listField.contents.children[0].adjustWidths(),this.listField.setTop(i.bottom()+this.padding),this.listField.setHeight(this.body.height()-i.height()-this.padding),this.magnifyingGlass&&(this.magnifyingGlass.setTop(i.top()),this.magnifyingGlass.setLeft(this.listField.left())),this.preview.setRight(this.body.right()),this.preview.setTop(i.bottom()+this.padding),this.notesField.setTop(this.preview.bottom()+e),this.notesField.setLeft(this.preview.left()),this.notesField.setHeight(this.body.bottom()-this.preview.bottom()-e)),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&this.buttons.children.length>0&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),this.removeShadow(),this.addShadow()},Jt.prototype=new lt,Jt.prototype.constructor=Jt,Jt.uber=lt.prototype,Jt.prototype.init=function(t,e,o){Jt.uber.init.call(this,this,null,null),this.ide=t,this.browser=o,this.key="recoverProject",this.projectName=e,this.versions=null,this.handle=null,this.listField=null,this.preview=null,this.notesText=null,this.notesField=null,this.labelString="Recover project",this.createLabel(),this.buildContents()},Jt.prototype.buildContents=function(){this.addBody(new o._V),this.body.color=this.color,this.buildListField(),this.preview=new o._V,this.preview.fixLayout=o.WY,this.preview.edge=ct.prototype.edge,this.preview.fontSize=ct.prototype.fontSize,this.preview.typeInPadding=ct.prototype.typeInPadding,this.preview.contrast=ct.prototype.contrast,this.preview.drawNew=function(){ct.prototype.drawNew.call(this),this.texture&&this.drawTexture(this.texture)},this.preview.drawCachedTexture=function(){this.image.getContext("2d").drawImage(this.cachedTexture,this.edge,this.edge),this.changed()},this.preview.drawRectBorder=ct.prototype.drawRectBorder,this.preview.setExtent(this.ide.serializer.thumbnailSize.add(2*this.preview.edge)),this.body.add(this.preview),this.preview.drawNew(),this.notesField=new o.yR,this.notesField.fixLayout=o.WY,this.notesField.edge=ct.prototype.edge,this.notesField.fontSize=ct.prototype.fontSize,this.notesField.typeInPadding=ct.prototype.typeInPadding,this.notesField.contrast=ct.prototype.contrast,this.notesField.drawNew=ct.prototype.drawNew,this.notesField.drawRectBorder=ct.prototype.drawRectBorder,this.notesField.acceptsDrops=!1,this.notesField.contents.acceptsDrops=!1,this.notesText=new o.$1(""),this.notesField.isTextLineWrapping=!0,this.notesField.padding=3,this.notesField.setContents(this.notesText),this.notesField.setWidth(this.preview.width()),this.body.add(this.notesField),this.addButton("recoverProject","Recover"),this.addButton("cancel","Cancel"),this.setExtent(new o.E9(360,300)),this.fixLayout()},Jt.prototype.buildListField=function(){var t=this;this.listField=new o.NT([]),this.fixListFieldItemColors(),this.listField.fixLayout=o.WY,this.listField.edge=ct.prototype.edge,this.listField.fontSize=ct.prototype.fontSize,this.listField.typeInPadding=ct.prototype.typeInPadding,this.listField.contrast=ct.prototype.contrast,this.listField.drawNew=ct.prototype.drawNew,this.listField.drawRectBorder=ct.prototype.drawRectBorder,this.listField.action=function(e){var i;void 0!==e&&(i=(0,o.qY)(t.versions,(function(t){return t.lastupdated===e})),t.notesText.text=i.notes||"",t.notesText.drawNew(),t.notesField.contents.adjustBounds(),t.preview.texture=i.thumbnail,t.preview.cachedTexture=null,t.preview.drawNew())},this.ide.cloud.getProjectVersionMetadata(this.projectName,(function(e){var i=new Date,s=new Date;s.setDate(i.getDate()-1),t.versions=e,t.versions.forEach((function(t){var e=new Date((new Date).getTime()-1e3*t.lastupdated);e.toDateString()===i.toDateString()?t.lastupdated=(0,o.NC)("Today, ")+e.toLocaleTimeString():e.toDateString()===s.toDateString()?t.lastupdated=(0,o.NC)("Yesterday, ")+e.toLocaleTimeString():t.lastupdated=e.toLocaleString()})),t.listField.elements=t.versions.map((function(t){return t.lastupdated})),t.clearDetails(),t.listField.buildListContents(),t.fixListFieldItemColors(),t.listField.adjustScrollBars(),t.listField.scrollY(t.listField.top()),t.fixLayout()}),this.ide.cloudError()),this.body.add(this.listField)},Jt.prototype.cancel=function(){var t=this;this.browser.show(),this.browser.listField.select((0,o.qY)(this.browser.projectList,(function(e){return e.projectname===t.projectName}))),Jt.uber.cancel.call(this)},Jt.prototype.recoverProject=function(){var t=this.listField.selected,e=(0,o.qY)(this.versions,(function(e){return e.lastupdated===t}));this.browser.openCloudProject({projectname:this.projectName},e.delta),this.destroy()},Jt.prototype.popUp=function(){var t=this.ide.world();t&&(Jt.uber.popUp.call(this,t),this.handle=new o.LG(this,300,300,this.corner,this.corner))},Jt.prototype.fixListFieldItemColors=Xt.prototype.fixListFieldItemColors,Jt.prototype.clearDetails=Xt.prototype.clearDetails,Jt.prototype.fixLayout=function(){var t=(0,o.SW)(this.titleFontSize)+2*this.titlePadding,e=this.padding/2,i=o._V.prototype.trackChanges;o._V.prototype.trackChanges=!1,this.body&&(this.body.setPosition(this.position().add(new o.E9(this.padding,t+this.padding))),this.body.setExtent(new o.E9(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height())),this.listField.setWidth(this.body.width()-this.preview.width()-this.padding),this.listField.contents.children[0].adjustWidths(),this.listField.setPosition(this.body.position()),this.listField.setHeight(this.body.height()),this.preview.setRight(this.body.right()),this.preview.setTop(this.listField.top()),this.notesField.setTop(this.preview.bottom()+e),this.notesField.setLeft(this.preview.left()),this.notesField.setHeight(this.body.bottom()-this.preview.bottom()-e)),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&(this.buttons.fixLayout(),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),o._V.prototype.trackChanges=i,this.changed()},Zt.prototype=new lt,Zt.prototype.constructor=Zt,Zt.uber=lt.prototype,Zt.prototype.init=function(t,e){Zt.uber.init.call(this,this,null,null),this.ide=t,this.key="importLibrary",this.action="importLibrary",this.librariesData=e,this.libraryCache={},this.handle=null,this.listField=null,this.palette=null,this.notesText=null,this.notesField=null,this.labelString="Import library",this.createLabel(),this.buildContents()},Zt.prototype.buildContents=function(){this.addBody(new o._V),this.body.color=this.color,this.initializePalette(),this.initializeLibraryDescription(),this.installLibrariesList(),this.addButton("ok","Import"),this.addButton("cancel","Cancel"),this.setExtent(new o.E9(460,455)),this.fixLayout()},Zt.prototype.initializePalette=function(){this.palette&&this.palette.destroy(),this.palette=new o.yR(null,null,y.prototype.sliderColor),this.palette.color=y.prototype.paletteColor,this.palette.padding=4,this.palette.isDraggable=!1,this.palette.acceptsDrops=!1,this.palette.contents.acceptsDrops=!1,this.body.add(this.palette)},Zt.prototype.initializeLibraryDescription=function(){this.notesField&&this.notesField.destroy(),this.notesField=new o.yR,this.notesField.fixLayout=o.WY,this.notesField.edge=ct.prototype.edge,this.notesField.fontSize=ct.prototype.fontSize,this.notesField.typeInPadding=ct.prototype.typeInPadding,this.notesField.contrast=ct.prototype.contrast,this.notesField.render=ct.prototype.render,this.notesField.drawRectBorder=ct.prototype.drawRectBorder,this.notesField.acceptsDrops=!1,this.notesField.contents.acceptsDrops=!1,this.notesText=new o.$1(""),this.notesField.isTextLineWrapping=!0,this.notesField.padding=3,this.notesField.setContents(this.notesText),this.notesField.setHeight(100),this.body.add(this.notesField)},Zt.prototype.installLibrariesList=function(){this.listField&&this.listField.destroy(),this.listField=new o.NT(this.librariesData,(t=>t.name),null,(()=>this.importLibrary()),"~"),this.fixListFieldItemColors(),this.listField.fixLayout=o.WY,this.listField.edge=ct.prototype.edge,this.listField.fontSize=ct.prototype.fontSize,this.listField.typeInPadding=ct.prototype.typeInPadding,this.listField.contrast=ct.prototype.contrast,this.listField.render=ct.prototype.render,this.listField.drawRectBorder=ct.prototype.drawRectBorder,this.listField.action=t=>{(0,o.kK)(t)||(this.notesText.text=(0,o.NC)(t.description||""),this.notesText.rerender(),this.notesField.contents.adjustBounds(),this.hasCached(t.fileName)?this.displayBlocks(t.fileName):(this.showMessage((0,o.NC)("Loading")+"\n"+(0,o.NC)(t.name)),this.ide.getURL(this.ide.resourceURL("libraries",t.fileName),(e=>{this.cacheLibrary(t.fileName,this.ide.serializer.loadBlocks(e)),this.displayBlocks(t.fileName)}))))},this.listField.setWidth(200),this.body.add(this.listField),this.fixLayout()},Zt.prototype.popUp=function(){var t=this.ide.world();t&&(Zt.uber.popUp.call(this,t),this.handle=new o.LG(this,300,300,this.corner,this.corner))},Zt.prototype.fixListFieldItemColors=Xt.prototype.fixListFieldItemColors,Zt.prototype.clearDetails=Xt.prototype.clearDetails,Zt.prototype.fixLayout=function(){var t=(0,o.SW)(this.titleFontSize)+2*this.titlePadding,e=this.padding/2;this.body&&(this.body.setPosition(this.position().add(new o.E9(this.padding,t+this.padding))),this.body.setExtent(new o.E9(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height())),this.listField.setExtent(new o.E9(200,this.body.height())),this.notesField.setExtent(new o.E9(this.body.width()-this.listField.width()-e,100)),this.palette.setExtent(new o.E9(this.notesField.width(),this.body.height()-this.notesField.height()-e)),this.listField.contents.children[0].adjustWidths(),this.listField.setPosition(this.body.position()),this.palette.setPosition(this.listField.topRight().add(new o.E9(e,0))),this.notesField.setPosition(this.palette.bottomLeft().add(new o.E9(0,e)))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&(this.buttons.fixLayout(),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),this.removeShadow(),this.addShadow()},Zt.prototype.hasCached=function(t){return this.libraryCache.hasOwnProperty(t)},Zt.prototype.cacheLibrary=function(t,e){this.libraryCache[t]=e},Zt.prototype.cachedLibrary=function(t){return this.libraryCache[t]},Zt.prototype.importLibrary=function(){if(this.listField.selected){var t=this.ide,e=this.listField.selected.fileName,i=this.listField.selected.name;this.hasCached(e)?(this.cachedLibrary(e).forEach((e=>{e.receiver=t.stage,t.stage.globalBlocks.push(e),t.stage.replaceDoubleDefinitionsFor(e)})),t.showMessage((0,o.NC)("Imported")+" "+(0,o.NC)(i),2)):(t.showMessage((0,o.NC)("Loading")+" "+(0,o.NC)(i)),t.getURL(t.resourceURL("libraries",e),(function(e){t.droppedText(e,i)})))}},Zt.prototype.displayBlocks=function(t){var e,i,s,r,n,a=this.cachedLibrary(t);a.length&&(this.initializePalette(),e=this.palette.left()+4,i=this.palette.top(),y.prototype.categories.forEach((t=>{a.forEach((a=>{a.category===t&&(t!==r&&(i+=4),r=t,s=a.templateInstance().fullImage(),(n=new o._V).isCachingImage=!0,n.bounds.setWidth(s.width),n.bounds.setHeight(s.height),n.cachedImage=s,n.setPosition(new o.E9(e,i)),this.palette.addContents(n),i+=n.fullBounds().height()+4)}))})),this.palette.scrollX(4),this.palette.scrollY(4),this.fixLayout())},Zt.prototype.showMessage=function(t){var e=new o.wR(null,t);this.initializePalette(),this.fixLayout(),e.popUpCenteredInWorld(this.palette.contents)},y.prototype.makeBlock=function(){var t,e=this.parentThatIsA(Kt),o=this.parentThatIsA(b),i=e.currentCategory,s=y.prototype.blockColor[i];t=new bt(null,(t=>{""!==t.spec&&(t.isGlobal?o.globalBlocks.push(t):this.customBlocks.push(t),e.flushPaletteCache(),e.refreshPalette(),new $t(t,this).popUp())}),this),"variables"!==i&&(t.category=i,t.categories.children.forEach((t=>t.refresh())),t.types.children.forEach((t=>{t.setColor(s),t.refresh()}))),t.prompt("Make a block",null,this.world())},gt.prototype.isInUse=function(){var t=this.definition,e=this.scriptTarget(),o=e.parentThatIsA(Kt);return t.isGlobal&&o?o.sprites.asArray().concat([o.stage]).some(((e,o)=>e.usesBlockInstance(t,!1,o))):e.allDependentInvocationsOf(this.blockSpec).length>0},gt.prototype.userMenu=function(){var t,e=this.parentThatIsA(wt),i=this.scriptTarget(),s=this;function r(e,i,s,r,n){t.addItem((s?"☑ ":"☐ ")+(0,o.NC)(e),i,s?r:n)}return this.isPrototype?((t=new o.wR(this)).addItem("script pic...",(function(){var t=this.world().children[0];t.saveCanvasAs(this.topBlock().scriptPic(),(t.projectName||(0,o.NC)("untitled"))+" "+(0,o.NC)("script pic"))}),"open a new window\nwith a picture of this script"),t.addItem("translations...",(function(){e.parentThatIsA($t).editTranslations()}),"experimental -\nunder construction"),this.isGlobal&&(e.inputs().length<2?t.addItem("block variables...",(function(){e.enableBlockVars()}),"experimental -\nunder construction"):t.addItem("remove block variables...",(function(){e.enableBlockVars(!1)}),"experimental -\nunder construction"))):((t=this.constructor.uber.userMenu.call(this))?t.addLine():t=new o.wR(this),this.isTemplate?(this.isGlobal?t.addItem("delete block definition...","deleteBlockDefinition"):(0,o.r3)(Object.keys(i.inheritedBlocks()),this.blockSpec)?r("inherited",(function(){var t=s.parentThatIsA(Kt);i.customBlocks.push(i.getMethod(s.blockSpec).copyAndBindTo(i)),t&&(t.flushPaletteCache(),t.refreshPalette())}),!0,"uncheck to\ndisinherit",null):i.exemplar&&i.exemplar.getMethod(this.blockSpec)?r("inherited","deleteBlockDefinition",!1,null,(0,o.NC)("check to inherit\nfrom")+" "+i.exemplar.name):t.addItem("delete block definition...","deleteBlockDefinition"),t.addItem("duplicate block definition...","duplicateBlockDefinition"),this.isGlobal&&t.addItem("export block definition...","exportBlockDefinition","including dependencies")):(this.isGlobal||(0,o.r3)(Object.keys(i.ownBlocks()),this.blockSpec))&&t.addItem("delete block definition...","deleteBlockDefinition"),this.variables.names().forEach((e=>function(e){var r=i.parentThatIsA(b),n=s.variables;t.addItem(e+"...",(function(){var t,i=(0,o.qY)(r.children,(function(t){return t instanceof B&&t.target===n&&t.getter===e}));if(null!==i)return i.show(),void i.fixLayout();(i=new B(e+" "+(0,o.NC)("(temporary)"),y.prototype.blockColor.variables,n,e)).setPosition(r.position().add(10)),(t=r.watchers(i.left())).length>0&&i.setTop(t[t.length-1].bottom()),r.add(i),i.fixLayout()}))}(e)))),t.addItem("edit...","edit"),t},gt.prototype.exportBlockDefinition=function(){new Tt(this.parentThatIsA(Kt).serializer,[this.definition].concat(this.definition.collectDependencies())).popUp(this.world())},gt.prototype.duplicateBlockDefinition=function(){var t=this.scriptTarget(),e=this.parentThatIsA(Kt),o=(this.isGlobal?this.definition:t.getMethod(this.blockSpec)).copyAndBindTo(t),i=o.spec,s=1;for(this.isGlobal?e.stage.globalBlocks.push(o):t.customBlocks.push(o);t.doubleDefinitionsFor(o).length>0;)s+=1,o.spec=i+" ("+s+")";e.flushPaletteCache(),e.refreshPalette(),new $t(o,t).popUp()},gt.prototype.deleteBlockDefinition=function(){var t,e,i,s,r,n=this.scriptTarget();if(this.isPrototype)return null;s=this.isGlobal?this.definition:n.getLocalMethod(this.blockSpec),r=s.blockInstance(),new lt(this,(()=>{n.deleteAllBlockInstances(s),s.isGlobal?(e=n.parentThatIsA(b),-1!==(t=e.globalBlocks.indexOf(s))&&e.globalBlocks.splice(t,1)):(-1!==(t=n.customBlocks.indexOf(s))&&n.customBlocks.splice(t,1),(s=n.getMethod(this.blockSpec))&&n.allDependentInvocationsOf(this.blockSpec).forEach((t=>t.refresh(s)))),(i=n.parentThatIsA(Kt))&&(i.flushPaletteCache(),i.refreshPalette())}),this).askYesNo("Delete Custom Block",(0,o.NC)("block deletion dialog text"),this.world(),r.doWithAlpha(1,(()=>(r.addShadow(),r.fullImage()))))},bt.prototype.addCategoryButton=function(t){var e,i=[Kt.prototype.frameColor,Kt.prototype.frameColor.darker(o.tU.isFlat?5:50),y.prototype.blockColor[t]];return(e=new rt(i,this,(()=>{this.category=t,this.categories.children.forEach((t=>t.refresh())),this.types&&this.types.children.forEach((t=>t.setColor(i[2]))),this.edit()}),t[0].toUpperCase().concat(t.slice(1)),(()=>this.category===t),null,null,75,!0)).corner=8,e.padding=0,e.labelShadowOffset=new o.E9(-1,-1),e.labelShadowColor=i[1],e.labelColor=Kt.prototype.buttonLabelColor,o.tU.isFlat&&(e.labelPressColor=o.Cj),e.contrast=this.buttonContrast,e.fixLayout(),e.refresh(),this.categories.add(e),e},$t.prototype=new lt,$t.prototype.constructor=$t,$t.uber=lt.prototype,$t.showing=[],$t.prototype.ok=function(){$t.uber.ok.apply(this,arguments)},$t.prototype.destroy=function(){$t.uber.destroy.apply(this,arguments);var t=$t.showing.indexOf(this);t>=0&&$t.showing.splice(t,1)},$t.defaultHatBlockMargin=new o.E9(10,10),$t.prototype.getDefinitionJSON=function(){var t=this.definition;return t?{spec:t.spec,category:t.category,type:t.type,guid:t.guid}:null},$t.prototype.init=function(t,e){var i,s,r,n,h,l=a.prototype.enableLiveCoding||a.prototype.enableSingleStepping;this.definition=t,this.translations=t.translationsAsText(),this.handle=null,$t.uber.init.call(this,e,(()=>this.updateDefinition()),e),this.key="editBlock"+t.spec,this.labelString=this.definition.isGlobal?"Block Editor":"Method Editor",this.createLabel(),A.copyIDs=!0,(i=new N).rejectsHats=!0,i.isDraggable=!1,i.color=Kt.prototype.groupColor,i.cachedTexture=Kt.prototype.scriptsPaneTexture,i.cleanUpMargin=10,(s=new wt(this.definition)).setPosition(i.position().add($t.defaultHatBlockMargin)),null!==t.comment&&(h=t.comment.fullCopy(),s.comment=h,h.block=s),null!==t.body&&s.nextBlock(l?t.body.expression:t.body.expression.fullCopy()),i.add(s),s.fixBlockColor(null,!0),this.definition.scripts.forEach((t=>{(n=t.fullCopy()).setPosition(i.position().add(t.position())),i.add(n),n instanceof A&&n.allComments().forEach((t=>t.align(n)))})),s.allComments().forEach((t=>t.align(s))),A.copyIDs=!1,(r=new o.yR(i)).padding=10,r.growth=50,r.isDraggable=!1,r.acceptsDrops=!1,r.contents.acceptsDrops=!0,i.scrollFrame=r,i.updateToolbar(),this.addBody(r),this.addButton("ok","OK"),l||(this.addButton("updateDefinition","Apply"),this.addButton("cancel","Cancel")),this.setExtent(new o.E9(400,350).add($t.defaultHatBlockMargin)),this.fixLayout(),i.fixMultiArgs(),(n=s.parts()[0]).forceNormalColoring(),n.fixBlockColor(s,!0)},$t.prototype.popUp=function(){var t=this.target.world();$t.showing.push(this),t&&($t.uber.popUp.call(this,t),this.setInitialDimensions(),this.handle=new o.LG(this,280,220,this.corner,this.corner),t.keyboardFocus=null)},$t.prototype.justDropped=function(){(0,o.WY)()},$t.prototype.accept=function(t){t instanceof CursorMorph||(this.action&&("function"==typeof this.target?"function"==typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action):"function"==typeof this.action?this.action.call(this.target,this.getInput()):this.target[this.action](this.getInput())),this.close())},$t.prototype.cancel=function(t){t instanceof CursorMorph||this.close()},$t.prototype.close=function(){var t,e;return this.definition.isGlobal&&(e=(0,o.qY)(this.body.contents.allChildren(),(t=>t.isCustomBlock&&!t.isGlobal)))?((e=e.scriptTarget().getMethod(e.semanticSpec).blockInstance()).addShadow(),void(new lt).inform("Local Block(s) in Global Definition","This global block definition contains one or more\nlocal custom blocks which must be removed first.",this.world(),e.doWithAlpha(1,(()=>e.fullImage())))):(t=this.target.doubleDefinitionsFor(this.definition)).length>0?((e=t[0].blockInstance()).addShadow(),void new lt(this,"consolidateDoubles",this).askYesNo("Same Named Blocks","Another custom block with this name exists.\nWould you like to replace it?",this.world(),e.doWithAlpha(1,(()=>e.fullImage())))):(this.destroy(),void this.deduplicateBlockIDs())},$t.prototype.consolidateDoubles=function(){this.target.replaceDoubleDefinitionsFor(this.definition),this.deduplicateBlockIDs(),this.destroy()},$t.prototype.refreshAllBlockInstances=function(t){var e=this.definition,o=this.target.paletteBlockInstance(e);this.definition.isGlobal?this.target.allBlockInstances(this.definition).reverse().forEach((t=>t.refresh())):this.target.allDependentInvocationsOf(t).reverse().forEach((t=>t.refresh(e))),o&&o.refreshDefaults()},$t.prototype.deduplicateBlockIDs=function(){var t=this.definition,e=function e(i,s){if(s=s||[],i==t||null==i)return s;i instanceof A&&s.push(i.id),i instanceof y&&e(i.customBlocks),i instanceof b&&e(i.globalBlocks);var r=i.children||i;return r instanceof Array?(r.forEach((function(t){t instanceof o._V&&e(t,s)})),s):s}(this.root()),i=t.scripts.slice();this.definition.body&&i.push(this.definition.body.expression),i.forEach((function(t){null!=t&&t.allChildren&&t.allChildren().forEach((function(t){t instanceof A&&e.includes(t.id)&&t.getNewID()}))}))},$t.prototype.updateDefinition=function(){var t=this.definition.blockSpec();this.applyToDefinition(this.definition),this.refreshAllBlockInstances(t),ide=this.target.parentThatIsA(Kt),ide.flushPaletteCache(),ide.refreshPalette()},$t.prototype.applyToDefinition=function(t){var e,o,i=this.body.contents.position(),s=1;for(A.copyIDs=!0,t.receiver=this.target,t.spec=this.prototypeSpec(),t.declarations=this.prototypeSlots(),t.variableNames=this.variableNames(),t.scripts=[],t.updateTranslations(this.translations),t.cachedTranslation=null,t.editorDimensions=this.bounds.copy(),t.cachedIsRecursive=null,this.body.contents.children.forEach((s=>{s instanceof wt?e=s:(s instanceof A||s instanceof ot&&!s.block)&&((o=s.fullCopy()).parent=null,o.setPosition(s.position().subtract(i)),t.scripts.push(o))})),e&&(t.category!==e.blockCategory&&this.target.shadowAttribute("scripts"),t.category=e.blockCategory,t.type=e.type,e.comment?(t.comment=e.comment.fullCopy(),t.comment.block=!0):t.comment=null),t.body=this.context(e),A.copyIDs=!1;this.target.doubleDefinitionsFor(this.definition).length>0;)s+=1,this.definition.spec=this.definition.spec+" ("+s+")"},$t.prototype.context=function(t){var e,i;return null===(e=(t||(0,o.qY)(this.body.contents.children,(t=>t instanceof wt))).nextBlock())?null:(e.allChildren().forEach((t=>{t instanceof A&&(t.cachedInputs=null)})),(i=a.prototype.reify.call(null,e,new d(this.definition.inputNames()),!0)).outerContext=null,i)},$t.prototype.prototypeSpec=function(){return(0,o.qY)(this.body.contents.children,(t=>t instanceof wt)).parts()[0].specFromFragments()},$t.prototype.prototypeSlots=function(){return(0,o.qY)(this.body.contents.children,(t=>t instanceof wt)).parts()[0].declarationsFromFragments()},$t.prototype.variableNames=function(){return(0,o.qY)(this.body.contents.children,(t=>t instanceof wt)).variableNames()},$t.prototype.editTranslations=function(){var t=this.definition.blockInstance();t.addShadow(new o.E9(3,3)),new lt(this,(t=>this.translations=t),this).promptCode("Custom Block Translations",this.translations,this.world(),t.doWithAlpha(1,(()=>t.fullImage())),this.definition.abstractBlockSpec()+"\n\n"+(0,o.NC)('Enter one translation per line. use colon (":") as lang/spec delimiter\nand underscore ("_") as placeholder for an input, e.g.:\n\nen:say _ for _ secs'))},$t.prototype.setInitialDimensions=function(){var t=this.world(),e=t.extent().subtract(new o.E9(this.padding,this.padding)),i=(0,o.SW)(this.titleFontSize)+2*this.titlePadding,s=this.buttons.height();if(this.definition.editorDimensions)return this.setPosition(this.definition.editorDimensions.origin),this.setExtent(this.definition.editorDimensions.extent().min(e)),void this.keepWithin(t);this.setExtent(this.body.contents.extent().add(new o.E9(this.padding,this.padding+i+s)).min(e)),this.setCenter(this.world().center())},$t.prototype.fixLayout=function(){var t=(0,o.SW)(this.titleFontSize)+2*this.titlePadding;this.buttons&&this.buttons.children.length>0&&this.buttons.fixLayout(),this.body&&(this.body.setPosition(this.position().add(new o.E9(this.padding,t+this.padding))),this.body.setExtent(new o.E9(this.width()-2*this.padding,this.height()-3*this.padding-t-this.buttons.height()))),this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(t-this.label.height())/2)),this.buttons&&this.buttons.children.length>0&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding)),this.removeShadow(),this.addShadow()},gt.prototype.edit=function(){var t,e,i,s,r=this.definition;if(this.isPrototype)(e=this.definition.blockInstance()).addShadow(),i=this.parentThatIsA(wt),new bt(null,(t=>{t&&(i.blockCategory=t.category,i.type=t.type,this.refreshPrototype())}),this).openForChange("Change block",i.blockCategory,i.type,this.world(),e.doWithAlpha(1,(()=>e.fullImage())),this.isInUse());else{if(s=this.scriptTarget(),!this.isGlobal){if((0,o.r3)(Object.keys(s.inheritedBlocks()),this.blockSpec))return void this.duplicateBlockDefinition();r=s.getMethod(this.semanticSpec)}(t=new $t(r,s)).popUp(),t.changed()}},Tt.prototype.fixLayout=$t.prototype.fixLayout,Bt.prototype.fixLayout=$t.prototype.fixLayout,Pt.prototype.fixLayout=$t.prototype.fixLayout,Bt.prototype.importBlocks=function(t){var e=this.target.parentThatIsA(Kt);e&&(this.blocks.length>0?(this.blocks.forEach((t=>{t.receiver=e.stage,e.stage.globalBlocks.push(t),e.stage.replaceDoubleDefinitionsFor(t)})),e.flushPaletteCache(),e.refreshPalette(),e.showMessage("Imported Blocks Module"+(t?": "+t:"")+".",2)):(new lt).inform("Import blocks","no blocks were selected",this.world()))},Rt.prototype.fixLayout=$t.prototype.fixLayout,I.prototype.showBubble=function(t,e,i){var r,n,a,l,p=!1,c=this.parentThatIsA(Kt),d=this,f=this.rightCenter().add(new o.E9(2,0)),m=this.parentThatIsA(o.yR),w=this.world();if(void 0===t||!w)return null;t instanceof u?((l=t).update(!0),l.step=t.update,l.isDraggable=!1,l.expand(this.parentThatIsA(o.yR).extent()),p=!0):t instanceof At?((l=t).isDraggable=!1,l.expand(this.parentThatIsA(o.yR).extent()),p=!0):t instanceof o._V?g(t)?(a=t.thumbnail(new o.E9(40,40)),(l=new o._V).isCachingImage=!0,l.bounds.setWidth(a.width),l.bounds.setHeight(a.height),l.cachedImage=a,l.version=t.version,l.step=function(){this.version!==t.version&&(a=t.thumbnail(new o.E9(40,40)),this.cachedImage=a,this.version=t.version,this.changed())}):(a=t.fullImage(),(l=new o._V).isCachingImage=!0,l.bounds.setWidth(a.width),l.bounds.setHeight(a.height),l.cachedImage=a):t instanceof C?(a=t.thumbnail(new o.E9(40,40)),l=new o._V,(l=new o._V).isCachingImage=!0,l.bounds.setWidth(a.width),l.bounds.setHeight(a.height),l.cachedImage=a):t instanceof x?l=new s("notes",30):t instanceof h?(a=t.image(),(l=new o._V).isCachingImage=!0,l.bounds.setWidth(a.width),l.bounds.setHeight(a.height),l.cachedImage=a):"boolean"==typeof t?l=y.prototype.booleanMorph.call(null,t):(0,o.HD)(t)?(n=t.length>500?t.slice(0,500)+"...":t,l=new o.$1(n,this.fontSize)):null===t?l=new o.$1("",this.fontSize):0===t?l=new o.$1("0",this.fontSize):t.toString&&(l=new o.$1(t.toString(),this.fontSize)),c&&c.currentSprite!==i&&(i instanceof b?d=c.corral.stageIcon:i?(i.isTemporary&&(i=(0,o.qY)(i.allExemplars(),(t=>!t.isTemporary))),d=(0,o.qY)(c.corral.frame.contents.children,(t=>t.object===i))):i=c,f=d.center()),(r=new o.KE(l,null,Math.max(this.rounding-2,6),0)).popUp(w,f,p),e&&this.exportPictureWithResult(r),d instanceof Qt?r.keepWithin(c.corral):m&&r.keepWithin(m)},A.prototype.userMenu=function(){var t,e,i,r=new o.wR(this),n=this.world(),a=this,h=!1,l=16===n.currentKey,p=this.activeProcess(),c=this.topBlock(),d=p&&p.context&&p.context.outerContext?p.context.outerContext.variables.names():[];function u(t,e,i,n,a){r.addItem([new s(i?"checkedBox":"rectangle",.75*o.tU.menuFontSize),(0,o.NC)(t)],e,i?n:a)}return r.addItem("help...","showHelp"),this.isTemplate?(this.parent instanceof I?"reportGetVar"===this.selector&&(r.addLine(),r.addItem("rename...",(()=>this.refactorThisVar(!0)),"rename only\nthis reporter"),r.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable")):("reportGetVar"===this.selector?(i=this.scriptTarget(),this.isInheritedVariable(!1)?u("inherited",(()=>i.toggleInheritedVariable(this.blockSpec)),!0,"uncheck to\ndisinherit",null):(this.isInheritedVariable(!0)&&u("inherited",(()=>i.toggleInheritedVariable(this.blockSpec)),!1,null,(0,o.NC)("check to inherit\nfrom")+" "+i.exemplar.name),u("transient","toggleTransientVariable",this.isTransientVariable(),"uncheck to save contents\nin the project","check to prevent contents\nfrom being saved"),r.addLine(),r.addItem("rename...",(()=>this.refactorThisVar(!0)),"rename only\nthis reporter"),r.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable"))):"evaluateCustomBlock"!==this.selector&&r.addItem("hide","hidePrimitive"),b.prototype.enableInheritance&&(i=this.scriptTarget(),(e={xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",getCostumeIdx:"costume #",getVolume:"volume",getPan:"balance",reportShown:"shown?",getPenDown:"pen down?"}[this.selector])&&i&&i.exemplar&&(r.addLine(),u("inherited",(()=>i.toggleInheritanceForAttribute(e)),i.inheritsAttribute(e),"uncheck to\ndisinherit",(0,o.NC)("check to inherit\nfrom")+" "+i.exemplar.name))),b.prototype.enableCodeMapping&&(r.addLine(),r.addItem("header mapping...","mapToHeader"),r.addItem("code mapping...","mapToCode"))),r):(r.addLine(),"reportGetVar"===this.selector?r.addItem("rename...",(function(){var t=a.fullCopy();t.addShadow(),new lt(a,(function(t){a.userSetSpec(t)}),a).prompt("Variable name",a.blockSpec,n,t.doWithAlpha(1,(()=>t.fullImage())),H.prototype.getVarNamesDict.call(a))}),"rename only\nthis reporter"):y.prototype.blockAlternatives[this.selector]?r.addItem("relabel...",(()=>this.relabel(y.prototype.blockAlternatives[this.selector]))):this.isCustomBlock&&this.alternatives&&(t=this.alternatives()).length>0&&r.addItem("relabel...",(()=>this.relabel(t))),(0,o.r3)(["reportMap","reportKeep","reportFindFirst","reportCombine"],this.selector)?(t={reportMap:"reportAtomicMap",reportKeep:"reportAtomicKeep",reportFindFirst:"reportAtomicFindFirst",reportCombine:"reportAtomicCombine"},r.addItem("compile",(()=>this.setSelector(t[this.selector])),"experimental!\nmake this reporter fast and uninterruptable\nCAUTION: Errors in the ring\ncan break your Snap! session!")):(0,o.r3)(["reportAtomicMap","reportAtomicKeep","reportAtomicFindFirst","reportAtomicCombine"],this.selector)?(t={reportAtomicMap:"reportMap",reportAtomicKeep:"reportKeep",reportAtomicFindFirst:"reportFindFirst",reportAtomicCombine:"reportCombine"},r.addItem("uncompile",(()=>this.setSelector(t[this.selector])))):(0,o.r3)(["reportPenTrailsAsCostume","reportPentrailsAsSVG"],this.selector)&&(t={reportPenTrailsAsCostume:"reportPentrailsAsSVG",reportPentrailsAsSVG:"reportPenTrailsAsCostume"},r.addItem((0,o.NC)(y.prototype.blocks[t[this.selector]].spec),(()=>{this.setSelector(t[this.selector]),this.changed()}))),r.addItem("duplicate",(()=>{var t=this.fullCopy(),e=this.parentThatIsA(Kt),o=this.parentThatIsA($t);t.pickUp(n),!e&&o&&(e=o.target.parentThatIsA(Kt)),e&&(n.hand.grabOrigin={origin:e.palette,position:e.palette.center()})}),"make a copy\nand pick it up"),this instanceof R&&this.nextBlock()&&(r.addItem((p?this.fullCopy():this).thumbnail(.5,60),(()=>{var t=this.fullCopy(),e=t.nextBlock(),o=this.parentThatIsA(Kt),i=this.parentThatIsA($t);e&&e.destroy(),t.pickUp(n),!o&&i&&(o=i.target.parentThatIsA(Kt)),o&&(n.hand.grabOrigin={origin:o.palette,position:o.palette.center()})}),"only duplicate this block"),r.addItem("extract","userExtractJustThis","only grab this block")),r.addItem("delete","userDestroy"),(0,o.kK)(this.comment)&&r.addItem("add comment",(()=>{var t=new ot;this.comment=t,t.block=this,t.layoutChanged();var e=this.parentThatIsA(N),o=this.parentThatIsA(Kt),i=this.parentThatIsA($t);!o&&i&&(o=i.target.parentThatIsA(Kt)),o&&(n.hand.grabOrigin={origin:o.palette,position:o.palette.center()}),e.clearDropInfo(),e.lastDropTarget={element:this},e.lastDroppedBlock=t,e.recordDrop(n.hand.grabOrigin)})),r.addItem("script pic...",(()=>{var t=this.parentThatIsA(Kt)||this.parentThatIsA($t).target.parentThatIsA(Kt);t.saveCanvasAs(c.scriptPic(),(t.projectName||(0,o.NC)("untitled"))+" "+(0,o.NC)("script pic"))}),"save a picture\nof this script"),(c instanceof D||!(c instanceof wt)&&c.allChildren().some((t=>"doReport"===t.selector)))&&r.addItem("result pic...",(()=>c.exportResultPic()),"save a picture of both\nthis script and its result"),l&&r.addItem("download script",(()=>{var t=this.parentThatIsA(Kt),e=this.parentThatIsA($t);!t&&e&&(t=e.target.parentThatIsA(Kt)),t&&t.saveXMLAs(t.serializer.serialize(this),this.selector+" script",!1)}),"download this script\nas an XML file",new o.Il(100,0,0)),p?(d.length&&(r.addLine(),d.forEach((t=>r.addItem(t+"...",(()=>p.doShowVar(t)))))),p.homeContext.variables.names().forEach((t=>{(0,o.r3)(d,t)||r.addItem(t+"...",(()=>p.doShowVar(t)))})),r):this.parent.parentThatIsA(O)?(r.addLine(),r.addItem("unringify","unringify"),!(this instanceof D)&&c instanceof F||r.addItem("ringify","ringify"),r):((0,o.r3)(["doBroadcast","doSend","doBroadcastAndWait","receiveMessage","receiveOnClone","receiveGo"],this.selector)&&(h=!0,r.addLine(),r.addItem(0===this.selector.indexOf("receive")?"senders...":"receivers...","showMessageUsers")),this.parent instanceof tt||this.parent instanceof V||this instanceof F||this instanceof R&&c instanceof F||(h||r.addLine(),r.addItem("ringify","ringify"),b.prototype.enableCodeMapping&&(r.addLine(),r.addItem("header mapping...","mapToHeader"),r.addItem("code mapping...","mapToCode"))),r))},Qt.prototype=new rt,Qt.prototype.constructor=Qt,Qt.uber=rt.prototype,Qt.prototype.thumbSize=new o.E9(40,40),Qt.prototype.labelShadowOffset=null,Qt.prototype.labelShadowColor=null,Qt.prototype.labelColor=o.Cj,Qt.prototype.fontSize=9,Qt.prototype.init=function(t){var e,i,s,r;e=[Kt.prototype.groupColor,Kt.prototype.frameColor,Kt.prototype.frameColor],i=()=>{var t=this.parentThatIsA(Kt);t&&t.selectSprite(this.object)},s=()=>{var t=this.parentThatIsA(Kt);return!!t&&t.currentSprite===this.object},r=()=>t.exemplar?(0,o.NC)("parent")+":\n"+t.exemplar.name:null,this.object=t||new y,this.version=this.object.version,this.thumbnail=null,this.rotationButton=null,Qt.uber.init.call(this,e,null,i,this.object.name,s,null,r),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},Qt.prototype.createThumbnail=function(){this.thumbnail&&this.thumbnail.destroy(),this.thumbnail=new o._V,this.thumbnail.isCachingImage=!0,this.thumbnail.bounds.setExtent(this.thumbSize),this.object instanceof y?(this.thumbnail.cachedImage=this.object.fullThumbnail(this.thumbSize,this.thumbnail.cachedImage),this.add(this.thumbnail),this.createRotationButton()):(this.thumbnail.cachedImage=this.object.thumbnail(this.thumbSize,this.thumbnail.cachedImage),this.add(this.thumbnail))},Qt.prototype.createLabel=function(){var t;this.label&&this.label.destroy(),t=new o.XC(this.object.name,this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor),this.label=new o.xZ,this.label.acceptsDrops=!1,this.label.alpha=0,this.label.setExtent(t.extent()),t.setPosition(this.label.position()),this.label.add(t),this.add(this.label)},Qt.prototype.createRotationButton=function(){var t;this.rotationButton&&(this.rotationButton.destroy(),this.roationButton=null),this.object.anchor&&((t=new rt(null,null,(()=>this.object.rotatesWithAnchor=!this.object.rotatesWithAnchor),["→","↻"],(()=>this.object.rotatesWithAnchor))).corner=8,t.labelMinExtent=new o.E9(11,11),t.padding=0,t.pressColor=t.color,t.fixLayout(),t.refresh(),this.rotationButton=t,this.add(this.rotationButton))},Qt.prototype.step=function(){this.version!==this.object.version&&(this.createThumbnail(),this.createLabel(),this.fixLayout(),this.version=this.object.version,this.refresh())},Qt.prototype.fixLayout=function(){if(!this.thumbnail||!this.label)return null;this.bounds.setWidth(this.thumbnail.width()+2*this.outline+2*this.edge+2*this.padding),this.bounds.setHeight(this.thumbnail.height()+2*this.outline+2*this.edge+3*this.padding+this.label.height()),this.thumbnail.setCenter(this.center()),this.thumbnail.setTop(this.top()+this.outline+this.edge+this.padding),this.rotationButton&&(this.rotationButton.setTop(this.top()),this.rotationButton.setRight(this.right())),this.label.setWidth(Math.min(this.label.children[0].width(),this.thumbnail.width())),this.label.setCenter(this.center()),this.label.setTop(this.thumbnail.bottom()+this.padding)},Qt.prototype.userMenu=function(){var t=new o.wR(this);return this.object instanceof b?(t.addItem("pic...",(()=>{this.parentThatIsA(Kt).saveCanvasAs(this.object.fullImage(),this.object.name)}),"save a picture\nof the stage"),this.object.trailsLog.length&&t.addItem("svg...",(()=>this.object.exportTrailsLogAsSVG()),"export pen trails\nline segments as SVG"),t):this.object instanceof y?(t.addItem("show","showSpriteOnStage"),t.addLine(),t.addItem("duplicate","duplicateSprite"),b.prototype.enableInheritance&&t.addItem("clone","instantiateSprite"),t.addItem("delete","removeSprite"),t.addLine(),b.prototype.enableInheritance&&(t.addItem("parent...","chooseExemplar"),this.object.exemplar&&t.addItem("release","releaseSprite","make temporary and\nhide in the sprite corral")),this.object.anchor&&t.addItem((0,o.NC)("detach from")+" "+this.object.anchor.name,(()=>this.object.detachFromAnchor())),this.object.parts.length&&t.addItem("detach all parts",(()=>this.object.detachAllParts())),t.addItem("export...","exportSprite"),t):null},Qt.prototype.duplicateSprite=function(){var t=this.parentThatIsA(Kt);t&&t.duplicateSprite(this.object)},Qt.prototype.instantiateSprite=function(){var t=this.parentThatIsA(Kt);t&&t.instantiateSprite(this.object)},Qt.prototype.removeSprite=function(){var t=this.parentThatIsA(Kt);t&&t.removeSprite(this.object)},Qt.prototype.exportSprite=function(){this.object.exportSprite()},Qt.prototype.chooseExemplar=function(){this.object.chooseExemplar()},Qt.prototype.releaseSprite=function(){this.object.release()},Qt.prototype.showSpriteOnStage=function(){this.object.showOnStage()},Qt.prototype.mouseDoubleClick=function(){this.object instanceof y&&this.object.flash()},Qt.prototype.render=function(t){switch(this.userState){case"highlight":this.drawBackground(t,this.highlightColor);break;case"pressed":this.drawOutline(t),this.drawBackground(t,this.pressColor),this.drawEdges(t,this.pressColor,this.pressColor.lighter(40),this.pressColor.darker(40));break;default:this.drawBackground(t,this.getRenderColor())}},Qt.prototype.getRenderColor=N.prototype.getRenderColor,Qt.prototype.prepareToBeGrabbed=function(){var t,e=this.parentThatIsA(Kt);this.mouseClickLeft(),this.alpha=.85,e&&(t=e.sprites.asArray().indexOf(this.object),e.sprites.remove(t+1),e.createCorral(),e.fixLayout())},Qt.prototype.justDropped=function(){this.alpha=1},Qt.prototype.wantsDropOf=function(t){return t instanceof A||t instanceof te||t instanceof ie},Qt.prototype.reactToDropOf=function(t,e){t instanceof A?this.copyStack(t):t instanceof te?this.copyCostume(t.object):t instanceof ie&&this.copySound(t.object),this.world().add(t),t.slideBackTo(e.grabOrigin)},Qt.prototype.copyStack=function(t){var e=this.object,i=t.fullCopy(),s=Math.max(e.scripts.children.map((t=>t.fullBounds().bottom())).concat([e.scripts.top()]));i.setPosition(new o.E9(e.scripts.left()+20,s+20)),e.scripts.add(i),i.allComments().forEach((t=>t.align(i))),e.scripts.adjustBounds(),i.allChildren().forEach((t=>{!t.isCustomBlock||t.isGlobal||e.getMethod(t.blockSpec)||t.deleteBlock()}))},Qt.prototype.copyCostume=function(t){var e=t.copy();e.name=this.object.newCostumeName(e.name),this.object.addCostume(e),this.object.wearCostume(e)},Qt.prototype.copySound=function(t){var e=t.copy();this.object.addSound(e.audio,e.name)},Qt.prototype.flash=function(){var t=this.world(),e=o.tU.isFlat,i=y.prototype.highlightColor,s=e?this.pressColor:this.outlineColor,r=this.outline,n=this.userState;e?this.pressColor=i:(this.outlineColor=i,this.outline=2),this.userState="pressed",this.rerender(),t.animations.push(new o.fw(o.WY,o.WY,0,800,o.WY,(()=>{e?this.pressColor=s:(this.outlineColor=s,this.outline=r),this.userState=n,this.rerender()})))},b.prototype.wantsDropOf=function(t){return t instanceof y||t instanceof B||t instanceof u||t instanceof Qt},te.prototype=new rt,te.prototype.constructor=te,te.uber=rt.prototype,te.prototype.thumbSize=new o.E9(80,60),te.prototype.labelShadowOffset=null,te.prototype.labelShadowColor=null,te.prototype.labelColor=o.Cj,te.prototype.fontSize=9,te.prototype.init=function(t){var e,o,i;e=[Kt.prototype.groupColor,Kt.prototype.frameColor,Kt.prototype.frameColor],o=()=>{var t=this.parentThatIsA(Kt),e=this.parentThatIsA(oe);t&&t.currentSprite.wearCostume(this.object),e&&e.updateSelection()},i=()=>{var t=this.parentThatIsA(Kt);return!!t&&t.currentSprite.costume===this.object},this.object=t||new C,this.version=this.object.version,this.thumbnail=null,te.uber.init.call(this,e,null,o,this.object.name,i,null,null),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},te.prototype.createThumbnail=function(){var t;Qt.prototype.createThumbnail.call(this),this.object instanceof S&&((t=new o.XC("svg",.8*this.fontSize,this.fontStyle,!1,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor)).setBottom(this.thumbnail.bottom()),this.thumbnail.add(t))},te.prototype.createLabel=Qt.prototype.createLabel,te.prototype.step=Qt.prototype.step,te.prototype.fixLayout=Qt.prototype.fixLayout,te.prototype.userMenu=function(){var t=new o.wR(this);return this.object instanceof C?(t.addItem("edit","editCostume"),16===this.world().currentKey&&t.addItem("edit rotation point only...","editRotationPointOnly",null,new o.Il(100,0,0)),t.addItem("rename","renameCostume"),t.addLine(),t.addItem("duplicate","duplicateCostume"),t.addItem("delete","removeCostume"),t.addLine(),t.addItem("export","exportCostume"),t):null},te.prototype.editCostume=function(){if(this.disinherit(),this.object instanceof S&&0===this.object.shapes.length)try{this.object.parseShapes()}catch(t){return void this.editRotationPointOnly()}this.object.edit(this.world(),this.parentThatIsA(Kt),!1)},te.prototype.editRotationPointOnly=function(){var t=this.parentThatIsA(Kt);this.object.editRotationPointOnly(this.world(),t),t.hasChangedMedia=!0},te.prototype.renameCostume=function(){this.disinherit();var t=this.object,e=this.parentThatIsA(oe),o=this.parentThatIsA(Kt);new lt(null,(i=>{i&&i!==t.name&&(t.name=e.sprite.newCostumeName(i,t),t.version=Date.now(),o.hasChangedMedia=!0)})).prompt(o.currentSprite instanceof y?"rename costume":"rename background",t.name,this.world())},te.prototype.duplicateCostume=function(){var t=this.parentThatIsA(oe),e=this.parentThatIsA(Kt),o=this.object.copy();o.name=t.sprite.newCostumeName(o.name),t.sprite.addCostume(o),t.updateList(),e&&e.currentSprite.wearCostume(o)},te.prototype.removeCostume=function(){var t=this.parentThatIsA(oe),e=this.parent.children.indexOf(this),o=ae.prototype.enableCamera?3:2,i=this.parentThatIsA(Kt);t.removeCostumeAt(e-o),i.currentSprite.costume===this.object&&i.currentSprite.wearCostume(null)},te.prototype.exportCostume=function(){var t=this.parentThatIsA(Kt);this.object instanceof S?t.saveFileAs(this.object.contents.src,"text/svg",this.object.name):t.saveCanvasAs(this.object.contents,this.object.name)},te.prototype.render=Qt.prototype.render,te.prototype.disinherit=function(){var t=this.parentThatIsA(oe),e=this.parent.children.indexOf(this);t.sprite.inheritsAttribute("costumes")&&(t.sprite.shadowAttribute("costumes"),this.object=t.sprite.costumes.at(e-3))},te.prototype.prepareToBeGrabbed=function(){this.disinherit(),this.mouseClickLeft(),this.removeCostume()},ee.prototype=new rt,ee.prototype.constructor=ee,ee.uber=rt.prototype,ee.prototype.thumbSize=new o.E9(80,60),ee.prototype.labelShadowOffset=null,ee.prototype.labelShadowColor=null,ee.prototype.labelColor=o.Cj,ee.prototype.fontSize=9,ee.prototype.init=function(t){var e,o,i;e=[Kt.prototype.groupColor,Kt.prototype.frameColor,Kt.prototype.frameColor],o=()=>{var t=this.parentThatIsA(Kt),e=this.parentThatIsA(oe);t&&t.currentSprite.wearCostume(null),e&&e.updateSelection()},i=()=>{var t=this.parentThatIsA(Kt);return!!t&&null===t.currentSprite.costume},this.object=t,this.version=this.object.version,this.thumbnail=null,ee.uber.init.call(this,e,null,o,"default",i,null,null),this.isDraggable=!1,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout()},ee.prototype.createThumbnail=function(){var t=o.tU.isFlat;this.thumbnail&&this.thumbnail.destroy(),this.object instanceof y?this.thumbnail=new s("turtle",this.thumbSize.y,this.labelColor,t?null:new o.E9(-1,-1),new o.Il(0,0,0)):this.thumbnail=new s("stage",this.thumbSize.y,this.labelColor,t?null:new o.E9(-1,-1),new o.Il(0,0,0)),this.add(this.thumbnail)},ee.prototype.createLabel=function(){var t;this.label&&this.label.destroy(),t=new o.XC((0,o.NC)(this.object instanceof y?"Turtle":"Empty"),this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor),this.label=new o.xZ,this.label.acceptsDrops=!1,this.label.alpha=0,this.label.setExtent(t.extent()),t.setPosition(this.label.position()),this.label.add(t),this.add(this.label)},ee.prototype.fixLayout=Qt.prototype.fixLayout,ee.prototype.render=Qt.prototype.render,ee.prototype.userMenu=function(){var t=new o.wR(this,"pen");return this.object instanceof b?null:(t.addItem(("tip"===this.object.penPoint?"●":"○")+" "+(0,o.NC)("tip"),(()=>{this.object.penPoint="tip",this.object.changed(),this.object.fixLayout(),this.object.rerender()})),t.addItem(("middle"===this.object.penPoint?"●":"○")+" "+(0,o.NC)("middle"),(()=>{this.object.penPoint="middle",this.object.changed(),this.object.fixLayout(),this.object.rerender()})),t)},oe.prototype=new o.yR,oe.prototype.constructor=oe,oe.uber=o.yR.prototype,oe.prototype.init=function(t,e){this.sprite=t||new y,this.costumesVersion=null,this.spriteVersion=null,oe.uber.init.call(this,null,null,e),this.fps=2,this.updateList()},oe.prototype.updateList=function(){var t,e,i,r,n=this.left()+5,a=this.top()+5,h=this.contents.position();this.changed(),this.contents.destroy(),this.contents=new o.xZ(this),this.contents.acceptsDrops=!1,this.contents.reactToDropOf=t=>{this.reactToDropOf(t)},this.addBack(this.contents),(t=new ee(this.sprite)).setPosition(new o.E9(n,a)),this.addContents(t),a=t.bottom()+4,(i=new st(this,"paintNew",new s("brush",15))).padding=0,i.corner=12,i.color=Kt.prototype.groupColor,i.highlightColor=Kt.prototype.frameColor.darker(50),i.pressColor=i.highlightColor,i.labelMinExtent=new o.E9(36,18),i.labelShadowOffset=new o.E9(-1,-1),i.labelShadowColor=i.highlightColor,i.labelColor=ee.prototype.labelColor,i.contrast=this.buttonContrast,i.hint="Paint a new costume",i.setPosition(new o.E9(n,a)),i.fixLayout(),i.setCenter(t.center()),i.setLeft(t.right()+16),this.addContents(i),ae.prototype.enableCamera&&((r=new st(this,"newFromCam",new s("camera",15))).padding=0,r.corner=12,r.color=Kt.prototype.groupColor,r.highlightColor=Kt.prototype.frameColor.darker(50),r.pressColor=i.highlightColor,r.labelMinExtent=new o.E9(36,18),r.labelShadowOffset=new o.E9(-1,-1),r.labelShadowColor=i.highlightColor,r.labelColor=ee.prototype.labelColor,r.contrast=this.buttonContrast,r.hint="Import a new costume from your webcam",r.setPosition(new o.E9(n,a)),r.fixLayout(),r.setCenter(i.center()),r.setLeft(i.right()+5),this.addContents(r),ae.prototype.enabled||(r.disable(),r.hint=ae.prototype.notSupportedMessage),document.addEventListener("cameraDisabled",(()=>{r.disable(),r.hint=ae.prototype.notSupportedMessage}))),(e=new o.$1((0,o.NC)("costumes tab help"))).fontSize=9,e.setColor(y.prototype.paletteTextColor),e.setPosition(new o.E9(n,a)),this.addContents(e),a=e.bottom()+4,this.sprite.costumes.asArray().forEach((e=>{(t=new te(e)).setPosition(new o.E9(n,a)),this.addContents(t),a=t.bottom()+4})),this.costumesVersion=this.sprite.costumes.lastChanged,this.contents.setPosition(h),this.adjustScrollBars(),this.changed(),this.updateSelection()},oe.prototype.updateSelection=function(){this.contents.children.forEach((function(t){t.refresh&&t.refresh()})),this.spriteVersion=this.sprite.version},oe.prototype.step=function(){this.costumesVersion!==this.sprite.costumes.lastChanged&&this.updateList(),this.spriteVersion!==this.sprite.version&&this.updateSelection()},oe.prototype.removeCostumeAt=function(t){this.sprite.shadowAttribute("costumes"),this.sprite.costumes.remove(t),this.updateList()},oe.prototype.paintNew=function(){var t=new C((0,o.oM)(null,!0),this.sprite.newCostumeName((0,o.NC)("Untitled"))),e=this.parentThatIsA(Kt);t.edit(this.world(),e,!0,null,(()=>{this.sprite.shadowAttribute("costumes"),this.sprite.addCostume(t),this.updateList(),e&&e.currentSprite.wearCostume(t)}))},oe.prototype.newFromCam=function(){var t,e=this.parentThatIsA(Kt),i=this.sprite;(t=new ae(e,i,o.WY,(t=>{i.addCostume(t),i.wearCostume(t),this.updateList()}))).key="camera",t.popUp(this.world())},oe.prototype.wantsDropOf=function(t){return t instanceof te},oe.prototype.reactToDropOf=function(t){var e=0,o=t.object,i=t.top();t.destroy(),this.contents.children.forEach((t=>{t instanceof te&&t.top()<i-4&&(e+=1)})),this.sprite.shadowAttribute("costumes"),this.sprite.costumes.add(o,e+1),this.updateList(),t.mouseClickLeft()},ie.prototype=new rt,ie.prototype.constructor=ie,ie.uber=rt.prototype,ie.prototype.thumbSize=new o.E9(80,60),ie.prototype.labelShadowOffset=null,ie.prototype.labelShadowColor=null,ie.prototype.labelColor=o.Cj,ie.prototype.fontSize=9,ie.prototype.init=function(t){var e,i,s;e=[Kt.prototype.groupColor,Kt.prototype.frameColor,Kt.prototype.frameColor],i=o.WY,s=()=>!1,this.object=t,this.version=this.object.version,this.thumbnail=null,ie.uber.init.call(this,e,null,i,this.object.name,s,null,null),this.isDraggable=!0,this.createThumbnail(),this.padding=2,this.corner=8,this.fixLayout(),this.fps=1},ie.prototype.createThumbnail=function(){var t;this.thumbnail&&this.thumbnail.destroy(),this.thumbnail=new o._V,this.thumbnail.bounds.setExtent(this.thumbSize),this.add(this.thumbnail),t=new o.XC(this.createInfo(),"16","",!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,new o.Il(200,200,200)),this.thumbnail.add(t),t.setCenter(new o.E9(40,15)),this.button=new st(this,"toggleAudioPlaying",this.object.previewAudio?"Stop":"Play"),this.button.hint="Play sound",this.button.fixLayout(),this.thumbnail.add(this.button),this.button.setCenter(new o.E9(40,40))},ie.prototype.createInfo=function(){var t=Math.round(this.object.audio.duration||0),e=t%60;return Math.floor(t/60).toString()+":"+(e<10?"0":"")+e.toString()},ie.prototype.toggleAudioPlaying=function(){this.object.previewAudio?(this.button.labelString="Play",this.button.hint="Play sound",this.object.previewAudio.pause(),this.object.previewAudio.terminated=!0,this.object.previewAudio=null):(this.button.labelString="Stop",this.button.hint="Stop sound",this.object.previewAudio=this.object.play(),this.object.previewAudio.addEventListener("ended",(()=>this.audioHasEnded()),!1)),this.button.createLabel()},ie.prototype.audioHasEnded=function(){this.button.trigger(),this.button.mouseLeave()},ie.prototype.createLabel=Qt.prototype.createLabel,ie.prototype.fixLayout=Qt.prototype.fixLayout,ie.prototype.userMenu=function(){var t=new o.wR(this);return this.object instanceof x?(t.addItem("rename","renameSound"),t.addItem("delete","removeSound"),t.addLine(),t.addItem("export","exportSound"),t):null},ie.prototype.renameSound=function(){var t=this.object,e=this.parentThatIsA(Kt);this.disinherit(),new lt(null,(o=>{o&&o!==t.name&&(t.name=o,t.version=Date.now(),this.createLabel(),this.fixLayout(),e.hasChangedMedia=!0)})).prompt("rename sound",t.name,this.world())},ie.prototype.removeSound=function(){var t=this.parentThatIsA(se),e=this.parent.children.indexOf(this)-1;t.removeSound(e)},ie.prototype.exportSound=function(){this.parentThatIsA(Kt).saveAudioAs(this.object.audio,this.object.name)},ie.prototype.render=Qt.prototype.render,ie.prototype.createLabel=Qt.prototype.createLabel,ie.prototype.disinherit=function(){var t=this.parentThatIsA(se),e=this.parent.children.indexOf(this);t.sprite.inheritsAttribute("sounds")&&(t.sprite.shadowAttribute("sounds"),this.object=t.sprite.sounds.at(e-1))},ie.prototype.prepareToBeGrabbed=function(){this.disinherit(),this.userState="pressed",this.state=!0,this.rerender(),this.removeSound()},se.prototype=new o.yR,se.prototype.constructor=se,se.uber=o.yR.prototype,se.prototype.init=function(t,e){this.sprite=t||new y,this.soundsVersion=null,this.spriteVersion=null,se.uber.init.call(this,null,null,e),this.acceptsDrops=!1,this.fps=2,this.updateList()},se.prototype.updateList=function(){var t,e,i,r=this.left()+5,n=this.top()+5,a=this.sprite.parentThatIsA(Kt);this.changed(),this.contents.destroy(),this.contents=new o.xZ(this),this.contents.acceptsDrops=!1,this.contents.reactToDropOf=t=>this.reactToDropOf(t),this.addBack(this.contents),(e=new o.$1((0,o.NC)("import a sound from your computer\nby dragging it into here"))).fontSize=9,e.setColor(y.prototype.paletteTextColor),e.setPosition(new o.E9(r,n)),this.addContents(e),(i=new st(a,"recordNewSound",new s("circleSolid",15))).padding=0,i.corner=12,i.color=Kt.prototype.groupColor,i.highlightColor=Kt.prototype.frameColor.darker(50),i.pressColor=i.highlightColor,i.labelMinExtent=new o.E9(36,18),i.labelShadowOffset=new o.E9(-1,-1),i.labelShadowColor=i.highlightColor,i.labelColor=ee.prototype.labelColor,i.contrast=this.buttonContrast,i.hint="Record a new sound",i.fixLayout(),i.label.setColor(new o.Il(255,20,20)),i.setPosition(e.bottomLeft().add(new o.E9(0,8))),this.addContents(i),n=i.bottom()+4,this.sprite.sounds.asArray().forEach((e=>{(t=new ie(e)).setPosition(new o.E9(r,n)),this.addContents(t),n=t.bottom()+4})),this.soundsVersion=this.sprite.sounds.lastChanged,this.changed(),this.updateSelection()},se.prototype.updateSelection=function(){this.contents.children.forEach((t=>{t.refresh&&t.refresh()})),this.spriteVersion=this.sprite.version},se.prototype.step=function(){this.soundsVersion!==this.sprite.sounds.lastChanged&&this.updateList(),this.spriteVersion!==this.sprite.version&&this.updateSelection()},se.prototype.removeSound=function(t){this.sprite.sounds.remove(t),this.updateList()},se.prototype.wantsDropOf=function(t){return t instanceof ie},se.prototype.reactToDropOf=function(t){var e=0,o=t.object,i=t.top();t.destroy(),this.contents.children.forEach((t=>{t instanceof ie&&t.top()<i-4&&(e+=1)})),this.sprite.shadowAttribute("sounds"),this.sprite.sounds.add(o,e+1),this.updateList()},re.prototype=new o._V,re.prototype.constructor=re,re.uber=o._V.prototype,re.prototype.init=function(t){this.target=t||null,this.userState="normal",o.LG.uber.init.call(this),this.color=o.tU.isFlat?Kt.prototype.backgroundColor:new o.Il(190,190,190),this.isDraggable=!1,this.setExtent(new o.E9(12,50))},re.prototype.render=function(t){"highlight"===this.userState?this.renderOn(t,o.tU.isFlat?new o.Il(245,245,255):new o.Il(100,100,255),this.color):this.renderOn(t,this.color)},re.prototype.renderOn=function(t,e,o){var i,s,r,n=this.height()/8,a=this.width()/6,h=a/2;for(t.lineWidth=a,t.lineCap="round",s=this.height()/2,t.strokeStyle=e.toString(),i=this.width()/12,r=0;r<3;r+=1)r>0&&(t.beginPath(),t.moveTo(i,s-(n-h)),t.lineTo(i,s+(n-h)),t.stroke()),i+=2*a,n*=2;if(o)for(t.strokeStyle=o.toString(),i=this.width()/12+a,n=this.height()/8,r=0;r<3;r+=1)r>0&&(t.beginPath(),t.moveTo(i,s-(n-h)),t.lineTo(i,s+(n-h)),t.stroke()),i+=2*a,n*=2},re.prototype.fixLayout=function(){if(this.target){var t=this.target.parentThatIsA(Kt);this.setTop(this.target.top()+10),this.setRight(this.target.left()),t&&t.add(this)}},re.prototype.step=null,re.prototype.mouseDownLeft=function(t){var e=this.world(),o=this.right()-t.x,i=this.target.parentThatIsA(Kt);if(!this.target)return null;i.isSmallStage=!0,i.controlBar.stageSizeButton.refresh(),this.step=function(){var t,s;e.hand.mouseButton?(t=e.hand.bounds.origin.x+o,s=this.target.right()-t,i.stageRatio=s/this.target.dimensions.x,i.setExtent(e.extent())):(this.step=null,i.isSmallStage=1!==i.stageRatio,i.controlBar.stageSizeButton.refresh())}},re.prototype.mouseEnter=function(){this.userState="highlight",this.rerender()},re.prototype.mouseLeave=function(){this.userState="normal",this.rerender()},re.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(Kt).toggleStageSize(!0,1)},ne.prototype=new o._V,ne.prototype.constructor=ne,ne.uber=o._V.prototype,ne.prototype.init=function(t){this.target=t||null,this.userState="normal",o.LG.uber.init.call(this),this.color=o.tU.isFlat?Kt.prototype.backgroundColor:new o.Il(190,190,190),this.isDraggable=!1,this.setExtent(new o.E9(12,50))},ne.prototype.render=re.prototype.render,ne.prototype.renderOn=re.prototype.renderOn,ne.prototype.fixLayout=function(){if(this.target){var t=this.target.parentThatIsA(Kt);this.setTop(this.target.top()+10),this.setRight(this.target.right()),t&&t.add(this)}},ne.prototype.step=null,ne.prototype.mouseDownLeft=function(t){var e=this.world(),o=this.right()-t.x,i=this.target.parentThatIsA(Kt);if(!this.target)return null;this.step=function(){var t;e.hand.mouseButton?(t=e.hand.bounds.origin.x+o,i.paletteWidth=Math.min(Math.max(200,t),i.stageHandle.left()-i.spriteBar.tabBar.width()),i.setExtent(e.extent())):this.step=null}},ne.prototype.mouseEnter=re.prototype.mouseEnter,ne.prototype.mouseLeave=re.prototype.mouseLeave,ne.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(Kt).setPaletteWidth(200)},ae.prototype=new lt,ae.prototype.constructor=ae,ae.uber=lt.prototype,ae.prototype.enableCamera=!0,ae.prototype.enabled=!0,ae.prototype.notSupportedMessage='Please make sure your web browser is up to date\nand your camera is properly configured. \n\nSome browsers also require you to access Snap!\nthrough HTTPS to use the camera.\n\nPlase replace the "http://" part of the address\nin your browser by "https://" and try again.',ae.prototype.init=function(t,e,i,s){this.ide=t,this.sprite=e,this.padding=10,this.oncancel=i,this.accept=s,this.videoElement=null,this.videoView=new o._V,this.videoView.isCachingImage=!0,ae.uber.init.call(this),this.labelString="Camera",this.createLabel(),this.buildContents()},ae.prototype.buildContents=function(){var t=this,e=this.sprite.parentThatIsA(b);function i(){t.disable(),t.ide.inform("Camera not supported",ae.prototype.notSupportedMessage),t.videoElement&&t.videoElement.remove(),t.cancel()}this.videoElement=document.createElement("video"),this.videoElement.hidden=!0,this.videoElement.width=e.dimensions.x,this.videoElement.height=e.dimensions.y,document.body.appendChild(this.videoElement),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then((t=>{this.videoElement.srcObject=t,this.videoElement.play().catch(i),this.videoElement.stream=t})).catch(i),this.videoView.setExtent(e.dimensions),this.videoView.cachedImage=(0,o.oM)(e.dimensions,!0,this.videoView.cachedImage),this.videoView.drawOn=function(o,i){var s,r,n=t.videoElement.videoWidth,a=t.videoElement.videoHeight,h=e.dimensions.x,l=e.dimensions.y;n&&(o.save(),o.translate(h,0),o.scale(-1,1),n/h>a/l?(s=h*(a/l),r=a):(s=n,r=l*(n/h)),o.drawImage(t.videoElement,0,0,s,r,-1*this.left(),this.top(),h,l),o.restore())},this.videoView.step=function(){this.changed()},this.addBody(new pt("column",this.padding/2)),this.body.add(this.videoView),this.body.fixLayout(),this.addButton("ok","Save"),this.addButton("cancel","Cancel"),this.fixLayout(),this.rerender()},ae.prototype.ok=function(){this.accept(new C(this.videoView.fullImage(),this.sprite.newCostumeName("camera")).flipped())},ae.prototype.disable=function(){ae.prototype.enabled=!1,document.dispatchEvent(new Event("cameraDisabled"))},ae.prototype.destroy=function(){this.oncancel.call(this),this.close()},ae.prototype.close=function(){this.videoElement&&this.videoElement.stream&&(this.videoElement.stream.getTracks()[0].stop(),this.videoElement.remove()),ae.uber.destroy.call(this)},he.prototype=new lt,he.prototype.constructor=he,he.uber=lt.prototype,he.prototype.init=function(t){var e=this;this.padding=10,this.accept=t,this.mediaRecorder=null,this.audioElement=document.createElement("audio"),this.audioElement.hidden=!0,this.audioElement.onended=function(t){e.stop()},document.body.appendChild(this.audioElement),this.recordButton=null,this.stopButton=null,this.playButton=null,this.progressBar=new o.RC,he.uber.init.call(this),this.labelString="Sound Recorder",this.createLabel(),this.buildContents()},he.prototype.buildContents=function(){var t=[];this.recordButton=new st(this,"record",new s("circleSolid",10)),this.stopButton=new st(this,"stop",new s("rectangleSolid",10)),this.playButton=new st(this,"play",new s("pointRight",10)),this.buildProgressBar(),this.addBody(new pt("row",this.padding)),this.body.add(this.recordButton),this.body.add(this.stopButton),this.body.add(this.playButton),this.body.add(this.progressBar),this.body.fixLayout(),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({audio:{channelCount:1}}).then((e=>{this.mediaRecorder=new MediaRecorder(e),this.mediaRecorder.ondataavailable=e=>{t.push(e.data)},this.mediaRecorder.onstop=e=>{var o=new Blob(t),i=new window.FileReader;i.readAsDataURL(o),i.onloadend=()=>{var e=i.result;e="data:audio/ogg;base64,"+e.split(",")[1],this.audioElement.src=e,this.audioElement.load(),t=[]}}})),this.addButton("ok","Save"),this.addButton("cancel","Cancel"),this.fixLayout(),this.rerender()},he.prototype.buildProgressBar=function(){var t=new o._V,e=this;this.progressBar.setExtent(new o.E9(150,20)),this.progressBar.setColor(new o.Il(200,200,200)),this.progressBar.setBorderWidth(1),this.progressBar.setBorderColor(new o.Il(150,150,150)),t.setExtent(new o.E9(130,2)),t.setColor(new o.Il(50,50,50)),t.setCenter(this.progressBar.center()),this.progressBar.add(t),this.progressBar.indicator=new o._V,this.progressBar.indicator.setExtent(new o.E9(5,15)),this.progressBar.indicator.setColor(new o.Il(50,200,50)),this.progressBar.indicator.setCenter(t.leftCenter()),this.progressBar.add(this.progressBar.indicator),this.progressBar.setPercentage=function(e){this.indicator.setLeft(t.left()+t.width()/100*e-this.indicator.width()/2)},this.progressBar.step=function(){e.audioElement.duration?this.setPercentage(e.audioElement.currentTime/e.audioElement.duration*100):this.setPercentage(0)}},he.prototype.record=function(){this.mediaRecorder&&"inactive"!==this.mediaRecorder.state?this.stop():(this.mediaRecorder.start(),this.recordButton.label.setColor(new o.Il(255,0,0)),this.playButton.label.setColor(new o.Il(0,0,0)))},he.prototype.stop=function(){this.mediaRecorder&&"inactive"!==this.mediaRecorder.state&&this.mediaRecorder.stop(),this.audioElement.pause(),this.audioElement.currentTime=0,this.recordButton.label.setColor(new o.Il(0,0,0)),this.playButton.label.setColor(new o.Il(0,0,0))},he.prototype.play=function(){this.stop(),this.audioElement.oncanplaythrough=function(){this.play(),this.oncanplaythrough=o.WY},this.playButton.label.setColor(new o.Il(0,255,0))},he.prototype.ok=function(){var t=this;this.stop(),this.audioElement.oncanplaythrough=function(){this.duration&&this.duration!==1/0?(t.accept(this),this.oncanplaythrough=o.WY,t.destroy()):(t.buttons.children.forEach((t=>t.disable())),this.play())}},he.prototype.destroy=function(){this.stop(),this.audioElement.remove(),this.mediaRecorder&&this.mediaRecorder.stream&&this.mediaRecorder.stream.getTracks()[0].stop(),he.uber.destroy.call(this)},window.onload=function(){(qt=new o.ww(document.getElementById("world"),!0,!0)).worldCanvas.focus(),(new Kt).openIn(qt),le(),window.onWorldLoaded&&window.onWorldLoaded()}}()})();
//# sourceMappingURL=main.js.map